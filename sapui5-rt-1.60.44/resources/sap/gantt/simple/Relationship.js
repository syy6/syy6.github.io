/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/Device","sap/ui/core/Core","sap/ui/core/IconPool","./GanttUtils","./RenderUtils","./BasePath","sap/ui/core/theming/Parameters"],function(D,C,I,G,R,B,P){"use strict";var A=6,L=20,a=15,b={"FinishToFinish":0,"FinishToStart":1,"StartToFinish":2,"StartToStart":3};var c=B.extend("sap.gantt.simple.Relationship",{metadata:{properties:{type:{type:"sap.gantt.simple.RelationshipType",group:"Appearance"},predecessor:{type:"string",group:"Data"},successor:{type:"string",group:"Data"},selectedStroke:{type:"sap.gantt.ValueSVGPaintServer",defaultValue:"#FF0000"},selectedStrokeWidth:{type:"sap.gantt.SVGLength",defaultValue:2}}}});c.prototype.applySettings=function(s){s=s||{};s.stroke=s.stroke||P.get("sapUiBaseText");s.strokeWidth=s.strokeWidth||1;B.prototype.applySettings.apply(this,arguments);};c.prototype.renderElement=function(r,e,g){var m=this.getRelatedInRowShapes(g);if(m.predecessor==null&&m.successor==null){return;}var t=this.getProcessedType();var d=this.getRlsAnchors(t,m);var n=this.getBaseRowHeight(g);this.calcLinePathD(d,n,t);this.renderRelationship(r,d);};c.prototype.getRlsAnchors=function(t,r){var p,s,o;var m=this.getShapeAnchors(r);if(r.predecessor&&r.successor){if(t==b.FinishToFinish){p=m.predecessor.tail;s=m.successor.tail;}else if(t==b.FinishToStart){p=m.predecessor.tail;s=m.successor.head;}else if(t==b.StartToFinish){p=m.predecessor.head;s=m.successor.tail;}else if(t==b.StartToStart){p=m.predecessor.head;s=m.successor.head;}}else if(r.predecessor&&!r.successor){if(t==b.FinishToFinish||t==b.FinishToStart){p=m.predecessor.tail;s={x:p.x+L,y:p.y};o={x:s.x,y:s.y+a/2};}else if(t==b.StartToFinish||t==b.StartToStart){p=m.predecessor.head;s={x:p.x-L,y:p.y};o={x:s.x-a,y:s.y+a/2};}}else if(!r.predecessor&&r.successor){if(t==b.FinishToFinish||t==b.StartToFinish){s=m.successor.tail;p={x:s.x+L,y:s.y};o={x:p.x,y:p.y+a/2};}else if(t==b.FinishToStart||t==b.StartToStart){s=m.successor.head;p={x:s.x-L,y:s.y};o={x:p.x-a,y:p.y+a/2};}}return{predecessor:p,successor:s,prompter:o};};c.prototype.calcLinePathD=function(m,n,t){var x=m.predecessor.x,y=m.predecessor.y;var d=m.successor.x,e=m.successor.y;var f,g=[x,y,d,e];if(y==e){f=this.calcIRlsPathD;}else if(y!=e){if(t==b.FinishToFinish){f=this.calcURlsPathD;g.push(false);}else if(t==b.FinishToStart){if(x<=d){f=this.calcLRlsPathD;}else if(x>d){f=this.calcSRlsPathD;g.push(n);}}else if(t==b.StartToFinish){if(x<d){f=this.calcSRlsPathD;g.push(n);}else if(x>=d){f=this.calcLRlsPathD;}}else if(t==b.StartToStart){f=this.calcURlsPathD;g.push(true);}}if(f==this.calcLRlsPathD){g[2]=(x<d)?d+m.successor.dx:d-m.successor.dx;g[3]=(y<e)?e-m.successor.dy:e+m.successor.dy;}this.setProperty("d",f.apply(this,g),true);};c.prototype.calcIRlsPathD=function(x,y,d,e){return this.getLinePathD([[x,y],[d,e]]);};c.prototype.calcLRlsPathD=function(x,y,d,e){return this.getLinePathD([[x,y],[d,y],[d,e]]);};c.prototype.calcURlsPathD=function(x,y,d,e,Y){var f=(x<d)?d+2*A:x+2*A;var g=(x<d)?x-2*A:d-2*A;var h=(!Y)?f:g;return this.getLinePathD([[x,y],[h,y],[h,e],[d,e]]);};c.prototype.calcSRlsPathD=function(x,y,d,e,n){var f=(x<d)?x-A*2:x+A*2;var g=(y<e)?y+n/2:y-n/2;var h=(x<d)?d+A*2:d-A*2;return this.getLinePathD([[x,y],[f,y],[f,g],[h,g],[h,e],[d,e]]);};c.prototype.getArrowPathD=function(p){var t=function(v){return Number(v);};var d=p.match(/-?\d+(\.\d+)?/g).map(t);var x=d[d.length/2-2];var y=d[d.length/2-1];var e=d[d.length/2+0];var f=d[d.length/2+1];var r=[[e,f]];if(x==e){if(y>f){r.push([e+A/2,f+A]);r.push([e-A/2,f+A]);}else if(y<f){r.push([e-A/2,f-A]);r.push([e+A/2,f-A]);}}else if(x!=e){if(x>e){r.push([e+A,f-A/2]);r.push([e+A,f+A/2]);}else if(x<e){r.push([e-A,f+A/2]);r.push([e-A,f-A/2]);}}return d3.svg.line().interpolate("linear-closed")(r);};c.prototype.getShapeAnchors=function(r){var m={predecessor:null,successor:null};Object.keys(r).forEach(function(k){var s=r[k];if(s==null){return;}if(s.getShapeAnchors){m[k]=s.getShapeAnchors();}else{var o=s.getDomRef().getBBox();m[k]={head:{x:o.x,y:o.y+o.height/2,dx:0,dy:o.height/2},tail:{x:o.x+o.width,y:o.y+o.height/2,dx:0,dy:o.height/2}};}});return m;};c.prototype.renderRelationship=function(r,m){r.write("<g");this.writeElementData(r);R.renderAttributes(r,this,["style"]);r.write(">");R.renderTooltip(r,this);r.write("<path");r.writeAttribute("d",this.getD());r.write("/>");r.write("<path");r.writeAttribute("d",this.getArrowPathD(this.getD()));r.write("/>");if(m.prompter){r.write("<text");r.writeAttribute("x",m.prompter.x);r.writeAttribute("y",m.prompter.y);r.writeAttribute("font-size",a);r.writeAttribute("font-family","SAP-icons");r.writeAttribute("text-anchor",(C.getConfiguration().getRTL()&&!D.browser.msie&&!D.browser.edge)?"end":"start");r.writeAttribute("stroke-width",0);r.write(">");r.write(I.getIconInfo("chain-link").content);r.write("</text>");}r.write("</g>");};c.prototype.getStyle=function(){return this.getInlineStyle({"fill":this.getStroke(),"stroke":this.getStroke(),"stroke-width":this.getStrokeWidth()});};c.prototype.getLinePathD=function(p){p=p.concat(p.slice(1,-1).reverse());return d3.svg.line().interpolate("linear-closed")(p);};c.prototype.getSelectedStyle=function(){return this.getInlineStyle({"fill":this.getSelectedStroke(),"stroke":this.getSelectedStroke(),"stroke-width":this.getSelectedStrokeWidth(),"pointer-events":"none"});};c.prototype.getBaseRowHeight=function(g){return C.byId(g).getTable()._getDefaultRowHeight();};c.prototype.getProcessedType=function(){var t=this.getProperty("type");var i=C.getConfiguration().getRTL();return i?3-b[t]:b[t];};c.prototype.getRelatedInRowShapes=function(g){var r={predecessor:null,successor:null};Object.keys(r).forEach(function(p){r[p]=G.shapeElementById(this.getProperty(p),g+"-svg");},this);return r;};return c;},true);
