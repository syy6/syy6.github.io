/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/comp/library","sap/ui/core/Control","sap/ui/comp/providers/ChartProvider","sap/suite/ui/microchart/library","sap/ui/core/CustomData","sap/ui/comp/smartmicrochart/SmartMicroChartCommons","sap/base/Log"],function(C,a,b,M,c,S,L){"use strict";var d=a.extend("sap.ui.comp.smartmicrochart.SmartMicroChart",{metadata:{library:"sap.ui.comp",designtime:"sap/ui/comp/designtime/smartmicrochart/SmartMicroChart.designtime",properties:{entitySet:{type:"string",group:"Misc",defaultValue:null},showLabel:{type:"boolean",group:"Appearance",defaultValue:true},enableAutoBinding:{type:"boolean",group:"Misc",defaultValue:false},chartBindingPath:{type:"string",group:"Misc",defaultValue:null},chartType:{type:"string",group:"Misc",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"164px"},height:{type:"sap.ui.core.CSSSize",group:"Misc",defaultValue:"74px"},isResponsive:{type:"boolean",group:"Appearance",defaultValue:false}},defaultAggregation:"_chart",aggregations:{_chart:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}},associations:{chartTitle:{type:"sap.m.Label",group:"Misc",multiple:false},chartDescription:{type:"sap.m.Label",group:"Misc",multiple:false},unitOfMeasure:{type:"sap.m.Label",group:"Misc",multiple:false},freeText:{type:"sap.m.Label",group:"Misc",multiple:false},ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"}},events:{initialize:{}}}});d.prototype.init=function(){this._bIsInitialized=false;this._bMetaModelLoadAttached=false;};d.prototype.setChartType=function(){return this;};d.prototype.getChartType=function(){return this.getAggregation("_chart").getChartType();};d.prototype.propagateProperties=function(){if(a.prototype.propagateProperties){a.prototype.propagateProperties.apply(this,arguments);}this._initializeMetadata();};d.prototype.onBeforeRendering=function(){var o=this.getAggregation("_chart");if(o){if(o.getMetadata().hasProperty("height")&&!this.getIsResponsive()){o.setProperty("height",this.getHeight(),true);}if(o.getMetadata().hasProperty("width")&&!this.getIsResponsive()){o.setProperty("width",this.getWidth(),true);}if(o.getMetadata().hasProperty("isResponsive")){o.setProperty("isResponsive",this.getIsResponsive(),true);M._passParentContextToChild(this,o);}if(o.getMetadata().hasProperty("showLabel")){o.setProperty("showLabel",this.getShowLabel(),true);}if(o.getMetadata().hasAssociation("chartTitle")){o.setAssociation("chartTitle",this.getChartTitle(),true);}if(o.getMetadata().hasAssociation("chartDescription")){o.setAssociation("chartDescription",this.getChartDescription(),true);}if(o.getMetadata().hasAssociation("unitOfMeasure")){o.setAssociation("unitOfMeasure",this.getUnitOfMeasure(),true);}if(o.getMetadata().hasAssociation("freeText")){o.setAssociation("freeText",this.getFreeText(),true);}}};d.prototype.addAriaLabelledBy=function(A){this.addAssociation("ariaLabelledBy",A,true);this.getAggregation("_chart").addAriaLabelledBy(A);return this;};d.prototype.removeAriaLabelledBy=function(A){this.removeAssociation("ariaLabelledBy",A,true);this.getAggregation("_chart").removeAriaLabelledBy(A);return this;};d.prototype.removeAllAriaLabelledBy=function(){this.removeAllAssociation("ariaLabelledBy",true);this.getAggregation("_chart").removeAllAriaLabelledBy();return this;};d.prototype._initializeMetadata=function(){if(!this._bIsInitialized){var m=this.getModel();if(m&&(m.getMetadata().getName()==="sap.ui.model.odata.v2.ODataModel"||m.getMetadata().getName()==="sap.ui.model.odata.ODataModel")){if(!this._bMetaModelLoadAttached){m.getMetaModel().loaded().then(this._onMetadataInitialized.bind(this));this._bMetaModelLoadAttached=true;}}else if(m){this._onMetadataInitialized();}}};d.prototype._createChartProvider=function(){var e=this.getEntitySet(),m=this.getModel();if(m&&e){this._oChartProvider=new b({entitySet:e,model:m,chartQualifier:this.data("chartQualifier")});}};d.prototype._onMetadataInitialized=function(){var q,D;this._bMetaModelLoadAttached=false;if(!this._bIsInitialized){this._createChartProvider();if(this._oChartProvider){this._oChartViewMetadata=this._oChartProvider.getChartViewMetadata();if(this._oChartViewMetadata){this._bIsInitialized=true;this._createInnerChart();}else{q=this.data("chartQualifier");D=this._oChartProvider.getChartDataPointMetadata();if(D){D=q?D.additionalAnnotations[q]:D.primaryAnnotation;if(D){this._bIsInitialized=true;this._createInnerChartFromDataPoint(D);}else{L.error("There is no UI.Chart annotation nore DataPoint annotation. We cannot initialize SmartMicroChart.");}}else{L.error("There is no UI.Chart annotation nore DataPoint annotation. We cannot initialize SmartMicroChart.");}}}}};d.prototype._createInnerChartFromDataPoint=function(D){var t=D.Visualization.EnumMember;if(S._isBulletVizualizationType(t)){this._buildSmartBulletMicroChart();}else{L.error("Only Bullet chart can be initialize with just DataPoint annotation. Type: "+t+" is not a Bullet chart type.");return;}this.invalidate();};d.prototype._createInnerChart=function(){if(!this._checkChartMetadata()){L.error("Created annotations not valid. Please review the annotations and metadata.");return;}var s=this._oChartViewMetadata.chartType;switch(s){case"line":case"area":var t=this._oChartViewMetadata.annotation.ChartType.EnumMember.split("/").pop().toLowerCase();if(t==="area"){this._buildSmartAreaMicroChart();}else if(t==="line"){this._buildSmartLineMicroChart();}else{L.error("Not supported chart type used.");return;}break;case"bullet":this._buildSmartBulletMicroChart();break;case"donut":this._buildSmartRadialMicroChart();break;case"stacked_bar":this._buildSmartStackedBarMicroChart();break;case"column":this._buildSmartColumnMicroChart();break;default:L.error("Not supported chart type used.");return;}this.invalidate();};d.prototype._buildSmartLineMicroChart=function(){this._buildSmartMicroChart(C.smartmicrochart.SmartLineMicroChart);};d.prototype._buildSmartAreaMicroChart=function(){this._buildSmartMicroChart(C.smartmicrochart.SmartAreaMicroChart);};d.prototype._buildSmartBulletMicroChart=function(){this._buildSmartMicroChart(C.smartmicrochart.SmartBulletMicroChart);};d.prototype._buildSmartRadialMicroChart=function(){this._buildSmartMicroChart(C.smartmicrochart.SmartRadialMicroChart);};d.prototype._buildSmartStackedBarMicroChart=function(){this._buildSmartMicroChart(C.smartmicrochart.SmartStackedBarMicroChart);};d.prototype._buildSmartColumnMicroChart=function(){this._buildSmartMicroChart(C.smartmicrochart.SmartColumnMicroChart);};d.prototype._buildSmartMicroChart=function(e){var o=new e({entitySet:this.getEntitySet(),chartBindingPath:this.getChartBindingPath(),initialize:[this._onChartInitialized,this],customData:[new c({key:"chartQualifier",value:this.data("chartQualifier")})]});if(o.getMetadata().hasProperty("enableAutoBinding")){o.setProperty("enableAutoBinding",this.getEnableAutoBinding(),true);}this.setAggregation("_chart",o,true);};d.prototype._onChartInitialized=function(){this.fireInitialize();};d.prototype._checkChartMetadata=function(){if(this._oChartViewMetadata.chartType&&this._oChartViewMetadata.annotation&&this._oChartViewMetadata.annotation.ChartType&&this._oChartViewMetadata.annotation.ChartType.EnumMember&&this._oChartViewMetadata.annotation.ChartType.EnumMember.length>0){return true;}else{return false;}};d.prototype.getAccessibilityInfo=function(){return S._getAccessibilityInfo.apply(this);};return d;});
