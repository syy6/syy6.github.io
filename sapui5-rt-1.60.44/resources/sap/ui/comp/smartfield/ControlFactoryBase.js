/*
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/core/library","sap/ui/comp/library","sap/ui/comp/util/FormatUtil","sap/ui/comp/providers/ValueHelpProvider","sap/ui/comp/providers/ValueListProvider","sap/ui/comp/smartfield/BindingUtil","sap/m/HBox","sap/base/Log"],function(B,c,l,F,V,a,b,H,L){"use strict";var C=l.smartfield.ControlContextType;var d=c.ValueState;var e=B.extend("sap.ui.comp.smartfield.ControlFactoryBase",{constructor:function(m,p){B.apply(this,arguments);this.sName="ControlFactoryBase";this._oModel=m;this._oParent=p;this._oBinding=new b();this._aProviders=[];this._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");}});e.prototype.createControl=function(f){var m,o;m=this._getCreator(f);if(m){o=this[m]();this._addAriaLabelledBy(o);if(o&&o.onCreate){this[o.onCreate](o.control,o.params);}}return o;};e.prototype._addAriaLabelledBy=function(o){var t;if((this._oParent.getControlContext()===C.None)||(this._oParent.getControlContext()===C.Form)||(this._oParent.getControlContext()===C.SmartFormGrid)){if(o){t=o.control;if(t instanceof H){if(t.getItems().length>0){t=t.getItems()[0];}}}if(t&&t.addAriaLabelledBy&&this._oParent.getAriaLabelledBy().length>0){t.removeAllAriaLabelledBy();this._oParent.getAriaLabelledBy().forEach(function(A){t.addAriaLabelledBy(A);});}}};e.prototype.addValidations=function(o,m){var s,E,t=this;s=function(S,f){var M,g,h=f.getSource();if(h){if(h.setValueState){h.setValueState(S);}g=f.getParameter("exception");if(g){M=g.message;}if(!M){M=f.getParameter("message");}if(h.setValueStateText){h.setValueStateText(M);}}if(m){t._oParent[m](S===d.Error);}};E=function(f){s(d.Error,f);};o.attachFormatError(E);o.attachParseError(E);o.attachValidationError(E);o.attachValidationSuccess(function(f){s(d.None,f);});};e.prototype._getDisplayBehaviourConfiguration=function(D){var s=null;var o=this._oParent.getConfiguration();if(o){s=o.getDisplayBehaviour();}if(!s&&this._oMetaData&&this._oMetaData.entityType){s=this._oHelper.oAnnotation.getTextArrangement(this._oMetaData.property.property,this._oMetaData.entityType);}if(!s){s=this._oParent.data(D);}return s;};e.prototype._getPreventInitialDataFetchInVHDialog=function(){var o=this._oParent.getConfiguration();return o?o.getPreventInitialDataFetchInValueHelpDialog():true;};e.prototype._formatDisplayBehaviour=function(D,k,s){var f=this._getDisplayBehaviourConfiguration(D);if(D==="defaultCheckBoxDisplayBehaviour"){return this._getFormattedExpressionFromDisplayBehaviour(f,k);}if(D==="defaultComboBoxReadOnlyDisplayBehaviour"&&!f){f="descriptionAndId";}return F.getFormattedExpressionFromDisplayBehaviour(f||"idOnly",k,s);};e.prototype._getFormattedExpressionFromDisplayBehaviour=function(D,v){var k="";switch(D){case"OnOff":k=v?"SMARTFIELD_CB_ON":"SMARTFIELD_CB_OFF";break;case"TrueFalse":k=v?"SMARTFIELD_CB_TRUE":"SMARTFIELD_CB_FALSE";break;default:k=v?"SMARTFIELD_CB_YES":"SMARTFIELD_CB_NO";break;}return this._oRb.getText(k);};e.prototype.shouldCreateValueHelpForControl=function(o){if(!o){return false;}var p=this._oParent;return p&&((p.getMode()==="edit")||(o.getMetadata().getName()==="sap.ui.comp.smartfield.DisplayComboBox"));};e.prototype.getDropdownItemKeyType=function(){};e.prototype.createValueHelp=function(o,p,v,m,O){var f,g;if(v.annotation&&(p["sap:value-list"]||p["com.sap.vocabularies.Common.v1.ValueList"])){var D=this._getDisplayBehaviourConfiguration("defaultDropDownDisplayBehaviour"),h=this._oParent.data("dateFormatSettings"),P=this._getPreventInitialDataFetchInVHDialog();if(typeof h==="string"){try{h=JSON.parse(h);}catch(i){}}var A,s;if(typeof v.annotation==="string"){s=v.annotation;}else if(v&&typeof v.annotation==="object"){A=v.analyser.getValueListAnnotationForFunctionImport({"":v.annotation},p.name).primaryValueListAnnotation;}if(!v.noDialog){if(o.setFilterSuggests){o.setFilterSuggests(false);}f=new V({loadAnnotation:true,fullyQualifiedFieldName:s,annotation:A,metadataAnalyser:v.analyser,control:o,model:m,preventInitialDataFetchInValueHelpDialog:P,dateFormatSettings:h,takeOverInputValue:false,supportMultiSelect:!!v.supportMultiSelect,supportRanges:!!v.supportRanges,fieldName:p.name,title:v.dialogtitle,displayBehaviour:D,type:v.type});if(O){f.attachValueListChanged(O);}this._aProviders.push(f);if(o.setShowValueHelp){o.setShowValueHelp(true);}}if(!v.noTypeAhead||!o.isA("sap.m.Input")){g=new a({control:o,dropdownItemKeyType:this.getDropdownItemKeyType(o),typeAheadEnabled:!v.noTypeAhead,aggregation:v.aggregation,loadAnnotation:true,fullyQualifiedFieldName:s,annotation:A,metadataAnalyser:v.analyser,model:m,dateFormatSettings:h,displayBehaviour:D});if(!v.noTypeAhead){if(o.setShowSuggestion){o.setShowSuggestion(true);}}if(O){g.attachValueListChanged(O);}this._aProviders.push(g);}}};e.prototype.getAttribute=function(n){var i=this._oParent.getBindingInfo(n);if(i){return this._oBinding.toBindingPath(i);}return this._oParent["get"+n.substring(0,1).toUpperCase()+n.substring(1)]();};e.prototype.createAttributes=function(A,t,N,E){var f=this,m={},i;for(var n in N){i=this._oParent.getBindingInfo(n);if(i){m[n]=this._oBinding.toBinding(i);}else{m[n]=this._oParent["get"+n.substring(0,1).toUpperCase()+n.substring(1)]();}}if(A){m[A]={model:this._oMetaData.model,path:this._oMetaData.path,type:t?this._oTypes.getType(t):null};}if(E){m[E.event]=function(p){try{f._oParent.fireChange({value:p.mParameters[E.parameter],newValue:p.mParameters[E.parameter]});}catch(g){L.warning(g);}};}this.addObjectBinding(m);return m;};e.prototype.mapBindings=function(A,N){var n,i;for(n in N){i=this._oParent.getBindingInfo(n);if(i){A[N[n]]=this._oBinding.toBinding(i);}else{A[N[n]]=this._oParent["get"+n.substring(0,1).toUpperCase()+n.substring(1)]();}}};e.prototype.addObjectBinding=function(A,o){if(!o){o=this._oParent.getObjectBinding(this._oMetaData.model);}if(A&&o){A.objectBindings={};A.objectBindings[this._oMetaData.model]=o.sPath;}};e.prototype.getFormatSettings=function(f){var m=null,g,o,h;if(f){m=this._oParent.data(f);if(!m){g=this._oParent.getCustomData();if(g){h=g.length;while(h--){o=g[h];if(o.getKey()===f){m=o.getValue();break;}}}}if(m&&typeof(m)==="string"){try{m=JSON.parse(m);}catch(i){return null;}}}return m;};e.prototype.destroyValueHelp=function(){this._aProviders.forEach(function(p){p.destroy();});this._aProviders=[];};e.prototype.destroy=function(){this.destroyValueHelp();if(this._oBinding){this._oBinding.destroy();}this._oBinding=null;this._oParent=null;this._oModel=null;this._oRb=null;};return e;},true);
