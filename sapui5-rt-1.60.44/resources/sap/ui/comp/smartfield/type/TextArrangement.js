/*
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/model/CompositeType","sap/ui/comp/util/FormatUtil","sap/ui/model/ParseException","sap/ui/model/ValidateException","sap/ui/model/FormatException","sap/base/assert"],function(q,C,F,P,V,a,b){"use strict";var T=C.extend("sap.ui.comp.smartfield.type.TextArrangement",{constructor:function(o,c,s){this.getPrimaryType().call(this,o,c);C.call(this,o,c);this.init(o,c,s);b(s.valueListAnnotation.valueListEntitySetName,"Missing value for the valueListEntitySetName field in the value list annotation. - "+this.getName());b(s.valueListAnnotation.keyField,"Missing value for the keyField in the value list annotation. - "+this.getName());b(s.valueListAnnotation.descriptionField,"Missing value for the descriptionField in the value list annotation. - "+this.getName());}});T.prototype.init=function(o,c,s){this.bParseWithValues=true;this.oSettings=q.extend({data:[],valueListAnnotation:null,onBeforeValidateValue:function(){},onAfterValidateValue:function(){}},s);this.oFormatOptions=q.extend({textArrangement:"idOnly"},o);this.fnPreParser=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"preParse"});this.fnParser=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"parse"});this.fnValidator=this.getValidator({textArrangement:this.oFormatOptions.textArrangement,prefix:"validate"});this.bNewDataLoaded=false;this.bRawValue=false;this.bValueValidated=false;this.vRawValue="";this.vRawID="";this.vRawDescription="";this.sDescription=undefined;};T.prototype.parseValue=function(v,s,c){if(v===""){return[this.getPrimaryType().prototype.parseValue.call(this,v,s),undefined];}var t=this.oFormatOptions.textArrangement;if(t==="idOnly"){return this.parseIDOnly(v,s);}this.vRawValue=v;if(!this.bNewDataLoaded){if(typeof this.fnPreParser==="function"){var r=this.fnPreParser.call(this,v,s,c,this.oFormatOptions);this.vRawID=r[0];this.vRawDescription=r[1];}else{this.vRawID=v;}this.bRawValue=true;return[undefined,undefined];}this.bNewDataLoaded=false;this.bRawValue=false;return this.fnParser(v,s,c,this.oSettings);};T.prototype.parseIDOnly=function(v,s){return[this.getPrimaryType().prototype.parseValue.call(this,v,s),undefined];};T.prototype.preParseIDAndDescription=function(v,s,c,o){var r=/.*\s\(.*\)/i;if(r.test(v)){var d=/\s\(/gi;if(v.match(d).length>1){throw new P(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTFIELD_NOT_FOUND"));}var e=T.splitIDAndDescription(v,{separator:d,textArrangement:o.textArrangement});e[0]=this.getPrimaryType().prototype.parseValue.call(this,e[0],s);return e;}v=this.getPrimaryType().prototype.parseValue.call(this,v,s);return[v,undefined];};T.prototype.parseIDAndDescription=function(v,s,c,S){var r=/.*\s\(.*\)/i;if(r.test(v)){v=this.preParseIDAndDescription(v,s,this.oFormatOptions)[0];}else if(S.data.length){var d=f(v,{key:S.valueListAnnotation.keyField,value:S.valueListAnnotation.descriptionField,data:S.data});if(d.length===0){throw new V(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTFIELD_NOT_FOUND"));}if(d.length>1){throw new V(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTFIELD_DUPLICATE_VALUES"));}this.sDescription=d[0];return[v,undefined];}else if(v!==""){throw new V(sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("SMARTFIELD_NOT_FOUND"));}return[v,undefined];};T.prototype.parseDescriptionOnly=function(v,s,c,S){var i,k=S.valueListAnnotation.keyField,d=S.valueListAnnotation.descriptionField,r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp");var I=f(v,{key:d,value:k,data:S.data});var e=I.length;if(e===1){i=this.getPrimaryType().prototype.parseValue.call(this,I[0],s);this.sDescription=v;return[i,undefined];}if(e===0){I=f(v,{key:k,value:d,data:S.data});e=I.length;}if(e===0){throw new V(r.getText("SMARTFIELD_NOT_FOUND"));}if(e>1){throw new V(r.getText("SMARTFIELD_DUPLICATE_VALUES"));}i=this.getPrimaryType().prototype.parseValue.call(this,v,s);this.sDescription=I[0];return[i,undefined];};T.prototype.validateValue=function(v){if(this.bRawValue){this.bValueValidated=false;this.onBeforeValidateValue(this.vRawID,this.oFormatOptions,this.getFilterFields());return;}this.getPrimaryType().prototype.validateValue.call(this,v[0]);if(v[0]!==null){this.fnValidator(v,this.oSettings);}this.bValueValidated=true;this.onAfterValidateValue(v[0]);};T.prototype.validateIDOnly=function(v,s){};T.prototype.validateIDAndDescription=function(v,s){};T.prototype.validateDescriptionOnly=function(v,s){};T.prototype.onAfterValidateValue=function(v){this.oSettings.onAfterValidateValue(v);};T.prototype.formatValue=function(v,t){if(this.bRawValue){return this.vRawValue;}var k=this.getPrimaryType().prototype.formatValue.call(this,v[0],t);if(k===""){return k;}var d=v[1];if(this.bValueValidated){d=(this.sDescription===undefined)?v[1]:this.sDescription;}else{this.onBeforeValidateValue(k,this.oFormatOptions,this.getFilterFields());return"";}return F.getFormattedExpressionFromDisplayBehaviour(this.oFormatOptions.textArrangement,k,d);};T.prototype.destroy=function(){this.oFormatOptions=null;this.oSettings=null;this.fnPreParser=null;this.fnParser=null;this.fnValidator=null;this.vRawValue="";this.vRawID="";this.vRawDescription="";this.sDescription="";};T.prototype.getName=function(){return"sap.ui.comp.smartfield.type.TextArrangement";};T.prototype.getPrimaryType=function(){};T.prototype.getValidator=function(s){switch(s.textArrangement){case"idAndDescription":case"descriptionAndId":return this[s.prefix+"IDAndDescription"];case"descriptionOnly":return this[s.prefix+"DescriptionOnly"];default:return this[s.prefix+"IDOnly"];}};T.prototype.getFilterFields=function(){return["keyField","descriptionField"];};function f(k,s){var v=[];s.data.forEach(function(d,i,D){if(d[s.key]===k){v.push(d[s.value]);}});return v;}T.splitIDAndDescription=function(v,s){var c=s.separator.exec(v),i=c["index"];switch(s.textArrangement){case"idAndDescription":return[v.slice(0,i),v.slice(i+2,-1)];case"descriptionAndId":return[v.slice(i+2,-1),v.slice(0,i)];default:return["",""];}};return T;});
