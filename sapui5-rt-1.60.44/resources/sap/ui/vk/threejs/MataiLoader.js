/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log"],function(L){"use strict";var S=function(p){this._id=S._nextId++;S.add(this);this._parentNode=p;this._nodes=new Map();this._meshes=new Map();this._cameras=new Map();this._materials=new Map();this._images=new Map();};S._nextId=1;S._map=new Map();S.add=function(s){this._map.set(s.getId(),s);return this;};S.getById=function(b){return this._map.get(b);};S.prototype.getId=function(){return this._id;};S.prototype.createNode=function(b){var p=this._nodes.get(b.parentRef)||null;var c=new THREE.Group();c.name=b.name;c.matrix.set(b.matrix[0],b.matrix[4],b.matrix[8],b.matrix[12],b.matrix[1],b.matrix[5],b.matrix[9],b.matrix[13],b.matrix[2],b.matrix[6],b.matrix[10],b.matrix[14],b.matrix[3],b.matrix[7],b.matrix[11],b.matrix[15]);c.matrix.decompose(c.position,c.quaternion,c.scale);c.userData.metadata=b.metadata;c.userData.veids=b.veids;(p||this._parentNode).add(c);this._nodes.set(b.nodeRef,c);};var n=new Float32Array([0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0,-1.0,0.0,0.0]);var i=new Uint16Array([0,1,2,2,1,3,4,6,5,5,6,7,8+0,8+1,8+2,8+2,8+1,8+3,8+4,8+6,8+5,8+5,8+6,8+7,16+0,16+1,16+2,16+2,16+1,16+3,16+4,16+6,16+5,16+5,16+6,16+7]);S.prototype.createMesh=function(c){var b=c.boundingBox;var v=new Float32Array([b[0],b[1],b[5],b[3],b[1],b[5],b[0],b[4],b[5],b[3],b[4],b[5],b[0],b[1],b[2],b[3],b[1],b[2],b[0],b[4],b[2],b[3],b[4],b[2],b[0],b[4],b[5],b[3],b[4],b[5],b[0],b[4],b[2],b[3],b[4],b[2],b[0],b[1],b[5],b[3],b[1],b[5],b[0],b[1],b[2],b[3],b[1],b[2],b[3],b[1],b[5],b[3],b[1],b[2],b[3],b[4],b[5],b[3],b[4],b[2],b[0],b[1],b[5],b[0],b[1],b[2],b[0],b[4],b[5],b[0],b[4],b[2]]);var d=new THREE.BufferGeometry();d.setIndex(new THREE.BufferAttribute(i,1));d.addAttribute("position",new THREE.BufferAttribute(v,3));d.addAttribute("normal",new THREE.BufferAttribute(n,3));var m=new THREE.Mesh(d,this._materials.get(c.materialRef));this._meshes.set(c.meshRef,m);if(c.matrix){m.matrix.set(c.matrix[0],c.matrix[4],c.matrix[8],c.matrix[12],c.matrix[1],c.matrix[5],c.matrix[9],c.matrix[13],c.matrix[2],c.matrix[6],c.matrix[10],c.matrix[14],c.matrix[3],c.matrix[7],c.matrix[11],c.matrix[15]);m.matrix.decompose(m.position,m.quaternion,m.scale);}};S.prototype.setMeshGeometry=function(b){var m=this._meshes.get(b.meshRef);var d=b.data;var c=new THREE.BufferGeometry();c.setIndex(new THREE.BufferAttribute(d.index,1));c.addAttribute("position",new THREE.BufferAttribute(d.position,3));if(d.normal){c.addAttribute("normal",new THREE.BufferAttribute(d.normal,3));}if(d.uv){c.addAttribute("uv",new THREE.BufferAttribute(d.uv,2));}m.geometry.copy(c);};S.prototype.insertMesh=function(b,m){var c=this._nodes.get(b);var d=this._meshes.get(m);c.add(d.parent?d.clone():d);};S.prototype.createCamera=function(b){var c=null;if(b.projection==="perspective"){c=new sap.ui.vk.threejs.PerspectiveCamera();c.setFov(b.fov);}else if(b.projection==="orthographic"){c=new sap.ui.vk.threejs.OrthographicCamera();c.setZoomFactor(b.orthoZoomFactor);}if(c){c.setNearClipPlane(b.nearClip);c.setFarClipPlane(b.farClip);c.setUsingDefaultClipPlanes(b.autoEvaluateClipPlanes);var d=new THREE.Vector3().fromArray(b.origin);var t=new THREE.Vector3().fromArray(b.target).sub(d);var u=new THREE.Vector3().fromArray(b.up).sub(d);c.setUpDirection(u.toArray());c.setPosition(d.toArray());c.setTargetDirection(t.toArray());}this._parentNode.userData.camera=c;this._cameras.set(b.cameraRef,c);};S.prototype.insertCamera=function(b,c){var d=this._nodes.get(b);var e=this._cameras.get(c);e=e?e.getCameraRef():null;if(d&&e){(d||this._parentNode).add(e.parent?e.clone():e);}};S.prototype.createMaterial=function(b){if(b.textures){b.textures.forEach(function(t){var f=t.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;var c=new THREE.Texture(this._images.get(t.imageRef),t.type==="reflection"?THREE.SphericalReflectionMapping:THREE.UVMapping,t.repeatX?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,t.repeatY?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,f,f);c.offset.set(t.offsetX,t.offsetX);c.repeat.set(t.scaleX,t.scaleY);b[t.type+"Texture"]=c;c.needsUpdate=true;},this);}var m=new THREE.MeshPhongMaterial({opacity:b.opacity,color:new THREE.Color(b.diffuse[0],b.diffuse[1],b.diffuse[2]),emissive:new THREE.Color(b.emissive[0]+b.ambient[0]*0.2,b.emissive[1]+b.ambient[1]*0.2,b.emissive[2]+b.ambient[2]*0.2),specular:new THREE.Color(b.specular[0],b.specular[1],b.specular[2]),map:b.diffuseTexture?b.diffuseTexture:null,specularMap:b.specularTexture?b.specularTexture:null,emissiveMap:b.emissiveTexture?b.emissiveTexture:null,envMap:b.reflectionTexture?b.reflectionTexture:null,alphaMap:b.opacityTexture?b.opacityTexture:null,bumpMap:b.bumpTexture?b.bumpTexture:null,transparent:b.opacity<1||!!b.opacityTexture});if(m.envMap){m.combine=THREE.MixOperation;m.reflectivity=0.5;}this._materials.set(b.materialRef,m);};S.prototype.createImage=function(b){var d=window.btoa(String.fromCharCode.apply(null,b.data));var c=new THREE.ImageLoader().load("data:image/"+b.format+";base64,"+d);this._images.set(b.imageRef,c);};S.prototype.progress=function(p){L.log("reading progress:",p);};var o=function(e){var d=e.data;if(d.ready){o.resolve();}else{var s=S.getById(d.sceneBuilderId);s[d.method].apply(s,d.args);}};var a=function(e){L.error("Error in WebWorker",e);};var g=(function(){var p;return function(){return p||(p=new Promise(function(r){var w=new Worker(sap.ui.require.toUrl("sap/ui/vk/threejs/MataiLoaderWorker.js"));o.resolve=r.bind(null,w);w.onmessage=o;w.onerror=a;}));};})();var l=function(b,u,p){g().then(function(w){var s=new S(p);w.postMessage({method:"loadSceneFromArrayBuffer",sceneBuilderId:s.getId(),buffer:b,fileName:u,sourceLocation:"remote"},[b]);});};return function(p,c){return new Promise(function(r,b){if(typeof c.getSource()==="string"){var u=c.getSource();fetch(u).then(function(d){return d.arrayBuffer();}).then(function(d){l(d,u,p);r({node:p,contentResource:c});});}});};});
