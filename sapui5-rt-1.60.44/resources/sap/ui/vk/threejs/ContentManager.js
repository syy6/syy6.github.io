/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./thirdparty/three","../ContentManager","./Scene","../TransformationMatrix","./PerspectiveCamera","./OrthographicCamera","../Messages"],function(q,t,C,S,T,P,O,M){"use strict";var a=C.extend("sap.ui.vk.threejs.ContentManager",{metadata:{library:"sap.ui.vk"}});var b=a.getMetadata().getParent().getClass().prototype;a.prototype.init=function(){if(b.init){b.init.call(this);}};a.prototype.exit=function(){if(b.exit){b.exit.call(this);}};function s(o){if(o&&o.isMesh){o.castShadow=true;o.receiveShadow=false;}if(o&&o.children){for(var n=0;n<o.children.length;n++){s(o.children[n]);}}}function c(n,e){if(n){var f=new THREE.Group();n.add(f);f.name="DefaultLights";f.private=true;var g=new THREE.Box3().setFromObject(n);var m=g.getSize().length();var p=new THREE.PointLight();p.color.copy(new THREE.Color(0.72,0.72,0.81));p.position.copy(g.getCenter());p.visible=true;p.private=true;f.add(p);var h=[new THREE.Color(0.2,0.2,0.2),new THREE.Color(0.32,0.32,0.36),new THREE.Color(0.36,0.36,0.36)];var i=[new THREE.Vector3(2.0,1.5,0.5),new THREE.Vector3(-2.0,-1.1,2.5),new THREE.Vector3(-0.04,-0.01,-2.0)];for(var l=0,j=h.length;l<j;l++){var k=new THREE.DirectionalLight();k.color.copy(h[l]);k.position.copy(i[l]);k.private=true;f.add(k);}if(e){s(n);var o=new THREE.DirectionalLight();o.color.copy(new THREE.Color(0.5,0.5,0.5));o.position.copy(new THREE.Vector3(0,1.0,0));o.castShadow=true;o.shadow.mapSize.width=512;o.shadow.mapSize.height=512;var d=2000;o.shadow.camera.left=-d;o.shadow.camera.right=d;o.shadow.camera.top=d;o.shadow.camera.bottom=-d;o.shadow.camera.far=3500;o.shadow.bias=-0.0001;o.private=true;f.add(o);var r=new THREE.PlaneBufferGeometry(g.getSize().x,g.getSize().z);var u=new THREE.ShadowMaterial();u.opacity=0.2;var v=new THREE.Mesh(r,u);v.rotation.x=-Math.PI/2;v.position.x=g.getCenter().x;v.position.y=g.min.y-m*0.1;v.position.z=g.getCenter().z;n.add(v);v.receiveShadow=true;}}}a.prototype.loadContent=function(d,e){var f=this;var l=function(){f.fireContentChangesStarted();var n=new THREE.Scene(),g=new S(n);f._loadContentResources(g,e).then(function(v){var d=g;if(v[0].camera){d.camera=v[0].camera;}var h=[];for(var i=0;i<v.length;i++){if(v[i].loader){h.push(v[i].loader);}}if(h.length>0){d.loaders=h;}f._initSceneWithCDSLoaderIfExists(g,h);c(g.getSceneRef(),false);f.fireContentChangesFinished({content:d});},function(r){q.sap.log.error("Failed to load content resources.",r);f.fireContentChangesFinished({content:null,failureReason:[{error:r,errorMessage:typeof r==="string"?r:sap.ui.vk.getResourceBundle().getText(M.VIT37.summary)}]});});};l();return this;};a.prototype._findLoader=function(d){if(d._contentManagerResolver&&d._contentManagerResolver.settings&&d._contentManagerResolver.settings.loader){return d._contentManagerResolver.settings.loader;}if(d.getSource()){var e=d.getSourceType();if(e==="stream"){if(this.defaultCdsLoader==null){q.sap.require("sap.ui.vk.threejs.ContentDeliveryService");this.defaultCdsLoader=new sap.ui.vk.threejs.ContentDeliveryService({authorizationHandler:this._authorizationHandler});}return this.defaultCdsLoader;}}return null;};a.prototype._loadContentResources=function(d,e){var p=[];e.forEach(function loadContentResource(f,g){var n=new THREE.Group();n.name=g.getName();n.sourceId=g.getSourceId();g._shadowContentResource={nodeProxy:d.getDefaultNodeHierarchy().createNodeProxy(n)};var l=g.getLocalMatrix();if(l){n.applyMatrix(new THREE.Matrix4().fromArray(T.convertTo4x4(l)));}f.add(n);var h=this._findLoader(g);if(typeof h==="function"){p.push(h(n,g,this._authorizationHandler));}else if(h&&h.load){p.push(h.load(n,g,this._authorizationHandler));}else{p.push(Promise.resolve({node:n,contentResource:g}));}g.getContentResources().forEach(loadContentResource.bind(this,n));}.bind(this,d.getSceneRef()));return Promise.all(p);};a.prototype._initSceneWithCDSLoaderIfExists=function(d,l){var e;if(l){for(var i=0;i<l.length;i++){if(l[i]instanceof sap.ui.vk.threejs.ContentDeliveryService){e=l[i];break;}}if(e){d._setState(e.getState());d.getDefaultNodeHierarchy().attachNodeRemoving(function(f){var r=f.getParameter("nodeRef");if(r.userData&&r.userData.treeNode&&r.userData.treeNode.sid){e.decrementResourceCountersForDeletedTreeNode(r.userData.treeNode.sid);}});return true;}}return false;};a.prototype.createOrthographicCamera=function(){return new O();};a.prototype.createPerspectiveCamera=function(){return new P();};return a;});
