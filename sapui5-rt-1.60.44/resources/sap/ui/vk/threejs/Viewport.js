/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../library","../ViewportBase","sap/ui/core/ResizeHandler","../Loco","./thirdparty/three","../ContentConnector","../ViewStateManager","./ViewportGestureHandler","./OrthographicCamera","./PerspectiveCamera","./NodesTransitionHelper","../Messages","sap/ui/base/ManagedObjectObserver"],function(q,l,V,R,L,a,C,b,c,O,P,N,M,d){"use strict";var e=V.extend("sap.ui.vk.threejs.Viewport",{metadata:{library:"sap.ui.vk",properties:{renderMode:{type:"sap.ui.vk.RenderMode",defaultValue:sap.ui.vk.RenderMode.Default}},events:{cameraChanged:{parameters:{position:"float[]",quaternion:"float[]",zoom:"float"},enableEventBubbling:true}}}});var f=e.getMetadata().getParent().getClass().prototype;e.prototype.init=function(){if(f.init){f.init.call(this);}this._resizeListenerId=null;this._renderLoopRequestId=0;this._renderLoopFunction=this._renderLoop.bind(this);this._shouldRenderFrame=true;this._clippingPlanes=[];this._renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setSize(1,1);this._renderer.shadowMap.enabled=true;this._camera=new P();var g=["varying float vPos;","void main() {","	gl_Position = vec4(position, 1.0);","	vPos = position.y * -0.5 + 0.5;","}"].join("\n");var h=["uniform vec4 topColor;","uniform vec4 bottomColor;","varying float vPos;","void main() {","	gl_FragColor = mix(topColor, bottomColor, vPos);","}"].join("\n");var i=new THREE.Vector4();var j=new THREE.Vector4();this._updateColor(i,this.getBackgroundColorTop());this._updateColor(j,this.getBackgroundColorBottom());this._checkBackgroundColor();this._backgroundMaterial=new THREE.ShaderMaterial({uniforms:{topColor:{value:i},bottomColor:{value:j}},vertexShader:g,fragmentShader:h,side:THREE.DoubleSide,depthTest:false,depthWrite:false,blending:THREE.NoBlending});var k=new THREE.Geometry();k.vertices.push(new THREE.Vector3(-1,1,0),new THREE.Vector3(1,1,0),new THREE.Vector3(-1,-1,0),new THREE.Vector3(1,-1,0));k.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3));this._backgroundCamera=new THREE.Camera();this._backgroundScene=new THREE.Scene();this._backgroundScene.add(new THREE.Mesh(k,this._backgroundMaterial));var x=["#include <clipping_planes_pars_vertex>","varying vec3 vNormal;","void main() {","#include <begin_vertex>","#include <project_vertex>","#include <clipping_planes_vertex>","#include <beginnormal_vertex>","#include <defaultnormal_vertex>","	vNormal = normalize( transformedNormal );","}"].join("\n");var m=["#include <clipping_planes_pars_fragment>","uniform vec4 color1;","uniform vec4 color2;","varying vec3 vNormal;","void main() {","#include <clipping_planes_fragment>","	gl_FragColor = mix(color1, color2, abs(normalize(vNormal).z));","}"].join("\n");this._xrayColor1=new THREE.Vector4(0,0.75,1,0.45);this._xrayColor2=new THREE.Vector4(0,0,1,0);this._xrayMaterial=new THREE.ShaderMaterial({uniforms:{color1:{value:this._xrayColor1},color2:{value:this._xrayColor2}},vertexShader:x,fragmentShader:m,side:THREE.DoubleSide,depthWrite:false,depthFunc:THREE.LessDepth,blending:THREE.NormalBlending,clipping:true,transparent:true});this._viewportGestureHandler=new c(this);this._loco=new L(this);this._loco.addHandler(this._viewportGestureHandler,-1);this._zoomedObject=null;this._nodesTransitionHelper=new N();this._nodesTransitionHelper.setViewport(this);this._cdsLoader=null;this.attachCameraChanged(function(n){this.setShouldRenderFrame();});this._sceneObserver=new d(this.setShouldRenderFrame.bind(this));};e.prototype.exit=function(){this._loco.removeHandler(this._viewportGestureHandler);this._viewportGestureHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();this.setScene(null);this.setCamera(null);this._renderer=null;this._backgroundCamera=null;this._backgroundMaterial=null;this._backgroundScene=null;this._loco=null;this._viewportGestureHandler=null;if(this._cdsLoader){this._cdsLoader.detachSceneUpdated(this._handleCdsSceneUpdate,this);}if(f.exit){f.exit.call(this);}};e.prototype._startRenderLoop=function(){if(!this._renderLoopRequestId){this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);}return this;};e.prototype._stopRenderLoop=function(){if(this._renderLoopRequestId){window.cancelAnimationFrame(this._renderLoopRequestId);this._renderLoopRequestId=0;}return this;};e.prototype.setBackgroundColorTop=function(v){f.setBackgroundColorTop.call(this,v);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.topColor.value,v);this._checkBackgroundColor();}return this;};e.prototype.setBackgroundColorBottom=function(v){f.setBackgroundColorBottom.call(this,v);if(this._backgroundMaterial!==null){this._updateColor(this._backgroundMaterial.uniforms.bottomColor.value,v);this._checkBackgroundColor();}return this;};e.prototype.setClippingPlanes=function(g){this._clippingPlanes=g;return this;};e.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this._stopRenderLoop();};e.prototype.onAfterRendering=function(){var g=this.getDomRef();g.appendChild(this._renderer.domElement);this._resizeListenerId=R.register(this,this._handleResize.bind(this));this._handleResize({size:{width:g.clientWidth,height:g.clientHeight}});this._startRenderLoop();};e.prototype._handleResize=function(g){if(!this._camera||!this._renderer){return false;}var w=g.size.width;var h=g.size.height;if(this._camera){this._camera.update(w,h);}this._renderer.setSize(w,h);this.fireResize({size:{width:w,height:h}});this.setShouldRenderFrame();return true;};e.prototype.setScene=function(s){this._scene=s;this._homeCamera=null;this._sceneObserver.disconnect();var n=this._scene?this._scene.getSceneRef():undefined;if(n){this._sceneObserver.observe(this._scene,{properties:["doubleSided"]});var g;for(var i=0;i<n.children.length;i++){g=n.children[i];if(g.private&&g.name==="DefaultLights"&&g.children.length){if(g.children[0]instanceof THREE.PointLight){this._eyePointLight=g.children[0];}}}}this.setShouldRenderFrame();return this;};e.prototype.getScene=function(){return this._scene;};e.prototype.setCamera=function(g){if(f.setCamera){f.setCamera.call(this,g);}var h=this.getCamera();if(h&&this._renderer){var s=this._renderer.getSize();h.update(s.width,s.height);if(!this._homeCamera&&h.getCameraRef()){this._homeCamera=h.getCameraRef().clone();}}this.setShouldRenderFrame();return this;};e.prototype.getRenderer=function(){return this._renderer;};e.prototype._getViewStateManagerThreeJS=function(){if(this._viewStateManager){if(this._viewStateManager.constructor===sap.ui.vk.threejs.ViewStateManager){return this._viewStateManager;}if(this._viewStateManager.constructor===sap.ui.vk.ViewStateManager&&this._viewStateManager._implementation.constructor===sap.ui.vk.threejs.ViewStateManager){return this._viewStateManager._implementation;}}return null;};e.prototype._updateBoundingBoxesIfNeeded=function(){var v=this._getViewStateManagerThreeJS();if(v){v._updateBoundingBoxesIfNeeded();}};e.prototype._updateColor=function(g,h){var i=sap.ui.vk.cssColorToColor(h);g.color=new THREE.Color(i.red/255,i.green/255,i.blue/255);g.alpha=i.alpha;g.x=g.color.r*g.alpha;g.y=g.color.g*g.alpha;g.z=g.color.b*g.alpha;g.w=g.alpha;};e.prototype._checkBackgroundColor=function(){var g=this.getBackgroundColorTop();if(g===this.getBackgroundColorBottom()){if(this._backgroundColor===null){this._backgroundColor=new THREE.Vector4();}this._updateColor(this._backgroundColor,g);}else{this._backgroundColor=null;}this.setShouldRenderFrame();};e.prototype._handleCdsSceneUpdate=function(){this.setShouldRenderFrame();};e.prototype.setShouldRenderFrame=function(){this._shouldRenderFrame=true;return this;};e.prototype.shouldRenderFrame=function(){return this._shouldRenderFrame;};e.prototype.setRenderMode=function(g){this.setProperty("renderMode",g,true);this.setShouldRenderFrame();};e.prototype.hitTest=function(x,y){var n=this._scene?this._scene.getSceneRef():undefined;var g=this._camera?this._camera.getCameraRef():undefined;if(!g||!n){return null;}var h=this._renderer.domElement;var m=new THREE.Vector2((x-h.clientLeft)/h.clientWidth*2-1,(h.clientTop-y)/h.clientHeight*2+1);var j=new THREE.Raycaster();j.setFromCamera(m,g);if(this._clippingPlanes){for(var i in this._clippingPlanes){var k=this._clippingPlanes[i];var s=k.distanceToPoint(j.ray.origin),t=-s/k.normal.dot(j.ray.direction);if(t>0){if(s<0){j.near=Math.max(j.near,t);}else{j.far=Math.min(j.far,t);}}else if(s<0){return null;}}}var u=j.intersectObjects(n.children,true);if(u&&u.length){var v=u[0];if(!v.object.name&&v.object.children.length===0){v.object=v.object.parent;}return v;}return null;};e.prototype.tap=function(x,y,i){if(!i){if(this._viewStateManager){var h=this.hitTest(x,y);var n=h&&h.object;var g={picked:n?[n]:[]};this.fireNodesPicked(g);if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Exclusive){this.exclusiveSelectionHandler(g.picked);}else if(this.getSelectionMode()===sap.ui.vk.SelectionMode.Sticky){this.stickySelectionHandler(g.picked);}if(n!==null){this.fireNodeClicked({nodeRef:n,x:x,y:y},true,true);}}}else if(!this.getFreezeCamera()){var j=this.hitTest(x,y);if(j&&(this._zoomedObject===null||this._zoomedObject!==j.object)){this._zoomedObject=j.object;this._viewportGestureHandler.zoomObject(this._zoomedObject,true);}else{this._viewportGestureHandler.zoomObject(this._zoomedObject,false);this._zoomedObject=null;}}return this;};var o={x:-2,y:-2};var r=2;var p=5;[{key:"left",dx:-r,dy:0},{key:"right",dx:+r,dy:0},{key:"up",dx:0,dy:-r},{key:"down",dx:0,dy:+r}].forEach(function(i){e.prototype["onsap"+i.key]=function(g){var h=this._viewportGestureHandler._cameraController;h.beginGesture(o.x,o.y);h.rotate(i.dx,i.dy,true);h.endGesture();this.setShouldRenderFrame();g.preventDefault();g.stopPropagation();};});[{key:"left",dx:-p,dy:0},{key:"right",dx:+p,dy:0},{key:"up",dx:0,dy:-p},{key:"down",dx:0,dy:+p}].forEach(function(i){e.prototype["onsap"+i.key+"modifiers"]=function(g){if(g.shiftKey&&!(g.ctrlKey||g.altKey||g.metaKey)){var h=this._viewportGestureHandler._cameraController;h.beginGesture(o.x,o.y);h.pan(i.dx,i.dy);h.endGesture();this.setShouldRenderFrame();g.preventDefault();g.stopPropagation();}};});[{key:"minus",d:0.98},{key:"plus",d:1.02}].forEach(function(i){e.prototype["onsap"+i.key]=function(g){var h=this._viewportGestureHandler._cameraController;h.beginGesture(this.$().width()/2,this.$().height()/2);h.zoom(i.d);h.endGesture();this.setShouldRenderFrame();g.preventDefault();g.stopPropagation();};});e.prototype._handleVisibilityChanged=e.prototype._handleOpacityChanged=e.prototype._handleTintColorChanged=e.prototype._handleHighlightColorChanged=function(g){this.setShouldRenderFrame();};e.prototype._handleSelectionChanged=function(g){var t=this.getTools();for(var i=0;i<t.length;i++){var h=sap.ui.getCore().byId(t[i]);var j=h.getGizmoForContainer(this);if(j&&j.handleSelectionChanged){j.handleSelectionChanged(g);}}this.setShouldRenderFrame();};e.prototype.setSelectionRect=function(g){this.setShouldRenderFrame();if(!g){this._selectionRect=null;return;}var s=this._renderer.getSize();var x=(g.x1/s.width)*2-1,y=(g.y1/s.height)*-2+1,h=(g.x2/s.width)*2-1,i=(g.y2/s.height)*-2+1;if(!this._selectionRect){var j=new THREE.Geometry();j.vertices.push(new THREE.Vector3(x,i,-1),new THREE.Vector3(h,i,-1),new THREE.Vector3(h,y,-1),new THREE.Vector3(x,y,-1));this._selectionRect=new THREE.LineLoop(j,new THREE.LineBasicMaterial({color:0xC0C000,linewidth:window.devicePixelRatio}));}else{var v=this._selectionRect.geometry.vertices;v[0].set(x,i,-1);v[1].set(h,i,-1);v[2].set(h,y,-1);v[3].set(x,y,-1);this._selectionRect.geometry.verticesNeedUpdate=true;}};e.prototype._renderLoop=function(){if(!this._renderer||!this.getDomRef()){this._renderLoopRequestId=0;return;}if(this._viewportGestureHandler){this._viewportGestureHandler.animateCameraUpdate();}if(this._nodesTransitionHelper){this._nodesTransitionHelper.displayNodesMoving();}var n=this.getCamera()?this.getCamera().getCameraRef():undefined;if(this._eyePointLight&&n){this._eyePointLight.position.copy(n.position);}if(this._shouldRenderFrame){this._shouldRenderFrame=false;this.render();}this._renderLoopRequestId=window.requestAnimationFrame(this._renderLoopFunction);};e.prototype.render=function(){var g=this._renderer;if(!g){return;}g.autoClear=this._backgroundColor!=null;if(g.autoClear){g.setClearColor(this._backgroundColor.color,this._backgroundColor.alpha);}else{g.render(this._backgroundScene,this._backgroundCamera);}var n=this._scene?this._scene.getSceneRef():null;var h=this._camera?this._camera.getCameraRef():null;if(!n||!h){return;}var t=this.getTools();var i,j,k;if(this._camera.getUsingDefaultClipPlanes()||(h.isOrthographicCamera&&this._camera.getZoomNeedRecalculate())){var m=this._scene._computeBoundingBox();if(!m.isEmpty()){if(h.isOrthographicCamera&&this._camera.getZoomNeedRecalculate()){this._camera.adjustZoom(m);}if(this._camera.getUsingDefaultClipPlanes()){for(i=0;i<t.length;i++){j=sap.ui.getCore().byId(t[i]);k=j.getGizmoForContainer(this);if(k&&k.expandBoundingBox){k.expandBoundingBox(m);}}this._camera.adjustClipPlanes(m);}}}var v=this._getViewStateManagerThreeJS();g.clippingPlanes=this._clippingPlanes;if(this.getRenderMode()===sap.ui.vk.RenderMode.XRay){if(v){var s=n.children[n.children.length-1].clone();v._selectedNodes.forEach(function(w){if(w.visible){w.add(s);g.render(w,h);g.autoClear=false;w.remove(s);}});}this._xrayColor1.w=0.45;n.overrideMaterial=this._xrayMaterial;}g.render(n,h);g.autoClear=false;g.clippingPlanes=[];n.overrideMaterial=null;if(v){var u=v._boundingBoxesScene;if(u){g.render(u,h);}}for(i=0;i<t.length;i++){j=sap.ui.getCore().byId(t[i]);k=j.getGizmoForContainer(this);if(k&&k.render){k.render(this);}}if(this._selectionRect){g.render(this._selectionRect,this._backgroundCamera);}};e.prototype.getImage=function(g,i,t,j,k){if(this._scene===null){return null;}g=g||16;i=i||16;if(g>2048){g=2048;}if(i>2048){i=2048;}var m=new THREE.WebGLRenderer({preserveDrawingBuffer:true});m.setSize(g,i);var n=this.getBackgroundColorTop();var s=this.getBackgroundColorBottom();if(t&&!j){m.setClearColor(t,1);}else if(!t&&j){m.setClearColor(j,1);}else{if(t&&j){this.setBackgroundColorTop(t);this.setBackgroundColorBottom(j);}m.render(this._backgroundScene,this._backgroundCamera);m.autoClear=false;}document.body.appendChild(m.domElement);var u=this.getCamera().getCameraRef().clone();var v=g/i;if(u.isOrthographicCamera){var w=u.right-u.left;var h=u.top-u.bottom;if(w>h){u.top=w/v/2;u.bottom=-w/v/2;}else{u.left=-h*v/2;u.right=h*v/2;}}else{var x=2*Math.atan(u.aspect*Math.tan(u.fov*Math.PI/360));if(u.fov<x*180/Math.PI){u.fov=360*Math.atan(Math.tan(x*0.5)/v)/Math.PI;}u.aspect=v;}u.updateProjectionMatrix();var y=[];var z=this._getViewStateManagerThreeJS();if(!k){if(z!==null){z.enumerateSelection(function(B){y.push(B);});z.setSelectionState(y,false,false,true);}}m.render(this._scene.getSceneRef(),u);var A=m.getContext().canvas.toDataURL();if(z!==null&&y.length>0){z.setSelectionState(y,true,false,true);}m.forceContextLoss();document.body.removeChild(m.domElement);if(s&&t){this.setBackgroundColorBottom(s);}if(n&&j){this.setBackgroundColorTop(n);}return A;};e.prototype._setContent=function(g){var s;var h;if(g){s=g;if(!(s instanceof sap.ui.vk.threejs.Scene)){s=null;}h=g.camera;if(!(h instanceof O||h instanceof P)){h=new P();}if(h instanceof O){var j=new THREE.Box3().setFromObject(s.getSceneRef());var k=j.getCenter();var m=h.getTargetDirection();var n=h.getPosition();var t=[k.x-n[0],k.y-n[1],k.z-n[2]];var u=t[0]*m[0]+t[1]*m[1]+t[2]*m[2];if(u<0){var v=j.getSize().length()/2;v-=u;n[0]-=m[0]*v;n[1]-=m[1]*v;n[2]-=m[2]*v;h.setPosition(n);}}if(g.loaders){for(var i=0;i<g.loaders.length;i++){if(g.loaders[i]instanceof sap.ui.vk.threejs.ContentDeliveryService){this._cdsLoader=g.loaders[i];this._cdsLoader.attachSceneUpdated(this._handleCdsSceneUpdate,this);break;}}}}this.setScene(s);if(h){this.setCamera(h);}};e.prototype._onAfterUpdateContentConnector=function(){this._setContent(this._contentConnector.getContent());};e.prototype._onBeforeClearContentConnector=function(){if(f._onBeforeClearContentConnector){f._onBeforeClearContentConnector.call(this);}this.setScene(null);};e.prototype._handleContentReplaced=function(g){var h=g.getParameter("newContent");this._setContent(h);};e.prototype._onAfterUpdateViewStateManager=function(){};e.prototype._onBeforeClearViewStateManager=function(){};C.injectMethodsIntoClass(e);b.injectMethodsIntoClass(e);e.prototype.activateView=function(v){var g=v.getCameraInfo();var n;if(g){if(g.type==="PerspectiveCamera"){n=new P();n.setFov(g.fov);n.setPosition(g.position);}if(g.type==="OrthographicCamera"){n=new O();n.setZoomFactor(g.zoomFactor);if(g.zoomNeedRecalculate){n.setZoomNeedRecalculate(true);}var h=g.position;var s=this.getScene();if(s){var i=new THREE.Box3().setFromObject(this.getScene().getSceneRef());var j=i.getCenter();var k=g.targetDirection;var m=[j.x-h[0],j.y-h[1],j.z-h[2]];var t=m[0]*k[0]+m[1]*k[1]+m[2]*k[2];if(t<0){var u=i.getSize().length()/2;u-=t;h[0]-=k[0]*u;h[1]-=k[1]*u;h[2]-=k[2]*u;}}n.setPosition(h);}n.setNearClipPlane(g.nearClipPlane);n.setFarClipPlane(g.farClipPlane);n.setUpDirection(g.upDirection);n.setTargetDirection(g.targetDirection);n.setUsingDefaultClipPlanes(g.usingDefaultClipPlanes);this._viewportGestureHandler.prepareForCameraUpdateAnimation(g.type);this.setCamera(n);this._viewportGestureHandler.startAnimatingCameraUpdate(500);}function w(D){return new THREE.Matrix4().set(D[0],D[1],D[2],D[3],D[4],D[5],D[6],D[7],D[8],D[9],D[10],D[11],0,0,0,1);}var x=this._viewStateManager.getNodeHierarchy();var y=v.getNodeInfos();if(y){this._nodesTransitionHelper.clear();y.forEach(function(D){if(D.target===null){return;}function E(H,I,J){for(var K=0;K<H.elements.length;K++){if(Math.abs(H.elements[K]-I.elements[K])>J){return false;}}return true;}if(D.transform){var F=w(D.transform);if(!E(F,D.target.matrix,1e-6)){var G=x.createNodeProxy(D.target);this._nodesTransitionHelper.setNodeForDisplay(G);F.decompose(D.target.position,D.target.quaternion,D.target.scale);D.target.updateMatrix();}}}.bind(this));var z=[];var A=[];for(var B=0;B<y.length;B++){if(y[B].visible){z.push(y[B].target);}else{A.push(y[B].target);}}this._viewStateManager.setVisibilityState(z,true,false);this._viewStateManager.setVisibilityState(A,false,false);this._nodesTransitionHelper.startDisplay(500);}return this;};e.prototype.zoomTo=function(w,n,g,m){var h=this._scene?this._scene.getSceneRef():null;var i=this._camera?this._camera.getCameraRef():null;if(!i||!h){return this;}m=m||0;var j=new THREE.Box3();var k=null;var s=null;(Array.isArray(w)?w:[w]).forEach(function(w){switch(w){case sap.ui.vk.ZoomTo.All:j.expandByObject(h);break;case sap.ui.vk.ZoomTo.Visible:j=this._scene._computeBoundingBox(true);break;case sap.ui.vk.ZoomTo.Selected:var v=this._getViewStateManagerThreeJS();if(v){v.enumerateSelection(function(n){j.expandByObject(n);});}break;case sap.ui.vk.ZoomTo.Node:if(!n){return this;}s=n;if(Array.isArray(n)){n.forEach(function(n){j.expandByObject(n);});}else{j.expandByObject(n);}break;case sap.ui.vk.ZoomTo.Restore:q.sap.log.error("sap.ui.vk.ZoomTo.Restore is not implemented");return this;case sap.ui.vk.ZoomTo.NodeSetIsolation:q.sap.log.error("sap.ui.vk.ZoomTo.NodeSetIsolation is not implemented");return this;case sap.ui.vk.ZoomTo.RestoreRemoveIsolation:q.sap.log.error("sap.ui.vk.ZoomTo.RestoreRemoveIsolation is not implemented");return this;case sap.ui.vk.ZoomTo.ViewLeft:k=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),-Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewRight:k=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewTop:k=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewBottom:k=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2);break;case sap.ui.vk.ZoomTo.ViewBack:k=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI);break;case sap.ui.vk.ZoomTo.ViewFront:k=new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),0);break;default:break;}}.bind(this));if(!j.isEmpty()){this._viewportGestureHandler.zoomTo(j,k,m,g*1000,s,s!==null);}return this;};e.prototype.getViewInfo=function(g){var v={};if(g==null){g={};}if(g.camera==null){g.camera=true;}var n=this._camera?this._camera.getCameraRef():null;if(g.camera&&n){var h=n.rotation.clone();h.reorder("YXZ");v.camera={rotation:{yaw:THREE.Math.radToDeg(h.y),pitch:THREE.Math.radToDeg(h.x),roll:THREE.Math.radToDeg(h.z)},position:{x:n.position.x,y:n.position.y,z:n.position.z},projectionType:n.isOrthographicCamera?sap.ui.vk.CameraProjectionType.Orthographic:sap.ui.vk.CameraProjectionType.Perspective,bindingType:sap.ui.vk.CameraFOVBindingType.Vertical};if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Perspective){v.camera.fieldOfView=n.fov;}else if(v.camera.projectionType===sap.ui.vk.CameraProjectionType.Orthographic){v.camera.zoomFactor=n.zoom;}if(g.camera.matrices){v.camera.matrices={view:n.matrixWorldInverse.elements.slice(),projection:n.projectionMatrix.elements.slice()};}}if(g.visibility&&this._viewStateManager){var i=g.visibility.mode==null?sap.ui.vk.VisibilityMode.Complete:g.visibility.mode;v.visibility={mode:i};if(i===sap.ui.vk.VisibilityMode.Complete){var j=this._viewStateManager.getVisibilityComplete();v.visibility.visible=j.visible;v.visibility.hidden=j.hidden;}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){v.visibility.changes=this._viewStateManager.getVisibilityChanges();}else{q.sap.log.warning(sap.ui.vk.getResourceBundle().getText(M.VIT32.summary),M.VIT32.code,"sap.ui.vk.threejs.Viewport");}}return v;};e.prototype.setViewInfo=function(v,g){var n=this._camera?this._camera.getCameraRef():null;if(v.camera&&n){var h=v.camera;var i=h.projectionType===sap.ui.vk.CameraProjectionType.Orthographic?new THREE.OrthographicCamera():new THREE.PerspectiveCamera();i.userData=n.userData;i.aspect=n.aspect;i.position.copy(h.position);var j=h.rotation;i.quaternion.setFromEuler(new THREE.Euler(THREE.Math.degToRad(j.pitch),THREE.Math.degToRad(j.yaw),THREE.Math.degToRad(j.roll),"YXZ"));i.fov=h.fieldOfView||i.fov;i.zoom=h.zoomFactor||i.zoom;this._viewportGestureHandler._activateCamera(i,(g||0)*1000);}if(v.visibility){var k=this._viewStateManager.getNodeHierarchy(),m=new Map(),s=k.findNodesByName();s.forEach(function(w){var x=k.createNodeProxy(w);var y=x.getVeId();k.destroyNodeProxy(x);if(y){m.set(y,w);}});switch(v.visibility.mode){case sap.ui.vk.VisibilityMode.Complete:var t=v.visibility.visible,u=v.visibility.hidden;t.forEach(function(w){this._viewStateManager.setVisibilityState(m.get(w),true,false);},this);u.forEach(function(w){this._viewStateManager.setVisibilityState(m.get(w),false,false);},this);break;case sap.ui.vk.VisibilityMode.Differences:v.visibility.changes.forEach(function(w){var x=m.get(w);if(x){this._viewStateManager.setVisibilityState(x,!this._viewStateManager.getVisibilityState(x),false);}},this);break;default:q.sap.log.error(sap.ui.vk.getResourceBundle().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.threejs.Viewport");break;}}return this;};e.prototype.queueCommand=function(g){if(this instanceof sap.ui.vk.threejs.Viewport){g();}return this;};e.prototype.getOutputSize=function(){var g=this.getDomRef().getBoundingClientRect();var v=g.width;var h=g.height;var i;i=Math.min(v,h);return{left:(v-i)/2,top:(h-i)/2,sideLength:i};};return e;});
