/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","./thirdparty/three","./BBoxSubdivider","./UsageCounter"],function(L,t,B,U){"use strict";var S=function(r){this._id=S._nextId++;S._add(this);this._submeshes=new Map();this._callouts=new Map();this._cameras=new Map();this._materials=new Map();this._images=new Map();this._geometries=new Map();if(r){this._rootNode=r;this._nodes=new Map();this._NodeMeshIdSubmeshIdsMap=new Map();}else{this._rootNode=null;this._nodes=null;this._NodeMeshIdSubmeshIdsMap=null;}this._currentSceneId=null;this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._sceneIdNodMeshIdMap=new Map();};S._nextId=1;S._map=new Map();S.prototype.getId=function(){return this._id;};S._add=function(s){S._map.set(s.getId(),s);return this;};S.prototype.setRootNode=function(r,n,s){this._rootNode=r;this._nodes=new Map();this._nodes.set(n,r);this._NodeMeshIdSubmeshIdsMap=new Map();if(!this._rootNode.userData){this._rootNode.userData={};}if(s){this._sceneIdTreeNodesMap.set(s,this._nodes);this._sceneIdRootNodeMap.set(s,r);this._sceneIdNodMeshIdMap.set(s,this._NodeMeshIdSubmeshIdsMap);this._currentSceneId=s;}return this;};S.prototype._resetCurrentScene=function(s){if(s&&s!==this._currentSceneId){var n=this._sceneIdTreeNodesMap.get(s);if(n){this._nodes=n;}else{this._nodes=null;}var e=this._sceneIdRootNodeMap.get(s);if(e){this._rootNode=e;}else{this._rootNode=null;}var m=this._sceneIdNodMeshIdMap.get(s);if(m){this._NodeMeshIdSubmeshIdsMap=m;}else{this._NodeMeshIdSubmeshIdsMap=null;}this._currentSceneId=s;}};S.prototype.getNode=function(n,s){this._resetCurrentScene(s);if(!this._nodes){return null;}return this._nodes.get(n);};S.prototype.getObjectId=function(o){do{if(o.userData&&o.userData.treeNode&&o.userData.treeNode.sid){return o.userData.treeNode.sid;}o=o.parent;}while(o);return null;};var a=function(e){var m=new THREE.Matrix4();if(e.length===3){m.setPosition(new THREE.Vector3().fromArray(e));}else if(e.length===12){m.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0.0,0.0,0.0,1.0);}else if(e.length===16){m.set(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]);}else{throw"Invalid matrix format";}return m;};var D={r:0.0235,g:0.0235,b:0.0235};var b={r:0.0602,g:0.0602,b:0.0602};S.prototype._createTemporaryMaterial=function(m){var e=new THREE.MeshPhongMaterial({color:0xaaaaaa});if(!e.userData){e.userData={};}e.userData.defaultHighlightingEmissive=D;e.userData.defaultHighlightingSpecular=b;e.userData.materialUsed=0;e.userData.materialId=m;e.userData.toBeUpdated=true;this._materials.set(m,e);return e;};S.prototype.createNode=function(n,p,s){var r={needUpdateMaterial:false,needSetSubmesh:false,idOfGeometriesToUpdate:null,materialIds:[]};this._resetCurrentScene(s);var e=this._nodes.get(p)||null;var i=new THREE.Group();i.userData.treeNode=n;if(n.renderOrder){i.renderOrder=n.renderOrder;}i.visible=n.visible!==undefined?n.visible:true;if(n.name){i.name=n.name;}i.userData.opacity=n.opacity;if(n.transform){i.applyMatrix(a(n.transform));}(e||this._rootNode).add(i);this._nodes.set(n.sid,i);var j=this.attachSubMeshesToNode(n.sid,s);var m=this.applyNodeMaterialToSubmeshes(n.sid,s);var o=this.applyNodeOpacityToSubmeshes(n.sid,s);r.needUpdateMaterial=m.needUpdateMaterial;r.needSetSubmesh=j.needSetSubmesh;r.idOfGeometriesToUpdate=j.idOfGeometriesToUpdate;r.materialIds=o.materialIds;return r;};S.prototype.applyNodeMaterialToSubmeshes=function(n,s){var r={needUpdateMaterial:false};this._resetCurrentScene(s);var e=this._nodes.get(n);if(!e){return r;}var j=e.userData.treeNode;e.userData.materialId=j.materialId;if(!j.meshId||!e.userData.materialId){return r;}var k=this._materials.get(e.userData.materialId);if(!k){k=this._createTemporaryMaterial(e.userData.materialId);r.needUpdateMaterial=true;}if(e&&e.children){for(var i=0;i<e.children.length;i++){var l=e.children[i];l.material=k;l.userData.materialId=e.userData.materialId;U.increaseMaterialUsed(k);if(j.renderOrder){l.material.depthTest=false;}}}return r;};S.prototype.applyNodeOpacityToSubmeshes=function(n,s,m){var r={materialIds:[]};this._resetCurrentScene(s);var e=this._nodes.get(n);if(!e){return r;}var j=e.userData.treeNode;if(!j.meshId||!j.opacity){return r;}if(e&&e.children){var k=new Set();for(var i=0;i<e.children.length;i++){var l=e.children[i];if(l.material&&(!m||m===l.material.userData.materialId)){if(!l.material.userData.toBeUpdated){l.userData.opacity=j.opacity;l.userData.originalMaterial=l.material;l.material=l.material.clone();l.material.opacity*=l.userData.opacity;l.material.transparent=l.material.opacity<0.99;}else{k.add(l.material.userData.materialId);}}}k.forEach(function(v){r.materialIds.push(v);});}return r;};S.prototype.attachSubMeshesToNode=function(n,s){var r={needSetSubmesh:false,idOfGeometriesToUpdate:new Set()};this._resetCurrentScene(s);var e=this._nodes.get(n);var j=e.userData.treeNode;if(!j.meshId){return r;}var k=this._NodeMeshIdSubmeshIdsMap.get(j.meshId);if(!k){r.needSetSubmesh=true;return r;}var l=[];k.forEach(function(v){l.push(v);});var i;var m;for(i=0;i<l.length;i++){m=l[i];this._insertSubmesh(j.sid,m,s);}for(i=0;i<l.length;i++){m=l[i];var o=this._submeshes.get(m);if(o&&o.userData&&o.userData.isBoundingBox&&o.userData.geometryId){r.idOfGeometriesToUpdate.add(o.userData.geometryId);}}return r;};S.prototype.updateMaterialInNode=function(n,s){this._resetCurrentScene(s);var r={needUpdateMaterial:false,nodeUpdated:false};var e=this._nodes.get(n.sid);var o=e.userData.materialId;var j=e.userData.opacity;e.userData.treeNode=n;e.userData.materialId=n.materialId;e.userData.opacity=n.opacity;var k=false;if(o===undefined){if(e.userData.materialId!==undefined){k=true;}}else if(o!==e.userData.materialId){k=true;}var l=false;if(j===undefined){if(e.userData.opacity!==undefined){l=true;}}else if(j!==e.userData.opacity){l=true;}if(!k&&!l){return r;}r.nodeUpdated=true;var m=null;if(e.userData.materialId){m=this._materials.get(e.userData.materialId);if(m===undefined){m=this._createTemporaryMaterial(e.userData.materialId);r.needUpdateMaterial=true;}if(n.renderOrder){m.depthTest=false;}}if(e&&e.children){for(var i=0;i<e.children.length;i++){var p=e.children[i];if(m){p.material=m;p.userData.materialId=n.materialId;U.increaseMaterialUsed(m);}else{var q=this._materials.get(p.userData.initialMaterialId);p.material=q;p.userData.materialId=p.userData.initialMaterialId;U.increaseMaterialUsed(q);}delete p.userData.originalMaterial;if(e.userData.opacity!==undefined&&(p.material.userData&&!p.material.userData.toBeUpdated)){p.userData.opacity=e.userData.opacity;p.userData.originalMaterial=p.material;p.material=p.material.clone();p.material.opacity*=p.userData.opacity;p.material.transparent=p.material.opacity<0.99;}else{p.userData.opacity=undefined;}}}return r;};S.prototype.updateGeometryInNode=function(n,e,s){this._resetCurrentScene(s);var j=this._nodes.get(n);if(j&&j.children){for(var i=0;i<j.children.length;i++){var k=j.children[i];if(!k.isMesh){continue;}if(k.userData.geometryId===e){var l=this._geometries.get(e);if(l){if(l.isPolyline&&!k.isLineSegment){var p=k.parent;var m=k.material;p.remove(k);var o=new THREE.LineBasicMaterial({color:0xff0000,linewidth:1,depthTest:false});o.color.copy(m.color);var q=new THREE.LineSegments(l,o);p.add(q);q.userData.meshId=k.userData.meshId;if(l.isPositionQuantized){q.position.copy(k.position);q.scale.copy(k.scale);}q.userData.initialMaterialId=k.userData.initialMaterialId;q.userData.isBoundingBox=false;q.userData.geometryId=k.userData.geometryId;q.userData.meshId=k.userData.meshId;q.userData.materialId=k.userData.materialId;q.userData.submeshInfo=k.userData.submeshInfo;q.userData.submeshId=k.userData.submeshId;var r=this._submeshes.get(q.userData.submeshId);if(r&&r.renderOrder){q.renderOrder=r.renderOrder;}this._submeshes.set(q.userData.submeshId,q);}else{k.geometry=l;k.userData.isBoundingBox=false;if(!l.isPositionQuantized){k.position.set(0,0,0);k.scale.set(1,1,1);}}U.increaseGeometryUsed(l);}}}}return this;};S.prototype.getChildNodeIds=function(n,s,e){this._resetCurrentScene(s);var j=this._nodes.get(n);var k=[];if(!j){return k;}if(j&&j.children){for(var i=0;i<j.children.length;i++){var l=j.children[i];if(l.userData&&l.userData.treeNode&&l.userData.treeNode.sid){k.push(l.userData.treeNode.sid);}else if(e&&l.userData&&l.userData.submeshInfo&&l.userData.submeshInfo.id){k.push(l.userData.submeshInfo.id);}}}return k;};function c(e){var j=atob(e);var l=j.length;var k=new Uint8Array(l);for(var i=0;i<l;i++){k[i]=j.charCodeAt(i);}return k;}function f(l){if(l){for(var i=0;i<l.length;i++){if(l[i].type==="box"&&l[i].data){return l[i];}}}return null;}function d(v){if(v===0){return Number.EPSILON;}return v;}function u(m,p){m.position.set((p[3]+p[0])/2,(p[4]+p[1])/2,(p[5]+p[2])/2);m.scale.set(d(p[3]-p[0]),d(p[4]-p[1]),d(p[5]-p[2]));}S.prototype.setSubmesh=function(m,s){var r={needUpdataMaterial:false,geometryIdToRequest:null,geometryPriority:0};var j=this._NodeMeshIdSubmeshIdsMap.get(m);if(!j){j=new Set();this._NodeMeshIdSubmeshIdsMap.set(m,j);}j.add(s.id);if(!s.lods){return false;}var l=null;for(var i=0;i<s.lods.length;i++){if(s.lods[i].type===undefined||s.lods[i].type==="mesh"||s.lods[i].type==="line"){l=s.lods[i];}}if(!l){return false;}var k=null;if(s.materialId){k=this._materials.get(s.materialId);if(!k){k=this._createTemporaryMaterial(s.materialId);r.needUpdataMaterial=true;}}var n=null;var o=this._geometries.get(l.id);if(o){if(k){n=new THREE.Mesh(o,k);}else{n=new THREE.Mesh(o);}n.userData.initialMaterialId=s.materialId;n.userData.isBoundingBox=false;n.userData.geometryId=l.id;n.userData.meshId=m;n.userData.submeshId=s.id;n.userData.materialId=s.materialId;if(o.isPositionQuantized){u(n,l.boundingBox);}U.increaseGeometryUsed(o);}else{r.geometryIdToRequest=l.id;var p;try{var q=f(s.lods);if(q&&q.data){var v=c(q.data);var w=B.unpackSubDividedBoundingBox(v);p=B.makeSubDividedBoundingBoxGeometry(w);}}catch(e){}var x=new THREE.BoxBufferGeometry(1,1,1);n=new THREE.Mesh(p?p:x,k);var y=l.boundingBox;if(Array.isArray(y)&&y.length===6){r.geometryPriority=new THREE.Vector3(y[3]-y[0],y[4]-y[1],y[5]-y[2]).length();}else{y=[0,0,0,1,1,1];}u(n,y);n.userData.initialMaterialId=s.materialId;n.userData.isBoundingBox=true;n.userData.geometryId=l.id;n.userData.meshId=m;n.userData.materialId=s.materialId;n.userData.submeshId=s.id;}n.userData.submeshInfo=s;this._submeshes.set(s.id,n);return r;};S.prototype.getSubmesh=function(s){return this._submeshes.get(s);};S.prototype.setGeometry=function(e){var i=new THREE.BufferGeometry();var j=new THREE.BufferAttribute(new Uint16Array(e.data.indices),1);var p=new THREE.BufferAttribute(new Float32Array(e.data.points),3);i.setIndex(j);i.addAttribute("position",p);if(!e.isPolyline){if(e.data.normals.length===e.data.points.length){var n=new THREE.BufferAttribute(new Float32Array(e.data.normals),3);i.addAttribute("normal",n);}if(e.data.uvs&&e.data.uvs.length*3===e.data.points.length*2){i.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(e.data.uvs),2));}}else{i.isPolyline=true;}i.computeBoundingSphere();i.isPositionQuantized=e.isPositionQuantized;if(!i.userData){i.userData={};}i.userData.geometryId=e.id;i.userData.geometryUsed=0;this._geometries.set(e.id,i);return this;};S.prototype.getGeometry=function(e){return this._geometries.get(e);};S.prototype._insertSubmesh=function(n,s,e){this._resetCurrentScene(e);var i=this._nodes.get(n);var j=this._submeshes.get(s);if(!i||!j){return false;}if(j.parent){j=j.clone();if(j.userData){if(j.userData.submeshInfo&&j.userData.initialMaterialId){var m=this._materials.get(j.userData.initialMaterialId);if(m){j.material=m;U.increaseMaterialUsed(m);}}if(j.userData&&j.userData.opacity){delete j.userData.opacity;}}}i.add(j);if(i.renderOrder){j.renderOrder=i.renderOrder;var M=this._materials.get(j.userData.initialMaterialId);if(M){M.depthTest=false;}}return true;};S.prototype._decrementResourceCounters=function(e){e.traverse(function(i){if(i.isMesh){U.decreaseMaterialUsed(i.material);U.decreaseGeometryUsed(i.geometry);}});};S.prototype.decrementResourceCountersForDeletedTreeNode=function(n,s){this._resetCurrentScene(s);var e=this;n=[].concat(n);n.forEach(function(i){var j=e._nodes.get(i);if(j){e._decrementResourceCounters(j);e._nodes.delete(i);}});return this;};S.prototype.remove=function(n,s){this._resetCurrentScene(s);var e=this;n=[].concat(n);n.forEach(function(j){var k=e._nodes.get(j);if(k){e._decrementResourceCounters(k);if(k.parent){k.parent.remove(k);}e._nodes.delete(j);for(var i=0;i<k.children.length;i++){var l=k.children[i];if(l.userData&&l.userData.treeNode&&l.userData.treeNode.sid){e.remove(l.userData.treeNode.sid,s);}}}});return this;};S.prototype.resourcesCleanUp=function(){var e=this._geometries;e.forEach(function(i){var j=i.userData.geometryUsed;if(j<=0){i.dispose();}});var m=this._materials;if(m){m.forEach(function(i){var j=i.userData.materialUsed;if(j<=0){i.dispose();}});}return this;};S.prototype.createCamera=function(e,s){this._resetCurrentScene(s);var i=null;var j=e.id;i=this._cameras.get(j);if(!i||(!i.isOrthographicCamera&&e.ortho)){if(e.ortho){i=new THREE.OrthographicCamera(-1,1,1,-1,e.near,e.far);}else{i=new THREE.PerspectiveCamera(e.fov*180/Math.PI,1,e.near,e.far);}}i.cameraInfo=e;if(e.origin){var o=new THREE.Vector3().fromArray(e.origin);i.position.copy(o);}if(e.up){var k=new THREE.Vector3().fromArray(e.up).normalize();i.up.copy(k);}if(e.target){i.lookAt((new THREE.Vector3().fromArray(e.target)).add(i.position));}if(e.ortho){i.zoom=e.zoom||0.02;}this._rootNode.userData.camera=i;if(j){this._cameras.set(j,i);}return i;};S.prototype.insertCamera=function(n,e,s){this._resetCurrentScene(s);var i=this._nodes.get(n);var j=this._cameras.get(e);if(i&&j){i.add(j.parent?j.clone():j);}return this;};S.prototype.getCamera=function(e){return this._cameras.get(e);};S.prototype.updateMaterialForGeometryWithoutNormal=function(m){var e=this._materials.get(m);if(e){e.emissive.copy(e.color);e.side=THREE.DoubleSide;}return this;};S.prototype.createMaterial=function(m){var r=[];var e=this._materials.get(m.id);if(m.lineWidth>0){if(!e||!e.isLineBasicMaterial){e=new THREE.LineBasicMaterial();this._materials.set(m.id,e);}e.color=new THREE.Color(m.lineColor[0],m.lineColor[1],m.lineColor[2]);e.depthTest=false;e.linewidth=m.lineWidth;e.userData.mateialInfo=m;e.userData.materialId=m.id;return r;}if(!e){e=this._createTemporaryMaterial(m.id);}if(e.userData&&e.userData.toBeUpdated){delete e.userData.toBeUpdated;}e.userData.materialInfo=m;if(m.diffuseColour){e.color.fromArray(m.diffuseColour);}if(m.specularColour){e.specular.fromArray(m.specularColour);}var i=true;if(m.emissiveColour){e.emissive.fromArray(m.emissiveColour);if(e.emissive.r!==0||e.emissive.g!==0||e.emissive.b!==0){i=false;}}if(i&&m.ambientColour){e.emissive.fromArray(m.ambientColour);e.emissive.multiplyScalar(0.2);}if(e.opacity!==undefined){e.opacity=m.opacity;e.transparent=m.opacity<1;if(e.transparent){e.side=THREE.DoubleSide;}}var j=e.glossiness?e.glossiness:0;var s=e.specularLevel?e.specularLevel:0;e.shininess=j*2+s*3;e.userData.defaultHighlightingEmissive=D;e.userData.defaultHighlightingSpecular=b;r=this.updateTextureMaps(m.id);return r;};S.prototype.getMaterial=function(m){return this._materials.get(m);};var g=function(i){var j="";try{var C=0x8000;var k=0;var l=i.length;var s;while(k<l){s=i.slice(k,Math.min(k+C,l));j+=String.fromCharCode.apply(null,s);k+=C;}}catch(e){j="";}return j;};S.prototype.createImage=function(i){var e=new DataView(i.binaryData.buffer);var j=true;if(e.getUint8(0,true)===parseInt("0xFF",16)&&e.getUint8(1,true)===parseInt("0xD8",16)){j=false;}var k=g(i.binaryData);var l="data:image/"+(j?"png":"jpeg")+";base64,"+btoa(k);this._images.set(i.id,l);return this;};var h=new THREE.TextureLoader();S.TextureType={Diffuse:0,Bump:1,Opacity:2,Reflection:3,Refraction:4,Specular:5,Ambient:6,Emissive:7,SpecularLevel:8,Glosiness:9,AmbientOcclusion:10,Decal:11};S.prototype.updateTextureMaps=function(m){var r=[];var e=this._materials.get(m);if(!e){return r;}var i=e.userData.materialInfo;if(!i){return r;}if(i.textureDiffuse){var j=this.updateTextureMap(i.id,S.TextureType.Diffuse);if(j.imageId){r.push(j);}}if(i.textureBump){var k=this.updateTextureMap(i.id,S.TextureType.Bump);if(k.imageId){r.push(k);}}if(i.textureOpacity){var o=this.updateTextureMap(i.id,S.TextureType.Opacity);if(o.imageId){r.push(o);}}if(i.textureEmissive){var l=this.updateTextureMap(i.id,S.TextureType.Emissive);if(l.imageId){r.push(l);}}if(i.textureAmbientOcclusion){var n=this.updateTextureMap(i.id,S.TextureType.AmbientOcclusion);if(n.imageId){r.push(n);}}if(i.textureReflection){var p=this.updateTextureMap(i.id,S.TextureType.Reflection);if(p.imageId){r.push(p);}}return r;};S.prototype.updateTextureMap=function(m,e){var r={textureType:e,imageId:null};var i=this._materials.get(m);if(!i){return r;}var j=i.userData.materialInfo;if(!j){return r;}var k=null;switch(e){case S.TextureType.Diffuse:k=j.textureDiffuse;break;case S.TextureType.Bump:k=j.textureBump;break;case S.TextureType.Opacity:k=j.textureOpacity;break;case S.TextureType.Reflection:k=j.textureReflection;break;case S.TextureType.Emissive:k=j.textureEmissive;break;case S.TextureType.AmbientOcclusion:k=j.textureAmbientOcclusion;break;default:break;}if(!k){return r;}var l=k[0];var n=this._images.get(l.imageId);if(!n){r.imageId=l.imageId;return r;}var o=h.load(n);o.wrapS=l.uvHorizontalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;o.wrapT=l.uvVerticalTilingEnabled?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping;o.magFilter=l.filterMode===1?THREE.NearestFilter:THREE.LinearFilter;o.minFilter=l.filterMode===1?THREE.NearestFilter:THREE.LinearMipMapLinearFilter;o.anisotropy=4;var p=l.influence!==undefined?l.influence:0;var q=l.uvHorizontalScale!==undefined?l.uvHorizontalScale:1;var s=l.uvVerticalScale!==undefined?l.uvVerticalScale:1;var v=l.uvHorizontalOffset!==undefined?l.uvHorizontalOffset:0;var w=l.uvVerticalOffset!==undefined?l.uvVerticalOffset:0;o.repeat.set(q,s);o.center.set(-v,-w);o.offset.set(v,w);o.rotation=-l.uvRotationAngle;switch(e){case S.TextureType.Diffuse:i.map=o;i.transparent|=n.startsWith("data:image/png");break;case S.TextureType.Bump:i.bumpMap=o;i.bumpScale=p;break;case S.TextureType.Opacity:i.alphaMap=o;break;case S.TextureType.Reflection:o.mapping=THREE.SphericalReflectionMapping;i.envMap=o;i.combine=THREE.AddOperation;i.reflectivity=p;break;case S.TextureType.Emissive:i.emissiveMap=o;break;case S.TextureType.AmbientOcclusion:i.aoMap=o;break;default:}i.userData.textureAdded=true;return r;};S.prototype.cleanup=function(){this._rootNode=null;if(this._nodes){this._nodes.clear();}if(this._NodeMeshIdSubmeshIdsMap){this._NodeMeshIdSubmeshIdsMap.clear();}this._submeshes.clear();this._callouts.clear();this._cameras.clear();this._materials.clear();this._images.clear();this._geometries.clear();this._currentSceneId=null;this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();this._sceneIdNodMeshIdMap.clear();S._map.delete(this._id);};return S;});
