/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["jquery.sap.global","sap/ui/base/ManagedObject","./thirdparty/three","sap/ui/vk/totara/TotaraLoader","./PerspectiveCamera","./OrthographicCamera","sap/ui/vk/View","./Material"],function(q,M,t,T,P,O,V,a){"use strict";var C=M.extend("sap.ui.vk.threejs.ContentDeliveryService",{metadata:{properties:{authorizationHandler:"any"},events:{cameraChanged:{parameters:{sceneId:{type:"string"},camera:{type:"any"}},enableEventBubbling:true},sceneUpdated:{parameters:{},enableEventBubbling:true},errorReported:{parameters:{error:{type:"any"}}}}}});var b=C.getMetadata().getParent().getClass().prototype;C.prototype.init=function(){if(b.init){b.init.call(this);}this._loader=null;this._transientSceneMap=new Map();this._currentNodeHierarchy=null;};C.prototype.initUrl=function(u,k){var d=this;function n(){d.fireSceneUpdated({});}if(!d._loader){this._loader=new T();var s=this._loader.getState();s.onErrorCallbacks.attach(this._reportError.bind(d));s.onMaterialFinishedCallbacks.attach(n);s.onImageFinishedCallbacks.attach(n);s.onSetGeometryCallbacks.attach(n);return this._loader.init(u);}else if(!k){var e=this._loader.getState();if(e){e.cleanup();}}return Promise.resolve("Loader is ready");};function c(d){if(!d){return null;}var e;if(d.isOrthographicCamera){e=new sap.ui.vk.threejs.OrthographicCamera();}else if(d.isPerspectiveCamera){e=new sap.ui.vk.threejs.PerspectiveCamera();}e.setCameraRef(d);e.setUsingDefaultClipPlanes(true);if(d.cameraInfo&&d.cameraInfo.zoom===-1){e.setZoomNeedRecalculate(true);}return e;}C.prototype._reportError=function(e){this.fireErrorReported(e);};C.prototype._createLoadParam=function(r,d,p,e){var f=this;var i;var s=false;var g={root:p,includeHidden:e.getIncludeHidden(),pushPMI:e.getPushPMI(),metadataFilter:e.getMetadataFilter(),useSecureConnection:e.getUseSecureConnection(),activateView:e.getActivateView(),enableLogger:e.getEnableLogger()===true,onActiveCamera:function(n){var j=false;var k=f._loader.getState();if(k){var l=k.contextMap.get(e.getVeid());if(l&&l.phase<2){i=c(n);j=true;}}if(!j){f.fireCameraChanged({sceneId:e.getVeid(),camera:c(n)});}},onInitialSceneFinished:function(){s=true;r({node:p,camera:i,contentResource:e,loader:f});}};var h=function(j){var k;if(j.getParameter("errorText")){k=j.getParameter("errorText");}else if(j.getParameter("error")){k=j.getParameter("error");}else if(j.getParameter("reason")){k=j.getParameter("reason");}else{k="failed to load: unknown reason";}if(s){var l=j.getParameter("error");if(l&&l===4){this.initUrl(this._loader.getUrl(),true);}}else{f.detachErrorReported(h);if(j.getParameter("events")){k=k+"\n"+JSON.stringify(j.getParameter("events"));}d(k);}};f.attachErrorReported(h);return g;};C.prototype.load=function(p,d,e){var f=this;var n=d.getNodeProxy();if(n){this._currentNodeHierarchy=n.getNodeHierarchy();}return new Promise(function(r,g){if(!d.getSource()||!d.getVeid()){g("url or veid not specified");return;}f.initUrl(d.getSource());var h=f._createLoadParam(r,g,p,d);if(f._loader){f._loader.request(d.getVeid(),h,e);}});};C.prototype.getState=function(){if(this._loader){return this._loader.getState();}return null;};C.prototype.decrementResourceCountersForDeletedTreeNode=function(s){var d=this.getState();if(d){var e=d.getContext(d.currentSceneInfo.id);this._loader.decrementResourceCountersForDeletedTreeNode(d,e,s);}};C.prototype.loadTransientScene=function(s,p,u){var d=this;return new Promise(function(r,e){if(!s||!p){e("invalid arguments");return;}if(d._transientSceneMap.has(s)){var f=d._transientSceneMap.get(s).clone();p.add(f);r({nodeRef:f});return;}if(!d._loader){e("ContentDeliveryService is not initialised");return;}var g=new THREE.Object3D();g.name="transient";var o=function(){var i=d._loader.getState().getContext(s);i.onSceneCompletedCallbacks.detach(o);d._transientSceneMap.set(s,g);var f=g.clone();p.add(f);r({nodeRef:f});};var h={root:g,onSceneCompleted:o,useSecureConnection:u};d._loader.request(s,h);});};C.prototype.update=function(s,d,v){var e=this;return new Promise(function(r,f){if(!e._loader){f("ContentDeliveryService is not initialised");return;}e._loader.update(s,d,v).then(function(g){if(e._currentNodeHierarchy){for(var i=0;i<g.replacedNodeRefs.length;i++){e._currentNodeHierarchy.fireNodeReplaced({ReplacedNodeRef:g.replacedNodeRefs[i],ReplacementNodeRef:g.replacementNodeRefs[i],ReplacedNodeId:g.replacedNodeRefs[i],ReplacementNodeId:g.replacementNodeRefs[i]});}}r({sceneVeId:g.sceneVeId,sids:g.sidArray});}).catch(function(g){return f(g);});});};C.prototype.exit=function(){if(b.exit){b.exit.call(this);}if(this._loader){this._loader.dispose();this._loader=null;}this._transientSceneMap=null;};C.prototype.loadView=function(s,v,d){if(typeof d==="undefined"){d="static";}var e=this;return this._loader.requestView(s,d,v).then(function(f){var m=new sap.ui.vk.View({name:f.name,nodeInfos:f.viewNodes});if(f.camera){var g=true;var r=false;if(f.camera.cameraInfo&&f.camera.cameraInfo.zoom===-1){r=true;}if(f.camera.type==="PerspectiveCamera"){m.setCameraInfo({type:f.camera.type,fov:f.camera.cameraInfo.fov*180/Math.PI,position:f.camera.position.toArray(),nearClipPlane:f.camera.near,farClipPlane:f.camera.far,upDirection:f.camera.up.toArray(),targetDirection:f.camera.getWorldDirection().toArray(),usingDefaultClipPlanes:g});}if(f.camera.type==="OrthographicCamera"){m.setCameraInfo({type:f.camera.type,zoomFactor:f.camera.zoom,position:f.camera.position.toArray(),nearClipPlane:f.camera.near,farClipPlane:f.camera.far,upDirection:f.camera.up.toArray(),targetDirection:f.camera.getWorldDirection().toArray(),usingDefaultClipPlanes:g,zoomNeedRecalculate:r});}}if(e._currentNodeHierarchy){for(var i=0;i<f.updatedNodes.length;i++){e._currentNodeHierarchy.fireNodeUpdated({nodeRef:f.updatedNodes[i]});}}e.fireSceneUpdated({});return m;}).catch(function(f){q.sap.log.error(f);return null;});};C.prototype.assignMaterialToNodes=function(s,m,n,d){var e=this;return this._loader.requestMaterial(m).then(function(f){function g(f,l,r){if(!l){return;}if(l.userData.markedForNotAssigningMaterial){delete l.userData.markedForNotAssigningMaterial;return;}if(e._currentNodeHierarchy){var o=e._currentNodeHierarchy.createNodeProxy(l);var p=new a();p.setMaterialRef(f);o.assignMaterial(p);}if(r){l.children.forEach(function(u){if(!u){return;}g(f,u,r);});}}if(!d){for(var i=0;i<n.length;i++){g(f,n[i]);}}else{for(var j=0;j<n.length;j++){n[j].userData.markedForNotAssigningMaterial=true;}var h=e._loader.getState().contextMap.get(s);var k=h.root;g(f,k,true);}e.fireSceneUpdated({});return true;}).catch(function(f){q.sap.log.error(f);return false;});};C.prototype.printLogTokens=function(){if(this._loader){this._loader.printLogTokens();return true;}else{return false;}};return C;});
