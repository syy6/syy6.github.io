
function HttpConnection(){"use strict";var u;var a;var o;function m(u){var p=new Promise(function(r,b){var x=new XMLHttpRequest();x.onload=function(){if(this.status>=200&&this.status<300){r(x.response);}else{b({status:this.status,statusText:x.statusText});}};x.onerror=function(){b({status:this.status,statusText:x.statusText});};x.open("GET",u,true);if(a){x.setRequestHeader("Authorization",a);}x.responseType="arraybuffer";x.send();});return p;}this.getUrl=function(){return u;};this.close=function(){};this.send=function(b,c,d){if(!b){return;}var t=this;m(encodeURI(u+b)).then(d||function(r){if(t.onResponse){t.onResponse(r);}}).catch(function(r){if(o){o({errorText:"could not connect to server:"+u,error:r.status,reason:r,context:c});}});};this.init=function(s,b){return new Promise(function(r,c){u=s;if(b!=null){b(s).then(function(t){if(t!=null){a=t.token_type+" "+t.access_token;}else{a=null;}r({});}).catch(function(d){return c(d);});}else{r({});}});};this.setOnErrorCallback=function(c){o=c;};this.onResponse=null;}
function WebSocketConnection(){"use strict";var l;var t=this;var c;var o;function i(){if(c&&c.readyState===1){return true;}return false;}function a(m,e,h){if(o){o({errorText:m,error:h,context:e});}}this.setOnErrorCallback=function(e){o=e;};this.getUrl=function(){return l;};this.close=function(){if(c){c.close();c=null;}};this.send=function(m,h){if(!m){return;}if(!i()){a("websocket connection lost",h,4);}else{try{c.send(m);}catch(e){a(e,h);}}};var b=0;function k(){var e=60000;if(c.readyState==1){c.send("");}b=setTimeout(k,e);}function d(){if(b){clearTimeout(b);b=0;}}var f=false;var g=function(e){var r=JSON.stringify(e);var h="setStreamingToken"+("["+r.length+"]")+r;return h;};this.init=function(s,h){return new Promise(function(r,j){if(s){l=s;}else{s=l;}c=new WebSocket(s);c.binaryType="arraybuffer";c.onopen=function(){f=true;if(h!=null){h(s).then(function(e){if(e!=null){var m=g({"token":e.access_token});c.send(m);}k();r({});}).catch(function(e){return j(e);});}else{k();r({});}};c.onclose=function(){d();};c.onmessage=function(e){var m=e.data;if(t.onResponse){t.onResponse(m);}};c.onerror=function(e){if(!f){j("error connecting to "+s);}else{a(e);}};});};this.onResponse=null;}
function findChar(c,s,u){"use strict";for(var i=s;i<u.length;i++){if(u[i]===c){return i;}}return-1;}
function getContentLength(c){"use strict";var l=c.split(",");if(l.length<0||l.length>2){throw"invalid content length";}var j=0;var b=0;try{j=parseInt(l[0],10);if(l.length===2){b=parseInt(l[1],10);}}catch(e){throw"invalid content length";}return{jsonContentLength:j,binaryContentLength:b};}
function Parser(){"use strict";}
Parser.createCommandList=function(a,o){"use strict";var b=new Uint8Array(a);var c=[];var s=0;var d=0;var f;var j;var g;while(d<b.length){d=findChar("[".charCodeAt(0),s,b);if(d===-1){break;}var h=Decoder.decode(b.slice(s,d)).replace(/\n|\r|\s/g,"");s=d+1;d=findChar("]".charCodeAt(0),s,b);if(d===-1){throw"No matching [] for command length. abort";}f=getContentLength(Decoder.decode(b.slice(s,d)));s=d+1;d=s+f.jsonContentLength;j=Decoder.decode(b.slice(s,d));try{j=JSON.parse(j);}catch(e){var i=h+": "+e;throw i;}if(f.binaryContentLength){s=d;d=s+f.binaryContentLength;g=b.slice(s,d);}else{g=undefined;}s=d;var k={name:h,jsonContent:j,binaryContent:g};if(o){o(k);}c.push(k);}return c;};
function Decoder(){"use strict";}
Decoder.uint8ArrayToString=function(u){"use strict";var f="";try{var C=0x8000;var i=0;var l=u.length;var s;while(i<l){s=u.slice(i,Math.min(i+C,l));f+=String.fromCharCode.apply(null,s);i+=C;}}catch(e){f="";}return f;};
Decoder.decode=function(u){"use strict";var e=Decoder.uint8ArrayToString(u);return decodeURIComponent(escape(e));};
function LoaderProxy(){"use strict";this.init=function(a,h,b){this._connection=a;this._connectionHTTP=h;this._sceneBuilderId=b;if(!a){throw"no connection provided for loader!";}this._connection.onResponse=function(r){var c=Parser.createCommandList(r);p(c);};};function p(c){var d;for(var i=0;i<c.length;i++){var a=c[i];if(a.binaryContent){d={name:a.name,jsonContent:a.jsonContent,binaryContent:a.binaryContent};self.postMessage(d,[d.binaryContent.buffer]);}else{d={name:a.name,jsonContent:a.jsonContent};self.postMessage(d);}}}this.getConnection=function(){return this._connection;};this.send=function(c){if(this._connectionHTTP&&c.resource){switch(c.method){case"getImage":this._connectionHTTP.send("images/"+c.resource,c,function(r){p([{name:"setImage",jsonContent:{id:c.resource},binaryContent:new Uint8Array(r)}]);});return;case"getGeometry":this._connectionHTTP.send("geometry?id="+c.resource,c,function(r){var d=new DataView(r);var b=d.getUint16(2,true);if(b>0){var g={id:d.getUint32(4,true).toString(),box:[d.getFloat32(14,true),d.getFloat32(18,true),d.getFloat32(22,true),d.getFloat32(26,true),d.getFloat32(30,true),d.getFloat32(34,true)]};var a=d.getUint16(8,true);if(a!==3){g.flags=d.getUint16(38,true);g.pointCount=d.getUint16(46,true);g.elementCount=d.getUint16(48,true);}var e=d.getUint32(52,true);var f=new Uint8Array(r,56,e);p([{name:"setGeometry",jsonContent:g,binaryContent:f}]);}});return;default:break;}}if(this._connection){this._connection.send(c.command);}};this.setSceneBuilderId=function(i){this._sceneBuilderId=i;};this.getSceneBuilderId=function(){return this._sceneBuilderId;};this.authorizationHandler=function(u){return new Promise(function(r,a){var d={name:"getAuthorization",jsonContent:{"url":u}};self.loader.authorizationHandler.resolve=r;self.loader.authorizationHandler.reject=a;self.postMessage(d);});};}
LoaderProxy.HttpConnection=HttpConnection;LoaderProxy.WebSocketConnection=WebSocketConnection;var loader=new LoaderProxy();var onmessage=function(e){"use strict";var d=e.data;switch(d.method){case"initializeConnection":if(!d.url){break;}var a=loader.getConnection();if(!a||a.getUrl()!==d.url){if(a){a.close();}var c;if(d.url.toLowerCase().startsWith("ws")){c=new WebSocketConnection();c.init(d.url,loader.authorizationHandler).then(function(){loader.init(c,null,d.sceneBuilderId);if(d.command){loader.send(d);}}).catch(function(b){});}else if(d.url.toLowerCase().startsWith("http")){c=new HttpConnection();c.init(d.url,loader.authorizationHandler).then(function(){loader.init(c,null,d.sceneBuilderId);if(d.command){loader.send(d);}}).catch(function(b){});}else{c=new WebSocketConnection();c.init((d.useSecureConnection?"wss://":"ws://")+d.url+"streaming?",loader.authorizationHandler).then(function(){var b=new HttpConnection();b.init((d.useSecureConnection?"https://":"http://")+d.url,loader.authorizationHandler).then(function(){loader.init(c,b,d.sceneBuilderId);if(d.command){loader.send(d);}}).catch(function(f){});}).catch(function(b){});}}else if(d.command){loader.send(d);}break;case"setAuthorization":if(d.error==null){loader.authorizationHandler.resolve(d.authorizationToken);}else{loader.authorizationHandler.reject(d.error);}delete(loader.authorizationHandler.resolve);delete(loader.authorizationHandler.reject);break;default:if(d.command){loader.send(d);}break;}};self.onmessage=onmessage;postMessage({ready:true});
