sap.ui.define(["jquery.sap.global","./ListMap","./RequestCommandGenerator","./CallbackHandler","./SceneStateContext","./Processor","./Commands","./Generator","./SceneState","./TotaraUtils"],function(q,L,R,C,S,P,a,G,b,T){"use strict";var c=function(){var _=new b();var d=false;var e=new P();var f=null;var g=this;function s(r,t){if(!g._worker){return false;}var i=false;if(r){while(r.canGenerateCommand()){var n=r.generateRequestCommand(true,t);g._worker.postMessage(n);i=true;}}return i;}function h(){var i=false;var t;var v=_.contextMap.values();var j=v.next();while(!j.done){var k=j.value;j=v.next();if(s(k.requestCommandGenerator,k.token)){i=true;}t=k.token;}if(!i){s(_.requestCommandGenerator,t);}}this.getUrl=function(){return f;};this.init=function(j){f=j;function o(i){if(i){i.phase=S.Phase.FinishedHierarchy;}if(!d){var m=i.meshGroupListMap;var k=new Set(m.keys());i.requestCommandGenerator.pushMeshIds(k);if(k.size===0){if(i.retrievalType===S.RetrievalType.Initial){i.onInitialSceneFinishedCallbacks.execute();}if(i.retrievalType===S.RetrievalType.Partial){i.onPartialRetrievalFinishedCallbacks.execute();}if(i.isSceneCompleted()){i.onSceneCompletedCallbacks.execute();}}}var n=_.materialIdsToRequest;if(n&&n.size){_.requestCommandGenerator.pushMaterialIds(n);}h();}e.setCommandCallback(a.notifyFinishedTree,function(i){if(i.error){return;}var k=i.context;o(k);});e.setCommandCallback(a.setMesh,function(k){if(k.error){return;}_.requestCommandGenerator.pushMaterialIds(k.materialIdSet);_.requestCommandGenerator.pushGeometryIds(k.geometryIdMap);if(k.updatedContexts){for(var i=0;i<k.updatedContexts.length;i++){var m=k.updatedContexts[i];if(m.meshGroupListMap.size===0){m.phase=S.Phase.FinishedMesh;m.onMeshFinishedCallbacks.execute();if(m.retrievalType===S.RetrievalType.Initial){m.onInitialSceneFinishedCallbacks.execute();}else if(m.retrievalType===S.RetrievalType.Partial){m.onPartialRetrievalFinishedCallbacks.execute();}if(m.isSceneCompleted()){m.onSceneCompletedCallbacks.execute();}m.progressCount.geometry.total=m.boundingBoxNodeIdsListMap.size;var t=m.token;if(m.isSceneCompleted()){l(m,"sceneCompleted",t);}else{l(m,"meshFinished",t);}}}}h();});e.setCommandCallback(a.setGeometry,function(k){if(k.error){return;}_.onSetGeometryCallbacks.execute(k);if(k.updatedContexts){for(var i=0;i<k.updatedContexts.length;i++){var m=k.updatedContexts[i];if(m.isSceneCompleted()){m.onSceneCompletedCallbacks.execute();var t=m.token;if(m.isSceneCompleted()){l(m,"sceneCompleted",t);}else{l(m,"geometryFinished",t);}m.finishedTime=Date.now();}}}});e.setCommandCallback(a.setTree,function(i){if(i.error&&i.context){_.contextMap.delete(i.context.sceneId);}});e.setCommandCallback(a.notifyFinishedView,function(r){if(r.error){return;}var i=r.context;if(i){var m=_.materialIdsToRequest;if(m&&m.size){_.requestCommandGenerator.pushMaterialIds(m);h();}if(r.view){var n=[];i.updatedNodes.forEach(function(v){n.push(v);});r.view.updatedNodes=n;}if(i.meshGroupListMap.size===0){i.onViewFinishedCallbacks.execute(r.view);}else{i.retrievalType=S.RetrievalType.Partial;var k=new Set(i.meshGroupListMap.keys());i.requestCommandGenerator.pushMeshIds(k);var p=function(){i.onPartialRetrievalFinishedCallbacks.detach(p);i.onViewFinishedCallbacks.execute(r.view);};i.onPartialRetrievalFinishedCallbacks.attach(p);l(i,"notifyFinishedView",i.token);h();}}});e.setCommandCallback(a.setMaterial,function(r){if(r.error){return;}_.requestCommandGenerator.pushImageIds(r.imageIdSet);if(_.materialIdsToRequest.size===0){_.onMaterialFinishedCallbacks.execute();}h();});e.setCommandCallback(a.setImage,function(r){if(r.error){return;}if(_.texturesToUpdate.size===0){_.onImageFinishedCallbacks.execute();}});e.setCommandCallback(a.setView,function(r){if(r.error){return;}var i=r.context;var t=i?i.token:null;l(i,"setView",t);});e.setCommandCallback(a.notifyError,function(r){_.onErrorCallbacks.execute(r);});var g=this;return new Promise(function(r){if(!g._work){g._worker=new Worker(sap.ui.require.toUrl("sap/ui/vk/totara/TotaraLoaderWorker.js"));g._worker.onmessage=function(i){var k=i.data;if(k.ready){return;}if(k.name==="getAuthorization"){if(_.getContext(_.currentSceneInfo.id).authorizationHandler){_.getContext(_.currentSceneInfo.id).authorizationHandler(k.jsonContent.url).then(function(t){g._worker.postMessage({"method":"setAuthorization","authorizationToken":t});}).catch(function(n){g._worker.postMessage({"method":"setAuthorization","authorizationToken":null,"error":n.toString()});});}else{g._worker.postMessage({"method":"setAuthorization","authorizationToken":null});}return;}var m={name:k.name,jsonContent:k.jsonContent};if(k.binaryContent){m.binaryContent=k.binaryContent;}e.process(_,m);};g._worker.onerror=function(i){};}});};this.enablePushMesh=function(i){d=i;};this.dispose=function(){e=null;if(_){if(_.contextMap){var v=_.contextMap.values();var i=v.next();while(!i.done){var j=i.value;i=v.next();j.dispose();}}_.dispose();_=null;}if(this._worker){this._worker.terminate();this._worker=undefined;}};function l(i,n,t){if(i&&i.progressLogger&&t&&n){i.progressLogger.logPerformance(n,t);}}this.request=function(i,j,k){if(!j.root){throw"context must include root where three js objects are attached to";}var m=_.createContext(i,j);_.currentSceneInfo.id=i;m.retrievalType=S.RetrievalType.Initial;m.authorizationHandler=k;m.initialRequestTime=Date.now();var t;if(m.enableLogger){var n=T.createLogger(i,m,this);if(n){t=T.generateToken();m.token=t;}}var o=j.includeHidden!==undefined?j.includeHidden:true;var p=j.$select!==undefined?j.$select:"name,transform,meshId,materialId,contentType,visible,opacity,renderOrder";var r={pushMaterials:true,pushMeshes:d,includeHidden:o,pushPMI:j.pushPMI||false,metadataFilter:j.metadataFilter,token:t,$select:p};if(j.activateView){r.activateView=j.activateView;}r.sceneId=i;r.context=i;var u=G.createGetTreeCommand(r);l(m,"modelRequested",t);this._worker.postMessage({method:"initializeConnection",url:f,useSecureConnection:j.useSecureConnection,token:m.token,command:u});};this.postMessage=function(m){this._worker.postMessage(m);};this.update=function(i,j,v){var g=this;return new Promise(function(r,k){var m=_.getContext(i);if(!m){k("no context for ${sceneVeId}.");}m.nodeSidsForPartialTree=new Set(j);m.retrievalType=S.RetrievalType.Partial;var n=m.includeHidden!==undefined?m.includeHidden:true;var o=m.$select!==undefined?m.$select:"name,transform,meshId,materialId,contentType,visible,opacity,renderOrder";var p={pushMaterials:true,pushMeshes:d,filter:j.join(),includeHidden:n,pushPMI:m.pushPMI||false,metadataFilter:m.metadataFilter,$select:o,breadcrumbs:true};var t;if(m.progressLogger){t=T.generateToken();m.token=t;}p.sceneId=i;p.context=i;if(v){p.activateView=v;}var u=G.createGetTreeCommand(p);var w=function(){m.onPartialRetrievalFinishedCallbacks.detach(w);l(m,"updateFinished(mesh)",t);var x=[];var y=[];m.replacedNodes.forEach(function(B,D){y.push(B);x.push(D);});var z=x;var A=y;r({sceneVeId:i,sids:j,replacedNodeRefs:z,replacementNodeRefs:A});};m.onPartialRetrievalFinishedCallbacks.attach(w);l(m,"updateRequested",t);g._worker.postMessage({method:"update",command:u});});};this.requestView=function(i,v,j){if(v!=="static"&&v!=="dynamic"){return Promise.reject("invalid arg: supported type - static, dynamic");}if(!j){return Promise.reject("invalid arg: viewId undefined");}var k=_.getContext(i);if(!k){return Promise.reject("no scene exist for ${sceneVeId}");}var t;if(k.progressLogger){t=T.generateToken();k.token=t;}var m=k.includeHidden!==undefined?k.includeHidden:false;var n=k.$select!==undefined?k.$select:undefined;var g=this;var o;var p=new Promise(function(r,u){var w="";var x;if(v==="static"){o={sceneId:i,id:j,token:t,includeHidden:m,$select:n};w+=G.createGetViewCommand(o);x=a.getView;}else{o={sceneId:i,type:j,token:t};w+=G.createGetDynamicViewCommand(o);x=a.getDynamicView;}var y=function(z){k.onViewFinishedCallbacks.detach(y);l(k,"onViewFinished",t);if(z){r(z);}else{u("no view data");}};k.onViewFinishedCallbacks.attach(y);l(k,"viewRequested",t);g._worker.postMessage({method:x,command:w});});return p;};this.requestMaterial=function(i){if(!i){return Promise.reject("invalid arg: materialId undefined");}var p=new Promise(function(r,j){var k=_.sceneBuilder.getMaterial(i);if(k){r(k);return;}_.requestCommandGenerator.pushMaterialIds([i]);var n=function(){_.onMaterialFinishedCallbacks.detach(n);var m=_.sceneBuilder.getMaterial(i);if(m!=null){r(m);}else{j("no material data");}};_.onMaterialFinishedCallbacks.attach(n);h();});return p;};this.getState=function(){return _;};this.decrementResourceCountersForDeletedTreeNode=function(i,j,n){i.sceneBuilder.decrementResourceCountersForDeletedTreeNode(n,j.sceneId);};this.printLogTokens=function(){if(!_||!_.contextMap){console.log("printLogTokens:no data to print");return;}var i=_.contextMap.entries();var j=i.next();while(!j.done){var k=j.key;var m=j.value;j=i.next();console.log("log tokens for scene => "+k);console.log("---------------------------------------");if(m.progressLogger){var n=m.progressLogger.getTokens();var o=n.keys();var p=o.next();while(!p.done){var t=p.value;o.next();console.log(t);}}console.log("---------------------------------------");}};};return c;});
