/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","sap/ui/table/TreeTable","sap/ui/table/Column","sap/ui/model/json/JSONModel","sap/ui/core/ResizeHandler","sap/m/Title","sap/m/SearchField","sap/m/Toolbar","sap/m/ToolbarLayoutData","sap/m/ToolbarSpacer","sap/m/Text","sap/ui/core/Icon","./ContentConnector","./ViewStateManager"],function(q,a,C,T,b,J,R,c,S,d,e,f,g,I,h,V){"use strict";var j=C.extend("sap.ui.vk.SceneTree",{metadata:{library:"sap.ui.vk",properties:{title:{type:"string",defaultValue:sap.ui.vk.getResourceBundle().getText("SCENETREE_TITLE")},showTitle:{type:"boolean",defaultValue:true},showSearchField:{type:"boolean",defaultValue:true}},aggregations:{treeTable:{type:"sap.ui.table.TreeTable",multiple:false}},associations:{contentConnector:{type:"sap.ui.vk.ContentConnector",multiple:false},viewStateManager:{type:"sap.ui.vk.ViewStateManager",multiple:false}},events:{contentChanged:{enableEventBubbling:true}}}});var k="sap-icon://show",m="sap-icon://hide";var t=sap.ui.vk.getResourceBundle().getText("SCENETREE_VISIBILITYSTATEVISIBLE"),n=sap.ui.vk.getResourceBundle().getText("SCENETREE_VISIBILITYSTATEHIDDEN");j.prototype._createNodeForSceneTree=function(i,l,v){var o=v.getVisibilityState(l);return{name:i,id:l,visible:o};};j.prototype.setScene=function(s,v){this.setViewStateManager(v);this._setScene(s);};j.prototype._setScene=function(s){this._scene=s;this.refresh();};j.prototype.init=function(){if(C.prototype.init){C.prototype.init.apply(this);}var i=this;this._title=new c({width:"100%",textAlign:sap.ui.core.TextAlign.Center,text:this.getTitle()});this._searchField=new S({layoutData:new e({shrinkable:true,maxWidth:"400px"}),search:function(l){var o=l.getParameter("query"),p=i._scene.getDefaultNodeHierarchy(),r=i._viewStateManager;if(p&&r){var s=!o?[]:p.findNodesByName({value:o,predicate:"contains"});var u=new Set(s);var w=[];r.enumerateSelection(function(x){if(!u.has(x)){w.push(x);}});r.setSelectionState(w,false,false);r.setSelectionState(s,true,false);}}});this._toolbar=new d({content:[this._title,new f(),this._searchField]});var v=new I({src:k,tooltip:t,width:"2em",height:"1.3em",size:"1.2em",press:function(l){var o=this.getSrc()!==k;this.setSrc(o?k:m);this.setTooltip(o?t:n);i._toggleVisibilityForAllChildren(i._model.getData(),o);}});this._tree=new T({title:this._toolbar,columnHeaderHeight:32,columns:[new b({label:sap.ui.vk.getResourceBundle().getText("SCENETREE_NAME"),tooltip:sap.ui.vk.getResourceBundle().getText("SCENETREE_NAME"),template:new g({text:"{name}",maxLines:1,tooltip:"{name}"}),resizable:false}),new b(this.getId()+"-visibilityColumn",{label:v,template:new I({src:{path:"",formatter:function(o){if(!o){return null;}return o.visible?k:m;}},tooltip:{path:"",formatter:function(o){if(!o){return null;}return o.visible?t:n;}},width:"2em",height:"1.3em",size:"1.2em",press:function(l){var o=i._tree.getContextByIndex(this.getParent().getIndex());var p=o?o.getObject():null;if(p){i._viewStateManager.setVisibilityState(p.id,!p.visible,true);}}}),width:"2.5em",resizable:false,hAlign:"Center"})],enableSelectAll:false,selectionMode:"MultiToggle",selectionBehavior:"RowSelector",visibleRowCountMode:"Fixed",expandFirstLevel:false,collapseRecursive:false,rowHeight:32});this.setAggregation("treeTable",this._tree);this.attachContentChanged(function(l){v.setSrc(k);v.setTooltip(t);});this._scene=null;this._syncing=false;this._updateSelectionTimer=0;this._updateVisibilityTimer=0;this._model=new J();this._tree.setModel(this._model);this._tree.bindRows({path:"/"});this._tree.attachRowSelectionChange(this._handleRowSelectionChange.bind(this));this._tree.attachFirstVisibleRowChanged(this._updateSelection.bind(this));this._tree.getBinding("rows").attachChange(this._dataChange.bind(this));};j.prototype.setTitle=function(v){this.setProperty("title",v,true);this._title.setText(v);return this;};j.prototype.setShowTitle=function(v){this.setProperty("showTitle",v,true);this._title.setVisible(v);this._updateTitleBar();return this;};j.prototype.setShowSearchField=function(v){this.setProperty("showSearchField",v,true);this._searchField.setVisible(v);this._updateTitleBar();return this;};j.prototype._updateTitleBar=function(){this._tree.setTitle(this.getShowTitle()||this.getShowSearchField()?this._toolbar:null);this._handleResize();};j.prototype.onBeforeRendering=function(){this._tree.setVisible(true);if(!this._resizeListenerId){this._resizeListenerId=R.register(this,this._handleResize.bind(this));}};j.prototype._handleRowSelectionChange=function(l){if(this._syncing||this._tree.getBinding("rows")._aSelectedContexts!=undefined){return;}var s=[];var o=[];var r=l.getParameter("rowIndices");for(var i in r){var p=r[i];var u=this._tree.getContextByIndex(p);var v=u?u.getObject().id:null;if(v){(this._tree.isIndexSelected(p)?s:o).push(v);}}if(s.length>0){this._viewStateManager.setSelectionState(s,true);}if(o.length>0){this._viewStateManager.setSelectionState(o,false);}};j.prototype._handleSelectionChanged=function(o){if(this._syncing){return;}function p(r,u){var v=r.getBinding("rows");if(v){for(var i=r.getFirstVisibleRow(),l=Math.min(i+r.getVisibleRowCount(),v.getLength());i<l;i++){var w=v.getContextByIndex(i);if(w&&w.getObject().id===u){return true;}}}return false;}var s=o.getParameter("selected");if(s.length===1&&!p(this._tree,s[0])){if(this._updateSelectionTimer>0){clearTimeout(this._updateSelectionTimer);this._updateSelectionTimer=0;}this._expandToNode(s[0],this._updateSelection.bind(this));}else if(this._updateSelectionTimer===0){this._updateSelectionTimer=setTimeout(this._updateSelection.bind(this),0);}};j.prototype._updateSelection=function(){this._updateSelectionTimer=0;if(this._syncing){return;}this._syncing=true;var v=this._viewStateManager,o=this._tree,r=o.getBinding("rows");if(v&&r){for(var i=o.getFirstVisibleRow(),l=Math.min(i+o.getVisibleRowCount(),r.getLength());i<l;i++){var p=r.getContextByIndex(i);if(p){var s=p.getObject().id;if(s){var u=v.getSelectionState(s);if(u!=o.isIndexSelected(i)){o[u?"addSelectionInterval":"removeSelectionInterval"](i,i);}}}}}this._syncing=false;};j.prototype._expandToNode=function(i,l){var o={tree:this._tree,rows:this._tree.getBinding("rows"),index:0,nodeRef:i,ancestors:new Set(this._scene.getDefaultNodeHierarchy().getAncestors(i)),callback:l};function s(r,u,v){var w=r.getFirstVisibleRow(),x=r.getVisibleRowCount();if((u<w)||(u>=(w+x))){w=Math.min(Math.max(u-(x>>1),0),v-x);setTimeout(function(){r.setFirstVisibleRow(w);},0);}}function p(o,r){if(r&&r.getParameter("reason")!=="expand"){return;}var u=o.rows.getLength();while(o.index<u){var v=o.rows.getContextByIndex(o.index);if(!v){break;}var i=v.getObject().id;if(i===o.nodeRef){s(o.tree,o.index,u);break;}if(o.ancestors.has(i)&&!o.tree.isExpanded(o.index)){o.tree.expand(o.index++);return;}o.index++;}o.rows.detachChange(o.expandHandlerProxy);o.callback();}o.expandHandlerProxy=p.bind(this,o);o.rows.attachChange(o.expandHandlerProxy);p(o);};j.prototype._dataChange=function(i){var r=i.getParameter("reason");if((r==="expand"||r==="collapse")&&this._updateSelectionTimer===0){this._updateSelectionTimer=setTimeout(this._updateSelection.bind(this),0);}};j.prototype._toggleVisibilityForAllChildren=function(l,o){var p=l.hasOwnProperty("children")?l.children:l;for(var i=0;p[i]!=null;i++){this._viewStateManager.setVisibilityState(p[i].id,o,true);}};j.prototype._handleVisibilityChanged=function(i){if(this._updateVisibilityTimer===0){this._updateVisibilityTimer=setTimeout(this._updateVisibility.bind(this),0);}};j.prototype._updateVisibility=function(){this._updateVisibilityTimer=0;this._getNodeVisibilityRecursive(this._model.getData());this._tree.getModel().refresh(true);};j.prototype._getNodeVisibilityRecursive=function(l){if(l.id!=null){l.visible=this._viewStateManager.getVisibilityState(l.id);}var o=l.hasOwnProperty("children")?l.children:l;for(var i=0;o[i]!=null;i++){this._getNodeVisibilityRecursive(o[i]);}};j.prototype._handleResize=function(i){var l=i?i.size.height:this.getDomRef().clientHeight;var o=this._tree.getTitle()?2.1:1.1;this._tree.setVisibleRowCount(Math.max(Math.floor(l/(this._tree.getRowHeight()+1)-o),0));this._updateSelection();};j.prototype.refresh=function(){if(!this._scene||!this._viewStateManager||!this._viewStateManager.getNodeHierarchy()){this._model.setData([]);return;}var i=this._scene.getDefaultNodeHierarchy();var l=[];var o=function(l,p){p.forEach(function(r,s){var u=i.createNodeProxy(r);var v=this._createNodeForSceneTree(u.getName(),u.getNodeRef(),this._viewStateManager);l[s]=v;i.destroyNodeProxy(u);v.children=[];o(v.children,i.getChildren(r));}.bind(this));}.bind(this);o(l,i.getChildren());this._model.setData(l);this._tree.setModel(this._model);this._tree.bindRows({path:"/",parameters:{arrayNames:["children"]}});this._tree.getBinding("rows").attachChange(this._dataChange.bind(this));this.fireContentChanged();};j.prototype._onBeforeClearContentConnector=j.prototype._onBeforeClearViewStateManager=function(){this._setScene(null);};j.prototype._onAfterUpdateContentConnector=j.prototype._onAfterUpdateViewStateManager=function(){if(this._contentConnector){this._setContent(this._contentConnector.getContent());}};j.prototype._setContent=function(i){this._setScene(i);};j.prototype._handleContentReplaced=function(i){this._setContent(i.getParameter("newContent"));};j.prototype._handleNodeHierarchyReplaced=function(i){this._setScene(this._scene);};j.prototype._handleContentChangesFinished=function(i){this.refresh();};h.injectMethodsIntoClass(j);V.injectMethodsIntoClass(j);return j;},true);
