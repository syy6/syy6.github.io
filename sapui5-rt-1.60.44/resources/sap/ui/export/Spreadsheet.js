/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./library','./ExportDialog','sap/ui/Device','sap/ui/export/SpreadsheetExport'],function(q,l,E,D,S){'use strict';var a=function(s){this.mSettings=q.extend(true,{},s);};a.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null;}};a.prototype.onprogress=function(P){q.sap.log.debug("Spreadsheet export: "+P+"% loaded.");};var p=(function(){var r={};for(var k in l.EdmType){r[k.toLowerCase()]=k;}return r;})();var b="Spreadsheet export: ";function v(P){var c=b;var o="odata";var e=".xlsx";var d=P.count;var s;P.fileName=P.fileName||'export';if(!q.sap.endsWith(P.fileName,e)){P.fileName+=e;}var f=P.dataSource;if(typeof f==="string"){P.dataSource={dataUrl:f,type:o,count:d};P.count=d;}else if(Array.isArray(f)){var g=f.map(function(r){return q.extend(true,{},r);});P.dataSource={data:g,type:"array"};}else if(f&&f.dataUrl){s=(f.type||o).toLowerCase();P.dataSource.type=s;if(f.useBatch){}}var h=P.dataSource.sizeLimit;d=P.dataSource.count||d||1;if(P.dataSource.type===o&&(!h||isNaN(h))){h=Math.round(d/1000)*200;h=Math.min(5000,Math.max(h,200));q.sap.log.warning(c+"dataSource.sizeLimit is not provided. sizeLimit is set to "+h);P.dataSource.sizeLimit=h;}var i=P&&P.workbook;i.columns.forEach(function(j){j.label=j.label||(j.property instanceof Array?j.property[0]:j.property)||"";var w=j.width;if(typeof w==="string"){var W=w.toLowerCase();w=parseFloat(W);if(W.indexOf("em")>0){w=w*2;}else if(W.indexOf("px")>0){w=w/8;}}if(isNaN(w)||w<1){w=10;}if(j.label.length<30){w=Math.max(j.label.length,w);}j.width=Math.round(w);if(j.type){j.type=j.type.toLowerCase();if(!p[j.type]){q.sap.log.warning(c+"insupported column property type "+j.type+". Type is reverted to 'string'.");j.type="";}if(j.type==="currency"&&!j.unitProperty){q.sap.log.warning(c+"missing unit property for currency column. Type is reverted to 'string'.");j.type="";}}var k=j.scale;if(j.type==="number"&&isNaN(k)&&k!=="variable"){q.sap.log.warning(c+"scale parameter for numerical column configuration is missing.");}if(typeof k==="string"){k=parseInt(k,10);}if(isNaN(k)){k=null;}j.scale=k;var t=(j.textAlign+"").toLowerCase();if(["begin","end"].indexOf(t)>-1){var m=["left","right"];t=(sap.ui.getCore().getConfiguration().getRTL()?m.reverse():m)[["begin","end"].indexOf(t)];}if(t!==""&&["left","right","center","begin","end"].indexOf(t)==-1){q.sap.log.warning(c+"incorrect column alignment property: "+t+". Default alignment is used.");t="";}j.textAlign=t;});}a.prototype.build=function(){var s=this;var P=q.extend(true,{},this.mSettings);v(P);return new Promise(function(r,R){var c;var d=D.system.desktop?2000000:100000;var n=P.dataSource.type=='array'?P.dataSource.data.length:P.dataSource.count;var e=P.workbook.columns.length;function o(m){if(!isNaN(m.progress)){if(c){c.updateStatus(m.progress);}s.onprogress(m.progress);}if(m.finish||typeof m.error!='undefined'){s.process=null;if(c){c.finish();}if(m.finish){r();}else{R(m.error);E.showErrorMessage(m.error);}}}function f(){if(P.showProgress===false){if(s.process){R("Cannot start export: the process is already running");return;}s.process=S.execute(P,o);return;}if(P.showProgress!==false){E.getProgressDialog().then(function(g){c=g;c.oncancel=function(){return s.process&&s.process.cancel();};if(s.process){R("Cannot start export: the process is already running");return;}c.open();s.process=S.execute(P,o);});}}if(e<=0){R('No columns to export.');}else if(n*e>d||!n){E.showWarningDialog({rows:n,columns:e}).then(f).catch(function(){R('Export cancelled by the user.');});}else{f();}});};return a;},true);
