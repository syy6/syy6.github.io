/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','sap/ui/Device','sap/ui/export/ExportUtils'],function(q,D,E){'use strict';var L='sap/ui/export/js/libs/JSZip3',a='sap/ui/export/js/XLSXExportUtils',b='sap/ui/export/js/XLSXBuilder';function d(p,c){function f(m){return c&&c(m);}function o(v){f({progress:v});}function g(e){f({error:e.message||e});}function h(){f({finish:true});}function i(){var s;var C;var t;function e(X,v){C=X.oData.getConverter(p);s=new v(p.workbook.columns,p.workbook.context,p.workbook.hierarchyLevel);o(0);t=window.setTimeout(l,0);}function l(){if(s){var v=p.dataSource.data||[];var R=C(v.slice());s.append(R);o(50);t=window.setTimeout(m,0);}}function m(){if(s){s.build().then(r);}}function r(v){if(v){E.saveAsFile(new Blob([v],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),p.fileName);}h();s=null;}function u(){window.clearTimeout(t);r();}sap.ui.require([a,b,L],e);return{cancel:u};}function n(u){if(!u){return u;}try{return new URL(u,document.baseURI).toString();}catch(e){return window.URI(u).absoluteTo(document.baseURI).toString();}}function j(){var s,r;function e(X,u){s=new u(p.workbook.columns,p.workbook.context,p.workbook.hierarchyLevel);r=X.oData.fetch(p,l);o(0);}function l(M){if(M.rows){s.append(M.rows);}if(M.progress){o(M.progress);}if(M.error||typeof M.error==='string'){s=null;return g(M.error);}return M.finished&&s.build().then(m);}function m(u){E.saveAsFile(new Blob([u],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),p.fileName);h();s=null;}function t(){r.cancel();h();s=null;}sap.ui.require([a,b,L],e);return{cancel:t};}function k(){var s;var l=q.extend(true,{},p);var w=typeof l.worker==='object'?l.worker:{};var C=function(){s.postMessage({cancel:true});h();};function m(v){var x=new Worker(v);x.onmessage=function(e){if(e.data.status){o(e.data.status);}else if(e.data.error||typeof e.data.error==='string'){g(e.data.error);}else{E.saveAsFile(new Blob([e.data],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),p.fileName);h();}};x.postMessage(l);return x;}function r(){q.sap.log.warning('Direct worker is not allowed. Load the worker via blob.');var e=window.URI(w.base).absoluteTo("").search("").hash("").toString();w.src=e+w.ref;var v='self.origin = "'+e+'"; '+'importScripts("'+w.src+'")';var x=new Blob([v]);var y=window.URL.createObjectURL(x);return m(y);}function t(){q.sap.log.warning('Blob worker is not allowed. Use in-process export.');C=j(l).cancel;}function u(){try{s=m(w.src);s.addEventListener('error',function(e){s=r();s.addEventListener('error',function(e){t();e.preventDefault();});e.preventDefault();});}catch(v){try{s=r();}catch(x){t();}}}l.dataSource.dataUrl=n(l.dataSource.dataUrl);l.dataSource.serviceUrl=n(l.dataSource.serviceUrl);w.base=w.base||sap.ui.resource('sap.ui.export.js','');w.ref=w.ref||'SpreadsheetWorker.js';w.src=w.base+w.ref;sap.ui.require([a],u);return{cancel:function(){C();}};}if(p.dataSource.type==='array'){return i();}else if(p.worker===false||sap.ui.disableExportWorkers===true||(D.browser.msie&&p.dataSource.dataUrl.indexOf('.')===0)){return j();}else{return k();}}return{execute:d};},true);
