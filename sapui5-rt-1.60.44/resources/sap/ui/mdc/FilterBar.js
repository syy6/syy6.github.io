/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(["./ResourceModel",'sap/ui/mdc/XMLComposite','sap/ui/base/ManagedObject','sap/ui/Device',"sap/ui/mdc/odata/v4/CommonHelper","sap/ui/mdc/FilterField","sap/m/SearchField","sap/m/Dialog","sap/m/Button","sap/m/MessageToast","sap/ui/model/json/JSONModel",'sap/ui/mdc/base/ConditionModel',"sap/ui/fl/ControlPersonalizationAPI"],function(R,X,M,D,C,F,S,a,B,b,J,c,d){"use strict";var e=X.extend("sap.ui.mdc.FilterBar",{metadata:{designtime:"sap/ui/mdc/designtime/FilterBar.designtime",specialSettings:{metadataContexts:{defaultValue:"{ model: 'entitySet', path:'',  name: 'entitySet'},{model: 'sap.fe.deviceModel', path: '/', name: 'sap.fe.deviceModel'},{model:'entitySet', path:'./@com.sap.vocabularies.UI.v1.SelectionFields', name:'selectionFields'}"}},properties:{liveUpdate:{type:"boolean",defaultValue:!D.system.phone,invalidate:"template"},searchOnStart:{type:"boolean",defaultValue:true,invalidate:"template"},filterSummary:{type:"string",defaultValue:"",invalidate:false},enabled:{type:"boolean",defaultValue:true,invalidate:false},conditionModelName:{type:"string",defaultValue:"sap.fe.cm",invalidate:false},listBindingNames:{type:"string[]",invalidate:false},hideBasicSearch:{type:"boolean",defaultValue:false,invalidate:"template"},enablePersonalization:{type:"boolean",defaultValue:true,invalidate:false}},events:{search:{},change:{}},aggregations:{},publicMethods:[]},fragment:"sap.ui.mdc.internal.filterbar.FilterBar"});var s=function(E){var o=this._getConditionModel();o.applyFilters(false);};e.prototype.init=function(){X.prototype.init.call(this);var t=this;this._bIsReady=false;this.attachSearch(s);this._requestConditionModel().then(function(o){if(!t.bInitialized){t.bInitialized=true;var f=o.bindProperty("/",o.getContext("/"));f.attachChange(t.handleChange.bind(t));if(t.getSearchOnStart()&&t.getEnabled()){t._bIsReady=true;t.fireSearch();}if(!t.getEnabled()){t._getInnerFilterBar().setBusy(true);}}});};e.prototype.onBeforeRendering=function(){this._setFilterSummary();};e.prototype.setEnabled=function(E){this._getInnerFilterBar().setBusy(!E);this.setProperty("enabled",E);if(E){if(this.bInitialized&&this.getSearchOnStart()){this._bIsReady=true;this.fireSearch();}}return this;};e.prototype.isReady=function(){return this._bIsReady;};e.prototype.getAppState=function(){var o=this._getConditionModel(),f=this._getDraftEditStateControl(),A={};if(o){A.conditionModel=o.serialize();}if(f){A.draftEditState=f.getSelectedKey();}return A;};e.prototype.setAppState=function(A){var t=this;return this._requestConditionModel().then(function(o){var f=t._getDraftEditStateControl();if(A.conditionModel){if(o){o.parse(A.conditionModel);}else{throw("app state contains condition model state but condition model not yet set");}}if(A.draftEditState&&f){f.setSelectedKey(A.draftEditState);}if(!t.getLiveUpdate()){t.handleGo();}});};e.prototype.handleChange=function(){if(this.getLiveUpdate()&&this.getEnabled()){this.fireSearch();this._setFilterSummary();this.fireChange();}else{this._bIsReady=false;this.fireChange();}};e.prototype.handleGo=function(){this._bIsReady=true;this.fireSearch();this._setFilterSummary();this.fireChange();};e.prototype._getEntitySet=function(){return this.byId("template::Filterbar::Adapt").getCustomData()[0].getValue();};e.prototype._getInnerFilterBar=function(){return this.get_content();};e.prototype._setFilterSummary=function(){var o=this._getDraftEditStateControl(),f="",g,h=[],i;if(this._getConditionModel()){var j=this._getConditionModel().getConditions("$search");if(j.length){g=j[0].values[0];f=R.getText("filterbar.SEARCHBY")+": "+g+((h.length>0)?" | ":"");}}if(o&&o.getSelectedKey()!=='0'){h.push(R.getText("filterbar.EDITING_STATUS"));}var k=this._getFilterFieldControls();for(i=0;i<k.length;i++){if(k[i].getConditions().length>0){h.push(k[i].getCustomData()[0].getValue());}}if(h.length>0){f+=R.getText("filterbar.FILTERBY")+" ("+h.length+"): ";for(i=0;i<h.length;i++){f+=((i>0)?', ':'')+h[i];}}if(!f){f=R.getText("filterbar.FILTERBYNONE");}this.setFilterSummary(f);};e.prototype._requestConditionModel=function(){var o=this._getConditionModel(),t=this;if(o){return Promise.resolve(o);}else{return new Promise(function(r){var m=t.getModel();var f=function(){var m=t.getModel(),o,n;if(!m){return;}t.detachModelContextChange(f);o=t.getModel(t.getConditionModelName());if(o){return Promise.resolve(o);}else{n=t.getListBindingNames();if(n&&m.getBindingForReference){n.forEach(function(N){m.getBindingForReference(N).then(function(l){o=t.getModel(t.getConditionModelName());if(!o){o=c.getFor(l);this.setModel(o,this.getConditionModelName());}r(o);}.bind(this));}.bind(t));}}};if(m){f();}else{t.attachModelContextChange(f);}});}};e.prototype._getConditionModel=function(){return this.getModel(this.getConditionModelName());};e.prototype._getDraftEditStateControl=function(){var f=this._getInnerFilterBar().getContent();var o;for(var i=0;i<f.length;i++){if(!(f[i]instanceof F)&&f[i].getItems){o=f[i].getItems()[1];if(o.getBinding("items")&&o.getBinding("items").getPath()==="/editStates"&&o.getBinding("items").getModel()===o.getModel("$draft")){return o;}}}};e.prototype._getFilterFieldControls=function(){var f=this._getInnerFilterBar().getContent();var o,g=[];for(var i=0;i<f.length;i++){o=f[i];if(o instanceof F){g.push(o.get_content().getItems()[1]);}}return g;};e.prototype._getAdaptFilterModel=function(P){var t=this;var f=this._getFilterFieldControls();var E=this._getEntitySet();var g=[];var m=this.getModel().getMetaModel();var h=m.getObject("/"+E+"/");var A,o;function j(i){return F.createInstance({entitySet:E,propertyPath:i,metaModel:m,parent:P});}function k(i){return t._getFilterFieldControl(f,i)!==undefined;}function l(q){for(var i=0;i<f.length;i++){if(f[i].getFieldPath()===q){return i;}}}for(var p in h){if(h[p].$kind&&h[p].$kind==="Property"){A=m.getObject("/"+E+"/"+p+"@");o=m.getContext("/"+E+"/"+p);if(C.isPropertyFilterable(p,{context:o})){g.push({columnKey:p,text:A['@com.sap.vocabularies.Common.v1.Label']||p,position:l(p),tooltip:A['@com.sap.vocabularies.Common.v1.Label']||p,selected:k(p),control:j(p),required:F._helper.isRequiredInFilter(p,{context:o})});}}}var n=new J({"filters":g});return n;};e.prototype._updateAdaptFilterModel=function(A){var f=this._getFilterFieldControls();var g=A.getObject("/filters");for(var i=0;i<g.length;i++){g[i].selected=this._getFilterFieldControl(f,g[i].columnKey)!==undefined;}A.setProperty("/filters",g);};e.prototype._getFilterFieldControl=function(f,p){for(var i=0;i<f.length;i++){if(f[i].getFieldPath()===p){return f[i];}}};e.prototype._adaptFilterBar=function(A,r){var f="",g="",h=[];A.forEach(function(o){f+=o.text+", ";h.push({selectorControl:this,changeSpecificData:{changeType:"addFilter",content:{columnKey:o.columnKey,text:o.text+':'}}});}.bind(this));r.forEach(function(o){g+=o.text+", ";h.push({selectorControl:this,changeSpecificData:{changeType:"removeFilter",content:{removedElement:this._getFilterFieldControl(this._getFilterFieldControls(),o.columnKey).getParent().getParent().getId()}}});}.bind(this));if(d.hasVariantManagement(this)){d.addPersonalizationChanges(h);}else{b.show("Adapting the Filter Bar is not yet implemented. \n The following filters shall be added:"+f+"The following filters shall be removed: "+g);}};e._helper={resolveSelectionField:function(o){var p=o.getObject();if(p.$PropertyPath){return o.getModel().createBindingContext(o.getPath()+"/$PropertyPath");}else{return o;}},isNavPropertyFilterable:function(o,n){var E,f,i=false,p=o.getPath(),m=o.getModel();E=C._getEntitySetPath(m,p);f=p.slice(E.length+1);if(f.indexOf("/")<0){i=C._isInNonFilterableProperties(m,E,f);}else{i=C._isContextPathFilterable(m,E,f);}return!i;},replaceSpecialCharsInId:function(p,i){var P;if(typeof p==="string"){P=p;}else{P=i.context.getModel().getObject(i.context.getPath()+"@sapui.name");}return C.replaceSpecialCharsInId(P);}};e._helper.isNavPropertyFilterable.requiresIContext=true;return e;},true);
