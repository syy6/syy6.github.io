/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(["./ResourceModel",'sap/ui/mdc/XMLComposite',"sap/ui/mdc/base/ODataSuggestProvider","sap/ui/mdc/base/OperatorSuggestProvider","sap/ui/mdc/base/FilterOperatorConfig","sap/ui/model/json/JSONModel","sap/ui/mdc/ValueHelpDialog","sap/ui/mdc/odata/v4/CommonHelper"],function(R,X,O,a,F,J,V,C){"use strict";var b=X.extend("sap.ui.mdc.FilterField",{metadata:{designtime:false,specialSettings:{metadataContexts:{defaultValue:"{ model: 'entitySet', path:'',  name: 'entitySet'}, { model: 'property', path:'',  name: 'property'}"}},properties:{withLabel:{type:"boolean",defaultValue:true,invalidate:"template"},conditionModelName:{type:"string",defaultValue:"sap.fe.cm",invalidate:false}},events:{},aggregations:{},publicMethods:[]},fragment:"sap.ui.mdc.internal.filterfield.FilterField"});b.prototype.getInnerFilterField=function(){var i=this.get_content().getItems();return i[i.length-1];};b.prototype.init=function(){X.prototype.init.call(this);var i=this.getInnerFilterField();var s=i.data("suggest")==='true',f=i.data("fixedValues")==='true';if(s||f){new O({fixedValues:f,control:i,init:this.handleProviderInit.bind(this),suggest:this.handleProviderSuggest.bind(this)});this._aSuggestFilterProperties=[];}};b.prototype.handleProviderInit=function(p,e){var i=this.getInnerFilterField();var E=this._getEntitySet();var P=this._getPropertyPath();var m=this.getModel().getMetaModel();var f=i.data("fixedValues")==='true';var t=this;this.bSuggestionViewCreated=true;m.requestValueListInfo('/'+E+'/'+P).then(function(v){C._extendValueListMetadata(m,E,P,v);v=v[v[""]?"":Object.keys(v)[0]];if(!v){return false;}if(!f){var s=v.$model.getMetaModel();var o=F.getFor(v.$model);if(!v.$mdc.bSearchable){v.Parameters.forEach(function(d){var g=d.ValueListProperty;var h=s.getContext("/"+v.CollectionPath+"/"+g);if(C.isPropertyFilterable(g,{context:h})){var T=s.getObject("/"+v.CollectionPath+"/"+g+"/$Type");var j=o.getOperatorsForType(T);var k=[];if(j.includes("Contains")){k.push("Contains");}else{j.forEach(function(l){if(l==="StartsWith"||l==="EQ"||l==="EndsWith"){k.push(l);}});}if(k.length){t._aSuggestFilterProperties.push({path:g,operators:k});}}});}}var c=new J(v);var S=sap.ui.view({viewName:"sap.ui.mdc.internal.filterfield.SuggestionList",type:"XML",async:true,preprocessors:{xml:{bindingContexts:{valueList:c.createBindingContext("/")},models:{valueList:c}}}});return S.loaded().then(function(){if(v.$mdc){if(v.$mdc.keyPath){p.setKeyPath(v.$mdc.keyPath);}if(v.$mdc.descriptionPath){p.setDescriptionPath(v.$mdc.descriptionPath);}if(v.$mdc.oLocalDataToValueListMap){p.setLocalDataToValueListMap(v.$mdc.oLocalDataToValueListMap);}}var T=S.getContent()[0];T.setModel(v.$model);p.setTable(T,e);});},function(o){throw(o.message);});};b.prototype.handleProviderSuggest=function(p,e){if(!this._fieldPath){var f="$search";if(this._aSuggestFilterProperties.length>0){f="";this._aSuggestFilterProperties.forEach(function(P){if(P.operators[0]==="Contains"){f+=P.path+",";}});f="*"+f.slice(0,-1)+"*";}this._fieldPath=f;}var v=e.newValue.trim()?e.newValue.trim():undefined;var s=p.getTable().getBinding("items");if(s.isSuspended()){s.resume();}var c=sap.ui.mdc.base.ConditionModel.getFor(s);c.removeAllConditions(this._fieldPath);if(v){c.addCondition(c.createCondition(this._fieldPath,"StartsWith",[v]));}c.applyFilters(false);};b.prototype._getEntitySet=function(){return this.getInnerFilterField().data("entitySetName");};b.prototype._getPropertyPath=function(){return this.getInnerFilterField().getFieldPath().replace(/\*/g,'');};b.prototype.handleValueHelpRequest=function(){var l=this.get_content().getItems()[0].getText();if(l.indexOf(":")+1===l.length){l=l.substr(0,l.length-1);}this.oValueHelpDialog=new V({id:this.getId()+"::valueHelpDialog",entitySet:this._getEntitySet(),fieldPath:this.getInnerFilterField().getFieldPath(),conditionModelName:"sap.ui.mdc.cm",title:l});this.oValueHelpDialog.setModel(this.getModel(this.getConditionModelName()),"sap.ui.mdc.cm");this.addDependent(this.oValueHelpDialog);this.oValueHelpDialog.open();};b._helper={getFieldPath:function(I,e,f){var m,s,p,t;m=I.getInterface(0).getModel();if(typeof f!=="string"){f=m.getObject(I.getInterface(1).getPath()+"@sapui.name");}if(f.indexOf('/')>-1){s=f.split('/');for(var i=0;i<(s.length-1);i++){p=m.getObject("/"+e+"/"+s.slice(0,(i+1)).join('/'));if(p&&p["$kind"]==="NavigationProperty"&&p["$isCollection"]){s[i]=s[i]+'*';t=true;}}if(t){f=s.join('/');}}return f;},getValueStatePath:function(i,e,f){var _=b._helper.getFieldPath(i,e,f);return"{sap.fe.cm>/fieldPath/"+_+"/valueState}";},getValueStateTextPath:function(i,e,f){var _=b._helper.getFieldPath(i,e,f);return"{sap.fe.cm>/fieldPath/"+_+"/valueStateText}";},getConditionsBinding:function(i,e,f,c){var _=b._helper.getFieldPath(i,e,f);return"{"+c+">/conditions/"+_+"}";},isRequiredInFilter:function(p,d){var e,P,i=false,f,m=d.context.getModel(),s=d.context.getPath();e=C._getEntitySetPath(m,s);if(typeof p==="string"){P=p;}else{P=m.getObject(s+"@sapui.name");}f=m.getObject(e+"@Org.OData.Capabilities.V1.FilterRestrictions");if(f&&f.RequiredProperties){i=f.RequiredProperties.some(function(c){return c.$PropertyPath===P;});}return i;},typeFormatOptions:function(p,d){var f="",s,m=d.context.getModel(),P=d.context.getPath(),t=m.getObject(P+"/$Type"),T,o;if(t==="Edm.Date"||t==="Edm.DateTimeOffset"||t==="Edm.TimeOfDay"){f+="style: 'medium'";}else if(t==="Edm.Decimal"){s=m.getObject(P+"/$Scale")||0;switch(s){case"floating":f+="decimals: "+(m.getObject(P+"/$Precision")||0);break;case"variable":break;default:f+="decimals: "+s;}}T=m.getObject(P+"@com.sap.vocabularies.Common.v1.Text");if(T){o=m.getObject(P+"@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement");if(f.length>1){f+=", ";}if(o&&o.$EnumMember){switch(o.$EnumMember){case"com.sap.vocabularies.UI.v1.TextArrangementType/TextLast":f+="displayFormat: 'ValueDescription'";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly":f+="displayFormat: 'Description'";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextSeparate":f+="displayFormat: 'Value'";break;default:f+="displayFormat: 'DescriptionValue'";}}else{f+="displayFormat: 'DescriptionValue'";}}f=f?"{"+f+"}":undefined;return f;},typeConstraints:function(p,d){var c="",s,m,M=d.context.getModel(),P=d.context.getPath(),t=M.getObject(P+"/$Type");if(t==="Edm.Decimal"){s=M.getObject(P+"/$Scale")||0;switch(s){case"floating":c+="decimals: "+(M.getObject(P+"/$Precision")||0);break;case"variable":break;default:c+="decimals: "+s;}}else if(t==="Edm.String"){m=M.getObject(P+"/$MaxLength");if(m){c+="maxLength: "+m;}if(M.getObject(P+"@com.sap.vocabularies.Common.v1.IsUpperCase")){if(c.length>1){c+=", ";}c+="toUpperCase: true";}}c=c?"{"+c+"}":undefined;return c;},getValueListCollectionEntitySet:function(v){var m=v.getObject();return m.$model.getMetaModel().createBindingContext("/"+m.CollectionPath);},getValueListProperty:function(p){var v=p.getModel();var m=v.getObject("/");return m.$model.getMetaModel().createBindingContext('/'+m.CollectionPath+'/'+p.getObject());}};b._helper.getFieldPath.requiresIContext=true;b._helper.getValueStatePath.requiresIContext=true;b._helper.getValueStateTextPath.requiresIContext=true;b._helper.getConditionsBinding.requiresIContext=true;b.createInstance=function(p){var e=p.entitySet,P=p.propertyPath,m=p.metaModel,o=p.parent,w=p.withLabel||false,E=m.createBindingContext("/"+e),c=m.createBindingContext("/"+e+"/"+P),n;var v=sap.ui.view({viewContent:"<core:View xmlns:core='sap.ui.core' xmlns:mdc='sap.ui.mdc'><mdc:FilterField metadataContexts=\"{ model: 'entitySet', path : '', name: 'entitySet'}, { model: 'property', path : '', name: 'property' }\" withLabel='"+w+"'/></core:View>",type:"XML",async:false,preprocessors:{xml:{bindingContexts:{entitySet:E,property:c},models:{entitySet:m,property:m}}}});n=v.getContent()[0];o.addDependent(n);return n;};return b;},true);
