/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/ui/core/Control','./library','./ActionToolbar','sap/m/OverflowToolbarButton','sap/m/Text','sap/m/Title','sap/ui/core/format/NumberFormat'],function(C,l,A,O,T,a,N){"use strict";var I,b,c,d,e;var S=l.SelectionMode;var f=l.TableType;var R=l.RowAction;var g=C.extend("sap.ui.mdc.Table",{library:"sap.ui.mdc",metadata:{designtime:"sap/ui/mdc/designtime/Table.designtime",specialSettings:{metadataContexts:{defaultValue:"{path:'',  name: 'collection'}"}},defaultAggregation:"columns",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null,invalidate:true},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:null,invalidate:true},rowAction:{type:"sap.ui.mdc.RowAction[]"},providerModulePath:{type:"string",defaultValue:"sap/ui/mdc/TableHelper"},header:{type:"string",group:"Misc",defaultValue:null},initiallyVisibleFields:{type:"string[]"},selectionMode:{type:"sap.ui.mdc.SelectionMode",defaultValue:S.None},showRowCount:{type:"boolean",group:"Misc",defaultValue:true},type:{type:"sap.ui.mdc.TableType",defaultValue:f.Table}},aggregations:{_content:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"},columns:{type:"sap.ui.mdc.Column",multiple:true},rows:{type:"sap.ui.base.ManagedObject",multiple:true},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{getter:"_createToolbar",aggregation:"actions"}}},events:{rowPress:{parameters:{bindingContext:{type:"sap.ui.model.Context"}}},selectionChange:{parameters:{bindingContext:{type:"sap.ui.model.Context"},selected:{type:"boolean"},selectAll:{type:"boolean"}}}}},constructor:function(){C.apply(this,arguments);this.bCreated=true;this._initializeContent(this.getType());},renderer:function(r,o){r.write("<div ");r.writeControlData(o);r.addClass("sapUiMdcTable");r.writeClasses();if(o.getHeight()){r.addStyle("height",o.getHeight());}if(o.getWidth()){r.addStyle("width",o.getWidth());}r.writeStyles();r.write(">");r.renderControl(o.getAggregation("_content"));r.write("</div>");}});g.prototype.init=function(){C.prototype.init.apply(this,arguments);this._oTableReady=new Promise(this._resolveTable.bind(this));};g.prototype.done=function(){return this._oTableReady;};g.prototype._resolveTable=function(r,h){this._fResolve=r;this._fReject=h;};g.prototype.setType=function(t){var o=this.getType();if(t===o&&this._oTable){return this;}this.setProperty("type",t,true);if(this.bCreated){if(this._oTable){if(o==="ResponsiveTable"){this._oTable.setHeaderToolbar();}else{this._oTable.removeExtension(this._oToolbar);}this._oTable.destroy("KeepDom");this._oTableReady=new Promise(this._resolveTable.bind(this));}if(this._oTemplate){this._oTemplate.destroy();this._oTemplate=null;}this._initializeContent(t);}return this;};g.prototype.setSelectionMode=function(m){this.setProperty("selectionMode",m,true);if(this._oTable){if(this._bMobileTable){this._oTable.setMode(this._getSelectionMode());}else{this._oTable.setSelectionMode(this._getSelectionMode());}}return this;};g.prototype.setRowAction=function(h){var o=this.getRowAction();this.setProperty("rowAction",h,true);if(((h&&h.length)!=(o&&o.length))||o[0]!=h[0]){this._updateRowAction();}return this;};g.prototype._updateRowAction=function(){var h=this.getRowAction();var i;if(this._bMobileTable&&this._oTemplate){this._oTemplate.setType(this.hasListeners("rowPress")?"Active":"Inactive");}else if(this._oTable){i=this._oTable.getRowActionTemplate();if(i){i.destroy();}this._oTable.setRowActionTemplate();this._oTable.setRowActionCount();}if(h&&h.indexOf(R.Navigation)>-1){if(this._oTable){if(this._bMobileTable){this._oTemplate.setType(R.Navigation);}else{this._oTable.setRowActionTemplate(new d({items:[new e({type:R.Navigation,press:[this._onRowActionPress,this]})]}));this._oTable.setRowActionCount(1);}}}};g.prototype._initializeContent=function(t){if(!this.bColumnsOrdered){this.bColumnsOrdered=true;this._orderColumns();}var p=this.getProviderModulePath();if(t==="Table"){sap.ui.getCore().loadLibrary("sap.ui.table",true).then(function(){sap.ui.require(["sap/ui/table/Table","sap/ui/table/Column","sap/ui/table/RowAction","sap/ui/table/RowActionItem",p],function(G,h,R,i,P){this._bMobileTable=false;this.oProvider=P;I=G;b=h;d=R;e=i;this._createContent();}.bind(this));}.bind(this));}else if(t==="ResponsiveTable"){sap.ui.require(["sap/m/Table","sap/m/Column","sap/m/ColumnListItem",p],function(h,i,j,P){this._bMobileTable=true;this.oProvider=P;I=h;b=i;c=j;this._createContent();}.bind(this));}};g.prototype._onAfterTableCreated=function(r){if(r&&this._fResolve){this._fResolve(this);}else if(this._fReject){this._fReject(this);}delete this._fResolve;delete this._fReject;};g.prototype._createContent=function(){this._createToolbar();this._createTable();this._updateRowAction();var m=this.getColumns();m.forEach(this._createInnerTableColumn,this);this.setAggregation("_content",this._oTable);this._onAfterTableCreated(true);if(this._oBindingInfo){this.bindRows(this._oBindingInfo);}};g.prototype.setHeader=function(t){this.setProperty("header",t,true);this._updateHeaderText();return this;};g.prototype._createToolbar=function(){if(!this._oToolbar){this._oTitle=new a(this.getId()+"-title",{text:this.getHeader()});this._oToolbar=new A(this.getId()+"-toolbar",{design:"Transparent",left:[this._oTitle],right:[new O(this.getId()+"-settings",{icon:"sap-icon://action-settings",text:"Settings (using Property Infos)",press:[this._showSettings,this],visible:false,tooltip:"Settings (TODO)"})]});}return this._oToolbar;};g.prototype._createTable=function(){if(this._bMobileTable){this._oTable=new I(this.getId()+"-innerTable",{growing:true,sticky:["ColumnHeaders","HeaderToolbar"],itemPress:[this._onItemPress,this],selectionChange:[this._onSelectionChange,this],mode:this._getSelectionMode(),headerToolbar:this._oToolbar});this._oTemplate=new c(this.getId()+"-innerTableRow");this._createColumn=g.prototype._createMobileColumn;this._sAggregation="items";this._oTable.bindRows=this._oTable.bindItems;}else{this._createColumn=g.prototype._createColumn;this._oTable=new I(this.getId()+"-innerTable",{cellClick:[this._onCellClick,this],rowSelectionChange:[this._onRowSelectionChange,this],selectionMode:this._getSelectionMode(),visibleRowCountMode:"Auto",extension:[this._oToolbar]});this._sAggregation="rows";}};g.prototype._getSelectionMode=function(){var s=this.getSelectionMode();switch(s){case"Single":s=this._bMobileTable?"SingleSelectLeft":"Single";break;case"Multi":s=this._bMobileTable?"MultiSelect":"MultiToggle";break;default:s=S.None;}return s;};g.prototype._createInnerTableColumn=function(m){var o=this._createColumn(m);this._oTable.addColumn(o);};g.prototype._orderColumns=function(){var i,h=[],m=this.getColumns();m.forEach(function(o){i=o.getInitialIndex();if(i>-1){h.push({index:i,column:this.removeColumn(o)});}},this);h.sort(function(o,j){return o-j;});h.forEach(function(o){this.insertColumn(o.column,o.index);},this);};g.prototype._createColumn=function(m,i){var t=m.getTemplate(true);if(!t&&this.oProvider){t=this.oProvider.createColumnTemplate({name:m.getDataProperties()[0]});m.setTemplate(t);}if(t&&t.setWrapping){t.setWrapping(false);}return new b(m.getId()+"-innerColumn",{width:m.getWidth(),hAlign:m.getHAlign(),label:m.getHeader(),showSortMenuEntry:false,showFilterMenuEntry:false,sortProperty:m.getDataProperties()[0],filterProperty:m.getDataProperties()[0],template:t});};g.prototype._createMobileColumn=function(m,i){var o,h;o=new b(m.getId()+"-innerColumn",{width:m.getWidth(),hAlign:m.getHAlign(),header:new T(m.getId()+"-innerColumnHeader",{textAlign:m.getHAlign(),text:m.getHeader()})});h=m.getTemplate(true);if(!h&&this.oProvider){h=this.oProvider.createColumnTemplate({name:m.getDataProperties()[0]});m.setTemplate(h);}if(i>=0){this._oTemplate.insertCell(h,i);}else{this._oTemplate.addCell(h);}return o;};g.prototype.removeColumn=function(m){m=this.removeAggregation("columns",m,true);if(this._oTable){var o=this._oTable.removeColumn(m.getId()+"-innerColumn");if(this._oTemplate){this._oTemplate.removeCell(m.getTemplate(true));}o.destroy();}return m;};g.prototype.addColumn=function(m){this.addAggregation("columns",m,true);if(this._oTable){var o=this._createColumn(m);this._oTable.addColumn(o);}return this;};g.prototype.insertColumn=function(m,i){this.insertAggregation("columns",m,i,true);if(this._oTable){var o=this._createColumn(m,i);this._oTable.insertColumn(o,i);}return this;};g.prototype._onItemPress=function(E){this.fireRowPress({bindingContext:E.getParameter("listItem").getBindingContext()});};g.prototype._onSelectionChange=function(E){this.fireSelectionChange({bindingContext:E.getParameter("listItem").getBindingContext(),selected:E.getParameter("selected"),selectAll:E.getParameter("selectAll")});};g.prototype._onCellClick=function(E){this.fireRowPress({bindingContext:E.getParameter("rowBindingContext")});};g.prototype._onRowActionPress=function(E){var r=E.getParameter("row");this.fireRowPress({bindingContext:r.getBindingContext()});};g.prototype._onRowSelectionChange=function(E){if(E.getParameter("userInteraction")){this.fireSelectionChange({bindingContext:E.getParameter("rowContext"),selected:E.getSource().isIndexSelected(E.getParameter("rowIndex")),selectAll:E.getParameter("selectAll")});}};g.prototype.getSelectedContexts=function(){var h;if(this._bMobileTable){h=this._oTable.getSelectedContexts();}else{h=this._oTable.getSelectedIndices().map(function(i){return this._oTable.getContextByIndex(i);},this);}return h;};g.prototype.bindAggregation=function(n,B){if(n==="rows"){return this.bindRows(B);}return C.prototype.bindAggregation.apply(this,arguments);};g.prototype.bindRows=function(B){this._oBindingInfo=B;if(this._oTable){if(this._bMobileTable&&this._oTemplate){B.template=this._oTemplate;}else{delete B.template;}if(!B.parameters){B.parameters={};}if(this.getShowRowCount()){g._addBindingListener(B,"dataReceived",this._onDataReceived.bind(this));}this._oTable.bindRows(B);}return this;};g.prototype._onDataReceived=function(E){if(E&&E.getParameter&&E.getParameter("__simulateAsyncAnalyticalBinding")){return;}this._updateHeaderText();};g.prototype._updateHeaderText=function(){var h,r;if(this._oTitle&&this.getHeader()){h=this.getHeader();if(this.getShowRowCount()){r=this._getRowCount();if(r){h+=" ("+r+")";}}this._oTitle.setText(h);}};g.prototype._getRowCount=function(){var r=this._getRowBinding(),i,v="";if(r){i=r.getLength();if(!this._oNumberFormatInstance){this._oNumberFormatInstance=N.getFloatInstance();}if(r.isLengthFinal()){v=this._oNumberFormatInstance.format(i);}}return v;};g.prototype._getRowBinding=function(){if(this._oTable){return this._oTable.getBinding(this._sAggregation);}};g._addBindingListener=function(B,E,h){if(!B.events){B.events={};}if(!B.events[E]){B.events[E]=h;}else{var o=B.events[E];B.events[E]=function(){h.apply(this,arguments);o.apply(this,arguments);};}};g.prototype._showSettings=function(){if(!this._settingsTriggered){this._settingsTriggered=true;sap.ui.require(["sap/ui/mdc/TableSettings"],function(h){h.showColumnsPanel(this).then(function(i){h.handleUserChanges(i,this).then(this._afterSettingsDone.bind(this));}.bind(this));}.bind(this));}};g.prototype.rebindTable=function(){if(this._oBindingInfo){this.bindRows(this._oBindingInfo);}};g.prototype._afterSettingsDone=function(){delete this._settingsTriggered;this.rebindTable();};g.prototype.exit=function(){if(this._oTemplate){this._oTemplate.destroy();}this._oTemplate=null;this._oTable=null;this._oToolbar=null;this._oTitle=null;this._oNumberFormatInstance=null;this._fReject=null;this._fResolve=null;};return g;},true);
