/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(["./ResourceModel","sap/ui/mdc/base/ConditionModel","sap/ui/mdc/base/ValueHelpPanel","sap/ui/mdc/base/DefineConditionPanel","sap/ui/mdc/base/FilterOperatorConfig","sap/ui/mdc/odata/v4/CommonHelper","sap/ui/model/json/JSONModel","sap/ui/mdc/experimental/NamedBindingModel","sap/m/Dialog","sap/m/Bar","sap/m/Label","sap/m/Button"],function(R,C,V,D,F,a,J,N,b,B,L,c){"use strict";var d=b.extend("sap.ui.mdc.ValueHelpDialog",{metadata:{properties:{entitySet:"string",fieldPath:"string",conditionModelName:"string",showConditionTab:{type:"boolean",defaultValue:true}},aggregations:{},events:{},publicMethods:[]},renderer:{}});d.prototype.init=function(){b.prototype.init.apply(this,arguments);var t=this;var T=new L();var o=new B({contentMiddle:T,contentRight:new c({text:'{$i18n>valuehelp.RESET}',press:this.onReset.bind(this)})});this.setCustomHeader(o);this.setDraggable(true);this.setResizable(true);this.setContentWidth('1024px');this.setContentHeight('600px');this.setVerticalScrolling(false);this.setHorizontalScrolling(false);this.setEndButton(new c({text:'{$i18n>valuehelp.CANCEL}',press:this.onCancel.bind(this)}));this.addStyleClass("sapUiNoContentPadding");this.oValueHelpPanel=new V({id:this.getId()+"::valueHelpPanel",height:"100%"});this.oValueHelpPanel.attachOnBasicSearchChange(t.handleOnBasicSearch.bind(t));this.addContent(t.oValueHelpPanel);this.attachAfterClose(function(e){Object.keys(this.mSearchTemplates).forEach(function(s){var S=this.mSearchTemplates[s];if(S.$filterBar&&S.$listContainer){var g=S.$filterBar.getConditionModelName();var h=S.$filterBar.getModel(g)||this.oConditionModelClone;var l=S.$listContainer._getRowBinding();C.destroyCM(h);l.getModel().unregisterNamedBinding(l);S.$listContainer.destroy();S.$filterBar.destroy();}}.bind(this));this.destroy();}.bind(this));var f=function(){var m=this.getModel();var e,s;if(m){t.detachModelContextChange(f);e=t.getEntitySet();s=t.getFieldPath();var g=t.getModel(t.getConditionModelName());t.oConditionModelClone=g.clone(s);var h=t.oConditionModelClone.bindProperty("/",t.oConditionModelClone.getContext("/"));h.attachChange(function(i){t.updateTableSelections();});t.oValueHelpPanel.initModel(t.oConditionModelClone);m.getMetaModel().requestValueListInfo('/'+e+'/'+s.replace(/\*/g,'')).then(function(v){a._extendValueListMetadata(m.getMetaModel(),e,s.replace(/\*/g,''),v);t.mSearchTemplates=v;var i=[],S=Object.keys(t.mSearchTemplates);if(S.length>1){S.forEach(function(n){i.push({key:S.indexOf(n).toString(),title:n,visible:true});});t.oValueHelpPanel.setSearchTemplateModelData({currentVariant:"0",defaultVariant:"0",variantsEditable:false,variants:i});}var j=function(E){t.switchSearchTemplate(Object.keys(t.mSearchTemplates)[E.getParameter("key")]);};t.oValueHelpPanel.attachSearchTemplateChange(j);var k=t.mSearchTemplates[""]?"":S[0];t.switchSearchTemplate(k);if(t.getShowConditionTab()&&t.mSearchTemplates[k].$mdc.sSelectionMode!=="Single"){var l=new D({id:t.getId()+"::defineConditionPanel",height:"100%"});t.oValueHelpPanel.setDefineConditions(l);}if(t.mSearchTemplates[k].$mdc.sSelectionMode==="Single"){t.oValueHelpPanel.setShowTokenizer(false);}else{t.setBeginButton(new c({text:'{$i18n>valuehelp.OK}',press:t.onOk.bind(t)}));}},function(E){throw(E.message);});T.setText(t.getTitle());}};this.attachModelContextChange(f);};d.prototype.onOk=function(){var l=this.getFieldPath();var o=this.getModel(this.getConditionModelName());o.merge(l,this.oConditionModelClone);this.close();};d.prototype.onCancel=function(){this.close();};d.prototype.handleOnBasicSearch=function(e){var t=this.mSearchTemplates[this.sActiveSearchTemplate].$listContainer._oTable;var s=e.getParameter("value")||e.getParameter("newValue");var f=this.mSearchTemplates[this.sActiveSearchTemplate].$mdc._aFilterProperties;s=(typeof s==="string")?s.trim():undefined;if(!f){t.getBinding("items").changeParameters({$search:s||undefined});}else if(s){var g="";f.forEach(function(p){if(p.operators[0]==="contains"){g=g+(g?" or ":"")+"contains"+'('+p.path+",\'"+s+"\')";}else{var P="";p.operators.forEach(function(o){if(o==="eq"){P=P+(P?" or ":"")+"("+p.path+" eq \'"+s+"\')";}else{P=P+(P?" or ":"")+o+'('+p.path+",\'"+s+"\')";}});g=g+(g?" or ":"")+P;}});t.getBinding("items").changeParameters({$filter:("("+g+")")});}else{t.getBinding("items").changeParameters({$filter:undefined});}};d.prototype.switchSearchTemplate=function(s){if(this.mSearchTemplates[s].$listContainer&&this.mSearchTemplates[s].$filterBar){this.updateContent(this.mSearchTemplates[s].$filterBar,this.mSearchTemplates[s].$listContainer);this.sActiveSearchTemplate=s;this.updateTableSelections();return;}var t=this;var v=this.mSearchTemplates[s];var o=new J(v);var m=v.$model.getMetaModel();var e=sap.ui.view({id:t.getId()+"::"+v.CollectionPath,viewName:"sap.ui.mdc.ValueHelpTemplate",type:"XML",async:true,preprocessors:{xml:{bindingContexts:{entitySet:m.createBindingContext("/"+v.CollectionPath),valueList:o.createBindingContext("/")},models:{valueList:o,entitySet:m}}}});e.loaded().then(function(e){var T=t.mSearchTemplates[s].$listContainer=e.byId("template::valueListTable");var f=t.mSearchTemplates[s].$filterBar=e.byId("template::valueListFilterBar");T.attachSelectionChange(t.handleSelectionChange.bind(t));T.bindRows({path:"/"+v.CollectionPath,parameters:{id:v.$mdc.qualifier},events:{change:t.updateTableSelections.bind(t)}});if(!v.$mdc.bSearchable){t.mSearchTemplates[s].$mdc._aFilterProperties=t._getFilterableProperties(v);}(v.$model.registerNamedBinding?Promise.resolve():N.upgrade(v.$model)).then(function(){T.setModel(v.$model);f.setModel(v.$model);t.updateContent(f,T);e.destroy();});t.sActiveSearchTemplate=s;});};d.prototype.updateContent=function(f,t){var s;this.oValueHelpPanel.setFilterbar(f);if(this.oValueHelpPanel.getTable()instanceof sap.m.ScrollContainer){s=this.oValueHelpPanel.getTable();s.removeAllContent();s.insertContent(t,0);}else{s=new sap.m.ScrollContainer({height:"100%",horizontal:false,vertical:true});s.addContent(t);}this.oValueHelpPanel.setTable(s);};d.prototype.handleSelectionChange=function(e){var t=this;var o=t.oConditionModelClone;var v=t.mSearchTemplates[t.sActiveSearchTemplate];var i,k,s,f;f=e.getParameter("bindingContext");i=f.getObject();k=i[v.$mdc.keyPath];s=i[v.$mdc.descriptionPath];var O={};Object.keys(v.$mdc.oLocalDataToValueListMap).forEach(function(l){var j=v.$mdc.oLocalDataToValueListMap[l];O[l]=i[j];});var g=o.createItemCondition(t.getFieldPath(),k,s);g.outParameters=O;var S=t.mSearchTemplates[t.sActiveSearchTemplate].$mdc.sSelectionMode;var h=o.indexOf(t.getFieldPath(),g);if(h===-1){if(S==="Single"){o.removeAllConditions();o.addCondition(g);t.onOk();}else{o.addCondition(g);}}else{o.removeCondition(t.getFieldPath(),h);}};d.prototype.updateTableSelections=function(e){var t=this;var T;if(!t.mSearchTemplates||!t.mSearchTemplates[t.sActiveSearchTemplate]){return;}T=t.mSearchTemplates[t.sActiveSearchTemplate].$listContainer._oTable;if(!T){return;}T.removeSelections(true);var l=T.getItems();var f;var v=t.mSearchTemplates[t.sActiveSearchTemplate];f=t.oConditionModelClone.getConditions();f.forEach(function(o){if(o.operator==="EEQ"){l.forEach(function(g){var i=g.getBindingContext().getObject();var O=o.outParameters;if((Object.keys(O).filter(function(k){var s=v.$mdc.oLocalDataToValueListMap[k];return O[k]===i[s];}).length)===Object.keys(O).length){T.setSelectedItem(g,true);}});}});};d.prototype.onReset=function(){var f;for(var p in this.mSearchTemplates){f=this.mSearchTemplates[p].$filterBar;if(f){f.getModel(f.getConditionModelName()).removeAllConditions();}}this.oConditionModelClone.removeAllConditions();this.oValueHelpPanel.clearSearch();};d.prototype._getFilterableProperties=function(v){var m=v.$model.getMetaModel();var f=F.getFor(v.$model);var e=[];v.Parameters.forEach(function(p){var P=p.ValueListProperty;var o=m.getContext("/"+v.CollectionPath+"/"+P);if(a.isPropertyFilterable(P,{context:o})){var t=m.getObject("/"+v.CollectionPath+"/"+P+"/$Type");var O=f.getOperatorsForType(t);var g=[];if(O.includes("Contains")){g.push("contains");}else{O.forEach(function(s){if(s==="StartsWith"||s==="EQ"||s==="EndsWith"){g.push(s.toLowerCase());}});}if(g.length){e.push({path:P,operators:g});}}});return e;};return d;},true);
