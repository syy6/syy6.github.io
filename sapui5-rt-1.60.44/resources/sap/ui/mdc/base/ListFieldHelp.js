/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['./FieldHelpBase','sap/ui/model/base/ManagedObjectModel','sap/ui/base/ManagedObjectObserver','sap/ui/mdc/library'],function(F,M,a,l){"use strict";var L;var D;var m;var b;var c=F.extend("sap.ui.mdc.base.ListFieldHelp",{metadata:{library:"sap.ui.mdc",aggregations:{items:{type:"sap.ui.core.ListItem",multiple:true,singularName:"item"}},defaultAggregation:"items"}});c.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oManagedObjectModel=new M(this);this._oObserver=new a(e.bind(this));this._oObserver.observe(this,{properties:["filterValue","conditions"],aggregations:["items"]});};c.prototype.exit=function(){F.prototype.exit.apply(this,arguments);this._oManagedObjectModel.destroy();delete this._oManagedObjectModel;this._oObserver.disconnect();this._oObserver=undefined;};c.prototype._createPopover=function(){var p=F.prototype._createPopover.apply(this,arguments);if((!L||!D||!m)&&!this._bListRequested){L=sap.ui.require("sap/m/List");D=sap.ui.require("sap/m/DisplayListItem");m=sap.ui.require("sap/m/library");b=sap.ui.require("sap/ui/model/Filter");if(!L||!D||!m){sap.ui.require(["sap/m/List","sap/m/DisplayListItem","sap/m/library","sap/ui/model/Filter"],d.bind(this));this._bListRequested=true;}}if(p){var i=this._getField();if(i){p.setInitialFocus(i);}_.call(this);}return p;};function _(){if(L&&D&&m&&!this._bListRequested){var i=new D({type:m.ListType.Active,label:"{$field>text}",value:"{$field>additionalText}"});var p=new b("text",j.bind(this));this._oList=new L(this.getId()+"-List",{width:"100%",showNoData:false,mode:m.ListMode.SingleSelectMaster,rememberSelections:false,items:{path:"$field>items",template:i,filters:p},itemPress:f.bind(this)});this._oList.setModel(this._oManagedObjectModel,"$field");this._oList.bindElement({path:"/",model:"$field"});k.call(this);this._setContent(this._oList);if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);this._iStep=null;}}}function d(i,p,q,r){L=i;D=p;m=q;b=r;this._bListRequested=false;if(!this._bIsBeingDestroyed){_.call(this);}}c.prototype.open=function(s){var p=this.getAggregation("_popover");if(p){var i=this._getField();p.setInitialFocus(i);}F.prototype.open.apply(this,arguments);return this;};c.prototype._handleAfterClose=function(E){F.prototype._handleAfterClose.apply(this,arguments);if(this._bUpdateFilterAfterClose){this._bUpdateFilterAfterClose=false;h.call(this);}};function e(C){if(C.object===this){if(C.name==="items"){if(C.mutation==="insert"){this._oObserver.observe(C.child,{properties:true});}else{this._oObserver.unobserve(C.child);}this.fireDataUpdate();}if(C.name==="conditions"){if(!this._bConditionUpdate){k.call(this);}}if(C.name==="filterValue"){if(this._oList){if(this._bClosing){this._bUpdateFilterAfterClose=true;}else{h.call(this);}}}}else{this.fireDataUpdate();}}c.prototype.openByTyping=function(){return true;};c.prototype.navigate=function(s){var p=this._getPopover();if(!p||!this._oList){this._bNavigate=true;this._iStep=s;return;}var S=this._oList.getSelectedItem();var i=this._oList.getItems();var I=i.length;var q=0;if(S){q=this._oList.indexOfItem(S);q=q+s;if(q<0){q=0;}else if(q>=I-1){q=I-1;}}else if(s>=0){q=s-1;}else{q=I+s;}var r=i[q];if(r&&r!==S){var O=g.call(this,r);var K=n.call(this,O);r.setSelected(true);o.call(this,K,r.getLabel(),r.getValue());if(!p.isOpen()){this.open();}this.fireNavigate({value:r.getLabel(),additionalValue:r.getValue(),key:K});}};c.prototype.getTextForKey=function(K){var I=this.getItems();for(var i=0;i<I.length;i++){var p=I[i];if(n.call(this,p)===K){return p.getText();}}return"";};c.prototype.getKeyForText=function(t){var I=this.getItems();for(var i=0;i<I.length;i++){var p=I[i];if(p.getText()===t){return n.call(this,p);}}return"";};function f(E){var i=E.getParameter("listItem");var s=i.getSelected();if(s){var O=g.call(this,i);var K=n.call(this,O);o.call(this,K,i.getLabel(),i.getValue());this.close();this.fireSelect({value:i.getLabel(),additionalValue:i.getValue(),key:K,conditions:this.getConditions(),add:true});}}function g(i){var p=i.getBindingContextPath();return this._oManagedObjectModel.getProperty(p);}function h(){var B=this._oList.getBinding("items");B.update();this._oList.updateItems();this._oList.invalidate();k.call(this);}function j(t){var s=this.getFilterValue();if(!s||(typeof s==="string"&&t.toLowerCase().startsWith(s.toLowerCase()))){return true;}else{return false;}}function k(){if(this._oList){var C=this.getConditions();var s;if(C.length>0&&(C[0].operator==="EEQ"||C[0].operator==="EQ")){s=C[0].values[0];}var I=this._oList.getItems();for(var i=0;i<I.length;i++){var p=I[i];var O=g.call(this,p);if(n.call(this,O)===s){p.setSelected(true);}else{p.setSelected(false);}}}}function n(i){var B=i.getBinding("key");if(B){return B.getInternalValue();}else{return i.getKey();}}function o(K,v,A){this._bConditionUpdate=true;var C={fieldPath:this.getFieldPath(),operator:"EEQ",values:[K]};if(v){C.values.push(v);}this.setProperty("conditions",[C],true);this._bConditionUpdate=false;}return c;},true);
