/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['./FieldHelpBase','./FilterOperatorConfig','sap/ui/base/ManagedObjectObserver','sap/base/util/merge','sap/base/util/ObjectPath','sap/base/util/deepEqual'],function(F,a,M,m,O,d){"use strict";var D;var B;var V;var b;var C;var c=F.extend("sap.ui.mdc.base.FieldValueHelp",{metadata:{library:"sap.ui.mdc",properties:{getTextForKey:{type:"function",group:"Data"},getKeyForText:{type:"function",group:"Data"},getKeyFromItem:{type:"function",group:"Data"},getTextFromItem:{type:"function",group:"Data"},filterFields:{type:"string",defaultValue:""},keyPath:{type:"string",defaultValue:""},descriptionPath:{type:"string",defaultValue:""},showConditionPanel:{type:"boolean",defaultValue:false},title:{type:"string",group:"Appearance",defaultValue:""},noDialog:{type:"boolean",group:"Appearance",defaultValue:false}},aggregations:{content:{type:"sap.ui.mdc.base.FieldValueHelpContentWrapperBase",multiple:false},filterBar:{type:"sap.ui.core.Control",multiple:false},_dialog:{type:"sap.m.Dialog",multiple:false,visibility:"hidden"}},defaultAggregation:"content",events:{navigateToItem:{parameters:{step:{type:"int"},selectedItem:{type:"sap.m.ListItemBase"}}},filterItems:{parameters:{filterText:{type:"string"}}}}}});c.prototype.init=function(){F.prototype.init.apply(this,arguments);this._oObserver=new M(_.bind(this));this._oObserver.observe(this,{properties:["filterValue","conditions","showConditionPanel","title"],aggregations:["content","filterBar"]});};c.prototype.exit=function(){F.prototype.exit.apply(this,arguments);this._oObserver.disconnect();this._oObserver=undefined;if(this._oFilterOperatorConfig){this._oFilterOperatorConfig.destroy();delete this._oFilterOperatorConfig;}};c.prototype.invalidate=function(i){if(i){var j=this.getAggregation("_dialog");var P=this.getFilterBar();if((j&&i===j)||(P&&i===P)){if(i.bOutput){var S=sap.ui.getCore().getStaticAreaRef();S=sap.ui.getCore().getUIArea(S);if(S.addInvalidatedControl){S.addInvalidatedControl(i);}}return;}}F.prototype.invalidate.apply(this,arguments);};c.prototype.connect=function(i){if(this._oField&&this._oField!==i){if(this._oFilterConditionModel){this._oFilterConditionModel.removeFilterField(this);}if(this._oConditionModel){this._oConditionModel.removeFilterField(this);}}F.prototype.connect.apply(this,arguments);if(this._oFilterConditionModel){this._oFilterConditionModel.addFilterField(this);}if(this._oConditionModel){this._oConditionModel.addFilterField(this);}else{s.call(this);}K.call(this,this.getShowConditionPanel());return this;};c.prototype.getIcon=function(){if(this.getNoDialog()){return"sap-icon://slim-arrow-down";}else{return"sap-icon://value-help";}};c.prototype._createPopover=function(){var P=F.prototype._createPopover.apply(this,arguments);if(P){var i=this._getField();if(i){P.setInitialFocus(i);}var W=this.getContent();W.initialize(true);P._getAllContent=function(){var j=this.getParent();var Q=[];if(j){var R=N.call(j);if(R){Q.push(R);}}return Q;};if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);this._iStep=null;}}return P;};c.prototype._handleAfterOpen=function(i){F.prototype._handleAfterOpen.apply(this,arguments);var W=this.getContent();if(W){W.fieldHelpOpen(true);}};c.prototype.open=function(S){if(this.getNoDialog()&&!S){S=true;}var W=this.getContent();if(W&&W.getFilterEnabled()&&!this._oFilterConditionModel){p.call(this);}var P=this.getAggregation("_popover");if(S){if(P){var i=this._getField();P.setInitialFocus(i);}F.prototype.open.apply(this,[S]);}else{if(P){if(P.isOpen()){this.close();}P.$().remove();}var j=A.call(this);if(j){var Q=j.getContent()[0];Q.setShowTokenizer(this.getMaxConditions()!==1);if(W){W.fieldHelpOpen(false);k.call(this);}this.fireOpen({suggestion:S});j.open();}else{this._bOpen=true;}}return;};c.prototype.toggleOpen=function(S){if(this.getNoDialog()&&!S){S=true;}if(S){F.prototype.toggleOpen.apply(this,[S]);}else{var i=A.call(this);if(i){if(i.isOpen()){var j=i.oPopup.getOpenState();if(j!=="CLOSED"&&j!=="CLOSING"){this.close();}else{this._bReopen=true;}}else{this.open(S);}}else{this._bOpen=!this._bOpen;}}};c.prototype.close=function(){if(!this._bDialogOpen){F.prototype.close.apply(this,arguments);}else{var i=this.getAggregation("_dialog");if(i){this._bClosing=true;i.close();var W=this.getContent();var j=i.getContent()[0];if(W){W.fieldHelpClose();j.clearSearch();this._oFilterConditionModel.removeAllConditions();n.call(this);}}this._bReopen=false;}};c.prototype._handleAfterClose=function(i){F.prototype._handleAfterClose.apply(this,arguments);if(this._bUpdateFilterAfterClose){this._bUpdateFilterAfterClose=false;l.call(this,this._sFilterValueAfterClose);this._sFilterValueAfterClose=null;}var W=this.getContent();if(W){W.fieldHelpClose();}};function _(i){if(i.name==="content"){z.call(this,i.mutation,i.child);}if(i.name==="filterBar"){L.call(this,i.mutation,i.child);}if(i.name==="conditions"){h.call(this,i.current);}if(i.name==="filterValue"){if(this._bClosing){this._bUpdateFilterAfterClose=true;this._sFilterValueAfterClose=i.current;}else{l.call(this,i.current);}}if(i.name==="showConditionPanel"){K.call(this,i.current);}if(i.name==="title"){var j=this.getAggregation("_dialog");if(j){j.setTitle(i.current);}}}c.prototype.openByTyping=function(){return true;};c.prototype.navigate=function(S){var P=this._getPopover();if(!P){this._bNavigate=true;this._iStep=S;return;}else if(!P.isOpen()){this.fireOpen({suggestion:true});}var W=this.getContent();if(W){W.navigate(S);}else{this._bNavigate=true;this._iStep=S;return;}};function e(i){var P=this._getPopover();var j=i.getParameter("key");var Q=i.getParameter("description");var R=this.getFieldPath();var S;if(!P.isOpen()){this.open(true);}if(Q){S=this._oConditionModel.createItemCondition(R,j,Q);}else{S=this._oConditionModel.createItemCondition(R,j);}this.setProperty("conditions",[S],true);this.fireNavigate({value:Q,key:j});}c.prototype.getTextForKey=function(i){var T="";var j=this.getGetTextForKey();if(j){T=j(i);if(typeof T!=="string"){throw new Error("function getTextForKey must return a string");}}else{var W=this.getContent();if(W){T=W.getTextForKey(i);}}return T;};c.prototype.getKeyForText=function(T){var i;var j=this.getGetKeyForText();if(j){i=j(T);}else{var W=this.getContent();if(W){i=W.getKeyForText(T);}}return i;};function f(P){var S=P.getParameter("selectedItems");var Q=this.getFieldPath();var R;var T=m([],this._oConditionModel.getConditions(Q));var U;var i=0;var j=0;var W=false;for(i=0;i<T.length;i++){U=T[i];if(U.operator==="EEQ"||U.operator==="EQ"){W=false;for(j=0;j<S.length;j++){R=S[j];if(U.values[0]===R.key){W=true;break;}}if(!W){this._oConditionModel.removeCondition(Q,U);}}}T=m([],this._oConditionModel.getConditions(Q));for(i=0;i<S.length;i++){R=S[i];W=false;for(j=0;j<T.length;j++){U=T[j];if((U.operator==="EEQ"||U.operator==="EQ")&&U.values[0]===R.key){W=true;break;}}if(!W){if(R.description){U=this._oConditionModel.createItemCondition(Q,R.key,R.description);}else{U=this._oConditionModel.createItemCondition(Q,R.key);}this._oConditionModel.addCondition(Q,U);}}if(this._bDialogOpen){k.call(this);}else{this.close();var X=R&&R.key;var Y=R&&R.description;this._bNoConditionModelUpdate=true;this.setProperty("conditions",[U],true);this.fireSelect({value:Y,key:X,conditions:[U],add:true});}}function g(i){if(i.getParameter("contentChange")){var P=this.getAggregation("_popover");var j=this.getAggregation("_dialog");var W=this.getContent();if(W){if(P&&this._bOpenIfContent){var Q=this._getField();if(Q){W.fieldHelpOpen(true);P.openBy(Q);}this._bOpenIfContent=false;}else if(j){var R=j.getContent()[0];y.call(this,R,W.getDialogContent());}if(this._oFilterConditionModel&&W.getListBinding()!==this._oFilterConditionModel._oListBinding){this._oFilterConditionModel.destroy();this._oFilterConditionModel=undefined;}if(W.getFilterEnabled()&&!this._oFilterConditionModel){p.call(this);}}}this.fireDataUpdate();}function h(j){if(this._oConditionModel){if(!this._bNoConditionModelUpdate){this._oConditionModel.removeAllConditions();for(var i=0;i<j.length;i++){var P=m({},j[i]);this._oConditionModel.addCondition(P);}}else{this._bNoConditionModelUpdate=false;}}else{s.call(this);}k.call(this);}function k(){if(!this._oField){return;}var j=this.getFieldPath();var W=this.getContent();if(W){var P=this._oConditionModel?this._oConditionModel.getConditions(j):this.getConditions();var Q=[];for(var i=0;i<P.length;i++){var R=P[i];if(R.operator==="EEQ"||R.operator==="EQ"){Q.push({key:R.values[0],description:R.values[1]});}}if(!d(Q,W.getSelectedItems())){W.setSelectedItems(Q);}}}function l(i){if(!this._oFilterConditionModel){return;}var j=r.call(this);if(!j){return;}this._oFilterConditionModel.removeAllConditions(j);if(i){var P=this._oFilterConditionModel.createCondition(j,"StartsWith",[i]);this._oFilterConditionModel.addCondition(P);}}function n(){if(!this._oFilterConditionModel){return;}if(this._oFilterConditionModel._oListBinding.isSuspended()){this._oFilterConditionModel._oListBinding.resume();}this._oFilterConditionModel.applyFilters(true);}function o(i){if(this._bOwnFilterChange){return;}n.call(this);}function p(){if(!C&&!this._bFilterConditionModelRequested){C=sap.ui.require("sap/ui/mdc/base/ConditionModel");if(!C){sap.ui.require(["sap/ui/mdc/base/ConditionModel"],q.bind(this));this._bFilterConditionModelRequested=true;}}if(C){var W=this.getContent();var i=W&&W.getListBinding();if(i){this._oFilterConditionModel=C.getFor(i,this.getId());l.call(this,this.getFilterValue());var j=this._oFilterConditionModel.bindProperty("/conditions",this._oFilterConditionModel.getContext("/conditions"));j.attachChange(o.bind(this));var P=this.getFilterBar();if(P){P.setModel(this._oFilterConditionModel,"filter");}}}}function q(i){C=i;this._bFilterConditionModelRequested=false;if(!this._bIsBeingDestroyed){p.call(this);}}c.prototype.getMaxConditions=function(){if(this._oField.getMaxConditions){return this._oField.getMaxConditions();}else{return 1;}};c.prototype.getDisplay=function(){if(this._oField.getDisplay){return this._oField.getDisplay();}};c.prototype.getRequired=function(){if(this._oField.getRequired){return this._oField.getRequired();}else{return false;}};c.prototype.getFilterOperatorConfig=function(){if(this._oField&&this._oField._getFilterOperatorConfig){return this._oField._getFilterOperatorConfig();}else if(this._oFilterOperatorConfig){return this._oFilterOperatorConfig;}else{this._oFilterOperatorConfig=a.getFor();return this._oFilterOperatorConfig;}};c.prototype.getDataType=function(){if(this._oField.getDataType){return this._oField.getDataType();}else{return"sap.ui.model.type.String";}};c.prototype._getDataType=function(){if(this._oField._getDataType){return this._oField._getDataType();}else{var i=O.get("sap.ui.model.odata.type.String");return new i();}};function r(){var i=this.getFilterFields();if(!i){i=this.getFieldPath();}return i;}c.prototype._getKeyPath=function(){var i=this.getKeyPath();if(!i&&this._oField&&this._oField.getFieldPath&&this._oField.getFieldPath()){i=this._oField.getFieldPath();}return i;};function s(){if(!C&&!this._bConditionModelRequested){C=sap.ui.require("sap/ui/mdc/base/ConditionModel");if(!C){sap.ui.require(["sap/ui/mdc/base/ConditionModel"],t.bind(this));this._bConditionModelRequested=true;}}if(C){this._oConditionModel=new C();var i=this;this._oConditionModel.getFilterOperatorConfig=function(){return i.getFilterOperatorConfig();};var j=this._oConditionModel.bindProperty("/",this._oConditionModel.getContext("/"));j.attachChange(u.bind(this));this._oConditionModel.addFilterField(this);h.call(this,this.getConditions());this.setModel(this._oConditionModel,"cm");}}function t(i){C=i;this._bConditionModelRequested=false;if(!this._bIsBeingDestroyed){s.call(this);}}function u(i){if(this._bChangedByMe){this._bChangedByMe=false;return;}if(this._bDialogOpen){k.call(this);}}function v(){var i;if((!D||!B||!V||!b)&&!this._bDialogRequested){D=sap.ui.require("sap/m/Dialog");B=sap.ui.require("sap/m/Button");V=sap.ui.require("sap/ui/mdc/base/ValueHelpPanel");b=sap.ui.require("sap/ui/mdc/base/DefineConditionPanel");if(!D||!B||!V||!b||!C){sap.ui.require(["sap/m/Dialog","sap/m/Button","sap/ui/mdc/base/ValueHelpPanel","sap/ui/mdc/base/DefineConditionPanel"],w.bind(this));this._bDialogRequested=true;}}if(D&&B&&V&&b&&!this._bDialogRequested){if(!this._oResourceBundle){this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");}var j=new B(this.getId()+"-ok",{text:this._oResourceBundle.getText("valuehelp.OK"),press:E.bind(this)});var P=new B(this.getId()+"-cancel",{text:this._oResourceBundle.getText("valuehelp.CANCEL"),press:G.bind(this)});var Q=x.call(this);i=new D(this.getId()+"-dialog",{contentHeight:"600px",contentWidth:"1000px",horizontalScrolling:false,verticalScrolling:false,title:this.getTitle(),resizable:true,draggable:true,content:[Q],afterOpen:H.bind(this),afterClose:I.bind(this),buttons:[j,P]});this.setAggregation("_dialog",i,true);i.setModel(new sap.ui.model.resource.ResourceModel({bundleName:"sap/ui/mdc/messagebundle",async:false}),"$i18n");K.call(this,this.getShowConditionPanel());}return i;}function w(i,j,P,Q,R){D=i;B=j;V=P;b=Q;this._bDialogRequested=false;if(!this._bIsBeingDestroyed){v.call(this);if(this._bOpen){this.open();delete this._bOpen;}}}function x(){var W=this.getContent();var i=this.getFilterBar();var j=new V(this.getId()+"-VHP",{height:"100%",showFilterbar:!!i,onBasicSearchChange:J.bind(this)});if(W){W.initialize(false);y.call(this,j,W.getDialogContent());}if(i){j.setFilterbar(i);}j.initModel(this._oConditionModel);return j;}function y(i,j){i.setTable(j);}function z(i,W){var P=this.getAggregation("_popover");var j=this.getAggregation("_dialog");if(i==="remove"){W.detachEvent("navigate",e,this);W.detachEvent("selectionChange",f,this);W.detachEvent("dataUpdate",g,this);W=undefined;}else{W.attachEvent("navigate",e,this);W.attachEvent("selectionChange",f,this);W.attachEvent("dataUpdate",g,this);k.call(this);}this.fireDataUpdate();if(this._bNavigate){this._bNavigate=false;this.navigate(this._iStep);this._iStep=null;}else if(P){P.invalidate();var Q=this.getFilterValue();if(Q){l.call(this,Q);}if(W&&W.getFilterEnabled()&&!this._oFilterConditionModel){p.call(this);}if(W&&this._bOpenIfContent){W.initialize(true);var R=this._getField();if(R){W.fieldHelpOpen(true);P.openBy(R);}this._bOpenIfContent=false;}}if(j){if(W){W.initialize(false);if(W.getFilterEnabled()&&!this._oFilterConditionModel){p.call(this);}var S=j.getContent()[0];y.call(this,S,W.getDialogContent());if(j.isOpen()){W.fieldHelpOpen(false);}}}}function A(){var i=this.getAggregation("_dialog");if(!i){i=v.call(this);}return i;}function E(i){this.close();var j=this._oConditionModel.getConditions(this.getFieldPath());j=C.removeEmptyConditions(j);var P;var Q;if(j.length>0){P=j[0].values[0];Q=j[0].values[1];}this._bNoConditionModelUpdate=true;this.setProperty("conditions",j,true);this.fireSelect({value:Q,key:P,conditions:j,add:false});}function G(i){this.close();}function H(i){this._bDialogOpen=true;}function I(i){this._bDialogOpen=false;h.call(this,this.getConditions());var W=this.getContent();if(W){W.fieldHelpClose();}this._handleAfterClose();}function J(i){var j=i.getParameter("value");l.call(this,j);}function K(i){var j=this.getAggregation("_dialog");if(j&&this._oField){var P=j.getContent()[0];if(i&&this._oField._getOnlyEEQ&&!this._oField._getOnlyEEQ()){if(!P._oDefineConditionPanel){var Q=new b(this.getId()+"-DCP");P.setDefineConditions(Q);}}else{P.setDefineConditions();}}}function L(i,j){if(i==="remove"){j.setModel(null,"filter");j=undefined;}else if(this._oFilterConditionModel){j.setModel(this._oFilterConditionModel,"filter");}var P=this.getAggregation("_dialog");if(P){var Q=P.getContent()[0];Q.setFilterbar(j);Q.setShowFilterbar(!!j);}}function N(){var W=this.getContent();if(W){return W.getSuggestionContent();}}return c;},true);
