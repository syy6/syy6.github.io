/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/thirdparty/jquery",'sap/ui/core/Control','sap/ui/model/json/JSONModel','./FilterFieldRenderer','sap/m/MultiInput','sap/m/Token','sap/ui/model/Filter','sap/ui/model/Sorter',"sap/ui/model/base/ManagedObjectModel","sap/ui/base/ManagedObjectObserver","sap/ui/mdc/base/type/DateRange",'sap/ui/mdc/library',"sap/base/Log","sap/ui/dom/containsOrEquals","sap/base/util/ObjectPath"],function(q,C,J,F,M,T,a,S,b,c,D,l,L,d,O){"use strict";var E=l.EditMode;var e=C.extend("sap.ui.mdc.base.FilterField",{constructor:function(i,s){this._oManagedObjectModel=null;this._oActiveDelegate=null;C.apply(this,arguments);},metadata:{properties:{showValueHelp:{type:"boolean",group:"Data",defaultValue:true},dataType:{type:"any",group:"Data",defaultValue:"sap.ui.model.type.String"},dataTypeConstraints:{type:"object",group:"Data",defaultValue:null},dataTypeFormatOptions:{type:"object",group:"Data",defaultValue:null},fieldPath:{type:"string",group:"Data",defaultValue:null},width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"15rem"},editable:{type:"boolean",group:"Data",defaultValue:true},editMode:{type:"sap.ui.mdc.EditMode",group:"Data",defaultValue:E.Editable},maxConditions:{type:"int",group:"Behavior",defaultValue:-1},placeholder:{type:"string",group:"Behavior",defaultValue:""},required:{type:"boolean",group:"Misc",defaultValue:false},valueState:{type:"sap.ui.core.ValueState",group:"Appearance",defaultValue:sap.ui.core.ValueState.None},valueStateText:{type:"string",group:"Misc",defaultValue:null},conditions:{type:"object[]",defaultValue:[]}},events:{valueHelpRequest:{},change:{parameters:{value:{type:"object"},type:{type:"string"},valid:{type:"boolean"}}},liveChange:{parameters:{value:{type:"string"},escPressed:{type:"boolean"}}}},aggregations:{_input:{type:"sap.ui.core.Control",multiple:false,hidden:true},content:{type:"sap.ui.core.Control",multiple:false},fieldHelp:{type:"sap.ui.mdc.base.FieldHelpBase",multiple:false}},publicMethods:[],defaultAggregation:"content"}});e.prototype.init=function(){this._oManagedObjectModel=new b(this);this._oManagedObjectModel.setSizeLimit(1000);this._oManagedObjectModel.attachEvent("propertyChange",this._updateConditionModel.bind(this));this._oObserver=new c(_.bind(this));this._oObserver.observe(this,{aggregations:["fieldHelp"]});};e.prototype.onAfterRendering=function(){var o=this.getAggregation("_input");if(o){var i=o.getFocusDomRef();q(i).attr("autocomplete","off");}};function _(o){if(o.name=="fieldHelp"&&o.child){f.call(this,o.child,o.mutation);}}function f(o,s){var i=false;if(s=="remove"){o.detachEvent("select",g,this);o.detachEvent("navigate",h,this);}else if(s=="insert"){o.attachEvent("select",g,this);o.attachEvent("navigate",h,this);i=true;}var n=this.getAggregation("_input");if(n&&n.setShowValueHelp){n.setShowValueHelp(i);}}function g(o){}function h(o){var v=o.getParameter("value");var i=this.getAggregation("_input");if(i&&i.setDOMValue){i.setDOMValue(v);i._doSelect();}this.fireLiveChange({value:v});}e.prototype._fireValueHelpRequest=function(o){if(this.hasListeners("valueHelpRequest")){this.fireValueHelpRequest(o);return;}var i=this.getFieldHelp();if(i){i.setFilterValue(" ");i.setConditions([]);i.toggleOpen();}};e.prototype.onsapup=function(o){var i=this.getFieldHelp();if(i){o.preventDefault();o.stopPropagation();i.navigate(-1);}};e.prototype.onsapdown=function(o){var i=this.getFieldHelp();if(i){o.preventDefault();o.stopPropagation();i.navigate(1);}};e.prototype.getFilterOperatorConfig=function(){if(!this._oFilterOpConfig&&this.getBinding("conditions")){var o=this.getBinding("conditions").getModel();this._oFilterOpConfig=o.getFilterOperatorConfig();}return this._oFilterOpConfig;};e.prototype.updateProperty=function(n){C.prototype.updateProperty.apply(this,arguments);if(n=="conditions"&&!this._bFFAdded){var B=this.getBinding("conditions");if(B){B.getModel().addFilterField(this);this._bFFAdded=true;}}return this;};e.prototype.setWidth=function(w){var o=this.getWidth();this.setProperty("width",w,true);if(o!=this.getWidth()){var i=this.getAggregation("_input");if(i){i.setWidth(w);}}return this;};e.prototype.setEditable=function(i){var o=this.getEditable();this.setProperty("editable",i,true);if(o!=this.getEditable()){var I=this.getAggregation("_input");if(I){I.setEditable(i);}}return this;};e.prototype.setPlaceholder=function(p){var o=this.getPlaceholder();this.setProperty("placeholder",p,true);if(o!=this.getPlaceholder()){var i=this.getAggregation("_input");if(i){i.setPlaceholder(p);}}return this;};e.prototype.setMaxConditions=function(i){this.setProperty("maxConditions",i,true);return this;};e.prototype.setRequired=function(r){var o=this.getRequired();this.setProperty("required",r,true);if(o!=this.getRequired()){var i=this.getAggregation("_input");if(i){i.setRequired(r);}}return this;};e.prototype._matchFieldPath=function(v){var s=this.sFieldPathUpper;return s===v;};e.prototype._handleTokenUpdate=function(i){var s=i.getId(),v,B,n,p,N,r;if(s==="tokenUpdate"){if(i.getParameter("type")==="added"){s="change";v=i.getParameter("addedTokens")[0].getText().trim();}if(i.getParameter("type")==="removed"){var R=i.getParameter("removedTokens"),t=[];R.forEach(function(o){t.push(o.getBindingContext("$filterField"));});B=this.getBinding("conditions");B.getModel().deleteConditions(t,B);}}if(s==="change"){L.info("mdc:FilterField","_handleTokenUpdate for "+s);var u=i.getSource(),w=this._getDataType(),x=w.getMetadata().getName();B=this.getBinding("conditions");if(u instanceof sap.m.Select){v=i.getParameter("selectedItem").getText();}else{v=v||i.getParameter("value");v=v.trim();}if(i.oSource.setSelectedKey){i.oSource.setSelectedKey();}L.info("mdc:FilterField","_handleTokenUpdate sValue "+v);if(!v){if(u instanceof sap.m.MultiInput){}else if(this.getMaxConditions()>=0&&this.getConditions().length>0){this.getConditions().splice(0,1);}B.getModel().removeUIMessage(this.getFieldPath());return;}if(u instanceof sap.m.DateRangeSelection){r=this.getFilterOperatorConfig().getOperator("BT");v=v.replace(" - ","...");n=r.getCondition(v,w);if(n){n.fieldPath=this.getFieldPath();this.setConditions(this.getConditions().push(n));this.fireChange({value:n,type:"added",valid:true});if(this.getMaxConditions()>=0&&B.getModel().getConditions(this.getFieldPath()).length>1){B.getModel().removeCondition(this.getFieldPath(),0);}return;}}if(this.getFieldHelp()){if(d(this.getFieldHelp()._getPopover().getFocusDomRef(),document.activeElement)){return;}if(this.getFieldHelp()._getPopover().isOpen()&&this.getFieldHelp().getConditions().length>0){return;}}p=this.getFilterOperatorConfig().getMatchingOperators(x,v);if(p.length===0){var y=this.getFilterOperatorConfig().getDefaultOperator(x);N=this.getFilterOperatorConfig().getOperator(y);v=N?N.format([v]):v;}else{N=p[0];}try{if(N&&N.test(v,w)){r=N;B.getModel().removeUIMessage(this.getFieldPath());}}catch(z){B.getModel().setUIMessage(this.getFieldPath(),z.message);}if(r){n=r.getCondition(v,w);if(n){n.fieldPath=this.getFieldPath();var A=this.getConditions();A.push(n);this.setConditions(A);this.fireChange({value:n,type:"added",valid:true});if(u instanceof sap.m.MultiInput){u.setValue("");}if(u instanceof sap.m.Select||u instanceof sap.m.DatePicker||u instanceof sap.m.TimePicker){if(this.getMaxConditions()>=0&&B.getModel().getConditions(this.getFieldPath()).length>1){B.getModel().removeCondition(this.getFieldPath(),0);}}}}}};var j=function(o){var r="";if(o){var i=this.getFilterOperatorConfig().getOperator(o.operator);var v=o.values;r=i.format(v,o,this._getDataType());}return r;};e.prototype._getDefaultInput=function(){var o;if(!this.getAggregation("_input")){var r=new RegExp("^\\*(.*)\\*|\\$search$");if(r.test(this.getProperty("fieldPath"))&&this.getMaxConditions()===1){o=new sap.m.SearchField(this.getId()+"-inner",{value:{path:"$filterField>conditions/0/values/0",mode:"OneWay"},search:function(i){var B=i.oSource.getParent().getBinding("conditions");var n=B.getModel();n.applyFilters(true);},liveChange:function(i){var n=i.oSource.getParent();var v=i.getParameter("newValue");if(this.iChangeTimer){clearTimeout(this.iChangeTimer);delete this.iChangeTimer;}this.iChangeTimer=setTimeout(function(){var p=n.getFilterOperatorConfig().getOperator("Contains");if(p&&p.test("*"+v+"*")){var B=n.getBinding("conditions");var s=B.getModel();if(v){var u=s.createCondition(n.getFieldPath(),"Contains",[v]);n.setConditions([u]);}else{n.setConditions([]);}}},400);}.bind(this)});}else if(this.getProperty("dataType").indexOf("Boolean")>-1&&this.getMaxConditions()===1){o=new sap.m.Select(this.getId()+"-inner",{width:this.getWidth(),selectedKey:"{$filterField>conditions/0/values/0}",valueState:{path:"$filterField>/valueState",mode:"OneWay"},valueStateText:{path:"$filterField>/valueStateText",mode:"OneWay"},items:[new sap.ui.core.Item({key:"",text:""}),new sap.ui.core.Item({key:false,text:this._getDataType().formatValue(false,"string")}),new sap.ui.core.Item({key:true,text:this._getDataType().formatValue(true,"string")})]});}else if(this.getProperty("dataType").indexOf(".Time")>-1&&this.getMaxConditions()===1){o=new sap.m.TimePicker(this.getId()+"-inner",{editable:{path:"$filterField>editMode",formatter:k},enabled:{path:"$filterField>editMode",formatter:m},width:"{$filterField>width}",required:"{$filterField>required}",value:{path:"$filterField>conditions/0/values/0",type:this._getDataType(),mode:"OneWay"},valueState:{path:"$filterField>/valueState",mode:"OneWay"},valueStateText:{path:"$filterField>/valueStateText",mode:"OneWay"}});}else if(this.getProperty("dataType").indexOf("Date")>-1&&this.getMaxConditions()===1){o=new sap.m.DatePicker(this.getId()+"-inner",{editable:{path:"$filterField>editMode",formatter:k},enabled:{path:"$filterField>editMode",formatter:m},width:"{$filterField>width}",required:"{$filterField>required}",value:{path:"$filterField>conditions/0/values/0",type:this._getDataType(),mode:"OneWay"},valueState:{path:"$filterField>/valueState",mode:"OneWay"},valueStateText:{path:"$filterField>/valueStateText",mode:"OneWay"}});}else if(this.getProperty("dataType").indexOf("Date")>-1&&this.getMaxConditions()===2){o=new sap.m.DateRangeSelection(this.getId()+"-inner",{editable:{path:"$filterField>editMode",formatter:k},enabled:{path:"$filterField>editMode",formatter:m},width:"{$filterField>width}",required:"{$filterField>required}",value:{parts:[{path:"$filterField>conditions/0/values/0",type:this._getDataType()},{path:"$filterField>conditions/0/values/1",type:this._getDataType()}],mode:"OneWay",type:"sap.ui.mdc.base.type.DateRange"},valueState:{path:"$filterField>/valueState",mode:"OneWay"},valueStateText:{path:"$filterField>/valueStateText",mode:"OneWay"}});}else{var t={};t.path="conditions";t.model="$filterField";t.template=new T({text:{path:'$filterField>',formatter:j.bind(this)},tooltip:{path:'$filterField>',formatter:j.bind(this)}});t.templateShareable=false;o=new M(this.getId()+"-inner",{tokens:t,editable:{path:"$filterField>editMode",formatter:k},enabled:{path:"$filterField>editMode",formatter:m},width:"{$filterField>width}",required:"{$filterField>required}",placeholder:"{$filterField>placeholder}",enableMultiLineMode:true,showSuggestion:false,valueState:{path:"$filterField>/valueState",mode:"OneWay"},valueStateText:{path:"$filterField>/valueStateText",mode:"OneWay"},showValueHelp:"{$filterField>showValueHelp}"});o._tokenizer.updateTokens=function(){this.updateAggregation("tokens");};o.attachTokenUpdate(this._handleTokenUpdate,this);o.attachValueHelpRequest(this._fireValueHelpRequest,this);o.attachLiveChange(this._handleLiveChange,this);o.onpaste=this._paste.bind(this);o.updateTokens=null;}if(o.attachChange){o.attachChange(this._handleTokenUpdate,this);}this.setAggregation("_input",o);this._input=o;this._activateManagedObjectModel();}return this.getAggregation("_input");};e.prototype._paste=function(o){var s,n=o.srcControl;if(window.clipboardData){s=window.clipboardData.getData("Text");}else{s=o.originalEvent.clipboardData.getData('text/plain');}var p=s.split(/\r\n|\r|\n/g);if(p&&p.length>1){setTimeout(function(){var t=this._getDataType(),r=t.getMetadata().getName();var u=p.length;for(var i=0;i<u;i++){if(p[i]){var v=p[i];var V=v.split(/\t/g);var w,x;if(V.length==2&&V[0]&&V[1]){w="BT";x=this.getFilterOperatorConfig().getOperator(w);}else{V=[v.trim()];w=this.getFilterOperatorConfig().getDefaultOperator(r);x=this.getFilterOperatorConfig().getOperator(w);}v=x?x.format(V):V[0];if(x){var y=x.getCondition(v,t);if(y){y.fieldPath=this.getFieldPath();this.setConditions(this.getConditions().push(y));this.fireChange({value:y,type:"added",valid:true});}}}}if(n instanceof sap.m.MultiInput){n.setValue("");}}.bind(this),0);}};function k(s){if(s&&s==E.Editable){return true;}else{return false;}}function m(s){if(s&&s!=E.Disabled){return true;}else{return false;}}e.prototype._handleLiveChange=function(o){var v;var i=false;if("value"in o.getParameters()){v=o.getParameter("value");}if("escPressed"in o.getParameters()){i=o.getParameter("escPressed");}var n=this.getFieldHelp();if(n){n.setFilterValue(v);if(n.openByTyping()){n.setConditions([]);n.open();}}this.fireLiveChange({value:v,escPressed:i});};e.prototype.getContent=function(){if(!this.getAggregation("content")){return this._getDefaultInput();}return this.getAggregation("content");};e.prototype.clone=function(){var o;if(this._input){this._input.detachChange(this._handleTokenUpdate,this);if(this._input.detachTokenUpdate){this._input.detachTokenUpdate(this._handleTokenUpdate,this);}if(this._input.detachValueHelpRequest){this._input.detachValueHelpRequest(this._fireValueHelpRequest,this);}o=C.prototype.clone.apply(this,arguments);this._input.attachChange(this._handleTokenUpdate,this);if(this._input.attachTokenUpdate){this._input.attachTokenUpdate(this._handleTokenUpdate,this);}if(this._input.attachValueHelpRequest){this._input.attachValueHelpRequest(this._fireValueHelpRequest,this);}var i=o.getAggregation("_input");i.attachChange(o._handleTokenUpdate,o);if(i.attachTokenUpdate){i.attachTokenUpdate(o._handleTokenUpdate,o);}if(i.attachValueHelpRequest){i.attachValueHelpRequest(o._fireValueHelpRequest,o);}}return o;};e.prototype.setContent=function(o){this._deactivateManagedObjectModel();this.setAggregation("content",o);this._activateManagedObjectModel();return this;};e.prototype.destroyContent=function(){this._deactivateManagedObjectModel();this.destroyAggregation("content");this._activateManagedObjectModel();return this;};e.prototype._updateConditionModel=function(o){var B=this.getBinding("conditions");if(B&&o.getParameter("resolvedPath").indexOf("/conditions")===0){B.getModel().checkUpdate(true,true);}};e.prototype._activateManagedObjectModel=function(){var o=this.getContent();if(o){if(!this._oManagedObjectModel){this._oManagedObjectModel=new b(this);this._oManagedObjectModel.setSizeLimit(1000);this._oManagedObjectModel.attachEvent("propertyChange",this._updateConditionModel.bind(this));}o.setModel(this._oManagedObjectModel,"$filterField");o.bindElement({path:"/",model:"$filterField"});}};e.prototype._deactivateManagedObjectModel=function(){var o=this.getContent();if(o){o.unbindElement("$filterField");this._oManagedObjectModel.destroy();this._oManagedObjectModel=null;}};e.prototype.setParent=function(){C.prototype.setParent.apply(this,arguments);if(!this.getParent()){this._deactivateManagedObjectModel();}else{this._activateManagedObjectModel();}};e.prototype.setDataType=function(v){delete this._oDataType;this.setProperty("dataType",v,true);return this;};e.mapEdmTypes={"Edm.Boolean":"sap.ui.model.odata.type.Boolean","Edm.Byte":"sap.ui.model.odata.type.Byte","Edm.Date":"sap.ui.model.odata.type.Date","Edm.DateTime":"sap.ui.model.odata.type.DateTime","Edm.DateTimeOffset":"sap.ui.model.odata.type.DateTimeOffset","Edm.Decimal":"sap.ui.model.odata.type.Decimal","Edm.Double":"sap.ui.model.odata.type.Double","Edm.Single":"sap.ui.model.odata.type.Single","Edm.Guid":"sap.ui.model.odata.type.Guid","Edm.Int16":"sap.ui.model.odata.type.Int16","Edm.Int32":"sap.ui.model.odata.type.Int32","Edm.Int64":"sap.ui.model.odata.type.Int64","Edm.SByte":"sap.ui.model.odata.type.SByte","Edm.String":"sap.ui.model.odata.type.String","Edm.Time":"sap.ui.model.odata.type.Time","Edm.TimeOfDay":"sap.ui.model.odata.type.TimeOfDay"};e.prototype._createDataType=function(t){var i=O.get(t||"");if(!i){var o=this.getFilterOperatorConfig(),n;if(o){n=o.getParentType(t);}else{n=e.mapEdmTypes[t];}if(!n){L.error("FilterField","dataType for "+t+" can not be created!");return null;}return this._createDataType(n);}return new i(this.getDataTypeFormatOptions(),this.getDataTypeConstraints());};e.prototype._getDataType=function(t){if(!this._oDataType){this._oDataType=this.getProperty("dataType");if(typeof this._oDataType==="string"){this._oDataType=this._createDataType(this._oDataType);}}return this._oDataType;};return e;},true);
