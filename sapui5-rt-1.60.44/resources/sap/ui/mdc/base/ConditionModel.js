/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2018 SAP SE. All rights reserved
	
 */
sap.ui.define(['./ConditionModelPropertyBinding','sap/ui/model/json/JSONModel','sap/ui/model/Filter','sap/ui/model/ChangeReason','sap/ui/mdc/base/FilterOperatorConfig','sap/base/util/merge','sap/base/util/deepEqual','sap/base/Log'],function(C,J,F,c,d,m,e,L){"use strict";var f=J.extend("sap.ui.mdc.base.ConditionModel",{constructor:function(){J.apply(this,arguments);this.setSizeLimit(1000);this._oMessageBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");sap.ui.getCore().attachLocalizationChanged(function(){this._oMessageBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");}.bind(this));if(!this.getProperty("/conditions")){this.setProperty("/conditions",{});}if(!this.getProperty("/fieldPath")){this.setProperty("/fieldPath",{});}this._mFieldPath={};}});f.prototype.bindProperty=function(p,o,P){if(p.startsWith("/conditions/")){var s=p.slice(12);s=h.call(this,s);p="/conditions/"+s;}var b=new C(this,p,o,P);return b;};f.prototype.getContext=function(p){if(p.startsWith("/conditions/")){var s=p.slice(12);s=h.call(this,s);p="/conditions/"+s;}return J.prototype.getContext.apply(this,[p]);};f.prototype.bindList=function(p,o,s,a,P){var b=J.prototype.bindList.apply(this,arguments);b.enableExtendedChangeDetection(true);return b;};f._mModels={};f.prototype.destroy=function(){if(this._oListBinding){delete f._mModels[f._createKey(this._oListBinding,this._sName)];this._oListBinding=undefined;this._sName=undefined;}J.prototype.destroy.apply(this,arguments);delete this._mFieldPath;delete this._oMessageBundle;};f.prototype.clone=function(s){var o=new f();o._oListBinding=this._oListBinding;var a=this.getFilterField(s);if(a){o.addFilterField(a);}else{L.error("ConditionModel","clone of ConditionModel for fieldPath '"+s+"' failed!");return o;}var b=this.getConditions(s);var j={};for(var i=0;i<b.length;i++){var k=b[i];var M=h.call(this,k.fieldPath);if(!j[M]){j[M]=[];}j[M].push(m({},k));}o.setConditions(j);return o;};f.prototype.merge=function(s,o,S){this.removeAllConditions(s);var a=f.removeEmptyConditions(o.getConditions(S));for(var i=0;i<a.length;i++){var b=a[i];this.addCondition(b.fieldPath,b);}this.checkUpdate(true,true);};f.removeEmptyConditions=function(a){for(var i=a.length-1;i>-1;i--){if(a[i].isEmpty){a.splice(parseInt(i,10),1);}}return a;};f.getFor=function(l,n){var k=f._createKey(l,n);var o=f._mModels[k];if(!o){o=new f();o._oListBinding=l;o._sName=n;f._mModels[k]=o;}else if(o._oListBinding!==l){o._oListBinding=l;o._sName=n;}return o;};f._createKey=function(l,n){return l.getModel().getId()+"--"+l.getPath()+"#"+(n===undefined?"":n);};f.prototype.setFor=function(l,n){delete f._mModels[f._createKey(this._oListBinding,n)];this._oListBinding=l;this._sName=n;f._mModels[f._createKey(this._oListBinding,n)]=this;return this;};f.destroyCM=function(o,n){o.destroy();};f._getAll=function(l){var o=[];var k=f._createKey(l);k=k.slice(0,k.length-1);for(var a in f._mModels){if(a.indexOf(k)===0){var b=f._mModels[a];o.push(b);}}return o;};f._getAllKeys=function(l){var o=[];var k=f._createKey(l);k=k.slice(0,k.length-1);for(var a in f._mModels){if(a.indexOf(k)===0){o.push(a);}}return o;};f.prototype.getConditions=function(s){return _.call(this,s);};function _(s,b){var o=this.getProperty("/conditions");var a;if(typeof s=="string"){s=h.call(this,s);if(!o[s]&&b){o[s]=[];}a=o[s]||[];}else{a=[];for(var M in o){for(var i=0;i<o[M].length;i++){var j=o[M][i];a.push(j);}}}return a;}function g(o){if(o.hasOwnProperty("fieldPath")){return o.fieldPath;}return false;}f.prototype.indexOf=function(s,o){if(typeof s==="object"&&!o){o=s;s=g.call(this,o);}if(typeof s!=="string"){throw new Error("sFieldPath must be a string "+this);}var I=-1;var a=this.getConditions(s);var b=JSON.stringify(o,['fieldPath','operator','values']);a.some(function(o,i){if(JSON.stringify(o,['fieldPath','operator','values'])===b){I=i;return true;}return false;});return I;};f.prototype.exist=function(o,s){if(s){return this.indexOf(s,o)>=0;}else{return this.indexOf(o)>=0;}};f.prototype.setConditions=function(o){var i=0;var a;this.setProperty("/conditions",{});if(Array.isArray(o)){for(i=0;i<o.length;i++){a=o[i];this.insertCondition(a.fieldPath,-1,a,true);}}else{this._bNoSingleEvent=true;for(var M in o){for(i=0;i<o[M].length;i++){a=o[M][i];this.insertCondition(M,-1,a,true);}M=h.call(this,M);this.firePropertyChange({reason:c.Add,path:"/conditions/"+M,context:undefined,value:o[M]});}this.checkUpdate(true,true);this._bNoSingleEvent=false;}return this;};f.prototype.addCondition=function(s,o,b){if(typeof s==="object"){b=o;o=s;s=g.call(this,o);}return this.insertCondition(s,-1,o,b);};f.prototype.insertCondition=function(s,I,o,b){if(typeof s==="number"&&typeof I!=="number"){o=I;b=o;I=s;s=g.call(this,o);}if(typeof s!=="string"){throw new Error("sFieldPath must be a string "+this);}var a;this._checkIsEmpty(o);this._updateValues(o);if(!b){var i=this.indexOf(s,o);if(i>=0){return this;}}a=_.call(this,s,true);if(I==-1){a.push(o);}else{a.splice(I,0,o);}this._checkMaxConditions(s);if(!this._bNoSingleEvent){this.checkUpdate(true,true);s=h.call(this,s);this.firePropertyChange({reason:c.Add,path:"/conditions/"+s,context:undefined,value:a});}return this;};f.prototype.createItemCondition=function(s,k,D){var v=[k,D];if(D===null||D===undefined){v.pop();}return this.createCondition(s,"EEQ",v);};f.prototype.createCondition=function(s,o,v){var a={fieldPath:s,operator:o,values:v};this._checkIsEmpty(a);this._updateValues(a);return a;};f.prototype.removeCondition=function(s,v){if(typeof s==="object"&&!v){v=s;s=g.call(this,v);}var i=-1;if(typeof v==="object"){i=this.indexOf(s,v);}else if(typeof v==="number"){i=v;}if(typeof s!=="string"){throw new Error("sFieldPath must be a string "+this);}var a=this.getConditions(s);if(a.length>i){a.splice(i,1);this.checkUpdate(true,true);this._checkMaxConditions(s);s=h.call(this,s);this.firePropertyChange({reason:c.Remove,path:"/conditions/"+s,context:undefined,value:a});return true;}return false;};f.prototype.removeAllConditions=function(s){var o=this.getProperty("/conditions");if(s){s=h.call(this,s);delete o[s];s=h.call(this,s);this.firePropertyChange({reason:c.Remove,path:"/conditions/"+s,context:undefined,value:o[s]});}else{for(var M in o){delete o[M];M=h.call(this,M);this.firePropertyChange({reason:c.Remove,path:"/conditions/"+M,context:undefined,value:o[M]});}}this.checkUpdate(true,true);return this;};f.prototype.deleteConditions=function(o,B){var s;if(!o||!B){return;}if(!Array.isArray(o)){o=[o];}var D=B.oModel.getProperty(B.getPath(),B.getContext())||[];if(Array.isArray(o)&&D.length>0){var I=[],k,i,n;if(Array.isArray(D)){for(i=0;i<o.length;i++){for(var j=0;j<D.length;j++){if(e(D[j],o[i].getProperty())){I.push(j);break;}}}I.sort(function(a,b){return a-b;});k=function(a){s=D[a].fieldPath;D.splice(a,1);};}else if(typeof D==="object"){for(n in D){var l=o[i].getPath();l=l.substring(o[i].getPath().lastIndexOf("/")+1);I.push(n);}k=function(l){delete D[l];};}for(i=I.length-1;i>-1;i--){k(I[i]);}}B.getModel().checkUpdate(true,true);this._checkMaxConditions(s);};f.prototype._checkIsEmpty=function(a){var o=this.getFilterOperatorConfig();a=a||this.getConditions();if(!Array.isArray(a)){a=[a];}a.forEach(function(b){var O=o.getOperator(b.operator);b.isEmpty=O.isEmpty(b);});};f.prototype._updateValues=function(a){var o=this.getFilterOperatorConfig();a=a||this.getConditions();if(!Array.isArray(a)){a=[a];}a.forEach(function(b){var O=o.getOperator(b.operator);if(b.operator!=="EEQ"){while(b.values.length!=O.valueTypes.length){if(b.values.length<O.valueTypes.length){b.values.push(null);}if(b.values.length>O.valueTypes.length){b.values=b.values.slice(0,b.values.length-1);}}}});};f.prototype._checkRequiredConditions=function(s,a){var b=a?[a]:Object.keys(this._mFieldPath||{});var E=false;var M=this._oMessageBundle.getText("conditionmodel.REQUIRED_CONDITION_MISSING");b.forEach(function(a){if(this._mFieldPath&&this._mFieldPath[a]){var o=this._mFieldPath[a];if(o.getRequired()&&this.getConditions(a).length<=0){if(s){this.addFieldPathMessage(a,M);}E=true;}else{this.removeFieldPathMessage(a,M);}}},this);return!E;};f.prototype._checkMaxConditions=function(s){var a=s?[s]:Object.keys(this._mFieldPath||{});var E=false;var S=false;if(S){var M=this._oMessageBundle.getText("conditionmodel.TOO_MANY_CONDITIONS");a.forEach(function(s){if(this._mFieldPath&&this._mFieldPath[s]){var o=this._mFieldPath[s];if(o.getMaxConditions()>=0&&this.getConditions(s).length>o.getMaxConditions()){this.addFieldPathMessage(s,M);E=true;}else{this.removeFieldPathMessage(s,M);}}},this);}else{a.forEach(function(s){if(this._mFieldPath&&this._mFieldPath[s]){var o=this._mFieldPath[s];var b=this.getConditions(s);var l=0;for(var i=0;i<b.length;i++){if(!b[i].isEmpty){l++;}}while(o.getMaxConditions()>=0&&l>o.getMaxConditions()){this.removeCondition(s,0);l--;E=false;}}},this);}return E;};f.prototype.addFilterField=function(o){var s=o.getFieldPath();this._mFieldPath[s]=o;this._getFieldPathProperty(s);};f.prototype.getFilterField=function(s){var a=Object.keys(this._mFieldPath||{});return this._mFieldPath[s||a[0]];};f.prototype.getFilterFields=function(){var a=Object.keys(this._mFieldPath||{});var b=[];a.forEach(function(s){b.push(this._mFieldPath[s]);},this);return b;};f.prototype.removeFilterField=function(o){var s=o.getFieldPath();if(this._mFieldPath&&this._mFieldPath[s]){delete this._mFieldPath[s];}var a=this.getProperty("/fieldPath");if(a&&a[s]){delete a[s];}};f.prototype._getFieldPathProperty=function(s){var o=this.getProperty("/fieldPath");if(!o[s]){o[s]={valueState:"None",valueStateText:"",messages:[]};}return o[s];};f.prototype.addFieldPathMessage=function(s,M){var o=this._getFieldPathProperty(s);if(!o.messages.some(function(I,i){if(I===M){return true;}return false;})){o.messages.push(M);}this._updateValueState(s);};f.prototype.setUIMessage=function(s,M){var o=this._getFieldPathProperty(s);o.uiMessage=M;this._updateValueState(s);};f.prototype.removeFieldPathMessage=function(s,M){var I;var o=this._getFieldPathProperty(s);if(o.messages.some(function(a,i){if(a===M){I=i;return true;}return false;})){o.messages.splice(I,1);}this._updateValueState(s);};f.prototype.removeUIMessage=function(s){var o=this._getFieldPathProperty(s);delete o.uiMessage;this._updateValueState(s);};f.prototype._updateValueState=function(s){var u=false,o=this._getFieldPathProperty(s),v="None",V="";if(o.uiMessage){v="Error";V=o.uiMessage;}else if(o.messages.length>0){v="Error";V=o.messages[o.messages.length-1];}if(o.valueState!==v){o.valueState=v;u=true;}if(o.valueStateText!==V){o.valueStateText=V;u=true;}if(u){this.checkUpdate(true,true);}};f.prototype.isValid=function(v,s){var a=s?[s]:Object.keys(this._mFieldPath||{});var V=this._checkRequiredConditions(v);a.forEach(function(s){var o=this._getFieldPathProperty(s);V=V&&o.valueState=="None";},this);return V;};f.prototype.applyFilters=function(v,a){if(this.isValid(v)){if(this._oListBinding.changeParameters){if(this.getConditions("$search").length){var V=this.getConditions("$search")[0].values[0];this._oListBinding.changeParameters({$search:V});}else{this._oListBinding.changeParameters({$search:undefined});}}var o;if(a){o=this.getAllFilters();}else{o=this.getFilters();}if(o){this._oListBinding.filter(o);}else{this._oListBinding.filter();}if(o){window.console.log("CM-Filter:"+this._prettyPrintFilters(o));}return true;}return false;};f.prototype.getAllFilters=function(){var o=f._getAll(this._oListBinding);var O=[];o.forEach(function(b){var a=b.getFilters();if(a){O.push(a);}});var a=null;if(O.length===1){a=O[0];}else if(O.length>1){a=new F({filters:O,and:true});}return a;};f.prototype._prettyPrintFilters=function(o){var r;if(!o){return"";}if(o._bMultiFilter){r="";var a=o.bAnd;o.aFilters.forEach(function(o,i,b){r+=this._prettyPrintFilters(o);if(b.length-1!=i){r+=a?" and ":" or ";}},this);return"("+r+")";}else{r=o.sPath+" "+o.sOperator+" '"+o.oValue1+"'";if(o.sOperator==="BT"){r+="...'"+o.oValue2+"'";}return r;}};f.prototype.getFilterOperatorConfig=function(){var M=this._oListBinding&&this._oListBinding.getModel();return d.getFor(M);};f.prototype.getFilters=function(s){var i,l,a,o=[],b,t,S,n,p;var k=this.getFilterOperatorConfig();var q={};if(s===undefined){b=this.getConditions();}else if(typeof s==="string"){b=this.getConditions(s);}else{b=s||[];}for(i=0;i<b.length;i++){q[b[i].fieldPath]=true;}var O,r;for(var u in q){l=[];a=[];t=null;for(i=0;i<b.length;i++){if(b[i].fieldPath===u){O=k.getOperator(b[i].operator);r=O.getModelFilter(b[i]);if(!(O.exclude&&b[i].operator==="NE")){if(r.sPath==="$search"){continue;}var $=/^\*(.+)\*$/.exec(r.sPath);if($){var v=$[1].split(',');for(var j=0;j<v.length;j++){l.push(new F(v[j],r.sOperator,r.oValue1));}continue;}if(r.sPath.indexOf('*/')>-1){S=r.sPath.split('*/');if(S.length===2){n=S[0];p=S[1];r.sPath='L1/'+p;if(!t){t={path:n,operator:'Any',variable:'L1'};}l.push(r);}else{throw new Error("Not Implemented");}}else{l.push(r);}}}}for(i=0;i<b.length;i++){if(b[i].fieldPath===u){O=k.getOperator(b[i].operator);r=O.getModelFilter(b[i]);if(O.exclude&&b[i].operator==="NE"){a.push(r);}}}if(t){if(l.length===1){t.condition=l[0];}else if(l.length>1){t.condition=new F({filters:l,and:false});}l=[new F(t)];}if(l.length===1){o.push(l[0]);}else if(l.length>1){o.push(new F({filters:l,and:false}));}if(a.length===1){o.push(a[0]);}else if(a.length>1){o=o.merge(a);}}if(o.length===1){return o[0];}else if(o.length>1){return new F({filters:o,and:true});}else{return null;}};f.prototype.serialize=function(){var a=m([],this.getConditions());a.forEach(function(o){delete o.isEmpty;},this);return'{"conditions":'+JSON.stringify(a)+"}";};f.prototype.serializeMeta=function(){var a=Object.keys(this._mFieldPath||{});var r="";a.forEach(function(s){if(this.getData().fieldPath[s].valueState!=="None"){r+=JSON.stringify(this.getData().fieldPath[s]);}},this);return'{"fieldPath":'+r+"}";};f.prototype.parse=function(o){var b=function(k,v){var a;if(!isNaN(parseInt(k,10))&&(typeof v==='string')){a=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2}).(\d{3})Z$/.exec(v);if(a){return new Date(v);}}return v;};this.setConditions(JSON.parse(o,b).conditions);};f.serialize=function(l){var o=f._getAllKeys(l);var r="";o.forEach(function(a){var b=f._mModels[a];if(b.getConditions()&&b.getConditions().length>0){r+=">>>"+a+"<<<";r+=b.serialize();}});return r;};f.serializeMeta=function(l){var o=f._getAllKeys(l);var r="";o.forEach(function(a){var b=f._mModels[a];r+=b.serializeMeta();});return r;};f.parse=function(o){var a=o.split(">>>");a.forEach(function(s){var p=s.split("<<<");if(p.length>1){if(f._mModels[p[0]]){f._mModels[p[0]].parse(p[1]);}else{var b=new f();b.parse(p[1]);f._mModels[p[0]]=b;}}});};function h(s){if(s){var p=s.split("/");if(p.length>1){s="";for(var i=0;i<p.length;i++){var P=p[i];if(i>0){if(!isNaN(P)||!isNaN(p[i-1])){s=s+"/";}else{s=s+"_";}}s=s+P;}}}return s;}return f;},true);
