/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(["jquery.sap.global","sap/ovp/cards/CommonUtils","sap/ovp/cards/SettingsUtils","sap/ui/dt/plugin/ElementMover","sap/ui/dt/OverlayRegistry",'sap/ui/dt/OverlayUtil','sap/ui/rta/plugin/Plugin','sap/ui/rta/util/BindingsExtractor','sap/ui/dt/MetadataPropagationUtil','sap/ui/rta/Utils',"sap/ovp/app/resources"],function(q,C,S,E,O,a,P,B,M,U,b){"use strict";var A=C.getApp();var _=function(){var u=q.sap.getUriParameters();var m=u.mParams["sap-ui-layer"];return m&&m[0];};var i=false;var c=function(){var u="https://"+window.location.host+"/sap/opu/odata/SSB/SMART_BUSINESS_DESIGNTIME_SRV/KPIs";q.ajax({type:"GET",url:u,dataType:"json",async:false,headers:"",success:function(m,t,n){var D={'d':{'results':[]}};D.d.results=m.d.results.filter(function(K){return!!K.ModelURI;});i=(D.d.results.length>0);if(i){var p=new sap.ui.model.json.JSONModel();p.setData(D);A.getView().setModel(p,"JSONModelForSSB");}},error:function(m){q.sap.log.error(m);}});};c();var e=new E(),d=function(m){m.setTargetZone(false);},f=function(m){m.setTargetZone(true);},g=function(t){var m=t.getAggregationOverlays();var p=m.filter(function(n){return n.isTargetZone();});if(p.length>0){return p[0];}else{return null;}},h=function(t){var m=e.getMovedOverlay();if(!m){return false;}var r=false;if(!(t.getElement()===m.getElement())){var T=g(t);if(T){r=true;}else if(a.isInTargetZoneAggregation(t)){r=true;}}if(r){m.setSelected(true);setTimeout(function(){m.focus();},0);}return r;},j=function(m,s){var n=m.getAggregationOverlays();n.forEach(function(p){s(p);});},k=function(s,m){var n=O.getOverlay(s),p=n.getParentElementOverlay(),r=a.findAllSiblingOverlaysInContainer(n,p);r.forEach(function(t){j(t,m);});};var l=E.prototype.checkTargetZone;E.prototype.checkTargetZone=function(m,n,p){var r=n?n:this.getMovedOverlay();var t=l.apply(this,arguments);if(!t){return false;}var s=r.getElement();var T=m.getParent();var u=r.getRelevantContainer();var v=T.getElement();var w=m.getDesignTimeMetadata();var x=M.getRelevantContainerForPropagation(w.getData(),s);x=x?x:v;if(!u||!x||!P.prototype.hasStableId(T)||u!==x){return false;}if(r.getParent().getElement()!==v){var y=B.getBindings(s,s.getModel());if(Object.keys(y).length>0&&s.getBindingContext()&&v.getBindingContext()){var z=U.getEntityTypeByPath(s.getModel(),s.getBindingContext().getPath());var D=U.getEntityTypeByPath(v.getModel(),v.getBindingContext().getPath());if(!(z===D)){return false;}}}return true;};E.prototype.deactivateAllTargetZones=function(s){k(s,d);};E.prototype.activateAllValidTargetZones=function(s){k(s,f);};var o={name:{singular:b.getText("Card"),plural:b.getText("Cards")},actions:{remove:{name:b.getText("OVP_KEYUSER_MENU_HIDE_CARD"),changeType:"hideCardContainer",changeOnRelevantContainer:true},reveal:{changeType:"unhideCardContainer",changeOnRelevantContainer:true,getLabel:function(m){var s=this._getCardId(m.getId()),n=this._getCardFromManifest(s);if(n){var p=n.settings;if(p.title){return p.title;}else if(p.category){return(p.category);}else if(p.subTitle){return p.subTitle;}return n.cardId;}else{q.sap.log.error("Card id "+s+" is not present in the manifest");return"";}}.bind(A)}}};var L=_();if(!L||L==="CUSTOMER"){o.actions["settings"]=function(){var s={"Cut":{icon:"sap-icon://scissors",name:b.getText("OVP_KEYUSER_MENU_CUT_CARD"),isEnabled:function(m){return true;},changeOnRelevantContainer:true,handler:function(m,G){var n=O.getOverlay(m),p=e.getMovedOverlay();if(p){p.removeStyleClass("sapUiDtOverlayCutted");e.setMovedOverlay(null);e.deactivateAllTargetZones(m);}e.setMovedOverlay(n);n.addStyleClass("sapUiDtOverlayCutted");e.activateAllValidTargetZones(m);return Promise.resolve([]).then(function(){return[];});}},"Paste":{icon:"sap-icon://paste",name:b.getText("OVP_KEYUSER_MENU_PASTE_CARD"),isEnabled:function(m){var n=O.getOverlay(m),t=g(n);return!!((t)||(a.isInTargetZoneAggregation(n)));},changeOnRelevantContainer:true,handler:function(m,G){var n=O.getOverlay(m),p=e.getMovedOverlay();if(p){var r=p.getElement(),t=n.getElement(),u=a.getParentInformation(p),T=a.getParentInformation(n),v=m.getComponentInstance().getComponentData().mainComponent,w=v.getLayout(),x=v.getUIModel(),y={},z={},D=[];if(x.getProperty('/containerLayout')==='resizable'){var F=w.getDashboardLayoutModel(),H=v._getCardId(r.getId()),I=v._getCardId(m.getId()),J=F.getCardById(H),K=F.getCardById(I),N=F.getColCount(),Q='C'+N,R=[];y.cardId=H;y.dashboardLayout={};y.dashboardLayout[Q]={row:K.dashboardLayout.row,oldRow:J.dashboardLayout.row,column:K.dashboardLayout.column,oldColumn:J.dashboardLayout.column};if(K.dashboardLayout.column+J.dashboardLayout.colSpan>N+1){y.dashboardLayout[Q].colSpan=K.dashboardLayout.colSpan;y.dashboardLayout[Q].oldColSpan=J.dashboardLayout.colSpan;y.dashboardLayout[Q].rowSpan=J.dashboardLayout.rowSpan;y.dashboardLayout[Q].oldRowSpan=J.dashboardLayout.rowSpan;}D.push({selectorControl:m.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:y}});D.push({selectorControl:m.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"dragAndDropUI",content:y}});F._arrangeCards(J,{row:K.dashboardLayout.row,column:K.dashboardLayout.column},'drag',R);F._removeSpaceBeforeCard(R);R.forEach(function(W){var X={};X.dashboardLayout={};X.cardId=W.content.cardId;X.dashboardLayout[Q]=W.content.dashboardLayout;D.push({selectorControl:m.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"dragOrResize",content:X}});});}else{var V=T.parent.getContent().filter(function(W){return W.getVisible();});y={cardId:v._getCardId(r.getId()),position:V.indexOf(t),oldPosition:V.indexOf(r)};D.push({selectorControl:m.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{changeType:"position",content:y}});z={cardId:v._getCardId(r.getId()),position:T.index,oldPosition:u.index};D.push({selectorControl:m.getComponentInstance().getComponentData().appComponent.getRootControl().getController().getLayout(),changeSpecificData:{runtimeOnly:true,changeType:"dragAndDropUI",content:z}});}}h(n);if(p){p.removeStyleClass("sapUiDtOverlayCutted");e.setMovedOverlay(null);e.deactivateAllTargetZones(m);return Promise.resolve(D).then(function(W){return W;});}}},"EditCard":{icon:"sap-icon://edit",name:b.getText("OVP_KEYUSER_MENU_EDIT_CARD"),isEnabled:function(m){return true;},changeOnRelevantContainer:true,handler:S.fnEditCardHandler},"CloneCard":{icon:"sap-icon://value-help",name:b.getText("OVP_KEYUSER_MENU_CLONE_CARD"),isEnabled:function(m){return true;},handler:S.fnCloneCardHandler},"AddStaticLinkListCard":{icon:"sap-icon://form",name:b.getText("OVP_KEYUSER_MENU_CREATE_LINK_LIST_CARD"),isEnabled:function(m){return true;},handler:S.fnAddStaticLinkListCardHandler}};if(i){s["AddKPICard"]={icon:"sap-icon://kpi-corporate-performance",name:"Add KPI Card",isEnabled:function(m){return true;},handler:S.fnAddKPICardHandler};}s["RemoveCard"]={icon:"sap-icon://delete",name:b.getText("OVP_KEYUSER_MENU_REMOVE_CARD"),isEnabled:function(m){var s=m.getComponentInstance().getComponentData().settings;return m.getId().indexOf("customer.")!==-1&&!s.cloneCard&&!s.newCard;},handler:S.fnRemoveCardHandler};return s;};}return o;},true);
