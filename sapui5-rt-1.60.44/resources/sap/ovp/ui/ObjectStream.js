/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2014 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["jquery.sap.global","sap/ui/Device","sap/ui/core/Control","sap/ui/core/Icon","sap/m/Dialog","sap/ovp/app/resources"],function(q,D,C,I,a,O){"use strict";var _=null;var K=function(o){this.init(o);};K.prototype.init=function(o){this.objectStream=o;this.keyCodes=q.sap.KeyCodes;this.jqElement=o.$();this.jqElement.on('keydown.keyboardNavigation',this.keydownHandler.bind(this));this.jqElement.on("focus.keyboardNavigation",".sapOvpObjectStreamItem",this.ObjectStreamFocusAccessabilityHandler.bind(this));};K.prototype.destroy=function(){if(this.jqElement){this.jqElement.off(".keyboardNavigation");}delete this.jqElement;delete this.objectStream;};K.prototype._swapItemsFocus=function(e,j,c){e.preventDefault();j.attr("tabindex","-1");c.attr("tabindex","0").focus();};K.prototype.ObjectStreamFocusAccessabilityHandler=function(){var f=document.activeElement;f=q(f);if(f){var l=f.find("[aria-label]");var i,c="";for(i=0;i<l.length;i++){if(l[i].getAttribute("role")=="heading"){c+=l[i].id+" ";}}if(c.length){f.attr("aria-labelledby",c);}if(f.hasClass('sapOvpCardHeader')){f.closest('.sapOvpObjectStreamItem').removeAttr("aria-labelledby");}}};K.prototype.tabButtonHandler=function(e){var j=q(document.activeElement);if(j.hasClass("sapOvpObjectStreamItem")){return;}if(j.hasClass("sapOvpObjectStreamClose")){e.preventDefault();this.jqElement.find(".sapOvpObjectStreamItem:sapTabbable").focus();return;}var c=j.closest(".sapOvpObjectStreamItem");if(!c.length){return;}var d=c.find(":sapTabbable");if(d.eq(d.length-1).is(j)){e.preventDefault();this.jqElement.find("a.sapOvpObjectStreamHeader").focus();}};K.prototype.shiftTabButtonHandler=function(e){var j=q(document.activeElement);if(j.hasClass("sapOvpObjectStreamItem")){e.preventDefault();this.jqElement.find(".sapOvpObjectStreamClose").focus();}if(j.hasClass("sapOvpObjectStreamClose")){e.preventDefault();this.jqElement.find('a.sapOvpObjectStreamHeader').focus();}if(j.hasClass("sapOvpObjectStreamHeader")){e.preventDefault();this.jqElement.find(".sapOvpObjectStreamItem:sapTabbable *:sapTabbable").last().focus();return;}};K.prototype.enterHandler=function(e){var j=q(document.activeElement);if(j.hasClass("sapOvpObjectStreamClose")){e.preventDefault();this.objectStream.getParent().close();if(_){_.focus();}return;}if(j.hasClass("sapOvpObjectStreamItem")&&!j.next().length){j.children().click();return;}};K.prototype.f6Handler=function(e){var j=q(document.activeElement);if(j.hasClass("sapOvpObjectStreamClose")){this.jqElement.find('.sapOvpObjectStreamItem').attr("tabindex","-1").first().attr("tabindex","0").focus();}else{this.jqElement.find('.sapOvpObjectStreamClose').focus();}};K.prototype.f7Handler=function(e){var j=q(document.activeElement);if(j.hasClass("sapOvpObjectStreamItem")){j.find(':sapTabbable').first().focus();}else{j.closest('.sapOvpObjectStreamItem').focus();}e.preventDefault();};K.prototype.leftRightHandler=function(e,i){var n=i?"next":"prev";var j=q(document.activeElement);if(!j.hasClass("sapOvpObjectStreamItem")){return false;}var c=j[n]();if(!c.length){return;}this._swapItemsFocus(e,j,c);};K.prototype.homeEndHandler=function(e,i){var n=i?"first":"last";var j=q(document.activeElement);if(!j.hasClass("sapOvpObjectStreamItem")){return false;}e.preventDefault();var c=this.jqElement.find(".sapOvpObjectStreamItem")[n]();this._swapItemsFocus(e,j,c);};K.prototype.pageUpDownHandler=function(e,i){var n=i?"prev":"next";var j=q(document.activeElement);if(!j.hasClass("sapOvpObjectStreamItem")){return;}if(!j[n]().length){return;}var c=false;var d=j;var w=q(window).width();while(!c){var f=d[n]();if(!f.length){c=d;break;}if(!i&&f.offset().left>w){c=f;break;}if(i&&(f.offset().left+f.outerHeight())<=0){c=f;break;}d=f;}this._swapItemsFocus(e,j,c);};K.prototype.keydownHandler=function(e){switch(e.keyCode){case this.keyCodes.TAB:(e.shiftKey)?this.shiftTabButtonHandler(e):this.tabButtonHandler(e);break;case this.keyCodes.ENTER:case this.keyCodes.SPACE:this.enterHandler(e);break;case this.keyCodes.F6:this.f6Handler(e);break;case this.keyCodes.F7:this.f7Handler(e);break;case this.keyCodes.ARROW_UP:case this.keyCodes.ARROW_LEFT:this.leftRightHandler(e,false);break;case this.keyCodes.ARROW_DOWN:case this.keyCodes.ARROW_RIGHT:this.leftRightHandler(e,true);break;case this.keyCodes.HOME:this.homeEndHandler(e,true);break;case this.keyCodes.END:this.homeEndHandler(e,false);break;case this.keyCodes.PAGE_UP:this.pageUpDownHandler(e,true);break;case this.keyCodes.PAGE_DOWN:this.pageUpDownHandler(e,false);break;}};var b=C.extend("sap.ovp.ui.ObjectStream",{metadata:{library:"sap.ovp",aggregations:{content:{type:"sap.ui.core.Control",multiple:true},placeHolder:{type:"sap.ui.core.Control",multiple:false},title:{type:"sap.ui.core.Control",multiple:false}}}});b.prototype.init=function(){var t=this;this._closeIcon=new I({src:"sap-icon://decline",tooltip:O.getText("close")});this._closeIcon.addEventDelegate({onclick:function(){t.getParent().close();}});};b.prototype._startScroll=function(d){this._direction=d;var c=this.wrapper.scrollWidth-this.wrapper.offsetWidth-Math.abs(this.wrapper.scrollLeft);var l;if(d=="left"){l=(this.rtl&&!this.scrollReverse)?c:this.wrapper.scrollLeft;if(l<=0){return;}this.jqRightEdge.css("opacity",1);}else{l=(this.rtl&&!this.scrollReverse)?Math.abs(this.wrapper.scrollLeft):c;if(l<=0){return;}this.jqLeftEdge.css("opacity",1);}var e=l*3;var t=(d=="left")?l:~l+1;q(this.container).one("transitionend",function(){this._mouseLeave({data:this});}.bind(this));this.container.style.transition='transform '+e+'ms linear';this.container.style.transform='translate('+t+'px, 0px) scale(1) translateZ(0px) ';};b.prototype._mouseLeave=function(e){var c=window.getComputedStyle(e.data.container).transform;e.data.container.style.transform=c;e.data.container.style.transition='';this.rtl=sap.ui.getCore().getConfiguration().getRTL();var t;var d=c.split(",");if(c.substr(0,8)=="matrix3d"){t=parseInt(d[12],10);}else if(c.substr(0,6)=="matrix"){t=parseInt(d[4],10);}if(isNaN(t)){return;}e.data.container.style.transform="none";if(D.browser.msie){t=this.rtl?~t:t;}e.data.wrapper.scrollLeft+=~t+(e.data._direction=="left"?-5:5);e.data._checkEdgesVisibility();};var s;b.prototype.debounceScrollHandler=function(){window.clearTimeout(s);s=window.setTimeout(this._checkEdgesVisibility.bind(this),150);};b.prototype._initScrollVariables=function(){var j=this.$();this.container=j.find(".sapOvpObjectStreamScroll").get(0);this.rtl=sap.ui.getCore().getConfiguration().getRTL();this.wrapper=j.find(".sapOvpObjectStreamCont").get(0);this.scrollReverse=this.scrollReverse||this.wrapper.scrollLeft>0;this.shouldShowScrollButton=(!D.system.phone&&!D.system.tablet)||D.system.combi;this.jqRightEdge=j.find(".sapOvpOSEdgeRight");this.jqLeftEdge=j.find(".sapOvpOSEdgeLeft");if(this.shouldShowScrollButton){this.jqRightEdge.add(this.jqLeftEdge).on("mouseenter.objectStream",this,this._mouseEnter).on("mouseleave.objectStream",this,this._mouseLeave);q(this.wrapper).on("scroll.objectStream",this.debounceScrollHandler.bind(this));}else{this.jqLeftEdge.css("display","none");this.jqRightEdge.css("display","none");}this._checkEdgesVisibility();};b.prototype._afterOpen=function(){if(D.os.ios&&this.$().length){this.$().on("touchmove.scrollFix",function(e){e.stopPropagation();});}var o=this.$().find('a.sapOvpObjectStreamHeader');o.removeAttr('aria-describedby');o.removeAttr('href');var l=o.attr('id');o.parent('div').attr('aria-labelledby',l);o.focus();if(this.keyboardNavigation){this.keyboardNavigation.destroy();}this.keyboardNavigation=new K(this);this._initScrollVariables();this.jqBackground=q("<div id='objectStreamBackgroundId' class='objectStreamNoBackground'></div>");q.sap.byId("sap-ui-static").prepend(this.jqBackground);this.jqBackground.on('click.closePopup',function(){this._oPopup.close();}.bind(this));q(".sapUshellEasyScanLayout").addClass("bluredLayout");var c=this.$().find('.sapOvpObjectStreamItem');for(var i=0;i<c.length;i++){var f=q(c[i]).find('.sapOvpActionFooter');if(f.find('button').length==0){f.attr('tabindex','-1');}}};b.prototype._beforeClose=function(){if(D.os.ios&&this.$().length){this.$().off(".scrollFix");}this.keyboardNavigation.destroy();this.jqBackground.remove();this.jqLeftEdge.add(this.jqRightEdge).add(this.wrapper).off(".objectStream");q(".sapUshellEasyScanLayout").removeClass("bluredLayout");this._oPopup=undefined;};b.prototype._mouseEnter=function(e){var c='right';if((e.target==e.data.jqRightEdge.get(0))||(e.currentTarget==e.data.jqRightEdge.get(0))){c=sap.ui.getCore().getConfiguration().getRTL()?'left':'right';}if((e.target==e.data.jqLeftEdge.get(0))||(e.currentTarget==e.data.jqLeftEdge.get(0))){c=sap.ui.getCore().getConfiguration().getRTL()?'right':'left';}e.data._startScroll(c);};b.prototype._checkEdgesVisibility=function(){var c=this.wrapper.scrollLeft;var l=this.wrapper.scrollWidth-this.wrapper.offsetWidth-this.wrapper.scrollLeft;var d=(c==0)?0:1;var r=(l==0)?0:1;if(sap.ui.getCore().getConfiguration().getRTL()&&this.scrollReverse){this.jqLeftEdge.css("opacity",r);this.jqRightEdge.css("opacity",d);this.jqRightEdge.css("z-index",(d===0)?0:1);}else{this.jqLeftEdge.css("opacity",d);this.jqRightEdge.css("opacity",r);this.jqRightEdge.css("z-index",(r===0)?0:1);}};b.prototype._createPopup=function(){this._oPopup=new a({showHeader:false,afterOpen:this._afterOpen.bind(this),beforeClose:this._beforeClose.bind(this),content:[this],stretch:D.system.phone}).removeStyleClass("sapUiPopupWithPadding").addStyleClass("sapOvpStackedCardPopup");this._oPopup.oPopup.setModal(false);};b.prototype.open=function(c,d){if(!this._oPopup){this._createPopup();}this._cardWidth=c;_=d;this.setCardsSize(this._cardWidth);this._oPopup.open();};b.prototype.onBeforeRendering=function(){var c=this.getBinding("content");var p=this.getPlaceHolder();if(c&&c.getLength()<=20){this.setPlaceHolder(null);if(p){p.destroy();}}};b.prototype.onAfterRendering=function(){if(!this._oPopup||!this._oPopup.isOpen()||!this.getContent().length){return;}setTimeout(function(){this._initScrollVariables();}.bind(this));};b.prototype.exit=function(){if(this._oPopup){this._oPopup.destroy();}this._closeIcon.destroy();if(this._oScroller){this._oScroller.destroy();this._oScroller=null;}};b.prototype.setCardsSize=function(c){var r=parseInt(window.getComputedStyle(document.documentElement).fontSize,10);var d=D.system.phone?document.body.clientHeight/r-4.5:28.75;var e=this.getContent();e.map(function(o){o.setWidth(c+"px");o.setHeight(d+"rem");});var p=this.getPlaceHolder();if(p){p.setWidth(c+"px");p.setHeight(d+"rem");}};b.prototype.updateContent=function(r){var B=this.mBindingInfos["content"],o=B.binding,c=o.getContexts(B.startIndex,B.length);if(r==="change"){var f=B.factory,i=0,d=this.getContent(),e=q.proxy(function(g){var h=this.getId()+"-"+q.sap.uid(),j=f(h,g);j.setBindingContext(g,B.model);this.addContent(j);},this);for(i=0;i<c.length;++i){if(i<d.length){d[i].setBindingContext(c[i],B.model);}else{e(c[i]);}}if(d.length>c.length){for(;i<d.length;++i){d[i].destroy();}d.length=c.length;}}};return b;});
