sap.ui.define(["sap/ui/core/Control","jquery.sap.global","sap/ui/Device","sap/ui/core/ResizeHandler","sap/ovp/app/resources"],function(C,q,D,R,O){"use strict";var a=C.extend("sap.ovp.ui.DashboardLayout",{metadata:{designTime:true,library:"sap.ovp",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"}},defaultAggregation:"content",events:{afterRendering:{},afterDragEnds:{}},properties:{dragAndDropRootSelector:{group:"Misc",type:"string"},dragAndDropEnabled:{group:"Misc",type:"boolean",defaultValue:true},debounceTime:{group:"Misc",type:"int",defaultValue:150}}},renderer:{render:function(r,c){var b=c.$().width();var d=sap.ui.getCore().getConfiguration().getRTL();var l=c.dashboardLayoutUtil.updateLayoutData(b?b:q(window).width());var e=c.dashboardLayoutUtil.getCards(l.colCount);function f(m){return m.getVisible();}function g(m){return m.id===this.getId().split("--")[1];}var h=c.getContent().filter(f);r.write("<div");r.writeControlData(c);r.addClass("sapUshellEasyScanLayout");if(!D.system.phone){r.addClass("sapOvpDashboardDragAndDrop");}r.addClass("sapOvpDashboard");r.writeClasses();d?r.addStyle("margin-right",l.marginPx+"px"):r.addStyle("margin-left",l.marginPx+"px");r.writeStyles();r.write(">");r.write("<div class='sapUshellEasyScanLayoutInner' role='list' aria-label='Cards'>");if(e.length>0){var i={},j,L,s,k=c.getDashboardLayoutModel().getColCount();for(j=0,L=h.length;j<L;j++){var S=['easyScanLayoutItemWrapper','sapOvpDashboardLayoutItem'];i=e.filter(g.bind(h[j]))[0];c.dashboardLayoutUtil.setCardCssValues(i);s=i.dashboardLayout.column+i.dashboardLayout.colSpan===k+1;if(s){i.dashboardLayout.colSpan===1?S.push('sapOvpNotResizableLeftRight'):S.push('sapOvpNotResizableRight');}if(i.template==='sap.ovp.cards.stack'||i.settings.stopResizing||!D.system.desktop){S.push('sapOvpDashboardLayoutItemNoDragIcon');}r.write("<div id='"+c.dashboardLayoutUtil.getCardDomId(i.id)+"' class='"+S.join(' ')+"' style='"+"; transform:translate3d("+i.dashboardLayout.left+" ,"+i.dashboardLayout.top+" ,0px)"+"; -ms-transform:translate3d("+i.dashboardLayout.left+" ,"+i.dashboardLayout.top+" ,0px)"+"; -moz-transform:translate3d("+i.dashboardLayout.left+" ,"+i.dashboardLayout.top+" ,0px)"+"; -webkit-transform:translate3d("+i.dashboardLayout.left+" ,"+i.dashboardLayout.top+" ,0px)"+"; height:"+i.dashboardLayout.height+"; width:"+i.dashboardLayout.width+";'"+" tabindex='0'; aria-setsize="+L+" aria-posinset="+(j+1)+">");r.renderControl(h[j]);r.write("</div>");}}r.write("</div>");r.write("<div class='after' tabindex='0'></div>");r.write("</div>");}},init:function(){this.oColumnLayoutData={};this.resizeHandlerId=this.initResizeHandler();var c=sap.ui.getCore().getComponent(this._sOwnerId);this.dashboardLayoutUtil=c.getDashboardLayoutUtil();this.dashboardLayoutUtil.setLayout(this);},exit:function(){if(this.resizeHandlerId){R.deregister(this.resizeHandlerId);}if(this.layoutDragAndDrop){this.layoutDragAndDrop.destroy();delete this.layoutDragAndDrop;}},onBeforeRendering:function(){},onAfterRendering:function(){this.keyboardNavigation=new K(this);if(!this.getDragAndDropRootSelector()){this.setDragAndDropRootSelector("#"+this.getId());}if(this.layoutDragAndDrop){this.layoutDragAndDrop.destroy();}if(this.getDragAndDropEnabled()){this.layoutDragAndDrop=this.dashboardLayoutUtil.getRearrange({rootSelector:this.getDragAndDropRootSelector(),layout:this});this.fireAfterRendering();}},getLayoutDataJSON:function(){return this.dashboardLayoutUtil.getDashboardLayoutModel().getLayoutVariants4Pers();},filterVisibleCards:function(e){return e.getVisible();},getDashboardLayoutUtil:function(){return this.dashboardLayoutUtil;},getDashboardLayoutModel:function(){return this.dashboardLayoutUtil.getDashboardLayoutModel();},getVisibleLayoutItems:function(){var c=this.getContent();var f=c.filter(this.filterVisibleCards);return f;},initResizeHandler:function(){var r;var d=this.getDebounceTime();var b=function(e){window.clearTimeout(r);r=window.setTimeout(this.oControl.resizeHandler.bind(this,e),d);};return R.register(this,b);},resizeHandler:function(e){this.oControl.dashboardLayoutUtil.resizeLayout(e.size.width);},setActive:function(s){if(s){this.removeStyleClass("ovpOverlay");}else{this.addStyleClass("ovpOverlay");}},getActive:function(){return!this.hasStyleClass("ovpOverlay");}});var K=function(o){this.init(o);};K.prototype.init=function(o){this.layoutUtil=o.getDashboardLayoutUtil();this.layoutModel=o.getDashboardLayoutModel();this.keyCodes=q.sap.KeyCodes;this.jqElement=o.$();this.bIgnoreSelfFocus=false;this.sLastFocusableCard=null;this.jqElement.on('keydown',this.keyDownHandler.bind(this));this.jqElement.find(".sapUshellEasyScanLayoutInner").on("focus.keyboardNavigation",this.layoutFocusHandler.bind(this));this.jqElement.on("focus.keyboardNavigation",".easyScanLayoutItemWrapper",this.layoutItemFocusHandler.bind(this));q(".sapFDynamicPageContent").on("click",this.layoutClickHandler.bind(this));};K.prototype.spacebarHandler=function(e){var i=sap.ui.getCore().byId(e.target.id);if(i&&i.mEventRegistry.hasOwnProperty('press')){q('#'+e.target.id).addClass('sapMLIBActive');q('#'+e.target.id+' span').css('color','#FFFFFF');i.firePress();}};K.prototype.layoutItemFocusHandler=function(){var j=q(document.activeElement);if(j){var l=j.find("[aria-label]");var i,s="";if(j.find('.valueStateText').length==1){var t=j.find('.valueStateText').find('.sapMObjectNumberText').text();var v=j.find('.valueStateText').find('.sapUiInvisibleText').text();j.find('.valueStateText').attr('aria-label',t+" "+v);j.find('.valueStateText').attr('aria-labelledby',"");}if(q(l).hasClass('kpiHeaderClass')){var k=q(l).closest('div.kpiHeaderClass');var b=k.text();var n=k.attr("id");var V=sap.ui.getCore().byId(n).getValueColor();k.attr('aria-label',b+" "+V);}j.find("[role='listitem']").attr('aria-label',"");if(j.hasClass('easyScanLayoutItemWrapper')){var c="";var d=j.find('.cardCount');var e=O.getText("cardPositionInApp",[j.attr('aria-posinset'),j.attr('aria-setsize')]);if(d.length===0){c="countDiv_"+new Date().getTime();var f='<div id="'+c+'" class="cardCount" aria-label="'+e+'" hidden></div>';j.append(f);}else{c=d[0].id;d.attr('aria-label',e);}s+=c+" ";var o=j.find('.cardType');if(o.length!==0){s+=o[0].id+" ";}}if(j.hasClass('sapOvpCardHeader')&&!j.hasClass('sapOvpStackCardContent')){var g="";var h=j.find('.cardHeaderType');if(h.length===0){var m=O.getText("CardHeaderType");g="cardHeaderType_"+new Date().getTime();var p='<div id="'+g+'" class="cardHeaderType" aria-label="'+m+'" hidden></div>';j.append(p);}else{g=h[0].id;}s+=g+" ";}for(i=0;i<l.length;i++){if(l[i].getAttribute("role")==="heading"){s+=l[i].id+" ";}}if(j.hasClass('sapOvpCardHeader')){var r=j.find('.cardHeaderText');if(r.length!==0){for(var i=0;i<r.length;i++){s+=r[i].id+" ";}}}if(s.length){j.attr("aria-labelledby",s);}if(j.prop('nodeName')==="LI"&&j.find('.linkListHasPopover').length!==0){if(j.find('#hasDetails').length===0){j.append("<div id='hasDetails' hidden>"+O.getText("HAS_DETAILS")+"</div>");j.attr('aria-describedby',"hasDetails");}}}};K.prototype.layoutFocusHandler=function(){if(this.sLastFocusableCard){this.sLastFocusableCard.focus();this.layoutUtil.sLastFocusableCard=this.sLastFocusableCard;return;}this.jqElement.find(".easyScanLayoutItemWrapper").first().focus();this.sLastFocusableCard=this.jqElement.find(".easyScanLayoutItemWrapper").first();this.layoutUtil.sLastFocusableCard=this.sLastFocusableCard;};K.prototype.layoutClickHandler=function(e){if(e&&e.target&&e.target.getAttribute("id")&&e.target.getAttribute("id").indexOf("mainView")!==-1){if(this.sLastFocusableCard){this.sLastFocusableCard.focus();this.layoutUtil.sLastFocusableCard=this.sLastFocusableCard;return;}this.jqElement.find(".easyScanLayoutItemWrapper").first().focus();this.sLastFocusableCard=this.jqElement.find(".easyScanLayoutItemWrapper").first();this.layoutUtil.sLastFocusableCard=this.sLastFocusableCard;}};K.prototype.ctrlArrowHandler=function(c,b){var o=this.layoutUtil.dashboardLayoutModel.getCardById(b),d=c.dashboardLayout.row,e=o.dashboardLayout.row,n=o.dashboardLayout.column,f=[],g;if(e>d&&o.dashboardLayout.rowSpan>=c.dashboardLayout.rowSpan){g=d+o.dashboardLayout.rowSpan;}else{g=e;}this.layoutUtil.dashboardLayoutModel._arrangeCards(c,{row:g,column:n},'drag',f);this.layoutUtil.dashboardLayoutModel._removeSpaceBeforeCard(f);this.layoutUtil._positionCards(this.layoutModel.aCards);this.layoutUtil.oLayoutCtrl.fireAfterDragEnds({positionChanges:f});};K.prototype.keyDownHandler=function(e){var b=document.activeElement,c=this.layoutUtil.getCardId(b.id),d=q.extend([],this.layoutModel.aCards),o=this.layoutModel.getCardById(c),f=this.layoutModel.iColCount,t={},g,h,l,r,m,n,p,s=q(document.activeElement);this.layoutModel._sortCardsByRow(d);for(var i=1;i<=f;i++){t[i]=[];}for(var j=0;j<d.length;j++){g=d[j].dashboardLayout.column;h=d[j].dashboardLayout.colSpan;if(h===1){t[g].push(d[j]);}else{for(var k=g;k<g+h;k++){t[k].push(d[j]);}}}r=this.getCardPosition(c,t[o.dashboardLayout.column]);switch(e.keyCode){case this.keyCodes.F6:e.preventDefault();if(e.shiftKey){this.bIgnoreSelfFocus=true;this.jqElement.find(".sapUshellEasyScanLayoutInner").focus();q.sap.handleF6GroupNavigation(e);}else{this.bIgnoreSelfFocus=true;var u=this.jqElement.scrollTop();this.jqElement.find(".after").focus();q.sap.handleF6GroupNavigation(e);this.jqElement.scrollTop(u);}break;case this.keyCodes.F7:e.preventDefault();if(s.hasClass("easyScanLayoutItemWrapper")){s.find(":sapTabbable").first().focus();}else{s.closest(".easyScanLayoutItemWrapper").focus();}break;case this.keyCodes.ARROW_UP:e.preventDefault();l=o.dashboardLayout.column;r--;m=t[l][r]&&t[l][r].id;if(m&&e.ctrlKey){this.ctrlArrowHandler(o,m);this.setFocusOnCard(c);}else{if(s&&s.hasClass("easyScanLayoutItemWrapper")){this.setFocusOnCard(m);}}break;case this.keyCodes.ARROW_DOWN:e.preventDefault();l=o.dashboardLayout.column;r++;m=t[l][r]&&t[l][r].id;if(m&&e.ctrlKey){this.ctrlArrowHandler(o,m);this.setFocusOnCard(c);}else{this.setFocusOnCard(m);}break;case this.keyCodes.ARROW_LEFT:e.preventDefault();l=o.dashboardLayout.column;l--;if(!t[l]||!t[l][r]){do{if(l===0){l=f;r--;break;}if(r<0){break;}l--;}while(!t[l]||!t[l][r])}m=t[l][r]&&t[l][r].id;if(m&&e.ctrlKey){this.ctrlArrowHandler(o,m);this.setFocusOnCard(c);}else{this.setFocusOnCard(m);}break;case this.keyCodes.ARROW_RIGHT:e.preventDefault();l=o.dashboardLayout.column+o.dashboardLayout.colSpan;if(!t[l]||!t[l][r]){do{if(l>f){l=1;r++;break;}l++;}while(!t[l]||!t[l][r])}m=t[l][r]&&t[l][r].id;if(m&&e.ctrlKey){this.ctrlArrowHandler(o,m);this.setFocusOnCard(c);}else{this.setFocusOnCard(m);}break;case this.keyCodes.PAGE_UP:e.preventDefault();l=o.dashboardLayout.column;if(e.altKey==true){(l===1)?r=0:l=1;m=t[l][r]&&t[l][r].id;}else{n=t[l].length-1;for(var i=n;i>0;i--){p=document.getElementById(this.layoutUtil.getCardDomId(t[l][i].id));if(p.getBoundingClientRect().bottom<0){m=t[l][i].id;break;}}if(!m){m=t[l][0].id;}}this.setFocusOnCard(m);break;case this.keyCodes.PAGE_DOWN:e.preventDefault();l=o.dashboardLayout.column;if(e.altKey==true){m=(l+o.dashboardLayout.colSpan)>f?d[d.length-1].id:t[f][r]&&t[f][r].id;}else{var w=q(window).height();n=t[l].length;for(var i=0;i<n;i++){p=document.getElementById(this.layoutUtil.getCardDomId(t[l][i].id));if(p.getBoundingClientRect().top>w){m=t[l][i].id;break;}}if(!m){m=t[l][n-1].id;}}this.setFocusOnCard(m);break;case this.keyCodes.HOME:e.preventDefault();l=o.dashboardLayout.column;if(e.ctrlKey==true){(r===0)?l=1:r=0;}else{(l===1)?r=0:l=1;}m=t[l][r]&&t[l][r].id;this.setFocusOnCard(m);break;case this.keyCodes.END:e.preventDefault();l=o.dashboardLayout.column;if(e.ctrlKey==true){var v=t[l].length-1;m=(v===r)?d[d.length-1].id:t[l][v]&&t[l][v].id;}else{m=(l+o.dashboardLayout.colSpan)>f?d[d.length-1].id:t[f][r]&&t[f][r].id;}this.setFocusOnCard(m);break;case this.keyCodes.SPACE:case this.keyCodes.ENTER:this.spacebarHandler(e);break;}};K.prototype.setFocusOnCard=function(c){if(c){var b=document.getElementById(this.layoutUtil.getCardDomId(c));b&&b.focus();this.sLastFocusableCard=b;this.layoutUtil.sLastFocusableCard=this.sLastFocusableCard;}};K.prototype.getCardPosition=function(c,b){for(var i=0;i<b.length;i++){if(b[i].id===c){break;}}return i;};return a;});
