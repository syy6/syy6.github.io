sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/library","sap/ui/model/odata/ODataUtils","sap/ovp/cards/generic/Component","sap/ui/generic/app/navigation/service/NavigationHandler","sap/m/MessageBox","sap/ovp/cards/CommonUtils","sap/ovp/cards/PersonalizationUtils","sap/ovp/cards/charts/VizAnnotationManager","sap/m/BusyDialog","sap/ui/model/Filter","sap/ui/fl/ControlPersonalizationAPI","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState","sap/m/ColumnListItem","sap/m/Text","sap/m/Switch","sap/m/Table","sap/m/Column","sap/m/Button","sap/m/Dialog","sap/ui/model/json/JSONModel","jquery.sap.global","sap/ui/Device","sap/ovp/ui/SmartphoneHeaderToggle","sap/ui/model/odata/v2/ODataModel","sap/ui/model/odata/ODataMetadata","sap/ui/fl/FlexControllerFactory","sap/ui/thirdparty/hasher","sap/m/BackgroundDesign","sap/m/ListSeparators","sap/ui/core/TextAlign","sap/ovp/support/lib/CommonMethods","sap/ovp/app/resources","sap/ovp/app/TemplateBaseExtension","sap/ui/core/mvc/ControllerExtension"],function(C,S,O,a,N,M,b,P,V,B,F,c,d,U,e,T,f,g,h,m,D,J,q,n,o,p,r,s,t,u,L,v,w,x,y,z){"use strict";var A="sap.ovp.app.customData",E="sap.ovp.app.extensionData";return C.extend("sap.ovp.app.Main",{getCustomAppStateDataExtension:function(i){},restoreCustomAppStateDataExtension:function(i){},getCustomFilters:function(){},onCustomActionPress:function(i){},onCustomParams:function(i){},modifyStartupExtension:function(i){},oRefreshTimer:null,nRefreshInterval:0,filterItemInFocus:null,bFinishedCardsCreationProcess:false,storeIncomingDeltaChanges:function(i){this.deltaCardsInfo=i?i:[];},appendIncomingDeltaChange:function(i){this.deltaChanges.push(i);},templateBaseExtension:y,onInit:function(){this.bDeltaChangesEnabled=false;this.deltaChanges=[];this._initFlexibilityPersonalization();if(this.getOwnerComponent()&&this.getOwnerComponent().getMetadata()&&this.getOwnerComponent().getMetadata().getManifest()){w.setAppComponent(this.getOwnerComponent());}w.setApplicationStatus(w.mApplicationStatus.LOADING);w.publishEvent("elements","ViewRenderingStarted",{});this.oContainer=sap.ushell&&sap.ushell.Container;this.aErrorCards=[];this.oCardsModels={};this.aFilters=[];this.errorHandlingObject={atLeastOneRequestSuccess:false,errorLoadingTimeout:{}};this.sPreviousEntityType="";this.sCurrentEntityType="";this.oLoadedComponents={};this.bGlobalFilterLoaded=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;q.sap.measure.start("ovp:GlobalFilter","Main Controller init -> Global Filter loaded","ovp");q.sap.measure.start("ovp:Personalization","Main Controller init -> Personalization loaded","ovp");this.isInitialLoading=true;var i=this.getUIModel();this.bDisableErrorPage=i&&i.getProperty("/disableErrorPage");this.oNavigationHandler=this.oNavigationHandler||new N(this);this.getLayout().addStyleClass("ovpLayoutElement");this.oState={};this.oState.oSmartFilterbar=this.byId("ovpGlobalFilter");this._initGlobalFilter();this._createModelForTile();this._checkJamAuth();b.enable(this,this.oNavigationHandler);},performRecreationOfCard:function(i){this.createLoadingCard(i);i.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(i.model);i=this._getTemplateForChart(i);this._loadCardComponent(i.template);this._createModelViewMap(i);q.when(this.createCard(i)).then(function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var j=this.getLayout().getDashboardLayoutUtil();if(j){var k=j.getDashboardLayoutModel();var l=k.getCardById(i.id);j._sizeCard(l);k.extractCurrentLayoutVariant();}}}.bind(this));},recreateCard:function(i){var j=this._getCardFromManifest(i.cardId);if(j.template=="sap.ovp.cards.charts.analytical"||j.template=="sap.ovp.cards.charts.smart.chart"){j.settings.chartAnnotationPath=i.chartAnnotationPath;if(i.navigation){j.settings.navigation=i.navigation;}}if(i.entitySet){j.settings.entitySet=i.entitySet;}j.settings.annotationPath=i.annotationPath;j.settings.dynamicSubtitleAnnotationPath=i.dynamicSubtitleAnnotationPath;j.settings.presentationAnnotationPath=i.presentationAnnotationPath;j.settings.selectionAnnotationPath=i.selectionAnnotationPath;j.settings.selectionPresentationAnnotationPath=i.selectionPresentationAnnotationPath;j.settings.kpiAnnotationPath=i.kpiAnnotationPath;j.settings.dataPointAnnotationPath=i.dataPointAnnotationPath;j.settings.identificationAnnotationPath=i.identificationAnnotationPath;j.settings.headerAnnotationPath=i.headerAnnotationPath;var k=j.settings.selectedKey;j.settings.selectedKey=i.selectedKey;if(j){this.performRecreationOfCard(j);}var l={changeType:"viewSwitch",content:{cardId:i.cardId,selectedKey:i.selectedKey,oldKey:k},isUserDependent:true};this.savePersonalization(l);},recreateRTAClonedCard:function(i){var j=this._getCardFromManifest(i.id);if(j){j.settings=i.settings;this.performRecreationOfCard(j);}},onBeforeRendering:function(){},getErrorCardsAsArray:function(){var k;var i=[];for(k in this.aOrderedCards){if(this.aOrderedCards[k].visibility){var j=this.aOrderedCards[k].id;var l=this.getView().byId(j);var G=l&&l.getComponentInstance();var H=G&&G.getComponentData();var I=H&&H.settings&&H.settings.template;if(I==="sap.ovp.cards.error"){i.push(j);}}}return i;},verifyAndSetErrorCard:function(R){var k;for(k in this.aOrderedCards){var i=this.getView().byId(this.aOrderedCards[k].id);var j=i&&i.getComponentInstance();var l=j&&j.getComponentData();var G=j&&j.getRootControl();var H=G&&G.getController();var I=H&&H.getCardItemsBinding();if(I){var K=R.getParameters().url;var Q=I.sCustomParams;var W=I.sFilterParams;var X=I.sPath.replace("/","");var Y=I.sRangeParams;var Z=I.sCountMode&&I.sCountMode.indexOf("Inline");var $=I.sSortParams;var _=R.getSource().sServiceUrl;var a1=R.oSource&&R.oSource.oMetadata;var b1=H.getEntityType();var c1=sap.ui.model.odata.ODataUtils.createFilterParams(this.aFilters,a1,b1);K=K.split(X).join("").split(Q).join("").split(W).join("").split(Y).join("").split($).join("").split(_).join("").split(c1).join("").split("?").join("").split("&").join("").split("/").join("");if(!Z){K=K.split("$inlinecount=allpages").join("");}var d1=l&&l.cardId;var e1=this._getCardFromManifest(d1);var f1=this.getErrorCardsAsArray();if(e1&&f1.indexOf(d1)==-1&&!K){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var g1=this.getLayout();var h1=g1.getDashboardLayoutModel();var i1=h1.getCardById(e1.id);e1=i1;}this.createErrorCard(e1,R);}}}},onAfterRendering:function(){w.setApplicationStatus(w.mApplicationStatus.RENDERED);w.publishEvent("elements","ViewRendered",{});this.oModelViewMap={};this.oAppStatePromise=null;if(this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes")){this.nRefreshInterval=this.getView().getModel("ui").getProperty("/refreshIntervalInMinutes");this.nRefreshInterval=(this.nRefreshInterval<=1?1:this.nRefreshInterval)*60000;}var i=this._getCardsModel();var j=[];var k;for(k in i){if(j.indexOf(i[k].model)==-1){j.push(i[k].model);}}var l=this.getOwnerComponent();if(l){for(k in j){var G=l.getModel(j[k]);if(G){G.attachRequestFailed(this.verifyAndSetErrorCard.bind(this));G.attachRequestSent(this.destroyErrorCardsAndReplaceWithOriginal.bind(this));}}}if(this.initialized){return;}this.initialized=true;this.oFlexibilityPersonalizationPromise.then(function(){q.sap.measure.end("ovp:Personalization");this.persistencyVariantLoaded=true;var H;var I=[],K=[];this.aManifestOrderedCards=this._getCardArrayAsVariantFormat(this.getLayout().getContent());for(var Q=0;Q<this.aManifestOrderedCards.length;Q++){H=this._getCardFromManifest(this.aManifestOrderedCards[Q].id);if(H&&H.settings&&H.settings.requireAppAuthorization){I.push({id:H.id,cardIntent:H.settings.requireAppAuthorization});K.push(H.settings.requireAppAuthorization);}}if(K.length>0){this._checkForAuthorization(I,K);}else{this.aOrderedCards=this._mergeLREPContent(this.aManifestOrderedCards);this.organizeCards(this.aOrderedCards);}}.bind(this),function(H){q.sap.log.error("Could not load information from LREP Persistency");q.sap.log.error(H);});if(n.system.phone){o.enable(this);}setTimeout(function(){if(!this.persistencyVariantLoaded){this.busyDialog=new B({text:x.getText("loading_dialog_text")});this.busyDialog.open();this.busyDialog.addStyleClass('sapOVPBusyDialog');}}.bind(this),500);},organizeCards:function(k){var l;var G=[];this._updateLayoutWithOrderedCards();this._updateDashboardLayoutCards(k);if(this.isDragAndDropEnabled()){if(sap.ushell&&sap.ushell.Container){this._initShowHideCardsButton();}}this._clearStoredEntities();for(var i=0;i<this.aOrderedCards.length;i++){if(this.aOrderedCards[i].visibility){l=this._getCardFromManifest(this.aOrderedCards[i].id);if(l){G.push(l);}}}for(var i=0;i<G.length;i++){this._initCardModel(G[i].model);this._loadCardComponent(G[i].template);this._createModelViewMap(G[i]);}q.sap.measure.start("ovp:CreateLoadingCards","Create Loading cards","ovp");for(var i=0;i<G.length;i++){this.createLoadingCard(G[i]);}q.sap.measure.end("ovp:CreateLoadingCards");setTimeout(function(){this.getLayout().addStyleClass("ovpLayoutElementShow");}.bind(this),0);setTimeout(function(){q.sap.measure.start("ovp:CreateCards","Create cards loop","ovp");for(var i=0,j=0;j<G.length;i++,j++){while(G[j].id!==k[i].id){i++;}l=G[j];if(!l.settings.title){q.sap.log.error("title is mandatory for card ID : "+l.id);}if(l.settings.tabs){var I=0;if(this.aOrderedCards[i].selectedKey&&l.settings.tabs.length>=this.aOrderedCards[i].selectedKey){I=this.aOrderedCards[i].selectedKey-1;}this.initializeTabbedCard(l,I);}l=this._getTemplateForChart(l);this._loadCardComponent(l.template);l.settings.baseUrl=this._getBaseUrl();this.createCard(l);}this.bFinishedCardsCreationProcess=true;q.sap.measure.end("ovp:CreateCards");}.bind(this),10);if(this.busyDialog){this.busyDialog.close();}},_getTemplateForChart:function(i){if(i.template==="sap.ovp.cards.charts.smart.chart"){var j=this.getView();var k=j.getModel(i.model);var l=k.getMetaModel();var G=l.getODataEntitySet(i.settings.entitySet);var H=l.getODataEntityType(G.entityType);var I;var K;var Q;var R=false;var W;if(i&&i.settings){if(!R&&i.settings.kpiAnnotationPath){var X=H[i.settings.kpiAnnotationPath];W=X.Detail.DefaultPresentationVariant&&X.Detail.DefaultPresentationVariant.Path;if(W){Q=this._getTemplateForChartFromVisualization(W,i,k,G,H);R=Q.bTemplateUpdated;if(R){i=Q.oCard;return i;}}}if(!R&&i.settings.selectionPresentationAnnotationPath){var Y=H[i.settings.selectionPresentationAnnotationPath];if(Y){W=Y.PresentationVariant&&Y.PresentationVariant.Path;if(W){Q=this._getTemplateForChartFromVisualization(W,i,k,G,H);R=Q.bTemplateUpdated;if(R){i=Q.oCard;return i;}}}}if(!R&&i.settings.presentationAnnotationPath){W=i.settings.presentationAnnotationPath;Q=this._getTemplateForChartFromVisualization(W,i,k,G,H);R=Q.bTemplateUpdated;if(R){i=Q.oCard;return i;}}if(!R&&i.settings.chartAnnotationPath){I=H[i.settings.chartAnnotationPath];K=I&&I.ChartType&&I.ChartType.EnumMember;if(K&&K.split("/")[1]==="Donut"){i.template="sap.ovp.cards.charts.analytical";}else{i.template="sap.ovp.cards.charts.smart.chart";}}}}return i;},_getTemplateForChartFromVisualization:function(i,j,k,l,G){if(/^@/.test(i)){i=i.slice(1);}j.settings.presentationAnnotationPath=i;var H=G[i]&&G[i].Visualizations;var I;var K;var Q;var R=false;if(H&&H.length>0){for(I=0;I<H.length;I++){var W=H[I].AnnotationPath;if(!W){return{oCard:j,bTemplateUpdated:R};}W.trim();if(W.startsWith("@")){W=W.slice(1);}if(W.indexOf("Chart")!=-1){j.settings.chartAnnotationPath=W;K=G[W];Q=K&&K.ChartType&&K.ChartType.EnumMember;if(Q&&Q.split("/")[1]==="Donut"){j.template="sap.ovp.cards.charts.analytical";}else{j.template="sap.ovp.cards.charts.smart.chart";}}R=true;}}return{oCard:j,bTemplateUpdated:R};},_createModelViewMap:function(i){if(!i||!i.settings||!i.model){return;}if(!i.settings.entitySet||i.settings.entitySet===""){return;}if(!(i.template.startsWith("sap.ovp.cards"))){return;}var j=i.model;if(!this.oModelViewMap[j]){this.oModelViewMap[j]={};}this.oModelViewMap[j][i.id]=true;},initializeTabbedCard:function(i,I){if(i.template=="sap.ovp.cards.charts.analytical"||i.template=="sap.ovp.cards.charts.smart.chart"){i.settings.chartAnnotationPath=i.settings.tabs[I].chartAnnotationPath;if(i.settings.tabs[I].navigation){i.settings.navigation=i.settings.tabs[I].navigation;}}if(i.settings.tabs[I].entitySet){i.settings.entitySet=i.settings.tabs[I].entitySet;}i.settings.annotationPath=i.settings.tabs[I].annotationPath;i.settings.dynamicSubtitleAnnotationPath=i.settings.tabs[I].dynamicSubtitleAnnotationPath;i.settings.presentationAnnotationPath=i.settings.tabs[I].presentationAnnotationPath;i.settings.selectionAnnotationPath=i.settings.tabs[I].selectionAnnotationPath;i.settings.selectionPresentationAnnotationPath=i.settings.tabs[I].selectionPresentationAnnotationPath;i.settings.kpiAnnotationPath=i.settings.tabs[I].kpiAnnotationPath;i.settings.dataPointAnnotationPath=i.settings.tabs[I].dataPointAnnotationPath;i.settings.identificationAnnotationPath=i.settings.tabs[I].identificationAnnotationPath;i.settings.params=i.settings.tabs[I].params;i.settings.selectedKey=I+1;},_getLibraryResourceBundle:function(){if(!this.oLibraryResourceBundle){this.oLibraryResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ovp");}return this.oLibraryResourceBundle;},_getOvplibResourceBundle:function(){return this.getOwnerComponent()._getOvpLibResourceBundle();},_getCardsModel:function(){if(!this.oCards){var i=this.getUIModel();this.oCards=i.getProperty("/cards");}return this.oCards;},_getBaseUrl:function(){var i=this.getUIModel();if(!this.sBaseUrl){this.sBaseUrl=i.getProperty("/baseUrl");}return this.sBaseUrl;},_getApplicationId:function(){var i=this.getUIModel();return i.getProperty("/applicationId");},_getCardFromManifest:function(j){var k=this._getCardsModel();for(var i=0;i<k.length;i++){if(k[i].id===j){return k[i];}}return null;},_getCardArrayAsVariantFormat:function(j){var k=[];for(var i=0;i<j.length;i++){var I=this._getCardId(j[i].getId());k.push({id:I,visibility:j[i].getVisible()});var l;if(this.getView()&&this.getView().byId){if(this.getView().byId(I).getComponentInstance()){l=this.getView().byId(I).getComponentInstance().getComponentData().settings.selectedKey;}}if(l){k[k.length-1].selectedKey=l;}}return k;},_checkForAuthorization:function(G,H){if(!this.oContainer){return;}var I=this;var K=[];var Q=b.getNavigationHandler();if(Q&&Q.oCrossAppNavService){Q.oCrossAppNavService.isIntentSupported(H).done(function(R){for(var i=0;i<G.length;i++){if(R[G[i].cardIntent].supported===false){K.push(G[i].id);for(var j=0;j<I.aManifestOrderedCards.length;j++){if(G[i].id===I.aManifestOrderedCards[j].id){I.aManifestOrderedCards.splice(j,1);break;}}}}I.aOrderedCards=I._mergeLREPContent(I.aManifestOrderedCards);function W(X,Y,Z){if(X.id===K[this.unsupportedCardIndex]){Z.splice(Y,1);}}for(var k=0;k<K.length;k++){for(var l=0;l<I.aOrderedCards.length;l++){if(I.aOrderedCards[l].id==K[k]){I.aOrderedCards.splice(l,1);if(I.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){I.getLayout().dashboardLayoutUtil.aCards.map(W,{unsupportedCardIndex:k});I.getLayout().dashboardLayoutUtil.dashboardLayoutModel.oLayoutVars.map(W,{unsupportedCardIndex:k});}break;}}}I.organizeCards(I.aOrderedCards);}).fail(function(){q.sap.log.error("Could not get authorization from isIntentSupported");I.aOrderedCards=I._mergeLREPContent(I.aOrderedCards);I.organizeCards(I.aOrderedCards);});}},_mergeLREPContent:function(l){var i=[];var j=false;if(this.bDeltaChangesEnabled&&Array.isArray(this.deltaCardsInfo)&&this.deltaCardsInfo.length>0){l=P.addMissingCardsFromManifest(l,this.deltaCardsInfo);j=true;}if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(!j){l=this.getLayout().getLayoutDataJSON();}i=P.mergeChanges(l,this.deltaChanges);this._bDashboardLayoutLrepActive=true;this.getLayout().getDashboardLayoutModel().setLayoutVars(i);}else{i=P.mergeChanges(l,this.deltaChanges);}return i?i:[];},_updateLayoutWithOrderedCards:function(){var l=this.getLayout();var k=this.aOrderedCards;l.removeAllContent();var G,H=false;if(this.getView().getModel("ui")&&this.getView().getModel("ui").getProperty("/cards")){G=this.getView().getModel("ui").getProperty("/cards");for(var i=0;i<G.length;i++){H=false;for(var j=0;j<k.length;j++){if(G[i].id==k[j].id){H=true;break;}}if(!H&&this.getView().byId(G[i].id)){this.getView().byId(G[i].id).destroy();}}}for(var i=0;i<k.length;i++){var I=this.getView().byId(k[i].id);if(I){I.setVisible(k[i].visibility);l.addContent(I);}}},_updateErrorCardsArray:function(i){var j;for(j=0;j<i.length;j++){var k=this.aErrorCards.indexOf(i[j].id);if((k>-1)&&i[j].visibility==false){this.aErrorCards.splice(k,1);}}},_updateDashboardLayoutCards:function(i){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().updateCardVisibility(i);}}},_resetDashboardLayout:function(){if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){if(this.getLayout().getDashboardLayoutUtil()){this.getLayout().getDashboardLayoutUtil().resetToManifest();}this.getLayout().rerender();}},_getCardArrayAsVariantFormatDashboard:function(){var i=[];var l=this.getLayout();var j=l.dashboardLayoutUtil.aCards;l.dashboardLayoutUtil.dashboardLayoutModel._sortCardsByRow(j);j.forEach(function(k){i.push({id:k.id,visibility:k.dashboardLayout.visible});});return i;},verifyGlobalFilterLoaded:function(){var G=this.getGlobalFilter();if(G.search()){if(G.validateMandatoryFields()){return true;}}this.getView().byId("ovpMain").setHeaderExpanded(true);return false;},onGlobalFilterChange:function(){this.filterChanged=true;if(this.bGlobalFilterInitialized){var G=this.getGlobalFilter();var l=G.getLiveMode();var i=this.getLayout();if(!l&&i){i.setActive(false);}}},destroyErrorCardsAndReplaceWithOriginal:function(){if(this.isModelRefreshTriggered||this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var k;var i=this.getErrorCardsAsArray();for(k in i){var j=this.getView().byId(i[k]);var l=j&&j.getComponentInstance();var G=l&&l.getComponentData();var H=G&&G.cardId;var I=this._getCardFromManifest(H);l.destroy();this.createCard(I);}this.isModelRefreshTriggered=false;}},onGlobalFilterSearch:function(){if(this.filterChanged||this.bGoButtonPressed||this.bSearchButtonPressed){var G=this.getGlobalFilter();var k=this.getLayout();if(k){k.setActive(true);}var l=this.getErrorCardsAsArray();if(l.length>0){this.destroyErrorCardsAndReplaceWithOriginal();}if(G&&!G.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}this._clearStoredEntities();var H=[];if(this.oGlobalFilter['_aFields'].length>0){H=this.oGlobalFilter["_aFields"];}else{var I=this.oGlobalFilter['_aFilterBarViewMetadata'];for(var i=0;i<I.length;i++){var K=I[i];for(var j=0;j<K.fields.length;j++){H.push(K.fields[j]);}}}for(var i=0;i<H.length;i++){if(H[i].control){var Q=document.getElementById(H[i].control.sId);if(q(Q).hasClass('sapMFocus')){this.filterItemInFocus=H[i].control;break;}}}var R="ovp-"+new Date().getTime();for(var W in this.oCardsModels){if(this.oCardsModels.hasOwnProperty(W)){try{this.oCardsModels[W].refresh(false,false,R);}catch(X){q.sap.log.warning(X);}}}this.filterChanged=false;this.bGoButtonPressed=false;this.bSearchButtonPressed=false;this._clearStoredEntities();}},_clearStoredEntities:function(){if(this.sPreviousEntityType){this.sPreviousEntityType="";}if(this.sCurrentEntityType){this.sCurrentEntityType="";}},_processFilters:function(){this.aFilters=[];var G=this.getGlobalFilter();if(!G){return;}var i=G.getFilters();var j=this.getCustomFilters();var I=true;var k;var l=function(Q,R){if(!(Q instanceof z)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!I){throw new Error("State must always be provided synchronously");}if(R){k=R;}};this.templateBaseExtension.addFilters(l);I=false;var H=[];if(j&&(j instanceof F)){H.push(j);}if(k&&(k instanceof F)){H.push(k);}if(H.length!==0){var K=[];if(i&&i.length>0){H.push(i[0]);}K.push(new F(H,true));if(K.length>0){i=K;}}this.aFilters=i;},_processSearch:function(){var i,j;var G=this.getGlobalFilter();if(!G){return;}var k=G.getParameters();var j=k&&k["custom"];if(!j){return;}for(var l in j){i=l+"="+q.sap.encodeURL(j[l]);}return i;},_initGlobalFilter:function(){var G=this.getGlobalFilter();if(!G){this.bGlobalFilterLoaded=true;this._parseNavigationVariant();q.sap.measure.end("ovp:GlobalFilter");return;}G.attachFiltersDialogClosed(this._storeCurrentAppStateAndAdjustURL.bind(this));var i=G.getVariantManagement();if(i){i.attachAfterSave(function(j){this._storeCurrentAppStateAndAdjustURL();}.bind(this));}this.oGlobalFilterLoadedPromise=new Promise(function(j,k){G.attachInitialized(function(){this._parseNavigationVariant();if(this.oParseNavigationPromise){this.oParseNavigationPromise.done(function(l,H,I){if(l){this._setNavigationVariantToGlobalFilter(l,H,I);this.filterChanged=false;}}.bind(this));this.oParseNavigationPromise.fail(function(){q.sap.log.error("Could not parse navigation variant from URL");});this.oParseNavigationPromise.always(function(){this.bGlobalFilterInitialized=true;if(G&&this.verifyGlobalFilterLoaded()){j();}}.bind(this));}else{if(G&&this.verifyGlobalFilterLoaded()){j();}}},this);G.attachSearch(function(){if(!this.bGlobalFilterLoaded){j();this.bGlobalFilterLoaded=true;if(!G.isDialogOpen()){this._storeCurrentAppStateAndAdjustURL();}var l=this.getLayout();if(l){l.setActive(true);}return;}this.onGlobalFilterSearch();},this);G.attachFilterChange(this.onGlobalFilterChange,this);G._oSearchButton&&G._oSearchButton.attachPress(function(){this.bGoButtonPressed=true;var l=this.getLayout();if(l){l.setActive(true);}}.bind(this));}.bind(this));this.oGlobalFilterLoadedPromise.then(function(j){this.bGlobalFilterLoaded=true;q.sap.measure.end("ovp:GlobalFilter");G._oBasicSearchField&&G._oBasicSearchField.attachSearch(function(){this.bSearchButtonPressed=true;}.bind(this));}.bind(this));},onShareButtonPress:function(i){var l=this._getLibraryResourceBundle();var j=this.getUIModel();var k=j&&j.getProperty("/title");if(!this._oShareActionButton){this._oShareActionButton=sap.ui.xmlfragment("sap.ovp.app.SharePage",{shareEmailPressed:function(){S.URLHelper.triggerEmail(null,l.getText("Email_Subject",[k]),document.URL);},shareJamPressed:function(){var G=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:document.URL,share:k}}});G.open();}});this.getView().addDependent(this._oShareActionButton);}this._oShareActionButton.openBy(i.getSource());},_checkJamAuth:function(){var G=q.sap.getObject("sap.ushell.Container.getUser");var i=this.getUIModel();if(i){i.setProperty("/jamVisible",!!G&&G().isJamActive());}},_createModelForTile:function(){var i=this.getUIModel();var H,j=i&&i.getProperty("/title");var k={tileTitle:j,tileCustomURL:function(){H=t.getHash();return H?("#"+H):window.location.href;}};if(i){i.setProperty("/tileInfo",k);}},_loadCardComponent:function(i){if(!this.oLoadedComponents[i]){q.sap.measure.start("ovp:CardComponentLoad:"+i,"Card Component load","ovp");this.oLoadedComponents[i]=sap.ui.component.load({name:i,url:q.sap.getModulePath(i),async:true});this.oLoadedComponents[i].then(function(){q.sap.measure.end("ovp:CardComponentLoad:"+i);});}},_initCardModel:function(i){var j=false;if(this.oCardsModels[i]||!i){return;}this.oCardsModels[i]=this.getView().getModel(i);if(!this.oCardsModels[i].bUseBatch){this.oCardsModels[i].setUseBatch(false);}else{this.oCardsModels[i].setUseBatch(true);}if(this.getGlobalFilter()){j=true;}this._overrideCardModelRead(this.oCardsModels[i],j);},getVisibleCustomFields:function(){var G=this.getGlobalFilter();var i=G.getAllFilterItems(true);var l,I,j=[];if(i){l=i.length;while(l--){I=i[l];if(I&&I.getVisibleInFilterBar()){j.push(I.getName());}}}var k,H,K,Q=G.getFilterBarViewMetadata();var R=[];if(Q){k=Q.length;while(k--){K=Q[k].fields;if(K){H=K.length;while(H--){if(K[H].isCustomFilterField&&j.indexOf(K[H].fieldName)>-1){R.push({name:K[H].fieldName});}}}}}return R;},_showErrorPage:function(i){if(this.bDisableErrorPage){return;}var j=this.getView().byId('ovpErrorPage');var k=this.getView().byId('ovpMain');if(i){j.setVisible(true);k.setVisible(false);return;}j.setVisible(false);k.setVisible(true);},_isValueHelpCall:function(j,k){var G=this.getGlobalFilter();if(!j||!G||!G._oFilterProvider){return false;}if(j.getId()!==G.getModel().getId()){return false;}var l=G._oFilterProvider;var H=l.getAssociatedValueHelpProviders().concat(l.getAssociatedValueListProviders());var I;for(var i=0;i<H.length;i++){I=H[i]&&H[i].oPrimaryValueListAnnotation;if(I&&I.valueListEntitySetName===k){return true;}}return false;},_overrideCardModelRead:function(j,k){var l=j.read;var G=this;j.read=function(){var H=arguments[1];if(!H){H={};Array.prototype.push.call(arguments,H);}var I=G._getEntityTypeFromPath(j,arguments[0],H.context,false);var K=G._getEntitySetFromEntityType(j,I);if(G._isValueHelpCall(j,K.name)){return l.apply(j,arguments);}if(k){G._processFilters();var Q=G.getGlobalFilter();if(!G.aFilters){G.aFilters=[];}var R=false;var W;var X=K["Org.OData.Capabilities.V1.SearchRestrictions"];if(K["sap:searchable"]==="true"||(X&&X.Searchable&&X.Searchable.Bool&&X.Searchable.Bool==="true")){W=G._processSearch();}G.sCurrentEntityType=I.entityType;if(G.sPreviousEntityType!==G.sCurrentEntityType){G.sPreviousEntityType=G.sCurrentEntityType;R=true;}if(!G.aRelevantFilters){G.aRelevantFilters=[];R=true;}if(R){G.aRelevantFilters=[];if(I){G.aRelevantFilters=G._getEntityRelevantFilters(I,G.aFilters,j,Q.getModel());}}var Y=H.urlParameters;if(G.aRelevantFilters&&G.aRelevantFilters.length>0){var Z=-1;if(Y){for(var $=0;$<Y.length;$++){if((Y[$]).lastIndexOf("$filter=",0)===0){Z=$;break;}}}if(Z>=0){var _=O.createFilterParams(G.aRelevantFilters,j.oMetadata,I).substr(8);if(G.aRelevantFilters.length===1){_="("+_+")";}Y[Z]=Y[Z].slice(0,8)+"("+Y[Z].slice(8,Y[Z].length)+")%20and%20"+_;}else{H.filters=G.aRelevantFilters;}}if(W){Y[Y.length]=W;}if(Q&&Q.getConsiderAnalyticalParameters()){var a1=Q.getAnalyticBindingPath();var b1,c1,d1;if(a1&&a1.length>0){if(I.entityType===Q.getEntityType()){c1=arguments[0];b1=arguments[0].indexOf('$');if(b1>0){c1=arguments[0].substring(0,b1-1);}d1=a1;if(c1!==d1){arguments[0]=arguments[0].replace(c1,d1);}}else{var e1=G._getParametersFromEntityPath(arguments[0]);var f1=G._getParametersFromEntityPath(a1);var g1,h1,i1;if(e1&&e1.length>0){var j1=G._getEntityTypeFromPath(j,arguments[0],H.context,true);for(var i=0;i<f1.length;i++){g1=G._getPropertyMapping(e1,f1[i].name,j1.name,Q.getEntityType(),j,Q.getModel());if(g1){h1=g1+"=.*?[,\)]";i1=arguments[0].match(new RegExp(h1));if(i1&&i1.length>0){c1=i1[0].slice(0,-1);d1=g1+"="+f1[i].sValue;if(c1!==d1){arguments[0]=arguments[0].replace(c1,d1);}}}}}}}}}var k1=j.getMetaModel();var l1=k1.getODataEntityType(K.entityType);Y=G._getExpandPropertiesForSmartCharts(Y,k1,l1);var m1=arguments[1].success;arguments[1].success=(function(o1,G){return function(){if(!G.errorHandlingObject.atLeastOneRequestSuccess){G.errorHandlingObject.atLeastOneRequestSuccess=true;G._showErrorPage(false);}if(G.filterItemInFocus!=null){G.filterItemInFocus.focus();G.filterItemInFocus=null;}if(G.nRefreshInterval!==0){if(G.oRefreshTimer!==null){clearTimeout(G.oRefreshTimer);}G.attachRefreshInterval(G.nRefreshInterval);}return o1.apply(this,arguments);};})(m1,G);var n1=arguments[1].error;arguments[1].error=(function(o1,G){return function(){if(!G.errorHandlingObject.atLeastOneRequestSuccess){clearTimeout(G.errorHandlingObject.errorLoadingTimeout);G.errorHandlingObject.errorLoadingTimeout=setTimeout(function(){if(!G.errorHandlingObject.atLeastOneRequestSuccess){G._showErrorPage(true);}},9000);}return o1.apply(this,arguments);};})(n1,G);return l.apply(j,arguments);};},_getExpandPropertiesForSmartCharts:function(i,G,H){var I;var K="";var Q;var R;var W;var X="$expand";var Y=false;var Z=false;var $;var _;var a1;var b1="com.sap.vocabularies.Common.v1.Text";var c1=H&&H.property;if(!i||!(i.length>0)){return i;}for(var l=0;l<i.length;l++){if(i[l].indexOf("$expand")>-1){return i;}}for(var d1=0;d1<i.length;d1++){if(i[d1].indexOf("$select")>-1){Z=true;_=i[d1];W=i[d1].split("$select=");if(W&&W[1]){$=decodeURIComponent(W[1]);I=$.split(",");if(!I||!(I.length>1)){return i;}}break;}}if(!Z){return i;}if(!I||!(I.length>0)||!c1||!(c1.length>0)){return i;}for(var j=0;j<I.length;j++){for(var k=0;k<c1.length;k++){if(I[j]==(c1[k]&&c1[k].name)){if(c1[k]&&c1[k]["sap:aggregation-role"]&&c1[k]["sap:aggregation-role"]=="dimension"){if(!c1[k][b1]||!c1[k][b1].Path||!(c1[k][b1].Path.indexOf("/")>0)){break;}K=c1[k][b1].Path;Q=K.split("/");if(!Q.length){break;}R=G.getODataAssociationEnd(H,Q[0]);if(!R){break;}if(!Y){X=X+"="+Q[0];Y=true;}else if(Y){X=X+","+Q[0];}a1=_+","+K;}break;}}}if(a1&&X){i[d1]=a1;i.push(X);}return i;},attachRefreshInterval:function(i){this.oRefreshTimer=setTimeout(function(){var l=this.getLayout();if(l&&l.getActive()){for(var j in this.oCardsModels){this.isModelRefreshTriggered=true;this.oCardsModels[j].refresh(false,false);}}}.bind(this),i);},_getEntityTypeFromPath:function(i,j,k,I){var l=p.prototype._normalizePath.apply(i,[j,k]);if(I){l=j.replace(/^\/|\/$/g,"").split("/")[0];if(l.indexOf("(")!=-1){l=l.substring(0,l.indexOf("("));}}var G=r.prototype._getEntityTypeByPath.apply(i.oMetadata,[l]);return G;},_getEntitySetFromEntityType:function(j,k){if(!j||!k){return;}var l=j.getMetaModel();var G=l&&l.getODataEntityContainer();var H=G&&G.entitySet;if(!H||!q.isArray(H)){return;}var I=H.length;for(var i=0;i<I;i++){if(H[i].entityType===k.entityType){return H[i];}}},_getPropertyMapping:function(j,k,l,G,H,I){var i,K;for(i=0;i<j.length;i++){if(j[i].name===k){K=j[i].name;return K;}if((("P_"+j[i].name)===k)||(j[i].name===("P_"+k))){K=j[i].name;return K;}}if(!l||!G||!H||!I){return;}var Q=H.oMetadata._getEntityTypeByName(l);var R=I.oMetadata._getEntityTypeByName(G);if(!Q||!R){return;}var W="com.sap.vocabularies.Common.v1.SemanticObject";var X="com.sap.vocabularies.Common.v1.SemanticObjectMapping";var Y=H.oAnnotations.getAnnotationsData();if(!Y||!Y.propertyAnnotations){return;}var Z=Y.propertyAnnotations[Q.namespace+"."+Q.name];var $=I.oAnnotations.getAnnotationsData();if(!$||!$.propertyAnnotations){return;}var _=$.propertyAnnotations[R.namespace+"."+R.name];var a1=_&&_[k];if(!a1||!a1[W]){return;}var b1,c1,d1,e1,f1;for(b1 in Z){c1=Z[b1];if(c1[W]&&c1[W].String===a1[W].String){d1=c1[X];if(!d1){continue;}e1=d1.length;f1="";while(e1--){if(d1[e1].SemanticObjectProperty.String===k){f1=d1[e1].LocalProperty.PropertyPath;break;}}if(f1!==""){for(i=0;i<j.length;i++){if(j[i].name===f1){K=j[i].name;return K;}}}}}return K;},_getParametersFromEntityPath:function(j){j=j.split("?")[0];var k=j.match(/\(.*=.*\)/);var l=[];if(!k){return l;}var G=k[0].slice(1,-1).trim().split(/\=|\,/);for(var i=0;i<G.length;i=i+2){l.push({name:G[i],sValue:G[i+1]});}return l;},_checkRelevantFiltersRecursive:function(j,k,l,G,H,I){if(!k._bMultiFilter){k.sPath=k.sPath.split('/').pop();var K=this._getPropertyMapping(j,k.sPath,l,G,H,I);if(K){k.sPath=K;return k;}}else{var Q=k.aFilters;var R,W=[];if(Q){for(var i=0;i<Q.length;i++){R=this._checkRelevantFiltersRecursive(j,Q[i],l,G,H,I);if(R){W.push(R);}}if(W.length>0){return(new F(W,k.bAnd));}}}},_getEntityRelevantFilters:function(i,j,k,l){var R=[];if(j.length>0&&i){var G=this._checkRelevantFiltersRecursive(i.property,j[0],i.name,this.getGlobalFilter().getEntityType(),k,l);if(G){R.push(G);}}return R;},_checkIsCardValid:function(i){var j=i+".Component";var k,l;q.sap.require(j);var G=q.sap.getObject(j);if(!G){return false;}if((G!==a)&&!(G.prototype instanceof a)){return false;}if((k=G.getMetadata())&&(l=k.getCustomizing())){if(l["sap.ui.viewReplacements"]&&l["sap.ui.viewReplacements"]["sap.ovp.cards.generic.Card"]){return false;}}if(G.prototype.createContent!=a.prototype.createContent){return false;}if(G.prototype.getPreprocessors!=a.prototype.getPreprocessors){return false;}return true;},_createCardComponent:function(i,j,k){var I="ovp:CreateCard-"+k.template+":"+k.id;q.sap.measure.start(I,"Create Card","ovp");var l=i.getModel("@i18n");if(k.template&&this._checkIsCardValid(k.template)){var G={async:true,name:k.template,componentData:{model:j,modelName:k.model,i18n:l,cardId:k.id,settings:k.settings,appComponent:this.getOwnerComponent(),mainComponent:this}};var H=this.getGlobalFilter();if(k.errorReason){G.componentData.errorReason=k.errorReason;}if(H){G.componentData.globalFilter={getUiState:H.getUiState.bind(H)};}var K=i;sap.ui.component(G).then(function(Q){var R=K.byId(Q.getComponentData().cardId);R.setPropagateModel(true);var W=R.getComponentInstance();R.setComponent(Q);if(W){setTimeout(function(){W.destroy();},0);}});}else{q.sap.log.error("Could not create Card from '"+k.template+"' template. Card is not valid.");}q.sap.measure.end(I);},createErrorCard:function(i,j){var k=q.extend(true,{},i,{template:"sap.ovp.cards.error"});k.errorReason=q.extend({},j);k.settings.oldTemplate=i.template;k.settings.template="sap.ovp.cards.error";this._createCardComponent(this.getView(),undefined,k);},createLoadingCard:function(i){var l=q.extend(true,{},i,{template:"sap.ovp.cards.loading"});this._createCardComponent(this.getView(),undefined,l);},createCard:function(i){var j=this.getView();var k=j.getModel(i.model);Promise.all([k.getMetaModel().loaded(),this.oGlobalFilterLoadedPromise,this.oLoadedComponents[i.template]]).then(function(){this._createCardComponent(j,k,i);}.bind(this),function(l){q.sap.log.error("Can't load card with id:'"+i.id+"' and type:'"+i.template+"', reason:"+l);});},_getCardId:function(i){var j=this.getView().getId()+"--";if(i.indexOf(j)!=-1){var k=i.indexOf(j)+j.length;return i.substr(k);}return i;},_initFlexibilityPersonalization:function(){this.oFlexibilityPersonalizationPromise=new Promise(function(i,j){var l=this.getLayout();this.oFlexController=s.createForControl(l);this.oFlexController.getComponentChanges().then(function(k){if(k.length>0){this.bDeltaChangesEnabled=true;}i();}.bind(this),function(k){i();});}.bind(this));},layoutChanged:function(j){var k=j.getParameter("positionChanges");var l=[],G=[];var H,I;if(this.getLayout().getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){var K=this.getLayout().dashboardLayoutUtil.dashboardLayoutModel.iColCount;if(k){for(var i=k.length-1;i>=0;i--){H=k[i];I=H.content.cardId;if(H.content.dashboardLayout.oldRow&&H.content.dashboardLayout.oldRow===H.content.dashboardLayout.row&&H.content.dashboardLayout.oldColumn&&H.content.dashboardLayout.oldColumn===H.content.dashboardLayout.column){continue;}if(G[I]){if(H.content.dashboardLayout.oldRow){G[I].content.dashboardLayout.oldRow=H.content.dashboardLayout.oldRow;}continue;}G[I]=H;}Object.keys(G).forEach(function(R){var H=G[R];if(H.content.dashboardLayout.oldRow&&H.content.dashboardLayout.oldRow===H.content.dashboardLayout.row&&H.content.dashboardLayout.oldColumn&&H.content.dashboardLayout.oldColumn===H.content.dashboardLayout.column){return;}l.push(G[R]);});l.forEach(function(H){var R=H.content.dashboardLayout;H.content.dashboardLayout={};H.content.dashboardLayout["C"+K]=R;});}}else{var Q=this.getLayout().getContent();this.aOrderedCards=this._getCardArrayAsVariantFormat(Q);l=k;}this.savePersonalization(l);},saveVariant:function(i){var j=this;this.smartVariandManagement.getVariantsInfo(function(k){var l=null;if(k&&k.length>0){l=k[0].key;}var G=l!==null;var H={name:"Personalisation",global:false,overwrite:G,key:l,def:true};j.smartVariandManagement.fireSave(H);});},createChangesForNewAPI:function(i,j){if(i&&j){var k=[];if(!Array.isArray(i)){i=[i];}i.forEach(function(l){k.push({selectorControl:j,changeSpecificData:l});});c.addPersonalizationChanges({controlChanges:k}).then(function(k){c.saveChanges(k,j).then(function(){q.sap.log.info("Personalization changes have been saved in lrep backend");},function(){q.sap.log.error("Personalization changes are not being saved by 'saveChanges' function");});},function(){q.sap.log.error("Personalization changes are not being added by 'addPersonalizationChanges' function");});}},savePersonalization:function(i){var l=this.getLayout();if(l){if(i){this.createChangesForNewAPI(i,l);return;}var j,k;if(l.getMetadata().getName()==="sap.ovp.ui.DashboardLayout"){j={cards:l.getLayoutDataJSON()};k="manageCardsForDashboardLayout";}else{j=this._getCardArrayAsVariantFormat(l.getContent());k="manageCardsForEasyScanLayout";}this.createChangesForNewAPI({changeType:k,content:j,isUserDependent:true},l);}},getLayout:function(){return this.getView()?this.getView().byId("ovpLayout"):null;},_initShowHideCardsButton:function(){var R=sap.ushell.Container.getRenderer("fiori2"),i={controlType:"sap.ushell.ui.launchpad.ActionItem",bCurrentState:true,oControlProperties:{icon:"sap-icon://dimension",text:x.getText("hideCardsBtn_title"),tooltip:x.getText("hideCardsBtn_tooltip"),press:this._onCardMenuButtonPress.bind(this)},bIsVisible:true,aStates:["app"]};R.addUserAction(i);},_onCardMenuButtonPress:function(){var j,l=this.getLayout().getMetadata().getName();this.visibilityChanges=[];function k(Z,$){for(var i=0;i<Z.length;i++){if(Z[i].id==$){return i;}}return-1;}function G(Z,$,_){var a1=-1;for(var i=0;i<$.length;i++){if(Z[i].id==$[i].id){a1=i;}else{a1=k(Z,$[i].id);}var b1=this.getView().byId($[i].id);var c1=b1.getComponentInstance();if(_){if(c1){c1.destroy();}}if($[i].visibility!=Z[a1].visibility||_){if($[i].visibility===true){var d1=this._getCardFromManifest($[i].id);if(d1){this.createLoadingCard(d1);d1.settings.baseUrl=this._getBaseUrl();this._clearStoredEntities();this._initCardModel(d1.model);d1=this._getTemplateForChart(d1);this._loadCardComponent(d1.template);this._createModelViewMap(d1);if(d1.settings.tabs){var e1=0;if(this.aOrderedCards[i].selectedKey&&d1.settings.tabs.length>=this.aOrderedCards[i].selectedKey){e1=this.aOrderedCards[i].selectedKey-1;}this.initializeTabbedCard(d1,e1);}this.createCard(d1);}}else{if(c1){c1.destroy();}}}}}function H(i){var Z=this._getCardFromManifest(i);if(Z){var $=Z.settings;if($.title){return $.title;}else if($.category){return($.category);}else if($.subTitle){return $.subTitle;}return i;}else{q.sap.log.error("Card id "+i+" is not available in the manifest");return"";}}var I=new e({cells:[new T({text:{path:"id",formatter:H.bind(this)}}),new f({state:"{visibility}",customTextOff:" ",customTextOn:" ",change:function(i){var Z=i.oSource.getParent();Z.toggleStyleClass('sapOVPHideCardsTableItem');Z.getCells()[0].toggleStyleClass('sapOVPHideCardsDisabledCell');var $=i.getSource().getBindingContext().getObject();var _=-1;this.visibilityChanges.forEach(function(a1,b1){if(a1.content.cardId===$.id){_=b1;}});if(_>-1){this.visibilityChanges.splice(_,1);}else{this.visibilityChanges.push({changeType:"visibility",content:{cardId:$.id,visibility:i.getParameter("state")},isUserDependent:true});}}.bind(this),tooltip:x.getText("hideCards_switchTooltip")})]});var K=new g("sapOVPHideCardsTable",{backgroundDesign:u.Transparent,showSeparators:L.Inner,columns:[new h({vAlign:"Middle"}),new h({hAlign:v.Right,vAlign:"Middle",width:"4.94rem"})]});K.addStyleClass('sapOVPHideCardsTable');K.bindItems({path:"/cards",template:I});var Q=K.onAfterRendering;K.onAfterRendering=function(Z){Q.apply(K,arguments);var $=Z.srcControl.mAggregations.items;if($){for(var i=0;i<$.length;i++){if(!$[i].getCells()[1].getState()){$[i].addStyleClass('sapOVPHideCardsTableItem');$[i].getCells()[0].addStyleClass('sapOVPHideCardsDisabledCell');}}}setTimeout(function(){q('.sapMListTblRow').first().focus();},200);};var R=new m("manageCardsokBtn",{text:x.getText("okBtn"),type:"Emphasized",press:function(){var i=this.oDialog.getModel().getProperty('/cards');G.apply(this,[this.aOrderedCards,i,false]);this.aOrderedCards=i;this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.savePersonalization(this.visibilityChanges);this.oDialog.close();}.bind(this)});var W=new m("manageCardsCancelBtn",{text:x.getText("cancelBtn"),press:function(){this.oDialog.close();}.bind(this)});var X=new m("manageCardsResetBtn",{text:x.getText("resetBtn"),enabled:((l==="sap.ovp.ui.DashboardLayout")?true:this.isValidForReset()),press:function(){M.show(x.getText("reset_cards_confirmation_msg"),{id:"resetCardsConfirmation",icon:M.Icon.QUESTION,title:x.getText("reset_cards_confirmation_title"),actions:[M.Action.OK,M.Action.CANCEL],onClose:function(i){if(i===M.Action.OK){this.oDialog.setBusy(true);G.apply(this,[this.aOrderedCards,this.aManifestOrderedCards,(l==="sap.ovp.ui.DashboardLayout")?true:false]);this.aOrderedCards=this.aManifestOrderedCards;this._resetDashboardLayout();this._updateDashboardLayoutCards(this.aOrderedCards);this._updateLayoutWithOrderedCards();this.oFlexController.discardChangesForId(this.getLayout().getId(),true).then(function(){this.oDialog.setBusy(false);this.oDialog.close();}.bind(this),function(){this.oDialog.setBusy(false);this.oDialog.close();q.sap.log.error("Discarding all personalization changes failed");}.bind(this));}}.bind(this)});}.bind(this)});this.oDialog=new D({title:x.getText("hideCardsBtn_title"),contentWidth:"29.6rem",contentHeight:"50%",stretch:n.system.phone,content:K,buttons:[R,W,X],afterClose:function(){this.visibilityChanges=[];this.oDialog.destroy();}.bind(this)}).addStyleClass("sapOVPCardsVisibilityDialog");this.oDialog.setBusyIndicatorDelay(0);var Y;if(l==="sap.ovp.ui.DashboardLayout"){Y=q.extend(true,[],this._getCardArrayAsVariantFormatDashboard());}else{Y=q.extend(true,[],this.aOrderedCards);}j=new J({cards:Y});this.oDialog.setModel(j);this.oDialog.open();},isValidForReset:function(){for(var i=0;i<this.aManifestOrderedCards.length;i++){if(this.aManifestOrderedCards[i].id!==this.aOrderedCards[i].id||this.aManifestOrderedCards[i].visibility!==this.aOrderedCards[i].visibility){return true;}}return false;},isDragAndDropEnabled:function(){return!n.system.phone;},getGlobalFilter:function(){if(!this.oGlobalFilter){this.oGlobalFilter=this.getView().byId("ovpGlobalFilter");}return this.oGlobalFilter;},getUIModel:function(){if(!this.oUIModel){var i=this.getOwnerComponent();this.oUIModel=i&&i.getModel("ui");}return this.oUIModel;},_parseNavigationVariant:function(){if(!this.oContainer){this.oParseNavigationPromise=q.Deferred().resolve();return;}this.oParseNavigationPromise=this.oNavigationHandler.parseNavigation();},_setUiStateToGlobalFilter:function(i,j,R){var G=this.getGlobalFilter();var k=new U({selectionVariant:i.toJSONObject()});G.setUiState(k,{replace:R,strictMode:false});j=j.concat(i.getParameterNames().concat(i.getSelectOptionsPropertyNames()));j=j.filter(function(l,H,I){return I.indexOf(l)==H;});return j;},_processModifyStartupExtension:function(i){if(!i){i=[];}var G=this.getGlobalFilter();var j=G.getUiState();var k=new d(j.getSelectionVariant());var l=JSON.parse(JSON.stringify(k));this.modifyStartupExtension(k);if(JSON.stringify(k)!==JSON.stringify(l)){try{i=this._setUiStateToGlobalFilter(k,i,true);}catch(H){q.sap.log.error("Error with modifyStartupExtension, falling back to default behavior"+H);i=this._setUiStateToGlobalFilter(l,i,true);}}return i;},_addFieldsToSFBAdvancedArea:function(i){var l;var G=this.getGlobalFilter();if(i&&i.length>0){l=i.length;while(l--){G.addFieldToAdvancedArea(i[l]);}}},_restoreAppState:function(i){this.restoreCustomAppStateDataExtension(i[A]);var j=i[E];if(!j){return;}var I=true;var G=function(k){if(!(k instanceof z)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var l=k.getMetadata().getNamespace();if(!I){throw new Error("State must always be restored synchronously");}return j[l];};this.templateBaseExtension.restoreExtensionAppStateData(G);I=false;},_setNavigationVariantToGlobalFilter:function(j,k,l){var G=this.getGlobalFilter();if(!G){return;}switch(l){case"iAppState":if(j.selectionVariant){var H,I,K,Q=false;var R,W,X,Y;var Z,$,_;G.clearVariantSelection();H=JSON.parse(j.selectionVariant);G.setCurrentVariantId(H.SelectionVariantID);$=G.getUiState({allFilters:false});W=$&&JSON.stringify($.getSelectionVariant());Y=G.getFilterData()._CUSTOM;Y=((typeof Y=='undefined')?{}:Y);Z=new U({selectionVariant:j.oSelectionVariant.toJSONObject()});G.setUiState(Z,{replace:true,strictMode:false});I=new d(j.selectionVariant);K=I.getParameterNames().concat(I.getSelectOptionsPropertyNames());for(var i=0;i<K.length;i++){G.addFieldToAdvancedArea(K[i]);}_=G.getUiState({allFilters:false});R=_&&JSON.stringify(_.getSelectionVariant());if(W!==R){Q=true;}if(j.customData&&Object.keys(j.customData).length>0){var X=j.customData;this._restoreAppState(X);if(JSON.stringify(Y)!==JSON.stringify(X)){Q=true;}}G.getSmartVariant().currentVariantSetModified(Q);G._updateToolbarText();}break;case"xAppState":case"URLParams":var a1=[];var b1=new d(j.oSelectionVariant.toJSONObject());var c1=new d(j.oDefaultedSelectionVariant.toJSONObject());if(!j.bNavSelVarHasDefaultsOnly&&!b1.isEmpty()){G.clearVariantSelection();G.clear();a1=this._setUiStateToGlobalFilter(b1,a1,true);}if(j.bNavSelVarHasDefaultsOnly&&!c1.isEmpty()&&G.getCurrentVariantId()===""){G.clear();a1=this._setUiStateToGlobalFilter(c1,a1,true);}if(G.getCurrentVariantId()!==""){this._setDisplayCurrency(c1);}a1=this._processModifyStartupExtension(a1);this._addFieldsToSFBAdvancedArea(a1);break;case"initial":a1=this._processModifyStartupExtension();this._addFieldsToSFBAdvancedArea(a1);break;}},_setDisplayCurrency:function(i){var G=this.getGlobalFilter();if(!G){return;}var l,j;var k=G.getAnalyticalParameters();if(k&&k.length>0){l=k.length;while(l--){if((k[l].name==="P_DisplayCurrency")||(k[l].name==="DisplayCurrency")){j=k[l];break;}}}if(!j){return;}var H=G.getFilters([j.fieldName]);var I=H&&H[0]&&H[0].oValue1;if(I&&I!==" "){return;}var K,Q;if(j.name.indexOf("P_")===0){Q=j.name;K=j.name.substr(2);}else{Q="P_"+j.name;K=j.name;}if(i&&!i.isEmpty()){var R;I=i.getParameter(K);if(!I||I===" "){I=i.getParameter(Q);}if(!I||I===" "){R=i.getSelectOption(K);I=R&&R[0]&&R[0].Low;}if(!I||I===" "){R=i.getSelectOption(Q);I=R&&R[0]&&R[0].Low;}}if(!I||I===" "){I=j.defaultPropertyValue;}if(!I||I===" "){return;}var W=new d();W.addParameter(j.name,I);var X=new U({selectionVariant:W.toJSONObject()});G.setUiState(X,{replace:false,strictMode:false});},_getCustomAppState:function(){var i={},j={};this.getCustomAppStateDataExtension(i);if(!(q.isEmptyObject(i))){j[A]=i;}var k;var I=true;var l=function(G,H){if(!(G instanceof z)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!I){throw new Error("State must always be provided synchronously");}if(H){k=k||Object.create(null);var K=G.getMetadata().getNamespace();k[K]=H;}};this.templateBaseExtension.provideExtensionAppStateData(l);I=false;if(k){j[E]=k;}return j;},onBeforeSFBVariantSave:function(){this.getGlobalFilter().setFilterData({_CUSTOM:this._getCustomAppState()});},onAfterSFBVariantLoad:function(){var i=this.getGlobalFilter().getFilterData();if(i._CUSTOM){this._restoreAppState(i._CUSTOM);}},onAssignedFiltersChanged:function(i){if(i.getSource()&&this.getView().byId("ovpFilterText")){this.getView().byId("ovpFilterText").setText(i.getSource().retrieveFiltersWithValuesAsText());}},_getCurrentAppState:function(){var G=this.getGlobalFilter();if(!G){return;}var i=G.getUiState({allFilters:false});var j=i&&i.getSelectionVariant();if(G.getSmartVariant().currentVariantGetModified()){j.SelectionVariantID="";}var k=j&&JSON.stringify(j);var l=new d(k);var H=this._getCustomAppState();return{selectionVariant:l.toJSONString(),customData:H};},_storeCurrentAppStateAndAdjustURL:function(i){if(i&&!i.oSource._bDirtyViaDialog){return;}if(!this.bGlobalFilterLoaded){return;}if(!this.oNavigationHandler){return;}if(this.oAppStatePromise){this.rejectPreviousPromise&&this.rejectPreviousPromise("skip");}this.oAppStatePromise=new Promise(function(k,l){this.rejectPreviousPromise=l;var G=this._getCurrentAppState();var H=this.oNavigationHandler.storeInnerAppStateWithImmediateReturn(G);H.promise.then(function(I){k(I);},function(I){l(I.getErrorCode());});}.bind(this));var j=function(k){this.oAppStatePromise=null;if(k&&k.length>0){this.oNavigationHandler.replaceHash(k);return;}throw"AppState key is empty";};var R=function(k){this.oAppStatePromise=null;if(k==="skip"){throw k;}throw("Something went wrong while storing AppState - "+k);};this.oAppStatePromise.then(j.bind(this),R.bind(this)).catch(function(k){if(k==="skip"){return;}q.sap.log.error(k);});}});});
