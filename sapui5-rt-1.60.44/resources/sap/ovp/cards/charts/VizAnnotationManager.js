sap.ui.define(["jquery.sap.global","sap/ovp/cards/charts/Utils","sap/ui/model/odata/CountMode","sap/ovp/cards/AnnotationHelper","sap/ui/core/format/NumberFormat","sap/ui/core/format/DateFormat","sap/viz/ui5/api/env/Format","sap/viz/ui5/controls/VizTooltip","sap/ovp/cards/CommonUtils","sap/ovp/cards/OVPCardAsAPIUtils","sap/viz/ui5/data/DimensionDefinition","sap/viz/ui5/data/MeasureDefinition","sap/viz/ui5/controls/common/feeds/FeedItem","sap/ui/core/Element","sap/ovp/app/resources"],function(q,U,C,a,N,D,V,b,c,O,e,M,F,g,h){"use strict";var l={LABEL_KEY:"sap:label",LABEL_KEY_V4:"com.sap.vocabularies.Common.v1.Label",TEXT_KEY:"sap:text",TEXT_KEY_V4:"com.sap.vocabularies.Common.v1.Text",TEXT_ARRANGEMENT_ANNO:"com.sap.vocabularies.UI.v1.TextArrangement",TYPE_KEY:"type",DISPLAY_FORMAT_KEY:"sap:display-format",SEMANTICS_KEY:"sap:semantics",UNIT_KEY:"sap:unit",UNIT_KEY_V4_ISOCurrency:"Org.OData.Measures.V1.ISOCurrency",UNIT_KEY_V4_Unit:"Org.OData.Measures.V1.Unit",CURRENCY_CODE:"currency-code",NAME_KEY:"name",NAME_CAP_KEY:"Name",EDM_TYPE:"type",EDM_INT32:"Edm.Int32",EDM_INT64:"Edm.Int64",SCATTER_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Scatter",BUBBLE_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Bubble",LINE_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Line",COLUMNSTACKED_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/ColumnStacked",VERTICALBULLET_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/VerticalBullet",COLUMN_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Column",COMBINATION_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Combination",DONUT_CHARTTYPE:"com.sap.vocabularies.UI.v1.ChartType/Donut"};var n={CARD_WARNING:"OVP-AC: Analytic card: Warning: ",CARD_ERROR:"OVP-AC: Analytic card Error: ",DATA_ANNO_ERROR:"OVP-AC: Analytic card Error:",CARD_ANNO_ERROR:"OVP-AC: Analytic card: Error ",CHART_ANNO_ERROR:"OVP-AC: Analytic card: Error ",INVALID_CHART_ANNO:"OVP-AC: Analytic Cards: Invalid Chart Annotation.",ANALYTICAL_CONFIG_ERROR:"Analytic card configuration error",CACHING_ERROR:"no model defined while caching OdataMetaData",INVALID_MAXITEMS:"maxItems is Invalid. ",NO_DATASET:"OVP-AC: Analytic Cards: Could not obtain dataset.",SORTORDER_WARNING:"SortOrder is present in PresentationVariant, but it is empty or not well formed.",BOOLEAN_ERROR:"Boolean value is not present in PresentationVariant.",IS_MANDATORY:"is mandatory.",IS_MISSING:"is missing.",NOT_WELL_FORMED:"is not found or not well formed)",MISSING_CHARTTYPE:"Missing ChartType in ",CHART_ANNO:"Chart Annotation.",DATA_ANNO:"Data Annotation",CARD_ANNO:"card annotation.",CARD_CONFIG:"card configuration.",CARD_CONFIG_ERROR:"Could not obtain configuration for ",CARD_CONTAINER_ERROR:"Could not obtain card container. ",DATA_UNAVAIALABLE:"No data available.",CONFIG_LOAD_ERROR:"Failed to load config.json. Reason: ",INVALID_CHARTTYPE:"Invalid ChartType given for ",INVALID_CONFIG:"No valid configuration given for ",CONFIG_JSON:"in config.json",ENTER_INTEGER:"Please enter an Integer.",NO_CARD_MODEL:"Could not obtain Cards model.",ANNO_REF:"com.sap.vocabularies.UI.v1 annotation.",INVALID_REDUNDANT:"Invalid/redundant role configured for ",CHART_IS:"chart is/are ",CARD_CONFIG_JSON:"card from config.json",ALLOWED_ROLES:"Allowed role(s) for ",DIMENSIONS_MANDATORY:"DimensionAttributes are mandatory.",MEASURES_MANDATORY:"MeasureAttributes are mandatory.",CARD_LEAST:"card: Enter at least ",CARD_MOST:"card: Enter at most ",FEEDS:"feed(s).",MIN_FEEDS:"Minimum number of feeds required for ",FEEDS_OBTAINED:"card is not configured. Obtained ",FEEDS_REQUIRED:"feed(s), Required: ",INVALID_SEMANTIC_MEASURES:"More than one measure is being semantically coloured",INVALID_IMPROVEMENT_DIR:"No Improvement Direction Found",INVALID_CRITICALITY:"Invalid criticality values",INVALID_DIMMEAS:"Invalid number of Measures or Dimensions",INVALID_FORECAST:"Invalid/Redundant Datapoint or Forecast measure",INVALID_TARGET:"Invalid/Redundant Datapoint or Target measure",ERROR_MISSING_AXISSCALES:"Minimum and Maximum values are mandatory for AxisScale MinMax to work"};var G;function o(f,j,v,x,u1,v1,w1){var x1="{";if(!f||!f.getSetting('ovpCardProperties')){q.sap.log.error(n.ANALYTICAL_CONFIG_ERROR);x1+="}";return x1;}var y1=f.getSetting("dataModel");var z1;if(w1&&w1.EnumMember){z1=w1.EnumMember.split("/");if(z1&&(z1[1]==='Donut')){y1.setDefaultCountMode(C.Inline);}if(z1&&(z1[1]!='Donut')&&(u1===undefined)){return null;}}var A1=[];var B1=[];var C1=[];var D1=[];var E1=[];var F1=[];var G1=v&&v.Parameters;var H1=x&&x.SortOrder;var I1=x&&x.MaxItems,J1=null;var K1;var L1;var M1;var N1=null;var O1=l.TEXT_KEY;var P1=l.TEXT_KEY_V4;var Q1=l.UNIT_KEY;var R1=l.UNIT_KEY_V4_ISOCurrency;var S1=l.UNIT_KEY_V4_Unit;var T1={};if(I1){J1=I1.Int32?I1.Int32:I1.Int;}if(J1){if(J1==="0"){q.sap.log.error("OVP-AC: Analytic card Error: maxItems is configured as "+J1);x1+="}";return x1;}if(!/^\d+$/.test(J1)){q.sap.log.error("OVP-AC: Analytic card Error: maxItems is Invalid. "+"Please enter an Integer.");x1+="}";return x1;}}var U1=f.getSetting('ovpCardProperties'),V1=U1.getProperty('/parameters');var W1=U1.getProperty("/metaModel");G1=G1||!!V1;if(G1){var X1=a.resolveParameterizedEntitySet(y1,j,v,V1);x1+="path: '"+X1+"'";}else{x1+="path: '/"+j.name+"'";}var Y1=[];N1=f.getSetting('ovpCardProperties').getProperty("/entitySet");if(!y1||!N1){return x1;}var Z1=i1(y1,N1);var $1=f.getSetting('ovpCardProperties').getProperty("/cardLayout");var _1=1,a2;var b2=K();var c2;var d2;if(u1&&$1&&$1.colSpan&&$1.colSpan>1){a2=$1.colSpan-_1;for(var e2 in b2){if((d2=b2[e2].reference)&&b2[d2]){var f2=q.extend(true,{},b2[d2]);b2[e2]=f2;}if(e2===z1[1]||(b2[e2].time&&b2[e2].time.type===z1[1].toLowerCase())){c2=b2[e2];break;}}var g2=L(u1,c2,y1,N1);if(g2){c2=c2.time;}else{c2=c2.default;}var h2=f.getSetting('ovpCardProperties').getProperty("/dataStep");if(!h2){if(c2.resize&&c2.resize.hasOwnProperty("dataStep")&&!isNaN(c2.resize.dataStep)){h2=c2.resize.dataStep;}}h2=parseInt(h2,10);if(a2>0&&h2&&!isNaN(h2)){J1=parseInt(J1,10)+h2*a2;}}if(v){var U1=f.getSetting('ovpCardProperties');Y1=a.getFilters(U1,v);}if(Y1.length>0){x1+=", filters: "+JSON.stringify(Y1);}if(H1){var i2=x.SortOrder;if(!i2.length){i2=U.getSortAnnotationCollection(y1,x,j);}if(i2.length<1){q.sap.log.warning(n.CARD_WARNING+n.SORTORDER_WARNING);}else{var j2="";var k2;var l2;var m2;for(var i=0;i<i2.length;i++){k2=i2[i];m2=k2.Property.PropertyPath;F1.push(m2);if(typeof k2.Descending==="undefined"){l2='true';}else{var Z=k2.Descending.Bool||k2.Descending.Boolean;if(!Z){q.sap.log.warning(n.CARD_WARNING+n.BOOLEAN_ERROR);l2='true';}else{l2=Z.toLowerCase()==='true'?'true':'false';}}j2=j2+"{path: '"+m2+"',descending: "+l2+"},";}x1+=", sorter: ["+j2.substring(0,j2.length-1)+"]";}}var n2=f.getSetting("ovpCardProperties").getProperty("/entityType");q.each(v1,function(i,m){K1=m.Measure.PropertyPath;if(m.DataPoint&&m.DataPoint.AnnotationPath){var d=n2[m.DataPoint.AnnotationPath.substring(1)];if(d.ForecastValue&&(d.ForecastValue.PropertyPath||d.ForecastValue.Path)){var s=(d.ForecastValue.PropertyPath||d.ForecastValue.Path);E1.push((d.ForecastValue.PropertyPath||d.ForecastValue.Path));if(Z1&&Z1[s]){var p2;if(Z1[s][R1]){p2=Z1[s][R1].Path?Z1[s][R1].Path:undefined;}else if(Z1[s][S1]){p2=Z1[s][S1].Path?Z1[s][S1].Path:undefined;}else if(Z1[s][Q1]){p2=Z1[s][Q1];}if(p2){if(q.inArray(p2,E1)===-1){E1.push(p2);}}}}if(d.TargetValue&&(d.TargetValue.PropertyPath||d.TargetValue.Path)){var q2=(d.TargetValue.PropertyPath||d.TargetValue.Path);E1.push((d.TargetValue.PropertyPath||d.TargetValue.Path));if(Z1&&Z1[q2]){var p2;if(Z1[q2][R1]){p2=Z1[q2][R1].Path?Z1[q2][R1].Path:undefined;}else if(Z1[q2][S1]){p2=Z1[q2][S1].Path?Z1[q2][S1].Path:undefined;}else if(Z1[q2][Q1]){p2=Z1[q2][Q1];}if(p2){if(q.inArray(p2,E1)===-1){E1.push(p2);}}}}}E1.push(K1);if(Z1&&Z1[K1]){if(Z1[K1][P1]){if(Z1[K1][P1].String&&K1!=Z1[K1][P1].String){E1.push(Z1[K1][P1].String?Z1[K1][P1].String:K1);}else if(Z1[K1][P1].Path&&K1!=Z1[K1][P1].Path){E1.push(Z1[K1][P1].Path?Z1[K1][P1].Path:K1);}}else if(Z1[K1][O1]&&K1!=Z1[K1][O1]){E1.push(Z1[K1][O1]?Z1[K1][O1]:K1);}}if(Z1&&Z1[K1]){var p2;if(Z1[K1][R1]){p2=Z1[K1][R1].Path?Z1[K1][R1].Path:undefined;}else if(Z1[K1][S1]){p2=Z1[K1][S1].Path?Z1[K1][S1].Path:undefined;}else if(Z1[K1][Q1]){p2=Z1[K1][Q1];}if(p2){if(q.inArray(p2,E1)===-1){E1.push(p2);}}}});q.each(u1,function(i,d){K1=d.Dimension.PropertyPath;A1.push(K1);if(Z1&&Z1[K1]){if(Z1[K1][P1]){if(Z1[K1][P1].String&&K1!=Z1[K1][P1].String){A1.push(Z1[K1][P1].String?Z1[K1][P1].String:K1);}else if(Z1[K1][P1].Path&&K1!=Z1[K1][P1].Path){M1=Z1[K1][P1].Path;var m=M1.split("/");if(m.length>1){L1=p(W1,n2,M1);if(L1!==""){A1.push(M1);B1.push(L1);D1=r(W1,n2,M1);if(D1.length>0){C1=C1.concat(D1);}}}else{A1.push(M1?M1:K1);}}}else if(Z1[K1][O1]&&K1!=Z1[K1][O1]){A1.push(Z1[K1][O1]?Z1[K1][O1]:K1);}}});if(C1.length>0){var k=0;while(k<C1.length){if(A1.indexOf(C1[k])!==-1){C1.splice(k,1);}else{k++;}}}if(E1.length>0){q.each(E1,function(i,m){T1[m]=true;});}if(A1.length>0){q.each(A1,function(i,d){T1[d]=true;});}x1+=", parameters: {select:'"+[].concat(A1,E1).join(",");if(F1.length>0){var o2=[];q.each(F1,function(i,s){if(!T1.hasOwnProperty(s)){o2.push(s);}});if(o2.length>0){x1+=","+o2.join(",");}}if(B1.length>0){x1+="'"+","+" expand:'"+B1.join(',');}x1+="'}";if(z1&&(z1[1]==='Donut')&&(u1===undefined)){x1+=", length: 1";}else if(z1&&(z1[1]==='Donut')&&(u1)&&J1){x1+=", length: "+(parseInt(J1,10)+1);}else if(J1){x1+=", length: "+J1;}x1+="}";return x1;}o.requiresIContext=true;function p(m,d,s){var f="";var j=s.split("/");if(j.length>1){for(var i=0;i<(j.length-1);i++){var k=m.getODataAssociationEnd(d,j[i]);if(k){d=m.getODataEntityType(k.type);if(f){f=f+"/";}f=f+j[i];}else{return f;}}}return f;}function r(m,d,s){var f=[];var k=[];var v;var x=s.split("/");if(x.length>1){for(var i=0;i<(x.length-1);i++){var u1=m.getODataAssociationEnd(d,x[i]);if(u1){d=m.getODataEntityType(u1.type);if(d){k=d&&d.key&&d.key.propertyRef;for(var j=0;j<k.length;j++){v=x[i]+"/"+k[j].name;f.push(v);}}}}}return f;}function t(m,d){var f=false;var i;if(m.DataPoint&&m.DataPoint.AnnotationPath){var j=d[m.DataPoint.AnnotationPath.substring(1)];if(j&&j.ForecastValue&&(j.ForecastValue.PropertyPath||j.ForecastValue.Path)){f=true;i=m;}}if(f===true){return i;}else{q.sap.log.warning(n.CARD_WARNING+n.INVALID_FORECAST);return undefined;}}function u(m,d){var f=false;var i;if(m.DataPoint&&m.DataPoint.AnnotationPath){var j=d[m.DataPoint.AnnotationPath.substring(1)];if(j&&j.TargetValue&&(j.TargetValue.PropertyPath||j.TargetValue.Path)){f=true;i=m;}}if(f===true){return i;}else{q.sap.log.warning(n.CARD_WARNING+n.INVALID_TARGET);return undefined;}}function w(m,d){var f;q.each(d,function(i,v){if(v.name===m){if(v["com.sap.vocabularies.Common.v1.Label"]){f=v["com.sap.vocabularies.Common.v1.Label"].String?v["com.sap.vocabularies.Common.v1.Label"].String:v["com.sap.vocabularies.Common.v1.Label"].Path;}else if(v["sap:label"]){f=v["sap:label"];}return false;}});return f;}function y(f,d){var j=true;if(d==="line"||d==="column"){q.each(f,function(i,v){if((v.getUid()==='valueAxis')||(v.getUid()==='categoryAxis')){if(v.getValues().length!=1){j=false;q.sap.log.warning(n.CARD_WARNING+n.INVALID_DIMMEAS);return false;}}});}else if(d==="vertical_bullet"){q.each(f,function(i,v){if((v.getUid()==='actualValues')||(v.getUid()==='categoryAxis')){if(v.getValues().length!=1){j=false;q.sap.log.warning(n.CARD_WARNING+n.INVALID_DIMMEAS);return false;}}});}if(j===true){return true;}}function z(m,s,v){var d=l.TYPE_KEY;if(!m||!m[s]||!m[s][d]){return v;}var f=["Edm.Int","Edmt.Int16","Edm.Int32","Edm.Int64","Edm.Decimal"];var i=m[s][d];if(q.inArray(i,f)!==-1){return Number(v);}return v;}function A(d){if(d){return d;}return"";}function B(){var d={locale:function(){},format:function(v,f){var i="";if(f){i=f.split('/');}if(i.length>0){var m,s;if(i.length===3){m=Number(i[1]);s=Number(i[2]);if(isNaN(m)){m=-1;}if(isNaN(s)){s=0;}}else{m=2;s=0;}if(i[0]==="axisFormatter"||(i[0]==="ShortFloat")){var j;j=N.getFloatInstance({style:'short',minFractionDigits:m,maxFractionDigits:m});if(i[0]==="ShortFloat"){j=N.getFloatInstance({style:'short',minFractionDigits:m,maxFractionDigits:m});}if(m===-1){j=N.getFloatInstance({style:'short'});}return j.format(Number(v));}else if(i[0]==="tooltipNoScaleFormatter"){var k=N.getFloatInstance({style:'short',currencyCode:false,shortRefNumber:s,showScale:false,minFractionDigits:m,maxFractionDigits:m});if(m===-1){k=N.getFloatInstance({minFractionDigits:0,currencyCode:false});}return k.format(Number(v));}else if(i[0]==="CURR"){var x=N.getCurrencyInstance({style:'short',currencyCode:false,minFractionDigits:m,maxFractionDigits:m});if(m===-1){x=N.getCurrencyInstance({style:'short',currencyCode:false});}return x.format(Number(v));}else if(i[0].search("%")!==-1){var u1=N.getPercentInstance({style:'short',minFractionDigits:m,maxFractionDigits:m});if(m===-1){u1=N.getPercentInstance({style:'short',minFractionDigits:1,maxFractionDigits:1});}v=u1.format(Number(v));return v;}}if(v.constructor===Date){var v1=D.getDateTimeInstance({pattern:f});if(f==="YearMonthDay"){v1=D.getDateInstance({style:"medium"});}if(f==="YearMonth"){v1=D.getDateTimeInstance({format:"YYYYMMM"});}if(f==="YearQuarter"||f==="Quarter"){v1=D.getDateTimeInstance({format:"YYYYQ"});}if(f==="YearWeek"||f==="Week"){v1=D.getDateTimeInstance({format:"YYYYWW"});}v=v1.format(new Date(v));}return v;}};V.numericFormatter(d);}function E(v,f){var d=v.getModel();var k=v.getVizType();if(k!="line"&&k!="bubble"){return;}if(!f){f=k==="line"?"categoryAxis":"valueAxis";}var m=v.getModel('ovpCardProperties').getProperty("/entitySet");if(!d||!m){return;}var s=i1(d,m);var x=v.getFeeds();for(var i=0;i<x.length;i++){if(x[i].getUid()===f){var u1=x[i].getValues();if(!u1){return;}for(var j=0;j<u1.length;j++){if(s[u1[j][l.TYPE_KEY]]!="Edm.DateTime"){return;}}v.setVizProperties({categoryAxis:{title:{visible:false}}});return;}}}function H(d,f,i,m,j,k){m=typeof m==="undefined"?false:m;var s=false;var v;if(!d&&m){q.sap.log.error(j+n.CARD_ERROR+i+n.IS_MANDATORY);return s;}if(!d){q.sap.log.warning(j+n.CARD_WARNING+i+n.IS_MISSING);s=true;return s;}v=f[d];if(!v||typeof v!=="object"){var x=m?q.sap.log.error:q.sap.log.warning;x(j+n.CARD_ERROR+"in "+i+". ("+d+" "+n.NOT_WELL_FORMED);return s;}if(k&&k==="sap.ovp.cards.charts.analytical.analyticalChart"&&i==="Chart Annotation"&&(!v.ChartType||!v.ChartType.EnumMember)){q.sap.log.error(j+n.CARD_ERROR+n.MISSING_CHARTTYPE+n.CHART_ANNO);return s;}s=true;return s;}function I(d){var f=false;if(!d){return f;}var s;var i;var j;var k;var m;var v;var x;var u1="";var v1;var w1=d.getView();if(w1){u1="["+w1.getId()+"] ";}if(!(v1=d.getCardPropertiesModel())){q.sap.log.error(u1+n.CARD_ERROR+"in "+n.CARD_CONFIG+n.NO_CARD_MODEL);return f;}x=v1.getProperty("/entityType");if(!x||q.isEmptyObject(x)){q.sap.log.error(u1+n.CARD_ERROR+"in "+n.CARD_ANNO);return f;}s=v1.getProperty("/selectionAnnotationPath");i=v1.getProperty("/chartAnnotationPath");k=v1.getProperty("/presentationAnnotationPath");m=v1.getProperty("/identificationAnnotationPath");v=v1.getProperty("/dataPointAnnotationPath");j=v1.getProperty("/contentFragment");f=H(s,x,"Selection Variant",false,u1);f=H(i,x,"Chart Annotation",true,u1,j)&&f;f=H(k,x,"Presentation Variant",false,u1)&&f;f=H(m,x,"Identification Annotation",true,u1)&&f;f=H(v,x,"Data Point",false,u1)&&f;return f;}function J(d,f,v){}function K(d){return U.getConfig(d);}function L(d,f,i,j){var k=false;var m;var s;var v;var x;var u1;var v1;if(!f.time||q.isEmptyObject(f.time)){return k;}if(!d){return k;}for(var w1=0;w1<d.length;w1++){if(!d[w1].Dimension||!(s=d[w1].Dimension.PropertyPath)){return k;}m=i1(i,j);if(m&&m[s]){v=m[s][l.TYPE_KEY];x=m[s][l.DISPLAY_FORMAT_KEY];u1=m[s][l.SEMANTICS_KEY];v1=m[s]["com.sap.vocabularies.Common.v1.IsCalendarYear"];}if(v&&v.lastIndexOf("Edm.Date",0)===0){if(v.toLowerCase()==="edm.datetime"){if(x&&x.toLowerCase()==="date"){k=true;}}else{k=true;}}if(v==="Edm.String"&&(v1||u1&&u1.lastIndexOf("year",0)===0)){k=true;}if(k){d.unshift(d.splice(w1,1)[0]);break;}}return k;}function P(i,d,f){var j="";var k=K(d);var m,s;if(!k){return j;}j=k.default.type;m=i.getSetting("dataModel");s=i.getSetting('ovpCardProperties').getProperty("/entitySet");if(L(f,k,m,s)){j=k.time.type;}return j;}P.requiresIContext=true;function Q(d,j,k){if(!d.length){return;}var m=k==="dimension"?"Dimension":"Measure";var s=[];q.each(d,function(i,f){if(!f||!f[m]||!f[m].PropertyPath){q.sap.log.error(n.INVALID_CHART_ANNO);return false;}s.push(f[m].PropertyPath);});var v=q.map(j.feeds,function(f){if(f.type===k){if(f.role){return f.role.split("|");}return[];}});v=q.grep(v,function(f,i){return q.inArray(f,v)===i;}).join(", ");q.sap.log.error(n.CARD_ERROR+n.INVALID_REDUNDANT+k+"(s) "+s.join(", ")+". "+n.ALLOWED_ROLES+j.type+n.CHART_IS+v);}function R(v,i){var d;if(v){if(v.String){d=v.String;}else if(v.Boolean||v.Bool){d=S(v);}else{d=T(v,i);}}return d;}function S(v,d){if(v&&v.Boolean){if(v.Boolean.toLowerCase()==="true"){return true;}else if(v.Boolean.toLowerCase()==="false"){return false;}}else if(v&&v.Bool){if(v.Bool.toLowerCase()==="true"){return true;}else if(v.Bool.toLowerCase()==="false"){return false;}}return d;}function T(v,i){var d;if(v){if(v.String){d=Number(v.String);}else if(v.Int){d=Number(v.Int);}else if(v.Decimal){d=Number(v.Decimal);}else if(v.Double){d=Number(v.Double);}else if(v.Single){d=Number(v.Single);}}if(i){var f=N.getFloatInstance({style:'short',minFractionDigits:2,maxFractionDigits:2});if(d){d=f.format(Number(d));}}return d;}function W(i,d){function Y(v1){if(v1){if(v1.Path){return"{path:'"+v1.Path+"'}";}else{return R(v1);}}else{return"";}}var v=i[i.measureNames];if(d&&d.CriticalityCalculation&&d.CriticalityCalculation.ImprovementDirection){var s=d.CriticalityCalculation.ImprovementDirection.EnumMember;var f=Y(d.CriticalityCalculation.DeviationRangeLowValue);var j=Y(d.CriticalityCalculation.DeviationRangeHighValue);var k=Y(d.CriticalityCalculation.ToleranceRangeLowValue);var m=Y(d.CriticalityCalculation.ToleranceRangeHighValue);return a._calculateCriticalityState(v,s,f,j,k,m,a.criticalityConstants.StateValues);}else{var x=d.Criticality.EnumMember;var u1=x?x.split("/"):[];if(u1){return u1[1];}}}function X(d,m,f){var j,k;q.each(m,function(i,v){if(v["com.sap.vocabularies.Common.v1.Label"]&&v["com.sap.vocabularies.Common.v1.Label"].String===d.measureNames){j=v.name;return false;}else if(v["com.sap.vocabularies.Common.v1.Label"]&&v["com.sap.vocabularies.Common.v1.Label"].Path===d.measureNames){j=v.name;return false;}else if(v["sap:label"]===d.measureNames){j=v.name;return false;}});q.each(f,function(i,v){if(v.Measure.PropertyPath===j){if(!v.DataPoint||!v.DataPoint.AnnotationPath){return false;}k=v.DataPoint.AnnotationPath;return false;}});return k;}function Y(i,d){if(i){if(i.Path){return i.Path;}else{return R(i,d);}}else{return"";}}function Z(m,d){function f(s,i){return s&&s.indexOf(i,s.length-i.length)!==-1;}var j=false;q.each(m,function(i,v){if(v.DataPoint&&v.DataPoint.AnnotationPath){var k=d[v.DataPoint.AnnotationPath.substring(1)];if(k&&k.CriticalityCalculation&&k.CriticalityCalculation.ImprovementDirection&&k.CriticalityCalculation.ImprovementDirection.EnumMember){var s=k.CriticalityCalculation.ImprovementDirection.EnumMember;var x=Y(k.CriticalityCalculation.DeviationRangeLowValue);var u1=Y(k.CriticalityCalculation.DeviationRangeHighValue);var v1=Y(k.CriticalityCalculation.ToleranceRangeLowValue);var w1=Y(k.CriticalityCalculation.ToleranceRangeHighValue);if(f(s,"Minimize")||f(s,"Minimizing")){if(w1&&u1){j=true;return false;}else{q.sap.log.warning(n.CARD_WARNING+n.INVALID_CRITICALITY);}}else if(f(s,"Maximize")||f(s,"Maximizing")){if(v1&&x){j=true;return false;}else{q.sap.log.warning(n.CARD_WARNING+n.INVALID_CRITICALITY);}}else if(f(s,"Target")){if(v1&&x&&w1&&u1){j=true;return false;}else{q.sap.log.warning(n.CARD_WARNING+n.INVALID_CRITICALITY);}}}else if(k&&k.Criticality){j=true;return false;}else{q.sap.log.warning(n.CARD_WARNING+n.INVALID_IMPROVEMENT_DIR);}}});if(j===true&&m.length>1){q.sap.log.warning(n.CARD_WARNING+n.INVALID_SEMANTIC_MEASURES);}return j;}function $(m,d,f,v){function i(A1,B1){return A1&&A1.indexOf(B1,A1.length-B1.length)!==-1;}var j=[null,null];var k=true;var s=m.Measure.PropertyPath;if(f[s]){if(f[s][l.LABEL_KEY_V4]){s=h1(f[s][l.LABEL_KEY_V4].String?f[s][l.LABEL_KEY_V4].String:f[s][l.LABEL_KEY_V4].Path,v,f);}else if(f[s][l.LABEL_KEY]){s=f[s][l.LABEL_KEY];}else if(s){s=s;}}var x=m.DataPoint.AnnotationPath;var u1=d[x.substring(1)];if(!u1.CriticalityCalculation||!u1.CriticalityCalculation.ImprovementDirection||!u1.CriticalityCalculation.ImprovementDirection.EnumMember){return j;}var v1=u1.CriticalityCalculation.ImprovementDirection.EnumMember;var w1=Y(u1.CriticalityCalculation.DeviationRangeLowValue,k);var x1=Y(u1.CriticalityCalculation.DeviationRangeHighValue,k);var y1=Y(u1.CriticalityCalculation.ToleranceRangeLowValue,k);var z1=Y(u1.CriticalityCalculation.ToleranceRangeHighValue,k);if(i(v1,"Minimize")||i(v1,"Minimizing")){if(z1&&x1){j[0]=h.getText("MINIMIZING_LESS",[s,z1]);j[1]=h.getText("MINIMIZING_MORE",[s,x1]);j[2]=h.getText("MINIMIZING_CRITICAL",[z1,s,x1]);}}else if(i(v1,"Maximize")||i(v1,"Maximizing")){if(y1&&w1){j[0]=h.getText("MAXIMISING_MORE",[s,y1]);j[1]=h.getText("MAXIMISING_LESS",[s,w1]);j[2]=h.getText("MAXIMIZING_CRITICAL",[w1,s,y1]);}}else if(i(v1,"Target")){if(y1&&w1&&z1&&x1){j[0]=h.getText("TARGET_BETWEEN",[y1,s,z1]);j[1]=h.getText("TARGET_AROUND",[s,w1,x1]);j[2]=h.getText("TARGET_CRITICAL",[w1,s,y1,z1,x1]);}}return j;}function _(m,v,d){if(v&&v.DataPoint&&v.DataPoint.AnnotationPath){var f=d[v.DataPoint.AnnotationPath.substring(1)];var i,j;if(f&&f.ValueFormat){i=f.ValueFormat;}else if(f&&f.NumberFormat){i=f.NumberFormat;}if(i&&i.NumberOfFractionalDigits&&i.NumberOfFractionalDigits.Int){j=i.NumberOfFractionalDigits.Int;if(m<Number(j)){m=Number(j);}}}return m;}function a1(m,v,d){if(v&&v.DataPoint&&v.DataPoint.AnnotationPath){var f=d[v.DataPoint.AnnotationPath.substring(1)];var s,i;if(f&&f.ValueFormat){s=f.ValueFormat;}else if(f&&f.NumberFormat){s=f.NumberFormat;}if(s){if(s.ScaleFactor&&s.ScaleFactor.Decimal){i=Number(s.ScaleFactor.Decimal);}else if(s.ScaleFactor&&s.ScaleFactor.Int){i=Number(s.ScaleFactor.Int);}if(!isNaN(i)){if(m===undefined){m=Number(i);}else if(m>Number(i)){m=Number(i);}}}}return m;}function b1(m,s){if(m&&m[s]&&(m[s]["Org.OData.Measures.V1.ISOCurrency"]||(m[s][l.SEMANTICS_KEY]&&m[s][l.SEMANTICS_KEY]===l.CURRENCY_CODE))){return true;}return false;}function c1(v,d){if(v.DataPoint&&v.DataPoint.AnnotationPath){var f=d[v.DataPoint.AnnotationPath.substring(1)];if(f&&f.ValueFormat&&f.ValueFormat.NumberOfFractionalDigits&&parseInt(f.ValueFormat.NumberOfFractionalDigits.Int,10)){return true;}}return false;}function d1(m,v,f){if(m[v[f].PropertyPath][l.EDM_TYPE]===l.EDM_INT32){return true;}return false;}function e1(m,v,f){if(m[v[f].PropertyPath][l.EDM_TYPE]===l.EDM_INT64){return true;}return false;}function f1(d,f,m,s){var x,u1,v1,w1;var x1,y1,z1,A1,B1;var C1;var D1,E1,F1;var G1,H1=[],I1=[];var J1;var K1;var L1=s&&s.getView();var M1,N1;x1=d.getVizType();y1=K();for(var O1 in y1){if((K1=y1[O1].reference)&&y1[K1]){var P1=q.extend(true,{},y1[K1]);y1[O1]=P1;}if(y1[O1].default.type===x1||(y1[O1].time&&y1[O1].time.type===x1)){z1=y1[O1];break;}}if(!z1){q.sap.log.error(n.CARD_ERROR+"in "+n.CARD_CONFIG+n.CARD_CONFIG_ERROR+x1+" "+n.CARD_CONFIG_JSON);return;}if(!(x=d.getModel('ovpCardProperties'))){q.sap.log.error(n.CARD_ERROR+"in "+n.CARD_CONFIG+n.NO_CARD_MODEL);return;}var Q1=d.getModel();var R1=x.getProperty("/entitySet");if(!Q1||!R1){return;}u1=x.getProperty("/entityType");if(!u1){q.sap.log.error(n.CARD_ANNO_ERROR+"in "+n.CARD_ANNO);return;}var S1=i1(Q1,R1);v1=x.getProperty("/chartAnnotationPath");if(!v1||!(w1=u1[v1])){q.sap.log.error(n.CARD_ANNO_ERROR+"in "+n.CARD_ANNO);return;}if(!(A1=w1.DimensionAttributes)||!A1.length){q.sap.log.error(n.CHART_ANNO_ERROR+"in "+n.CHART_ANNO+" "+n.DIMENSIONS_MANDATORY);return;}var T1;if(!(B1=w1.MeasureAttributes)||!B1.length){q.sap.log.error(n.CHART_ANNO_ERROR+"in "+n.CHART_ANNO+" "+n.MEASURES_MANDATORY);return;}else{var U1=B1[0].DataPoint?u1[B1[0].DataPoint.AnnotationPath.substring(1)]:null;var V1=U1&&U1.ValueFormat&&U1.ValueFormat.NumberOfFractionalDigits&&U1.ValueFormat.NumberOfFractionalDigits.Int;T1=V1?V1:0;}J1=L(A1,z1,Q1,R1);if(J1){z1=z1.time;}else{z1=z1.default;}var W1=x.getProperty("/ChartProperties")||x.getProperty("/chartProperties");if(x&&x.getProperty("/tabs")&&(W1===undefined)){M1=L1.byId("ovp_card_dropdown");N1=parseInt(M1.getSelectedKey(),10);W1=x.getProperty("/tabs")&&x.getProperty("/tabs")[N1-1]&&(x.getProperty("/tabs")[N1-1]["ChartProperties"]||x.getProperty("/tabs")[N1-1]["chartProperties"]);}var X1=false;var Y1=T1>0?"tooltipNoScaleFormatter/"+T1.toString()+"/":'tooltipNoScaleFormatter/-1/';var Z1=new b({formatString:Y1});Z1.connect(d.getVizUid());Z1.connect(d.getVizUid());d._oOvpVizFrameTooltip=Z1;[z1.dimensions,z1.measures].forEach(function(j,i){var k=i?B1:A1;var v=i?"measure(s)":"dimension(s)";if(j.min&&k.length<j.min){q.sap.log.error(n.CARD_ERROR+"in "+x1+" "+n.CARD_LEAST+j.min+" "+v);X1=true;}if(j.max&&k.length>j.max){q.sap.log.error(n.CARD_ERROR+"in "+x1+n.CARD_MOST+j.max+" "+v);X1=true;}});if(X1){return;}var $1=true;if(z1.properties&&z1.properties.hasOwnProperty("hideLabel")&&!z1.properties["hideLabel"]){$1=false;}var _1=true;var a2=false;if(x1==='donut'){a2=true;}d.removeAllAggregation();C1={legend:{isScrollable:false},title:{visible:false},interaction:{noninteractiveMode:_1?false:true,selectability:{legendSelection:a2?true:false,axisLabelSelection:false,mode:'EXCLUSIVE',plotLassoSelection:false,plotStdSelection:true},zoom:{enablement:'disabled'}},plotArea:{window:{start:'firstDataPoint',end:'lastDataPoint'},dataLabel:{visible:a2?true:false,type:'value'},dataPoint:{invalidity:'ignore'}},categoryAxis:{label:{truncatedLabelRatio:0.15}},general:{groupData:false,showAsUTC:true}};if(z1.properties&&z1.properties.semanticColor===true&&Z(B1,u1)){var b2=h.getText("GOOD");var c2=h.getText("BAD");var d2=h.getText("CRITICAL");var e2=h.getText("OTHERS");if(B1.length===1){var f2=$(B1[0],u1,S1,d);var b2=f2[0]||b2,c2=f2[1]||c2,d2=f2[2]||d2,e2=h.getText("OTHERS");}C1.plotArea.dataPointStyle={rules:[{callback:function(i){var j=X(i,S1,B1);if(!j){return false;}var k=u1[j.substring(1)];var v=W(i,k);if(v===a.criticalityConstants.StateValues.Positive){return true;}else if(v==="Positive"){return true;}},properties:{color:"sapUiChartPaletteSemanticGoodLight1"},"displayName":b2},{callback:function(i){var j=X(i,S1,B1);if(!j){return false;}var k=u1[j.substring(1)];var v=W(i,k);if(v===a.criticalityConstants.StateValues.Critical){return true;}else if(v==="Critical"){return true;}},properties:{color:"sapUiChartPaletteSemanticCriticalLight1"},"displayName":d2},{callback:function(i){var j=X(i,S1,B1);if(!j){return false;}var k=u1[j.substring(1)];var v=W(i,k);if(v===a.criticalityConstants.StateValues.Negative){return true;}else if(v==="Negative"){return true;}},properties:{color:"sapUiChartPaletteSemanticBadLight1"},"displayName":c2},{callback:function(i){var j=X(i,S1,B1);if(!j){return false;}var k=u1[j.substring(1)];var v=W(i,k);if(v===a.criticalityConstants.StateValues.None){return true;}else if(v==="Neutral"){return true;}},properties:{color:"sapUiChartPaletteSemanticNeutralLight1"},"displayName":e2}]};}var g2=x.getProperty("/bEnableStableColors");var h2=x.getProperty("/colorPalette");var i2;if(!g2&&(w1.ChartType.EnumMember===l.COLUMNSTACKED_CHARTTYPE||w1.ChartType.EnumMember===l.DONUT_CHARTTYPE||w1.ChartType.EnumMember===l.COLUMN_CHARTTYPE||w1.ChartType.EnumMember===l.VERTICALBULLET_CHARTTYPE||w1.ChartType.EnumMember===l.LINE_CHARTTYPE||w1.ChartType.EnumMember===l.COMBINATION_CHARTTYPE||w1.ChartType.EnumMember===l.BUBBLE_CHARTTYPE)&&h2&&h2.length>=2&&h2.length<=4){q.each(A1,function(i,j){if(j&&j.Role&&j.Role.EnumMember==="com.sap.vocabularies.UI.v1.ChartDimensionRoleType/Series"){i2=j.Dimension&&j.Dimension.PropertyPath;return;}});var j2;if(i2){if(S1&&S1[i2]){if(S1[i2][l.LABEL_KEY_V4]){j2=h1(S1[i2][l.LABEL_KEY_V4].String?S1[i2][l.LABEL_KEY_V4].String:S1[i2][l.LABEL_KEY_V4].Path,d,S1);}else if(S1[i2][l.LABEL_KEY]){j2=S1[i2][l.LABEL_KEY];}else if(i2){j2=i2;}}var k2=h2.map(function(v){return v.color;});var l2=h2.map(function(v){return v.legendText;});var m2=l2[0]!=undefined?l2[0]:h.getText("OTHERS");var n2=l2[1]!=undefined?l2[1]:h.getText("BAD");var o2=l2[2]!=undefined?l2[2]:h.getText("CRITICAL");var p2=l2[3]!=undefined?l2[3]:h.getText("GOOD");C1.plotArea.dataPointStyle={rules:[{callback:function(i){if(i&&(i[j2]==="3"||i[j2]===3)){if(h2.length<4){return false;}return true;}},properties:{color:k2[3]},"displayName":p2},{callback:function(i){if(i&&(i[j2]==="2"||i[j2]===2)){if(h2.length<3){return false;}return true;}},properties:{color:k2[2]},"displayName":o2},{callback:function(i){if(i&&(i[j2]==="1"||i[j2]===1)){return true;}},properties:{color:k2[1]},"displayName":n2},{callback:function(i){if(i&&(i[j2]==="0"||i[j2]===0)){return true;}},properties:{color:k2[0]},"displayName":m2}]};}}var q2=false;if(w1.ChartType.EnumMember===l.SCATTER_CHARTTYPE||w1.ChartType.EnumMember===l.BUBBLE_CHARTTYPE||w1.ChartType.EnumMember===l.LINE_CHARTTYPE){if(w1&&w1.AxisScaling&&w1.AxisScaling.EnumMember){var r2=w1.AxisScaling.EnumMember.substring(w1.AxisScaling.EnumMember.lastIndexOf('/')+1,w1.AxisScaling.EnumMember.length);switch(r2){case"AdjustToDataIncluding0":C1.plotArea.adjustScale=false;q2=true;break;case"AdjustToData":C1.plotArea.adjustScale=true;q2=true;break;case"MinMaxValues":var s2=[];if(w1["MeasureAttributes"][0]&&w1["MeasureAttributes"][0].DataPoint&&w1["MeasureAttributes"][0].DataPoint.AnnotationPath){var t2=w1["MeasureAttributes"][0].DataPoint.AnnotationPath;var u2=t2.substring(t2.lastIndexOf('@')+1,t2.length);if(u1&&u1[u2]){var v2=u1[u2];if(v2&&v2.MaximumValue&&v2.MaximumValue.Decimal&&v2.MinimumValue&&v2.MinimumValue.Decimal){s2.push({feed:"valueAxis",max:v2.MaximumValue.Decimal,min:v2.MinimumValue.Decimal});q2=true;}else{q.sap.log.error(n.ERROR_MISSING_AXISSCALES);}}}if(w1.ChartType.EnumMember!==l.LINE_CHARTTYPE&&w1["MeasureAttributes"][1]&&w1["MeasureAttributes"][1].DataPoint&&w1["MeasureAttributes"][1].DataPoint.AnnotationPath){var t2=w1["MeasureAttributes"][1].DataPoint.AnnotationPath;var u2=t2.substring(t2.lastIndexOf('@')+1,t2.length);if(u1&&u1[u2]){var v2=u1[u2];if(v2&&v2.MaximumValue&&v2.MaximumValue.Decimal&&v2.MinimumValue&&v2.MinimumValue.Decimal){s2.push({feed:"valueAxis2",max:v2.MaximumValue.Decimal,min:v2.MinimumValue.Decimal});q2=true;}else{q.sap.log.error(n.ERROR_MISSING_AXISSCALES);}}}d.setVizScales(s2);break;default:break;}}}E1=A1.slice();F1=B1.slice();var w2=0;var x2=0;var y2;var z2;var A2=false;var B2=false;var C2=false;var D2=false;var E2=false;var F2;var G2=[];var H2=[],I2=[];if((x1==="column"||x1==="vertical_bullet")&&z1.feeds&&(z1.feeds.length>0)){var J2;for(J2=0;J2<z1.feeds.length;J2++){if(z1.feeds[J2].uid==="color"){z1.feeds.splice(J2,1);break;}}for(J2=0;J2<z1.feeds.length;J2++){if(z1.feeds[J2].uid==="categoryAxis"){delete z1.feeds[J2].role;break;}}if(x.getProperty("/colorPalette")){for(J2=0;J2<z1.feeds.length;J2++){if(z1.feeds[J2].uid==="categoryAxis"){z1.feeds[J2].role="Category";break;}}z1.feeds.push({"uid":"color","min":1,"type":"dimension","role":"Series"});}}q.each(z1.feeds,function(i,v){var Q2=v.uid;var R2=[];if(v.type){var S2,T2,U2;if(v.type==="dimension"){S2=A1.length;T2="Dimension";U2="dimensions";D1=E1;G1=H1;}else{S2=B1.length;T2="Measure";U2="measures";D1=F1;G1=I1;}var V2=0,W2=S2;if(v.min){V2=V2>v.min?V2:v.min;}if(v.max){W2=W2<v.max?W2:v.max;}if(!v.role){var X2=D1.length;for(var j=0;j<X2&&R2.length<W2;++j){var Y2=D1[j];D1.splice(j,1);--X2;--j;R2.push(Y2);if(S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_ISOCurrency]){F2=S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_ISOCurrency].Path?S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_ISOCurrency].Path:undefined;}else if(S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_Unit]){F2=S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_Unit].Path?S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_Unit].Path:undefined;}else if(S1[Y2[T2].PropertyPath][l.UNIT_KEY]){F2=S1[Y2[T2].PropertyPath][l.UNIT_KEY];}if(!D2){D2=d1(S1,Y2,T2);}if(!E2){E2=e1(S1,Y2,T2);}if(b1(S1,F2)){A2=true;}else{B2=true;}if(!C2){C2=c1(Y2,u1);}if(!A2){w2=_(w2,Y2,u1);y2=a1(y2,Y2,u1);}else{x2=_(x2,Y2,u1);z2=a1(z2,Y2,u1);}}}else{var Z2=v.role.split("|");q.each(Z2,function(j,q3){if(R2.length===W2){return false;}var X2=D1.length;for(var k=0;k<X2&&R2.length<W2;++k){var Y2=D1[k];if(Y2&&Y2.Role&&Y2.Role.EnumMember&&Y2.Role.EnumMember.split("/")&&Y2.Role.EnumMember.split("/")[1]){var r3=Y2.Role.EnumMember.split("/")[1];if(r3===q3){D1.splice(k,1);--X2;--k;R2.push(Y2);if(S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_ISOCurrency]){F2=S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_ISOCurrency].Path?S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_ISOCurrency].Path:undefined;}else if(S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_Unit]){F2=S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_Unit].Path?S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_Unit].Path:undefined;}else if(S1[Y2[T2].PropertyPath][l.UNIT_KEY]){F2=S1[Y2[T2].PropertyPath][l.UNIT_KEY];}if(b1(S1,F2)){A2=true;}else{B2=true;}if(!D2){D2=d1(S1,Y2,T2);}if(!E2){E2=e1(S1,Y2,T2);}if(!C2){C2=c1(Y2,u1);}if(!A2){w2=_(w2,Y2,u1);y2=a1(y2,Y2,u1);}else{x2=_(x2,Y2,u1);z2=a1(z2,Y2,u1);}}}else if(q.inArray(Y2,G1)===-1){G1.push(Y2);}}});if(R2.length<W2){q.each(G1,function(k,Y2){var q3;var J2;if((q3=z1[U2].defaultRole)&&(q.inArray(q3,Z2)!==-1)&&(J2=q.inArray(Y2,D1))!==-1){D1.splice(J2,1);R2.push(Y2);if(S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_ISOCurrency]){F2=S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_ISOCurrency].Path?S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_ISOCurrency].Path:undefined;}else if(S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_Unit]){F2=S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_Unit].Path?S1[Y2[T2].PropertyPath][l.UNIT_KEY_V4_Unit].Path:undefined;}else if(S1[Y2[T2].PropertyPath][l.UNIT_KEY]){F2=S1[Y2[T2].PropertyPath][l.UNIT_KEY];}if(b1(S1,F2)){A2=true;}else{B2=true;}if(!D2){D2=d1(S1,Y2,T2);}if(!E2){E2=e1(S1,Y2,T2);}if(!C2){C2=c1(Y2,u1);}if(!A2){w2=_(w2,Y2,u1);y2=a1(y2,Y2,u1);}else{x2=_(x2,Y2,u1);z2=a1(z2,Y2,u1);}if(R2.length===W2){return false;}}});}if(R2.length<V2){q.sap.log.error(n.CARD_ERROR+n.MIN_FEEDS+x1+" "+n.FEEDS_OBTAINED+R2.length+" "+n.FEEDS_REQUIRED+V2+" "+n.FEEDS);return false;}}if(R2.length){var $2=[];var _2;if(!(_2=d.getDataset())){q.sap.log.error(n.NO_DATASET);return false;}G=u1;q.each(R2,function(i,Y2){if(!Y2||!Y2[T2]||!Y2[T2].PropertyPath){q.sap.log.error(n.INVALID_CHART_ANNO);return false;}var k=Y2[T2].PropertyPath;var j2=k;var q3=k;var r3=null;if(S1&&S1[k]){if(S1[k][l.LABEL_KEY_V4]){if(S1[k][l.LABEL_KEY_V4].String){j2=h1(S1[k][l.LABEL_KEY_V4].String,d,S1);}else if(S1[k][l.LABEL_KEY_V4].Path){j2=S1[k][l.LABEL_KEY_V4].Path;}else{j2=k;}}else if(S1[k][l.LABEL_KEY]){j2=S1[k][l.LABEL_KEY];}else if(k){j2=k;}if(S1[k][l.TEXT_KEY_V4]){q3=S1[k][l.TEXT_KEY_V4].String?S1[k][l.TEXT_KEY_V4].String:S1[k][l.TEXT_KEY_V4].Path;}else if(S1[k][l.TEXT_KEY]){q3=S1[k][l.TEXT_KEY];}else if(k){q3=k;}r3=S1[k][l.TYPE_KEY]||null;}var s3;if((r3==="Edm.DateTime"||r3==="Edm.DateTimeOffset")&&q3===k){s3="{path:'"+k+"', formatter: 'sap.ovp.cards.charts.VizAnnotationManager.returnDateFormat'}";}else{if(S1[k]&&S1[k][l.TEXT_KEY_V4]&&S1[k][l.TEXT_KEY_V4][l.TEXT_ARRANGEMENT_ANNO]){var t3,u3;t3=S1[k][l.TEXT_ARRANGEMENT_ANNO];u3=t3&&t3.EnumMember;if(!u3){t3=S1[k][l.TEXT_KEY_V4][l.TEXT_ARRANGEMENT_ANNO];u3=t3&&t3.EnumMember;}if(!u3){var v3=G;t3=v3&&v3[l.TEXT_ARRANGEMENT_ANNO];u3=t3&&t3.EnumMember;}switch(u3){case"com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst":s3="{"+q3+"}"+" "+"("+"{"+k+"}"+")";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextLast":s3="{"+k+"}"+" "+"("+"{"+q3+"}"+")";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly":s3="{"+q3+"}";break;case"com.sap.vocabularies.UI.v1.TextArrangementType/TextSeperate":s3="{"+k+"}"+" "+"("+"{"+q3+"}"+")";break;default:s3="{"+k+"}";break;}}else{s3="{"+q3+"}";}}$2.push(j2);if(T2==="Dimension"){if(Q2==="waterfallType"){var w3=new e({name:j2,value:"{"+k+"}"});}else{var w3=new e({name:j2,value:"{"+k+"}",displayValue:s3});}var x3=S1[k][l.SEMANTICS_KEY];var y3=S1[k]["com.sap.vocabularies.Common.v1.IsCalendarYear"]&&S1[k]["com.sap.vocabularies.Common.v1.IsCalendarYear"].Bool;if(J1&&(r3==="Edm.DateTime"||y3||r3==="Edm.DateTimeOffset"||(x3&&x3.lastIndexOf("year",0)===0))){w3.setDataType("date");}_2.addDimension(w3);if(q.inArray(j2,I2)===-1){I2.push(j2);}}else{_2.addMeasure(new M({name:j2,value:"{"+k+"}"}));if((q.inArray(j2,H2)===-1)&&(Q2!="bubbleWidth")){H2.push(j2);}}});d.addFeed(new F({'uid':Q2,'type':T2,'values':$2}));if(Q2==="categoryAxis"){C1[Q2]={title:{visible:$1?false:true,text:$2.join(", ")},label:{formatString:A2?'CURR':'axisFormatter',truncatedLabelRatio:0.15}};}else{C1[Q2]={title:{visible:$1?false:true,text:$2.join(", ")},label:{formatString:A2?'CURR':'axisFormatter'}};}G2.push(C1[Q2]);if(z1.hasOwnProperty("vizProperties")){var a3=0;var b3=z1.vizProperties.length;var c3;var d3;for(;a3<b3;a3++){if(z1.vizProperties[a3].hasOwnProperty("value")){d3=z1.vizProperties[a3].value;}if(z1.vizProperties[a3].hasOwnProperty("path")){c3=(z1.vizProperties[a3].path).split(".");var e3=c3.length;var f3,g3;var h3;for(var i3=0,h3=c3[0],f3=C1,g3=W1;i3<e3;++i3){if(i3===e3-1){if(g3&&g3.hasOwnProperty(h3)){if(x1==='donut'&&(g3[h3]==="value"||g3[h3]==="percentage")){d3=g3[h3];}else if(x1!='donut'){d3=g3[h3];}}if((q2&&(h3!="adjustScale"))||(!q2&&(h3==="adjustScale"))||(!q2&&(h3!="adjustScale"))){f3[h3]=d3;}break;}f3[h3]=f3[h3]||{};f3=f3[h3];if(g3){g3[h3]=g3[h3]||{};g3=g3[h3];}h3=c3[i3+1];}}}}if(v.hasOwnProperty("vizProperties")){var i=0;var j3=v.vizProperties.length;var k3;var l3;var m3;for(;i<j3;i++){if(v.vizProperties[i].hasOwnProperty("method")){l3=v.vizProperties[i].method;switch(l3){case'count':k3=$2.length;if(v.vizProperties[i].hasOwnProperty("min")&&k3<=v.vizProperties[i].min){k3=v.vizProperties[i].min;}else if(v.vizProperties[i].hasOwnProperty("max")&&k3>=v.vizProperties[i].max){k3=v.vizProperties[i].max;}break;}}else if(v.vizProperties[i].hasOwnProperty("value")){k3=v.vizProperties[i].value;}if(v.vizProperties[i].hasOwnProperty("path")){m3=(v.vizProperties[i].path).split(".");var n3=m3.length;var o3;var p3;for(var j=0,p3=m3[0],o3=C1;j<n3;++j){if(j===n3-1){o3[p3]=k3;break;}o3[p3]=o3[p3]||{};o3=o3[p3];p3=m3[j+1];}}}}}}});var K2=d.getFeeds();if(z1.properties&&z1.properties.semanticPattern===true&&y(K2,x1)){q.each(K2,function(i,v){if(K2[i].getType()==='Measure'&&((K2[i].getUid()==='valueAxis')||(K2[i].getUid()==='actualValues'))){var j;q.each(B1,function(J2,V2){var W2=w(V2.Measure.PropertyPath,S1);if(W2===K2[i].getValues()[0]){j=t(V2,u1);return false;}});if(j){var k=w(j.Measure.PropertyPath,S1);var Q2=(u1[j.DataPoint.AnnotationPath.substring(1)].ForecastValue.PropertyPath||u1[j.DataPoint.AnnotationPath.substring(1)].ForecastValue.Path);var R2=w(Q2,S1);var S2=h.getText("ACTUAL",[k]);var T2=h.getText("FORECAST",[R2]);C1.plotArea.dataPointStyle={rules:[{dataContext:{MeasureNamesDimension:k},properties:{color:"sapUiChartPaletteSequentialHue1Light1",lineType:"line",lineColor:"sapUiChartPaletteSequentialHue1Light1"},displayName:S2},{dataContext:{MeasureNamesDimension:R2},properties:{color:"sapUiChartPaletteSequentialHue1Light1",lineType:"dotted",lineColor:"sapUiChartPaletteSequentialHue1Light1",pattern:"diagonalLightStripe"},displayName:T2}]};d.getDataset().addMeasure(new M({name:R2,value:"{"+Q2+"}"}));var U2=K2[i].getValues();U2.push(R2);K2[i].setValues(U2);}return false;}});}if(z1.properties&&z1.properties.semanticPattern===true&&y(K2,x1)&&d.getVizType()==="vertical_bullet"){q.each(K2,function(i,v){if(K2[i].getType()==='Measure'&&((K2[i].getUid()==='valueAxis')||(K2[i].getUid()==='actualValues'))){var j;q.each(B1,function(J2,R2){var S2=w(R2.Measure.PropertyPath,S1);if(S2===K2[i].getValues()[0]){j=u(R2,u1);return false;}});if(j){var k=(u1[j.DataPoint.AnnotationPath.substring(1)].TargetValue.PropertyPath||u1[j.DataPoint.AnnotationPath.substring(1)].TargetValue.Path);var Q2=w(k,S1);d.getDataset().addMeasure(new M({name:Q2,value:"{"+k+"}"}));d.addFeed(new F({'uid':"targetValues",'type':"Measure",'values':[Q2]}));}return false;}});}if(A2&&B2){q.sap.log.warning(h.getText("Currency_non_currency_measure"));}if((D2||E2)&&!C2){x2=w2=-1;if(C1&&(C1["valueAxis"]||C1["valueAxis2"])){if(C1["valueAxis"]){if(C1["valueAxis"].label){C1["valueAxis"].label.allowDecimals=false;}else{C1["valueAxis"].label={allowDecimals:false};}}else{C1["valueAxis"]={label:{allowDecimals:false}};}if(C1["valueAxis2"]){if(C1["valueAxis2"].label){C1["valueAxis2"].label.allowDecimals=false;}else{C1["valueAxis2"].label={allowDecimals:false};}}else{C1["valueAxis2"]={label:{allowDecimals:false}};}}}else if(!(D2||E2)&&!C2){x2=w2=-1;}var L2;if(z2===undefined){z2="";}if(y2===undefined){y2="";}if(A2){L2=k1(z2,A2);}else{L2=k1(y2,A2);}if(f){f.setScale(L2);}j1(H2,I2,m);var M2="";q.each(G2,function(i,j){var k=j.label.formatString;M2="";if(A2){if(k==='CURR'){M2='CURR/'+x2.toString()+"/";}else{M2='axisFormatter/'+x2.toString()+"/";}}else{M2='axisFormatter/'+w2.toString()+"/";}j.label.formatString=M2;});if(x1==="vertical_bullet"){C1["valueAxis"]={title:{visible:$1?false:true},label:{formatString:M2}};}var N2="";var O2="";if(A2){N2=x2.toString();O2='CURR/'+x2.toString()+"/";}else{N2=w2.toString();O2='axisFormatter/'+w2.toString()+"/";}if(x1==="donut"){C1.plotArea.dataLabel.formatString=O2;if(C1.plotArea.dataLabel.type==="percentage"){C1.plotArea.dataLabel.formatString="0.0%/"+N2+"/";}}Q(E1,z1,"dimension");Q(F1,z1,"measure");if(J1){var P2=A1[0].Dimension.PropertyPath;if(S1[P2][l.SEMANTICS_KEY]==='yearmonth'||S1[P2]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){C1.timeAxis.levels=["year","month"];}else if(S1[P2][l.SEMANTICS_KEY]==='yearquarter'||S1[P2]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){C1.timeAxis.levels=["quarter"];}else if(S1[P2][l.SEMANTICS_KEY]==='yearweek'||S1[P2]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){C1.timeAxis.levels=["week"];}}d.setVizProperties(C1);}function g1(v,d,f){if(v&&(v.getVizType()==="bubble"||v.getVizType()==="scatter")){return;}var j,k,s,x;var u1;var v1=l.UNIT_KEY;var w1=l.UNIT_KEY_V4_ISOCurrency;var x1=l.UNIT_KEY_V4_Unit;var y1;var z1=[];if(!(j=v.getModel('ovpCardProperties'))){q.sap.log.error(n.CARD_ERROR+"in "+n.CARD_CONFIG+n.NO_CARD_MODEL);return;}var A1=v.getModel();var B1=j.getProperty("/entitySet");if(!A1||!B1){return;}k=j.getProperty("/entityType");if(!k){q.sap.log.error(n.CARD_ANNO_ERROR+"in "+n.CARD_ANNO);return;}var C1=i1(A1,B1);s=j.getProperty("/chartAnnotationPath");if(!s||!(x=k[s])){q.sap.log.error(n.CARD_ANNO_ERROR+"in "+n.CARD_ANNO);return;}if(!(u1=x.MeasureAttributes)||!u1.length){q.sap.log.error(n.CHART_ANNO_ERROR+"in "+n.CHART_ANNO+" "+n.MEASURES_MANDATORY);return;}q.each(u1,function(i,m){y1=m.Measure.PropertyPath;if(m.DataPoint&&m.DataPoint.AnnotationPath){var J1=k[m.DataPoint.AnnotationPath.substring(1)];if(J1.ForecastValue&&(J1.ForecastValue.PropertyPath||J1.ForecastValue.Path)){z1.push((J1.ForecastValue.PropertyPath||J1.ForecastValue.Path));}}z1.push(y1);});var D1=d?d.results:null;var E1="";var F1=true;var G1=[];var H1=v.getFeeds();q.each(H1,function(i,m){if(m.getType()==="Measure"){G1=G1.concat(m.getValues());}});if(D1){q.each(z1,function(i,m){var J1="";if(C1&&C1[m]){if(C1[m][l.LABEL_KEY_V4]){J1=h1(C1[m][l.LABEL_KEY_V4].String?C1[m][l.LABEL_KEY_V4].String:C1[m][l.LABEL_KEY_V4].Path,v,C1);}else if(C1[m][l.LABEL_KEY]){J1=C1[m][l.LABEL_KEY];}else if(m){J1=m;}}if(q.inArray(J1,G1)!=-1){if(C1&&C1[m]){var K1;if(C1[m][w1]){K1=C1[m][w1].Path?C1[m][w1].Path:C1[m][w1].String;}else if(C1[m][x1]){K1=C1[m][x1].Path?C1[m][x1].Path:C1[m][x1].String;}else if(C1[m][v1]){K1=C1[m][v1];}if(!K1){F1=false;return false;}if(K1&&C1[K1]){for(var i=0;i<D1.length;i++){var L1=D1[i];if(F1){if(E1&&L1[K1]&&(L1[K1]!="")&&(E1!="")&&(E1!=L1[K1])){F1=false;break;}}E1=L1[K1];}}}}});}var I1="";if(F1){if(E1!=""){I1=h.getText("IN_NO_SCALE",[E1]);I1=" "+I1;}if(f){f.setText(I1);f.data("aria-label",I1,true);}}}function h1(f,v,m){var s;var d;var i;if(f.indexOf("{")===0){f=f.slice(1,-1);if(f.indexOf(">")!=-1){i=f.split(">");s=i[0];d=i[1];}else if(f.indexOf("&gt;")!=-1){i=f.split("&gt;");s=i[0];d=i[1];}try{f=v.getModel(s).getProperty(d);}catch(j){f=m[f][l.LABEL_KEY_V4].String;q.sap.log.error("Unable to read labels from resource file",j);}}return f;}function i1(m,d){var f=U.cacheODataMetadata(m);if(!f){return undefined;}return f[d];}function j1(m,d,f){var j="",k="",s="";if(f){j=f.getText();}if(m&&(m.length>1)){for(var i=0;i<m.length-1;i++){if(k!=""){k+=", ";}k+=m[i];}k=h.getText("MEAS_DIM_TITLE",[k,m[i]]);}else if(m){k=m[0];}if(d&&(d.length>1)){for(var i=0;i<d.length-1;i++){if(s!=""){s+=", ";}s+=d[i];}s=h.getText("MEAS_DIM_TITLE",[s,d[i]]);}else if(d){s=d[0];}if(f&&(j==="")){j=h.getText("NO_CHART_TITLE",[k,s]);f.setText(j);f.data("aria-label",j,true);}}function k1(m,i){var d=1;var s;if(i){var f=N.getCurrencyInstance({style:'short',currencyCode:false,shortRefNumber:m});s=f.format(Number(d));}else{var j=N.getFloatInstance({style:'short',shortRefNumber:m});s=j.format(Number(d));}var k=s.slice(-1);return k;}function l1(v,d){v.attachSelectData(function(f){var m=v.getModel('ovpCardProperties');var s=v.getModel();var u1=m.getProperty("/entitySet");var v1=i1(s,u1);var w1=[],x1=[];var y1={},z1={};var A1=v.getDataset().getDimensions();var B1;for(var i=0;i<A1.length;i++){w1.push(A1[i].getName());}var C1=q.map(v.getDataset().getBinding("data").getCurrentContexts(),function(x){return x.getObject();});if(f.getParameter("data")&&f.getParameter("data")[0]&&f.getParameter("data")[0].data){B1=f.getParameter("data")[0].data._context_row_number;var D1=v.getDataset().getBinding("data").getContexts()[B1];var E1=d.getEntityNavigationEntries(D1)[0];if(C1[B1].$isOthers&&C1[B1].$isOthers===true){var F1={$isOthers:true};var G1={getObject:function(){return F1;}};if(O.checkIfAPIIsUsed(d)){if(d.checkNavigation()){c.onContentClicked(G1);}}else{if(E1){d.doNavigation(G1,E1);}}}else{x1=Object.keys(f.getParameter("data")[0].data);for(var j=0;j<w1.length;j++){for(var k=0;k<x1.length;k++){if(w1[j]===x1[k]){for(var H1 in v1){if(v1.hasOwnProperty(H1)){var I1=v1[H1][l.LABEL_KEY]||v1[H1][l.NAME_KEY]||v1[H1][l.NAME_CAP_KEY];if(I1===x1[k]){y1[H1]=C1[B1][H1];}}}}for(var H1 in C1[B1]){if(v1.hasOwnProperty(H1)){z1[H1]=C1[B1][H1];}}}}if(y1){q.each(Object.keys(y1),function(i,H1){if(v1[H1]["type"]==="Edm.String"){if(v1[H1]["sap:semantics"]==="yearmonth"||v1[H1]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){y1[H1]=(y1[H1].constructor===Date?D.getDateTimeInstance({pattern:"YYYYMM"}).format(y1[H1]):y1[H1]);}else if(v1[H1]["sap:semantics"]==="yearquarter"||v1[H1]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){y1[H1]=(y1[H1].constructor===Date?D.getDateTimeInstance({pattern:"YYYYQ"}).format(y1[H1]):y1[H1]);}else if(v1[H1]["sap:semantics"]==="yearweek"||v1[H1]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){y1[H1]=(y1[H1].constructor===Date?D.getDateTimeInstance({pattern:"YYYYww"}).format(y1[H1]):y1[H1]);}}});}if(z1){q.each(Object.keys(z1),function(i,H1){if(v1[H1]["type"]==="Edm.String"){if(v1[H1]["sap:semantics"]==="yearmonth"||v1[H1]["com.sap.vocabularies.Common.v1.IsCalendarYearMonth"]){z1[H1]=(z1[H1].constructor===Date?D.getDateTimeInstance({pattern:"YYYYMM"}).format(z1[H1]):z1[H1]);}else if(v1[H1]["sap:semantics"]==="yearquarter"||v1[H1]["com.sap.vocabularies.Common.v1.IsCalendarYearQuarter"]){z1[H1]=(z1[H1].constructor===Date?D.getDateTimeInstance({pattern:"YYYYQ"}).format(z1[H1]):z1[H1]);}else if(v1[H1]["sap:semantics"]==="yearweek"||v1[H1]["com.sap.vocabularies.Common.v1.IsCalendarYearWeek"]){z1[H1]=(z1[H1].constructor===Date?D.getDateTimeInstance({pattern:"YYYYww"}).format(z1[H1]):z1[H1]);}}});}var G1={getObject:function(){return y1;},getAllData:function(){return z1;}};if(O.checkIfAPIIsUsed(d)){if(d.checkNavigation()){c.onContentClicked(G1);}}else{if(E1){d.doNavigation(G1,E1);}}}}});}function m1(d){if(d.EnumMember.endsWith("Bubble")){return true;}else{return false;}}function n1(d){var f=false;if(!d||d.constructor!=Array||d.length<1||d[0].constructor!=Object||!d[0].Dimension||!d[0].Dimension.PropertyPath){q.sap.log.error(n.CHART_ANNO_ERROR+"in "+n.CHART_ANNO+" "+n.DIMENSIONS_MANDATORY);return f;}f=true;return f;}function o1(m){var d=false;if(!m||m.constructor!=Array||m.length<1||m[0].constructor!=Object||!m[0].Measure||!m[0].Measure.PropertyPath){q.sap.log.error(n.CHART_ANNO_ERROR+"in "+n.CHART_ANNO+" "+n.MEASURES_MANDATORY);return d;}d=true;return d;}function p1(d){return d.name;}function q1(d){if(d&&d.indexOf("#")!=-1){var f=d.split("#");if(f.length>1){return f[1];}}return"";}function r1(d,v){var f=v.getModel('ovpCardProperties');var i=s1(v);var m=+i.itemsLength;var j=+f.getProperty("/dataStep");if(m&&j){var k=d.colSpan-1;if(k>=0){m+=j*k;t1(v,m);}}}function s1(v){var d=v.getModel('ovpCardProperties');var f=d.getProperty("/entityType");var i=d.getProperty("/presentationAnnotationPath");var j=f.hasOwnProperty(i)&&f[i];var m=j&&j.MaxItems;if(m){var k=m.Int32?m.Int32:m.Int;return{itemsLength:+k,dataStep:+d.getProperty("/dataStep")};}}function t1(v,d){var f,j={},k=[];var s=v.getVizType();var x=v.getModel('ovpCardProperties');var u1=x.getProperty("/entityType");var v1=x.getProperty("/chartAnnotationPath");var w1=u1[v1];var x1=v.getParent();var y1=x1.getBinding("data");j.path=y1.getPath();j.parameters={};if(y1.mParameters&&y1.mParameters.select){j.parameters.select=y1.mParameters.select;}j.filters=y1.aApplicationFilters;j.sorter=y1.aSorters;j.length=(s==="donut")?d+1:d;j.template=new g();x1.bindAggregation("data",j);if(s==="donut"){q.each(w1.MeasureAttributes,function(i,m){k.push(m.Measure.PropertyPath);});f={};f.path=y1.getPath();f.parameters={};f.parameters.select=k.join(",");f.filters=y1.aApplicationFilters;f.sorter=y1.aSorters;f.length=1;f.template=new g();x1.bindAggregation("aggregateData",f);}x1.updateBindingContext();}return{constants:l,errorMessages:n,formatItems:o,formatByType:z,returnDateFormat:A,formatChartAxes:B,hideDateTimeAxis:E,checkExists:H,validateCardConfiguration:I,checkNoData:J,getConfig:K,hasTimeSemantics:L,getChartType:P,getPrimitiveValue:R,formThePathForCriticalityStateCalculation:W,checkFlag:Z,buildVizAttributes:f1,setChartUoMTitle:g1,getMetadata:i1,getSelectedDataPoint:l1,checkBubbleChart:m1,dimensionAttrCheck:n1,measureAttrCheck:o1,getEntitySet:p1,getAnnotationQualifier:q1,reprioritizeContent:r1,getMaxItems:s1,getLabelFromAnnotationPath:h1};},true);
