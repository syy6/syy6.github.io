sap.ui.define(["sap/ovp/cards/generic/Card.controller","jquery.sap.global","sap/ovp/cards/charts/VizAnnotationManager","sap/ui/comp/odata/MetadataAnalyser","sap/ovp/cards/charts/SmartAnnotationManager","sap/ui/model/Filter","sap/ovp/cards/AnnotationHelper","sap/ui/model/Sorter","sap/ovp/app/resources"],function(C,q,V,M,S,F,A,a,O){"use strict";return C.extend("sap.ovp.cards.charts.smart.chart.analyticalChart",{onInit:function(){C.prototype.onInit.apply(this,arguments);V.formatChartAxes();this.bFlag=true;var e=M.prototype._enrichChartAnnotation;var l,i,o;M.prototype._enrichChartAnnotation=function(b,c){if(c){if(!c.Measures){c.Measures=[];if(c.MeasureAttributes){l=c.MeasureAttributes.length;for(i=0;i<l;i++){o=c.MeasureAttributes[i];c.Measures.push({"PropertyPath":o.Measure.PropertyPath});}}}if(!c.Dimensions){c.Dimensions=[];if(c.DimensionAttributes){l=c.DimensionAttributes.length;for(i=0;i<l;i++){o=c.DimensionAttributes[i];c.Dimensions.push({"PropertyPath":o.Dimension.PropertyPath});}}}}e.apply(this,arguments);};},onBeforeRendering:function(){var s=this.getView().byId("analyticalChart2");var v=s&&s._getVizFrame();if(v){this.vizFrame=v;var b=this.getView().byId("vbLayout");this.vbLayout=b;this.isVizPropSet=false;var c=s.getChart();c.setProperty("enableScalingFactor",true);S.getSelectedDataPoint(v,this);S.attachDataReceived(s,this);}},getCardItemsBinding:function(){var s=this.getView().byId("analyticalChart2");var v=s&&s._getVizFrame();if(v&&v.getDataset()&&v.getDataset().getBinding("data")&&this.vbLayout){this.vbLayout.setBusy(false);}if(v&&v.getParent()){return v.getParent().getBinding("data");}return null;},onAfterRendering:function(){C.prototype.onAfterRendering.apply(this,arguments);var s=this.getView().byId("analyticalChart2");var c=this.getOwnerComponent().getComponentData();if(this.getCardPropertiesModel().getProperty("/layoutDetail")==="resizable"&&c.appComponent){var d=c.appComponent.getDashboardLayoutUtil(),b=d.getCardDomId(c.cardId),o=d.dashboardLayoutModel.getCardById(c.cardId),e=document.getElementById(b),h=this.getHeaderHeight();e.getElementsByClassName("sapOvpWrapper")[0].style.height=o.dashboardLayout.rowSpan*d.ROW_HEIGHT_PX-(h+2*d.CARD_BORDER_PX)+"px";var m=Math.round((h+2*d.CARD_BORDER_PX)/d.ROW_HEIGHT_PX);if(o.dashboardLayout.rowSpan<=m){e.classList.add("sapOvpMinHeightContainer");}if(s){s._getVizFrame().setHeight(this._calculateVizFrameHeight()+"px");}}var f=s&&s.getChart();if(f){var v=s&&s._getVizFrame();f.attachRenderComplete(function(){var D="";if(v&&v._states()&&v._states()["dynamicScale"]){var g=this.getView().byId("ovpUoMTitle");var i=f.getScalingFactor();var j=i&&i.primaryValues&&i.primaryValues.scalingFactor;var u=i&&i.primaryValues&&i.primaryValues.unit;if(j&&u){D=O.getText("IN",[j,u]);}else if(j&&!u){D=O.getText("IN_NO_SCALE",[j]);}else if(!j&&u){D=O.getText("IN_NO_SCALE",[u]);}if(D!==""){g.setText(D);}}}.bind(this));}},beforeRebindSmartChart:function(e){var c=this.getView().byId("analyticalChart2");c.attachBeforeRebindChart(q.proxy(this.beforeRebindSmartChart,this));var b=e.getParameter("bindingParams");this.dataLength=this.getChartBindingLength();b.length=this.dataLength;var f=b.filters;var s=b.sorter;var o=this.getCardPropertiesModel();var d=o.getData();var g=d.entityType[d.selectionAnnotationPath];var h=g&&g.SelectOptions;var i=this.getModel();var E=this.getEntitySet();var m=S.getMetadata(this.getModel(),d.entitySet);var p=d.entityType[d.presentationAnnotationPath];var j=p&&p.SortOrder;var k=p&&p.MaxItems,l=null;if(k){l=k.Int32?k.Int32:k.Int;}if(l){if(l=="0"){q.sap.log.error("OVP-AC: Analytic card Error: maxItems is configured as "+l);}if(!/^\d+$/.test(l)){q.sap.log.error("OVP-AC: Analytic card Error: maxItems is Invalid. "+"Please enter an Integer.");}}if(h){q.each(g.SelectOptions,function(){var u=this.PropertyName.PropertyPath;q.each(this.Ranges,function(){if(this.Sign.EnumMember==="com.sap.vocabularies.UI.v1.SelectionRangeSignType/I"){var v=S.getPrimitiveValue(this.Low);var w=this.High&&this.High.String;v=S.formatByType(m,u,v);var x={path:u,operator:this.Option.EnumMember.split("/")[1],value1:v};if(w){x.value2=S.formatByType(m,u,w);}f.push(new F(x));}});});}if(j){if(p.SortOrder.Path&&p.SortOrder.Path.indexOf('@')>=0){var n=p.SortOrder.Path.split('@')[1];var r=i.getServiceAnnotations()[E.entityType];p.SortOrder=r[n];}q.each(p.SortOrder,function(){var u=this.Property.PropertyPath;var v=this.Descending.Boolean||this.Descending.Bool;var w={sPath:u,bDescending:v=="true"?true:false};s.push(new a(u,w.bDescending));});}var t="";var P=o.getProperty('/parameters');var G=this.oMainComponent&&this.oMainComponent.getGlobalFilter();t=A.resolveParameterizedEntitySet(i,E,g,P,G);c.setChartBindingPath(t);},getChartBindingLength:function(){var c=this.getView().byId("analyticalChart2"),o=S.getMaxItems(c),b=+this.getCardPropertiesModel().getProperty("/cardLayout/colSpan")-1,l;if(o&&o.itemsLength&&o.dataStep&&this.getCardPropertiesModel().getProperty('/layoutDetail')==='resizable'){l=o.itemsLength+b*o.dataStep;}else if(o&&o.itemsLength&&this.getCardPropertiesModel().getProperty('/layoutDetail')!=='resizable'){l=o.itemsLength;}else{l=100;}return l;},resizeCard:function(n,$){var c=this.getCardPropertiesModel(),s=this.getView().byId("analyticalChart2"),o=this.getCardPropertiesModel().getProperty("/cardLayout"),b=this.getView().byId('ovpCardContentContainer').getDomRef();c.setProperty("/cardLayout/rowSpan",n.rowSpan);c.setProperty("/cardLayout/colSpan",n.colSpan);this.bSorterSetForCustomCharts=false;n.showOnlyHeader?b.classList.add('sapOvpContentHidden'):b.classList.remove('sapOvpContentHidden');q(this.getView().$()).find(".sapOvpWrapper").css({height:(n.rowSpan*o.iRowHeightPx)-(o.headerHeight+2*o.iCardBorderPx)+"px"});if(s){if(this.dataLength!==this.getChartBindingLength()||(n.showOnlyHeader===false&&(this.oldShowOnlyHeaderFlag===true||this.oldShowOnlyHeaderFlag===undefined))){s.rebindChart();}s._getVizFrame().setHeight(this._calculateVizFrameHeight()+"px");}this.oldShowOnlyHeaderFlag=n.showOnlyHeader;},_calculateVizFrameHeight:function(){var v,c=this.getCardPropertiesModel().getProperty('/cardLayout');if(c&&c.rowSpan){var g=this.getView().getController(),d=this.getItemHeight(g,'toolbar'),b=this.getView().byId('bubbleText'),i=this.getView().byId('ovpChartTitle')?this.getItemHeight(g,'ovpChartTitle'):0,B=b&&b.getVisible()?this.getItemHeight(g,'bubbleText'):0;v=c.rowSpan*c.iRowHeightPx-(c.headerHeight+2*c.iCardBorderPx+d+i+B);}return v;}});});
