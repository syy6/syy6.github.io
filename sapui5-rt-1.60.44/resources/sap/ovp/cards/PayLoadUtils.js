/*!
 * Copyright (c) 2009-2014 SAP SE, All Rights Reserved
 */
sap.ui.define(['jquery.sap.global','sap/ovp/cards/rta/SettingsDialogConstants'],function(q,S){"use strict";function g(i,j,k,G){return i+"_sap.ovp.cards."+j+"."+k+"."+G;}function c(V){return{"type":"XTIT","maxLength":40,"value":{"":V}};}function a(i,I,j){var k=i+"["+I+"]";if(j){k+="/"+j;}return k;}function s(j,M){var k=M._getCardsModel();for(var i=0;i<k.length;i++){if(k[i].id===j){return true;}}return false;}function b(i,j,k){var G={"propertyPath":i,"operation":j};if(k){G["propertyValue"]=k;}return G;}function f(j){delete j.id;delete j.dashboardLayout;delete j.settings.baseUrl;delete j.settings.cloneCard;delete j.settings.newCard;delete j["customer.settings"];delete j["vendor.settings"];if(j.settings["staticContent"]){for(var i=0;i<j.settings["staticContent"].length;i++){delete j.settings["staticContent"][i].id;}}}function d(i,O,N){if(N==="customer.settings"&&O){P.aEntityPropertyChange.push(b("vendor.settings","UPSERT",O.settings));i["vendor.settings"]=O.settings;}}function e(N,i,O,j){if(O){if(N==="customer.settings"){O[j]={operation:"DELETE"};}}else{if(N==="customer.settings"){P.aEntityPropertyChange.push(b(i,"UPSERT",{operation:"DELETE"}));}else{P.aEntityPropertyChange.push(b(i,"DELETE"));}}}function h(i){P.aEntityPropertyChange.push(b("customer.settings","UPSERT",i["customer.settings"]));}function l(i,j,k,V,O){var I=g(P.sApplicationId,P.sCardId,i,k),G=j+"/"+k;if(!P.oText){P.oText={};}P.oText[I]=c(V);if(O){O[k]="{{"+I+"}}";}else{P.aEntityPropertyChange.push(b(G,"UPSERT","{{"+I+"}}"));}}function m(N,j,T,O){var k=this._oCardManifestSettings,G=this._oOriginalCardManifestSettings;for(var i=0;i<T.length;i++){if((!G[T[i]]&&k[T[i]])||(G[T[i]]&&k[T[i]]&&(G[T[i]]!=k[T[i]]))){if(O){l(N,N,T[i],k[T[i]],j[N]);}else{l(N,N,T[i],k[T[i]]);}j.settings[T[i]]=k[T[i]];}else if(!k[T[i]]&&G[T[i]]){if(O){e(N,N+"/"+T[i],j[N],T[i]);}else{e(N,N+"/"+T[i]);}delete j.settings[T[i]];}}}function n(i,j,V,O){var k=i+"/"+j;if(O){O[j]=V;}else{P.aEntityPropertyChange.push(b(k,"UPSERT",V));}}function o(N,j,k,O){var G=this._oCardManifestSettings,H=this._oOriginalCardManifestSettings;for(var i=0;i<k.length;i++){if((!H[k[i]]&&G[k[i]])||(H[k[i]]&&G[k[i]]&&(H[k[i]]!=G[k[i]]))){if(O){n(N,k[i],G[k[i]],j[N]);}else{n(N,k[i],G[k[i]]);}j.settings[k[i]]=G[k[i]];}else if(!G[k[i]]&&H[k[i]]){if(O){e(N,N+"/"+k[i],j[N],k[i]);}else{e(N,N+"/"+k[i]);}delete j.settings[k[i]];}}}function p(N,i){var j=S.cardSettings["settings"],T=S.cardSettings["text"];if(N==="customer.settings"){if(i["customer.settings"]){m.bind(this)(N,i,T,false);o.bind(this)(N,i,j,false);}else{i["customer.settings"]={};m.bind(this)(N,i,T,true);o.bind(this)(N,i,j,true);h(i);}}else{m.bind(this)(N,i,T,false);o.bind(this)(N,i,j,false);}}function r(N,k,G,T,H,O){var I=this._oCardManifestSettings[H];for(var i=0;i<I.length;i++){for(var j=0;j<T.length;j++){if(I[i][T[j]]){var J=a(N+"/"+H,i),K=N+"."+H+"."+i;if(O){l(K,J,T[j],I[i][T[j]],k[N][H][i]);}else{l(K,J,T[j],I[i][T[j]],G[i]);}}}}if(!O){n(N,H,G);}}function t(j,T){var O=S.cardSettingsArrayLevel[T]["onlyTabLevelProps"],k=false;for(var i=0;O&&i<O.length;i++){if(O[i]===j){k=true;break;}}return k;}function u(N,j,T,k,G,O){var H=this._oCardManifestSettings,i;for(i=0;i<T.length;i++){if(H[T[i]]&&!t(T[i],G)){if(O){l(N,N,T[i],H[T[i]],j[N]);}else{l(N,N,T[i],H[T[i]]);}j.settings[T[i]]=H[T[i]];}}for(i=0;i<k.length;i++){if(H[k[i]]&&!t(k[i],G)){if(O){n(N,k[i],H[k[i]],j[N]);}else{n(N,k[i],H[k[i]]);}j.settings[k[i]]=H[k[i]];}}if(O){e(N,N+"/"+G,j[N],G);}else{e(N,N+"/"+G);}delete j.settings[G];}function v(N,j,k,T,G,H,O){var i;for(i=0;i<T.length;i++){if(j[N][T[i]]){if(O){e(N,N+"/"+T[i],j[N],T[i]);}else{e(N,N+"/"+T[i]);}delete j.settings[T[i]];}}for(i=0;i<G.length;i++){if(j[N][G[i]]){if(O){e(N,N+"/"+G[i],j[N],G[i]);}else{e(N,N+"/"+G[i]);}delete j.settings[G[i]];}}r.bind(this)(N,j,k,T,H,O);}function w(j,T){return q.map(q.extend(true,{},j),function(k){var G=S.cardSettingsArrayLevel[T]["text"],i,H=S.cardSettingsArrayLevel[T]["settings"],I={};for(i=0;i<G.length;i++){if(k[G[i]]){I[G[i]]=k[G[i]];}}for(i=0;i<H.length;i++){if(k[H[i]]){I[H[i]]=k[H[i]];}}return I;});}function x(N,i,j,k,T,O){var G=S.cardSettingsArrayLevel[T]["text"],H=S.cardSettingsArrayLevel[T]["settings"],I=w(j,T);if(j&&k){i.settings[T]=w(j,T);if(N==="customer.settings"){i[N][T]=w(j,T);}r.bind(this)(N,i,I,G,T,O);}else if(!j&&k){u.bind(this)(N,i,G,H,T,O);}else if(j&&!k){i.settings[T]=w(j,T);if(N==="customer.settings"){i[N][T]=w(j,T);}v.bind(this)(N,i,I,G,H,T,O);}}function y(N,i,O){var j=this._oCardManifestSettings["staticContent"],k=this._oOriginalCardManifestSettings["staticContent"],T=this._oCardManifestSettings["tabs"],G=this._oOriginalCardManifestSettings["tabs"];if(j||k){x.bind(this)(N,i,j,k,"staticContent",O);}else if(T||G){x.bind(this)(N,i,T,G,"tabs",O);}}function z(N,i){var j=S.cardSettingsForComplex["settings"],T=S.cardSettingsForComplex["text"];if(N==="customer.settings"){if(i["customer.settings"]){m.bind(this)(N,i,T,false);o.bind(this)(N,i,j,false);y.bind(this)(N,i,false);}else{i["customer.settings"]={};m.bind(this)(N,i,T,true);o.bind(this)(N,i,j,true);y.bind(this)(N,i,true);h(i);}}else{m.bind(this)(N,i,T,false);o.bind(this)(N,i,j,false);y.bind(this)(N,i,false);}}function A(N,i){var j=this._oCardManifestSettings["staticContent"],O=this._oOriginalCardManifestSettings["staticContent"],T=this._oCardManifestSettings["tabs"],k=this._oOriginalCardManifestSettings["tabs"];if(j||O||T||k){z.bind(this)(N,i);}else{p.bind(this)(N,i);}}function B(i){var k=S.AllCardSettingsForKPICard,j,G=this._oCardManifestSettings,H={"model":"customer.kpi_card_model_"+i.getTrimmedDataURIName(G.selectedKPI.ODataURI),"template":"sap.ovp.cards.charts.analytical","settings":{}};for(j=0;j<k.length;j++){if(G[k[j]]){H.settings[k[j]]=G[k[j]];}}return H;}function C(){var k=this._oCardManifestSettings["staticContent"],T=S.cardSettingsArrayLevel["staticContent"]["text"],i,j,G=S.cardSettingsArrayLevel["staticContent"]["settings"],H=this._oCardManifestSettings,I=S.cardSettingsForStaticLinkListCard,J={"template":"sap.ovp.cards.linklist","settings":{"staticContent":[]}};for(j=0;j<I.length;j++){if(H[I[j]]){J.settings[I[j]]=H[I[j]];}}for(j=0;j<k.length;j++){J.settings["staticContent"].push({});for(i=0;i<T.length;i++){if(k[j][T[i]]){J.settings["staticContent"][j][T[i]]=k[j][T[i]];}}for(i=0;i<G.length;i++){if(k[j][G[i]]){J.settings["staticContent"][j][G[i]]=k[j][G[i]];}}}return J;}function D(G,H,I){var T,i,j,k,J,K=I.settings["staticContent"],L=I.settings["tabs"];var M=S.cardSettingsWithText;for(i=0;i<M.length;i++){var N;if(typeof M[i]=="string"){if(I.settings[M[i]]){if(!T){T={};}N=g(G,H,"settings",M[i]);T[N]=c(I.settings[M[i]]);I.settings[M[i]]="{{"+N+"}}";}}else if(typeof M[i]=="object"){if(M[i].hasOwnProperty("staticContent")){if(K){for(j=0;j<K.length;j++){for(k=0;k<M[i]["staticContent"].length;k++){J=M[i]["staticContent"][k];if(K[j][J]){if(!T){T={};}N=g(G,H,"settings.staticContent."+j,J);T[N]=c(K[j][J]);I.settings["staticContent"][j][J]="{{"+N+"}}";}}}}}else if(M[i].hasOwnProperty("tabs")){if(L){for(j=0;j<L.length;j++){for(k=0;k<M[i]["tabs"].length;k++){J=M[i]["tabs"][k];if(L[j][J]){if(!T){T={};}N=g(G,H,"settings.tabs."+j,J);T[N]=c(L[j][J]);I.settings["tabs"][j][J]="{{"+N+"}}";}}}}}}}return T;}function E(M,j,k){var I=false;for(var i=0;i<k.length;i++){if(k[i].id!==j&&k[i].model===M){I=true;break;}}return I;}function F(i,T,j,O,V){var k={};k['appDescriptorChange']={'parameters':i};if(T){k['appDescriptorChange']['texts']=T;}if(O){k['flexibilityChange']={"newAppDescriptor":j,"oldAppDescriptor":O};}else{k['flexibilityChange']=j;}if(V){k['viewSwitchChange']=V;}return k;}var P={sApplicationId:"",sCardId:"",aEntityPropertyChange:[],oText:undefined,getPayLoadForEditCard:function(i){var j=i.oAppDescriptor.id,k={"cardId":j},T,G,H=q.extend(true,{},i.oAppDescriptor),O=q.extend(true,{},i.oAppDescriptor),N,V;N=(j.lastIndexOf("customer.",0)===0)?"settings":"customer.settings";P.sApplicationId=i.sApplicationId;P.sCardId=j;P.aEntityPropertyChange=[];P.oText=undefined;d(H,i.oOriginalAppDescriptor,N);A.bind(this)(N,H);T=q.extend(true,{},P.oText);G=P.aEntityPropertyChange;if(G.length===1){k["entityPropertyChange"]=G[0];}else{k["entityPropertyChange"]=G;}if(this._oCardManifestSettings["tabs"]){var I=this._oCardManifestSettings.defaultViewSelected,J=this._oOriginalCardManifestSettings.selectedKey;J=(J&&J>0)?J:1;if(I&&I>0&&I!==J){V={cardId:j,selectedKey:I,oldKey:J};}H.settings.selectedKey=I;}return F(k,T,H,O,V);},getPayLoadForCloneCard:function(j){return new Promise(function(k,G){var H={card:{}},T,I={},J=j.getComponentInstance().getComponentData(),M=J.mainComponent,K=M._getApplicationId(),L=q.extend(true,{},M._getCardFromManifest(J.cardId));var N="customer."+L.id,i=1;while(s(N+"_C"+i,M)){i++;}N=N+"_C"+i;f(L);I=q.extend(true,{},L);I.id=N;I.settings.title=I.settings.title+" "+i;L.settings.title=L.settings.title+" "+i;if(L.settings.defaultSpan&&L.settings.defaultSpan.showOnlyHeader){L.settings.defaultSpan.rows=12;}T=D(K,N,L);H.card[N]=L;k(F(H,T,I));});},getPayLoadForNewStaticLinkListCard:function(j){var k={card:{}},T,G={},M=j.oMainComponent,H=M._getApplicationId(),I=C.bind(this)();var J="customer.newStaticLinkListCard",i=1;while(s(J+"_N"+i,M)){i++;}J=J+"_N"+i;f(I);G=q.extend(true,{},I);G.id=J;T=D(H,J,I);k.card[J]=I;return F(k,T,G);},getPayLoadForNewKPICard:function(j){var k={card:{}},T,G={},M=j.oMainComponent,H=j.oAppComponent,I=M._getApplicationId(),J=B.bind(this)(j);var K="customer.newKPICard",i=1;while(s(K+"_N"+i,M)){i++;}K=K+"_N"+i;f(J);G=q.extend(true,{},J);G.id=K;G.settings.selectedKPI=q.extend(true,{},this._oCardManifestSettings.selectedKPI);T=D(I,K,J);k.card[K]=J;var L=J.model+"_ANNO",N=j.getDataSources(L),O=true,Q=0;if(N[L]){if(N[L].uri!==this._oCardManifestSettings.selectedKPI.ModelURI){while(N[L+"_"+Q]){Q++;}L=L+"_"+Q;}else{O=false;}}var R=H.getModel(J.model);if(!R){k["model"]={};k["model"][J.model]={dataSource:J.model,settings:{"defaultCountMode":sap.ui.model.odata.CountMode.None}};k["dataSource"]={};k["dataSource"][J.model]={uri:this._oCardManifestSettings.selectedKPI.ODataURI,type:"OData",settings:{annotations:[L],localUri:""}};if(O){k["dataSource"][L]={uri:this._oCardManifestSettings.selectedKPI.ModelURI,type:"ODataAnnotation",settings:{localUri:""}};G.settings["sAnnoKey"]=L;}}var U=F(k,T,G);if(O&&R){U["addODataAnnotation"]={'parameters':{"dataSourceId":J.model,"annotations":[L],"dataSource":{}}};U["addODataAnnotation"].parameters.dataSource[L]={uri:this._oCardManifestSettings.selectedKPI.ModelURI,type:"ODataAnnotation",settings:{localUri:""}};U['flexibilityChange'].settings["sAnnoKey"]=L;}return U;},getPayLoadForRemoveCard:function(i){var j={},k={},G=i.getComponentInstance().getComponentData(),H=G.cardId;j["cardId"]=H;k.id=i.getId();var I=F(j,null,k),J=G.mainComponent.getUIModel().getProperty("/cards");if(!E(G.modelName,H,J)&&!!G.modelName){I["removeDataSourceChange"]=[];var M=G.appComponent.getMetadata(),K=M.getManifestEntry("sap.ui5").models[G.modelName].dataSource,L=M.getManifestEntry("sap.app").dataSources[K].settings.annotations;L.forEach(function(N){I["removeDataSourceChange"].push({'parameters':{"dataSourceId":N}});});}return I;}};return P;},true);
