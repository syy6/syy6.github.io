// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["jquery.sap.global","sap/ushell/System","sap/ushell/User","sap/ushell/utils","sap/ui2/srvc/ODataWrapper","sap/ui/thirdparty/URI","sap/ui/thirdparty/datajs"],function(q,S,U,u,O,a,b){"use strict";var C=function(s,p,P){var o,c="/sap/public/bc/icf/logoff";this._logoutViaHiddenIFrame=function(d,e){var f=document.createElement("iframe"),g=e.replace(/"/g,"\\\"");window.addEventListener("message",function(E){if(E.data===e){d.resolve();}});f.style.visibility="hidden";f.setAttribute("src",e);function h(){parent.postMessage(g,"*");}f.addEventListener("load",h);f.addEventListener("error",h);document.body.appendChild(f);};this.getSystem=function(){return s;};this.getUser=function(){return o;};this._determineAccessibility=function(d){var A=u.getParameterValueBoolean("sap-accessibility");if(A!==undefined){return A;}A=d.accessibility;if(A!==undefined){return A;}return false;};this._setThemeAccessibilityFlags=function(d){if(d.userProfile&&d.userProfile.length){var e,f;e=d.userProfile.filter(function(g){return g.id&&g.id==='THEME';})[0];if(e&&e.value){d.setThemePermitted=(e.editState===3);}else{d.oUserProfileDataTheme=false;}f=d.userProfile.filter(function(g){return g.id&&g.id==='ACCESSIBILITY';})[0];if(f&&f.id){d.setAccessibilityPermitted=(f.editState===3);}else{d.setAccessibilityPermitted=false;}if(f&&f.value==="true"){d.accessibility=true;}if(f&&f.value==="false"){d.accessibility=false;}d.accessiblity=this._determineAccessibility(d);}};this._setUserProfileFlags=function(d){if(d.userProfile&&d.userProfile.length&&q.isArray(d.userProfile)){var e={};d.setContentDensityPermitted=false;d.userProfile.forEach(function(f){if((f.id in e)){return;}e[f.id]=f.id;if(f.id==="CONTENT_DENSITY"){d.contentDensity=f.value;d.setContentDensityPermitted=(f&&f.editState===3)||false;}if(f.id==="TRACKING_USAGE_ANALYTICS"){if(typeof f.value==="string"){if(f.value.toLowerCase()==="true"||f.value.toLowerCase()==="false"){f.value=(f.value.toLowerCase()==="true")||false;}else{f.value=undefined;}}if(typeof f.value==="undefined"||typeof f.value==="boolean"){d.trackUsageAnalytics=f.value;}else{d.trackUsageAnalytics=undefined;}}});}};this.load=function(){var d=new q.Deferred(),e=P.config;e.alias=s.getAlias();e.platform=s.getPlatform();s=new S(e);this._setThemeAccessibilityFlags(e);this._setUserProfileFlags(e);o=new U(e);sap.ui2.srvc.ODataWrapper["sap-language"]=e.language;sap.ui2.srvc.ODataWrapper["sap-client"]=e.client;if(e.target){C.startUpApplication={adjustedInitialTarget:e.adjustedInitialTarget,target:e.target};}this._setUserImage(o);return d.resolve().promise();};this.addFurtherRemoteSystems=function(){var d=new q.Deferred(),e;e=sap.ushell.Container.getService("PageBuilding").getFactory().getPageBuildingService();e.readAllCatalogsForUser("type eq 'H' or type eq 'REMOTE'",function(D){var f=D.results,g="/sap/opu/odata/sap/SM_CATALOG_SRV/";if(f){f.forEach(function(h){var i=/^\/sap\/hba\//.test(h.baseUrl);if(h.type==='H'||h.baseUrl===g||i){sap.ushell.Container.addRemoteSystem(new S({alias:h.systemAlias,platform:(i||h.type==='H')?"hana":"abap",baseUrl:h.type==='H'?"":";o="}));}});}d.resolve();},function(E){q.sap.log.error("Reading REMOTE catalogs failed: "+E,null,"sap.ushell_abap.adapters.abap.ContainerAdapter");d.reject();});return d.promise();};this.getCurrentUrl=function(){return window.location.href;};this.logout=function(l){var d=new q.Deferred(),e;if(l){if(u.hasNativeLogoutCapability()){var f=(new a(c)).absoluteTo(this.getCurrentUrl()).search("").toString();window.external.getPrivateEpcm().doLogOff(f);}else{this.logoutRedirect();}q.sap.log.info("ABAP system logged out: "+s.getAlias(),null,"sap.ushell_abap.adapters.abap.ContainerAdapter");d.resolve();}else{e=s.adjustUrl(c);q.sap.log.info("Logging out from system '"+s.getAlias()+"' via hidden iframe");this._logoutViaHiddenIFrame(d,e);}return d.promise();};this.logoutRedirect=function(){var d=s.adjustUrl(c);this._setDocumentLocation(d);};this._setDocumentLocation=function(l){window.document.location=l;};this._setUserImage=function(o){function i(){var d=window["sap-ushell-config"],v=q.sap.getObject("renderers.fiori2.componentData.config.enableUserImage",undefined,d);return!!v;}if(i()&&o&&o.isJamActive&&o.isJamActive()){b.read('/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/Self?$format=json',function(r){var j=r.results.Id,J="/sap/bc/ui2/smi/rest_tunnel/Jam/api/v1/OData/Members('"+j+"')/ProfilePhoto/$value";o.setImage(J);},function(){q.sap.log.error("Could not recieve JAM user data");});}};};return C;},true);
