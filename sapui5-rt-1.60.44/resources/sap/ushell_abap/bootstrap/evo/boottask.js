sap.ui.define(["sap/ushell/bootstrap/common/common.boot.path","sap/ushell/bootstrap/common/common.load.xhrlogon","sap/ushell/utils","./abap.bootstrap.utils","./abap.request.server.config","./abap.request.startup","./abap.request.pageset","./abap.xhr.handler","./abap.theme.handler","sap/ushell/EventHub","sap/ushell/services/Container","sap/ui/Device","sap/ui2/srvc/utils"],function(b,x,u,a,r,s,p,X,t,E){"use strict";var B={};sap.ushell_abap=sap.ushell_abap||{};sap.ushell_abap.bootstrap=sap.ushell_abap.bootstrap||{};sap.ushell_abap.getShellType=function(){return u.hasNativeNavigationCapability()?"NWBC":"FLP";};sap.ushell_abap.bootstrap.addPostParametersToNavTargetResultUrl=function(P,U){if(P){U+=(U.indexOf("?")<0)?"?":"&";U+=P;}return U;};sap.ushell_abap.bootstrap.adjustNavTargetResult=function(R){if(R){var U=R.url,e,K={applicationType:R.applicationType,additionalInformation:R.applicationData},L,M,N,O;if(R.text){K.text=R.text;}if((R.applicationType==="URL"||R.applicationType==="SAPUI5")){M=/^SAPUI5\.Component=(.*)/.exec(R.applicationData);L=M&&M[1];jQuery.sap.require("sap.ui.thirdparty.URI");var P=sap.ui.require('sap/ui/thirdparty/URI');e=U&&new P(U);if(L||R.applicationDependencies){if(L){K.ui5ComponentName=L;}if(R.applicationDependencies){try{N=JSON.parse(R.applicationDependencies);O=N.self;if(!K.ui5ComponentName&&O.name){K.ui5ComponentName=O.name;K.additionalInformation="SAPUI5.Component="+K.ui5ComponentName;}if(O&&O.url&&typeof O.url==="string"){if(e){if(O.url.toUpperCase().indexOf(e.path().toUpperCase())!==0){sap.ui2.srvc.log.debug("Component URL defined in target mapping "+"does not match the URL retrieved from application index. "+"The URL of the application index is used for further processing.","Target mapping URL: "+R.url+"\nApplication index URL: "+O.url,"sap.ushell_abap.bootstrap.abap");}e.path(O.url);U=e.toString();jQuery.sap.log.debug("ResolveLink result's component url has been replaced with the url specified "+"in Application Dependencies, which includes cache buster token");}else{U=O.url;}}K.applicationDependencies=N;}catch(Q){sap.ui2.srvc.log.error("Parsing of applicationDependencies attribute in resolveLink result failed for SAPUI5 component '"+L+"'",Q,"sap.ushell_abap.bootstrap.abap");}}U=sap.ui2.srvc.addCacheBusterTokenUsingUshellConfig(U);}}K.url=U;return K;}};var c=new RegExp("^(#)?([A-Za-z0-9_]+)-([A-Za-z0-9_]+)"),S,o;function i(e){function K(e){if(!e){return false;}return(e.indexOf("Shell-runStandaloneApp")===0)||(e.indexOf("Shell-home")===0)||(e.indexOf("Shell-appfinder")===0)||(e.indexOf("Shell-catalog")===0)||(e.indexOf("shell-catalog")===0)||(e.indexOf("Action-search")===0);}function L(){return window['sap-ushell_abap-bootstrap-abap-noInitialTarget']!==undefined;}var M=e.match(c);var N=M&&M[2];var O=M&&M[3];var P=e&&!K(e)&&!L()&&N&&O;return P;}function g(){var e,K=a.getLocationHref(),L=K.indexOf("#");if(L<0){return"";}e=decodeURI(K.slice(L+1));return e;}function d(){var e=g(),K=e.indexOf("&/");return K<0?e:e.slice(0,K);}function f(e){var M=e.match(c);return M?{semanticObject:M[2],action:M[3]}:undefined;}function h(e){if(!e||e==="#"){return true;}return(e.indexOf("Shell-home")===0)||(e.indexOf("Shell-appfinder")===0)||(e.indexOf("Shell-catalog")===0)||(e.indexOf("shell-catalog")===0);}function j(O){if(O===undefined){return undefined;}try{return JSON.parse(JSON.stringify(O));}catch(e){sap.ui2.srvc.log.error("Could not clone object",null,"sap.ushell_abap.bootstrap");return undefined;}}function k(T){return T.indexOf("sap_")===0;}function l(e,K){var L=sap.ui.getCore(),M=L.getConfiguration(),N=M.getFormatSettings();u.addTime("setSapui5Settings");jQuery.sap.log.debug("setSapui5Settings()",JSON.stringify(e),"sap.ushell_abap.bootstrap.abap");if(e.language){M.setLanguage(e.language,e.ABAPLanguage);}if(e.legacyDateFormat){N.setLegacyDateFormat(e.legacyDateFormat);}if(e.legacyDateCalendarCustomizing){N.setLegacyDateCalendarCustomizing(e.legacyDateCalendarCustomizing);}if(e.legacyNumberFormat){N.setLegacyNumberFormat(e.legacyNumberFormat);}if(e.legacyTimeFormat){N.setLegacyTimeFormat(e.legacyTimeFormat);}if(typeof K==="object"){N.addCustomCurrencies(K);}}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function m(e){jQuery.sap.getObject("sap-ushell-config.services.Container.adapter.config",0).bootTheme=j(e);}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function n(e){if(!e){sap.ui2.srvc.log.error("extractSystemThemeRoot: mandatory parameter oStartupServiceResult not supplied");}if(e.themeRoot){return e.themeRoot;}if(e.client){sap.ui2.srvc.log.warning("Theme root was not contained in startup service result. A fallback to /sap/public/bc/themes/~client-<client number> is used",null,"sap.ushell_abap.bootstrap");return"/sap/public/bc/themes/~client-"+e.client;}sap.ui2.srvc.log.error("extractSystemThemeRoot: Could not determine system theme root");}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function q(e){var P,T;if(e&&e.userProfile){P=e.userProfile.filter(function(K){return K.id==="THEME";});T=P.length?P[0]:{};if(T.value){return T.value;}}if(e&&e.theme){return e.theme;}return"";}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function v(T,S){if(T&&k(T)){return"";}return S;}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function w(e,S){var T;T=q(e);return{theme:T,root:v(T,S)};}sap.ui2.srvc.testPublishAt(sap.ushell_abap.bootstrap);function y(S){var T,e;T=a.getUrlParameterValue("sap-theme");if(T){if(T.indexOf('@')>0){e=T.split('@',2);return{theme:e[0],root:e[1]};}return{theme:T,root:v(T,S)};}return undefined;}function z(){var U=sap.ui2.srvc.getParameterMap()["sap-theme"]&&sap.ui2.srvc.getParameterMap()["sap-theme"][0];if(U){return U;}return undefined;}function A(e){var T=e;var K=e.indexOf("@");if(K>=0){var L=T.slice(K+1);return t.isThemeRootSafe(L);}return true;}function C(o,S){var U,e={},K,L=z();u.addTime("applyTheme");if(L&&A(L)){U=y(S);K=U;sap.ui2.srvc.log.debug("theme: URL theme = '"+K.theme+"' theme root = '"+K.root+"'",null,"sap.ushell_abap.bootstrap");if(K.root){sap.ui.getCore().setThemeRoot(K.theme,K.root.replace(/\/?$/,"/UI5/"));}}else if(o){K=o;sap.ui2.srvc.log.debug("theme: startup service theme = '"+K.theme+"' theme root = '"+K.root+"'",null,"sap.ushell_abap.bootstrap");if(K.root){sap.ui.getCore().applyTheme(K.theme,K.root+"/UI5/");}else{sap.ui.getCore().applyTheme(K.theme);}}else{e.theme=jQuery.sap.getObject("sap-ui-config.theme");if(e.theme){e.root=jQuery.sap.getObject("sap-ui-config.themeRoots."+e.theme);if(!e.root){e.root=v(e.theme,S);}K={theme:e.theme,root:e.root};sap.ui2.srvc.log.debug("theme: html file theme = '"+K.theme+"' theme root = '"+K.root+"'",null,"sap.ushell_abap.bootstrap");}else{K={theme:"",root:""};sap.ui2.srvc.log.error("Could not determine theme",null,"sap.ushell_abap.bootstrap");}}m(K);return K;}function D(e){var P=sap.ui2.srvc.getParameterMap(),R=a.getUrlParameterValue("sap-locale",P),U={},K;K=jQuery.sap.getObject("sap-ushell-config.services.SupportTicket.config",0);if(K.enabled!==false){K.enabled=(e.isEmbReportingActive===true);}K=jQuery.sap.getObject("sap-ushell-config.services.ClientSideTargetResolution.adapter.config.services",0);K.targetMappings=e.services&&e.services.targetMappings;K=jQuery.sap.getObject("sap-ushell-config.services.LaunchPage.adapter.config.services",0);K.targetMappings=e.services&&e.services.targetMappings;K.launchPage=e.services&&e.services.pbFioriHome;K=jQuery.sap.getObject("sap-ushell-config.services.PageBuilding.adapter.config.services",0);K.pageBuilding=e.services&&e.services.pbFioriHome;K=jQuery.sap.getObject("sap-ushell-config.services.Personalization.adapter.config.services",0);K.personalization=e.services&&e.services.personalization;K=jQuery.sap.getObject("sap-ushell-config.services.Personalization.config",0);K.seed=e.seed;if(!R){U={language:e.languageBcp47||e.language,ABAPLanguage:e.language,legacyDateFormat:e.dateFormat,legacyDateCalendarCustomizing:e.tislcal,legacyNumberFormat:e.numberFormat===""?" ":e.numberFormat,legacyTimeFormat:e.timeFormat};}C(o,S);l(U,e.currencyFormats);}function F(e,N){var K=d(),L=g(),R=f(K),M=[R],O={},P={},Q;var T=jQuery.sap.getObject("sap-ushell-config.services.AppState.config",0);var U=jQuery.sap.getObject("sap-ushell-config.services.ClientSideTargetResolution.adapter.config",0);function V(Y,L){var Z=L.match(Y);var $=[];if(!Z){return;}$=(Z[2]).toString().split("=");P[$[0]]=$[1];}function W(Y,Z,P,$,_){if(Z&&Z[_]&&P&&P[$]){Y[P[$]]=Z[_];}}if(i(K)){V(/(\?|&)(sap-xapp-state=[A-Z0-9]+)/,K);V(/(\?|&)(sap-intent-param=[A-Z0-9]+)/,K);V(/(\?|&)(sap-system=[A-Z0-9]+)/,K);V(/(\?|&|[\/])(sap-iapp-state=[A-Z0-9]+)/,L);Q=s.requestDirectStart(e,N,R,P);T.initialAppStatesPromise=Q.then(function(Y){W(O,Y,P,"sap-intent-param","iparState");W(O,Y,P,"sap-iapp-state","iappState");W(O,Y,P,"sap-xapp-state","xappState");T.initialAppStates=O;return Promise.resolve(O);});U.initialSegmentPromise=Q.then(function(Y){if(Y.targetMappings){return Promise.resolve([M,Y.targetMappings,Y.systemAliases]);}return Promise.resolve(null);});}else{T.initialAppStatesPromise=Promise.resolve({});U.initialSegmentPromise=Promise.resolve(null);}}function G(){var P=new Promise(function(e,K){var R,O;O=function(){jQuery.sap.log.info("Direct application start: resolving component waitFor promise after shell renderer created event fired.");e();sap.ushell.Container.detachRendererCreatedEvent(O);};E.once("ShellNavigationInitialized").do(function(){R=sap.ushell.Container.getRenderer();if(R){jQuery.sap.log.info("Direct application start: resolving component waitFor promise immediately (shell renderer already created).");e();}else{sap.ushell.Container.attachRendererCreatedEvent(O);}});});return P;}function H(M){var U=a.getUrlParameterValue("sap-ushell-reload"),e;if(U){if(U==="X"||U==="true"){e=true;}else{e=false;}}if(e!==undefined){jQuery.sap.getObject("services.ShellNavigation.config",0,M).reload=e;}}function I(e,K,L){var M=d();D(e);K.forEach(function(N){a.mergeConfig(window["sap-ushell-config"],N,true);});H(window["sap-ushell-config"]);sap.ushell.bootstrap("abap",{abap:"sap.ushell_abap.adapters.abap",hana:"sap.ushell_abap.adapters.hana"}).done(function(){var N=x.FrameLogonManager.getInstance();sap.ushell.Container.oFrameLogonManager=N;}).always(function(){if(i(M)){var R,N;window["sap-ushell-async-libs-promise-directstart"]=new Promise(function(O,P){R=O;N=P;});window["sap-ushell-async-libs-promise-directstart"].catch(function(O){});sap.ushell.Container.getServiceAsync("NavTargetResolution").then(function(O){O.resolveHashFragment("#"+d()).done(function(P){if(P&&P.ui5ComponentName){sap.ushell.Container.getServiceAsync("Ui5ComponentLoader").then(function(U){U.createComponent(P,f(M),G()).done(function(Q){R({resolvedHashFragment:Q,dependenciesLoaded:true});}).fail(function(Q){N(Q);});});}else{R({resolvedHashFragment:P,dependenciesLoaded:false});}}).fail(function(P){N(P);});});}L();});}function J(U){var N=false,e,R;if(window['sap-ushell_abap-bootstrap-abap-noOData']){N=true;}X.initXhrLogon(window["sap-ushell-config"]);e=s.requestStartupConfig().then(function(K){var L=d();jQuery.sap.getObject("sap-ushell-config.services.Container.adapter",0).config=K;F(K,N);S=n(K);o=w(K,S);if(!z()&&o){jQuery.sap.log.debug("theme: load theme from startup service via window",null,"sap.ushell_abap.bootstrap");}if(h(L)){p.requestPageSet(K,N);var M=jQuery.sap.getObject("sap-ushell-config.services.LaunchPage.adapter.config",0);M.compactTMPromise=s.requestCompactTM(K,N);}var O=jQuery.sap.getObject("sap-ushell-config.services.ClientSideTargetResolution.adapter.config",0);O.navTargetDataPromise=s.requestFullTM(K,N);return Promise.resolve(K);},function(M){jQuery.sap.log.error("start_up request failed: "+M,null,"sap.ushell_abap.bootstrap");return Promise.resolve({});});R=r().then(function(K){return Promise.resolve(K);},function(M){jQuery.sap.log.error("Could not load server configuration: "+M,null,"sap.ushell_abap.bootstrap.abap");return Promise.resolve([]);});Promise.all([e,R,U]).then(function(P){I.apply(null,P);});}B.start=J;B.bootstrap=I;B._getShellHash=d;B._getFullShellHash=g;B._createWaitForRendererCreatedPromise=G;return B;});
