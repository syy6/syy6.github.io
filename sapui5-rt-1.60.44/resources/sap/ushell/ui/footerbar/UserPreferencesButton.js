// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/m/Button','sap/m/Dialog','sap/m/Bar','sap/m/Text','sap/m/List','sap/ushell/library','sap/ushell/resources','sap/ushell/ui/launchpad/AccessibilityCustomData','sap/ushell/ui/launchpad/ActionItem','sap/m/DisplayListItem','sap/ui/layout/VerticalLayout','sap/m/ObjectIdentifier','sap/ushell/EventHub','sap/ushell/Config','./UserPreferencesButtonRenderer','sap/ui/model/json/JSONModel','sap/ushell/ui/utils'],function(B,D,a,T,L,l,r,A,b,c,V,O,E,C,U,J,u){"use strict";var d=b.extend("sap.ushell.ui.footerbar.UserPreferencesButton",{metadata:{library:"sap.ushell"}});d.prototype.init=function(){if(b.prototype.init){b.prototype.init.apply(this,arguments);}this.setIcon('sap-icon://person-placeholder');this.translationBundle=r.i18n;this.setText(this.translationBundle.getText("userSettings"));this.setTooltip(this.translationBundle.getText("settings_tooltip"));this.attachPress(this.showUserPreferencesDialog);this.oModel=C.createModel("/core/shell/model/userPreferences",J);this.setModel(this.oModel);};d.prototype.createDialog=function(){var t=this;this.saveButton=this._createSaveButton();this.cancelButton=this._createCancelButton();this.oDialog=new D({id:"userPreferencesDialog",title:"{/dialogTitle}",contentWidth:"29.6rem",content:null,contentHeight:"17rem",buttons:[this.saveButton,this.cancelButton],afterClose:function(){this._destroyDialog();this.oUser.resetChangedProperties();}.bind(t),stretch:sap.ui.Device.system.phone}).addStyleClass("sapUshellUserPreferencesDialog");this._addDialogBackButton();this.oDialog.setModel(this.getModel());this.oDialog.addCustomData(new A({key:"aria-label",value:t.translationBundle.getText("Settings_Dialog_Main_label"),writeToDom:true}));this.oDialog.addContent(this._getOriginalDialogContent());};d.prototype._getOriginalDialogContent=function(){if(!this.oInitialContent){var o,e;o=this._getUserDetailsControl();e=this._getEntryListControl();this.oInitialContent=new V('userPreferencesLayout',{content:[o,e],width:"100%"});}return this.oInitialContent;};d.prototype._getEntryListControl=function(){var e=this._getUserPrefEntriesTemplate(),x=this.getModel()&&this.getModel().getProperty('/enableHelp'),t=this,i,s=this.oUser.getFullName(),o,f=new L('userPrefEnteryList',{items:{path:"/entries",template:e}});f.addCustomData(new A({key:"aria-label",value:t.translationBundle.getText("Settings_EntryList_label")+s,writeToDom:true}));o=f.onAfterRendering;f.onAfterRendering=function(){var g=this.getItems(),h;o.apply(this,arguments);for(i=0;i<g.length;i++){h=g[i].getBindingContext().getPath();if(!t.getModel().getProperty(h+"/valueResult")){t._setEntryValueResult(h);}if(x){t._addXRayHelpId(h,g[i]);}}};return f;};d.prototype._addXRayHelpId=function(e,o){var h=this.getModel().getProperty(e+"/entryHelpID");if(h){o.addStyleClass("help-id-"+h);}};d.prototype._setEntryValueResult=function(e){var t=this;var i=this.getModel().getProperty(e+"/editable");var v=this.getModel().getProperty(e+"/valueArgument");if(typeof v==="function"){this.getModel().setProperty(e+"/valueResult",this.translationBundle.getText("genericLoading"));this.getModel().setProperty(e+"/editable",false);var o=v();o.done(function(f){t.getModel().setProperty(e+"/editable",i);t.getModel().setProperty(e+"/visible",typeof(f)==='object'?!!f.value:true);t.getModel().setProperty(e+"/valueResult",typeof(f)==='object'?f.displayText:f);});o.fail(function(){t.getModel().setProperty(e+"/valueResult",t.translationBundle.getText("loadingErrorMessage"));});}else if(!!v){this.getModel().setProperty(e+"/valueResult",v);this.getModel().setProperty(e+"/editable",i);}else{this.getModel().setProperty(e+"/valueResult",this.translationBundle.getText("loadingErrorMessage"));}};d.prototype._emitEntryOpened=function(e){var o=E.last("UserSettingsOpened")||{};var p=e.split("/").pop();o[p]=true;E.emit("UserSettingsOpened",o);};d.prototype._getUserPrefEntriesTemplate=function(){var t=this,i,p=function(e){var o={};o=jQuery.extend(true,{},{},e);sap.ui.require(['sap/m/FlexBox','sap/m/FlexAlignItems','sap/m/FlexJustifyContent','sap/m/BusyIndicator'],function(F,f,g,h){var j=true,k,s,m=o.getSource().getLabel(),n=o.getSource().getBindingContext().getPath();t.getModel().setProperty("/activeEntryPath",n);t._setDetailedEntryModeMode(true,n,m,n);t.oDialog.removeAllContent();s=t.getModel().getProperty(n+"/contentResult");if(s){k=sap.ui.getCore().byId(s);t.oDialog.addContent(k);t._emitEntryOpened(n);}else{var q=null,v,S=true,I=false,w=t.getModel().getProperty(n+"/contentFunc");if(typeof w==="function"){t._emitEntryOpened(n);v=w();v.done(function(x){S=false;if(I===true){t.oDialog.removeAllContent();q.destroy();}if(x instanceof sap.ui.core.Control){t.getModel().setProperty(n+"/contentResult",x.getId());t.oDialog.addContent(x);}else{j=false;}});v.fail(function(){S=false;if(I===true){t.oDialog.removeAllContent();q.destroy();}j=false;});v.always(function(){if(j===false){var x=new F("userPrefErrorFlexBox",{height:"5rem",alignItems:f.Center,justifyContent:g.Center,items:[new T("userPrefErrorText",{text:t.translationBundle.getText("loadingErrorMessage")})]});t.getModel().setProperty(n+"/contentResult",x.getId());t.oDialog.addContent(x);}});if(S===true){q=new h('userPrefLoadingBusyIndicator',{size:"2rem"});t.oDialog.addContent(q);I=true;}}}});};i=new c({label:"{title}",value:"{valueResult}",tooltip:{path:"valueResult",formatter:function(v){return typeof(v)==='string'?v:"";}},type:{path:"editable",formatter:function(e){return(e===true)?"Navigation":"Inactive";}},visible:{path:"visible",formatter:function(v){return(v!==undefined)?v:true;}},press:p,customData:new A({key:"aria-label",value:{parts:[{path:'title'},{path:'valueResult'}],formatter:function(s,v){v=v?v:"";return s+" "+v;}},writeToDom:true})});return i;};d.prototype._getUserDetailsControl=function(){return new O({title:this.oUser.getFullName(),text:this.oUser.getEmail()}).addStyleClass("sapUshellUserPrefUserIdentifier");};d.prototype._createCancelButton=function(){var t=this;return new B({id:"cancelButton",text:{parts:['/entries'],formatter:function(e){if(!e){return"";}var f=e.some(function(o){return o.editable;});return f>0?t.translationBundle.getText("cancelBtn"):t.translationBundle.getText("close");}},press:t._dialogCancelButtonHandler.bind(t),visible:true});};d.prototype._createSaveButton=function(){var t=this;return new B({id:"saveButton",text:this.translationBundle.getText("saveBtn"),press:t._dialogSaveButtonHandler.bind(t),visible:{parts:['/entries'],formatter:function(e){if(!e){return false;}return e.some(function(o){return o.editable;});}}});};d.prototype._setDetailedEntryModeMode=function(i,e,f,g){this.getModel().setProperty("/isDetailedEntryMode",!!i);this.getModel().setProperty("/dialogTitle",f);};d.prototype.showUserPreferencesDialog=function(){this.oUser=sap.ushell.Container.getUser();this.createDialog();this.oDialog.open();};d.prototype._dialogBackButtonHandler=function(e){var t=this;sap.ui.require(['sap/ui/layout/VerticalLayout'],function(V){t.getModel().setProperty("/isDetailedEntryMode",false);t.getModel().setProperty("/dialogTitle",t.translationBundle.getText("userSettings"));t.oDialog.removeAllContent();t.oDialog.addContent(t._getOriginalDialogContent());t._setEntryValueResult(t.getModel().getProperty("/activeEntryPath"));t.getModel().setProperty("/activeEntryPath",null);});};d.prototype._destroyDialog=function(){this.oHeadBar.destroy();this.oInitialContent.destroy();this.oInitialContent=null;this._modelCleanUpToInitial();this._entriesCleanUp();this.oDialog.destroy();this.saveButton.destroy();this.cancelButton.destroy();};d.prototype._entriesCleanUp=function(){var i,e=this.getModel().getProperty("/entries"),s,o;for(i=0;i<e.length;i++){var s=e[i].contentResult;delete e[i].contentResult;if(s){o=sap.ui.getCore().byId(s);o.destroy();o=null;}e[i].valueResult=null;}this.getModel().setProperty("/entries",e);};d.prototype._modelCleanUpToInitial=function(){this.getModel().setProperty("/isDetailedEntryMode",false);this.getModel().setProperty("/dialogTitle",this.translationBundle.getText("userSettings"));};d.prototype._dialogSaveButtonHandler=function(){var t=this,i,e=this.getModel().getProperty("/entries"),s=u.saveUserPreferenceEntries(e);i=this.getModel().getProperty("/isDetailedEntryMode");if(i){this.getModel().setProperty("/activeEntryPath",null);}s.done(function(){t._showSaveMessageToast();});s.fail(function(f){sap.ui.require(['sap/m/MessageBox'],function(M){var g,h="";if(f.length===1){g=t.translationBundle.getText("savingEntryError")+" ";}else{g=t.translationBundle.getText("savingEntriesError")+"\n";}f.forEach(function(j){g+=j.entry+"\n";h+="Entry: "+j.entry+" - Error message: "+j.message+"\n";});M.show(g,{icon:M.Icon.ERROR,title:t.translationBundle.getText("Error"),actions:[M.Action.OK]});jQuery.sap.log.error("Failed to save the following entries",h,"sap.ushell.ui.footerbar.UserPreferencesButton");});});this.oDialog.close();this._destroyDialog();};d.prototype._dialogCancelButtonHandler=function(){var i,e=this.getModel().getProperty("/entries");for(i=0;i<e.length;i++){if(e[i]&&e[i].onCancel){e[i].onCancel();}}this.oDialog.close();this._destroyDialog();};d.prototype._addDialogBackButton=function(){var t=this;var o=new B('userPrefBackBtn',{visible:"{/isDetailedEntryMode}",icon:sap.ui.core.IconPool.getIconURI("nav-back"),press:t._dialogBackButtonHandler.bind(t),tooltip:this.translationBundle.getText("feedbackGoBackBtn_tooltip")});var e=new T("userPrefTitle",{text:"{/dialogTitle}"});this.oHeadBar=new a({contentLeft:[o],contentMiddle:[e]});this.oDialog.setCustomHeader(this.oHeadBar);};d.prototype._showSaveMessageToast=function(){var t=this;sap.ui.require(['sap/m/MessageToast'],function(M){var m=t.translationBundle.getText("savedChanges");M.show(m,{duration:3000,width:"15em",my:"center bottom",at:"center bottom",of:window,offset:"0 -50",collision:"fit fit"});});};return d;},true);
