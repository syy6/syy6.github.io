/*!
 * Copyright (c) 2009-2017 SAP SE, All Rights Reserved
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/ManagedObject','sap/ui/core/Control','sap/ushell/library','sap/ui/core/Icon','sap/m/Text','sap/ushell/override','sap/ushell/resources','sap/ushell/ui/launchpad/PlusTile','sap/ushell/ui/launchpad/TileContainerRenderer'],function(q,M,C,l,I,T,o,r,P){"use strict";var a=C.extend("sap.ushell.ui.launchpad.TileContainer",{metadata:{library:"sap.ushell",properties:{scrollType:{type:"string",group:"Misc",defaultValue:'item'},animationSpeed:{type:"int",group:"Misc",defaultValue:500},groupId:{type:"string",group:"Misc",defaultValue:null},showHeader:{type:"boolean",group:"Misc",defaultValue:true},showPlaceholder:{type:"boolean",group:"Misc",defaultValue:true},defaultGroup:{type:"boolean",group:"Misc",defaultValue:false},isLastGroup:{type:"boolean",group:"Misc",defaultValue:false},headerText:{type:"string",group:"Misc",defaultValue:null},headerLevel:{type:"sap.m.HeaderLevel",group:"Misc",defaultValue:sap.m.HeaderLevel.H2},groupHeaderLevel:{type:"sap.m.HeaderLevel",group:"Misc",defaultValue:sap.m.HeaderLevel.H4},showGroupHeader:{type:"boolean",group:"Misc",defaultValue:true},homePageGroupDisplay:{type:"string",defaultValue:null},visible:{type:"boolean",group:"Misc",defaultValue:true},sortable:{type:"boolean",group:"Misc",defaultValue:true},showNoData:{type:"boolean",group:"Misc",defaultValue:false},noDataText:{type:"string",group:"Misc",defaultValue:null},isGroupLocked:{type:"boolean",group:"Misc",defaultValue:null},isGroupSelected:{type:"boolean",group:"Misc",defaultValue:false},editMode:{type:"boolean",group:"Misc",defaultValue:false},showBackground:{type:"boolean",group:"Misc",defaultValue:false},icon:{type:"string",group:"Misc",defaultValue:'sap-icon://locked'},showIcon:{type:"boolean",group:"Misc",defaultValue:false},deluminate:{type:"boolean",group:"Misc",defaultValue:false},showMobileActions:{type:"boolean",group:"Misc",defaultValue:false},enableHelp:{type:"boolean",group:"Misc",defaultValue:false},tileActionModeActive:{type:"boolean",group:"Misc",defaultValue:false},ieHtml5DnD:{type:"boolean",group:"Misc",defaultValue:false},showDragIndicator:{type:"boolean",group:"Misc",defaultValue:false},showEmptyLinksArea:{type:"boolean",group:"Misc",defaultValue:false},showEmptyLinksAreaPlaceHolder:{type:"boolean",group:"Misc",defaultValue:false},hidden:{type:"boolean",group:"Misc",defaultValue:false},transformationError:{type:"boolean",group:"Misc",defaultValue:false},supportLinkPersonalization:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{tiles:{type:"sap.ushell.ui.launchpad.Tile",multiple:true,singularName:"tile"},links:{type:"sap.ui.core.Control",multiple:true,singularName:"link"},beforeContent:{type:"sap.ui.core.Control",multiple:true,singularName:"beforeContent"},afterContent:{type:"sap.ui.core.Control",multiple:true,singularName:"afterContent"},footerContent:{type:"sap.ui.core.Control",multiple:true,singularName:"footerContent"},headerActions:{type:"sap.ui.core.Control",multiple:true,singularName:"headerAction"}},events:{afterRendering:{},add:{},titleChange:{}}}});a.prototype.init=function(){this.bIsFirstTitleChange=true;this._sDefaultValue=r.i18n.getText("new_group_name");this._sOldTitle="";this.oNoLinksText=new T({text:r.i18n.getText("emptyLinkContainerInEditMode")}).addStyleClass("sapUshellNoLinksAreaPresentTextInner");this.oTransformationErrorText=new T({text:r.i18n.getText("transformationErrorText")}).addStyleClass("sapUshellTransformationErrorText");this.oTransformationErrorIcon=new I({src:"sap-icon://message-error"}).addStyleClass("sapUshellTransformationErrorIcon");this.oIcon=new I({src:this.getIcon()});this.oIcon.addStyleClass('sapUshellContainerIcon');this.oPlusTile=new P({groupId:this.getGroupId(),enableHelp:this.getEnableHelp(),press:[this.fireAdd,this]});this.oPlusTile.setParent(this);if(sap.ushell.Container!=undefined){if(sap.ushell.Container.getService("LaunchPage").isLinkPersonalizationSupported()){a.prototype.isLinkPersonalizationOveride();}}};a.prototype.exit=function(){if(this.oPlusTile){this.oPlusTile.destroy();}};a.prototype.onAfterRendering=function(){var t=this;var e=this.getModel()&&this.getModel().getProperty("/enableRenameLockedGroup")||false;q("#"+this.getId()+"-title").find(this.getHeaderLevel()).click(function(){var b=e||!t.getIsGroupLocked()&&!t.getDefaultGroup()&&t.getTileActionModeActive();t.setEditMode(b);});if(sap.ui.Device.system.desktop){this.handleScreenReaderAttr();}var E=sap.ui.getCore().getEventBus();E.publish("launchpad","GroupHeaderVisibility");this.fireAfterRendering();};a.prototype.getTransformationErrorText=function(){return this.oTransformationErrorText;},a.prototype.getTransformationErrorIcon=function(){return this.oTransformationErrorIcon;},a.prototype.getNoLinksText=function(){return this.oNoLinksText;};a.prototype.setTransformationError=function(t){this.setProperty('transformationError',t,true);if(t){this.$().find(".sapUshellTransformationError").show();}else{this.$().find(".sapUshellTransformationError").hide();}this.$().find(".sapUshellNoLinksAreaPresent").toggleClass("sapUshellNoLinksAreaPresentError",t);return this;};a.prototype.updateAggregation=o.updateAggregation;a.prototype.updateTiles=function(R){var n="tiles";if(this.isTreeBinding(n)){M.prototype.updateAggregation.apply(this,arguments);}else{q.sap.log.debug("Updating TileContainer. Reason: ",R);switch(R){case"filter":try{this.filterTiles();}catch(e){this.updateAggregation(n);}break;default:this.updateAggregation(n);}}};a.prototype.handleNoItemsToDisplayMessage=function(){var t=this.getBinding('tiles'),i=t&&t.getContexts().length;if(i){this.$().find(".sapUshellNoFilteredItems").hide();}else{if(this.getShowNoData()){if(this.getNoDataText()){this.setNoDataText(this.getNoDataText());}else{this.setNoDataText(r.i18n.getText("noFilteredItems"));}this.$().find(".sapUshellNoFilteredItems").show();}}};a.prototype.createMissingElementsInOnScreenElements=function(i,e,b,g,s,B,f,A){var p,n=null,G=null,j=b,S=this.getShowGroupHeader(),c=e.length,d;for(j=b;j<c;j++){p=e[j].getPath();if(!i.onScreenPathIndexMap[p]){if(g&&s.length>0){n=s[0].fnGroup(e[j]);if(typeof n==="string"){n={key:n};}if(G===null&&j>0){G=s[0].fnGroup(e[j-1]);}if(n.key!==G){if(B.groupHeaderFactory){d=B.groupHeaderFactory(n);}if(!i.onScreenHeaders[n.key]){A(n,d);i.onScreenHeaders[n.key]={aItemsRefrenceIndex:this.getTiles().length-1,isVisible:S};}G=n.key;}}f(e[j]);i.onScreenPathIndexMap[p]={aItemsRefrenceIndex:this.getTiles().length-1,isVisible:true};}else{throw true;}}};a.prototype._newLinkContainerEnabled=function(){return this.getSupportLinkPersonalization();};a.prototype.addNewItem=function(e){var n="tiles",A=this.getMetadata().getJSONKeys()[n],b=this.mBindingInfos[n],f=b.factory,c=q.proxy(function(d){var i=this.getId()+"-"+q.sap.uid(),g=f(i,d);g.setBindingContext(d,b.model);this[A._sMutator](g);},this);c(e);};a.prototype.markVisibleOnScreenElements=function(e,i){var b=0,p,c=e.length;for(b=0;b<c;b++){p=e[b].getPath();if(i.onScreenPathIndexMap[p]){i.onScreenPathIndexMap[p].isVisible=true;}else{return b;}}return b;};a.prototype.indexOnScreenElements=function(b){var p,i,c={onScreenHeaders:{},onScreenPathIndexMap:{}},d=b.length,e;for(i=0;i<d;i++){e=b[i];if(e.getHeaderText){c.onScreenHeaders[e.getHeaderText()]={aItemsRefrenceIndex:i,isVisible:false};}else if(e.getBindingContext()){p=e.getBindingContext().getPath();c.onScreenPathIndexMap[p]={aItemsRefrenceIndex:i,isVisible:false};}}return c;};a.prototype.showHideTilesAndHeaders=function(i,b){var s,n="tiles",S=this.getShowGroupHeader(),B=this.mBindingInfos[n].binding,g,c,e;for(s in i.onScreenPathIndexMap){if(i.onScreenPathIndexMap.hasOwnProperty(s)){e=i.onScreenPathIndexMap[s];c=b[e.aItemsRefrenceIndex];c.setVisible(e.isVisible);if(e.isVisible){g=B.aSorters[0].fnGroup(c.getBindingContext());i.onScreenHeaders[g].isVisible=S;}}}for(s in i.onScreenHeaders){if(i.onScreenHeaders.hasOwnProperty(s)){e=i.onScreenHeaders[s];b[e.aItemsRefrenceIndex].setVisible(e.isVisible);}}};a.prototype.filterTiles=function(){var n="tiles",b=this.mBindingInfos[n],B=this.mBindingInfos[n].binding,c=B.getContexts(),i=this.getTiles(),d,e,f,g,s,h,j,k;e=this.indexOnScreenElements(i);d=this.markVisibleOnScreenElements(c,e);if(c[d]&&this.getTiles().length>0){f=this.getTiles()[this.getTiles().length-1].getBindingContext().getPath();g=c[d].getPath();s=f.split('/');h=g.split('/');k=s[s.length-1];j=h[h.length-1];if(parseInt(k,10)>parseInt(j,10)){throw true;}}this.createMissingElementsInOnScreenElements(e,c,d,B.isGrouped(),B.aSorters,b,this.addNewItem.bind(this),this.addTileGroup.bind(this));i=this.getTiles();this.showHideTilesAndHeaders(e,i);this.handleNoItemsToDisplayMessage();if(sap.ui.Device.system.desktop){this.handleScreenReaderAttr();}};a.prototype.addTileGroup=function(g,h){this.addAggregation("tiles",h||new sap.ushell.ui.launchpad.HeaderTile({headerText:g.text||g.key,headerLevel:g.headerLevel||this.getGroupHeaderLevel(),visible:this.getShowGroupHeader()}));};a.prototype.setNoDataText=function(n){this.setProperty("noDataText",n,true);if(this.getShowNoData()){this.$().find(".sapUshellNoFilteredItems").text(n);}return this;};a.prototype.setGroupId=function(v){this.setProperty("groupId",v,true);if(this.oPlusTile){this.oPlusTile.setGroupId(v);}return this;};a.prototype.setHeaderText=function(h){this.setProperty("headerText",h,true);this.$().find(".sapUshellContainerTitle").text(h);return this;};a.prototype.setVisible=function(v){this.setProperty("visible",v,true);this.toggleStyleClass("sapUshellHidden",!v);return this;};a.prototype.setShowMobileActions=function(s){var S=true;if(this.oHeaderButton){this.oHeaderButton.setVisible(s);}else if(s){S=false;}this.setProperty('showMobileActions',s,S);};a.prototype.setShowIcon=function(s){this.setProperty('showIcon',s,true);q('#'+this.getId()).find('.'+'sapUshellContainerIcon').toggleClass('sapUshellContainerIconHidden',!s);};a.prototype.setDeluminate=function(d){this.setProperty('deluminate',d,true);this.toggleStyleClass('sapUshellDisableLockedGroupDuringDrag',d);return this;};sap.ushell.ui.launchpad.TileContainer.prototype.setHidden=function(h){this.setProperty("hidden",!!h,true);this.toggleStyleClass("sapUshellTileContainerEditModeHidden",!!h);return this;};a.prototype.groupHasTiles=function(){var p='',t=this.getTiles(),b=[];if(this.getBindingContext()){p=this.getBindingContext().sPath;t=this.getModel().getProperty(p).tiles;}return sap.ushell.utils.groupHasVisibleTiles(t,b);};a.prototype.handleScreenReaderAttr=function(){var c=this.getInnerContainersDomRefs();var b=c[0].children;if(!b||b.length==0||!b[0].classList.contains("sapUshellHeaderTile")){return;}var d;var e;var f=[];for(var i=0;i<b.length;i++){if(b[i].classList.contains("sapUshellHidden")){continue;}if(b[i].classList.contains("sapUshellHeaderTile")){d=b[i];q(d).attr("role","heading");q(d).attr("aria-level","3");e=0;f=[];}else if(b[i].tagName=="LI"){e++;q(b[i]).attr("aria-posinset",e);f.push(b[i]);var n=b[i+1];if(!n||n.tagName!="LI"){for(var j=0;j<f.length;j++){q(f[j]).attr("aria-setsize",f.length);}}}}};a.prototype.getInnerContainerDomRef=function(){var c=this.getDomRef(),i;if(!c){return null;}i=q(c).find('.sapUshellTilesContainer-sortable');return i[0];};a.prototype.getInnerContainersDomRefs=function(){var c=this.getDomRef(),i,b;if(!c){return null;}i=q(c).find('.sapUshellTilesContainer-sortable');b=q(c).find('.sapUshellLineModeContainer');return[i[0],b[0]];};a.prototype.setEditMode=function(v){if(v){this.addStyleClass('sapUshellEditing');this._startEdit();}else{this.setProperty('editMode',v,false);this.removeStyleClass('sapUshellEditing');}};a.prototype.isLinkPersonalizationOveride=function(){a.prototype.updateLinks=function(R){var g=this.getParent(),t=g&&g.getDisplayMode&&g.getDisplayMode()==='tabs';if(t&&!this.getTileActionModeActive()){g.removeLinksFromUnselectedGroups();}if(this.getLinks().length>0){this.removeAllLinks();}M.prototype.updateAggregation.call(this,"links");};a.prototype.destroyLinks=function(R){q.sap.log.debug("link is destroyed because: "+R,null,"sap.ushell.ui.launchpad.TileContainer");};};a.prototype.setShowEmptyLinksArea=function(v){this.setProperty('showEmptyLinksArea',v,true);this.toggleStyleClass("sapUshellLinksAreaHidden",!v);};a.prototype.setShowEmptyLinksAreaPlaceHolder=function(v){this.setProperty('showEmptyLinksArea',v,true);this.toggleStyleClass("sapUshellTileContainerEditMode",v);this.toggleStyleClass("sapUshellTileContainerTabsModeEmptyLinksArea",v);this.toggleStyleClass("sapUshellEmptyLinksAreaPlaceHolder",!v);};a.prototype._startEdit=function(){var t=this;if(this.getModel()&&!this.getModel().getProperty("/editTitle")){this.getModel().setProperty("/editTitle",true,false);}if(!this.oEditInputField){sap.ui.require(['sap/m/Input'],function(b){t.setProperty('editMode',true,false);t.oEditInputField=new b({placeholder:t._sDefaultValue,value:t.getHeaderText()}).addStyleClass('sapUshellTileContainerTitleInput');t.oEditInputField.addEventDelegate({onAfterRendering:function(){setTimeout(function(){var e=t.oEditInputField.getDomRef();if(e){if(q('#'+e.id+":visible").length>0){setTimeout(function(){q(e).find('input').focus();}.bind(t),100);var w=q(window).height(),j=t.getDomRef(),g=j.offsetHeight,c=j.getBoundingClientRect().top,d=j.offsetTop;if(g+c>w){q('.sapUshellDashboardView section').stop().animate({scrollTop:d},0);}}}}.bind(t),100);}.bind(t),onfocusout:function(e){t._stopEdit();q.proxy(t.setEditMode,t,false)();},onsapenter:function(e){t._stopEdit();q.proxy(t.setEditMode,t,false)();setTimeout(function(){var c=e.srcControl,j=q(c.getDomRef()).prev();j.focus();},0);}});t.oEditInputField.setValue(t.getHeaderText());});}else{this.oEditInputField.setValue(this.getHeaderText());t.setProperty('editMode',true,false);}this._sOldTitle=this._sDefaultValue;if(sap.ui.Device.system.phone){var t=this;setTimeout(function(){var e=sap.ui.getCore().getEventBus();e.publish("launchpad","scrollToGroup",{group:t,groupChanged:false,focus:false});},100);}};a.prototype._stopEdit=function(){var c=this.getHeaderText();var n=this.oEditInputField.getValue(),h;n=n.substring(0,256).trim()||this._sDefaultValue;h=n!==c;if(this.bIsFirstTitleChange&&n===this.oEditInputField.getPlaceholder()){h=true;}this.bIsFirstTitleChange=false;if(this.getModel()&&this.getModel().getProperty("/editTitle")){this.getModel().setProperty("/editTitle",false,false);}if(!this._sOldTitle){this._sOldTitle=c;this.setHeaderText(c);}else if(h){this.fireTitleChange({newTitle:n});this.setHeaderText(n);}};a.prototype.exit=function(){if(this.oHeaderButton){this.oHeaderButton.destroy();}if(this.oActionSheet){this.oActionSheet.destroy();}if(C.prototype.exit){C.prototype.exit.apply(this,arguments);}};return a;});
