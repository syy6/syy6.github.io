// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/core/theming/Parameters','sap/ushell/library','sap/ui/Device','sap/ui/core/IconPool','./ShellTitle','sap/ushell/Config','./ShellAppTitle','./ShellHeaderRenderer'],function(q,C,T,l,D,I,S,a){"use strict";var s=0,n=0;var L;var i;var b;var c;var d="sapUshellShellShowSearchOverlay";var M=3,e=1,f=0.5,g=9,A=3,h=3,j=12;var k=C.extend("sap.ushell.ui.shell.ShellHeader",{metadata:{properties:{logo:{type:"sap.ui.core.URI",defaultValue:""},showLogo:{type:"boolean",defaultValue:true},searchState:{type:"string",defaultValue:"COL"},ariaLabel:{type:"string",defaultValue:undefined},showSeparators:{type:"boolean",group:"Appearance",defaultValue:true}},aggregations:{headItems:{type:"sap.ushell.ui.shell.ShellHeadItem",multiple:true},headEndItems:{type:"sap.ushell.ui.shell.ShellHeadItem",multiple:true},search:{type:"sap.ui.core.Control",multiple:false},user:{type:"sap.ushell.ui.shell.ShellHeadUserItem",multiple:false},title:{type:"sap.ushell.ui.shell.ShellTitle",multiple:false},appTitle:{type:"sap.ushell.ui.shell.ShellAppTitle",multiple:false}},associations:{shellLayout:{type:"sap.ui.base.ManagedObject",multiple:false}},events:{searchSizeChanged:{}}}});k.prototype.setVisible=function(v){v=v===undefined?true:!!v;q(".sapUshellShellHead, .sapUshellShellHead > .sapUshellShellCntnt").css("display",v?"":"none");C.prototype.setVisible.call(this,v);};k.prototype.getShellLayoutControl=function(){return sap.ui.getCore().byId(this.getShellLayout());};k.prototype.createUIArea=function(m){var o=document.getElementById('shell-hdrcntnt');var p=m||'canvas';var r=document.getElementById(p);if(r&&!o){r.insertAdjacentHTML('beforebegin','<header id="shell-hdr" class="sapContrastPlus sapUshellShellHead">'+'</header>');if(!this.getVisible()){this.setVisible(false);}this.placeAt('shell-hdr');}};k.prototype.SearchState={COL:"COL",EXP:"EXP",EXP_S:"EXP_S"};k.prototype.init=function(){this._rtl=sap.ui.getCore().getConfiguration().getRTL();this._handleMediaChange=function(p){if(!this.getDomRef()){return;}if(this.getSearchState()!=this.SearchState.COL){this._setMaxWidthForAppTitleAndTitle();this._handleSearchSizeChanged();return;}this._refresh();};D.media.attachHandler(this._handleMediaChange,this,D.media.RANGESETS.SAP_STANDARD);this._handleResizeChange=function(){if(!this.getDomRef()){return;}var u=this.getUser();if(this.getUser()){u._checkAndAdaptWidth(!this.$("hdr-search").hasClass("sapUshellShellHidden")&&!!this.getSearch());}if(this.getSearchState()!=this.SearchState.COL){this._setMaxWidthForAppTitleAndTitle();this._handleSearchSizeChanged();return;}this._refresh();};D.resize.attachHandler(this._handleResizeChange,this);this.data("sap-ui-fastnavgroup","true",true);this.oTitle=null;};k.prototype.exit=function(){D.media.detachHandler(this._handleMediaChange,this,D.media.RANGESETS.SAP_STANDARD);D.resize.detachHandler(this._handleResizeChange,this);if(this.oTitle){this.oTitle.destroy();}var m=document.getElementById('shell-hdr');if(m){m.parentElement.removeChild(m);}};k.prototype.setAccessKeyHandler=function(m){this._accessKeyHandler=m;};k.prototype.attachAccessKeyHander=function(m){if(!m){return;}q("#sapUshellHeaderAccessibilityHelper").focusin(function(E){var v=sap.ui.getCore().byId('viewPortContainer'),o=v.getCurrentState(),p;if(m.bForwardNavigation){switch(o){case"Center":if(m.getAppKeysHandler()){setTimeout(function(){m.fnExternalKeysHandler(E,m.bFocusPassedToExternalHandlerFirstTime);m.bFocusPassedToExternalHandlerFirstTime=false;m.bFocusOnShell=false;},0);}else{var r=q(":focusable").filter("[tabindex!='-1']"),t=r.index(document.activeElement),p=r.eq(t+1);if(!p.length){var u=document.getElementById(v.getCurrentCenterPage());if(u.tagName==="IFRAME"){m.bForwardNavigation=false;u.focus();}else{p=r[0];}}}break;case"LeftCenter":p=q("#logoutBtn");if(p.length===0){p=q("#userStatusOpener");}break;case"RightCenter":p=q("#sapUshellNotificationIconTabByDate");m.bFocusOnShell=false;break;}}else{var H=this.getHeadEndItems(),w;if(H.length>0){w=H[H.length-1];p=w;}else p=this.getAppTitle();}setTimeout(function(){if(p){p.focus();}},0);}.bind(this));};k.prototype.onAfterRendering=function(){this._refresh();this.$("icon").one('load',this._refresh.bind(this));var m=this.getShellLayoutControl();if(m){this.$("hdr-center").toggleClass("sapUshellShellAnim",m.getShowAnimation());}var o=this.$("hdr-search-container");if(s!=n){if(this.getSearchState()==this.SearchState.COL){o.one('transitionend',function(){q(this).addClass("sapUshellShellSearchHidden");});}this._setSearchContainerMaxSize(n,false);var p={remSize:this._convertPxToRem(this.getSearchContainerRect(n).width),isFullWidth:this.isPhoneState()};this.fireSearchSizeChanged(p);}else if(this.getSearchState()==this.SearchState.COL){q(o).addClass("sapUshellShellSearchHidden");}if(a.last("/core/extension/enableHelp")){q('#actionsBtn').addClass('help-id-actionsBtn');q('#configBtn').addClass('help-id-configBtn');q('#homeBtn').addClass('help-id-homeBtn');}this.attachAccessKeyHander(this._accessKeyHandler);};k.prototype.onThemeChanged=function(){this.invalidate();};k.prototype._getLogo=function(){return this.getLogo()||T._getThemeImage(null,true);};k.prototype._handleSearchSizeChanged=function(){var m;if(this.getSearchState()==this.SearchState.COL){return;}else if(this.getSearchState()==this.SearchState.EXP){m=s;this._handleExpSearchState(m);}else if(this.getSearchState()==this.SearchState.EXP_S){m=this._handleExpSSearchState();this._setSearchContainerMaxSize(m);}var o={remSize:this._convertPxToRem(this.getSearchContainerRect(m).width),isFullWidth:this.isPhoneState()};this.fireSearchSizeChanged(o);};k.prototype._refresh=function(){var u=this.getUser();if(u){u._refreshImage();u._checkAndAdaptWidth(!!this.getSearch());}if(!this.hasStyleClass("sapUshellShellHideLogo")){this._saveLogoWidth();}this._setMaxWidthForAppTitleAndTitle();if(this.getSearchState()!=this.SearchState.COL){this._adjustHeaderWithSearch();}this._saveSearchPhoneStateThreshold();};k.prototype._saveLogoWidth=function(){var o=this.$("hdr-begin").find(".sapUshellShellIco");if(o){i=parseInt(o.css("padding-left"),10);b=parseInt(o.css("padding-right"),10);L=this.$("icon")[0].getBoundingClientRect().width;}};k.prototype._convertPxToRem=function(p){var r=parseFloat(T.get("sapUiFontSize"));return p/r;};k.prototype._convertRemToPx=function(r){var m=parseFloat(T.get("sapUiFontSize"));return r*m;};k.prototype._setMaxWidthForAppTitleAndTitle=function(){this._setMaxWidthForAppTitle();if(this.isLSize()){this._setMaxWidthForTitle();}else{this._setAppTitleFontSize();}};k.prototype._setMaxWidthForAppTitle=function(){var m=this.$("hdr-appTitle");var o=this.$("hdr-appTitle").find(".sapUshellHeadTitle");if(!m.length){return;}o.removeClass('sapUshellHeadTitleWithSmallerFontSize');m.css({'max-width':'none'});var p=this._calcCenterWidth();var t=0;if(this.isLSize()){var r=this.$("hdr-title");if(r.length){t=r[0].getBoundingClientRect().width;}}var P=this.isSSize()?e:M;var w=this._convertPxToRem(p-t)-2*P;var u=m.find('.sapUshellShellHeadAction');var v=u.length?A+1.5:A;if(w<v){w=v;}m.css({'max-width':w+"rem"});};k.prototype._calcCenterWidth=function(){var m=this.$("hdr-appTitle")[0].getBoundingClientRect();var o=this.$("hdr-begin")[0].getBoundingClientRect();var p=this.$("hdr-end")[0].getBoundingClientRect();var r;if(this._isOverlapping(o,m)||this._isOverlapping(m,p)){var t=o.width;var u=p.width;var v=this.$()[0].getBoundingClientRect().width;r=v-2*Math.max(t,u);}else{var w=this.$("hdr-center");var r=w[0].getBoundingClientRect().width;}return r;};k.prototype._setMaxWidthForTitle=function(){var m=this.$("hdr-title");if(!m.length){return;}m.css({'max-width':j+"rem",'opacity':1});var o=this.$("hdr-appTitle");if(!o||!o[0]){return;}var r=this._isOverlapping(m[0].getBoundingClientRect(),o[0].getBoundingClientRect(),M,false);if(r){var t=m[0].getBoundingClientRect().width;var p=this._convertPxToRem(t-r);if(p<h){m.css({'opacity':0});}else{m.css({'max-width':p+"rem"});}}};k.prototype._setAppTitleFontSize=function(){var o=this.$("hdr-appTitle").find(".sapUshellHeadTitle");if(o&&o[0]){var m=o[0].scrollWidth;var p=o[0].clientWidth;if(m>p){o.addClass('sapUshellHeadTitleWithSmallerFontSize');}}};k.prototype._adjustHeaderWithSearch=function(m){var o=this.$("hdr-appTitle");if(!o.length||o.css('opacity')=="0"||o.css('display')=="none"){return;}var p=o[0].getBoundingClientRect();var r;if(m){r=this.getSearchContainerRect(m);}else{var t=this.$("hdr-search-container");r=this.getSearchContainerRect(parseFloat(t.get(0).style.maxWidth));}var O=this._isOverlapping(p,r,f,true);if(!O){return;}else if(O){var u=p.width;o.css({'max-width':this._convertPxToRem(u-O)+"rem"});}};k.prototype.setAppTitle=function(o){o.attachTextChanged(this._handleAppTitleChange,this);this.setAggregation("appTitle",o,true);};k.prototype.removeAppTitle=function(o){o.detachedTextChanged(this._handleAppTitleChange);this.removeAggregation("appTitle");};k.prototype._handleAppTitleChange=function(){if(!this.getDomRef()){return;}if(this.getSearchState()!=this.SearchState.COL){this._setMaxWidthForAppTitleAndTitle();this._handleSearchSizeChanged();}};k.prototype.setTitleControl=function(t,o){this.oTitle=this.oTitle||sap.ui.getCore().byId("shellTitle");if(this.oTitle){this.oTitle.destroy();}this.oTitle=new S("shellTitle",{text:t,icon:I.getIconURI("overflow")});this.oTitle.setInnerControl(o);this.setTitle(this.oTitle);};k.prototype.removeHeadItem=function(v){if(typeof v==='number'){v=this.getHeadItems()[v];}this.removeAggregation('headItems',v);};k.prototype.addHeadItem=function(o){this.addAggregation('headItems',o);};k.prototype.isPhoneState=function(){var m=D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD).name;var E=true;var H=this.$().width();if(H<=c){E=false;}return(D.system.phone||m=="Phone"||!E);};k.prototype.isLSize=function(){var m=D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD).name;return(m=="Desktop");};k.prototype.isSSize=function(){var m=D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD).name;return(D.system.phone||m=="Phone");};k.prototype.getSearchContainerRect=function(m){var o=q("<div> </div>").css("max-width",m+"rem");var p=q("<div></div>").append(o).insertAfter(this.$("hdr-search-container"));o.addClass('sapUshellShellSearch');var t=o[0].getBoundingClientRect();p.remove();return t;};k.prototype.setSearchState=function(m,o,w){if(typeof m!=="string"||!this.SearchState.hasOwnProperty(m)){return;}this.requiredRemSize=o;this.setProperty('searchState',m,false);var p;if(m===this.SearchState.COL){p=this._handleColSearchState(true);}else if(m===this.SearchState.EXP){this.bWithOverlay=(w===false)?false:true;p=this._handleExpSearchState(o,true);}else if(m==this.SearchState.EXP_S){this.bWithOverlay=(w===true)?true:false;p=this._handleExpSSearchState(o,true);}this._setSearchContainerMaxSize(p,true);};k.prototype.getSearchAvailableSize=function(){var m=this._convertPxToRem(this._getSizeToAppTitle());var o=m-this._getMinPaddingRemSize();return(o>=0?o:0);};k.prototype._getSizeToAppTitle=function(){var o=this.$("hdr-center");var m=o[0];var p=this.$("hdr-appTitle").find(".sapUshellAppTitle");var r=p[0];var t;if(this._rtl){t=r?r.getBoundingClientRect().left-m.getBoundingClientRect().left:this._getSizeToTitle();}else{t=r?m.getBoundingClientRect().right-r.getBoundingClientRect().right:this._getSizeToTitle();}return t;};k.prototype._getSizeToTitle=function(){var o=this.$("hdr-center");var m=o[0];var t=this.$("hdr-title").find(".sapUshellHeadTitle");var p=t[0];var r;if(this._rtl){r=p?p.getBoundingClientRect().left-m.getBoundingClientRect().left:this._getSizeToLogo();}else{r=p?m.getBoundingClientRect().right-p.getBoundingClientRect().right:this._getSizeToLogo();}return r;};k.prototype._getSizeToLogo=function(){var o=this.$("hdr-center");var m=o[0];var p=m.getBoundingClientRect().width+this._getSearchButtonWidth();var r=this.$("hdr-begin").find(".sapUshellShellIco");var t=r[0];var u=false;if(this.hasStyleClass("sapUshellShellHideLogo")){u=true;}if(t&&u){var v=this._rtl?b:i;return p-L-v;}else{var v=this._rtl?i:b;return p+v;}};k.prototype._getMaxSize=function(){var o=this.$("hdr-center");var m=o[0];var p=this.$("hdr-begin").find(".sapUshellShellIco");var r=p[0];var t=false;if(this.hasStyleClass("sapUshellShellHideLogo")){t=true;}var u;if(r&&!t){var v=this._rtl?i:b;u=L+v;}else{u=0;}var w=m.getBoundingClientRect().width+this._getSearchButtonWidth()+u;return w;};k.prototype._getSearchButtonWidth=function(){var o=this.getHeadEndItems()[0];if(o&&o.getVisible()){var m=o.getDomRef();var p=m.getBoundingClientRect().width;return p;}return 0;};k.prototype._handleColSearchState=function(m){var o=this.getShellLayoutControl();if(o){o.removeStyleClass(d);}this.removeStyleClass(d);this.removeStyleClass("sapUshellShellHideLogo");this.removeStyleClass("sapUshellShellHideSubtitle");this.removeStyleClass("sapUshellShellHideAppTitle");if(this.isPhoneState()){return this._handleColSearchStatePhone();}return 0;};k.prototype._handleExpSearchState=function(r,m){var o=this.getShellLayoutControl();if(o){o.toggleStyleClass(d,this.bWithOverlay);}this.toggleStyleClass(d,this.bWithOverlay);if(this.isPhoneState()){this._handleExpAndExpSSearchStatePhone();return r;}else{return this._handleExpSearchStateLargeScreen(r,m);}};k.prototype._handleExpSearchStateLargeScreen=function(r,m){var o;this.removeStyleClass("sapUshellShellHideForPhone");var p=this._convertPxToRem(this._getMaxSize());var t=this._convertPxToRem(this._getSizeToTitle());var u=this._convertPxToRem(this._getSizeToAppTitle());var v=this._convertPxToRem(this._getSizeToLogo());if(r>p){this.addStyleClass("sapUshellShellHideLogo");this.addStyleClass("sapUshellShellHideSubtitle");this.addStyleClass("sapUshellShellHideAppTitle");o=p;}else if(r>v-this._getMinPaddingRemSize()){this.addStyleClass("sapUshellShellHideLogo");this.addStyleClass("sapUshellShellHideSubtitle");this.addStyleClass("sapUshellShellHideAppTitle");o=r;}else if(r>t-this._getMinPaddingRemSize()){this.addStyleClass("sapUshellShellHideSubtitle");this.addStyleClass("sapUshellShellHideAppTitle");this.removeStyleClass("sapUshellShellHideLogo");o=r;}else if(r>u-this._getMinPaddingRemSize()){this.addStyleClass("sapUshellShellHideAppTitle");this.removeStyleClass("sapUshellShellHideSubtitle");this.removeStyleClass("sapUshellShellHideLogo");o=r;}else{this.removeStyleClass("sapUshellShellHideAppTitle");this.removeStyleClass("sapUshellShellHideSubtitle");this.removeStyleClass("sapUshellShellHideLogo");o=r;}return o;};k.prototype._handleExpSSearchState=function(r,m){var o=this.getShellLayoutControl();if(o){o.toggleStyleClass(d,this.bWithOverlay);}this.toggleStyleClass(d,this.bWithOverlay);if(this.isPhoneState()){this._handleExpAndExpSSearchStatePhone();return r;}else{var p=this._handleExpSSearchStateLargeScreen(r,m);if(p>this.requiredRemSize){p=this.requiredRemSize;}return p;}};k.prototype._handleExpSSearchStateLargeScreen=function(r,m){var o;this.removeStyleClass("sapUshellShellHideForPhone");var p=this._convertPxToRem(this._getSizeToAppTitle());if(p-this._getMinPaddingRemSize()<g){p=g+this._getMinPaddingRemSize();}if(!r){r=p;}if(r>p-this._getMinPaddingRemSize()){o=p-this._getMinPaddingRemSize();}else{o=r;}this.removeStyleClass("sapUshellShellHideLogo");this.removeStyleClass("sapUshellShellHideSubtitle");this.removeStyleClass("sapUshellShellHideAppTitle");return o;};k.prototype._handleExpAndExpSSearchStatePhone=function(){this.addStyleClass("sapUshellShellHideForPhone");};k.prototype._handleColSearchStatePhone=function(){this.removeStyleClass("sapUshellShellHideForPhone");return 0;};k.prototype._setSearchContainerMaxSize=function(m,o){if(!o){var p=this.$("hdr-search-container");p.css("max-width",m+"rem");s=n=m;}else{n=m;}this._adjustHeaderWithSearch(m);};k.prototype._getMinPaddingRemSize=function(){if(this._convertPxToRem(this._getSizeToAppTitle())<g){return f;}else{return M;}};k.prototype._saveSearchPhoneStateThreshold=function(){if(this.hasStyleClass("sapUshellShellHideForPhone")){return;}var m=this.getSearchAvailableSize();if(m==0){m=-f;}var o=this._maxRemToRemoveFromAppTitle();if(m+o<g){var H=this.$().width();c=H+this._convertRemToPx(g-m-o);}return c;};k.prototype._maxRemToRemoveFromAppTitle=function(){var m=this.$("hdr-appTitle");var o=m.find(".sapUshellHeadTitle");if(!m.length||!o.length){return 0;}var p=this._convertPxToRem(o[0].getBoundingClientRect().width);var r=(p-A)>0?(p-A):0;return r;};k.prototype._isOverlapping=function(m,o,p,P){if(!p){p=0;}if(this._rtl){var r=m.left;var t=o.right;if(P){r=r-this._convertRemToPx(p);}else{t=t+this._convertRemToPx(p);}if(r<t){return t-r;}}else{var u=m.right;var v=o.left;if(P){u=u+this._convertRemToPx(p);}else{v=v-this._convertRemToPx(p);}if(v<u){if(m.bottom>o.top&&m.bottom<o.bottom){return u-v;}}}return 0;};k.prototype.getSearchMaxWidth=function(){return s;};return k;},true);
