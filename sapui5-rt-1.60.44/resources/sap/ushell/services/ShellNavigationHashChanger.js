// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/routing/HashChanger","sap/ui/thirdparty/hasher"],function(H,h){"use strict";function c(){var b=window.history.length;var m={onHashChanged:function(){if(window.history.length!==b){m.onHashChanged=function(){};m.isInitialNavigation=function(){return false;};}},isInitialNavigation:function(){return true;}};return m;}var O={HASH_SET:{name:"hashSet",historyEntry:true},HASH_REPLACED:{name:"hashReplaced",historyEntry:false},SHELL_HASH_CHANGED:{name:"shellHashChanged",historyEntry:true,usedByUi5HistoryDetection:true},SHELL_HASH_PARAMETER_CHANGED:{name:"shellHashParameterChanged",historyEntry:false},HASH_CHANGED:{name:"hashChanged",historyEntry:false,usedByUi5HistoryDetection:true}};var S=H.extend("sap.ushell.services.ShellNavigatonHashChanger",{constructor:function(C){var u;this.oServiceConfig=C;if(jQuery.sap.getUriParameters().get("sap-ushell-reload")){if(jQuery.sap.getUriParameters().get("sap-ushell-reload")==="X"||jQuery.sap.getUriParameters().get("sap-ushell-reload")==="true"){u=true;}else{u=false;}}if(u!==undefined){if(typeof this.oServiceConfig!=="object"){this.oServiceConfig={};}this.oServiceConfig.reload=u;}H.apply(this);this._initializedByShellNav=false;this.oURLShortening=sap.ushell.Container.getService("URLShortening");this.privfnShellCallback=null;this.privappHashPrefix="&/";this.privhashPrefix="#";this.aNavigationFilters=[];this.NavigationFilterStatus={Continue:"Continue",Custom:"Custom",Abandon:"Abandon",Keep:"Keep"};}});S.prototype.privgetCurrentShellHash=function(){var r=this.privsplitHash(h.getHash());return{hash:"#"+((r&&r.shellPart)?r.shellPart:"")};};S.prototype.privconstructHash=function(A){var o=this.privgetCurrentShellHash();o.hash+=A;return o;};S.prototype.privconstructShellHash=function(s){return sap.ushell.Container.getService("URLParsing").constructShellHash(s);};S.prototype.privsplitHash=function(s){var o,b,A;if(s===undefined||s===null||s===""){return{shellPart:null,appSpecificRoute:null,intent:null,params:null};}o=sap.ushell.Container.getService("URLParsing").parseShellHash(s);if(o===undefined||o===null){return null;}b=(o.params&&!jQuery.isEmptyObject(o.params))?o.params:null;A=o.appSpecificRoute;o.appSpecificRoute=undefined;return{shellPart:this.privstripLeadingHash(this.privconstructShellHash(o))||null,appSpecificRoute:A||null,intent:(o.semanticObject&&o.action&&(o.semanticObject+"-"+o.action+(o.contextRaw||"")))||null,params:b};};S.prototype.privsetHash=function(f,A,w){h.prependHash="";f=this.privstripLeadingHash(f);A=A||"";if(w===undefined){w=true;}if(w){this.fireEvent("hashSet",{sHash:A});h.setHash(f);}else{this.fireEvent("hashReplaced",{sHash:A});h.replaceHash(f);}};S.prototype.privstripLeadingHash=function(s){if(s[0]==='#'){return s.substring(1);}return s;};S.prototype.registerNavigationFilter=function(f){if(typeof f!=="function"){throw new Error("fnFilter must be a function");}this.aNavigationFilters.push(f);};S.prototype.unregisterNavigationFilter=function(f){if(typeof f!=="function"){throw new Error("fnFilter must be a function");}this.aNavigationFilters=this.aNavigationFilters.filter(function(r){return r!==f;});};function a(C,t){this.oAppState=undefined;this.oPromise=(new jQuery.Deferred()).resolve();this.getNextKey=function(){this.oAppState=sap.ushell.Container.getService("AppState").createEmptyAppState(C,t);return this.oAppState.getKey();};this.store=function(v){var n;this.oAppState.setData(v);n=this.oAppState.save();this.oPromise=jQuery.when(this.oPromise,n);};this.getPromise=function(){return this.oPromise;};}S.prototype.compactParams=function(p,r,C,t){var u=sap.ushell.Container.getService("URLParsing"),s,o,R,P,d=new jQuery.Deferred(),b=u.constructShellHash({"target":{"semanticObject":"SO","action":"action"},"params":p},s);if(p===undefined||Object.keys(p).length===0){return d.resolve(p).promise();}s=new a(C,t);R=this.oURLShortening.compactHash(b,r,s);o=u.parseParameters(R.hash.match(/\?.*/)[0]);P=s.getPromise();P.done(function(){d.resolve(o);}).fail(function(m){d.reject(m);});return d;};S.prototype.hrefForExternal=function(A,v,C,b){var r=this.hrefForExternalNoEnc(A,v,C,b);function e(R,v){if(v===true){R.hash=encodeURI(R.hash);}else{R=encodeURI(R);}return R;}if(!b){return e(r,v);}var d=new jQuery.Deferred();r.done(function(R){d.resolve(e(R,v));}).fail(d.reject.bind(d));return d;};S.prototype.hrefForExternalNoEnc=function(A,v,C,b){var t,p,d,s=new a(C),r;t=this.privhrefForExternalNoEnc(A,s);if(v===true){r={hash:t.hash,params:t.params,skippedParams:t.skippedParams};}else{r=t.hash;}if(!b){return r;}p=s.getPromise();d=new jQuery.Deferred();p.done(function(){d.resolve(r);}).fail(function(m){d.reject(m);});return d;};S.prototype.privhrefForExternalNoEnc=function(A,s){var r;if(A===undefined){return this.privgetCurrentShellHash();}if(A&&A.target&&(typeof A.target.semanticObject==="string"||typeof A.target.shellHash==="string")){r="#"+this.privconstructShellHash(A);return this.oURLShortening.compactHash(r,undefined,s);}return this.privgetCurrentShellHash();};S.prototype.privgetAppHash=function(A){var s,o;if(A&&A.target&&(typeof A.target.shellHash==="string")){o=sap.ushell.Container.getService("URLParsing").parseShellHash(A.target.shellHash);s=o&&o.appSpecificRoute;s=s&&s.substring(2);}return s;};S.prototype.hrefForAppSpecificHash=function(A){return encodeURI(this.privconstructHash(this.privappHashPrefix+A).hash);};S.prototype.toExternal=function(A,C,w){var s,o=new a(C),b;s=this.privhrefForExternalNoEnc(A,o).hash;b=this.privgetAppHash(A);this.privsetHash(s,b,w);};S.prototype.toAppHash=function(A,w){var s=this.privconstructHash(this.privappHashPrefix+A).hash;this.privsetHash(s,A,w);};S.prototype.initShellNavigation=function(s){this._oInitialNavigationManager=c();if(this._initializedByShellNav){jQuery.sap.log.info("initShellNavigation already called on this ShellNavigationHashChanger instance.");return false;}this.privfnShellCallback=s;h.changed.add(this.treatHashChanged,this);if(!h.isActive()){h.initialized.addOnce(this.treatHashChanged,this);h.init();}else{this.treatHashChanged(h.getHash());}this._initializedByShellNav=true;return true;};S.prototype.init=function(){if(this._initialized){jQuery.sap.log.info("init already called on this ShellNavigationHashChanger instance.");return false;}var n=this.privsplitHash(h.getHash()),A=n&&(n.appSpecificRoute||"  ").substring(2);this.fireEvent("hashChanged",{newHash:A,fullHash:n?n.shellPart+n.appSpecificRoute:""});this._initialized=true;return true;};S.prototype.treatHashChanged=function(n,o){if(this.inAbandonFlow){return;}this._oInitialNavigationManager.onHashChanged();var A,s,N,b,d,f,g,j,E,i,F,k,l,m;n=this.oURLShortening.expandHash(n);o=this.oURLShortening.expandHash(o);N=this.privsplitHash(n);b=this.privsplitHash(o);if(!N){E=new Error("Illegal new hash - cannot be parsed: '"+n+"'");this.fireEvent("shellHashChanged",{newShellHash:n,newAppSpecificRoute:null,oldShellHash:(b?b.shellPart:o),error:E});this.privfnShellCallback(n,null,(b?b.shellPart:o),(b?b.appSpecificRoute:null),E);return;}d=N.intent;if(!b){b={shellPart:o,appSpecificRoute:null};}else{f=b.intent;}for(i=0;i<this.aNavigationFilters.length;i++){try{F=this.aNavigationFilters[i].call(undefined,n,o);k=F;if(typeof F!=="string"){k=F.status;l=F.hash;}if(k===this.NavigationFilterStatus.Custom){if(l&&l.length>0){this.inAbandonFlow=true;h.replaceHash(l);this.inAbandonFlow=false;}return;}if(k===this.NavigationFilterStatus.Abandon){this.inAbandonFlow=true;h.replaceHash(o);this.inAbandonFlow=false;return;}if(k===this.NavigationFilterStatus.Keep){m=true;}}catch(e){jQuery.sap.log.error("Error while calling Navigation filter! ignoring filter...",e.message,"sap.ushell.services.ShellNavigation");}}if(m){this.fireEvent("hashChanged",{newHash:n,oldHash:o,fullHash:n});return;}var p=d===f&&o!==undefined;if(p&&!this._parametersChanged(N.params,b.params)){A=(N.appSpecificRoute||"  ").substring(2);s=(b.appSpecificRoute||"  ").substring(2);jQuery.sap.log.info("Inner App Hash changed from '"+s+"' to '"+A+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent("hashChanged",{newHash:A,oldHash:s,fullHash:n});return;}if(p&&this.hasListeners("shellHashParameterChanged")){g=sap.ushell.Container.getService("URLParsing").paramsToString(N.params);j=sap.ushell.Container.getService("URLParsing").paramsToString(b.params);jQuery.sap.log.info("Shell hash parameters changed from '"+j+"' to '"+g+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent("shellHashParameterChanged",{oNewParameters:N.params,oOldParameters:b.params});return;}if(o!==undefined&&this.oServiceConfig&&this.oServiceConfig.reload){window.location.hash='#'+encodeURI(n);window.location.reload();}jQuery.sap.log.info("Outer shell hash changed from '"+o+"' to '"+n+"'",null,"sap.ushell.services.ShellNavigation");this.fireEvent("shellHashChanged",{newShellHash:N.shellPart,newAppSpecificRoute:N.appSpecificRoute,oldShellHash:b.shellPart,oldAppSpecificRoute:b.appSpecificRoute});this.privfnShellCallback(N.shellPart,N.appSpecificRoute,b.shellPart,b.appSpecificRoute);};S.prototype.isInitialNavigation=function(){return this._oInitialNavigationManager&&this._oInitialNavigationManager.isInitialNavigation();};S.prototype._parametersChanged=function(n,o){return!jQuery.sap.equal(n,o);};S.prototype.setHash=function(s){this.toAppHash(s,true);};S.prototype.replaceHash=function(s){this.toAppHash(s,false);};S.prototype.getHash=function(){return this.getAppHash();};S.prototype.getAppHash=function(){var n=this.privsplitHash(h.getHash()),A=n&&(n.appSpecificRoute||"  ").substring(2);return A;};S.prototype.isInnerAppNavigation=function(n,o){var N=this.privsplitHash(n)||{};var b=this.privsplitHash(o)||{};var d=this._haveSameIntent(n,o);var e=!this._parametersChanged(N.params,b.params);return d&&e;};S.prototype._haveSameIntent=function(n,o){var N=this.privsplitHash(n)||{};var b=this.privsplitHash(o)||{};var s=N.intent;var d=b.intent;return s===d&&o!==undefined;};S.prototype.destroy=function(){h.changed.remove(this.treatHashChanged,this);H.prototype.destroy.apply(this,arguments);};S.prototype._getAllEvents=function(){return Object.keys(O).map(function(e){return O[e];});};S.prototype.getReplaceHashEvents=function(){return this._getAllEvents().filter(function(e){return e.historyEntry===false;}).map(function(e){return e.name;});};S.prototype.getSetHashEvents=function(){return this._getAllEvents().filter(function(e){return e.historyEntry===true;}).map(function(e){return e.name;});};return S;},true);
