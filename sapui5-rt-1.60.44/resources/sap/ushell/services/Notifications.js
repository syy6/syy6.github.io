// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/datajs","sap/ui/core/ws/SapPcpWebSocket"],function(O,S){"use strict";function N(c,p,s){var m=new sap.ui.model.json.JSONModel(),t=new Date(),o=s&&s.config,r={getNotifications:{},getNotificationsByType:{},getNotificationsInGroup:{},getBadgeNumber:{},resetBadgeNumber:{},getNotificationTypesSettings:{},getNotificationsGroupHeaders:{},getMobileSupportSettings:{},getWebSocketValidity:{},getNotificationCount:{}},w,W=o.webSocketUrl||"/sap/bc/apc/iwngw/notification_push_apc",P=o.pollingIntervalInSeconds||60,i=undefined,a=undefined,b=undefined,u=[],U=[],d=[],I=false,C=[],f=false,g=false,E=true,h,D,j=5000,k=6000,l=false,n={NOTIFICATIONS:0,NOTIFICATIONS_BY_TYPE:1,GET_BADGE_NUMBER:2,RESET_BADGE_NUMBER:3,GET_SETTINGS:4,GET_MOBILE_SUPPORT_SETTINGS:5,NOTIFICATIONS_GROUP_HEADERS:6,NOTIFICATIONS_IN_GROUP:7,GET_NOTIFICATIONS_COUNT:8,VALIDATE_WEBSOCKET_CHANNEL:9,NOTIFICATIONS_BY_DATE_DESCENDING:"notificationsByDateDescending",NOTIFICATIONS_BY_DATE_ASCENDING:"notificationsByDateAscending",NOTIFICATIONS_BY_PRIORITY_DESCENDING:"notificationsByPriorityDescending",NOTIFICATIONS_BY_TYPE_DESCENDING:"notificationsByTypeDescending"},M={PACKAGED_APP:0,FIORI_CLIENT:1,WEB_SOCKET:2,POLLING:3},q,F=false,v,z=true,A=false,H=true,B=false,G=new jQuery.Deferred(),J=new jQuery.Deferred(),K,L=G.promise(),Q=false,R={},T=10,V=false,X=false;this.isEnabled=function(){if(!o.enabled||!o.serviceUrl){E=false;if(o.enabled&&!o.serviceUrl){jQuery.sap.log.warning("No serviceUrl was found in the service configuration");}}else{E=true;}return E;};this.init=function(){if((!f)&&(this.isEnabled())){sap.ui.getCore().getEventBus().subscribe("launchpad","sessionTimeout",this.destroy,this);this.lastNotificationDate=new Date();z=o.enableNotificationsPreview;this._setWorkingMode();f=true;this.bUpdateDependencyInitiatorExists=false;this._userSettingInitialization();}};this.getUnseenNotificationsCount=function(){var e=jQuery.Deferred();e.resolve(m.getProperty("/UnseenCount"));return e.promise();};this.getNotificationsCount=function(){return m.getProperty("/NotificationsCount")?m.getProperty("/NotificationsCount"):"0";};this.getNotificationsByTypeWithGroupHeaders=function(){var e,x,y=new jQuery.Deferred(),Y=this._getRequestURI(n.NOTIFICATIONS_BY_TYPE);x={requestUri:Y};if(!this._getHeaderXcsrfToken()){e={};e["X-CSRF-Token"]="fetch";x.headers=e;}O.request(x,function(Z){y.resolve(Z);},function(Z){if(Z.response&&Z.response.statusCode===200&&Z.response.body){y.resolve(Z.response.body);}else{y.reject(Z);jQuery.sap.log.error("Notification service - oData executeAction failed: ",Z,"sap.ushell.services.Notifications");}});return y.promise();};this.getNotificationsGroupHeaders=function(){var e,x,y=new jQuery.Deferred(),Y=this._getRequestURI(n.NOTIFICATIONS_GROUP_HEADERS);x={requestUri:Y};if(!this._getHeaderXcsrfToken()){e={};e["X-CSRF-Token"]="fetch";x.headers=e;}O.request(x,function(Z){y.resolve(Z);},function(Z){if(Z.response&&Z.response.statusCode===200&&Z.response.body){y.resolve(Z.response.body);}else{y.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",Z,"sap.ushell.services.Notifications");}});return y.promise();};this.getNotificationsBufferInGroup=function(e,x,y){var Y=this,Z,$,_=new jQuery.Deferred(),a1={group:e,skip:x,top:y},b1,c1,d1=this._getRequestURI(n.NOTIFICATIONS_IN_GROUP,a1);if(Q===true){b1=R[n.NOTIFICATIONS_IN_GROUP].slice(x,x+y);c1=JSON.stringify({"@odata.context":"$metadata#Notifications","value":b1});setTimeout(function(){_.resolve(c1);},1000);}else{$={requestUri:d1};if(!this._getHeaderXcsrfToken()){Z={};Z["X-CSRF-Token"]="fetch";$.headers=Z;}O.request($,function(e1){Y._updateCSRF(e1.response);_.resolve(e1.value);},function(e1){if(e1.response&&e1.response.statusCode===200&&e1.response.body){Y._updateCSRF(e1.response);_.resolve(JSON.parse(e1.response.body).value);}else{_.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",e1,"sap.ushell.services.Notifications");}});}return _.promise();};this.getNotificationsBufferBySortingType=function(e,x,y){var Y=this,Z,$,_=new jQuery.Deferred(),a1={skip:x,top:y},b1,c1,d1=this._getRequestURI(e,a1);if(Q===true){b1=R[e].slice(x,x+y);c1=JSON.stringify({"@odata.context":"$metadata#Notifications","value":b1});setTimeout(function(){_.resolve(c1);},1000);}else{$={requestUri:d1};if(!this._getHeaderXcsrfToken()){Z={};Z["X-CSRF-Token"]="fetch";$.headers=Z;}O.request($,function(e1){Y._updateCSRF(e1.response);_.resolve(e1.value);},function(e1){if(e1.response&&e1.response.statusCode===200&&e1.response.body){Y._updateCSRF(e1.response);_.resolve(JSON.parse(e1.response.body).value);}else{_.reject();jQuery.sap.log.error("Notification service - oData executeAction failed: ",e1,"sap.ushell.services.Notifications");}});}return _.promise();};this.getNotifications=function(){var e,x=jQuery.Deferred();if((q===M.FIORI_CLIENT)||(q===M.PACKAGED_APP)){e=this._readNotificationsData(false);e.done(function(){x.resolve(m.getProperty("/Notifications"));}).fail(function(y){x.reject();});}else{x.resolve(m.getProperty("/Notifications"));}return x.promise();};this.executeBulkAction=function(e,x){var y=new jQuery.Deferred(),Y=[],Z=[],$={succededNotifications:Y,failedNotifications:Z},_=this;_.sendBulkAction(e,x).done(function(a1){a1.forEach(function(b1,c1){var d1=b1.NotificationId,e1=b1.Success;if(e1){Y.push(d1);}else{Z.push(d1);}});if(Z.length){y.reject($);}else{y.resolve($);}}).fail(function(){y.reject($);});return y.promise();};this.dismissBulkNotifications=function(e){var x=new jQuery.Deferred(),y=this;y.sendBulkDismiss(e).done(function(){x.resolve();}).fail(function(){x.reject();});return x.promise();};this.executeAction=function(e,x){var y=this,Y=o.serviceUrl+"/ExecuteAction",Z={NotificationId:e,ActionId:x},$={requestUri:Y,method:"POST",data:Z,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}},_=jQuery.Deferred();O.request($,function(a1){var b1,c1={isSucessfull:true,message:""};if(a1&&a1.response&&a1.response.statusCode===200&&a1.response.body){b1=JSON.parse(a1.response.body);c1.isSucessfull=b1.Success;c1.message=b1.MessageText;}_.resolve(c1);},function(a1){var b1,c1={isSucessfull:false,message:""};if(a1.response&&a1.response.statusCode===200&&a1.response.body){b1=JSON.parse(a1.response.body);c1.isSucessfull=b1.Success;c1.message=b1.MessageText;_.resolve(c1);}else if(y._csrfTokenInvalid(a1)&&(V===false)){y._invalidCsrfTokenRecovery(_,y.executeAction,[e,x]);}else{_.reject(a1);jQuery.sap.log.error("Notification service - oData executeAction failed: ",a1,"sap.ushell.services.Notifications");}});return _.promise();};this.sendBulkAction=function(e,x){var y=this,Y=o.serviceUrl+"/BulkActionByHeader",Z={ParentId:e,ActionId:x},$={requestUri:Y,method:"POST",data:Z,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}},_=jQuery.Deferred();O.request($,function(a1){var b1,c1;if(a1&&a1.response&&a1.response.statusCode===200&&a1.response.body){b1=JSON.parse(a1.response.body);c1=b1.value;}_.resolve(c1);},function(a1){var b1,c1;if(a1.response&&a1.response.statusCode===200&&a1.response.body){b1=JSON.parse(a1.response.body);c1=b1.value;_.resolve(c1);}else if(y._csrfTokenInvalid(a1)&&(V===false)){y._invalidCsrfTokenRecovery(_,y.sendBulkAction,[e,x]);}else{_.reject();jQuery.sap.log.error("Notification service - oData executeBulkAction failed: ",a1.message,"sap.ushell.services.Notifications");}});return _.promise();};this.sendBulkDismiss=function(e){var x=this,y=o.serviceUrl+"/DismissAll",Y={ParentId:e},Z={requestUri:y,method:"POST",data:Y,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}},$=jQuery.Deferred();O.request(Z,function(_){$.resolve();},function(_){if(_.response&&_.response.statusCode===200){$.resolve();}else if(x._csrfTokenInvalid(_)&&(V===false)){x._invalidCsrfTokenRecovery($,x.sendBulkDismiss,[e]);}else{$.reject();jQuery.sap.log.error("Notification service - oData executeBulkAction failed","sap.ushell.services.Notifications");}});return $.promise();};this.markRead=function(e){var x=this,y=o.serviceUrl+"/MarkRead",Y={NotificationId:e},Z={requestUri:y,method:"POST",data:Y,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}},$=jQuery.Deferred();O.request(Z,function(_){$.resolve();},function(_){if(x._csrfTokenInvalid(_)&&(V===false)){x._invalidCsrfTokenRecovery($,x.markRead,[e]);}else{jQuery.sap.log.error("Notification service - oData reset badge number failed: ",_,"sap.ushell.services.Notifications");$.reject(_);}});return $.promise();};this.dismissNotification=function(e){var x=o.serviceUrl+"/Dismiss",y=this,Y={NotificationId:e},Z={requestUri:x,method:"POST",data:Y,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}},$=jQuery.Deferred();O.request(Z,function(_){$.resolve();},function(_){if(y._csrfTokenInvalid(_)&&(V===false)){y._invalidCsrfTokenRecovery($,y.dismissNotification,[e]);}else{$.reject(_);jQuery.sap.log.error("Notification service - oData dismiss notification failed: ",_,"sap.ushell.services.Notifications");}});return $.promise();};this.registerNotificationsUpdateCallback=function(e){u.push(e);};this.registerDependencyNotificationsUpdateCallback=function(e,x){if(x===false){this.bUpdateDependencyInitiatorExists=true;}U.push({callback:e,dependent:x});};this.registerNotificationCountUpdateCallback=function(e){d.push(e);};this.notificationsSeen=function(){this._setNotificationsAsSeen();};this.isFirstDataLoaded=function(){return F;};this.readSettings=function(){var e;e=this._readSettingsFromServer();return e;};this.saveSettingsEntry=function(e){var x;x=this._writeSettingsEntryToServer(e);return x;};this.getUserSettingsFlags=function(){var e=new jQuery.Deferred();if(B===true){e.resolve({previewNotificationEnabled:A,highPriorityBannerEnabled:H});}else{L.done(function(){e.resolve({previewNotificationEnabled:A,highPriorityBannerEnabled:H});});}return e.promise();};this.setUserSettingsFlags=function(e){A=e.previewNotificationEnabled;H=e.highPriorityBannerEnabled;this._writeUserSettingsFlagsToPersonalization(e);};this._getNotificationSettingsMobileSupport=function(){return K;};this.getPreviewNotificationEnabledConfig=function(){return z;};this.destroy=function(){g=true;if(i){clearTimeout(i);}else if(a){clearTimeout(a);}else if(b){clearTimeout(b);}if((q===M.WEB_SOCKET)&&w){w.close();}sap.ui.getCore().getEventBus().unsubscribe("launchpad","sessionTimeout",this.destroy,this);};this._readUnseenNotificationsCount=function(e){var x=this,y=new jQuery.Deferred(),Y=this._getRequestURI(n.GET_BADGE_NUMBER),Z={requestUri:Y};O.read(Z,function($,_){m.setProperty("/UnseenCount",_.data.GetBadgeNumber.Number);x._setNativeIconBadge(_.data.GetBadgeNumber.Number);y.resolve(_.data.GetBadgeNumber.Number);},function($){if($.response&&$.response.statusCode===200&&$.response.body){var _=JSON.parse($.response.body);m.setProperty("/UnseenCount",_.value);x._setNativeIconBadge(_.value);y.resolve(_.value);}else{jQuery.sap.log.error("Notification service - oData read unseen notifications count failed: ",$.message,"sap.ushell.services.Notifications");y.reject($);}});return y.promise();};this.readNotificationsCount=function(){var e=new jQuery.Deferred(),x=this._getRequestURI(n.GET_NOTIFICATIONS_COUNT),y={requestUri:x};O.read(y,function(Y,Z){e.resolve(Z.data);},function(Y){if(Y.response&&Y.response.statusCode===200&&Y.response.body){var Z=JSON.parse(Y.response.body);e.resolve(Z.value);}else{jQuery.sap.log.error("Notification service - oData read notifications count failed: ",Y.message,"sap.ushell.services.Notifications");e.reject(Y);}});return e.promise();};this._getNotificationSettingsAvalability=function(){return J.promise();};this._setNotificationsAsSeen=function(){var e=this,x=jQuery.Deferred(),y=this._getRequestURI(n.RESET_BADGE_NUMBER),Y={requestUri:y,method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}};if(this._isFioriClientMode()===true||this._isPackagedMode()===true){this._setNativeIconBadge(0);}O.request(Y,function(Z,$){x.resolve();},function(Z){if(e._csrfTokenInvalid(Z)&&(V===false)){e._invalidCsrfTokenRecovery(x,e._setNotificationsAsSeen);}else{jQuery.sap.log.error("Notification service - oData reset badge number failed: ",Z,"sap.ushell.services.Notifications");x.reject(Z);}});return x.promise();};this._readNotificationsData=function(e){var x=this,y,Y,Z,$=new jQuery.Deferred(),_=[];y=this._readUnseenNotificationsCount(e);_.push(y);Z=this.readNotificationsCount();Z.done(function(a1){m.setProperty("/NotificationsCount",a1);});Y=this.getNotificationsBufferBySortingType(n.NOTIFICATIONS_BY_DATE_DESCENDING,0,T);_.push(Y);jQuery.when.apply(jQuery,_).then(function(a1){_[0].done(function(b1){if(e===true){x._updateNotificationsCountConsumers();}});_[1].done(function(b1){jQuery.sap.flpmeasure.start(0,"Notifications (services + rendering)",7);m.setProperty("/Notifications",b1);x._notificationAlert(b1);if(e===true){x._updateNotificationsConsumers();x._updateDependentNotificationsConsumers();}$.resolve();});});return $.promise();};this._getHeaderXcsrfToken=function(){return h;};this._getDataServiceVersion=function(){return D;};this._getRequestURI=function(e,x){var y,Y=encodeURI(this._getConsumedIntents(e));switch(e){case n.NOTIFICATIONS:if(r.getNotifications.basic===undefined){r.getNotifications.basic=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20false";}if(this._isIntentBasedConsumption()){if(r.getNotifications.byIntents===undefined){r.getNotifications.byIntents=r.getNotifications.basic.concat("&intents%20eq%20"+Y);}return r.getNotifications.byIntents;}return r.getNotifications.basic;case n.NOTIFICATIONS_BY_TYPE:if(r.getNotificationsByType.basic===undefined){r.getNotificationsByType.basic=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams";}if(this._isIntentBasedConsumption()){if(r.getNotificationsByType.byIntents===undefined){r.getNotificationsByType.byIntents=r.getNotificationsByType.basic.concat("&$filter=intents%20eq%20"+Y);}return r.getNotificationsByType.byIntents;}return r.getNotificationsByType.basic;case n.NOTIFICATIONS_GROUP_HEADERS:if(r.getNotificationsGroupHeaders.basic===undefined){r.getNotificationsGroupHeaders.basic=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20true";}if(this._isIntentBasedConsumption()){if(r.getNotificationsGroupHeaders.byIntents===undefined){r.getNotificationsGroupHeaders.byIntents=r.getNotificationsGroupHeaders.basic.concat("&intents%20eq%20"+Y);}return r.getNotificationsGroupHeaders.byIntents;}return r.getNotificationsGroupHeaders.basic;case n.NOTIFICATIONS_IN_GROUP:y=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt desc&$filter=IsGroupHeader eq false and ParentId eq "+x.group+"&$skip="+x.skip+"&$top="+x.top;if(this._isIntentBasedConsumption()===true){y=y.concat("&intents%20eq%20"+Y);}break;case n.GET_BADGE_NUMBER:if(r.getBadgeNumber.basic===undefined){r.getBadgeNumber.basic=o.serviceUrl+"/GetBadgeNumber()";}if(this._isIntentBasedConsumption()){if(r.getBadgeNumber.byIntents===undefined){r.getBadgeNumber.byIntents=o.serviceUrl+"/GetBadgeCountByIntent("+Y+")";}return r.getBadgeNumber.byIntents;}return r.getBadgeNumber.basic;case n.GET_NOTIFICATIONS_COUNT:if(r.getNotificationCount.basic===undefined){r.getNotificationCount.basic=o.serviceUrl+"/Notifications/$count";}return r.getNotificationCount.basic;case n.RESET_BADGE_NUMBER:if(r.resetBadgeNumber.basic===undefined){r.resetBadgeNumber.basic=o.serviceUrl+"/ResetBadgeNumber";}return r.resetBadgeNumber.basic;case n.GET_SETTINGS:if(r.getNotificationTypesSettings.basic===undefined){r.getNotificationTypesSettings.basic=o.serviceUrl+"/NotificationTypePersonalizationSet";}return r.getNotificationTypesSettings.basic;case n.GET_MOBILE_SUPPORT_SETTINGS:if(r.getMobileSupportSettings.basic===undefined){r.getMobileSupportSettings.basic=o.serviceUrl+"/Channels(ChannelId='SAP_SMP')";}return r.getMobileSupportSettings.basic;case n.VALIDATE_WEBSOCKET_CHANNEL:if(r.getWebSocketValidity.basic===undefined){r.getWebSocketValidity.basic=o.serviceUrl+"/Channels('SAP_WEBSOCKET')";}return r.getWebSocketValidity.basic;case n.NOTIFICATIONS_BY_DATE_DESCENDING:y=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+x.skip+"&$top="+x.top;if(this._isIntentBasedConsumption()===true){y=y.concat("&intents%20eq%20"+Y);}break;case n.NOTIFICATIONS_BY_DATE_ASCENDING:y=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20asc&$filter=IsGroupHeader%20eq%20false&$skip="+x.skip+"&$top="+x.top;if(this._isIntentBasedConsumption()===true){y=y.concat("&intents%20eq%20"+Y);}break;case n.NOTIFICATIONS_BY_PRIORITY_DESCENDING:y=o.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=Priority%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+x.skip+"&$top="+x.top;if(this._isIntentBasedConsumption()===true){y=y.concat("&intents%20eq%20"+Y);}break;default:y="";}return y;};this._readSettingsFromServer_noConnection=function(){var e=jQuery.Deferred(),x=[{NotificationTypeId:"type1",NotificationTypeDesc:"aaaaabbbbb-cccccddddd",PriorityDefault:"40-HIGH",DoNotDeliver:false,DoNotDeliverMob:true},{NotificationTypeId:"type2",NotificationTypeDesc:"cccccdddddccc-aaaaabbbbb",PriorityDefault:"10-LOW",DoNotDeliver:true,DoNotDeliverMob:true}];e.resolve(JSON.stringify({"@odata.context":"$metadata#NotificationTypePersonalizationSet","value":x}));return e.promise();};this._readSettingsFromServer_noData=function(){var e=jQuery.Deferred();e.resolve(JSON.stringify({"@odata.context":"$metadata#NotificationTypePersonalizationSet","value":{}}));return e.promise();};this._readSettingsFromServer=function(){var e=this._getRequestURI(n.GET_SETTINGS),x={requestUri:e},y=jQuery.Deferred();O.request(x,function(Y){y.resolve(Y.results);},function(Y){if(Y.response&&Y.response.statusCode===200&&Y.response.body){y.resolve(Y.response.body);}else{y.reject(Y);jQuery.sap.log.error("Notification service - oData get settings failed: ",Y,"sap.ushell.services.Notifications");}});return y.promise();};this._readMobileSettingsFromServer=function(){var e=this._getRequestURI(n.GET_MOBILE_SUPPORT_SETTINGS),x={requestUri:e},y=jQuery.Deferred(),Y,Z;O.request(x,function($){if(typeof($.results)==="string"){Y=JSON.parse($.results);Y.successStatus=true;Z=JSON.stringify(Y);y.resolve(Z);}else{$.results.successStatus=true;y.resolve($.results);}},function($){if($.response&&$.response.statusCode===200&&$.response.body){Y=JSON.parse($.response.body);Y.successStatus=true;Z=JSON.stringify(Y);y.resolve(Z);}else{y.resolve(JSON.stringify({successStatus:false}));jQuery.sap.log.error("Notification service - oData get settings failed: ",$,"sap.ushell.services.Notifications");}});return y.promise();};this._checkWebSocketActivity=function(){var e=this._getRequestURI(n.VALIDATE_WEBSOCKET_CHANNEL),x={requestUri:e},y=jQuery.Deferred(),Y;O.request(x,function(Z){if(typeof(Z.results)==="string"){Y=JSON.parse(Z.results);y.resolve(Y.IsActive);}else{y.resolve(false);}},function(Z){if(Z.response&&Z.response.statusCode===200&&Z.response.body){Y=JSON.parse(Z.response.body);y.resolve(Y.IsActive);}else{y.resolve(false);jQuery.sap.log.error("Notification service - oData get settings failed: ",Z,"sap.ushell.services.Notifications");}});return y.promise();};this._writeSettingsEntryToServer=function(e){var x=this,y,Y=this._getRequestURI(n.GET_SETTINGS)+"(NotificationTypeId="+e.NotificationTypeId+")",Z={requestUri:Y,method:"PUT",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json","DataServiceVersion":D,"X-CSRF-Token":h}};Z.data=JSON.parse(JSON.stringify(e));Z.data["@odata.context"]="$metadata#NotificationTypePersonalizationSet/$entity";y=new jQuery.Deferred();O.request(Z,function($){y.resolve($);},function($){if($.response&&$.response.statusCode===200&&$.response.body){y.resolve($.response.body);}else if(x._csrfTokenInvalid($)&&(V===false)){x._invalidCsrfTokenRecovery(y,x._writeSettingsEntryToServer,[e]);}else{y.reject($);jQuery.sap.log.error("Notification service - oData set settings entry failed: ",$,"sap.ushell.services.Notifications");}});return y.promise();};this._updateNotificationsConsumers=function(){u.forEach(function(e){e();});};this._updateDependentNotificationsConsumers=function(){var e=this,x=new jQuery.Deferred();U.forEach(function(y){if(e.bUpdateDependencyInitiatorExists===false){y.callback();}else{y.dependent===true?y.callback(x.promise()):y.callback(x);}});};this._updateNotificationsCountConsumers=function(){d.forEach(function(e){e();});};this._updateAllConsumers=function(){this._updateNotificationsConsumers();this._updateNotificationsCountConsumers();this._updateDependentNotificationsConsumers();};this._getModel=function(){return m;};this._getMode=function(){return q;};this._setWorkingMode=function(){var e;if(o.intentBasedConsumption===true){C=this._getIntentsFromConfiguration(o.consumedIntents);if(C.length>0){I=true;}}if(this._isPackagedMode()){q=M.PACKAGED_APP;e=this._getIntentsFromConfiguration(window.fiori_client_appConfig.applications);if(e.length>0){C=e;}if(C.length>0){I=true;}this._registerForPush();this._readNotificationsData(true);this._setNativeIconBadgeWithDelay();return;}this._performFirstRead();};this._performFirstRead=function(){var e=this,x,y=this._readNotificationsData(true);y.done(function(){x=e._getFioriClientRemainingDelay();if(x<=0){e._fioriClientStep();}else{i=setTimeout(function(){e._fioriClientStep();},x);}F=true;}).fail(function(Y){jQuery.sap.log.error("Notifications oData read failed. Error: "+Y);return;});};this._fioriClientStep=function(){var e=this,x;if(this._isFioriClientMode()){q=M.FIORI_CLIENT;this._addPushNotificationHandler();x=this.getUnseenNotificationsCount();x.done(function(y){e._setNativeIconBadge(y,function(){});}).fail(function(){});}else{this._webSocketStep();}};this._webSocketStep=function(){q=M.WEB_SOCKET;this._establishWebSocketConnection();};this._webSocketRecoveryStep=function(){if(l===false){l=true;a=setTimeout(function(){this._webSocketStep();}.bind(this),j);}else{this._activatePollingAfterInterval();}};this._activatePollingAfterInterval=function(){var e=this;b=setTimeout(function(){e._activatePolling();},P*1000);};this._activatePolling=function(){var e=this;q=M.POLLING;this._readNotificationsData(true);b=setTimeout(e._activatePolling.bind(e,P,false),(P*1000));};this._formatAsDate=function(e){return new Date(e);};this._notificationAlert=function(e){if(H===false){return;}var x,y=[],Y=0;for(x in e){if(this.lastNotificationDate&&this._formatAsDate(e[x].CreatedAt)>this.lastNotificationDate){if(e[x].Priority==="HIGH"){y.push(e[x]);}}if(Y<this._formatAsDate(e[x].CreatedAt)){Y=this._formatAsDate(e[x].CreatedAt);}}if(this.lastNotificationDate&&y&&y.length>0){sap.ui.getCore().getEventBus().publish("sap.ushell.services.Notifications","onNewNotifications",y);}this.lastNotificationDate=Y;};this._getFioriClientRemainingDelay=function(){return k-(new Date()-t);};this._establishWebSocketConnection=function(){var x=this,y=false,Y;try{w=this._getWebSocketObjectObject(W,[S.SUPPORTED_PROTOCOLS.v10]);w.attachMessage(this,function(Z){Y=Z.getParameter("pcpFields");if((Y)&&(Y.Command)&&(Y.Command==="Notification")){x._readNotificationsData(true);}});w.attachOpen(this,function(){x._checkWebSocketActivity().done(function(Z){if(!Z){y=true;w.close();x._activatePollingAfterInterval();}});jQuery.sap.log.info("Notifications UShell service WebSocket: webSocket connection opened");});w.attachClose(this,function(Z,$){jQuery.sap.log.warning("Notifications UShell service WebSocket: attachClose called with code: "+Z.mParameters.code+" and reason: "+Z.mParameters.reason);if((!g)&&(!y)){x._webSocketRecoveryStep();}});w.attachError(this,function(Z,$){jQuery.sap.log.warning("Notifications UShell service WebSocket: attachError called!");});}catch(e){jQuery.sap.log.error("Exception occurred while creating new sap.ui.core.ws.SapPcpWebSocket. Message: "+e.message);}};this._isFioriClientMode=function(){return!(sap.FioriClient===undefined);};this._isPackagedMode=function(){return(window.fiori_client_appConfig&&window.fiori_client_appConfig.prepackaged===true);};this._setNativeIconBadge=function(e){if((sap.Push!==undefined)&&(sap.Push.setBadgeNumber!==undefined)){sap.Push.setBadgeNumber(e,function(){});}};this._setNativeIconBadgeWithDelay=function(){var e=this,x;setTimeout(function(){x=e.getUnseenNotificationsCount();x.done(function(y){e._setNativeIconBadge(y);}).fail(function(){});},4000);};this._getIntentsFromConfiguration=function(e){var x=[],y,Y;if(e&&e.length>0){for(Y=0;Y<e.length;Y++){y=e[Y].intent;x.push(y);}}return x;};this._handlePushedNotification=function(e){var x,y,Y,Z,$=[],_;if(e!==undefined){if((e.additionalData===undefined)||(e.additionalData.foreground===true)){this._readNotificationsData(true);}else{if(e.additionalData&&e.additionalData.NavigationTargetObject){y=e.additionalData.NavigationTargetObject;}else{y=e.NavigationTargetObject;}if(e.additionalData&&e.additionalData.NavigationTargetAction){Y=e.additionalData.NavigationTargetAction;}else{Y=e.NavigationTargetAction;}if(e.additionalData&&e.additionalData.NavigationTargetParam){Z=e.additionalData.NavigationTargetParam;}else{Z=e.NavigationTargetParam;}if(Z){if(typeof Z==='string'||Z instanceof String){$[0]=Z;}else if(Array.isArray(Z)===true){$=Z;}}x=e.NotificationId;if((typeof hasher!=="undefined")&&(hasher.getHash()===y+"-"+Y)){_=sap.ui.getCore().byId('viewPortContainer');if(_){_.switchState("Center");}}sap.ushell.utils.toExternalWithParameters(y,Y,$);this.markRead(x);this._readNotificationsData(true);}}};this._registerForPush=function(){sap.Push.initPush(this._handlePushedNotification.bind(this));};this._addPushNotificationHandler=function(){document.addEventListener("deviceready",this._registerForPush.bind(this),false);};this._isIntentBasedConsumption=function(){return I;};this._getConsumedIntents=function(e){var x="",y;if(!this._isIntentBasedConsumption()){return x;}if(C.length>0){if(e!==n.GET_BADGE_NUMBER){x="&";}for(y=0;y<C.length;y++){if(e===n.GET_BADGE_NUMBER){if(y===0){x=C[y];}else{x=x+","+C[y];}}else{x=x+"NavigationIntent%20eq%20%27"+C[y]+"%27";}}}return x;};this._revalidateCsrfToken=function(){var e;h=undefined;X=false;e=this.getNotificationsBufferBySortingType(n.NOTIFICATIONS_BY_DATE_DESCENDING,0,1);return e.promise();};this._csrfTokenInvalid=function(e){return(e.response&&(e.response.statusCode===403)&&(e.response.headers["x-csrf-token"]==="Required"));};this._invalidCsrfTokenRecovery=function(x,y,Y){var Z=this,$=this._revalidateCsrfToken(),_;V=true;$.done(function(){_=y.apply(Z,Y);_.done(function(e){V=false;x.resolve(e);});_.fail(function(e){V=false;if(e.response&&e.response.statusCode===200&&e.response.body){x.resolve(e.response.body);}else{x.reject(e);}});});$.fail(function(e){V=false;x.reject(e);jQuery.sap.log.error("Notification service - oData markRead failed: ",e.message,"sap.ushell.services.Notifications");});};this._notificationsAscendingSortBy=function(e,Y){e.sort(function(x,y){var Z=x[Y],$=y[Y];if(Z===$){Z=x.id;$=y.id;}return $>Z?-1:1;});return e;};this._getWebSocketObjectObject=function(W,e){return new S(W,e);};this._notificationsDescendingSortBy=function(e,Y){e.sort(function(x,y){var Z=x[Y],$=y[Y];if(Z===$){Z=x.id;$=y.id;return Z>$?-1:1;}if(Y==="Priority"){if(Z==="HIGH"){return-1;}if($==="HIGH"){return 1;}if(Z==="MEDIUM"){return-1;}return 1;}return Z>$?-1:1;});return e;};this.getOperationEnum=function(){return n;};this._readUserSettingsFlagsFromPersonalization=function(){var e=this,x,y;try{y=this._getUserSettingsPersonalizer().getPersData();}catch(Y){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(Y.name+": "+Y.message);x=new jQuery.Deferred();x.reject(Y);y=x.promise();}y.done(function(Z){if(Z===undefined){e._writeUserSettingsFlagsToPersonalization({previewNotificationEnabled:A,highPriorityBannerEnabled:H});}else{A=Z.previewNotificationEnabled;H=Z.highPriorityBannerEnabled;}B=true;G.resolve();});y.fail(function(){jQuery.sap.log.error("Reading User Settings flags from Personalization service failed");});};this._writeUserSettingsFlagsToPersonalization=function(e){var x,y;try{y=this._getUserSettingsPersonalizer().setPersData(e);}catch(Y){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(Y.name+": "+Y.message);x=new jQuery.Deferred();x.reject(Y);y=x.promise();}return y;};this._getUserSettingsPersonalizer=function(){if(v===undefined){v=this._createUserSettingsPersonalizer();}return v;};this._createUserSettingsPersonalizer=function(){var e=sap.ushell.Container.getService("Personalization"),x,y={keyCategory:e.constants.keyCategory.FIXED_KEY,writeFrequency:e.constants.writeFrequency.LOW,clientStorageAllowed:true},Y={container:"sap.ushell.services.Notifications",item:"userSettingsData"},Z=e.getPersonalizer(Y,y,x);return Z;};this._updateCSRF=function(e){if((X===true)||(e.headers===undefined)){return;}if(!this._getHeaderXcsrfToken()){h=e.headers["x-csrf-token"]||e.headers["X-CSRF-Token"]||e.headers["X-Csrf-Token"];}if(!this._getDataServiceVersion()){D=e.headers.DataServiceVersion||e.headers["odata-version"];}X=true;};this._userSettingInitialization=function(){var e,x,y={settingsAvailable:false,mobileAvailable:false},Y,Z,$;this._readUserSettingsFlagsFromPersonalization();e=this._readSettingsFromServer();x=this._readMobileSettingsFromServer();Y=[e,x];e.done(function(){y.settingsAvailable=true;});e.fail(function(){A=true;});x.done(function(_){Z=JSON.parse(_);$=Z.successStatus;if($){K=_?Z.IsActive:false;y.mobileAvailable=K;}else{K=false;y.mobileAvailable=false;}});jQuery.when.apply(jQuery,Y).then(function(_){J.resolve(y);});};};N.hasNoAdapter=true;return N;},true);
