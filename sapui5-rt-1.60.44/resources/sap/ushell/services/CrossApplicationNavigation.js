// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/services/AppConfiguration','sap/ushell/services/_CrossApplicationNavigation/utils'],function(a,u){"use strict";function C(c,p,s){var A,S;if(s&&s.config){S=s.config;}function g(t,o){var r,d,e,f,h,i;if(typeof t!=="string"&&!jQuery.isPlainObject(t)&&t!==undefined){jQuery.sap.log.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined;}if(t===undefined){return undefined;}var n;if(o){if(typeof o.getComponentData!=="function"||!jQuery.isPlainObject(o.getComponentData())||!o.getComponentData().startupParameters||!jQuery.isPlainObject(o.getComponentData().startupParameters)){jQuery.sap.log.error("Cannot call getComponentData on component","the component should be an application root component","sap.ushell.services.CrossApplicationNavigation");}else{i=o.getComponentData().startupParameters;if(i.hasOwnProperty("sap-system")){e=i["sap-system"][0];}if(i.hasOwnProperty("sap-ushell-next-navmode")){n=i["sap-ushell-next-navmode"][0];}}}else{r=a.getCurrentApplication();if(r&&r["sap-system"]){e=r["sap-system"];}else if(r&&r.url){e=jQuery.sap.getUriParameters(r.url).get("sap-system");}if(r&&r["sap-ushell-next-navmode"]){n=r["sap-ushell-next-navmode"];}else if(r&&r.url){n=jQuery.sap.getUriParameters(r.url).get("sap-ushell-next-navmode");}}if(jQuery.isPlainObject(t)){f=jQuery.extend(true,{},t);if(!e&&!n){return f;}if(f.target&&f.target.shellHash){if(typeof f.target.shellHash==="string"){f.target.shellHash=g(f.target.shellHash,o);}return f;}f.params=f.params||{};if(e&&!Object.prototype.hasOwnProperty.call(f.params,"sap-system")){f.params["sap-system"]=e;}if(n&&!Object.prototype.hasOwnProperty.call(f.params,"sap-ushell-navmode")){f.params["sap-ushell-navmode"]=[n];}return f;}else{h=t;if(!(e||n)){return h;}if(e&&!/[?&]sap-system=/.test(h)){d=(h.indexOf("?")>-1)?"&":"?";h+=d+"sap-system="+e;}if(n&&!/[?&]sap-ushell-navmode=/.test(h)){d=(h.indexOf("?")>-1)?"&":"?";h+=d+"sap-ushell-navmode="+n;}return h;}}function b(t){var d,o,e;if(localStorage&&localStorage["sap-ushell-enc-test"]==="false"){return t;}if(!S||!S["sap-ushell-enc-test"]){if(localStorage&&localStorage["sap-ushell-enc-test"]!=="true"){return t;}}if(typeof t!=="string"&&!jQuery.isPlainObject(t)&&t!==undefined){jQuery.sap.log.error("Unexpected input type",null,"sap.ushell.services.CrossApplicationNavigation");return undefined;}if(t===undefined){return undefined;}if(jQuery.isPlainObject(t)){o=jQuery.extend(true,{},t);if(o.target&&o.target.shellHash){if(typeof o.target.shellHash==="string"){if(o.target.shellHash!=="#"&&o.target.shellHash!==""){o.target.shellHash=b(o.target.shellHash);}}return o;}o.params=o.params||{};o.params["sap-ushell-enc-test"]=["A B%20C"];return o;}else{e=t;if(!/[?&]sap-system=/.test(e)){d=(e.indexOf("?")>-1)?"&":"?";e+=d+"sap-ushell-enc-test="+encodeURIComponent("A B%20C");}return e;}}this._extractInnerAppRoute=function(i){var t=this,P,I;if(typeof i==="string"){P=i.split("&/");I=P.shift();return{intent:I,innerAppRoute:P.length>0?"&/"+P.join("&/"):""};}if(Object.prototype.toString.apply(i)==="[object Object]"){var d=jQuery.sap.getObject("target.shellHash",undefined,i);if(typeof d==="string"){var r=t._extractInnerAppRoute(d);i.target.shellHash=r.intent;return{intent:i,innerAppRoute:r.innerAppRoute};}if(i.hasOwnProperty("appSpecificRoute")){var v=i.appSpecificRoute;delete i.appSpecificRoute;var e=typeof v==="string"&&v.indexOf("&/")!==0&&v.length>0;return{innerAppRoute:e?"&/"+v:v,intent:i};}return{intent:i,innerAppRoute:""};}jQuery.sap.log.error("Invalid input parameter","expected string or object","sap.ushell.services.CrossApplicationNavigation");return{intent:i};};this._injectInnerAppRoute=function(i,I){var d,t=this;if(!I){return i;}if(typeof i==="string"){return i+I;}if(Object.prototype.toString.apply(i)==="[object Object]"){d=jQuery.sap.getObject("target.shellHash",undefined,i);if(typeof d==="string"){i.target.shellHash=t._injectInnerAppRoute(d,I);return i;}i.appSpecificRoute=I;}return i;};this.hrefForExternal=function(o,d,e){var f,E,i;if(sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){f=jQuery.sap.extend(true,{},o);E=this._extractInnerAppRoute(f);i=E.intent;u.addXAppStateFromParameter(i,"sap-xapp-state-data");f=g(i,d);f=b(f);f=this._injectInnerAppRoute(f,E.innerAppRoute);return sap.ushell.Container.getService("ShellNavigation").hrefForExternal(f,undefined,d,e);}jQuery.sap.log.debug("Shell not available, no Cross App Navigation");if(e){return(new jQuery.Deferred()).resolve("").promise();}return"";};this.expandCompactHash=function(h){return sap.ushell.Container.getService("NavTargetResolution").expandCompactHash(h);};this.backToPreviousApp=function(){if(this.isInitialNavigation()){this.toExternal({target:{shellHash:"#"},writeHistory:false});return;}this.historyBack();};this.historyBack=function(i){var d=-1;if(i&&typeof i==="number"){if(i<=0){jQuery.sap.log.warning("historyBack called with an argument <= 0 and will result in a forward navigation or refresh","expected was an argument > 0","sap.ushell.services.CrossApplicationNavigation#historyBack");}d=i*-1;}window.history.go(d);};this.isInitialNavigation=function(){var o=sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation");if(!o){jQuery.sap.log.debug("ShellNavigation service not available","This will be treated as the initial navigation","sap.ushell.services.CrossApplicationNavigation");return true;}var i=o.isInitialNavigation();if(typeof i==="undefined"){return true;}return i;};this.toExternal=function(o,d){var e,E,i,w=o.writeHistory;if(sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){e=jQuery.sap.extend(true,{},o);E=this._extractInnerAppRoute(e);i=E.intent;u.addXAppStateFromParameter(i,"sap-xapp-state-data");e=g(i,d);e=b(e);delete e.writeHistory;e=this._injectInnerAppRoute(e,E.innerAppRoute);sap.ushell.Container.getService("ShellNavigation").toExternal(e,d,w);return;}jQuery.sap.log.debug("Shell not avialable, no Cross App Navigation");return;};this.hrefForAppSpecificHash=function(d){if(sap.ushell&&sap.ushell.Container&&typeof sap.ushell.Container.getService==="function"&&sap.ushell.Container.getService("ShellNavigation")){return sap.ushell.Container.getService("ShellNavigation").hrefForAppSpecificHash(d);}jQuery.sap.log.debug("Shell not available, no Cross App Navigation; fallback to app-specific part only");return"#"+encodeURI(d);};this.getPrimaryIntent=function(d,P){var q={};var f;var r=/^#\w+-displayFactSheet(?:$|\?.)/;q.tags=["primaryAction"];q.semanticObject=d;if(P){q.params=P;}return this.getLinks(q).then(function(l){if(l.length===0){delete q.tags;q.action="displayFactSheet";f=function(L,o){var e;if(L.intent===o.intent){return 0;}e=r.test(L.intent)^r.test(o.intent);if(e){return r.test(L.intent)?-1:1;}return L.intent<o.intent?-1:1;};return this.getLinks(q);}f=function(L,o){if(L.intent===o.intent){return 0;}return L.intent<o.intent?-1:1;};return l;}.bind(this)).then(function(l){return l.length===0?null:l.sort(f)[0];});};this.getSemanticObjectLinks=function(d,P,i,o,e,f){var m,h,E;m=g({params:P},o).params;m=b({params:m}).params;h=sap.ushell.Container.getService("NavTargetResolution");var v;if(jQuery.isArray(d)){v=[];d.forEach(function(j){v.push([{semanticObject:j[0],params:j[1],ignoreFormFactor:!!j[2],ui5Component:j[3],appStateKey:j[4],compactIntents:!!(j[5])}]);});}else{v={semanticObject:d,params:m,ignoreFormFactor:i,ui5Component:o,appStateKey:e,compactIntents:!!f};}E=sap.ushell.utils.invokeUnfoldingArrayArguments(h.getLinks.bind(h),[v]);return E;};this.getLinks=function(v){var e;e=sap.ushell.utils.invokeUnfoldingArrayArguments(this._getLinks.bind(this),[v]);return e;};this._getLinks=function(n){var N,P,m,o=sap.ushell.Container.getService("NavTargetResolution");if(typeof n==="undefined"){n={};}N=jQuery.extend(true,{},n);N.compactIntents=!!N.compactIntents;N.action=N.action||undefined;N.paramsOptions=u.extractGetLinksParameterOptions(N.params);P=N.params?u.extractGetLinksParameterDefinition(N.params):N.params;m=g({params:P},N.ui5Component).params;m=b({params:m}).params;if(N.appStateKey){m["sap-xapp-state"]=[N.appStateKey];delete N.appStateKey;}N.params=m;return o.getLinks(N);};this.getDistinctSemanticObjects=function(){var o=sap.ushell.Container.getService("NavTargetResolution");return o.getDistinctSemanticObjects();};this.isIntentSupported=function(i,o){var d=new jQuery.Deferred(),O={},e=i.map(function(I){var f=g(I,o);O[f]=I;return f;});sap.ushell.Container.getService("NavTargetResolution").isIntentSupported(e).done(function(I){var m={};Object.keys(I).forEach(function(k){m[O[k]]=I[k];});d.resolve(m);}).fail(d.reject.bind(d));return d.promise();};this.isNavigationSupported=function(i,o){var d=i.map(function(I){return g(I,o);});return sap.ushell.Container.getService("NavTargetResolution").isNavigationSupported(d);};this.isUrlSupported=function(U){var d=new jQuery.Deferred(),o,h;if(typeof U!=="string"){d.reject();return d.promise();}o=sap.ushell.Container.getService("URLParsing");if(o.isIntentUrl(U)){h=o.getHash(U);this.isIntentSupported(["#"+h]).done(function(r){if(r["#"+h]&&r["#"+h].supported){d.resolve();}else{d.reject();}}).fail(function(){d.reject();});}else{d.resolve();}return d.promise();};this.createComponentInstance=function(i,o,O){var d,U,e,f;if(!o){o={};}else{f=Object.keys(o).length;if(f>1||(f===1&&!o.componentData)){throw"`oConfig` argument should either be an empty object or contain only the `componentData` property.";}}if(o.componentData){delete o.componentData.startupParameters;delete o.componentData.config;delete o.componentData["sap-xapp-state"];}d=sap.ushell.Container;U=d.getService("URLParsing");e=U.constructShellHash(U.parseShellHash(i));if(!e){return new jQuery.Deferred(function(D){D.reject("Navigation intent invalid!");}).promise();}return d.getService("NavTargetResolution").resolveHashFragment("#"+e).then(function(r){if(r.applicationType!==sap.ushell.components.container.ApplicationType.URL&&!(/^SAPUI5\.Component=/.test(r.additionalInformation))){return new jQuery.Deferred(function(D){D.reject("The resolved target mapping is not of type UI5 component.");}).promise();}r=jQuery.extend(true,{},r,o);if(!r.ui5ComponentName&&r.additionalInformation){r.ui5ComponentName=r.additionalInformation.replace(/^SAPUI5\.Component=/,"");}return new jQuery.Deferred(function(D){var h=d.getService("Ui5ComponentLoader");if(O){O.runAsOwner(function(){j(r);});}else{j(r);}function j(k){k.loadDefaultDependencies=false;h.createComponent(k).then(function(l){D.resolve(l.componentHandle.getInstance());},function(E){E=E||"";jQuery.sap.log.error("Cannot create UI5 component: "+E,E.stack,"sap.ushell.services.CrossApplicationNavigation");D.reject(E);});}}).promise();});};this.createEmptyAppState=function(o,t){if(!A){A=sap.ushell.Container.getService("AppState");}if(!(o instanceof sap.ui.core.UIComponent)){throw new Error("oAppComponent passed must be a UI5 Component");}return A.createEmptyAppState(o,t);};this.getStartupAppState=function(o){this._checkComponent(o);var d=o.getComponentData()&&o.getComponentData()["sap-xapp-state"]&&o.getComponentData()["sap-xapp-state"][0];return this.getAppState(o,d);};this._checkComponent=function(o){if(!(o instanceof sap.ui.core.UIComponent)){throw new Error("oComponent passed must be a UI5 Component");}};this.getAppState=function(o,d){var e,D=new jQuery.Deferred();this._checkComponent(o);if(!A){A=sap.ushell.Container.getService("AppState");}if(typeof d!=="string"){if(d!==undefined){jQuery.sap.log.error("Illegal Argument sAppStateKey ");}setTimeout(function(){e=A.createEmptyUnmodifiableAppState(o);D.resolve(e);},0);return D.promise();}return A.getAppState(d);};this.getAppStateData=function(d){return sap.ushell.utils.invokeUnfoldingArrayArguments(this._getAppStateData.bind(this),[d]);};this._getAppStateData=function(d){var D=new jQuery.Deferred();if(!A){A=sap.ushell.Container.getService("AppState");}if(typeof d!=="string"){if(d!==undefined){jQuery.sap.log.error("Illegal Argument sAppStateKey ");}setTimeout(function(){D.resolve(undefined);},0);}else{A.getAppState(d).done(function(o){D.resolve(o.getData());}).fail(D.resolve.bind(D,undefined));}return D.promise();};this.saveMultipleAppStates=function(d){var r=[],D=new jQuery.Deferred();d.forEach(function(o){r.push(o.save());});jQuery.when.apply(this,r).done(function(){D.resolve(r);}).fail(function(){D.reject("save failed");});return D.promise();};}C.hasNoAdapter=true;return C;},true);
