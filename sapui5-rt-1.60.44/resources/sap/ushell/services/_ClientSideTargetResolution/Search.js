// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/utils","sap/ushell/services/_ClientSideTargetResolution/Utils","sap/ushell/services/_ClientSideTargetResolution/VirtualInbounds","sap/ushell/services/_ClientSideTargetResolution/Formatter","sap/ushell/TechnicalParameters"],function(u,U,v,f,t){"use strict";var A=[undefined,"GUI","WDA","UI5"];function a(M,I){var R=M.inbound.resolutionResult;if(!R){return"";}return["applicationType","ui5ComponentName","url","additionalInformation","text"].map(function(K){if(I){return R.hasOwnProperty(K)?K+":"+R[K]:"";}return R.hasOwnProperty(K)?R[K]:"";}).join("");}function b(M){return M.sort(function(s,x){if((s["sap-priority"]||0)-(x["sap-priority"]||0)!==0){return-((s["sap-priority"]||0)-(x["sap-priority"]||0));}if(s.priorityString<x.priorityString){return 1;}if(s.priorityString>x.priorityString){return-1;}var S=a(s);var y=a(x);if(S<y){return 1;}else if(S>y){return-1;}return 0;});}function e(I,M){var s;if(I&&I["sap-priority"]&&I["sap-priority"][0]){s=parseInt(I["sap-priority"][0],10);if(!isNaN(s)){M["sap-priority"]=s;}}return;}function m(V,F,K,M){var s;if(!F){return true;}if(!V&&V!==""){return false;}s=F.value;if(F.format==="reference"){if(/UserDefault\.extended\./.test(s)){jQuery.sap.log.error("Illegal inbound: extended user default '"+s+"' used as filter");return false;}if(K.hasOwnProperty(s)){return V===K[s];}M[s]=true;return true;}if(F.format==="value"||F.format==="plain"||F.format===undefined){return V===F.value;}else if(F.format==="regexp"){return!!V.match("^"+F.value+"$");}else{jQuery.sap.log.error("Illegal oFilter format");return false;}}function g(M){return M.inbound&&M.inbound.resolutionResult&&M.inbound.resolutionResult["sap.ui"]&&M.inbound.resolutionResult["sap.ui"].technology;}function c(M){return M.inbound&&M.inbound.resolutionResult&&M.inbound.resolutionResult.appId;}function d(I,s,K,M,D){var x={},y={};Object.keys(I).forEach(function(P){if(P!=="sap-ushell-defaultedParameterNames"){x[P]=I[P];}});if(!s){return x;}Object.keys(s).forEach(function(P){var T=s[P],z,V=false;if(!x[P]&&T.hasOwnProperty("defaultValue")){if(T.defaultValue.format&&T.defaultValue.format==="reference"){z=T.defaultValue.value;if(K.hasOwnProperty(z)){if(typeof K[z]==="string"){x[P]=[K[z]];V=true;}else if(typeof K[z]==="object"){x[P]=K[z];V=true;}}else{x[P]=[T.defaultValue];M.push(T.defaultValue.value);}}else{x[P]=[T.defaultValue.value];V=true;}if(V){y[P]=true;}}});Object.keys(y).sort().forEach(function(P){D.push(P);});return x;}function h(M,I){M.resolutionResult={};if(I&&I.resolutionResult&&I.resolutionResult.hasOwnProperty("sap.platform.runtime")){M.resolutionResult["sap.platform.runtime"]=I.resolutionResult["sap.platform.runtime"];}Object.keys(M.intentParamsPlusAllDefaults).slice(0).forEach(function(N){if(!jQuery.isArray(M.intentParamsPlusAllDefaults[N])){if(!M.resolutionResult.oNewAppStateMembers){M.resolutionResult.oNewAppStateMembers={};}M.resolutionResult.oNewAppStateMembers[N]=M.intentParamsPlusAllDefaults[N];}});}function i(R,M){R.forEach(function(s){M[s]=true;});}function j(M){var T=M.intentParamsPlusAllDefaults["sap-ui-tech-hint"]&&M.intentParamsPlusAllDefaults["sap-ui-tech-hint"][0];var I=M.defaultedParamNames&&(M.defaultedParamNames.indexOf("sap-ui-tech-hint")>=0);if(T&&g(M)===T){return I?1:2;}return 0;};function k(M){var s=M.intentParamsPlusAllDefaults["sap-ui-app-id-hint"]&&M.intentParamsPlusAllDefaults["sap-ui-app-id-hint"][0];if(s&&(s===c(M))){return 1;}return 0;}function l(M,x){function y(N){var s="000"+N;return s.substr(s.length-3);}return["AIDM="+k(M),M.genericSO?"g":"x","TECM="+j(M),"MTCH="+y(x.countMatchingParams),"MREQ="+y(x.countMatchingRequiredParams),"NFIL="+y(x.countMatchingFilterParams),"NDEF="+y(x.countDefaultedParams),"POT="+y(x.countPotentiallyMatchingParams),"RFRE="+y(999-x.countFreeInboundParams),"TECP="+n(M)].join(" ");};function n(M){var T=g(M);var P=A.indexOf(T);return Math.max(0,P);}function o(I,s){var x=false;if(I.signature.additionalParameters==="allowed"||I.signature.additionalParameters==="ignored"){return true;}if(I.signature.additionalParameters==="notallowed"||I.signature.additionalParameters===undefined){x=Object.keys(s).every(function(P){return(!I.signature.parameters[P]&&P.indexOf("sap-")!==0)?false:true;});}else{jQuery.sap.log.error("Unexpected value of inbound for signature.additionalParameters");}return x;}function p(I,s,K,D){var M=s.reduce(function(R,x){var y=w(I,x,K,R.missingReferences);if(y.matches){R.matchResults.push(y);}else if(D){(function(){var N=R.noMatchReasons;var z=f.formatInbound(x);N[z]=y.noMatchReason+(y.noMatchDebug?"| DEBUG: "+y.noMatchDebug:"");})();}return R;},{matchResults:[],noMatchReasons:{},missingReferences:{}});return jQuery.when(M);}function q(I,s,x,D,K,M){var S=Object.keys(I).every(function(P){var V=s[P],y=V&&V[0],z=I[P];if(z.required&&(y===null||y===undefined)){return false;}if(z.filter){if(!m(y,z.filter,K,M)){return false;}}return true;});return S;}function r(I,s,x,D,y){var z=0,B=0,C=0,E=0,S={};function F(P){return!t.isTechnicalParameter(P);}var G=Object.keys(x).filter(F);var H=D.filter(F);Object.keys(I).filter(F).forEach(function(P){var V=s[P],J=V&&V[0],K=I[P],L=x.hasOwnProperty(P);if(L){++z;if(K.filter){++C;}if(K.required){++B;}}else if(J===null||J===undefined){++E;}});if(y){S.countPotentiallyMatchingParams=G.filter(function(J){return I.hasOwnProperty(J);}).length;}else{S.countPotentiallyMatchingParams=G.length;}S.countDefaultedParams=H.length;S.countMatchingParams=z;S.countMatchingRequiredParams=B;S.countMatchingFilterParams=C;S.countFreeInboundParams=E;return S;}function w(I,s,K,M){var x={inbound:s};function N(W,X,Y){W.matches=false;W.noMatchReason=X;W.noMatchDebug=Y;return W;}function y(W){W.matches=true;W.matchesVirtualInbound=v.isVirtualInbound(s);return W;}var z=s.semanticObject==="*";x.genericSO=z;var S=I.semanticObject===undefined||I.semanticObject===s.semanticObject||z;if(!S){return N(x,"Semantic object \""+I.semanticObject+"\" did not match");}var B=I.action===undefined||I.action===s.action;if(!B){return N(x,"Action \""+I.action+"\" did not match");}var F=!s.deviceTypes||I.formFactor===undefined||s.deviceTypes[I.formFactor];if(!F){return N(x,"Form factor \""+I.formFactor+"\" did not match","Inbound: ["+Object.keys(s.deviceTypes).filter(function(W){return!!s.deviceTypes[W];}).join(", ")+"]");}var T=I.params&&I.params["sap-ui-tech-hint"]&&I.params["sap-ui-tech-hint"][0];if(I.treatTechHintAsFilter&&T){var C=g({inbound:s});if(C!==T){return N(x,"Tech Hint as filter \""+T+"\" did not match","Inbound: ["+C+"]");}}var R=[],D=[],E=I.params||{};var G=d(E,s.signature&&s.signature.parameters,K,R,D);x.intentParamsPlusAllDefaults=G;x.defaultedParamNames=D;e(G,x);var H=q(s.signature.parameters,G,E,D,K,M);if(!H){return N(x,"Inbound parameter signature did not match",f.formatInboundSignature(s.signature));}var P=U.constructParameterDominatorMap(s.signature.parameters);var J=U.findDominatedDefaultParameters(G,D,P);var L=D.filter(function(W){return!J[W];});var O=U.filterObjectKeys(G,function(W){return!J[W];});if(!o(s,O)){return N(x,"Additional parameters not allowed",f.formatInboundSignature(s.signature));}var Q=s.signature.additionalParameters==="ignored";if(Q){U.filterObjectKeys(O,function(W){if(W.indexOf("sap-")===0){return true;}if(s.signature.parameters.hasOwnProperty(W)){return true;}return false;},true);}var V=r(s.signature.parameters,G,E,D,Q);h(x,s);x.intentParamsPlusAllDefaults=O;x.defaultedParamNames=L;x.priorityString=l(x,V);i(R,M);return y(x);}return{match:p,matchOne:w,sortMatchingResultsDeterministic:b,matchesFilter:m,checkAdditionalParameters:o,addDefaultParameterValues:d,extractSapPriority:e,serializeMatchingResult:a};});
