sap.ui.define(["sap/ui/base/EventProvider","sap/ushell/ui/launchpad/UserStatusItem"],function(E,U){"use strict";return function(s){var S=s.serviceRegistry,a=s.serviceFactory,b=s.service;var o=new E(),O={statusChanged:"statusChanged",serviceStateChanged:"serviceStateChanged"},A;var c=b.extend("sap.ushell.ui5service.UserStatus",{init:function(){var t=this,p=this.getInterface();c.prototype.isEnabled=false;p.init=function(){t._amendPublicServiceInstance.call(t,this);};S.register("sap.ushell.ui5service.UserStatus",new a(p));c.prototype.AvailableStatus={AVAILABLE:"AVAILABLE",AWAY:"AWAY",BUSY:"BUSY",APPEAR_OFFLINE:"APPEAR_OFFLINE"};},_setActiveComponentId:function(i){A=i;},_getActiveComponentId:function(){return A;},_getEventProvider:function(){return o;},_ensureArrayOfObjectOfStrings:function(v,m){var V=jQuery.isArray(v)&&v.every(function(d){return jQuery.isPlainObject(d)&&Object.keys(d).length>0&&Object.keys(d).every(function(k){return typeof d[k]==="string";});});if(!V){jQuery.sap.log.error("'"+m+"' was called with invalid parameters","An array of non-empty objects with string values is expected","sap.ushell.ui5service.UserStatus");}return V;},_ensureFunction:function(v,m){var t=typeof v;if(t!=="function"){jQuery.sap.log.error("'"+m+"' was called with invalid arguments","the parameter should be a function, got '"+t+"' instead","sap.ushell.ui5service.UserStatus");return false;}return true;},_ensureString:function(v,m){var t=typeof v;if(t!=="string"){jQuery.sap.log.error("'"+m+"' was called with invalid arguments","the parameter should be a string, got '"+t+"' instead","sap.ushell.ui5service.UserStatus");return false;}return true;},_addCallAllowedCheck:function(p,P){var t=this;p[P]=function(){var C=p.getContext();if(!C||C.scopeObject.getId()!==A){jQuery.sap.log.warning("Call to "+P+" is not allowed","This may be caused by an app component other than the active '"+A+"' that tries to call the method","sap.ushell.ui5service.UserStatus");return undefined;}return t[P].apply(p,arguments);};},_amendPublicServiceInstance:function(p){var t=this,C;C=p.getContext();if(typeof C==="undefined"){return;}["setStatus","attachStatusChanged","detachStatusChanged"].forEach(function(m){t._addCallAllowedCheck(p,m);});if(C.scopeType==="component"){this._setActiveComponentId(C.scopeObject.getId());return;}jQuery.sap.log.error("Invalid context for UserStatus interface","The context must be empty or an object like { scopeType: ..., scopeObject: ... }","sap.ushell.ui5service.UserStatus");},setEnabled:function(e){o.fireEvent(O.serviceStateChanged,{data:e});c.prototype.isEnabled=e;this._getUserStatusSetting().then(function(u){if(u===undefined||u.userStatusEnabled===undefined){this._showLegalPopup();}else if(u.userStatusEnabled){this.setStatus(u.userStatusDefault);}else if(!u.userStatusEnabled){this.setStatus(null);}}.bind(this));return;},attachEnabledStatusChanged:function(f){this._getEventProvider().attachEvent(O.serviceStateChanged,f);},detachEnabledStatusChanged:function(f){this._getEventProvider().detachEvent(O.serviceStateChanged,f);},setStatus:function(n){if(!c.prototype.isEnabled){throw new Error("Unable to change status because the UserStatus service is disabled.");}if(!c.prototype.AvailableStatus[n]&&n!==null){throw new Error("Enter a valid status.");}this._getUserStatusSetting().then(function(u){if((n!==null)&&(u===undefined||u.userStatusEnabled===undefined||!u.userStatusEnabled)){throw new Error("Unable to change status; user has not explicitly opted-in to share their online status.");}o.fireEvent(O.statusChanged,{data:n});return;});},getUxdVersion:function(){if((new jQuery.sap.Version(sap.ui.version).compareTo("1.37.0"))>=0){return 2;}return 1;},attachStatusChanged:function(f){this._getEventProvider().attachEvent(O.statusChanged,f);},detachStatusChanged:function(f){this._getEventProvider().detachEvent(O.statusChanged,f);},_getOnlineStatusPopOver:function(u){var p=new sap.m.Popover({placement:sap.m.PlacementType.Bottom,showArrow:true,showHeader:false,content:[new U({status:U.prototype.STATUS_ENUM.AVAILABLE,isOpener:false,press:function(e){d.setStatus(U.prototype.STATUS_ENUM.AVAILABLE);p.close();}}).addStyleClass('sapUserStatusContainer'),new U({status:U.prototype.STATUS_ENUM.AWAY,isOpener:false,press:function(e){d.setStatus(U.prototype.STATUS_ENUM.AWAY);p.close();}}).addStyleClass('sapUserStatusContainer'),new U({status:U.prototype.STATUS_ENUM.BUSY,isOpener:false,press:function(e){d.setStatus(U.prototype.STATUS_ENUM.BUSY);p.close();}}).addStyleClass('sapUserStatusContainer'),new U({status:U.prototype.STATUS_ENUM.APPEAR_OFFLINE,isOpener:false,press:function(e){d.setStatus(U.prototype.STATUS_ENUM.APPEAR_OFFLINE);p.close();}}).addStyleClass('sapUserStatusContainer')]});var d=new U({tooltip:"{i18n>headerActionsTooltip}",enabled:false,ariaLabel:sap.ushell.Container.getUser().getFullName(),image:sap.ui.core.IconPool.getIconURI("account"),status:u?U.prototype.STATUS_ENUM[u]:U.prototype.STATUS_ENUM["AVAILABLE"],press:function(e){var B=sap.ui.getCore().byId(e.mParameters.id);p.openBy(B);}.bind(this),contentList:p}).addStyleClass('sapUserStatusOpener');return d;},_showLegalPopup:function(){var t=this;setTimeout(function(){var T=sap.ui.getCore().getConfiguration().getRTL()?'Left':'Right';var d=sap.ui.Device.system.phone?"auto":"14rem";var f=sap.ui.Device.system.phone?"auto":"10rem";var g=new sap.m.Label({text:sap.ushell.resources.i18n.getText("enableStatusMessageBoxFld")+":",width:d,textAlign:T});var h=new sap.m.Switch("enableStatusSwitch",{type:sap.m.SwitchType.Default,change:function(e){k.setEnabled(e.mParameters.state);jQuery("#"+k.getId()).attr("tabindex",e.mParameters.state?0:-1);}.bind(this)});var i=new sap.m.FlexBox({alignItems:'Center',direction:'Row',items:[g,h]}).addStyleClass('sapUshellUserStatusFlexBox');var j=new sap.m.Label({text:sap.ushell.resources.i18n.getText("userStatusMessageBoxDropdownLabelFld")+":",width:f,textAlign:T}).addStyleClass("sapUshellUserStatusSignInAsLabel");var k=t._getOnlineStatusPopOver(U.prototype.STATUS_ENUM.AVAILABLE.status);jQuery("#"+k.getId()).attr("tabindex",k.getEnabled()?0:-1);var l=new sap.m.Text({text:sap.ushell.resources.i18n.getText("userStatusMessageBoxInfoTextLine1")}).addStyleClass('sapUshellUserStatusLegalTextLine').addStyleClass('sapUshellUserStatusLegalTextFirstLine');var m=new sap.m.Text({text:sap.ushell.resources.i18n.getText("userStatusMessageBoxInfoTextLine2")}).addStyleClass('sapUshellUserStatusLegalTextLine');var n=new sap.m.FlexBox({alignItems:'Center',direction:'Row',items:[j,k]}).addStyleClass('sapUshellUserStatusFlexBox');var p=new sap.ui.layout.VerticalLayout('userStatusDialogLayout',{content:[i,n,l,m]});var q=new sap.m.Button('saveButton',{text:sap.ushell.resources.i18n.getText("okBtn"),press:function(){t._writeUserStatusSettingToPersonalization({userStatusEnabled:h.getState(),userStatusDefault:h.getState()?k.getStatus().status:null});t.setStatus(h.getState()?k.getStatus().status:null);r.close();}});var r=new sap.m.Dialog('agreementMessageBox',{title:sap.ushell.resources.i18n.getText("userStatusAgreementMessageBoxTitle"),modal:true,stretch:sap.ui.Device.system.phone,buttons:[q],afterClose:function(e){t._getUserStatusSetting().then(function(u){if(u===undefined||u.userStatusEnabled===undefined){t._writeUserStatusSettingToPersonalization({userStatusEnabled:false,userStatusDefault:null});t.setStatus(null);}r.destroy();});}}).addStyleClass('sapUshellUserStatusDialog');r.addContent(p);r.open();},100);},_getUserStatusSetting:function(){var p=this._getUserSettingsPersonalizer();return p.getPersData();},_writeUserStatusSettingToPersonalization:function(u){var d,p;try{p=this._getUserSettingsPersonalizer().setPersData(u);}catch(e){jQuery.sap.log.error("Personalization service does not work:");jQuery.sap.log.error(e.name+": "+e.message);d=new jQuery.Deferred();d.reject(e);p=d.promise();}return p;},_getUserSettingsPersonalizer:function(){this.oUserPersonalizer=this._createUserPersonalizer();return this.oUserPersonalizer;},_createUserPersonalizer:function(){var p=sap.ushell.Container.getService("Personalization"),C,d={keyCategory:p.constants.keyCategory.FIXED_KEY,writeFrequency:p.constants.writeFrequency.LOW,clientStorageAllowed:true},P={container:"sap.ushell.services.UserStatus",item:"userStatusData"},e=p.getPersonalizer(P,d,C);return e;}});return c;};});
