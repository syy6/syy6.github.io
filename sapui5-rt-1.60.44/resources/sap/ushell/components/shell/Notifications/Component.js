// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/resources','sap/ui/core/UIComponent','sap/ushell/components/homepage/ComponentKeysHandler','sap/ushell/renderers/fiori2/AccessKeysHandler','sap/ushell/utils','sap/ushell/ui/shell/RightFloatingContainer','sap/ushell/EventHub','sap/ui/Device'],function(r,U,C,A,u,R,E,D){"use strict";return U.extend("sap.ushell.components.shell.Notifications.Component",{metadata:{version:"1.60.40",library:"sap.ushell.components.shell.Notifications",dependencies:{libs:["sap.m"]},config:{}},createContent:function(){this.oRenderer=sap.ushell.Container.getRenderer("fiori2");this.oDefConfig={};this.bIsViewCreated=false;this.isNotificationPreviewLoaded=false;this.oNotificationsPreviewModel=undefined;this.AccessKeysHandler=A;var t=this;var a=h.bind(this);var f=function(N){var B=this.mBindingInfos[N],d=this.getMetadata().getJSONKeys()[N],e;jQuery.each(this[d._sGetter](),jQuery.proxy(function(i,v){this[d._sRemoveMutator](v);},this));jQuery.each(B.binding.getContexts(),jQuery.proxy(function(i,v){e=B.factory(this.getId()+"-"+i,v)?B.factory(this.getId()+"-"+i,v).setBindingContext(v,B.model):"";this[d._sMutator](e);},this));};this.oPreviewNotificationsContainerPlaceholder=new R({id:'notifications-preview-container-placeholder',visible:{path:'/enableNotificationsPreview',formatter:function(v){return t._handleNotificationsPreviewVisibility.apply(t,[v]);}}}).addStyleClass('sapUshellPreviewNotificationsConainer');this.oPreviewNotificationsContainer=new R({id:'notifications-preview-container',top:4,right:'1rem',actAsPreviewContainer:true,floatingContainerItems:{path:"/previewNotificationItems",factory:function(d,e){return sap.ui.getCore().byId(e.getObject().previewItemId);}},insertItemsWithAnimation:{path:'/animationMode',formatter:function(s){return s!=='minimal';}},visible:{path:'/enableNotificationsPreview',formatter:this._handleNotificationsPreviewVisibility.bind(this)}}).addStyleClass('sapContrastPlus').addStyleClass('sapContrast');this.oPreviewNotificationsContainer.updateAggregation=f;sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell.services.Notifications","enablePreviewNotificationChanged",this._updateNotificationConfiguration,this);sap.ui.getCore().getEventBus().publish("shell","notificationsPreviewContainerCreated",{previewNotificationsContainerPlaceholder:this.oPreviewNotificationsContainerPlaceholder,previewNotificationsContainer:this.oPreviewNotificationsContainer});this.oNotificationsPreviewModel=this.oPreviewNotificationsContainer.getModel();var o=(this.getComponentData()?this.getComponentData().config:{});this.oDefConfig={view:{position:"right"},enableHeaderButton:true,enablePreview:true};var n,b;this._updateNotificationConfiguration();if(sap.ushell.Container.getService("Notifications").isEnabled()===true){sap.ushell.Container.getRenderer("fiori2").shellCtrl.getModel().setProperty("/enableNotifications",true);sap.ushell.Container.getService("Notifications").init();if(this.oRenderer.getShellConfig().enableNotificationsUI===true){sap.ushell.Container.getRenderer("fiori2").shellCtrl.getModel().setProperty("/enableNotificationsUI",true);sap.ushell.Container.getService("Notifications").registerDependencyNotificationsUpdateCallback(this.notificationsCountUpdateCallback.bind(this),true);}}this.oDefConfig=jQuery.extend(this.oDefConfig,o);n=sap.ui.getCore().byId("NotificationsCountButton");n.applySettings({icon:sap.ui.core.IconPool.getIconURI("ui-notifications"),floatingNumber:{parts:["/notificationsCount"],formatter:function(d){var j=this.getDomRef(),e="";if(j){if(d>0){e=r.i18n.getText("NotificationToggleButtonCollapsed",d);}else{e=r.i18n.getText("NotificationToggleButtonCollapsedNoNotifications");}j.setAttribute("aria-label",e);}return d;}},visible:"{/enableNotifications}",enabled:"{/enableNotifications}",selected:{path:"/currentViewPortState",formatter:function(v){if(v==='RightCenter'){return true;}return false;}},press:function(){a(this,!this.getSelected());},showSeparator:false,tooltip:r.i18n.getText("NotificationToggleButtonExpanded")},true,true).removeStyleClass("sapUshellPlaceHolders");b=n.onAfterRendering;n.onAfterRendering=function(){if(b){b.apply(this,arguments);}jQuery(this.getDomRef()).attr("aria-pressed",t.oRenderer.getNotificationsSelected());if(this.getDisplayFloatingNumber()>0){jQuery(this.getDomRef()).attr("aria-label",r.i18n.getText("NotificationToggleButtonCollapsed",this.getDisplayFloatingNumber()));}else{jQuery(this.getDomRef()).attr("aria-label",r.i18n.getText("NotificationToggleButtonCollapsedNoNotifications"));}};n.addEventDelegate({onsapskipforward:function(e){t.AccessKeysHandler.bForwardNavigation=true;e.preventDefault();jQuery("#sapUshellHeaderAccessibilityHelper").focus();},onsaptabnext:function(e){t.AccessKeysHandler.bForwardNavigation=true;e.preventDefault();jQuery("#sapUshellHeaderAccessibilityHelper").focus();},onsapskipback:function(e){if(t.AccessKeysHandler.getAppKeysHandler()){e.preventDefault();t.AccessKeysHandler.bFocusOnShell=false;}}});this.oRenderer.addShellDanglingControl(n);if(sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().getProperty("/enableNotificationsUI")===true){sap.ushell.Container.getRenderer("fiori2").oShellModel.addHeaderEndItem(["NotificationsCountButton"],false,["home","app","minimal"],true);}if(D.media.getCurrentRange(D.media.RANGESETS.SAP_STANDARD).name==="Phone"){sap.ushell.Container.getRenderer("fiori2").getShellController().handleEndItemsOverflow({name:'Phone',showOverFlowBtn:true});}E.on('showNotifications').do(function(v){a(n,v);});sap.ui.getCore().getEventBus().publish("shell","notificationsCompLoaded",{delay:1000});},_notificationsUpdateCallback:function(){var t=this,a=5,T=0,b=this.oNotificationsPreviewModel.getProperty("/previewNotificationItems"),n=[],N=[],d,e,f,g,j,i,o,k=false,m=a-b.length-1;sap.ushell.Container.getService("Notifications").getNotifications().done(function(l){if(!l){return;}var p=sap.ui.getCore().byId("notifications-preview-container"),v;if(!this.isNotificationPreviewLoaded){p.setEnableBounceAnimations(true);}if(b&&b.length){for(j=0;j<b.length;j++){var O=b[j].originalItemId,q=false;for(i=0;i<l.length;i++){if(l[i].Id===O){q=true;break;}if(b[j].originalTimestamp>l[i].CreatedAt){break;}}if(!q){b.splice(j,1);k=true;j--;}}}if(b&&b.length>0){d=b[0].originalTimestamp;e=sap.ushell.Container.getService("Notifications")._formatAsDate(d);}for(j=0;(j<l.length)&&(T<a);j++){f=l[j].CreatedAt;g=sap.ushell.Container.getService("Notifications")._formatAsDate(f);if((e?g>e:true)){n[T]=l[j];T++;}}var s=n.length;if(b&&b.length>0&&b.length<a&&l.length>b.length){d=b[b.length-1].originalTimestamp;e=sap.ushell.Container.getService("Notifications")._formatAsDate(d);T=0;for(j=0;(j<l.length)&&(T<=m);j++){f=l[j].CreatedAt;g=sap.ushell.Container.getService("Notifications")._formatAsDate(f);if(g<e){n[s+T]=l[j];T++;}}}if(n.length===0&&!k){this._disableNotificationPreviewBouncingAnimation(p);return;}for(i=0;i<n.length;i++){o=new sap.m.NotificationListItem({hideShowMoreButton:true,title:n[i].SensitiveText?n[i].SensitiveText:n[i].Text,description:n[i].SubTitle,datetime:u.formatDate(n[i].CreatedAt),priority:sap.ui.core.Priority[n[i].Priority.charAt(0)+n[i].Priority.substr(1).toLowerCase()],press:function(w){var x=this.getBindingContext().getPath(),P=x.split("/"),y="/"+P[1]+"/"+P[2],z=this.getModel().getProperty(y),S=z.NavigationTargetObject,B=z.NavigationTargetAction,F=z.NavigationTargetParams,G=z.originalItemId,H=sap.ushell.Container.getService("Notifications");u.toExternalWithParameters(S,B,F);var I=H.markRead(G);I.fail(function(){sap.ushell.Container.getService('Message').error(r.i18n.getText('notificationsFailedMarkRead'));});},close:function(w){var x=this.getBindingContext().getPath(),P=x.split("/"),y="/"+P[1]+"/"+P[2],z=this.getModel().getProperty(y),B=z.originalItemId,b=t.oNotificationsPreviewModel.getProperty("/previewNotificationItems"),F=sap.ushell.Container.getService("Notifications"),G=F.dismissNotification(B);G.done(function(){var i;for(i=0;i<b.length;i++){if(b[i].originalItemId===B){break;}}b.splice(i,1);t.oNotificationsPreviewModel.setProperty("/previewNotificationItems",b);});G.fail(function(){sap.ushell.Container.getService('Message').error(r.i18n.getText('notificationsFailedDismiss'));t.oNotificationsPreviewModel.setProperty("/previewNotificationItems",b);});}}).addStyleClass("sapUshellNotificationsListItem");N.push({previewItemId:o.getId(),originalItemId:n[i].Id,originalTimestamp:n[i].CreatedAt,NavigationTargetObject:n[i].NavigationTargetObject,NavigationTargetAction:n[i].NavigationTargetAction,NavigationTargetParams:n[i].NavigationTargetParams});v=sap.ui.getCore().byId('viewPortContainer');if(v.getCurrentState()==="RightCenter"){o.addStyleClass("sapUshellRightFloatingContainerItemBounceOut");}}if(b.length===0){t.oNotificationsPreviewModel.setProperty("/previewNotificationItems",N);this._disableNotificationPreviewBouncingAnimation(p);return;}for(j=N.length-1;j>-1;j--){if(b.length>=a){setTimeout(function(){b.pop();t.oNotificationsPreviewModel.setProperty("/previewNotificationItems",b);},1000);}if(N[j].originalTimestamp>b[0].originalTimestamp){b.unshift(N[j]);}else{b.push(N[j]);}}t.oNotificationsPreviewModel.setProperty("/previewNotificationItems",b);this._disableNotificationPreviewBouncingAnimation(p);}.bind(this)).fail(function(){});},_disableNotificationPreviewBouncingAnimation:function(n){if(!this.isNotificationPreviewLoaded){this.isNotificationPreviewLoaded=true;n.setEnableBounceAnimations(false);}},_handleNotificationsPreviewVisibility:function(e){var s=this.oRenderer.getCurrentViewportState(),i=s==='Center',n=sap.ushell.Container.getService('Notifications');e=e&&i;if(e){if(!this.bNotificationsRegistered){n.registerNotificationsUpdateCallback(this._notificationsUpdateCallback.bind(this));this.bNotificationsRegistered=true;}if(n.isFirstDataLoaded()){setTimeout(function(){if(this.oController&&this.oController._notificationsUpdateCallback){this.oController._notificationsUpdateCallback();}}.bind(this),300);}if(!this.bSubscribedToViewportStateSwitch){this.bHeadsupNotificationsInitialyVisible=this.oRenderer.getRightFloatingContainerVisibility();sap.ui.getCore().getEventBus().subscribe("launchpad","afterSwitchState",this._handleViewportStateSwitch,this);this.bSubscribedToViewportStateSwitch=true;}this._handleHeadsupNotificationsPresentation(s);}return e;},_handleViewportStateSwitch:function(s,e,d){var a=d.getParameter('to');if(a=='Center'){var n=sap.ui.getCore().byId("notifications-preview-container");if(n&&n.setFloatingContainerItemsVisiblity){n.setFloatingContainerItemsVisiblity(true);}}},_handleHeadsupNotificationsPresentation:function(s){var i=s==='Center',p=this.oPreviewNotificationsContainer.getDomRef(),H=p&&p.getBoundingClientRect(),P=H?H.bottom<0:false,S=i?P:this.bHeadsupNotificationsInitialyVisible;this.oRenderer.showRightFloatingContainer(S);},_handleAlerts:function(s,e,n){var N;if(this.oRenderer.getViewPortContainerCurrentState()!=='RightCenter'){for(N=0;N<n.length;N++){this.handleNotification(n[N]);}}},handleNotification:function(n){var a=this.oRenderer.addRightFloatingContainerItem({press:function(e){var v=sap.ui.getCore().byId('viewPortContainer');if(window.hasher.getHash()===n.NavigationTargetObject+"-"+n.NavigationTargetAction){v.switchState("Center");}else{u.toExternalWithParameters(n.NavigationTargetObject,n.NavigationTargetAction,n.NavigationTargetParams);}sap.ushell.Container.getService("Notifications").markRead(n.Id);},datetime:r.i18n.getText("notification_arrival_time_now"),title:n.SensitiveText?n.SensitiveText:n.Text,description:n.SubTitle,unread:n.IsRead,priority:"High",hideShowMoreButton:true},true,true);var t=this;setTimeout(function(){t.oRenderer.removeRightFloatingContainerItem(a.getId(),true);},3500);},notificationsCountUpdateCallback:function(d){var t=this,v=this.oRenderer.getViewPortContainerCurrentState(),i=v==="RightCenter"?true:false;if((d===undefined)||(!i)){this._updateBadge();}else{d.done(function(){t._updateBadge();});}},_updateBadge:function(){var n;sap.ushell.Container.getService("Notifications").getUnseenNotificationsCount().done(function(N){n=parseInt(N,10);sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().setProperty('/notificationsCount',n);}).fail(function(d){jQuery.sap.log.error("Shell.controller - call to notificationsService.getCount failed: ",d,"sap.ushell.renderers.lean.Shell");});},_switchToNotificationView:function(s){this.oRenderer.ViewPortContainerNavTo('rightViewPort',"notificationsView",'show');this.oRenderer.switchViewPortStateByControl(s,"RightCenter");sap.ui.getCore().getEventBus().publish("launchpad","notificationViewOpened");},_switchToNotificationViewWithPreview:function(n,a,s){if(a==='minimal'){this._switchToNotificationView(s);}else{var i=n.getFloatingContainerItems().length;setTimeout(function(){this._switchToNotificationView(s);}.bind(this),300+(i*100));}},_updateNotificationConfiguration:function(s,e,d){var o=this.oRenderer.getModelConfiguration(),n=sap.ushell.Container.getService("Notifications").isEnabled(),N=o.appState!=="embedded"&&o.appState!=="headerless"&&o.appState!=="merged"&&o.appState!=="standalone",b=true,p=true,a,f=D.system.desktop||D.system.tablet||D.system.combi,P={};if(n===true){a=sap.ushell.Container.getService("Notifications").getUserSettingsFlags();a.done(function(g){b=g.previewNotificationEnabled;P.bUserEnableNotificationsPreview=b;P.bConfigEnableNotificationsPreview=p;P.bMainFlagExists=false;if(p&&n&&f&&N){P.bMainFlagExists=true;P.bEnableNotificationsPreview=b;}sap.ui.getCore().getEventBus().publish("shell","changeNotificationPreview",P);});}},exit:function(){sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.services.Notifications","onNewNotifications",this._handleAlerts,this);sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.services.Notifications","enablePreviewNotificationChanged",this._updateNotificationConfiguration,this);if(this.bSubscribedToViewportStateSwitch){sap.ui.getCore().getEventBus().unsubscribe("launchpad","afterSwitchState",this._handleViewportStateSwitch,this);this.bSubscribedToViewportStateSwitch=false;}if(sap.ushell.Container){if(sap.ushell.Container.getService("Notifications").isEnabled()===true){sap.ushell.Container.getService("Notifications").destroy();}}this.oPreviewNotificationsContainerPlaceholder.destroy();this.oPreviewNotificationsContainer.destroy();}});function c(o){if(o.oDefConfig.view&&o.bIsViewCreated==false){var n=sap.ui.view("notificationsView",{viewName:"sap.ushell.components.shell.Notifications.Notifications",type:'JS',viewData:{}});n.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"role",value:"region",writeToDom:true}));n.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"aria-label",value:r.i18n.getText("NotificationToggleButtonExpanded"),writeToDom:true}));o.bIsViewCreated=true;if(o.oDefConfig.view.position==="right"){o.oRenderer.addRightViewPort(n);}else{o.oRenderer.addLeftViewPort(n);}}}function h(s,S){S=!!S;if(s.getSelected()===S){return;}var n=sap.ui.getCore().byId("notifications-preview-container"),a=sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().getProperty('/animationMode')||'full';c(this);if(S){sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().setProperty("/notificationsCount",0);if(n){n.setFloatingContainerItemsVisiblity(false);this._switchToNotificationViewWithPreview(n,a,s);}else{this._switchToNotificationView(s);}}else{this.oRenderer.switchViewPortStateByControl(s,"Center");}sap.ushell.Container.getService("Notifications").notificationsSeen();sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().setProperty("/notificationsCount",0);s.$().attr("aria-pressed",S);s.$().attr("aria-label",r.i18n.getText("NotificationToggleButtonCollapsedNoNotifications"));}});
