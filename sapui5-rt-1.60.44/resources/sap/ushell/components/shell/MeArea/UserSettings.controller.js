// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/ui/launchpad/AccessibilityCustomData','sap/ushell/EventHub','sap/ushell/Config','sap/ui/model/json/JSONModel'],function(A,E,C,J){"use strict";sap.ui.controller("sap.ushell.components.shell.MeArea.UserSettings",{onInit:function(){var v=this.getView(),t=this;this.navBackButton=new sap.m.ToggleButton({icon:sap.ui.Device.system.phone?"sap-icon://nav-back":"sap-icon://menu2",press:function(e){if(sap.ui.Device.system.phone){v.getSplitApp().backDetail();t._handleNavButton();this.setPressed(false);}else{if(v.getSplitApp().isMasterShown()){v.getSplitApp().hideMaster();this.setTooltip(sap.ushell.resources.i18n.getText("ToggleButtonShow"));this.setPressed(false);}else{v.getSplitApp().showMaster();this.setTooltip(sap.ushell.resources.i18n.getText("ToggleButtonHide"));this.setPressed(true);}}},tooltip:sap.ushell.resources.i18n.getText("ToggleButtonShow")});if(v&&v.getSplitApp()){v.getSplitApp().attachAfterMasterClose(t,function(){t._handleNavButton.apply(t);});v.getSplitApp().attachAfterMasterOpen(t,function(){t._handleNavButton.apply(t);});}var m=new J({entries:C.last("/core/shell/model/userPreferences/entries"),profiling:C.last("/core/shell/model/userPreferences/profiling")});this.getView().setModel(m,"entries");this.aDoables=[C.on("/core/shell/model/userPreferences/entries").do(function(e){m.setProperty("/entries",e);}),C.on("/core/shell/model/userPreferences/profiling").do(function(e){m.setProperty("/profiling",e);})];},_handleNavButton:function(){var v=this.getView();if(v&&v.getSplitApp()&&v.getSplitApp().getCurrentDetailPage()){if(!v.getSplitApp().isMasterShown()){v.splitAppHeaderBar.addContentLeft(this.navBackButton);}else{if(sap.ui.Device.system.phone||sap.ui.Device.orientation.landscape){v.splitAppHeaderBar.removeAllContentLeft();}}}},getOriginalDialogContent:function(){if(!this.oInitialContent){var e;e=this.getEntryListControl();this.oInitialContent=new sap.ui.layout.VerticalLayout('userPreferencesLayout',{content:[e]}).addStyleClass("sapUshellUserSettingLayout");this.aDanglingControls.push(this.oInitialContent);}return this.oInitialContent;},createDetailPage:function(e,a,t,c){var b=this,v=b.getView(),o=new sap.m.ObjectHeader({title:t,backgroundDesign:sap.m.BackgroundDesign.Solid}).addStyleClass("sapUshellUserSettingDetailHeader");if(e==="userAccountEntry"){var u=sap.ushell.Container.getUser(),d=u.getImage();if(!d){o.setIcon(sap.ui.core.IconPool.getIconURI("sap-icon://person-placeholder"));}else{o.setIcon(C.last("/core/shell/model/userImage/personPlaceHolder"));}u.attachOnSetImage(this.updateUserImage.bind({origScope:this,oObjectHeader:o}));o.setTitle(sap.ushell.Container.getUser().getFullName());}var p=new sap.m.Page('detail'+c.getId(),{content:[o,c],showHeader:false});p.addStyleClass("sapUsheUserSettingDetaildPage");p.onAfterRendering=function(){b._handleNavButton();};v.aDanglingControls.push(p);v.getModel("entries").setProperty(a+"/contentResult",p);v.getSplitApp().addDetailPage(p);b.navToDetail(p.getId());},updateUserImage:function(d){var u=(typeof d)==='string'?d:d.mParameters;var i=true;if((typeof u)==='string'){if(u){i=false;}}else{if(!jQuery.isEmptyObject(u)){i=false;}}if(!i){this.oObjectHeader.setIcon(this.origScope.getView().getModel().getProperty('/userImage/personPlaceHolder'));}else{this.oObjectHeader.setIcon(sap.ui.core.IconPool.getIconURI("sap-icon://person-placeholder"));}},emitEntryOpened:function(e){var u=E.last("UserSettingsOpened")||{};var p=e.split("/").pop();u[p]=true;E.emit("UserSettingsOpened",u);},getListPressHandler:function(s,a){var t=this,i=true,b=s.getBindingContext("entries").getPath(),v=this.getView(),c=v.getModel("entries").getProperty(b+"/contentResult"),B=null,S=true,I=false,d=v.getModel("entries").getProperty(b),f=d.contentFunc,o,k;if(sap.ui.Device.system.phone){s.setSelected(false);}if(c){t.navToDetail(c.getId(),a);t._handleNavButton();t.emitEntryOpened(b);}else{if(typeof f==="function"){o=f();o.done(function(e){S=false;if(I===true){B.destroy();}if(e instanceof sap.ui.core.Control){t.emitEntryOpened(b);t.createDetailPage.apply(t,[d.entryHelpID,b,d.title,e]);}else{i=false;}});o.fail(function(){S=false;if(I===true){B.destroy();}i=false;});o.always(function(){if(i===false){var e=new sap.m.FlexBox("userPrefErrorFlexBox",{height:"5rem",alignItems:sap.m.FlexAlignItems.Center,justifyContent:sap.m.FlexJustifyContent.Center,items:[new sap.m.Text("userPrefErrorText",{text:v.translationBundle.getText("loadingErrorMessage")})]});v.aDanglingControls.push(e);v.getModel("entries").setProperty(b+"/contentResult",e);v.getSplitApp().addDetailPage(e);t.navToDetail(e.getId());}});if(S===true){B=new sap.m.BusyIndicator('userPrefLoadingBusyIndicator',{size:"2rem"});this.aDanglingControls.push(B);I=true;}}else{d.valueArgument().done(function(V){k=t._getKeyValueContent(d,V);t.createDetailPage(d.entryHelpID,b,d.title,k);}).fail(function(e){k=t._getKeyValueContent(d);t.createDetailPage(d.entryHelpID,b,d.title,k);});}}},_getKeyValueContent:function(e,s){var k,v,b,V=s?s:" ",f=sap.ui.Device.system.phone?'Start':'Center',F=sap.ui.Device.system.phone?'Wrap':'NoWrap',a=sap.ui.Device.system.phone?'Column':'Row';k=new sap.m.Label({text:e.title+":"}).addStyleClass('sapUshellUserSettingsDetailsKey');v=new sap.m.Input({value:V,editable:false}).addStyleClass('sapUshellUserSettingsDetailsValue');b=new sap.m.FlexBox({alignItems:f,wrap:F,direction:a,items:[k,v]});return b;},createMasterPages:function(){var t=this,e=t.getUserSettingsEntryTemplate();this.aDanglingControls=this.getView().aDanglingControls;this.oMasterEntryList=new sap.m.List('userSettingEnteryList',{items:{path:"entries>/entries",template:e},mode:"SingleSelectMaster",select:function(a){t.getListPressHandler(a.getSource().getSelectedItem(),a.getId());}});var o=this.oMasterEntryList.onAfterRendering;this.oMasterEntryList.onAfterRendering=function(){var a=this.getItems();var b;o.apply(this,arguments);for(var i=0;i<a.length;i++){b=a[i].getBindingContext("entries").getPath();t._setEntryValueResult(b);}if(!sap.ui.Device.system.phone){this.setSelectedItem(this.getItems()[0]);t.getListPressHandler(this.getSelectedItem());}};var p=new sap.m.Page("userSettingMaster",{showHeader:false,content:[this.oMasterEntryList]}).addStyleClass("sapUshellUserSettingMaster");t.aDanglingControls.push(this.oMasterEntryList,p);return p;},_setEntryValueResult:function(e){var v=this.getView(),m=v.getModel("entries"),i=m.getProperty(e+"/editable"),a=m.getProperty(e+"/valueArgument"),V;if(typeof a==="function"){m.setProperty(e+"/valueResult",v.translationBundle.getText("genericLoading"));m.setProperty(e+"/editable",false);V=a();if(V){V.done(function(b){m.setProperty(e+"/editable",i);var c=true;if(m.getProperty(e+"/visible")!==undefined){c=m.getProperty(e+"/visible");}else if(m.getProperty(e+"/defaultVisibility")!==undefined){c=m.getProperty(e+"/defaultVisibility");}m.setProperty(e+"/visible",typeof(b)==='object'?!!b.value:c);m.setProperty(e+"/valueResult",typeof(b)==='object'?b.displayText:b);});V.fail(function(){m.setProperty(e+"/valueResult",v.translationBundle.getText("loadingErrorMessage"));});}}else if(!!a){m.setProperty(e+"/valueResult",a);m.setProperty(e+"/editable",i);}else{m.setProperty(e+"/valueResult",v.translationBundle.getText("loadingErrorMessage"));}},getUserSettingsEntryTemplate:function(){var i=new sap.m.StandardListItem({title:"{entries>title}",description:"{entries>valueResult}",icon:{parts:["entries>icon","/userImage/account"],formatter:function(e,u){if(e==="sap-icon://account"){e=u;}return e?e:"sap-icon://action-settings";}},type:sap.ui.Device.system.phone?"Navigation":"Inactive",visible:{parts:[{path:'entries>visible'},{path:'entries>defaultVisibility'},{path:'entries>/profiling/length'}],formatter:function(v,d){if(this.getTitle()===sap.ushell.resources.i18n.getText("userProfiling")){var p=this.getModel("entries").getProperty("/profiling");p.forEach(function(e,a){if(e.entryHelpID==="usageAnalytics"){if(!sap.ushell.Container.getService("UsageAnalytics").systemEnabled()||!sap.ushell.Container.getService("UsageAnalytics").isSetUsageAnalyticsPermitted()){p.splice(a,1);}}},this);return(p!==undefined&&p.length>0);}else{if(v!==undefined){return v;}else{return(d!==undefined)?d:true;}}}},customData:new A({key:"aria-label",value:{parts:[{path:'entries>title'},{path:'entries>valueResult'}],formatter:function(t,v){v=v?v:"";return t+" "+v;}},writeToDom:true})}).addStyleClass("sapUshellUserSettingMasterListItem");return i;},navToDetail:function(i,e){var v=this.getView(),s=v.getSplitApp();s.toDetail(i);E.emit("UserPreferencesDetailNavigated",i);if(e==="select"){this.applyFocus(i);}if(s.getMode()==="ShowHideMode"){s.hideMaster();}},applyFocus:function(i){if(!sap.ui.Device.system.phone){var e=jQuery.sap.byId(i).firstFocusableDomRef();if(e){jQuery.sap.focus(e);}}},onExit:function(){this.aDoables.forEach(function(d){d.off();});this.getView().aDanglingControls.forEach(function(c){if(c){if(c.destroyContent){c.destroyContent();}c.destroy();}});}});},false);
