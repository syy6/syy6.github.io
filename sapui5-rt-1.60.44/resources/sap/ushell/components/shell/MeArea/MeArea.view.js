// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/services/AppType","sap/m/Button","sap/m/List","sap/m/Text","sap/m/VBox","sap/m/HBox","sap/m/Image","sap/m/Dialog","sap/m/Popover","sap/m/OverflowToolbar","sap/m/ScrollContainer","sap/ushell/Config","sap/ushell/renderers/fiori2/AccessKeysHandler","sap/ushell/resources","sap/ushell/ui/launchpad/UserStatusItem","sap/ushell/ui/launchpad/AccessibilityCustomData","sap/m/library","sap/ui/Device","sap/ui/core/Icon","sap/ui/core/IconPool","sap/ui/core/service/ServiceFactoryRegistry","sap/ushell/utils/WindowUtils"],function(A,B,L,T,V,H,I,D,P,O,S,C,a,r,U,b,m,c,d,e,f,W){"use strict";var g=m.BackgroundDesign,h=m.ButtonType,j=m.ListSeparators,k=m.ListType,l=m.PlacementType,n=m.ToolbarDesign;sap.ui.jsview("sap.ushell.components.shell.MeArea.MeArea",{createContent:function(o){this.addStyleClass('sapUshellMeAreaView');this.aDanglingControls=[];var u=sap.ushell.Container.getUser().getFullName(),p,t=r.i18n,q=(this.getViewData()?this.getViewData().config:{})||{},s=q.appState,w=(s==='embedded'||s==='embedded-home'||s==='standalone'||s==='blank-home'||s==='blank'),x,y=f.get("sap.ushell.ui5service.UserStatus");if(y){var z=y.createInstance(),E=function(i){z.then(function(y){y.setStatus(i);p.close();});};}x=[new U({status:U.prototype.STATUS_ENUM.AVAILABLE,id:"userStatusItem1",isOpener:false,press:function(i){E(sap.ushell.ui5service.UserStatus.prototype.AvailableStatus.AVAILABLE);}.bind(this)}).addStyleClass('sapUserStatusContainer'),new U({status:U.prototype.STATUS_ENUM.AWAY,id:"userStatusItem2",isOpener:false,press:function(i){E(sap.ushell.ui5service.UserStatus.prototype.AvailableStatus.AWAY);}.bind(this)}).addStyleClass('sapUserStatusContainer'),new U({status:U.prototype.STATUS_ENUM.BUSY,id:"userStatusItem3",isOpener:false,press:function(i){E(sap.ushell.ui5service.UserStatus.prototype.AvailableStatus.BUSY);}.bind(this)}).addStyleClass('sapUserStatusContainer'),new U({status:U.prototype.STATUS_ENUM.APPEAR_OFFLINE,id:"userStatusItem4",isOpener:false,press:function(i){E(sap.ushell.ui5service.UserStatus.prototype.AvailableStatus.APPEAR_OFFLINE);}.bind(this)}).addStyleClass('sapUserStatusContainer')];if(!q.disableSignOut){x.push(new U({status:U.prototype.STATUS_ENUM.SIGNOUT,id:"userStatusLogout",isOpener:false,press:[o.logout,o]}).addStyleClass('sapUserStatusSignOutContainer'));}var F=new L({id:"sapUshellUserStatusItemList",showSeparators:"None",items:x});F.addCustomData(new b({key:"aria-labelledBy",value:"userStatusItem1",writeToDom:true}));p=new P("statuses",{placement:l.Bottom,showArrow:false,showHeader:false,content:F}).addStyleClass('sapUserStatusPopOver');p.addStyleClass("sapContrastPlus");p.setOffsetX(-3);x=[new T({text:u}).addStyleClass('sapUshellMeAreaUserName')];var G=new U({id:"userStatusOpener",visible:{parts:["/userStatusEnabled","/userStatusUserEnabled"],formatter:function(i,v){if(i&&v){return true;}return false;}.bind(this)},status:{path:"/userStatus",formatter:function(i){return U.prototype.STATUS_ENUM[i];}.bind(this)},tooltip:t.getText("userStatus_tooltip"),image:e.getIconURI("account"),press:function(i){var v=sap.ui.getCore().byId(i.mParameters.id);if(p.isOpen()){p.close();}else{p.openBy(v);}}.bind(this),contentList:p}).addStyleClass('sapUserStatusOpener');G.addCustomData(new b({key:"tabindex",value:"0",writeToDom:true}));G.addCustomData(new b({key:"aria-label",value:r.i18n.getText("OnlineStatus")+" "+t.getText("userStatus_tooltip"),writeToDom:true}));G.addCustomData(new b({key:"role",value:"listbox",writeToDom:true}));var J=new L({items:[G],backgroundDesign:g.Transparent});x.push(J);if(!q.disableSignOut){var K;if(!w){K=new B("logoutBtn",{visible:{parts:["/userStatusEnabled","/userStatusUserEnabled"],formatter:function(i,v){if(i&&v){return false;}return true;}.bind(this)},type:h.Transparent,icon:'sap-icon://log',text:r.i18n.getText("signoutBtn_title"),press:[o.logout,o]});x.push(K);}else{K=new sap.ushell.ui.launchpad.ActionItem("logoutBtn",{visible:true,type:h.Transparent,icon:'sap-icon://log',text:r.i18n.getText("signoutBtn_title"),press:[o.logout,o]});}}var M=new V({items:[x]}).addStyleClass("sapUshellUserArea");var N=sap.ushell.Container.getUser(),Q=N.getImage(),R;if(!Q){R=this.createPlaceHolderIcon();}else{R=this.createNewImage();}R.addStyleClass("sapUshellMeAreaUserImage");var X=new H({items:[R,M]});N.attachOnSetImage(this._updateUserImage.bind({origScope:this,oUserHBox:X,userBoxItem:R}));X.addStyleClass('sapUshellMeAreaUserInfo');X.addStyleClass('sapContrastPlus');var Y=o.createSaveButton(),Z=o.createCancelButton();this.oSettingsDialog=new D({id:"userSettingsDialog",showHeader:false,content:null,contentHeight:"42rem",contentWidth:"58rem",buttons:[Y,Z],afterClose:function(){sap.ushell.Container.getUser().resetChangedProperties();},stretch:c.system.phone}).addStyleClass("sapUshellUserSetting");this.oSettingsDialog.addContent(o.getSettingsDialogContent());this.oSettingsDialog.addEventDelegate({onkeydown:function(i){if(i.keyCode===27){if(o&&typeof o._dialogCancelButtonHandler==="function"){o._dialogCancelButtonHandler();}}}.bind(this)});this.aDanglingControls.push(Z,Y,this.oSettingsDialog);X.addEventDelegate({onsapskipback:function(i){i.preventDefault();a.setIsFocusHandledByAnotherHandler(true);a.sendFocusBackToShell(i);},onsaptabprevious:function(i){i.preventDefault();a.setIsFocusHandledByAnotherHandler(true);a.sendFocusBackToShell(i);}});var $=new O({id:"overflowActions",design:n.Transparent,content:{path:"/currentState/actions",factory:function(i,v){var e1=sap.ui.getCore().byId(v.getObject());if(e1){var f1=e1.isA("sap.ushell.ui.shell.ShellHeadItem");if(f1){return undefined;}if(e1.setActionType){e1.setActionType("action");e1.addStyleClass('sapContrastPlus');}o._addPressHandlerToActions(e1);}return e1;}}});$._getOverflowButtonSize=function(){return 82.4;};$.addCustomData(new b({key:"aria-label",value:r.i18n.getText("overflowActions_AriaLabel"),writeToDom:true}));if($._getOverflowButton){var _=$._getOverflowButton();if(_){var a1=_.onAfterRendering;_.onAfterRendering=function(){if(a1){a1.apply(this,arguments);}this.addStyleClass('sapUshellActionItem').addStyleClass('sapContrastPlus');this.setText(r.i18n.getText('meAreaMoreActions'));};}}$.updateAggregation=function(e1){var f1=this.mBindingInfos[e1],g1=this.getMetadata().getJSONKeys()[e1],h1;jQuery.each(this[g1._sGetter](),jQuery.proxy(function(i,v){this[g1._sRemoveMutator](v);},this));jQuery.each(f1.binding.getContexts(),jQuery.proxy(function(i,v){h1=f1.factory(this.getId()+"-"+i,v)?f1.factory(this.getId()+"-"+i,v).setBindingContext(v,f1.model):"";this[g1._sMutator](h1);},this));};var b1=new V("sapUshellMeAreaContent",{});this.actionBox=$;b1.addItem(X);b1.addItem($);if(q.enableRecentActivity){var c1=sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().getProperty('/currentState/showRecentActivity');if(c1===true){var d1=this.createIconTabBar(o);d1.done(function(i){b1.addItem(i);var v=sap.ushell.Container.getRenderer("fiori2").oShellModel.getModel().getProperty("/enableTrackingActivity");i.setVisible(v);});}}this.actionBox.addEventDelegate({onsaptabnext:function(i){var v=i.originalEvent,e1=v.srcElement,f1=jQuery('.sapUshellActionItem:last')[0].id,g1,h1;h1=sap.ui.getCore().byId('meAreaIconTabBar').getVisible();g1=f1===e1.id;if(g1===true&&!h1){i.preventDefault();a.setIsFocusHandledByAnotherHandler(true);a.sendFocusBackToShell(i);}},onsapskipforward:function(i){var v=sap.ui.getCore().byId('meAreaIconTabBar').getVisible();if(!v){i.preventDefault();a.setIsFocusHandledByAnotherHandler(true);a.sendFocusBackToShell(i);}}});return new S({vertical:true,horizontal:false,height:"100%",content:b1});},createIconTabBar:function(o){var R=new jQuery.Deferred(),t=this,i,p,q;sap.ui.require(['sap/m/IconTabBar','sap/m/CustomListItem','sap/m/IconTabFilter','sap/m/Text','sap/m/HBox'],function(s,u,v,T,H){i=new s('meAreaIconTabBar',{backgroundDesign:g.Transparent,expandable:false,items:[t.createIconTab("recentActivities",true,o,u,v,T,H),t.createIconTab("frequentActivities",false,o,u,v,T,H)]}).addStyleClass('sapUshellMeAreaTabBar');i.addEventDelegate({onsaptabnext:function(E){var w=E.originalEvent,x=w.srcElement,y=x.classList,z;z=jQuery.inArray('sapUshellMeAreaActivityItem',y)>-1;if(z===true){E.preventDefault();a.setIsFocusHandledByAnotherHandler(true);a.sendFocusBackToShell(E);}},onsapskipforward:function(E){E.preventDefault();a.setIsFocusHandledByAnotherHandler(true);a.sendFocusBackToShell(E);}});p=i.onAfterRendering;i.onAfterRendering=function(){if(p){p.apply(t,arguments);}q=sap.ui.getCore().byId('meAreaIconTabBar--header');if(q){q.addStyleClass('sapContrastPlus');q.addStyleClass('sapUshellTabBarHeader');}};R.resolve(i);});return R.promise();},createIconTab:function(i,s,o,p,q,T,H){var t,u,v,w,x,y,z,M,E,F;t=function(G,J){u=J.getProperty("icon");v=J.getProperty("title");w=A.getDisplayName(J.getProperty("appType"));var K=new T({text:v}).addStyleClass('sapUshellMeAreaActivityItemTitle'),N=u?new d({src:u}).addStyleClass('sapUshellMeAreaActivityItemIcon'):null,Q=new T({text:w}).addStyleClass('sapUshellMeAreaActivityItemDescription'),R=new T({text:s?J.getProperty("timestamp"):""}).addStyleClass('sapUshellMeAreaActivityItemInfo'),X=new H({items:N?[N,Q]:[Q],justifyContent:"SpaceBetween"}),Y=new H({items:s?[X,R]:[X],justifyContent:"SpaceBetween"}).addStyleClass('sapUshellMeAreaActivityItemContainer');x=new p({content:[K,Y],type:k.Active}).addStyleClass('sapUshellMeAreaActivityItem');x.addCustomData(new b({key:"aria-describedby",value:y.getId(),writeToDom:true}));return x;};y=new q({id:"sapUshellIconTabBar"+i,text:r.i18n.getText(i)});z=new L({id:"sapUshellActivityList"+i,showSeparators:j.All,items:{path:"meAreaModel>/apps/"+i,factory:t.bind(this)},noDataText:r.i18n.getText(i+'NoDataText'),itemPress:function(G){M=this.getModel('meAreaModel');F=sap.ui.getCore().byId("viewPortContainer");if(F){F.switchState("Center");}E=G.getParameter('listItem').getBindingContextPath();o.setLastVisited(M.getProperty(E).url);setTimeout(function(){if(M.getProperty(E).url[0]==='#'){hasher.setHash(M.getProperty(E).url);}else{var J=C.last("/core/shell/enableRecentActivity")&&C.last("/core/shell/enableRecentActivityLogging");if(J){var R={title:M.getProperty(E).title,appType:A.APP,url:M.getProperty(E).url,appId:M.getProperty(E).url};sap.ushell.Container.getRenderer("fiori2").logRecentActivity(R);}W.openURL(M.getProperty(E).url,'_blank');}},200);}});y.addContent(z);return y;},onViewStateShow:function(){this.getController().refreshRecentActivities();this.getController().refreshFrequentActivities();if(this.actionBox){this.actionBox.updateAggregation("content");}this.getController().updateScrollBar(hasher.getHash());},createNewImage:function(){return new I({src:'{/userImage/personPlaceHolder}'});},createPlaceHolderIcon:function(){return new d({src:'{/userImage/personPlaceHolder}',size:'4rem'});},getControllerName:function(){return"sap.ushell.components.shell.MeArea.MeArea";},_updateUserImage:function(o){var u=(typeof o)==='string'?o:o.mParameters;this.oUserHBox.removeItem(this.userBoxItem);if((typeof u)==='string'){this.userBoxItem=this.origScope.createNewImage();}else{this.userBoxItem=this.origScope.createPlaceHolderIcon();}if(this.oUserHBox){this.oUserHBox.insertItem(this.userBoxItem,0);if(this.userBoxItem){this.userBoxItem.addStyleClass("sapUshellMeAreaUserImage");}}}});},false);
