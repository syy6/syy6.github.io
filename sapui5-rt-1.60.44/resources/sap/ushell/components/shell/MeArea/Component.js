// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/resources','sap/ui/core/UIComponent','sap/ushell/components/applicationIntegration/AppLifeCycle','sap/ushell/components/homepage/ComponentKeysHandler','sap/ushell/ui/footerbar/ContactSupportButton','sap/ushell/ui/footerbar/EndUserFeedback','sap/ushell/EventHub','sap/ushell/Config','./UserPreferences'],function(r,U,A,C,a,E,b,c,d){"use strict";var _;function f(){if(!_){_=sap.ushell.Container.getRenderer("fiori2");}return _;}function g(){return f().getShellConfig();}function h(){return A.getElementsModel().getModel();}var i;return U.extend("sap.ushell.components.shell.MeArea.Component",{metadata:{version:"1.60.40",library:"sap.ushell.components.shell.MeArea",dependencies:{libs:["sap.m","sap.ui.layout"]}},createContent:function(){this._bSearchPrefsLoaded=false;this._bIsMeAreaCreated=false;i=c.last("/core/extension/enableHelp");var m;var t=function(s){this.toggleMeAreaView(m,s);}.bind(this);m=sap.ui.getCore().byId("meAreaHeaderButton");m.applySettings({tooltip:sap.ushell.Container.getUser().getFullName(),icon:'{/userImage/personPlaceHolder}',selected:{path:"/currentViewPortState",formatter:function(v){if(v==='LeftCenter'){return true;}return false;}},press:function(){t(!this.getSelected());},visible:true,enabled:true,showSeparator:false,ariaLabel:"{i18n>MeAreaToggleButtonAria}"}).removeStyleClass("sapUshellPlaceHolders");m.addEventDelegate({onAfterRendering:function(){m.$().attr("aria-pressed",m.getSelected());},onsapskipforward:function(e){sap.ushell.renderers.fiori2.AccessKeysHandler.bForwardNavigation=true;e.preventDefault();jQuery("#sapUshellHeaderAccessibilityHelper").focus();},onsaptabprevious:function(e){var v=sap.ui.getCore().byId('viewPortContainer'),s=v.getCurrentState(),R;switch(s){case"LeftCenter":R=jQuery("#meAreaIconTabBar-content li:first");if(R.length>0){R[0].focus();}else{var j=c.last("/core/shell/enableRecentActivity");if(j&&h().getProperty("/enableTrackingActivity")){jQuery("#meAreaIconTabBar .sapMITBText")[0].focus();}else{e.preventDefault();jQuery('.sapUshellActionItem:last')[0].focus();}}break;case"Center":if(sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler()){e.preventDefault();sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;}break;default:}},onsapskipback:function(e){var v=sap.ui.getCore().byId('viewPortContainer'),s=v.getCurrentState(),n;switch(s){case"LeftCenter":e.preventDefault();n=jQuery("#meAreaIconTabBar .sapMITBSelected");if(n.length===0){n=jQuery(".sapUshellActionItem");}n[0].focus();break;case"Center":e.preventDefault();if(jQuery("#sapUshellFloatingContainerWrapper:visible").length==1&&(e.originalEvent.srcElement.id)!=""){sap.ui.getCore().getEventBus().publish("launchpad","shellFloatingContainerIsAccessible");}else if(sap.ushell.renderers.fiori2.AccessKeysHandler.getAppKeysHandler()){sap.ushell.renderers.fiori2.AccessKeysHandler.bFocusOnShell=false;}break;default:}}});A.getElementsModel().createInspection("actions",[{fnCondition:function(I,e,T){return true;},fnAction:function(I,e,T){if((I&&I.length>0)||(e&&e.length>0)){if(e.indexOf("meAreaHeaderButton")===-1){T.addHeaderItem(["meAreaHeaderButton"],true);}}else{T.removeHeaderItem(["meAreaHeaderButton"],true);}}}],false,["blank-home","blank"]);this._createMeArea();b.on('showMeArea').do(t);sap.ui.getCore().getEventBus().publish("shell","meAreaCompLoaded",{delay:0});},_createMeArea:function(){if(this._bIsMeAreaCreated===true){return;}this._bIsMeAreaCreated=true;var m=sap.ui.view("meArea",{viewName:"sap.ushell.components.shell.MeArea.MeArea",type:'JS',viewData:f().getComponentData(),async:true});m.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"role",value:"region",writeToDom:true}));m.addCustomData(new sap.ushell.ui.launchpad.AccessibilityCustomData({key:"aria-label",value:r.i18n.getText("MeAreaToggleButtonAria"),writeToDom:true}));this._createActionButtons();this._setUserPrefModel();sap.ui.getCore().getEventBus().publish("launchpad","Settings");m.loaded().then(function(v){f().addLeftViewPort(m);});f().ViewPortContainerAttachAfterSwitchStateAnimationFinished(function(D){if(D.getParameter("to")==="LeftCenter"&&!this._bSearchPrefsLoaded){this._getSearchPrefs();}}.bind(this));},toggleMeAreaView:function(m,s){if(!m||!m.getDomRef()){return;}if(m.getSelected()===!!s){return;}var e=h().getProperty('/currentState/stateName');var p={'embedded':true,'embedded-home':true,'standalone':true,'blank-home':true,'blank':true};this._createMeArea();if(p[e]===true){this._showActionsInPopOver(m);}else{this._switchToMeAreaView(m,s);}},_createActionButtons:function(){if(!sap.ui.getCore().byId("aboutBtn")){var o=new sap.ushell.ui.footerbar.AboutButton("aboutBtn");if(i){o.addStyleClass('help-id-aboutBtn');}f().addShellDanglingControl(o);}if(!sap.ui.getCore().byId("userSettingsBtn")&&!g().moveUserSettingsActionToShellHeader){var u=new sap.ushell.ui.launchpad.ActionItem("userSettingsBtn",{id:"userSettingsBtn",text:r.i18n.getText("userSettings"),icon:'sap-icon://action-settings'});if(i){u.addStyleClass('help-id-loginDetails');}f().addShellDanglingControl(u);}if(!g().moveContactSupportActionToShellHeader){c.on("/core/extension/SupportTicket").do(function(e){var j=sap.ui.getCore().byId("ContactSupportBtn");if(e&&!j){j=new a("ContactSupportBtn");f().addShellDanglingControl(j);if(i){j.addStyleClass('help-id-contactSupportBtn');}}j&&j.setVisible(e);});}h().setProperty('/showEndUserFeedback',false);function s(j,k){try{j.isEnabled().done(function(){h().setProperty('/showEndUserFeedback',true);var l=f().getEndUserFeedbackConfiguration();if(g().moveGiveFeedbackActionToShellHeader){jQuery.sap.measure.start("FLP:Shell.controller._createActionButtons","create give feedback as shell head end item","FLP");var t=sap.ui.getCore().byId("EndUserFeedbackHandlerBtn");t.setModel(h());t.setShowAnonymous(l.showAnonymous);t.setAnonymousByDefault(l.anonymousByDefault);t.setShowLegalAgreement(l.showLegalAgreement);t.setShowCustomUIContent(l.showCustomUIContent);t.setFeedbackDialogTitle(l.feedbackDialogTitle);t.setTextAreaPlaceholder(l.textAreaPlaceholder);t.setAggregation("customUIContent",l.customUIContent,false);k.attachPress(function(){t.firePress();});jQuery.sap.measure.end("FLP:Shell.controller._createActionButtons");}else if(!k){k=new E("EndUserFeedbackBtn",{showAnonymous:l.showAnonymous,anonymousByDefault:l.anonymousByDefault,showLegalAgreement:l.showLegalAgreement,showCustomUIContent:l.showCustomUIContent,feedbackDialogTitle:l.feedbackDialogTitle,textAreaPlaceholder:l.textAreaPlaceholder,customUIContent:l.customUIContent});if(i){k.addStyleClass('help-id-EndUserFeedbackBtn');}f().addShellDanglingControl(k);}k.setVisible(true);}).fail(function(){if(k){k.setVisible(false);}});}catch(e){jQuery.sap.log.error("EndUserFeedback adapter is not found",e.message||e);}}c.on("/core/extension/EndUserFeedback").do(function(e){var j=sap.ui.getCore().byId("EndUserFeedbackBtn");if(e){sap.ushell.Container.getServiceAsync("EndUserFeedback").then(function(k){s(k,j);});}else if(j){h().setProperty('/showEndUserFeedback',false);j.setVisible(false);}});},_setUserPrefModel:function(){d.setModel();},_showActionsInPopOver:function(o){var e=h().getProperty('/currentState/actions');if(!this.oActionsPopover){this.oActionsLayout=new sap.ui.layout.VerticalLayout();this.oActionsPopover=new sap.m.Popover("sapUshellActionsPopover",{showHeader:false,placement:sap.m.PlacementType.Bottom,content:this.oActionsLayout}).addStyleClass("sapUshellPopupContainer");}this.oActionsLayout.removeAllContent();this._createActionButtons();e.forEach(function(s,I){var j=sap.ui.getCore().byId(s);if(j&&j.setActionType){this.oActionsLayout.addContent(j);j.setActionType('standard');j.addStyleClass('sapUshellStandardActionItem');}}.bind(this));this.oActionsPopover.setModel(h());this.oActionsPopover.openBy(o);},_switchToMeAreaView:function(o,s){f().switchViewPortStateByControl(o,s?"LeftCenter":"Center");f().toggleOverFlowActions();},_getSearchPrefs:function(){function e(){var m=h();try{var j=m.getProperty("/currentState/stateName");return A.getElementsModel().getBaseStateMember(j,"headEndItems").indexOf("sf")!=-1;}catch(k){jQuery.sap.log.debug("Shell controller._createWaitForRendererCreatedPromise: search button is not visible.");return false;}}if(e()){sap.ui.require(['sap/ushell/renderers/fiori2/search/userpref/SearchPrefs','sap/ushell/renderers/fiori2/search/SearchShellHelperAndModuleLoader'],function(S){this._bSearchPrefsLoaded=true;var s=S.getEntry();s.isSearchPrefsActive().done(function(j){if(j){f().addUserProfilingEntry(s);}}.bind(this));}.bind(this));}},exit:function(){}});});
