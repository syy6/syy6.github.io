// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/Device","sap/ushell/utils","sap/ushell/library","sap/m/MessagePopover","sap/ui/core/Component","sap/ui/core/ComponentContainer","sap/ui/core/Control","sap/ui/thirdparty/URI","sap/ushell/EventHub"],function(D,u,a,M,C,b,c,U,E){"use strict";var p="sap.ushell.components.container.",s=p+"ApplicationContainer",d="sap.ushell.Container.dirtyState.",l,S={"sap.ushell.services.CrossApplicationNavigation":{isTrustedPostMessageSourceFn:function(){return true;},oServiceCalls:{"hrefForExternal":{executeServiceCallFn:function(e){return new jQuery.Deferred().resolve(sap.ushell.Container.getService("CrossApplicationNavigation").hrefForExternal(e.oMessageData.body.oArgs)).promise();}},"getSemanticObjectLinks":{executeServiceCallFn:function(e){return sap.ushell.Container.getService("CrossApplicationNavigation").getSemanticObjectLinks(e.oMessageData.body.sSemanticObject,e.oMessageData.body.mParameters,e.oMessageData.body.bIgnoreFormFactors,undefined,undefined,e.oMessageData.body.bCompactIntents);}},"isIntentSupported":{executeServiceCallFn:function(e){return sap.ushell.Container.getService("CrossApplicationNavigation").isIntentSupported(e.oMessageData.body.aIntents);}},"isNavigationSupported":{executeServiceCallFn:function(e){return sap.ushell.Container.getService("CrossApplicationNavigation").isNavigationSupported(e.oMessageData.body.aIntents);}},"backToPreviousApp":{executeServiceCallFn:function(e){sap.ushell.Container.getService("CrossApplicationNavigation").backToPreviousApp();return new jQuery.Deferred().resolve().promise();}},"historyBack":{executeServiceCallFn:function(e){sap.ushell.Container.getService("CrossApplicationNavigation").historyBack(e.oMessageData.body.iSteps);return new jQuery.Deferred().resolve().promise();}},"getAppStateData":{executeServiceCallFn:function(e){return sap.ushell.Container.getService("CrossApplicationNavigation").getAppStateData(e.oMessageData.body.sAppStateKey);}},"toExternal":{executeServiceCallFn:function(e){var P=u.clone(e.oMessageData.body.oArgs);var Q=(P||{}).params;var R=Q&&Q.hasOwnProperty("sap-system");if(R){if(u.isPlainObject(Q["sap-system"])){var T=Q["sap-system"];var V=Q["sap-system-src"];var W=typeof V==="string";if(!W){e.storeSapSystemData(T);}else{e.storeSapSystemData(T,V);Q["sap-system-src"]=V;}Q["sap-system"]=T.id;}else if(e.matchesLocalSid(Q["sap-system"])){delete Q["sap-system"];}}return new jQuery.Deferred().resolve(sap.ushell.Container.getService("CrossApplicationNavigation").toExternal(P)).promise();}},"registerBeforeAppCloseEvent":{executeServiceCallFn:function(e){e.oContainer.setProperty("beforeAppCloseEvent",{enabled:true,params:e.oMessageData.body},true);return new jQuery.Deferred().resolve().promise();}}}},"sap.ushell.CrossApplicationNavigation":{isTrustedPostMessageSourceFn:function(){return true;},oServiceCalls:{"backToPreviousApp":{executeServiceCallFn:function(e){sap.ushell.Container.getService("CrossApplicationNavigation").backToPreviousApp();return new jQuery.Deferred().resolve().promise();}}}},"sap.ushell.ui5service.ShellUIService":{isTrustedPostMessageSourceFn:function(){return true;},oServiceCalls:{"setTitle":{executeServiceCallFn:function(e){return new jQuery.Deferred().resolve(e.oContainer.getShellUIService().setTitle(e.oMessageData.body.sTitle)).promise();}},"setBackNavigation":{executeServiceCallFn:function(e){return e.executeSetBackNavigationService(e.oMessage,e.oMessageData);}}}},"sap.ushell.services.Container":{isTrustedPostMessageSourceFn:function(){return true;},oServiceCalls:{"setDirtyFlag":{executeServiceCallFn:function(e){sap.ushell.Container.setDirtyFlag(e.oMessageData.body.bIsDirty);return new jQuery.Deferred().resolve().promise();}},"getFLPUrl":{executeServiceCallFn:function(e){return new jQuery.Deferred().resolve(sap.ushell.Container.getFLPUrl()).promise();}}}}},r;function f(T){var e=sap.ushell.Container.getService("CrossApplicationNavigation");e.isUrlSupported(T.url).done(function(){T.promise.resolve({"allowed":true,"id":T.id});}).fail(function(){T.promise.resolve({"allowed":false,"id":T.id});});}function i(){var e={"asyncURLHandler":O.prototype._adaptIsUrlSupportedResultForMessagePopover};if(M&&M.setDefaultHandlers){M.setDefaultHandlers(e);}}E.once("RendererExtensionPluginsLoaded").do(i);l=new u.Map();function g(e){return l.get(e.getId());}function h(e){var P=S[e.sService];if(P){Object.keys(e.oServiceCalls).forEach(function(R){P.oServiceCalls[R]=e.oServiceCalls[R];});return;}var Q={isTrustedPostMessageSourceFn:function(){return true;},oServiceCalls:{}};if(e.isTrustedPostMessageSourceFn){Q.isTrustedPostMessageSourceFn=e.isTrustedPostMessageSourceFn;}Object.keys(e.oServiceCalls).forEach(function(R){Q.oServiceCalls[R]=e.oServiceCalls[R];});S[e.sService]=Q;}function j(){return S;}function k(e){var P=jQuery.sap.getUriParameters(e).mParams,Q=P["sap-xapp-state"],R;delete P["sap-xapp-state"];R={startupParameters:P};if(Q){R["sap-xapp-state"]=Q;}return R;}function m(e,P){if(!r){r=jQuery.sap.resources({url:jQuery.sap.getModulePath(p)+"/resources/resources.properties",language:sap.ui.getCore().getConfiguration().getLanguage()});}return r.getText(e,P);}function n(){return new sap.ui.core.Icon({size:"2rem",src:"sap-icon://error",tooltip:O.prototype._getTranslatedText("an_error_has_occured")});}function o(e){var P=e.getAggregation("child"),Q;if(P instanceof b){Q=P.getComponentInstance().getMetadata().getName().replace(/\.Component$/,"");jQuery.sap.log.debug("unloading component "+Q,null,s);}e.destroyAggregation("child");}function q(e,P,Q){var R,T,V,W,X,Y,Z,$={},_,a1;V=P.indexOf("?");if(V>=0){Y=O.prototype._getParameterMap(P);$=Y.startupParameters;P=P.slice(0,V);}if(P.slice(-1)!=='/'){P+='/';}if(/\.view\.(\w+)$/i.test(Q)){X=/^SAPUI5=(?:([^\/]+)\/)?([^\/]+)\.view\.(\w+)$/i.exec(Q);if(!X){jQuery.sap.log.error("Invalid SAPUI5 URL",Q,s);return O.prototype._createErrorControl();}Z=X[1];_=X[2];a1=X[3].toUpperCase();if(Z){_=Z+"."+_;}else{W=_.lastIndexOf(".");if(W<1){jQuery.sap.log.error("Missing namespace",Q,s);return O.prototype._createErrorControl();}Z=_.slice(0,W);}}else{Z=Q.replace(/^SAPUI5=/,"");}jQuery.sap.registerModulePath(Z,P+Z.replace(/\./g,'/'));O.prototype._destroyChild(e);if(_){if(e.getApplicationConfiguration()){$.config=e.getApplicationConfiguration();}T=sap.ui.view({id:e.getId()+"-content",type:a1,viewData:$||{},viewName:_});e.fireEvent("applicationConfiguration");}else{jQuery.sap.log.debug("loading component "+Z,null,s);var b1=Y?{startupParameters:Y.startupParameters}:{startupParameters:{}};if(Y&&Y["sap-xapp-state"]){b1["sap-xapp-state"]=Y["sap-xapp-state"];}if(e.getApplicationConfiguration()){b1.config=e.getApplicationConfiguration();}R=sap.ui.component({id:e.getId()+"-component",componentData:b1,name:Z});e.fireEvent("applicationConfiguration",{"configuration":R.getMetadata().getConfig()});T=new b({id:e.getId()+"-content",component:R});}T.setWidth(e.getWidth());T.setHeight(e.getHeight());T.addStyleClass("sapUShellApplicationContainer");e.setAggregation("child",T,true);return T;}function t(e,P){setTimeout(function(){sap.ui.getCore().getEventBus().publish("sap.ushell",e,P);},0);}function v(e,P,Q){var R,T,V,W,X={startupParameters:{}},Y,Z=e.getComponentHandle(),$=sap.ushell.Container.getService("PluginManager"),_,a1;u.addTime("createUi5Component");R=P.indexOf("?");if(R>=0){W=O.prototype._getParameterMap(P);X={startupParameters:W.startupParameters};if(W["sap-xapp-state"]){X["sap-xapp-state"]=W["sap-xapp-state"];}P=P.slice(0,R);}if(e.getApplicationConfiguration()){X.config=e.getApplicationConfiguration();}if(P.slice(-1)!=='/'){P+='/';}O.prototype._destroyChild(e);Y={id:e.getId()+"-component",name:Q,componentData:X};jQuery.sap.log.debug("Creating component instance for "+Q,JSON.stringify(Y),s);sap.ui.getCore().getEventBus().publish("sap.ushell.components.container.ApplicationContainer","_prior.newUI5ComponentInstantion",{name:Q});if(Z){T=Z.getInstance(Y);}else{jQuery.sap.registerModulePath(Q,P);jQuery.sap.log.error("No component handle available for '"+Q+"'; fallback to component.load()",null,s);T=sap.ui.component({id:e.getId()+"-component",name:Q,componentData:X});}e.fireEvent("applicationConfiguration",{"configuration":T.getMetadata().getConfig()});V=new b({id:e.getId()+"-content",component:T});V.setHeight(e.getHeight());V.setWidth(e.getWidth());V.addStyleClass("sapUShellApplicationContainer");e._disableRouterEventHandler=O.prototype._disableRouter.bind(this,T);sap.ui.getCore().getEventBus().subscribe("sap.ushell.components.container.ApplicationContainer","_prior.newUI5ComponentInstantion",e._disableRouterEventHandler);e.setAggregation("child",V,true);if($){_=$.getPluginLoadingPromise("RendererExtensions");a1=_&&_.state();if(a1==="pending"){_.done(function(){O.prototype._publishExternalEvent("appComponentLoaded",{component:T});}).fail(function(){O.prototype._publishExternalEvent("appComponentLoaded",{component:T});});}if(a1==="resolved"||a1==="rejected"){O.prototype._publishExternalEvent("appComponentLoaded",{component:T});}}O.prototype._publishExternalEvent("appComponentLoaded",{component:T});return V;}function w(e){var P;if((e instanceof C)&&(typeof e.getRouter==="function")){P=e.getRouter();if(P&&(typeof P.stop==="function")){jQuery.sap.log.info("router stopped for instance "+e.getId());P.stop();}}}function x(e){var P=document.createElement("a"),Q=jQuery.sap.getUriParameters(e).get("sap-client"),R;P.href=e;R=P.protocol+"//"+P.host;return new sap.ushell.System({alias:Q?R+"?sap-client="+Q:R,baseUrl:R,client:Q||undefined,platform:"abap"});}function y(e,P){var T=false,Q=e.getDomRef(),R=e.getApplicationType(),V,W;if(Q){if(u.isApplicationTypeEmbeddedInIframe(R)){V=U(Q.src||window.location&&window.location.href||'');W=V.protocol()+"://"+V.host();T=(P.source===Q.contentWindow)||(P.origin===W);}else if(R===sap.ushell.components.container.ApplicationType.URL){V=U();W=V.protocol()+"://"+V.host();T=(P.origin===W);}}return T;}function z(e,P,Q){var R=JSON.stringify({type:"request",service:P,request_id:jQuery.sap.uid(),body:{}});jQuery.sap.log.debug("Sending post message request to origin ' "+Q+"': "+R,null,"sap.ushell.components.container.ApplicationContainer");e.postMessage(R,Q);}function A(){var e=this.getDomRef();if(!e||e.tagName!=="IFRAME"){return null;}return e;}function B(P,Q,R){var T=jQuery.sap.getObject("sap-ushell-config.services.PostMessage.config",0),V=R&&R.service,W,X,Y,Z,$=false;jQuery.sap.log.debug("Received post message request from origin '"+Q.origin+"': "+JSON.stringify(R),null,"sap.ushell.components.container.ApplicationContainer");if(R.type!=="request"||!V){return;}for(var _ in S){if(S.hasOwnProperty(_)){if(V.indexOf(_)!==-1){X=S[_];Y=_;$=true;break;}}}if($===false){return;}W=V.split(".")[3];if(T&&T.enabled===false){jQuery.sap.log.warning("Received message for "+W+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,"sap.ushell.components.container.ApplicationContainer");return;}if(!O.prototype._isTrustedPostMessageSource(P,Q)||!X.isTrustedPostMessageSourceFn(P,Q)){jQuery.sap.log.warning("Received message from untrusted origin '"+Q.origin+"': "+JSON.stringify(Q.data),null,"sap.ushell.components.container.ApplicationContainer");return;}function a1(e,h1){var i1=JSON.stringify({type:"response",service:R.service,request_id:R.request_id,status:e,body:h1});jQuery.sap.log.debug("Sending post message response to origin ' "+Q.origin+"': "+i1,null,"sap.ushell.components.container.ApplicationContainer");if(typeof Q.source!=="object"||Q.source===null){jQuery.sap.log.debug("Cannot send response message to origin ' "+Q.origin,"`source` member of request message is not an object","sap.ushell.components.container.ApplicationContainer");return;}Q.source.postMessage(i1,Q.origin);}function b1(Q,R){var e=new jQuery.Deferred(),h1;if(R.body&&R.body.callbackMessage&&R.body.callbackMessage.service){h1=O.prototype._backButtonPressedCallback.bind(null,Q.source,R.body.callbackMessage.service,Q.origin);}e.resolve(P.getShellUIService().setBackNavigation(h1));return e.promise();}function c1(h1,i1){var j1,k1,l1,m1=[h1.id];if(arguments.length>1){m1.unshift(i1);}try{l1=JSON.stringify(h1);}catch(e){jQuery.sap.log.error("Cannot stringify and store expanded system data: "+e);}if(l1){k1=u.getLocalStorage();j1=u.generateLocalStorageKey("sap-system-data",m1);k1.setItem(j1,l1);}}function d1(){var e=sap.ushell.Container.getLogonSystem();var h1=e.getName();var i1=e.getClient();return"sid("+h1+"."+i1+")";}function e1(e){return d1().toLowerCase()===e.toLowerCase();}var f1={matchesLocalSid:e1,getLocalSystemInSidForma:d1,storeSapSystemData:c1,executeSetBackNavigationService:b1,sendResponseMessage:a1,oMessage:Q,oMessageData:R,oContainer:P,oAppIsolationService:P.getAppIsolationService()};try{Z=X.oServiceCalls[R.service.replace(Y+".","")];if(Z&&Z.executeServiceCallFn){Z.executeServiceCallFn(f1).done(function(e){a1("success",{result:e});}).fail(function(e){a1("error",{message:e});});}else{a1("error",{message:"Unknown service name: '"+R.service+"'"});}}catch(g1){a1("error",{message:g1.message});}}function F(P,Q){var R=P.getUi5ComponentName&&P.getUi5ComponentName(),T=Q.data;if(typeof T==="string"){try{T=JSON.parse(Q.data);}catch(e){jQuery.sap.log.debug("Message received from origin '"+Q.origin+"' cannot be parsed: "+e,T,"sap.ushell.components.container.ApplicationContainer");return;}}if(typeof R==="string"&&P.getIsolated()!==true){jQuery.sap.log.debug("Skipping handling of postMessage 'message' event with data '"+JSON.stringify(T)+"' on container of UI5 application '"+R+"'","Only non UI5 application containers can handle 'message' postMessage event","sap.ushell.components.container.ApplicationContainer");return;}if(!P.getActive()){jQuery.sap.log.debug("Skipping handling of postMessage 'message' event with data '"+JSON.stringify(T)+"' on inactive container '"+P.getId()+"'","Only active containers can handle 'message' postMessage event","sap.ushell.components.container.ApplicationContainer");return;}if(T.action==="pro54_setGlobalDirty"&&localStorage.getItem(P.globalDirtyStorageKey)===sap.ushell.Container.DirtyState.PENDING){if(!O.prototype._isTrustedPostMessageSource(P,Q)){jQuery.sap.log.warning("Received message from untrusted origin: "+Q.origin,T,"sap.ushell.components.container.ApplicationContainer");return;}jQuery.sap.log.debug("getGlobalDirty() pro54_setGlobalDirty SetItem key:"+P.globalDirtyStorageKey+" value: "+T.parameters.globalDirty,null,"sap.ushell.components.container.ApplicationContainer");u.localStorageSetItem(P.globalDirtyStorageKey,T.parameters.globalDirty,true);}else{O.prototype._handleServiceMessageEvent(P,Q,T);}}function G(e,P){var Q=e._getIFrame(),R=e.getApplicationType();if(u.isApplicationTypeEmbeddedInIframe(e.getApplicationType(R))&&Q){Q.contentWindow.postMessage(JSON.stringify({action:"pro54_disableDirtyHandler"}),"*");P.preventDefault();}}function H(R,e,P){R.write("<div").writeControlData(e).writeAccessibilityState(e).addClass("sapUShellApplicationContainer").writeClasses(e).addStyle("height",e.getHeight()).addStyle("width",e.getWidth()).writeStyles().write(">").renderControl(P);R.write("</div>");}function I(P,Q){var R=Q==="TR"?"":"-NWBC";var V,T=function(){var V,W;try{V=sap.ui.getVersionInfo().version;}catch(e){jQuery.sap.log.error("sap ui version could not be determined, using sap.ui.version (core version) as fallback "+e);V=window.sap&&sap.ui&&sap.ui.version;}W=/\d+\.\d+\.\d+/.exec(V);if(W&&W[0]){V=W[0];}else{V=undefined;}return V;};V=T();if(V){P+=P.indexOf("?")>=0?"&":"?";P+="sap-shell="+encodeURIComponent("FLP"+V+R);}return P;}function J(e,P,T,R){var Q,V=function(){var Y=u.getParameterValueBoolean("sap-accessibility");if(Y!==undefined){return Y;}return sap.ushell.Container.getUser().getAccessibilityMode();},W=function(){var Y=jQuery.sap.getUriParameters(e)||{mParams:{}};if(Y.mParams["sap-theme"]===undefined){return sap.ushell.Container.getUser().getTheme(sap.ushell.User.prototype.constants.themeFormat.NWBC);}return undefined;},X=function(){var Y=false,Z=jQuery.sap.getUriParameters(e)||{mParams:{}};Y=sap.ui.getCore().getConfiguration().getStatistics()&&!Z.mParams.hasOwnProperty("sap-statistics");return Y;};e+=e.indexOf("?")>=0?"&":"?";e+="sap-ie=edge";Q=W();if(Q){e+=e.indexOf("?")>=0?"&":"?";e+="sap-theme="+encodeURIComponent(Q);}if(T){e+=e.indexOf("?")>=0?"&":"?";e+="sap-target-navmode="+encodeURIComponent(T);}if(V()){e+=e.indexOf("?")>=0?"&":"?";e+="sap-accessibility=X";}if(X()){e+=e.indexOf("?")>=0?"&":"?";e+="sap-statistics=true";}if(R){e+=e.indexOf("?")>=0?"&":"?";e+="sap-keepclientsession=1";}return I(e,P);}function K(R,e,P,Q){var T=e.getAggregation("child");if(!T||e._bRecreateChild){T=O.prototype._createUi5Component(e,P,Q);e._bRecreateChild=false;}O.prototype._renderControlInDiv(R,e,T);}function L(e,P,V){var Q=e.getProperty(P);if(jQuery.sap.equal(Q,V)){return;}e.setProperty(P,V);e._bRecreateChild=true;}function N(R,e,P,Q,T){var V;localStorage.removeItem(e.globalDirtyStorageKey);if(T&&T.indexOf("SAPUI5.Component=")===0&&P===sap.ushell.components.container.ApplicationType.URL&&!!!e.getIsolated()){K(R,e,Q,T.replace(/^SAPUI5\.Component=/,""));return;}if(T&&T.indexOf("SAPUI5=")===0&&P===sap.ushell.components.container.ApplicationType.URL&&!!!e.getIsolated()){O.prototype._renderControlInDiv(R,e,O.prototype._createUi5View(e,Q,T));return;}jQuery.sap.log.debug("Not resolved as \"SAPUI5.Component=\" or \"SAPUI5=\" , "+"will attempt to load into iframe "+T);if(!e.getActive()){jQuery.sap.log.debug("Skipping rendering container iframe","Container '"+e.getId()+"' is inactive");return;}try{if(!!!e.getIsolated()){Q=e.getFrameSource(P,Q,T);}else{Q=e.getIframeUrl();}}catch(W){jQuery.sap.log.error(W.message||W,null,s);e.fireEvent("applicationConfiguration");R.renderControl(O.prototype._createErrorControl());return;}if(sap.ushell.Container){V=O.prototype._getLogoutHandler(e);if(!V){if(u.isApplicationTypeEmbeddedInIframe(P)){V=O.prototype._logout.bind(null,e);l.put(e.getId(),V);sap.ushell.Container.attachLogoutEvent(V);sap.ushell.Container.addRemoteSystem(O.prototype._createSystemForUrl(Q));}}else if(!u.isApplicationTypeEmbeddedInIframe(P)){sap.ushell.Container.detachLogoutEvent(V);l.remove(e.getId());}}if(u.isApplicationTypeEmbeddedInIframe(P)||!!e.getIsolated()){var X=(!!e.getIsolated()?"inplace":e.getTargetNavigationMode());if(!!!e.getIsolated()){Q=O.prototype._adjustNwbcUrl(Q,P,X,e.getIsStateful());}u.localStorageSetItem(e.globalDirtyStorageKey,sap.ushell.Container.DirtyState.INITIAL);}e.fireEvent("applicationConfiguration");R.write("<iframe").writeControlData(e).writeAccessibilityState(e).writeAttributeEscaped("src",Q).addClass("sapUShellApplicationContainer").writeClasses(e).addStyle("height",e.getHeight()).addStyle("width",e.getWidth()).writeStyles().write("></iframe>");}var O=c.extend(s,{metadata:{properties:{additionalInformation:{defaultValue:"",type:"string"},application:{type:"object"},applicationConfiguration:{type:"object"},applicationType:{defaultValue:"URL",type:p+"ApplicationType"},height:{defaultValue:"100%",type:"sap.ui.core.CSSSize"},navigationMode:{defaultValue:"",type:"string"},targetNavigationMode:{defaultValue:"",type:"string"},text:{defaultValue:"",type:"string"},url:{defaultValue:"",type:"string"},visible:{defaultValue:true,type:"boolean"},active:{defaultValue:true,type:"boolean"},"sap-system":{defaultValue:undefined,type:"string"},applicationDependencies:{type:"object"},componentHandle:{type:"object"},ui5ComponentName:{type:"string"},width:{defaultValue:"100%",type:"sap.ui.core.CSSSize"},shellUIService:{type:"object"},appIsolationService:{type:"object"},reservedParameters:{type:"object"},coreResourcesFullyLoaded:{type:"boolean"},isStateful:{defaultValue:false,type:"boolean"},isolated:{defaultValue:false,type:"boolean"},iframeUrl:{defaultValue:"",type:"string"},appLifeCycle:{type:"object"},iframeHandlers:{defaultValue:"",type:"string"},beforeAppCloseEvent:{type:"object"}},events:{"applicationConfiguration":{}},aggregations:{child:{multiple:false,type:"sap.ui.core.Control",visibility:"hidden"}},library:"sap.ushell",designtime:"sap/ushell/designtime/ApplicationContainer.designtime"},exit:function(){var e,P=this;if(sap.ushell.Container){e=O.prototype._getLogoutHandler(P);if(e){sap.ushell.Container.detachLogoutEvent(e);l.remove(P.getId());}}localStorage.removeItem(P.globalDirtyStorageKey);if(P._unloadEventListener){removeEventListener("unload",P._unloadEventListener);}if(P._disableRouterEventHandler){sap.ui.getCore().getEventBus().unsubscribe("sap.ushell.components.container.ApplicationContainer","_prior.newUI5ComponentInstantion",P._disableRouterEventHandler);}if(P._storageEventListener){removeEventListener("storage",P._storageEventListener);}if(P._messageEventListener){removeEventListener("message",P._messageEventListener);}O.prototype._destroyChild(P);if(c.exit){c.exit.apply(P);}},init:function(){var e=this;e.globalDirtyStorageKey=d+jQuery.sap.uid();e._unloadEventListener=e.exit.bind(e);addEventListener("unload",e._unloadEventListener);e._storageEventListener=function(P){var Q=e.getApplicationType();if(P.key===e.globalDirtyStorageKey&&P.newValue===sap.ushell.Container.DirtyState.PENDING&&u.isApplicationTypeEmbeddedInIframe(Q)){var R=e._getIFrame();if(R){jQuery.sap.log.debug("getGlobalDirty() send pro54_getGlobalDirty ",null,"sap.ushell.components.container.ApplicationContainer");R.contentWindow.postMessage(JSON.stringify({action:"pro54_getGlobalDirty"}),'*');}}};addEventListener('storage',e._storageEventListener);e._messageEventListener=O.prototype._handleMessageEvent.bind(null,e);addEventListener('message',e._messageEventListener);},onAfterRendering:function(e){if(this.getIsStateful()){this.rerender=function(){};}if(D.os.ios&&this.$().prop("tagName")==="IFRAME"){this.$().parent().css("overflow","auto");}},renderer:function(R,e){var P=e.getApplication(),Q=e.launchpadData,T;if(!e.getVisible()){O.prototype._renderControlInDiv(R,e);return;}if(e.error){delete e.error;O.prototype._renderControlInDiv(R,e,O.prototype._createErrorControl());}else if(!P){O.prototype._render(R,e,e.getApplicationType(),e.getUrl(),e.getAdditionalInformation());}else if(!P.isResolvable()){O.prototype._render(R,e,P.getType(),P.getUrl(),"");}else if(Q){O.prototype._render(R,e,Q.applicationType,Q.Absolute.url.replace(/\?$/,""),Q.applicationData);}else{jQuery.sap.log.debug("Resolving "+P.getUrl(),null,s);P.resolve(function(V){jQuery.sap.log.debug("Resolved "+P.getUrl(),JSON.stringify(V),s);e.launchpadData=V;O.prototype._destroyChild(e);},function(V){var W=P.getMenu().getDefaultErrorHandler();if(W){W(V);}O.prototype._destroyChild(e);e.error=V;});T=new sap.m.Text({text:O.prototype._getTranslatedText("loading",[P.getText()])});O.prototype._destroyChild(e);e.setAggregation("child",T);O.prototype._renderControlInDiv(R,e,T);}}});O.prototype.getFrameSource=function(e,P,Q){if(!Object.prototype.hasOwnProperty.call(sap.ushell.components.container.ApplicationType,e)){throw new Error("Illegal application type: "+e);}return P;};O.prototype.setUrl=function(V){L(this,"url",V);};O.prototype.setAdditionalInformation=function(V){L(this,"additionalInformation",V);};O.prototype.setApplicationType=function(V){L(this,"applicationType",V);};O.prototype.createPostMessageRequest=function(e,P){var R=Date.now().toString();return{"type":"request","request_id":R,"service":e,"body":P};};O.prototype.registerShellCommunicationHandler=function(e){var P=this;if(Array.isArray(e)){e.forEach(function(Q){P._addShellCommunicationHandler(Q);});}else{this._addShellCommunicationHandler(e);}};O.prototype.setNewTRApplicationContext=function(e){var P=this._getIFrame();if(!P){return Promise.reject({message:"Expected an exisiting TR application application frame but found none."});}e=I(e);var R=this.createPostMessageRequest("sap.its.startService",{"url":e});return this.postMessageToIframe(R,P,true).catch(function(Q){return Promise.reject({eventData:Q,message:"Failed to change application context."});});};O.prototype.postMessageToIframe=function(P,Q,W){var R=this;var T=P.request_id;return new Promise(function(V,X){function Y($){var _;try{_=JSON.parse($.data);if(T!==_.request_id){return;}if("success"===_.status){V(_);}else{X(_);}window.removeEventListener("message",Y);}catch(e){V();jQuery.sap.log.warning("Obtained bad response from framework in response to message "+P.request_id);jQuery.sap.log.debug("Underlying framework returned invalid response data: '"+$.data+"'");}}var Z=JSON.stringify(P);jQuery.sap.log.debug("Sending postMessage "+Z+" to application container '"+R.getId()+"'");if(W){window.addEventListener("message",Y,false);Q.contentWindow.postMessage(Z,"*");}else{Q.contentWindow.postMessage(Z,"*");V();}});};O.prototype.setNewApplicationContext=function(e,P){var Q=this;var R=this["setNew"+e+"ApplicationContext"];if(!R){return Promise.reject({message:"Unsupported application type"});}var T=this._getIFrame();if(!T){return Promise.reject({message:"Expected an exisiting TR application application frame but found none."});}var V=this.createPostMessageRequest("sap.gui.triggerCloseSessionImmediately",{});return this.postMessageToIframe(V,T,true).then(function(){return R.call(Q,P);},function(W){return Promise.reject({eventData:W,message:"Failed to change application context."});});};O.prototype.onApplicationOpened=function(e){var P=this.getIsStateful();if(!P){return Promise.resolve();}var Q=this.getApplicationType();if(Q==="TR"&&e!=="TR"){var R=this._getIFrame();if(!R){return Promise.reject({message:"Expected an exisiting TR application application frame but found none."});}var T=this.createPostMessageRequest("sap.gui.triggerCloseSession",{});return this.postMessageToIframe(T,R,false).catch(function(V){return Promise.reject({eventData:V,message:"Failed to change application context."});});}return Promise.resolve();};O.prototype.postMessageRequest=function(e){var P=this._getIFrame();if(!P){return Promise.reject({message:"Expected an exisiting TR application application frame but found none."});}var R=this.createPostMessageRequest(e,{});return this.postMessageToIframe(R,P,false).catch(function(Q){return Promise.reject({eventData:Q,message:"Failed to post message."});});};O.prototype.sendBeforeAppCloseEvent=function(){var e=this.getBeforeAppCloseEvent&&this.getBeforeAppCloseEvent(),R;if(e&&e.enabled&&e.enabled===true){R=this.createPostMessageRequest("sap.ushell.services.CrossApplicationNavigation.beforeAppCloseEvent",e.params);return this.postMessageToIframe(R,this._getIFrame(),true);}else{return undefined;}};O.prototype._addShellCommunicationHandler=h;O.prototype._getCommunicationHandlers=j;O.prototype._adaptIsUrlSupportedResultForMessagePopover=f;O.prototype._getLogoutHandler=g;O.prototype._getParameterMap=k;O.prototype._getTranslatedText=m;O.prototype._createErrorControl=n;O.prototype._destroyChild=o;O.prototype._createUi5View=q;O.prototype._publishExternalEvent=t;O.prototype._createUi5Component=v;O.prototype._disableRouter=w;O.prototype._createSystemForUrl=x;O.prototype._isTrustedPostMessageSource=y;O.prototype._handleServiceMessageEvent=B;O.prototype._handleMessageEvent=F;O.prototype._logout=G;O.prototype._renderControlInDiv=H;O.prototype._adjustNwbcUrl=J;O.prototype._render=N;O.prototype._backButtonPressedCallback=z;O.prototype._getIFrame=A;return O;},true);
