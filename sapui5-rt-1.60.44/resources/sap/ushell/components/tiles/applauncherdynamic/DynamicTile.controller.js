// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/datajs","sap/ui/thirdparty/URI","sap/ushell/components/tiles/utils","sap/ushell/components/tiles/utilsRT","sap/ushell/components/applicationIntegration/AppLifeCycle","sap/ushell/Config","sap/m/GenericTileMode","sap/ushell/utils/WindowUtils"],function(O,U,u,a,A,C,G,W){"use strict";sap.ui.getCore().loadLibrary("sap.m");sap.ui.controller("sap.ushell.components.tiles.applauncherdynamic.DynamicTile",{timer:null,_aDoableObject:{},oDataRequest:null,sConfigNavigationTargetUrlOld:"",REFRESH_INTERVAL_MIN:10,constructTargetUrlWithSapSystem:function(n,s){var o,h;if(s){o=sap.ushell.Container.getService("URLParsing");if(o.isIntentUrl(n)){h=o.parseShellHash(n);if(!h.params){h.params={};}h.params["sap-system"]=s;n="#"+o.constructShellHash(h);}else{n+=((n.indexOf("?")<0)?"?":"&")+"sap-system="+s;}}return n;},onInit:function(){var v=this.getView(),V=v.getViewData(),t=V.chip,c=a.getConfiguration(t,t.configurationUi.isEnabled(),false),m,k,K,b=this,N=c.navigation_target_url,s;this.sConfigNavigationTargetUrlOld=c.navigation_target_url;jQuery.sap.log.setLevel(2,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile");this.bIsRequestCompleted=false;this.oShellModel=A.getElementsModel();s=t.url.getApplicationSystem();this.navigationTargetUrl=this.constructTargetUrlWithSapSystem(N,s);m=new sap.ui.model.json.JSONModel({sizeBehavior:C.last("/core/home/sizeBehavior"),config:c,mode:c["display_mode"]||G.ContentMode,data:a.getDataToDisplay(c,{number:((t.preview&&t.preview.isEnabled())?1234:"...")}),nav:{navigation_target_url:(t.configurationUi&&t.configurationUi.isEnabled()?"":this.navigationTargetUrl)},search:{display_highlight_terms:[]}});v.setModel(m);this._aDoableObject=C.on("/core/home/sizeBehavior").do(function(S){m.setProperty("/sizeBehavior",S);});if(t.types){t.types.attachSetType(function(T){if(b.tileType!=T){var m=b.getView().getModel();if(T==='link'){m.setProperty("/mode",G.LineMode);}else{m.setProperty("/mode",m.getProperty("/config/display_mode")||G.ContentMode);}b.tileType=T;}});}if(!this.tileType){this.tileType="tile";}if(t.search){k=v.getModel().getProperty("/config/display_search_keywords");K=k.split(/[, ]+/).filter(function(n,i){return n&&n!=="";});if(c.display_title_text&&c.display_title_text!==""&&K.indexOf(c.display_title_text)===-1){K.push(c.display_title_text);}if(c.display_subtitle_text&&c.display_subtitle_text!==""&&K.indexOf(c.display_subtitle_text)===-1){K.push(c.display_subtitle_text);}if(c.display_info_text&&c.display_info_text!==""&&K.indexOf(c.display_info_text)===-1){K.push(c.display_info_text);}if(c.display_number_unit&&c.display_number_unit!==""&&K.indexOf(c.display_number_unit)===-1){K.push(c.display_number_unit);}t.search.setKeywords(K);t.search.attachHighlight(function(h){v.getModel().setProperty("/search/display_highlight_terms",h);});}if(t.bag&&t.bag.attachBagsUpdated){t.bag.attachBagsUpdated(function(g){if(g.indexOf("tileProperties")>-1){u._updateTilePropertiesTexts(v,t.bag.getBag('tileProperties'));}});}if(t.configuration&&t.configuration.attachConfigurationUpdated){t.configuration.attachConfigurationUpdated(function(g){if(g.indexOf("tileConfiguration")>-1){u._updateTileConfiguration(v,t.configuration.getParameterValueAsString("tileConfiguration"));}});}if(t.preview){t.preview.setTargetUrl(this.navigationTargetUrl);t.preview.setPreviewIcon(c.display_icon_url);t.preview.setPreviewTitle(c.display_title_text);if(t.preview.setPreviewSubtitle&&typeof t.preview.setPreviewSubtitle==='function'){t.preview.setPreviewSubtitle(c.display_subtitle_text);}}if(t.configurationUi.isEnabled()){t.configurationUi.setUiProvider(function(){var o=u.getConfigurationUi(v,"sap.ushell.components.tiles.applauncherdynamic.Configuration");t.configurationUi.attachCancel(b.onCancelConfiguration.bind(null,o));t.configurationUi.attachSave(b.onSaveConfiguration.bind(null,o));return o;});this.getView().getContent()[0].setTooltip(u.getResourceBundleModel().getResourceBundle().getText("edit_configuration.tooltip"));}else if(!t.preview||!t.preview.isEnabled()){if(!s){sap.ushell.Container.addRemoteSystemForServiceUrl(c.service_url);}this.bNeedsRefresh=true;this.iNrOfTimerRunning=0;}if(t.refresh){t.refresh.attachRefresh(this.refreshHandler.bind(this));}if(t.visible){t.visible.attachVisible(this.visibleHandler.bind(this));}if(t.actions){var d=c.actions,e;if(d){e=d.slice();}else{e=[];}var T=m.getProperty("/mode")===G.LineMode?"link":"tile",f=a.getTileSettingsAction(m,this.onSaveRuntimeSettings.bind(this),T);e.push(f);t.actions.setActionsProvider(function(){return e;});}sap.ui.getCore().getEventBus().subscribe("launchpad","sessionTimeout",this.stopRequests,this);},stopRequests:function(){if(this.timer){clearTimeout(this.timer);}if(this.oDataRequest){try{this.bIsAbortRequestFlow=true;this.oDataRequest.abort();}catch(e){jQuery.sap.log.warning(e.name,e.message);}this.bNeedsRefresh=true;this.bIsAbortRequestFlow=undefined;}},onExit:function(){this.stopRequests();sap.ui.getCore().getEventBus().unsubscribe("launchpad","sessionTimeout",this.stopRequests,this);this._aDoableObject.off();},onPress:function(e){var v=this.getView(),V=v.getViewData(),m=v.getModel(),t=m.getProperty("/nav/navigation_target_url"),T=V.chip,c=m.getProperty("/config"),r={},R=sap.ushell.Container.getRenderer("fiori2");if(e.getSource().getScope&&e.getSource().getScope()===sap.m.GenericTileScope.Display){if(T.configurationUi.isEnabled()){T.configurationUi.display();}else if(t){if(t[0]==='#'){hasher.setHash(t);}else{r.title=c.display_title_text;r.appType="App";r.url=c.navigation_target_url;r.appId=c.navigation_target_url;R.logRecentActivity(r);W.openURL(t,'_blank');}}}},extractData:function(d){var n,k=["results","icon","title","number","numberUnit","info","infoState","infoStatus","targetParams","subtitle","stateArrow","numberState","numberDigits","numberFactor"];if(typeof d==="object"&&Object.keys(d).length===1){n=Object.keys(d)[0];if(jQuery.inArray(n,k)===-1){return d[n];}}return d;},onSaveRuntimeSettings:function(s){var v=this.getView(),V=v.getModel(),t=v.getViewData().chip,c=V.getProperty("/config"),S=s.getModel();c.display_title_text=S.getProperty('/title');c.display_subtitle_text=S.getProperty('/subtitle');c.display_info_text=S.getProperty('/info');c.display_search_keywords=S.getProperty('/keywords');var b=t.bag.getBag('tileProperties');b.setText('display_title_text',c.display_title_text);b.setText('display_subtitle_text',c.display_subtitle_text);b.setText('display_info_text',c.display_info_text);b.setText('display_search_keywords',c.display_search_keywords);function l(e){jQuery.sap.log.error(e,null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile.controller");}b.save(function(){jQuery.sap.log.debug("property bag 'tileProperties' saved successfully");V.setProperty("/config",c);V.setProperty('/data/display_title_text',c.display_title_text);V.setProperty('/data/display_subtitle_text',c.display_subtitle_text);V.setProperty('/data/display_info_text',c.display_info_text);V.refresh();},l);},onSaveConfiguration:function(c){var d=jQuery.Deferred(),m=c.getModel(),t=m.getProperty("/tileModel"),T=c.getViewData().chip,b=u.tileActionsRows2TileActionsArray(m.getProperty("/config/tile_actions_rows")),e={display_icon_url:m.getProperty("/config/display_icon_url"),display_number_unit:m.getProperty("/config/display_number_unit"),service_url:m.getProperty("/config/service_url"),service_refresh_interval:m.getProperty("/config/service_refresh_interval"),navigation_use_semantic_object:m.getProperty("/config/navigation_use_semantic_object"),navigation_target_url:m.getProperty("/config/navigation_target_url"),navigation_semantic_object:jQuery.trim(m.getProperty("/config/navigation_semantic_object"))||"",navigation_semantic_action:jQuery.trim(m.getProperty("/config/navigation_semantic_action"))||"",navigation_semantic_parameters:jQuery.trim(m.getProperty("/config/navigation_semantic_parameters")),display_search_keywords:m.getProperty("/config/display_search_keywords")};var r=u.checkInputOnSaveConfig(c);if(!r){r=u.checkTileActions(c);}if(r){d.reject("mandatory_fields_missing");return d.promise();}if(e.navigation_use_semantic_object){e.navigation_target_url=a.getSemanticNavigationUrl(e);m.setProperty("/config/navigation_target_url",e.navigation_target_url);}var f=T.bag.getBag('tileProperties');f.setText('display_title_text',m.getProperty("/config/display_title_text"));f.setText('display_subtitle_text',m.getProperty("/config/display_subtitle_text"));f.setText('display_info_text',m.getProperty("/config/display_info_text"));f.setText('display_search_keywords',e.display_search_keywords);var g=T.bag.getBag('tileNavigationActions');u.populateTileNavigationActionsBag(g,b);function l(E,o){jQuery.sap.log.error(E,null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile.controller");d.reject(E,o);}T.writeConfiguration.setParameterValues({tileConfiguration:JSON.stringify(e)},function(){var o=a.getConfiguration(T,false,false),h=a.getConfiguration(T,true,false),m=new sap.ui.model.json.JSONModel({config:o,tileModel:t});c.setModel(m);t.setData({data:h,nav:{navigation_target_url:""}},false);if(T.preview){T.preview.setTargetUrl(o.navigation_target_url);T.preview.setPreviewIcon(o.display_icon_url);T.preview.setPreviewTitle(o.display_title_text);if(T.preview.setPreviewSubtitle&&typeof T.preview.setPreviewSubtitle==='function'){T.preview.setPreviewSubtitle(o.display_subtitle_text);}}f.save(function(){jQuery.sap.log.debug("property bag 'tileProperties' saved successfully");if(T.title){T.title.setTitle(o.display_title_text,function(){d.resolve();},l);}else{d.resolve();}},l);g.save(function(){jQuery.sap.log.debug("property bag 'navigationProperties' saved successfully");},l);},l);return d.promise();},successHandlerFn:function(r,R){var v=this.getView(),m=v.getModel(),c=m.getProperty("/config"),V=v.getViewData(),t=V.chip,s=t.url.getApplicationSystem(),d;this.oDataRequest=undefined;if(typeof R==="object"){var b=jQuery.sap.getUriParameters(r).get("$inlinecount");if(b&&b==="allpages"){R={number:R.__count};}else{R=this.extractData(R);}}else if(typeof R==="string"){R={number:R};}if(V.properties&&V.properties.info){if(typeof R==="object"){R.info=V.properties.info;}}d=a.getDataToDisplay(c,R);m.setProperty("/data",d);if(this.sConfigNavigationTargetUrlOld!==c.navigation_target_url){this.navigationTargetUrl=this.constructTargetUrlWithSapSystem(c.navigation_target_url,s);this.sConfigNavigationTargetUrlOld=this.navigationTargetUrl;}m.setProperty("/nav/navigation_target_url",a.addParamsToUrl(this.navigationTargetUrl,d));var i=c.service_refresh_interval;if(i>0){i=Math.max(i,this.REFRESH_INTERVAL_MIN);jQuery.sap.log.info("Wait "+i+" seconds before calling "+c.service_url+" again",null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile.controller");this.refeshAfterInterval(i);}},errorHandlerFn:function(m,i){var v=this.getView(),M=v.getModel(),c=M.getProperty("/config"),s=m&&m.message?m.message:m,r=u.getResourceBundleModel().getResourceBundle();this.oDataRequest=undefined;if(s==="Request aborted"){jQuery.sap.log.info("Data request from service "+c.service_url+" was aborted",null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile");}else{if(m.response){s+=" - "+m.response.statusCode+" "+m.response.statusText;}var l=i?jQuery.sap.log.warning:jQuery.sap.log.error;l("Failed to update data via service\n"+"  service URL: "+c.service_url+"\n"+"  "+s,null,"sap.ushell.components.tiles.applauncherdynamic.DynamicTile");}if(!this.bIsAbortRequestFlow){M.setProperty("/data",a.getDataToDisplay(c,{number:"???",info:r.getText("dynamic_data.error"),infoState:"Critical"}));}},onCancelConfiguration:function(c,s,e){var v=c.getViewData(),m=c.getModel(),t=m.getProperty("/tileModel"),T=v.chip,o=a.getConfiguration(T,false,false);m.setData({config:o,tileModel:t},false);},prepareToLoadData:function(){var d=this.getView(),c=d.getModel().getProperty("/config"),t=d.getViewData().chip,s=c.service_url,r,g,b=this;if(!s){this.errorHandlerFn("No service URL given!",true);return;}if(/;o=([;\/?]|$)/.test(s)){s=t.url.addSystemToServiceUrl(s);}if(this.serviceUrlWithDefaults){g=new jQuery.Deferred().resolve({url:this.serviceUrlWithDefaults}).promise();}else{r=sap.ushell.Container.getService("ReferenceResolver");g=r.resolveUserDefaultParameters(s);}g.done(b.loadData.bind(b)).fail(b.errorHandlerFn.bind(b));},loadData:function(r){if(r.defaultsWithoutValue&&r.defaultsWithoutValue.length>0){this.errorHandlerFn("The service URL contains User Default(s) with no set value: "+r.defaultsWithoutValue.join(", "),true);return;}if(r.ignoredReferences&&r.ignoredReferences.length>0){this.errorHandlerFn("The service URL contains invalid Reference(s): "+r.ignoredReferences.join(", "),false);return;}var s=r.url,S,b,R,o;this.serviceUrlWithDefaults=s;R={"Cache-Control":"no-cache, no-store, must-revalidate","Pragma":"no-cache","Expires":"0","Accept-Language":(sap.ui&&sap.ui.getCore().getConfiguration().getLanguage())||""};if(sap.ushell.Container){S=sap.ui.getCore().getConfiguration().getSAPLogonLanguage();if(S){R["sap-language"]=S;}b=sap.ushell.Container.getLogonSystem()?sap.ushell.Container.getLogonSystem().getClient():"";o=new U(s);if(b&&!o.protocol()){R["sap-client"]=b;}}if(S&&s.indexOf("sap-language=")===-1){s=s+(s.indexOf("?")>=0?"&":"?")+"sap-language="+S;}this.oDataRequest=O.read({requestUri:s,headers:R},this.successHandlerFn.bind(this,s),this.errorHandlerFn.bind(this));},refreshTile:function(){var v=this.getView(),V=v.getViewData(),i=V.chip.visible.isVisible();if(i&&this.bNeedsRefresh){this.bNeedsRefresh=false;if(!this.oDataRequest){this.prepareToLoadData();}}},refeshAfterInterval:function(r){var t=this;this.iNrOfTimerRunning++;setTimeout(function(){t.iNrOfTimerRunning--;if(t.iNrOfTimerRunning===0){t.bNeedsRefresh=true;t.refreshTile();}},r*1000);},refreshHandler:function(){this.bNeedsRefresh=true;this.refreshTile();},visibleHandler:function(i){if(i){this.refreshTile();}else{this.stopRequests();}}});},false);
