// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ushell/components/applicationIntegration/elements/model','sap/ushell/components/applicationIntegration/Storage','sap/ushell/components/container/ApplicationContainer','sap/ushell/ui5service/ShellUIService','sap/ushell/components/applicationIntegration/application/Application','sap/ushell/components/applicationIntegration/relatedServices/RelatedServices','sap/ushell/components/applicationIntegration/relatedShellElements/RelatedShellElements','sap/ushell/components/applicationIntegration/configuration/AppMeta','sap/ushell/services/AppConfiguration','sap/ushell/utils','sap/ushell/resources','sap/ui/Device','sap/ushell/Config','sap/ushell/EventHub','sap/ushell/ui5service/AppIsolationService'],function(E,S,A,a,b,R,c,d,e,u,r,D,C,f,g){"use strict";function h(){var v,i=["URL"],s,j,o,k,l=false,m={},n={home:{embedded:"embedded-home",headerless:"headerless-home",merged:"blank-home",blank:"blank-home"},app:{minimal:"minimal",app:"app",standalone:"standalone",embedded:"embedded",headerless:"headerless",merged:"merged",home:"home",blank:"blank",lean:"lean"}},p,G=[],q={};this.shellElements=function(){return c;};this.service=function(){return R;};this.isCurrentApp=function(t){return m.appId===t?true:false;};this.isAppWithSimilarShellHashInCache=function(t,F){var w=S.get(t);if(w){if(w.shellHash===F){return true;}else{return false;}}else{return false;}};this.isAppInCache=function(t){return!!S.get(t);};this.normalizeAppId=function(t){var w="-component",x=t.endsWith(w);if(x){return t.substring(0,t.length-w.length);}else{return t;}};this.onComponentCreated=function(t,w,x){var y=x.component,z=this.normalizeAppId(y.getId());if(y.active){y.active();}if(this.isAppInCache(z)){S.get(z).app=y;}else{m.app=y;}};this.onGetMe=function(t,w,x){x.AppLifeCycle=this;};this.store=function(t){var w=S.get(t);if(w){b.store(w.app);R.store(w.service);d.store(w.meta);}};this.destroy=function(t,F){var w=S.get(t);function x(){b.destroy(F);c.destroy(F);d.destroy(F);}this.removeControl(t);if(w){w.container.destroy();S.remove(t);}else{var P=F&&F.sendBeforeAppCloseEvent&&F.sendBeforeAppCloseEvent();if(P===undefined){x();}else{P.then(function(){x();},function(y){x();jQuery.sap.log.error("FLP got a failed response from the iframe for the 'sap.ushell.services.CrossApplicationNavigation.beforeAppCloseEvent' message sent",y,"sap.ushell.components.applicationIntegration.AppLifeCycle.js");});}}};this.restore=function(t){var w=S.get(t);if(w){b.restore(w.app);R.restore(w.service);d.restore(w.meta);}};this.onAfterNavigate=function(F,t,T){if(F&&t){if(S.get(F)){this.store(F);}else if(t.getApplicationType&&this.applicationIsStatefulType(t.getApplicationType())){if(T.indexOf("Shell-appfinder-component")>0||T.indexOf("Shell-home-component")>0){t.postMessageRequest("sap.gui.triggerCloseSessionImmediately");}}else{if(this.isAppOfTypeCached(F)===false){this.destroy(F,t);}}if(F.indexOf("Shell-appfinder-component")>0){sap.ui.getCore().getEventBus().publish("sap.ushell","appFinderAfterNavigate");}}if(T){if(S.get(T)){this.restore(T);}else{}}};this.storeApp=function(t,w,T,x,y,H,F){if(!this.isAppInCache(t)){S.set(t,{service:R.create(),shellHash:F,appId:t,stt:'loading',appRelatedElements:c.getAppRelatedElement(),container:w,meta:e.getMetadata(T),app:undefined,target:y,hash:H});return true;}return false;};this.resoterApp=function(t){if(this.isAppInCache(t)){m=S.get(t);}};this.isAppOfTypeCached=function(t){if(!l&&t.indexOf(s)!==-1){return true;}if(!l&&t.indexOf("Shell-appfinder")!==-1){return true;}if(jQuery.sap.getUriParameters().get("sap-keep-alive")=="true"){return true;}return false;};h.prototype._getURLParsing=function(){if(!this._oURLParsing){this._oURLParsing=sap.ushell.Container.getService("URLParsing");}return this._oURLParsing;};this.openApp=function(t,T,w,F){var x;var y=undefined,H=undefined;var z="application"+t;if(typeof T!=="undefined"){y=Object.assign({},T);delete y.componentHandle;}if(typeof w!=="undefined"){H=Object.assign({},w);}if(this.isAppOfTypeCached(z)||this.isCachedEnabledAsAppParameter(w,T)){if(!this.isAppInCache(z)){x=this.createApplicationContainer(t,T);this.storeApp(z,x,T,w,y,H,F);}this.resoterApp(z);}else if(this.applicationIsStatefulType(T.applicationType)){x=this.getStatefulContainer(T.applicationType);if(!x){x=this.createApplicationContainer(t,T);this.setStatefulContainer(T.applicationType,x);x.setIsStateful(true);}m={appId:z,stt:'loading',container:x,meta:e.getMetadata(T),app:undefined,target:y,hash:H};}else{x=this.createApplicationContainer(t,T);m={appId:z,stt:'loading',container:x,meta:e.getMetadata(T),app:undefined,target:y,hash:H};}};this.getAppMeta=function(){return d;};this.init=function(t,I,w,x,y,z){o=new a({scopeObject:y.ownerComponent,scopeType:"component"});k=new g({scopeObject:y.ownerComponent,scopeType:"component"});j=t;v=I;s=w;d.init(s);l=x;S.init(z,function(B){var F=B.value;this.destroy(F.appId,F.container);}.bind(this));sap.ui.getCore().getEventBus().subscribe("sap.ushell","appComponentLoaded",this.onComponentCreated,this);sap.ui.getCore().getEventBus().subscribe("sap.ushell","getAppLifeCycle",this.onGetMe,this);c.init(this.getElementsModel());};this.addControl=function(t){v.addCenterViewPort(t);};this.removeControl=function(I){v.removeCenterViewPort(I,true);};this.removeApplication=function(I){var t=this.getControl(I);if(t){this.removeControl(t.getId());t.destroy();}};this.getControl=function(I){return v&&(v.getViewPortControl('centerViewPort',"application"+'-'+I)||v.getViewPortControl('centerViewPort',"applicationShellPage"+'-'+I));};this.getViewPortContainer=function(){return v;};this.navTo=function(I){v.navTo('centerViewPort',I,'show');};this.getCurrentApplication=function(){return m;};this.setApplicationFullWidth=function(I){var t=this.getCurrentApplication();if(t.container){t.container.toggleStyleClass("sapUShellApplicationContainerLimitedWidth",!I);}};this.createComponent=function(t,P){this.shellElements().setDangling(true);return b.createComponent(t,P);};this.getAppContainer=function(t,w,I,x,F){w.shellUIService=o.getInterface();w.appIsolationService=k.getInterface();w.targetNavigationMode=I?"explace":"inplace";this.openApp(t,w,x,F);if(G.length>0)m.container.registerShellCommunicationHandler(G);if(q["UI5APP"])m.container.setIframeHandlers(q["UI5APP"]);return m.container;};this.getShellUIService=function(){return o;};this.getAppIsolationService=function(){return k;};this.initShellUIService=function(t){o._attachHierarchyChanged(d.onHierarchyChange.bind(this));o._attachTitleChanged(d.onTitleChange.bind(this));o._attachRelatedAppsChanged(d.onRelatedAppsChange.bind(this));o._attachBackNavigationChanged(t.fnOnBackNavigationChange.bind(this));};this.parseStatefulContainerConfiguration=function(t){var w={};if(t){var x={"GUI":true};Object.keys(t).filter(function(y){return true===t[y]&&x[y];}).map(function(U){var y=U;if(y==="GUI"){y="TR";}return y;}).forEach(function(y){w[y]=null;});}p=w;};this.setStatefulApplicationContainer=function(t){p=t;};this.getStatefulApplicationContainer=function(){return p;};this.applicationIsStatefulType=function(t){return p.hasOwnProperty(t);};this.getStatefulContainer=function(t){return p[t];};this.setStatefulContainer=function(t,w){return p[t]=w;};this.statefulContainerForTypeExists=function(t){return!!this.getStatefulContainer(t);};this.getAllApplicationContainers=function(){return Object.keys(p).map(function(K){return p[K];}).filter(function(t){return!!t;});};this.getElementsModel=function(){return E;};this.activeContainer=function(t){var w=this.getAllApplicationContainers();w.forEach(function(x){jQuery.sap.log.info("Deactivating container "+x.getId());x.setActive(false);});if(t){jQuery.sap.log.info("Activating container "+t.getId());t.setActive(true);}};this.reuseApplicationContainer=function(t,w,x){var y=this;return t.setNewApplicationContext(w,x).then(function(){y.navTo(t.getId());t.toggleStyleClass("hidden",false);jQuery.sap.log.info("New application context opened successfully in an existing transaction UI session.");},function(z){jQuery.sap.log.error(z&&z.message||z);});};this.createApplicationContainer=function(t,w){return b.createApplicationContainer(t,w);};this.publishNavigationStateEvents=function(t,w,O){var x,I=t.getId?t.getId():"",y=this;var z=e.getMetadata(),B=z.icon,T=z.title;t.addEventDelegate({onAfterRendering:O});x=t.exit;t.exit=function(){if(x){x.apply(this,arguments);}y.getAppMeta()._applyContentDensityByPriority();setTimeout(function(){var F=jQuery.extend(true,{},w);delete F.componentHandle;F["appId"]=I;F["usageIcon"]=B;F["usageTitle"]=T;sap.ui.getCore().getEventBus().publish("sap.ushell","appClosed",F);jQuery.sap.log.info('app was closed');},0);var P=y._publicEventDataFromResolutionResult(w);sap.ushell.renderers.fiori2.utils.publishExternalEvent("appClosed",P);};};this._publicEventDataFromResolutionResult=function(t){var P={};if(!t){return t;}["applicationType","ui5ComponentName","url","additionalInformation","text"].forEach(function(w){P[w]=t[w];});Object.freeze(P);return P;};this.isCachedEnabledAsAppParameter=function(t,T){if(t&&t.params&&t.params["sap-keep-alive"]){if(t.params["sap-keep-alive"]=="true"){return true;}}if(T&&T.url){if(jQuery.sap.getUriParameters(T.url).get("sap-keep-alive")=="true"){return true;}}return false;};this.getInMemoryInstance=function(I,F){var t="application-"+I,w=S.get(t);if(w){if(w.shellHash===F){return{isInstanceSupported:true,appId:w.appId,container:w.container};}else{return{isInstanceSupported:false,appId:w.appId,container:w.container};}}return{isInstanceSupported:false,appId:undefined,container:undefined};};this.handleControl=function(I,t,w,T,W,x,F){var y=this.getControl(I),z=this.statefulContainerForTypeExists(T.applicationType),M=e.getMetadata(T),L=(T.applicationType==="NWBC"||T.applicationType==="TR"),B=i.indexOf(T.applicationType)>=0,H="application-"+I,J=this.isAppOfTypeCached(H,B)||this.isCachedEnabledAsAppParameter(w,T);if(!z&&y&&!J){this.destroy(y.getId(),y);y=W(I,M,w,T,t,T.fullWidth||M.fullWidth||L,F);}else if(!y){y=W(I,M,w,T,t,T.fullWidth||M.fullWidth||L,F);}else if(I===s){x();}if(!z){this.resoterApp(y.getId());this.navTo(y.getId());}v.switchState("Center");u.setPerformanceMark("FLP -- centerViewPort");this.activeContainer(y);if(z){this.reuseApplicationContainer(y,T.applicationType,T.url);}};this.switchViewState=function(t,w,x){var y=t,z;if(n[t]&&n[t][j]){y=n[t][j];}var I=C.last("/core/shell/model/currentState/stateName")==="home";if(!I&&(!m.appId||!S.get(m.appId))){E.destroyManageQueue();}z=S.get("application"+x);if(z){c.restore(z);}else{c.assignNew(t);}var B=E.switchState(y,w,x);this.shellElements().setDangling(false);this.shellElements().processDangling();if(t==="searchResults"){this.getElementsModel().setProperty("/lastSearchScreen",'');if(!window.hasher.getHash().indexOf("Action-search")===0){var F=sap.ui.getCore().getModel("searchModel");window.hasher.setHash("Action-search&/searchTerm="+F.getProperty("/uiFilter/searchTerms")+"&dataSource="+JSON.stringify(F.getProperty("/uiFilter/dataSource").getJson()));}}sap.ui.getCore().getEventBus().publish("launchpad","shellViewStateChanged",B);};this.registerShellCommunicationHandler=function(t,T){if(T==="global"){G=t;}else{m.container.registerShellCommunicationHandler(t);}};this.registerIframeCommunicationHandler=function(H,t){q[t]=H;};}return new h();},true);
