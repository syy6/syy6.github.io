// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ui/core/IconPool','sap/ui/Device','sap/ui/core/CustomData','sap/ui/core/theming/Parameters','sap/ui/core/HTML','sap/ushell/UserActivityLog','sap/ushell/ui/launchpad/ActionItem','sap/ushell/ui/launchpad/Fiori2LoadingDialog','sap/ushell/ui/shell/ShellHeadItem','sap/ushell/ui/shell/ShellNavigationMenu','sap/ushell/ui/shell/ToolArea','sap/ushell/ui/shell/NavigationMiniTile','sap/ushell/ui/footerbar/ContactSupportButton','sap/ushell/ui/launchpad/AccessibilityCustomData','sap/ushell/renderers/fiori2/AccessKeysHandler','sap/m/StandardListItem','sap/m/Button','sap/m/Dialog','sap/ushell/resources','sap/ushell/utils','sap/ushell/Config','sap/ushell/EventHub'],function(I,D,C,T,H,U,A,F,S,a,b,N,c,d,e,f,B,g,r,u,h,E){"use strict";function s(i,o){return sap.ui.getCore().byId(o.getObject());}sap.ui.jsview("sap.ushell.renderers.fiori2.Shell",{createContent:function(o){this.oController=o;this.oShellAppTitleStateEnum={SHELL_NAV_MENU_ONLY:0,ALL_MY_APPS_ONLY:1,SHELL_NAV_MENU:2,ALL_MY_APPS:3};var v=this.getViewData()||{},i=v.config||{},j=(i.appState==="embedded")?true:false,k,l=new S({id:"configBtn",tooltip:"{i18n>showGrpsBtn_tooltip}",ariaLabel:"{i18n>showGrpsBtn_tooltip}",icon:I.getIconURI("menu2"),selected:{path:"/currentState/showPane"},press:[o.togglePane,o]}),m=sap.ui.getCore().getConfiguration().getRTL()?"feeder-arrow":"nav-back",n=new S({id:"homeBtn",tooltip:"{i18n>homeBtn_tooltip}",ariaLabel:"{i18n>homeBtn_tooltip}",icon:I.getIconURI("home"),target:i.rootIntent?"#"+i.rootIntent:"#"}),p=new S({id:"backBtn",tooltip:"{i18n>backBtn_tooltip}",ariaLabel:"{i18n>backBtn_tooltip}",icon:I.getIconURI(m),press:o._navBack.bind(o)}),q,M,t=h.last("/core/extension/enableHelp");this._allowUpToThreeActionInShellHeader(i);p.setShowSeparator(false);n.setShowSeparator(false);n.addCustomData(new d({key:"aria-disabled",value:"false",writeToDom:true}));this.oConfig=i;n.addEventDelegate({onsapskipback:function(W){if(e.getAppKeysHandler()){W.preventDefault();e.bFocusOnShell=false;}},onsapskipforward:function(W){if(e.getAppKeysHandler()){W.preventDefault();e.bFocusOnShell=false;}}});l.addEventDelegate({onsapskipforward:function(W){if(e.getAppKeysHandler()){W.preventDefault();e.bFocusOnShell=false;}},onfocusin:function(){e.bFocusOnShell=true;e.bFocusPassedToExternalHandlerFirstTime=true;}});this.aDanglingControls=[];if(!i.preventLoadingDialogAtStartup){k=new F({id:"Fiori2LoadingDialog",text:""});this.aDanglingControls.push(k);}if(u.isNotificationsEnabled()){q=new S({id:"NotificationsCountButton",icon:sap.ui.core.IconPool.getIconURI("ui-notifications"),accessKey:"n",visible:true,enabled:false}).addStyleClass("sapUshellPlaceHolders");q.setShowSeparator(false);this.aDanglingControls.push(q);}M=new S({id:"meAreaHeaderButton",icon:'{/userImage/personPlaceHolder}',accessKey:"m",visible:true,enabled:false}).addStyleClass("sapUshellPlaceHolders");M.setShowSeparator(false);this.aDanglingControls.push(M);if(i.enablePersonalization!==false){var w;var x="openCatalogBtn";var y=r.i18n.getText("open_appFinderBtn");var z='sap-icon://sys-find';var G="#Shell-home&/appFinder/catalog";var J="Shell";var K="appfinder";var L=function(){jQuery.sap.measure.start("FLP:AppFinderLoadingStartToEnd","AppFinderLoadingStartToEnd","FLP");sap.ushell.Container.getServiceAsync("URLParsing").then(function(W){if(W){w=W.parseShellHash(window.hasher.getHash());w.action=K;w.semanticObject=J;G="#"+W.constructShellHash(w);}setTimeout(function(){sap.ushell.Container.getServiceAsync("CrossApplicationNavigation").then(function(X){X.toExternal({target:{shellHash:G}});});},D.system.desktop?0:500);}.bind(this));};var O=!i.disableAppFinder;if(i.moveAppFinderActionToShellHeader){if(!this.oOpenCatalogItem){this.oOpenCatalogItem=new S(x,{icon:z,tooltip:y,text:y,press:L,showSeparator:false,visible:O});this.oOpenCatalogItem.data("isShellHeader",true);}}else if(!this.oOpenCatalogItem){this.oOpenCatalogItem=new A(x,{text:y,icon:z,actionType:'action',press:L,visible:O});}if(t){this.oOpenCatalogItem.addStyleClass('help-id-openCatalogActionItem');}this.aDanglingControls.push(this.oOpenCatalogItem);if(i.moveEditHomePageActionToShellHeader){jQuery.sap.measure.start("FLP:Shell.view.createContent","create the edit home page button as shell head enditem","FLP");if(!this.oTileActionsButton){this.oTileActionsButton=new S("ActionModeBtn",{icon:'sap-icon://edit',visible:false,showSeparator:false});this.oTileActionsButton.data("isShellHeader",true);if(t){this.oTileActionsButton.addStyleClass('help-id-openCatalogActionItem');}}this.aDanglingControls.push(this.oTileActionsButton);jQuery.sap.measure.end("FLP:Shell.view.createContent");}}var P=new S({id:"endItemsOverflowBtn",tooltip:"{i18n>shellHeaderOverflowBtn_tooltip}",ariaLabel:"{i18n>shellHeaderOverflowBtn_tooltip}",icon:"sap-icon://overflow",press:[o.pressEndItemsOverflow,o],visible:true,showSeparator:false});this.aDanglingControls.push(P);var Q,R;Q=sap.ui.xmlfragment("sap.ushell.renderers.fiori2.ShellHeader",o);Q.setAccessKeyHandler(e);this.oShellHeaderAppTitle=Q.getAppTitle();this.oShellHeaderAppTitle.addEventDelegate({onsapskipforward:function(W){if(e.getAppKeysHandler()){W.preventDefault();e.bFocusOnShell=false;}}});this.oShellHeader=Q;this.addEventDelegate({"onBeforeRendering":function(){this.oShellHeader.createUIArea(this.getUIArea().getId());}},this);R=sap.ui.xmlfragment("sap.ushell.renderers.fiori2.ShellLayout",o);R.setHeader(Q);R._setStrongBackground(true);var V;E.once("ToolAreaItemCreated").do(function(W){V=this._createToolArea();R.setToolArea(V);V.updateAggregation=this.updateShellAggregation;}.bind(this));this.setOUnifiedShell(R);Q.setShellLayout(R);if(j){Q.setLogo(sap.ui.resource('sap.ui.core','themes/base/img/1x1.gif'));}else{this.initShellBarLogo(Q);}this.setDisplayBlock(true);this.aDanglingControls=this.aDanglingControls.concat([sap.ui.getCore().byId('viewPortContainer'),n,p,l]);this.logonIFrameReference=null;u.setPerformanceMark("FLP - Shell.view rendering started!");return R;},_createToolArea:function(){var o=new b({id:'shell-toolArea',toolAreaItems:{path:"/currentState/toolAreaItems",factory:s}});return o;},_allowUpToThreeActionInShellHeader:function(o){if(Object.keys(o).length!=0){var i=[o.moveAppFinderActionToShellHeader,o.moveUserSettingsActionToShellHeader,o.moveGiveFeedbackActionToShellHeader,o.moveContactSupportActionToShellHeader,o.moveEditHomePageActionToShellHeader];var j=0;for(var k=0;k<5;k++){if(j===3){i[k]=false;}else if(i[k]){j++;}}o.moveAppFinderActionToShellHeader=i[0];o.moveUserSettingsActionToShellHeader=i[1];o.moveGiveFeedbackActionToShellHeader=i[2];o.moveContactSupportActionToShellHeader=i[3];o.moveEditHomePageActionToShellHeader=i[4];}},_createPostCoreExtControls:function(j,k){var o=this.oController,l=this.oConfig,m=sap.ui.getCore().byId("shell");if(!m){return;}var n=function(w,x){var y=x.getProperty("icon");var z=x.getProperty("title");var G=x.getProperty("subtitle");var J=x.getProperty("intent");if(!y){y="sap-icon://circle-task-2";}var L=(new f({type:"Active",title:z,description:G,icon:y,customData:[new C({key:"intent",value:J})],press:function(K){var M=K.getSource().getCustomData();if(M&&M.length>0){for(var i=0;i<M.length;i++){if(M[i].getKey()==="intent"){var O=M[i].getValue();if(O&&O[0]==="#"){o.navigateFromShellApplicationNavigationMenu(O);return;}}}}}})).addStyleClass("sapUshellNavigationMenuListItems");return L;};var R=function(i,w){var x=w.getProperty("icon");var y=w.getProperty("title");var z=w.getProperty("subtitle");var G=w.getProperty("intent");return new N({title:y,subtitle:z,icon:x,intent:G,press:function(){var J=this.getIntent();if(J&&J[0]==='#'){o.navigateFromShellApplicationNavigationMenu(J);}}});};var p=new a("shellNavigationMenu",{title:"{/currentState/application/title}",icon:"{/currentState/application/icon}",showTitle:{path:"/currentState/application/showNavMenuTitle"},showRelatedApps:(l.appState==="lean")?false:true,items:{path:"/currentState/application/hierarchy",factory:n.bind(this)},miniTiles:{path:"/currentState/application/relatedApps",factory:R.bind(this)},visible:{path:'/ShellAppTitleState',formatter:function(i){return i===this.oShellAppTitleStateEnum.SHELL_NAV_MENU;}.bind(this)}});p.setModel(this.getModel());this.oShellHeaderAppTitle.setNavigationMenu(p);var q=new j({id:'shell-floatingContainer',content:{path:"/currentState/floatingContainerContent",factory:s}});q.addCustomData(new d({key:"tabindex",value:"-1",writeToDom:true}));q.addEventDelegate({onsapskipforward:function(i){i.preventDefault();e.setIsFocusHandledByAnotherHandler(true);e.sendFocusBackToShell(i);},onsapskipback:function(i){if(e.getAppKeysHandler()){i.preventDefault();e.bFocusOnShell=false;}}});q.setModel(m.getModel());this.aDanglingControls.push(q);var t=new k({id:'shell-floatingActions',floatingActions:{path:"/currentState/floatingActions",factory:s}});t.updateAggregation=this.updateShellAggregation;var v=this.getOUnifiedShell();v.setFloatingContainer(q);v.setFloatingActionsContainer(t);this._createAllMyAppsView();},createPostCoreExtControls:function(){sap.ui.require(["sap/ushell/ui/shell/FloatingContainer","sap/ushell/ui/shell/ShellFloatingActions"],this._createPostCoreExtControls.bind(this));},_createAllMyAppsView:function(){var o=function(i){if(i.isEnabled()){this.oAllMyAppsView=sap.ui.view("allMyAppsView",{type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.ushell.renderers.fiori2.allMyApps.AllMyApps",viewData:{_fnGetShellModel:this.getModel.bind(this)},async:true,height:"100%",visible:{path:'/ShellAppTitleState',formatter:function(j){return j!==this.oShellAppTitleStateEnum.SHELL_NAV_MENU;}.bind(this)}}).addStyleClass("sapUshellAllMyAppsView");this.oAllMyAppsView.addCustomData(new d({key:"aria-label",value:r.i18n.getText("allMyApps_headerTitle"),writeToDom:true}));this.getOUnifiedShell().getHeader().getAppTitle().setAllMyApps(this.oAllMyAppsView);}}.bind(this);sap.ushell.Container.getServiceAsync("AllMyApps").then(o);},getOUnifiedShell:function(){return this.oUnifiedShell;},setOUnifiedShell:function(o){this.oUnifiedShell=o;},initShellBarLogo:function(o){function i(k){var m=/url[\s]*\('?"?([^\'")]*)'?"?\)/.exec(k);return m?m[1]:null;}function j(){if(!o.bIsDestroyed){var k=i(T.get("sapUiGlobalLogo"));o.setLogo(k||jQuery.sap.getModulePath("sap.ushell")+'/themes/base/img/sap_55x27.png');}}if(sap.ui.getCore().isThemeApplied()){j();}sap.ui.getCore().attachThemeChanged(j);u.setPerformanceMark("FLP-TimeToFirstMeaningfullPaint_setLogo");},updateShellAggregation:function(n){var o=this.mBindingInfos[n],j=this.getMetadata().getJSONKeys()[n],k;jQuery.each(this[j._sGetter](),jQuery.proxy(function(i,v){this[j._sRemoveMutator](v);},this));jQuery.each(o.binding.getContexts(),jQuery.proxy(function(i,v){k=o.factory(this.getId()+"-"+i,v)?o.factory(this.getId()+"-"+i,v).setBindingContext(v,o.model):"";this[j._sMutator](k);},this));},getControllerName:function(){return"sap.ushell.renderers.fiori2.Shell";},createIFrameDialog:function(){var o=null,l=this.logonIFrameReference,i;var _=function(){if(l){l.remove();}return jQuery('<iframe id="SAMLDialogFrame" src="" frameborder="0" height="100%" width="100%"></iframe>');};var j=function(){o.addStyleClass('sapUshellSamlDialogHidden');jQuery('#sap-ui-blocklayer-popup').addClass('sapUshellSamlDialogHidden');};this.destroyIFrameDialog();var k=new B({text:r.i18n.getText("samlCloseBtn"),press:function(){sap.ushell.Container.cancelLogon();}});var m=new H("SAMLDialogFrame");this.logonIFrameReference=_();m.setContent(this.logonIFrameReference.prop('outerHTML'));o=new g({id:"SAMLDialog",title:r.i18n.getText("samlDialogTitle"),contentWidth:"50%",contentHeight:"50%",rightButton:k}).addStyleClass("sapUshellIframeDialog");i=h.last("/core/extension/SupportTicket");if(i){var n=new c();n.setWidth('150px');n.setIcon('');o.setLeftButton(n);}o.addContent(m);o.open();j();this.logonIFrameReference=jQuery('#SAMLDialogFrame');return this.logonIFrameReference[0];},destroyIFrameDialog:function(){var i=sap.ui.getCore().byId('SAMLDialog');if(i){i.destroy();}this.logonIFrameReference=null;},showIFrameDialog:function(){var o=sap.ui.getCore().byId('SAMLDialog');if(o){o.removeStyleClass('sapUshellSamlDialogHidden');jQuery('#sap-ui-blocklayer-popup').removeClass('sapUshellSamlDialogHidden');}},addDanglingControl:function(o){this.aDanglingControls.push(o);}});},false);
