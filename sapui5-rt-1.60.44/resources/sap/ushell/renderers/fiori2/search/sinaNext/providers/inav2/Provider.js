sinaDefine(['../../core/core','../../core/util','../../core/lang','./ajax','./ajaxTemplates','./pivotTableParser','./conditionSerializer','./dataSourceSerializer','./FacetParser','./ItemParser','./suggestionParser','./suggestionTermSplitter','./LabelCalculator','./UserEventLogger','./MetadataParser'],function(c,u,l,a,b,p,d,e,F,I,s,f,L,U,M){"use strict";return c.defineClass({id:'inav2',_initAsync:function(g){this.urlPrefix='/sap/es/ina';this.getServerInfoUrl=this.urlPrefix+'/GetServerInfo';this.getResponseUrl=this.urlPrefix+'/GetResponse';this.sina=g.sina;this.ajaxClient=a.createAjaxClient();this.metadataLoadPromises={};this.internalMetadata={};this.labelCalculator=new L();this.userEventLogger=new U(this);this.metadataParser=new M(this);this.itemParser=new I(this);this.facetParser=new F(this);this.executeSearchQuery=this.addMetadataLoadDecorator(this.executeSearchQuery);this.executeChartQuery=this.addMetadataLoadDecorator(this.executeChartQuery);this.executeSuggestionQuery=this.addMetadataLoadDecorator(this.executeSuggestionQuery);this.sessionId=c.generateGuid();return this.loadServerInfo().then(function(h){this.serverInfo=h;this.userEventLogger.delayedInit();if(!this.supports('Search')){return Promise.reject(new c.Exception('Enterprise Search is not active'));}return this.loadBusinessObjectDataSources();}.bind(this)).then(function(){return{capabilities:this.sina._createCapabilities({fuzzy:this.supports('Search','OptionFuzzy')})};}.bind(this));},addMetadataLoadDecorator:function(g){return function(){var h=arguments;var q=arguments[0];var i=q.filter.dataSource;return Promise.resolve().then(function(){return this.loadMetadata(i);}.bind(this)).then(function(){return g.apply(this,h);}.bind(this));}.bind(this);},loadMetadata:function(g){if(g.type===this.sina.DataSourceType.Category){return c.Promise.resolve();}var h=this.metadataLoadPromises[g.id];if(h){return h;}b.loadDataSourceMetadataRequest.DataSource.ObjectName=g.id;this.addLanguagePreferences(b.loadDataSourceMetadataRequest);h=this.ajaxClient.postJson(this.getResponseUrl,b.loadDataSourceMetadataRequest).then(function(r){this.metadataParser.parseMetadataRequestMetadata(g,r.data);}.bind(this));this.metadataLoadPromises[g.id]=h;return h;},supports:function(g,h){for(var i=0;i<this.serverInfo.Services.length;++i){var k=this.serverInfo.Services[i];if(k.Service==g){if(!h){return true;}for(var j=0;j<k.Capabilities.length;++j){var m=k.Capabilities[j];if(m.Capability===h){return true;}}}}return false;},loadServerInfo:function(){return this.ajaxClient.getJson(this.getServerInfoUrl).then(function(r){return r.data;}.bind(this));},loadBusinessObjectDataSources:function(){var t=this;t.addLanguagePreferences(b.loadDataSourcesRequest);if(t.supports('Search','PluralDescriptionForDataSource')){b.loadDataSourcesRequest.Search.NamedValues.push({AttributeName:"DescriptionPlural",Name:"DescriptionPlural"});}return t.ajaxClient.postJson(t.getResponseUrl,b.loadDataSourcesRequest).then(function(r){t._processDataSourcesResponse(r,false);},function(g){var h=t.serverInfo.ServerInfo.SystemId+t.serverInfo.ServerInfo.Client+"~ESH_CONNECTOR~";b.fallbackLoadDataSourcesRequest.DataSource.ObjectName=h;return t.ajaxClient.postJson(t.getResponseUrl,b.fallbackLoadDataSourcesRequest).then(function(r){t._processDataSourcesResponse(r,true);});});},_processDataSourcesResponse:function(r,g){var h=p.parse(r.data);var j=h.axes[0];for(var i=0;i<j.length;++i){var k=j[i];var m='';var n='';var o='';if(!g){if(c.isObject(k.Description)){m=k.Description.Value;}else{m=k.Description;}if(c.isObject(k.DescriptionPlural)){n=k.DescriptionPlural.Value;}else{n=k.DescriptionPlural;}if(c.isObject(k.ObjectName)){o=k.ObjectName.Value;}else{o=k.ObjectName;}}else{k.$$ResultItemAttributes$$.forEach(function(t){if(t.Name==="DESCRIPTION"){m=t.Value;}if(t.Name==="DESCRIPTION_PLURAL"){n=t.Value;}if(t.Name==="OBJECT_NAME"){o=t.Value;}});}if(!m){m=o;}if(!n){n=m;}var q=this.sina._createDataSource({id:o,label:m,labelPlural:n,type:this.sina.DataSourceType.BusinessObject,attributesMetadata:[{id:'dummy'}]});this.labelCalculator.calculateLabel(q);}},getInternalMetadataAttributes:function(g){var h=[];var i=this.internalMetadata[g.id];if(!i){return h;}for(var j in i.data){h.push(i.data[j]);}return h;},getInternalMetadataAttribute:function(g,h){return this.internalMetadata[g.id].data[h];},getInternalMetadataLoadStatus:function(g){var i=this.internalMetadata[g.id];if(!i){return{};}return i.loadStatus;},fillInternalMetadata:function(g,h,j){var k=this.internalMetadata[g.id];if(!k){k={loadStatus:{},data:{}};this.internalMetadata[g.id]=k;}for(var i=0;i<j.length;++i){var m=j[i];var n=k.data[m.Name];if(!n){n={};k.data[m.Name]=n;}for(var o in m){n[o]=m[o];}}k.loadStatus[h]=true;},addTemplateConditions:function(r){r.addCondition({attribute:'$$RenderingTemplatePlatform$$',operator:this.sina.ComparisonOperator.Eq,value:'html'});r.addCondition({attribute:'$$RenderingTemplateTechnology$$',operator:this.sina.ComparisonOperator.Eq,value:'Tempo'});r.addCondition({attribute:'$$RenderingTemplateType$$',operator:this.sina.ComparisonOperator.Eq,value:'ResultItem'});r.addCondition({attribute:'$$RenderingTemplateType$$',operator:this.sina.ComparisonOperator.Eq,value:'ItemDetails'});},assembleOrderBy:function(q){var r=[];for(var i=0;i<q.sortOrder.length;++i){var g=q.sortOrder[i];var h=(g.order===this.sina.SortOrder.Descending)?'DESC':'ASC';r.push({AttributeName:g.id,SortOrder:h});}return r;},executeSearchQuery:function(q){var g,r;var h=q.filter.rootCondition.clone();this.addTemplateConditions(h);b.searchRequest.Search.Filter=d.serialize(q.filter.dataSource,h);b.searchRequest.DataSource=e.serialize(q.filter.dataSource);b.searchRequest.Search.SearchTerms=q.filter.searchTerm;b.searchRequest.Search.Top=q.top;b.searchRequest.Search.Skip=q.skip;b.searchRequest.Options=this.assembleRequestOptions(q);b.searchRequest.Search.OrderBy=this.assembleOrderBy(q);b.searchRequest.Search.Expand=['Grid','Items','TotalCount'];this.addLanguagePreferences(b.searchRequest);this.addSessionId(b.searchRequest);if(q.calculateFacets){b.searchRequest.Search.Expand.push('ResultsetFacets');}return this.ajaxClient.postJson(this.getResponseUrl,b.searchRequest).then(function(i){r=i;return this.itemParser.parse(q,r.data);}.bind(this)).then(function(i){g=i;return this.facetParser.parse(q,r.data);}.bind(this)).then(function(i){return this.sina._createSearchResultSet({id:r.data.ExecutionID,title:'Search Result List',query:q,items:g.items,totalCount:g.totalCount,facets:i});}.bind(this));},executeChartQuery:function(q){var r=q.filter.rootCondition.clone();this.addTemplateConditions(r);b.chartRequest.Search.Filter=d.serialize(q.filter.dataSource,r);b.chartRequest.DataSource=e.serialize(q.filter.dataSource);b.chartRequest.Search.SearchTerms=q.filter.searchTerm;b.chartRequest.Search.Top=1;b.chartRequest.Search.Skip=0;b.chartRequest.Facets.Attributes=[q.dimension];b.chartRequest.Facets.MaxNumberOfReturnValues=q.top;b.chartRequest.Options=this.assembleRequestOptions(q);this.addLanguagePreferences(b.chartRequest);this.addSessionId(b.chartRequest);return this.ajaxClient.postJson(this.getResponseUrl,b.chartRequest).then(function(g){return this.facetParser.parse(q,g.data);}.bind(this)).then(function(g){if(g.length>0){return g[0];}return this.sina._createChartResultSet({title:q.filter.dataSource.getAttributeMetadata(q.dimension).label,items:[],query:q});}.bind(this));},executeSuggestionQuery:function(q){var g=q.filter.searchTerm;var h=f.split(this,g);var r=q.filter.rootCondition.clone();if(h.searchTerm){r.addCondition(q.sina.createSimpleCondition({attribute:'$$SearchTerms$$',value:h.searchTerm}));}r.addCondition(q.sina.createSimpleCondition({attribute:'$$SuggestionTerms$$',value:h.suggestionTerm}));b.suggestionRequest.Suggestions2.Filter=d.serialize(q.filter.dataSource,r);b.suggestionRequest.DataSource=e.serialize(q.filter.dataSource);b.suggestionRequest.Options=this.assembleSuggestionOptions(q);if(b.suggestionRequest.Options.length===0){return this.sina._createSuggestionResultSet({title:'Suggestions',query:q,items:[]});}b.suggestionRequest.Suggestions2.Top=q.top;b.suggestionRequest.Suggestions2.Skip=q.skip;this.addLanguagePreferences(b.suggestionRequest);this.addSessionId(b.suggestionRequest);return this.ajaxClient.postJson(this.getResponseUrl,b.suggestionRequest).then(function(i){var j=s.parse(this,q,i.data);f.concatenate(this,h,j);return this.sina._createSuggestionResultSet({title:'Suggestions',query:q,items:j});}.bind(this));},addSessionId:function(r){if(!this.supports('Search','SessionHandling')){delete r.SessionID;delete r.SessionTimestamp;return;}r.SessionID=this.sessionId;r.SessionTimestamp=parseInt(u.generateTimestamp(),10);},addLanguagePreferences:function(r){if(!this.supports('Search','LanguagePreferences')){delete r.LanguagePreferences;return;}r.LanguagePreferences=l.getLanguagePreferences();},assembleSuggestionOptions:function(q){var g={SearchTerm:{Data:'SuggestObjectData',History:'SuggestSearchHistory'},Object:{},DataSource:{Data:'SuggestDataSources'}};if(!this.supports('Suggestions2','ScopeTypes')){delete g.SearchTerm.History;delete g.DataSource.Data;}var o=[];var h=q.types;var k=q.calculationModes;for(var i=0;i<h.length;i++){var m=h[i];for(var j=0;j<k.length;j++){var n=k[j];var v=g[m][n];if(!v){continue;}o.push(v);}}return o;},assembleRequestOptions:function(q){var O=['SynchronousRun'];if(this.decideValueHelp(q)){O.push('ValueHelpMode');}return O;},decideValueHelp:function(q){var g=q.filter.rootCondition.conditions;for(var i=0;i<g.length;i++){if(q.filter._getAttribute(g[i])===q.dimension){return true;}}return false;},getConfigurationAsync:function(){if(!this.supports('PersonalizedSearch','SetUserStatus')){return c.Promise.resolve(this.sina._createConfiguration({personalizedSearch:false,isPersonalizedSearchEditable:false}));}return this.ajaxClient.postJson(this.getResponseUrl,b.getConfigurationRequest).then(function(r){var g={personalizedSearch:false,isPersonalizedSearchEditable:false};g.personalizedSearch=r.data.Data.PersonalizedSearch.SessionUserActive;switch(r.data.Data.PersonalizedSearch.PersonalizationPolicy){case'Opt-In':g.isPersonalizedSearchEditable=true;break;case'Opt-Out':g.isPersonalizedSearchEditable=true;break;case'Enforced':g.isPersonalizedSearchEditable=false;break;case'Disabled':g.isPersonalizedSearchEditable=false;break;}return this.sina._createConfiguration(g);}.bind(this));},saveConfigurationAsync:function(g){if(!this.supports('PersonalizedSearch','SetUserStatus')){return c.Promise.resolve();}b.saveConfigurationRequest.SearchConfiguration.Data.PersonalizedSearch.SessionUserActive=g.personalizedSearch;return this.ajaxClient.postJson(this.getResponseUrl,b.saveConfigurationRequest);},resetPersonalizedSearchDataAsync:function(){if(!this.supports('PersonalizedSearch','ResetUserData')){return c.Promise.resolve();}return this.ajaxClient.postJson(this.getResponseUrl,b.resetPersonalizedSearchDataRequest);},logUserEvent:function(g){return this.userEventLogger.logUserEvent(g);},getDebugInfo:function(){return'Searchsystem: '+this.serverInfo.ServerInfo.SystemId+' Client: '+this.serverInfo.ServerInfo.Client;}});});
