sinaDefine(['../../core/core','./typeConverter','../tools/cds/CDSAnnotationsParser'],function(c,t,C){"use strict";return c.defineClass({_init:function(p){this.provider=p;this.sina=p.sina;this.cdsAnnotationsParser=this.sina._createCDSAnnotationsParser();},fillMetadataBuffer:function(d,a){if(d.attributesMetadata[0].id!=='dummy'){return;}d.attributesMetadata=[];d.attributeMetadataMap={};var i;var b=[];var e=[];var f=[];var g=[];var p;var h;var u={};var k={dataSourceAnnotations:{},attributeAnnotations:{}};for(i=0;i<d.annotations.length;i++){k.dataSourceAnnotations[d.annotations[i].Name.toUpperCase()]=d.annotations[i].Value;}for(i=0;i<a.length;i++){h=a[i];p=this.fillPublicMetadataBuffer(d,h,u);var l=k.attributeAnnotations[p.id.toUpperCase()]={};var m=h.Annotations&&h.Annotations.results||[];var n=false,s="SEMANTICS.";for(var j=0;j<m.length;j++){l[m[j].Name]=m[j].Value;if(n||m[j].Name.substr(0,s.length)==s){n=true;}}if(h.Semantics&&!n){var o;switch(h.Semantics){case"EMAIL.ADDRESS":case"TELEPHONE.TYPE":case"CURRENCYCODE":case"UNITOFMEASURE":o="TRUE";break;case"QUANTITY.UNITOFMEASURE":case"AMOUNT.CURRENCYCODE":o=h.UnitAttribute;break;}if(o){l[s+h.Semantics]=o;}}if(p.temporaryUsage.Title!==undefined){b.push(p);}if(p.temporaryUsage.Detail!==undefined){if(h.isSummary){e.push(p);}else{f.push(p);}}}var q=this.cdsAnnotationsParser.parseCDSAnnotationsForDataSource(d,k);if(!q.dataSourceIsCdsBased){b.sort(this._createSortFunction("Title"));for(i=0;i<b.length;++i){var r=b[i].id;h=d.getAttributeMetadata(r);h.usage.Title=h.temporaryUsage.Title;h.usage.Title.displayOrder=i;}var v=this._createSortFunction("Detail");e.sort(v);f.sort(v);g.push.apply(g,e);g.push.apply(g,f);for(i=0;i<g.length;++i){g[i].usage.Detail=g[i].temporaryUsage.Detail;g[i].usage.Detail.displayOrder=i;}}for(i=0;i<d.attributesMetadata.length;i++){h=d.attributesMetadata[i];if(h.temporaryUsage){for(var w in h.temporaryUsage){if(w!="Title"&&w!="Detail"){h.usage[w]=h.temporaryUsage[w];}}}}},_createSortFunction:function(u){return function(a,b){if(a.temporaryUsage[u].displayOrder<b.temporaryUsage[u].displayOrder){return-1;}else if(a.temporaryUsage[u].displayOrder>b.temporaryUsage[u].displayOrder){return 1;}else{return 0;}};},fillPublicMetadataBuffer:function(d,a,u){var b=a.Displayed&&a.DisplayOrder?a.DisplayOrder:-1;var p=this.sina._createAttributeMetadata({id:a.Id,label:a.Name!==""?a.Name:a.Id,isKey:a.Key,isSortable:a.Sortable,usage:{},type:this.parseAttributeType(a),matchingStrategy:this.parseMatchingStrategy(a)});p.semanticObjectType=a.SemanticObjectTypeId;p.temporaryUsage=a.UIAreas?this.parseUsage(a,b):{};d.attributesMetadata.push(p);d.attributeMetadataMap[p.id]=p;return p;},parseMatchingStrategy:function(a){if(a.TextIndexed){return this.sina.MatchingStrategy.Text;}else{return this.sina.MatchingStrategy.Exact;}},parseAttributeType:function(a){for(var i=0;i<a.UIAreas.results.length;i++){var p=a.UIAreas.results[i];var b=p.Id;switch(b){case'SUMMARY':continue;case'DETAILS':continue;case'TITLE':continue;case'#HIDDEN':case'HIDDEN':continue;case'FACTSHEET':continue;case'DETAILIMAGE':case'PREVIEWIMAGE':return this.sina.AttributeType.ImageUrl;case'LONGTEXT':return this.sina.AttributeType.Longtext;default:throw new c.Exception('Unknown presentation usage '+p);}}switch(a.EDMType){case'Edm.String':case'Edm.Binary':case'Edm.Boolean':case'Edm.Byte':case'Edm.Guid':return this.sina.AttributeType.String;case'Edm.Double':case'Edm.Decimal':case'Edm.Float':return this.sina.AttributeType.Double;case'Edm.Int16':case'Edm.Int32':case'Edm.Int64':return this.sina.AttributeType.Integer;case'Edm.Time':return this.sina.AttributeType.Time;case'Edm.DateTime':if(a.TypeLength>8){return this.sina.AttributeType.Timestamp;}return this.sina.AttributeType.Date;case'GeoJson':return this.sina.AttributeType.GeoJson;default:throw new c.Exception('Unknown data type '+a.EDMType);}},parseUsage:function(a,d){var u=a.UIAreas.results;var b=a.Facet||a.AdvancedSearchRelevant;var e={};u.forEach(function(f){var i=f.Id;if(i==="TITLE"){e.Title={displayOrder:d};}if(i==="SUMMARY"||i==="DETAILIMAGE"||i==="PREVIEWIMAGE"){a.isSummary=true;e.Detail={displayOrder:d};}if(i==="DETAILS"||i==="LONGTEXT"){e.Detail={displayOrder:d};}});if(b){e.AdvancedSearch={displayOrder:d};}return e;}});});
