sinaDefine(['../../core/core','../../core/util','../../core/lang','./ajax','./conditionSerializer','./dataSourceSerializer','./FacetParser','./ItemParser','./suggestionParser','./suggestionTermSplitter','./MetadataParser'],function(c,u,l,a,b,d,F,I,S,s,M){"use strict";return c.defineClass({id:'hana_odata',_initAsync:function(e){this.requestPrefix=u.getBaseUrl(e.url)+'/es/odata/callbuildin.xsjs';this.sina=e.sina;this.ajaxClient=a.createAjaxClient();this.metadataLoadPromises={};this.internalMetadata={};this.metadataParser=new M(this);this.itemParser=new I(this);this.facetParser=new F(this);this.suggestionParser=new S(this);return this.loadServerInfo().then(function(f){this.serverInfo=f;if(!this.supports('Search')){return Promise.reject(new c.Exception('Enterprise Search is not active'));}return this.loadBusinessObjectDataSources();}.bind(this)).then(function(){if(this.sina.dataSources.length===0){return Promise.reject(new c.Exception('Enterprise Search is not active - no datasources'));}return{capabilities:this.sina._createCapabilities({fuzzy:false})};}.bind(this));},supports:function(e,f){var g=this.serverInfo.services;for(var h in g){if(h===e){if(!f){return true;}var i=g[h].Capabilities;for(var j=0;j<i.length;++j){var k=i[j];if(k===f){return true;}}}}return false;},loadServerInfo:function(){var e={rawServerInfo:{Services:[{Service:'Search',Capabilities:[{Capability:'SemanticObjectType'}]},{Service:'Suggestions2',Capabilities:[{Capability:'ScopeTypes'}]}]},services:{Suggestions:{suggestionTypes:['objectdata']},Search:{capabilities:['SemanticObjectType']}}};return Promise.resolve(e);},loadBusinessObjectDataSources:function(){var t=this;var r=this.buildQueryUrl(this.requestPrefix,"/$metadata");return this.ajaxClient.getXML(r).then(function(e){t.metadataParser.parseResponse(e).then(function(f){for(var i=0;i<f.dataSourcesList.length;++i){var g=f.dataSourcesList[i];t.metadataParser.fillMetadataBuffer(g,f.businessObjectMap[g.id]);}});});},assembleOrderBy:function(q){var r=[];for(var i=0;i<q.sortOrder.length;++i){var e=q.sortOrder[i];var f=(e.order===this.sina.SortOrder.Descending)?'desc':'asc';r.push({AttributeId:e.id,SortOrder:f});}return r;},translateOrder:function(o){var r='desc';if(o==='Ascending'){r='asc';}return r;},executeSearchQuery:function(q){var r=q.filter.rootCondition.clone();var f=b.serialize(q.filter.dataSource,r);var e=q.filter.searchTerm;var g=d.serialize(q.filter.dataSource);var t=q.top||10;var h=q.skip||0;var i=q.facetTop||5;var o=q.sortOrder;var k='';var m="Search.search(query='";if(q.filter.dataSource!==this.sina.getAllDataSource()){m+="SCOPE:"+g.Id+" ";}m+=f+" "+e+"')";var n='filter('+m+')';var p={$count:true,$top:t,$skip:h,$apply:n,whyfound:true};if(Array.isArray(o)){for(var j=0;j<o.length;j++){var v=o[j];if(j===0){k+=v.id+' '+this.translateOrder(v.order);}else{k+=','+v.id+' '+this.translateOrder(v.order);}}}if(k.length>0){p['$orderby']=k;}var w=this.buildQueryUrl(this.requestPrefix,'/$all');if(q.calculateFacets){p.facets='all';p.facetlimit=i;}var x,y;return this.ajaxClient.getJson(w,p).then(function(z){y=z;return this.itemParser.parse(q,y.data);}.bind(this)).then(function(z){x=z;var A=y.data['@com.sap.vocabularies.Search.v1.SearchStatistics'].ConnectorStatistics;if(q.getDataSource()===this.sina.getAllDataSource()&&A&&Array.isArray(A)&&A.length===1){var B=[{"@com.sap.vocabularies.Search.v1.Facet":{"PropertyName":"scope","isConnectorFacet":true},"Items":[{"scope":A[0].OdataID,"_Count":y.data["@odata.count"]}]}];return this.facetParser.parse(q,B);}return this.facetParser.parse(q,y.data['@com.sap.vocabularies.Search.v1.Facets']);}.bind(this)).then(function(z){return this.sina._createSearchResultSet({title:'Search Result List',query:q,items:x,totalCount:y.data['@odata.count']||0,facets:z});}.bind(this));},executeChartQuery:function(q){var e=q.filter.searchTerm;var f=d.serialize(q.filter.dataSource);var r=q.filter.rootCondition.clone();var g=15;var h=r.removeAttributeConditions(q.dimension);var i=h.deleted;var j=b.serialize(q.filter.dataSource,r);var t=q.top||5;var k="Search.search(query='";if(f!==this.sina.getAllDataSource()){k+="SCOPE:"+f.Id+" ";}if(i===true){k+='('+h.attribute+':EQ'+':\\"'+h.value+'*\\")'+' '+e;}else{k+=j+" "+e;}k+="')";var m='filter('+k+')';var n={$count:true,$top:0,$apply:m};var o=this.buildQueryUrl(this.requestPrefix,'/$all');var p='all';n.facetlimit=t;if(q.dimension){p=q.dimension;var v=q.filter.dataSource.getAttributeMetadata(q.dimension);if((v.type==='Double'||v.type==='Integer')&&t>=20){n.facetlimit=g;}}n.facets=p;return this.ajaxClient.getJson(o,n).then(function(w){var x=this.facetParser.parse(q,w.data['@com.sap.vocabularies.Search.v1.Facets']);return x;}.bind(this)).then(function(w){if(w.length>0){return w[0];}return this.sina._createChartResultSet({title:q.filter.dataSource.getAttributeMetadata(q.dimension).label,items:[],query:q});}.bind(this));},executeSuggestionQuery:function(q){var e={SearchTerm:{Data:'SuggestObjectData',History:'SuggestSearchHistory'},Object:{},DataSource:{Data:'SuggestDataSources'}};var f=q.types;var g=q.calculationModes;var h=c.Promise.resolve({items:[]});for(var i=0;i<f.length;i++){var k=f[i];for(var j=0;j<g.length;j++){var m=g[j];var v=e[k][m];switch(v){case"SuggestObjectData":return this._fireSuggestionQuery(q);default:return h;}}}},_fireSuggestionQuery:function(q){var e=q.filter.searchTerm;var f=s.split(this,e);var g="GetSuggestion(term='";if(q.filter.dataSource!==this.sina.getAllDataSource()){g+="SCOPE:"+q.filter.dataSource.id+" ";}g+=e+"')";var h={};var i=this.buildQueryUrl(this.requestPrefix,'/$all/'+g);return this.ajaxClient.getJson(i,h).then(function(r){var j=[];if(r.data.value){j=this.suggestionParser.parse(q,r.data.value);}s.concatenate(this,f,j);return this.sina._createSuggestionResultSet({title:'Suggestions',query:q,items:j});}.bind(this));},getFilterValueFromConditionTree:function(e,f){if(f.ConditionAttribute&&f.ConditionAttribute===e){return f.ConditionValue;}else if(f.SubFilters){var i;var r=null;for(i=0;r===null&&i<f.SubFilters.length;i++){r=this.getFilterValueFromConditionTree(e,f.SubFilters[i]);}return r;}return null;},logUserEvent:function(e){},buildQueryUrl:function(q,e){var r=q+'/v5'+e;return r;},getDebugInfo:function(){return' SinaProvider :'+this.id;}});});
