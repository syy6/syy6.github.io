sinaDefine(['../../core/core','../../core/util','./pivotTableParser','./typeConverter','../tools/fiori/FioriIntentsResolver','../../sina/NavigationTarget'],function(c,u,p,t,I,N){"use strict";return c.defineClass({_init:function(a){this.provider=a;this.sina=a.sina;this.intentsResolver=this.sina._createFioriIntentsResolver();},parse:function(s,d){var a=this.parseTotalCount(d);d=p.parse(d);if(d.axes.length===0){return Promise.resolve({totalCount:0,items:[]});}var b=d.axes[0];var e=[];for(var i=0;i<b.length;++i){var f=b[i];this.provider.metadataParser.parseSearchRequestMetadata(f);var g=this.parseItem(f);e.push(g);}return Promise.all(e).then(function(h){return{totalCount:a,items:h};}.bind(this));},parseTotalCount:function(d){if(d.ItemLists&&d.ItemLists[0]&&d.ItemLists[0].TotalCount){return d.ItemLists[0].TotalCount.Value;}return 0;},parseItem:function(a){var b=[];var d=[];var s=[];var e=this.sina.getDataSource(a.$$DataSourceMetaData$$[0].ObjectName);for(var m=0;m<a.$$ResultItemAttributes$$.length;++m){var f=a.$$ResultItemAttributes$$[m];var g=e.getAttributeMetadata(f.Name);var h=this.sina._createSearchResultSetItemAttribute({id:f.Name,label:e.getAttributeMetadata(f.Name).label,value:t.ina2Sina(g.type,f.Value),valueFormatted:f.ValueFormatted||f.Value,valueHighlighted:f.ValueFormatted||f.Value,isHighlighted:false,metadata:g});if(g.usage.Title){b.push(h);}if(g.usage.Detail){d.push(h);}for(var i=0;i<a.$$AttributeMetadata$$.length;i++){var l=a.$$AttributeMetadata$$[i];if(l.Name==f.Name){if(l.SemanticObjectType&&l.SemanticObjectType.length>0){s.push({name:l.SemanticObjectType,value:h.value,type:h.metadata.type});}break;}}}b.sort(function(B,C){return B.metadata.usage.Title.displayOrder-C.metadata.usage.Title.displayOrder;});d.sort(function(B,C){return B.metadata.usage.Detail.displayOrder-C.metadata.usage.Detail.displayOrder;});this.parseWhyFound(e,b,d,a);var n=[];var o=[];for(var j=0;j<b.length;++j){var q=b[j];n.push(q.valueFormatted);o.push(q.valueHighlighted);}n=n.join(' ');o=o.join(' ');var r;for(var k=0;k<a.$$RelatedActions$$.length;++k){var v=a.$$RelatedActions$$[k];if(v.Type==="GeneralUri"||v.Type==="SAPNavigation"){var w=v.Description;var x=encodeURI(v.Uri);r=this.sina._createNavigationTarget({label:w,targetUrl:x});}}var y=a.$$DataSourceMetaData$$[0].SemanticObjectType;var z=a.$$DataSourceMetaData$$[0].SystemId;var A=a.$$DataSourceMetaData$$[0].Client;return this.intentsResolver.resolveIntents({semanticObjectType:y,semanticObjectTypeAttributes:s,systemId:z,client:A,fallbackDefaultNavigationTarget:r}).then(function(B){var C=B&&B.defaultNavigationTarget;var D=B&&B.navigationTargets;var E=this.sina._createSearchResultSetItem({dataSource:e,title:n,titleHighlighted:o,titleAttributes:b,detailAttributes:d,defaultNavigationTarget:C,navigationTargets:D});return E;}.bind(this));},parseWhyFound:function(d,a,b,e){var i,w,f,j,g;for(i=0;i<e.$$WhyFound$$.length;i++){w=e.$$WhyFound$$[i];f=this.getResponseAttributeId(d,w.Name);for(j=0;j<a.length;++j){g=a[j];if(f===g.id){w.matched=true;g.valueHighlighted=w.Value;g.isHighlighted=true;break;}}for(j=0;j<b.length;++j){g=b[j];if(f===g.id){w.matched=true;g.valueHighlighted=w.Value;g.isHighlighted=true;break;}}}for(i=0;i<e.$$WhyFound$$.length;i++){w=e.$$WhyFound$$[i];if(w.matched){continue;}f=this.getResponseAttributeId(d,w.Name);var m=d.getAttributeMetadata(f);if(!m){throw new c.Exception('metadata misssing for '+f);}g=this.sina._createSearchResultSetItemAttribute({id:m.id,label:m.label,value:null,valueFormatted:u.filterString(w.Value,['<b>','</b>']),valueHighlighted:w.Value,isHighlighted:true,metadata:m});b.push(g);}},getResponseAttributeId:function(d,r){var a=this.provider.getInternalMetadataAttribute(d,r);if(!a){return r;}var b=this.provider.getInternalMetadataAttribute(d,a.correspondingSearchAttributeName);if(!b){return r;}return b.Name;}});});
