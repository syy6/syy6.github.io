sinaDefine(['../../core/core','../../core/util','../../core/lang','./ajax','./ajaxTemplates','./conditionSerializer','./dataSourceSerializer','./FacetParser','./ItemParser','./NlqParser','./suggestionParser','./suggestionTermSplitter','./LabelCalculator','./UserEventLogger','./MetadataParser'],function(c,u,l,a,b,d,e,F,I,N,S,s,L,U,M){"use strict";return c.defineClass({id:'abap_odata',_initAsync:function(f){this.requestPrefix='/sap/opu/odata/sap/ESH_SEARCH_SRV';this.sina=f.sina;this.ajaxClient=a.createAjaxClient();this.metadataLoadPromises={};this.internalMetadata={};this.labelCalculator=new L();this.userEventLogger=new U(this);this.metadataParser=new M(this);this.itemParser=new I(this);this.nlqParser=new N(this);this.facetParser=new F(this);this.suggestionParser=new S(this,this.itemParser);this.sessionId=c.generateGuid();return this.loadServerInfo().then(function(g){this.serverInfo=g.d.results[0];if(!this.supports('Search')){return Promise.reject(new c.Exception('Enterprise Search is not active'));}return this.loadBusinessObjectDataSources();}.bind(this)).then(function(){return{capabilities:this.sina._createCapabilities({fuzzy:false})};}.bind(this));},supports:function(f,g){for(var i=0;i<this.serverInfo.Services.results.length;++i){var h=this.serverInfo.Services.results[i];if(h.Id==f){if(!g){return true;}for(var j=0;j<h.Capabilities.length;++j){var k=h.Capabilities[j];if(k.Capability===g){return true;}}}}return false;},loadServerInfo:function(){var r=this.buildQueryUrl(this.requestPrefix,"/ServerInfos?$expand=Services/Capabilities");var f=this.buildQueryUrl(this.requestPrefix,"/$metadata");var g=this.ajaxClient.getJson(r);var m=this.ajaxClient.getXML(f);return Promise.all([g,m]).then(function(v){var h=v[0];var i=v[1];var p=new DOMParser();var D=p.parseFromString(i,"text/xml");if(D.documentElement.nodeName!="parsererror"){this.serviceXML=D;}return h.data;}.bind(this));},loadBusinessObjectDataSources:function(){var r="/DataSources?$expand=Annotations,Attributes/UIAreas,Attributes/Annotations&$filter=Type eq 'View'";if(this.serviceXML){var f="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSource]>NavigationProperty[Name=Annotations],"+"Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSourceAttribute]>NavigationProperty[Name=Annotations]";var g=this.serviceXML.querySelectorAll(f);if(g.length!=2){r="/DataSources?$expand=Attributes/UIAreas&$filter=Type eq 'View'";}var h="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=DataSource]>Property[Name=IsInternal]";g=this.serviceXML.querySelectorAll(h);if(g.length>0){r=r+" and IsInternal eq false";}var j="Schema[Namespace=ESH_SEARCH_SRV]>EntityType[Name=SearchOptions]>Property[Name=ClientServiceName]";g=this.serviceXML.querySelectorAll(j);if(g.length===0){delete b.searchRequest.d.QueryOptions.ClientServiceName;delete b.nlqSearchRequest.d.QueryOptions.ClientServiceName;}}var k=this.buildQueryUrl(this.requestPrefix,r);return this.ajaxClient.getJson(k).then(function(m){var n=m.data.d.results;for(var i=0;i<n.length;++i){var o=n[i];var p=this.sina._createDataSource({id:o.Id,label:o.Name,labelPlural:o.NamePlural,type:this.sina.DataSourceType.BusinessObject,attributesMetadata:[{id:'dummy'}]});p.system=o.SourceSystem;p.client=o.SourceClient;p.sematicObjectType=o.SemanticObjectTypeId;p.annotations=o.Annotations&&o.Annotations.results||[];this.labelCalculator.calculateLabel(p);this.metadataParser.fillMetadataBuffer(p,o.Attributes.results);}}.bind(this));},assembleOrderBy:function(q){var r=[];for(var i=0;i<q.sortOrder.length;++i){var f=q.sortOrder[i];var g=(f.order===this.sina.SortOrder.Descending)?'desc':'asc';r.push({AttributeId:f.id,SortOrder:g});}return r;},executeSearchQuery:function(q){var i,r;var f=b.searchRequest;if(q.nlq){f=b.nlqSearchRequest;}f=JSON.parse(JSON.stringify(f));var g=q.filter.rootCondition.clone();var h=d.serialize(q.filter.dataSource,g);if(h.SubFilters.length!==0){f.d.Filter=h;}else{delete f.d.Filter;}f.d.DataSources=[e.serialize(q.filter.dataSource)];f.d.QueryOptions.SearchTerms=q.filter.searchTerm;f.d.QueryOptions.Top=q.top;f.d.QueryOptions.Skip=q.skip;f.d.OrderBy=this.assembleOrderBy(q);this.addSessionId(f);if(!q.calculateFacets){delete f.d.MaxFacetValues;delete f.d.Facets;}else{f.d.MaxFacetValues=5;f.d.Facets=[{"Values":[]}];}var j=this.buildQueryUrl(this.requestPrefix,"/SearchQueries");return this.ajaxClient.postJson(j,f).then(function(k){r=k;return this.itemParser.parse(q,r.data.d);}.bind(this)).then(function(k){i=k;return this.facetParser.parse(q,r.data.d);}.bind(this)).then(function(k){var n=this.nlqParser.parse(r.data.d);var t=n.success?n.description:'Search Result List';return this.sina._createSearchResultSet({id:r.data.d.ResultList.ExecutionID,title:t,query:q,items:i,nlqSuccess:n.success,totalCount:r.data.d.ResultList.TotalHits,facets:k});}.bind(this));},executeChartQuery:function(q){var r="";var f={};var g=q.filter.rootCondition.clone();var h;if(this.decideValueHelp(q)){f=JSON.parse(JSON.stringify(b.valueHelperRequest));f.d.ValueHelpAttribute=q.dimension;h=d.serialize(q.filter.dataSource,g);if(h.SubFilters.length!==0){f.d.Filter=h;}else{delete f.d.Filter;}f.d.ValueFilter=this.getFilterValueFromConditionTree(q.dimension,h);f.d.QueryOptions.SearchTerms=q.filter.searchTerm;f.d.DataSources=[e.serialize(q.filter.dataSource)];r=this.buildQueryUrl(this.requestPrefix,"/ValueHelpQueries");}else{f=JSON.parse(JSON.stringify(b.chartRequest));h=d.serialize(q.filter.dataSource,g);if(h.SubFilters.length!==0){f.d.Filter=h;}else{delete f.d.Filter;}f.d.DataSources=[e.serialize(q.filter.dataSource)];f.d.QueryOptions.SearchTerms=q.filter.searchTerm;f.d.QueryOptions.Skip=0;this.addSessionId(f);f.d.FacetRequests=[{DataSourceAttribute:q.dimension}];f.d.MaxFacetValues=q.top;r=this.buildQueryUrl(this.requestPrefix,"/SearchQueries");}return this.ajaxClient.postJson(r,f).then(function(i){return this.facetParser.parse(q,i.data.d);}.bind(this),function(i){return[];}).then(function(i){if(i.length>0){return i[0];}return this.sina._createChartResultSet({title:q.filter.dataSource.getAttributeMetadata(q.dimension).label,items:[],query:q});}.bind(this));},decideValueHelp:function(q){var f=q.filter.rootCondition.conditions;for(var i=0;i<f.length;i++){if(q.filter._getAttribute(f[i])===q.dimension){return true;}}return false;},executeSuggestionQuery:function(q){return c.Promise.all([this.executeRegularSuggestionQuery(q),this.executeObjectSuggestionQuery(q)]).then(function(r){var f=[];f.push.apply(f,r[1]);f.push.apply(f,r[0]);return this.sina._createSuggestionResultSet({title:'Suggestions',query:q,items:f});}.bind(this));},isObjectSuggestionQuery:function(q){return q.types.indexOf('Object')>=0&&q.filter.dataSource.type===q.sina.DataSourceType.BusinessObject;},executeObjectSuggestionQuery:function(q){if(!this.isObjectSuggestionQuery(q)){return c.Promise.resolve([]);}var r=JSON.parse(JSON.stringify(b.objectSuggestionRequest));var f=q.filter.rootCondition.clone();var g=d.serialize(q.filter.dataSource,f);if(g.SubFilters.length!==0){r.d.Filter=g;}else{delete r.d.Filter;}r.d.DataSources=[e.serialize(q.filter.dataSource)];r.d.QueryOptions.Top=q.top;r.d.QueryOptions.Skip=q.skip;r.d.QueryOptions.SearchTerms=q.filter.searchTerm;this.addSessionId(r);var h=this.buildQueryUrl(this.requestPrefix,"/SuggestionsQueries");return this.ajaxClient.postJson(h,r).then(function(i){return this.suggestionParser.parseObjectSuggestions(q,i.data);}.bind(this));},executeRegularSuggestionQuery:function(q){var r=JSON.parse(JSON.stringify(b.suggestionRequest));var f=q.filter.searchTerm;var g=s.split(this,f);var h=q.filter.rootCondition.clone();var i=d.serialize(q.filter.dataSource,h);if(i.SubFilters.length!==0){r.d.Filter=i;}else{delete r.d.Filter;}r.d.DataSources=[e.serialize(q.filter.dataSource)];r.d.QueryOptions.Top=q.top;r.d.QueryOptions.Skip=q.skip;r.d.SuggestionInput=g.suggestionTerm;r.d.QueryOptions.SearchTerms=g.searchTerm===null?"":g.searchTerm;if(!this.includeSuggestionTypes(q,r)){return[];}this.addSessionId(r);var j=this.buildQueryUrl(this.requestPrefix,"/SuggestionsQueries");return this.ajaxClient.postJson(j,r).then(function(k){return this.suggestionParser.parseRegularSuggestions(q,k.data);}.bind(this)).then(function(k){s.concatenate(this,g,k);return k;}.bind(this));},includeSuggestionTypes:function(q,f){var g={SearchTerm:{Data:'IncludeAttributeSuggestions',History:'IncludeHistorySuggestions'},Object:{},DataSource:{Data:'IncludeDataSourceSuggestions'}};var h=q.types;var k=q.calculationModes;var m=false;for(var i=0;i<h.length;i++){var n=h[i];for(var j=0;j<k.length;j++){var o=k[j];var v=g[n][o];if(typeof v==='undefined'){continue;}f.d[v]=true;m=true;}}return m;},addSessionId:function(r){r.d.QueryOptions.ClientSessionID=this.sessionId;var t=new Date().getTime();r.d.QueryOptions.ClientCallTimestamp="\\/Date("+t+")\\/";},getFilterValueFromConditionTree:function(f,g){if(g.ConditionAttribute&&g.ConditionAttribute===f){return g.ConditionValue;}else if(g.SubFilters){var i;var r=null;for(i=0;r===null&&i<g.SubFilters.length;i++){r=this.getFilterValueFromConditionTree(f,g.SubFilters[i]);}return r;}return null;},getConfigurationAsync:function(){var r=this.buildQueryUrl(this.requestPrefix,"/PersonalizedSearchMainSwitches?$filter=Selected eq true");return this.ajaxClient.getJson(r).then(function(f){var g={personalizedSearch:false,isPersonalizedSearchEditable:false};switch(f.data.d.results[0].MainSwitch){case 3:g.isPersonalizedSearchEditable=true;break;case 4:g.isPersonalizedSearchEditable=true;break;case 2:g.isPersonalizedSearchEditable=false;break;case 1:g.isPersonalizedSearchEditable=false;break;}r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.getJson(r).then(function(f){if(f.data.d.IsEnabledForPersonalizedSearch){g.personalizedSearch=true;}return this.sina._createConfiguration(g);}.bind(this));}.bind(this));},saveConfigurationAsync:function(f){var g={"IsEnabledForPersonalizedSearch":f.personalizedSearch};var r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.mergeJson(r,g);},resetPersonalizedSearchDataAsync:function(){var f={"ClearPersonalizedSearchHistory":true};var r=this.buildQueryUrl(this.requestPrefix,"/Users('<current>')");return this.ajaxClient.mergeJson(r,f);},logUserEvent:function(f){return this.userEventLogger.logUserEvent(f);},buildQueryUrl:function(q,f){var w=window.location.href;var r="";var g="";var h="";var i="";g=w.indexOf("esh-system=sid(");if(g!==-1){var j=w.substring(g).indexOf(")");if(j!==-1){h=w.substring(g+15,g+j);if(h.length!==0){i=";o=sid("+h+")";}}}if(h.length===0){g=w.indexOf("esh-system=");if(g!==-1){var k=w.substring(g).indexOf("&");var m=w.substring(g).indexOf("#");if(k!==-1&&m!==-1){if(k<m){h=w.substring(g+11,g+k);}else{h=w.substring(g+11,g+m);}}if(k!==-1&&m===-1){h=w.substring(g+11,g+k);}if(k===-1&&m!==-1){h=w.substring(g+11,g+m);}if(k===-1&&m===-1){h=w.substring(g+11);}}if(h.length!==0){i=";o="+h;}}r=q+i+f;return r;},getDebugInfo:function(){return'Searchsystem: '+this.serverInfo.SystemId+' Client: '+this.serverInfo.Client+' SinaProvider :'+this.id;}});});
