sinaDefine(['../../core/core','../../core/util','./typeConverter','../tools/fiori/FioriIntentsResolver','../../sina/NavigationTarget'],function(c,u,t,I,N){"use strict";return c.defineClass({_init:function(p){this.provider=p;this.sina=p.sina;this.intentsResolver=this.sina._createFioriIntentsResolver();this.suvNavTargetResolver=this.sina._createSuvNavTargetResolver();},parse:function(s,d){if(d.ResultList.SearchResults===null){return Promise.resolve([]);}var i=d.ResultList.SearchResults.results;return this.parseItems(i);},parseItems:function(a){var b=[];for(var i=0;i<a.length;++i){var d=a[i];var e=this.parseItem(d);b.push(e);}return Promise.all(b);},parseItem:function(a){var i,j,k,m;var b={};var d=[];var e="";var f=[];var g,h,s,l,n,o;var p={};var q=[];var r=[];var v={};var w=[];var x=[];var y;var z=this.sina.getDataSource(a.DataSourceId);var A,B,C,D;var E=[];var F={};var G=a.Score/100;var H;for(j=0;j<a.Attributes.results.length;j++){A=a.Attributes.results[j];B=z.getAttributeMetadata(A.Id);C=this.sina._createSearchResultSetItemAttribute({id:A.Id,label:B.label,value:t.odata2Sina(B.type,A.Value),valueFormatted:A.ValueFormatted||"",valueHighlighted:A.Snippet||A.ValueFormatted||"",isHighlighted:A.Snippet.indexOf("<b>")>-1&&A.Snippet.indexOf("</b>")>-1,metadata:B});u.appendRemovingDuplicates(E,u.extractHighlightedTerms(C.valueHighlighted));if(B.isUnitOfMeasure||B.isCurrency){p[A.Id]=C;continue;}if(B.unitOfMeasureAttribute){h=p[B.unitOfMeasureAttribute.id];if(h){C.unitOfMeasure=h;}else{q.push(C);}}if(B.descriptionAttribute){g=b[B.descriptionAttribute.id];if(g){C.description=g;}else{r.push(C);}}if(B.suvUrlAttribute&&B.suvMimeTypeAttribute){n=b[B.suvUrlAttribute]||B.suvUrlAttribute.id;o=b[B.suvMimeTypeAttribute]||B.suvMimeTypeAttribute.id;v[A.Id]={suvThumbnailAttribute:C,suvTargetUrlAttribute:n,suvTargetMimeTypeAttribute:o};}if(B.usage.Navigation){if(B.usage.Navigation.mainNavigation){y=this.sina._createNavigationTarget({label:C.value,targetUrl:C.value});}}if(B.group){var J=F[B.group.id];if(!J){J=this.sina._createSearchResultSetItemAttributeGroup({id:B.group.id,metadata:B.group,label:B.group.label,template:B.group.template,attributes:{}});F[B.group.id]=J;if(B.group.usage.Detail){f.push(J);}if(B.group.usage.Title){d.push(J);}}J.attributes[B.nameInGroup]=C;C.group=J;C.nameInGroup=B.nameInGroup;}else{if(B.usage.Detail){f.push(C);}if(!B.usage.Title&&!B.usage.Detail&&!B.isDescription&&(C.isHighlighted||(C.descriptionAttribute&&C.descriptionAttribute.isHighlighted))){w.push(C);}}if(B.usage.Title){d.push(C);}if(B.usage.TitleDescription){e=C.valueHighlighted;}b[C.id]=C;D=z.attributeMetadataMap[C.id].semanticObjectType;if(D.length>0){x.push({name:D,value:C.value,type:C.metadata.type});}}for(i=0;i<q.length;i++){C=q[i];B=z.getAttributeMetadata(C.id);if(B.unitOfMeasureAttribute){h=p[B.unitOfMeasureAttribute.id];if(h){C.unitOfMeasure=h;}}}for(i=0;i<r.length;i++){C=r[i];B=z.getAttributeMetadata(C.id);if(B.descriptionAttribute){g=b[B.descriptionAttribute.id];if(g){C.description=g;}}}for(l in v){s=v[l];if(typeof s.suvTargetUrlAttribute=="string"){s.suvTargetUrlAttribute=b[s.suvTargetUrlAttribute];}if(typeof s.suvTargetMimeTypeAttribute=="string"){s.suvTargetMimeTypeAttribute=b[s.suvTargetMimeTypeAttribute];}if(!(s.suvTargetUrlAttribute||s.suvTargetMimeTypeAttribute)){delete v[l];}}d.sort(function(Q,R){return Q.metadata.usage.Title.displayOrder-R.metadata.usage.Title.displayOrder;});f.sort(function(Q,R){return Q.metadata.usage.Detail.displayOrder-R.metadata.usage.Detail.displayOrder;});if(a.HitAttributes!==null){for(k=0;k<a.HitAttributes.results.length;k++){A=a.HitAttributes.results[k];B=z.getAttributeMetadata(A.Id);H=t.odata2Sina(B.type,u.filterString(A.Snippet,['<b>','</b>']));C=this.sina._createSearchResultSetItemAttribute({id:A.Id,label:B.label,value:H,valueFormatted:H,valueHighlighted:A.Snippet,isHighlighted:A.Snippet.indexOf("<b>")>-1&&A.Snippet.indexOf("</b>")>-1,metadata:B});u.appendRemovingDuplicates(E,u.extractHighlightedTerms(C.valueHighlighted));w.push(C);}}f=f.concat(w);var K=[];var L=[];for(m=0;m<d.length;m++){var M=d[m];K.push(M.valueFormatted);L.push(M.valueHighlighted);}K=K.join(' ');L=L.join(' ');this.suvNavTargetResolver.resolveSuvNavTargets(z,v,E);D=z.sematicObjectType;var O=z.system;var P=z.client;return this.intentsResolver.resolveIntents({semanticObjectType:D,semanticObjectTypeAttributes:x,systemId:O,client:P,fallbackDefaultNavigationTarget:y}).then(function(Q){var R=Q&&Q.defaultNavigationTarget;var S=Q&&Q.navigationTargets;return this.sina._createSearchResultSetItem({dataSource:z,title:K,titleHighlighted:L,titleAttributes:d,titleDescription:e,detailAttributes:f,defaultNavigationTarget:R,navigationTargets:S,score:G});}.bind(this));}});});
