sap.ui.define(["sap/ui/core/mvc/Controller",'sap/ushell/renderers/fiori2/search/SearchResultListFormatter',"sap/ui/export/Spreadsheet"],function(C,S,c){"use strict";return C.extend("sap.ui.export.sample.table.Spreadsheet",{onExport:function(){var t=this;t.exportData={columns:[],rows:[]};if(t.table===undefined){t.table=sap.ui.getCore().byId('ushell-search-result-table');t.model=t.table.getModel();}sap.ui.getCore().byId('dataExportButton').setEnabled(false);var e=t.model.query.clone();e.setCalculateFacets(false);e.setTop(1000);var s=function(b){t._parseColumns(b.items[0]);var f=new S();var d=f.format(b,e.filter.searchTerm,{suppressHighlightedValues:true});for(var i=0;i<d.length;i++){b.items[i].title=d[i].title;b.items[i].titleDescription=d[i].titleDescription;}t._parseRows(b.items);t._doExport();};var a=function(b){t.model.normalSearchErrorHandling(b);sap.ui.getCore().byId('dataExportButton').setEnabled(true);};if(t.model.getProperty("/boCount")>1000){sap.m.MessageBox.information(sap.ushell.resources.i18n.getText("exportDataInfo"),{actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(A){if(A==sap.m.MessageBox.Action.OK){e.getResultSetAsync().then(s,a);}if(A==sap.m.MessageBox.Action.CANCEL){sap.ui.getCore().byId('dataExportButton').setEnabled(true);}}});}else{e.getResultSetAsync().then(s,a);}},_parseColumns:function(f){var t=this;var e=[];e.push({label:f.dataSource.labelPlural,property:'title_export_column',type:'string'});e.push({label:sap.ushell.resources.i18n.getText("titleDescription"),property:'title_description_export_column',type:'string'});var d=f.detailAttributes;if(t.model.getProperty("/resultToDisplay")==="searchResultList"){var l=0;for(var i=0;i<d.length&&l<12;i++){e=e.concat(t._getRelatedColumns(d[i]));l++;}}else{var v=[];t.table.getColumns().forEach(function(a){if(a.getVisible()){v.push(a);}});v.sort(function(a,b){if(a.getOrder()<b.getOrder())return-1;if(a.getOrder()>b.getOrder())return 1;return 0;});v.forEach(function(a){var b=a.getBindingContext().getObject().attributeId;for(var i=0;i<d.length;i++){if(d[i].id===b){e=e.concat(t._getRelatedColumns(d[i]));}}});}t.exportData.columns=e;},_getRelatedColumns:function(a){var t=this;var b=[];if(a.value){b.push(t._getColumn(a));if(a.unitOfMeasure){b.push(t._getColumn(a.unitOfMeasure));}if(a.description){b.push(t._getColumn(a.description));}}if(a.attributes){Object.values(a.attributes).forEach(function(s){b.push(t._getColumn(s));});}return b;},_getColumn:function(a){var t=this;var b={label:a.label,property:a.id};if(a.metadata.type===undefined){b.type='string';return b;}switch(a.metadata.type){case t.model.sinaNext.AttributeType.Double:b.type='number';b.scale=2;break;case t.model.sinaNext.AttributeType.Integer:b.type='number';b.scale=0;break;default:b.type='string';}return b;},_parseRows:function(s){var t=this;var e=[];s.forEach(function(r){var a=r.detailAttributes;var b={};b["title_export_column"]=r.title;b["title_description_export_column"]=r.titleDescription;for(var i=0;i<a.length;i++){b=t._getRelatedValues(b,a[i]);}e.push(b);});t.exportData.rows=e;},_getRelatedValues:function(r,a){if(a.value){r[a.id]=a.value;if(a.unitOfMeasure){r[a.unitOfMeasure.id]=a.unitOfMeasure.value;}if(a.description){r[a.description.id]=a.description.value;}}if(a.attributes){Object.values(a.attributes).forEach(function(s){r[s.id]=s.value;});}return r;},_doExport:function(){var t=this;var s={workbook:{columns:t.exportData.columns},dataSource:t.exportData.rows};new c(s).build().then(function(){sap.ui.getCore().byId('dataExportButton').setEnabled(true);},function(){sap.ui.getCore().byId('dataExportButton').setEnabled(true);});}});});
