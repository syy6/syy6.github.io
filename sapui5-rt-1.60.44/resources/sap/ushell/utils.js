// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/theming/Parameters","sap/ui/thirdparty/URI","sap/ushell/utils/clone","sap/ushell/utils/type","sap/ui/Device"],function(P,U,c,t,D){"use strict";var u={};u.isArray=t.isArray;u.isPlainObject=t.isPlainObject;u.isDefined=t.isDefined;u.clone=c;u.getMember=function(o,a){var p=a.split("."),n=o;if(!o){return undefined;}p.forEach(function(s){if(typeof n!=="object"){return undefined;}n=n[s.replace(/[|]/g,".")];});return n;};u.setPerformanceMark=function(m,C){if(performance&&performance.mark){if(!C){C={};}if(C.bUseUniqueMark){if(C.bUseLastMark){performance.clearMarks(m);}else if(performance.getEntriesByName(m,"mark").length!=0){return;}}performance.mark(m);}};u.setPerformanceMeasure=function(m){if(performance&&performance.measure){performance.measure(m);}};u.addTime=function(i,I,e){if(!window["sap-ushell-startTime"]){window["sap-ushell-startTime"]=Date.now();}var s=window["sap-ushell-startTime"];e=e||Date.now();if(e<s){e=s+1;}jQuery.sap.measure.add("sap.ushell.fromStart."+i,I,s,e,e-s,e-s);};u.Error=function(m,C){this.name="sap.ushell.utils.Error";this.message=m;jQuery.sap.log.error(m,null,C);};u.Error.prototype=new Error();u.localStorageSetItem=function(k,v,l){var E;try{localStorage.setItem(k,v);if(l){E=document.createEvent("StorageEvent");E.initStorageEvent("storage",false,false,k,"",v,"",localStorage);dispatchEvent(E);}}catch(e){jQuery.sap.log.warning("Error calling localStorage.setItem(): "+e,null,"sap.ushell.utils");}};u.getLocalStorage=function(){return window.localStorage;};u.getLocalStorageItem=function(k){return window.localStorage.getItem(k);};u.generateUniqueId=function(T){var s,e,i;if(jQuery.isArray(T)){e=T;i=function(g){return e.indexOf(g)===-1;};}else{i=T;}do{s=jQuery.sap.uid();}while(!i(s));return s;};u.reload=function(){location.reload();};u.calculateOrigin=function(d){var o;if(d.origin){return d.origin;}if(d.protocol&&d.hostname){return d.protocol+"//"+d.hostname+(d.port?':'+d.port:'');}if(d.href){o=new U(d.href);return o.protocol()+"://"+o.hostname()+(o.port()?':'+o.port():'');}};u.getPrivateEpcm=function(){if(window.external&&window.external&&typeof window.external.getPrivateEpcm!=="undefined"){return window.external.getPrivateEpcm();}return undefined;};u.hasNativeNavigationCapability=function(){return u.isFeatureBitEnabled(1);};u.hasNativeLogoutCapability=function(){return u.isFeatureBitEnabled(2);};u.hasNavigationModeCapability=function(){return u.isFeatureBitEnabled(4);};u.isFeatureBitEnabled=function(f){var F="0",p;p=u.getPrivateEpcm();if(p){try{F=p.getNwbcFeatureBits();jQuery.sap.log.debug("Detected epcm getNwbcFeatureBits returned feature bits: "+F);}catch(e){jQuery.sap.log.error("failed to get feature bit vector via call getNwbcFeatureBits on private epcm object",e.stack,"sap.ushell.utils");}}return(parseInt(F,16)&f)>0;};u.isApplicationTypeEmbeddedInIframe=function(a){return a==="NWBC"||a==="TR"||a==="WCF";};u.appendUserIdToUrl=function(p,s){var a=sap.ushell.Container.getService("UserInfo").getUser().getId(),S=s.indexOf("?")>=0?"&":"?";return s+S+p+"="+a;};u.isNativeWebGuiNavigation=function(r){if(this.hasNativeNavigationCapability()&&r&&r.applicationType==="TR"){return true;}return false;};u.Map=function(){this.entries={};};u.Map.prototype.put=function(k,v){var o=this.get(k);this.entries[k]=v;return o;};u.Map.prototype.containsKey=function(k){if(typeof k!=="string"){throw new u.Error("Not a string key: "+k,"sap.ushell.utils.Map");}return Object.prototype.hasOwnProperty.call(this.entries,k);};u.Map.prototype.get=function(k){if(this.containsKey(k)){return this.entries[k];}};u.Map.prototype.keys=function(){return Object.keys(this.entries);};u.Map.prototype.remove=function(k){delete this.entries[k];};u.Map.prototype.toString=function(){var r=['sap.ushell.utils.Map('];r.push(JSON.stringify(this.entries));r.push(')');return r.join('');};u.getParameterValueBoolean=function(p,s){var a=jQuery.sap.getUriParameters(s).mParams&&jQuery.sap.getUriParameters(s).mParams[p],T=["true","x"],f=["false",""],v;if(!a||a.length===0){return undefined;}v=a[0].toLowerCase();if(T.indexOf(v)>=0){return true;}if(f.indexOf(v)>=0){return false;}return undefined;};u.call=function(s,f,a){var m;if(a){setTimeout(function(){u.call(s,f,false);},0);return;}try{s();}catch(e){m=e.message||e.toString();jQuery.sap.log.error("Call to success handler failed: "+m,e.stack,"sap.ushell.utils");if(f){f(m);}}};u.handleTilesVisibility=function(){u.getVisibleTiles();};u.refreshTiles=function(){var e=sap.ui.getCore().getEventBus();e.publish("launchpad","refresTiles");};u.setTilesNoVisibility=function(){var e=sap.ui.getCore().getEventBus();e.publish("launchpad","setTilesNoVisibility");};u.getBasicHash=function(h){if(!u.validHash(h)){jQuery.sap.log.debug("Utils ; getBasicHash ; Got invalid hash");return false;}var o=sap.ushell.Container.getService("URLParsing"),s=o.parseShellHash(h);return s?s.semanticObject+"-"+s.action:h;};u.validHash=function(h){return(h&&h.constructor===String&&jQuery.trim(h)!=="");};u.handleTilesOpacity=function(m){var T,a,b,C=P.get("sapUshellTileBackgroundColor"),r=this.hexToRgb(C),j,d,R,e,s,f,o,p,g,h,i,k=sap.ushell.Container.getService("UserRecents");if(r){R="rgba("+r.r+","+r.g+","+r.b+",{0})";b=k.getAppsUsage();b.done(function(l){T=l.usageMap;j=jQuery('.sapUshellTile').not('.sapUshellTileFooter');var n=m.getProperty("/groups");m.setProperty('/animationRendered',true);for(i=0;i<j.length;i++){e=jQuery(j[i]);s=this.getBasicHash(e.find('.sapUshellTileBase').attr('data-targeturl'));if(s){d=this.convertToRealOpacity(T[s],l.maxUsage);f=R.replace("{0}",d);a=sap.ui.getCore().byId(e.attr('id'));o=a.getBindingContext();p=o.sPath.split('/');g=p[2];h=p[4];n[g].tiles[h].rgba=f;}}m.setProperty("/groups",n);}.bind(this));}};u.convertToRealOpacity=function(a,m){var o=[1,0.95,0.9,0.85,0.8],O=Math.floor(m/o.length),i;if(!a){return o[0];}if(!m){return o[o.length-1];}i=Math.floor((m-a)/O);return i<o.length?o[i]:o[o.length-1];};u.getCurrentHiddenGroupIds=function(m){var l=sap.ushell.Container.getService("LaunchPage"),g=m.getProperty('/groups'),h=[],G,a,b;for(a=0;a<g.length;a++){b=g[a]?g[a].isGroupVisible:true;if(g[a].object){G=l.getGroupId(g[a].object);}if(!b&&G!==undefined){h.push(G);}}return h;};u.hexToRgb=function(h){var i=!h||h[0]!='#'||(h.length!=4&&h.length!=7),r;h=!i&&h.length===4?'#'+h[1]+h[1]+h[2]+h[2]+h[3]+h[3]:h;r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null;};u.getFormFactor=function(){var s=sap.ui.Device.system;if(s.desktop){return s.SYSTEMTYPE.DESKTOP;}if(s.tablet){return s.SYSTEMTYPE.TABLET;}if(s.phone){return s.SYSTEMTYPE.PHONE;}};u.getVisibleTiles=function(){var n=document.body.clientHeight,C=sap.ui.getCore().byId("dashboardGroups"),N=sap.ui.getCore().byId("viewPortContainer"),g,a,e,b,d,f,T,h,i,j,k,s=jQuery('#shell-hdr').height(),l=[],G,I,v=[],E=sap.ui.getCore().getEventBus(),m,o,p,q;if(window.document.hidden){E.publish("launchpad","onHiddenTab");}if(C&&C.getGroups()&&N){G=jQuery(C.getDomRef());I=G?G.is(":visible"):false;m=C.getGroups();for(g=0;g<m.length;g=g+1){b=m[g];d=b.getTiles();f=b.getLinks();o=[d,f];for(e=0;e<o.length;e++){p=o[e];if(p){for(a=0;a<p.length;a++){T=p[a];if(!I||window.document.hidden){l.push(T);}else{h=jQuery(T.getDomRef());i=h.offset();if(i){j=h.offset().top;k=j+h.height();q=b.getVisible()&&(k>s-300)&&(j<n+300);if(q){v.push({oTile:u.getTileModel(T),iGroup:g,bIsExtanded:(k>s)&&(j<n)?false:true});}else if(v.length>0){E.publish("launchpad","visibleTilesChanged",v);return l;}l.push(T);}}}}}}}if(v.length>0){E.publish("launchpad","visibleTilesChanged",v);}return l;};u.getTileModel=function(a){var b=a.getBindingContext();return b.getObject()?b.getObject():null;};u.getTileObject=function(a){var b=a.getBindingContext();return b.getObject()?b.getObject().object:null;};u.addBottomSpace=function(){var j=jQuery('#dashboardGroups').find('.sapUshellTileContainer:visible');var l=j.last(),h=jQuery(".sapUshellShellHead > div").height(),a=l.parent().height(),g=parseInt(l.find(".sapUshellContainerTitle").css("margin-top"),10),b=parseInt(jQuery('.sapUshellDashboardGroupsContainer').css("padding-bottom"),10),n;if(j.length===1){n=0;}else{n=jQuery(window).height()-h-a-g-b;n=(n<0)?0:n;}jQuery('.sapUshellDashboardGroupsContainer').css("margin-bottom",n+"px");};u.calcVisibilityModes=function(g,p){var i=true,I=true,l=g.pendingLinks&&g.pendingLinks.length?g.pendingLinks:g.links,h=u.groupHasVisibleTiles(g.tiles,l);if(!h&&(!p||(g.isGroupLocked)||(g.isDefaultGroup)||D.system.phone||(D.system.tablet&&!D.system.desktop))){i=false;}if(!h&&!p){I=false;}return[i,I];};u.groupHasVisibleTiles=function(g,a){var v=false,b,d,e=!g?[]:g,l=!a?[]:a;e=e.concat(l);if(!e.length){return false;}for(b=0;b<e.length;b=b+1){d=e[b];if(d.isTileIntentSupported){v=true;break;}}return v;};u.invokeUnfoldingArrayArguments=function(f,A){var b=this,d,o,p,r,e;if(!jQuery.isArray(A[0])){return f.apply(this,A);}d=A[0];if(d.length===0){return new jQuery.Deferred().resolve([]).promise();}o=new jQuery.Deferred();p=[];r=[];e=new jQuery.Deferred().resolve();d.forEach(function(n,i){if(!jQuery.isArray(n)){jQuery.sap.log.error("Expected Array as nTh Argument of multivalue invokation: first Argument must be array of array of arguments: single valued f(p1,p2), f(p1_2,p2_2), f(p1_3,p2_3) : multivalued : f([[p1,p2],[p1_2,p2_2],[p1_3,p2_3]]");throw new Error("Expected Array as nTh Argument of multivalue invokation: first Argument must be array of array of arguments: single valued f(p1,p2), f(p1_2,p2_2), f(p1_3,p2_3) : multivalued : f([[p1,p2],[p1_2,p2_2],[p1_3,p2_3]]");}var g=f.apply(b,n),h=new jQuery.Deferred();g.done(function(){var a=Array.prototype.slice.call(arguments);r[i]=a;h.resolve();}).fail(h.reject.bind(h));p.push(h.promise());e=jQuery.when(e,h);});jQuery.when.apply(jQuery,p).done(function(){o.resolve(r);}).fail(function(){o.reject("failure");});return o.promise();};u.isClientSideNavTargetResolutionEnabled=function(){var d=true,l;if(jQuery.sap.storage===undefined){l=window.localStorage.getItem("targetresolution-client");l=(l===false||l==="false"||l==="")?false:true;}else{l=jQuery.sap.storage(jQuery.sap.getObject("jQuery.sap.storage.Type.local"),"targetresolution").get("client");}if(l===""||l===false||u.getParameterValueBoolean("sap-ushell-nav-cs")===false){return false;}return d;};u._getCurrentDate=function(){return new Date();};u._convertToUTC=function(d){return Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate(),d.getUTCHours(),d.getUTCMinutes(),d.getUTCSeconds(),d.getUTCMilliseconds());};u.formatDate=function(C){var i,n,T,d,h,m;i=u._convertToUTC(new Date(C));n=u._convertToUTC(u._getCurrentDate());T=n-i;d=parseInt(T/(1000*60*60*24),10);if(d>0){if(d===1){return sap.ushell.resources.i18n.getText("time_day",d);}return sap.ushell.resources.i18n.getText("time_days",d);}h=parseInt(T/(1000*60*60),10);if(h>0){if(h===1){return sap.ushell.resources.i18n.getText("time_hour",h);}return sap.ushell.resources.i18n.getText("time_hours",h);}m=parseInt(T/(1000*60),10);if(m>0){if(m===1){return sap.ushell.resources.i18n.getText("time_minute",m);}return sap.ushell.resources.i18n.getText("time_minutes",m);}return sap.ushell.resources.i18n.getText("just_now");};u.toExternalWithParameters=function(s,a,p){var C=sap.ushell.Container.getService("CrossApplicationNavigation"),T={},o={},i,b,d;T.target={semanticObject:s,action:a};if(p&&p.length>0){o={};for(i=0;i<p.length;i++){b=p[i].Key;d=p[i].Value;o[b]=d;}T.params=o;}C.toExternal(T);};u.moveElementInsideOfArray=function(a,n,b){if(!u.isArray(a)||n===undefined||b===undefined){throw"Incorrect input parameters passed";}if(n>=a.length||b>=a.length||b<0||n<0){throw"Index out of bounds";}var e=a.splice(n,1)[0];a.splice(b,0,e);return a;};u.shallowMergeObject=function(T){return Array.prototype.slice.call(arguments,1,arguments.length).map(function(s){return{sourceObject:s,properties:Object.keys(s)};}).reduce(function(r,s){s.properties.forEach(function(p){r[p]=s.sourceObject[p];});return r;},T);};u.getLocationHref=function(){return window.location.href;};u.isNotificationsEnabled=function(){var C=window["sap-ushell-config"],n=false;n=jQuery.sap.getObject("services.Notifications.config.enabled",undefined,C);return(n&&n===true);};u.generateLocalStorageKey=function(p,i){var n=i.length;if(n===0){throw new Error("At least one id should be provided when generating the local storage key");}var s="$";if(n===2){s="#";}else if(n>2){s="@"+n+"@";}return p+s+i.join(":");};return u;},true);
