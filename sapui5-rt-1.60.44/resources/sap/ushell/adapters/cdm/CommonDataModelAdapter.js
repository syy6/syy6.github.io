// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/ClientSideTargetResolutionAdapter","jquery.sap.global","jquery.sap.script"],function(C,q){"use strict";var a=function(u,p,A){this.oAdapterConfiguration=A;if(A&&A.config&&A.config.siteData){this.oCdmSiteDataRequestPromise=new q.Deferred().resolve(A.config.siteData);}else if(A&&A.config&&A.config.siteDataPromise){this.oCdmSiteDataRequestPromise=A.config.siteDataPromise;}else{var s=this._identifySiteUrlFromConfig(A);this.oCdmSiteDataRequestPromise=this._requestSiteData(s);}};a.prototype._requestSiteData=function(u){var s=new q.Deferred();if(!u){return s.reject("Cannot load site: configuration property 'siteDataUrl' is missing for CommonDataModelAdapter.");}q.ajax({type:"GET",dataType:"json",url:u}).done(function(r){s.resolve(r);}).fail(function(e){q.sap.log.error(e.responseText);s.reject("CDM Site was requested but could not be loaded.");});return s.promise();};a.prototype.getSite=function(){var d=new q.Deferred();this.oCdmSiteDataRequestPromise.done(function(s){var S=q.extend({},s);delete S.personalization;d.resolve(S);}).fail(function(m){d.reject(m);});return d.promise();};a.prototype.getPersonalization=function(){var d=new q.Deferred(),t=this;this.oCdmSiteDataRequestPromise.done(function(s){var S=q.extend({},s);if(t.oAdapterConfiguration&&t.oAdapterConfiguration.config&&t.oAdapterConfiguration.config.ignoreSiteDataPersonalization){delete S.personalization;}if(S.personalization){d.resolve(S.personalization);}else{t._readPersonalizationDataFromStorage().done(function(p){d.resolve(p);}).fail(function(m){d.reject(m);});}}).fail(function(m){d.reject(m);});return d.promise();};a.prototype._storePersonalizationData=function(p){var P=new q.Deferred(),o=sap.ushell.Container.getService("Personalization"),c,s={keyCategory:o.constants.keyCategory.FIXED_KEY,writeFrequency:o.constants.writeFrequency.LOW,clientStorageAllowed:true},b={container:"sap.ushell.cdm.personalization",item:"data"},d=o.getPersonalizer(b,s,c);d.setPersData(p).done(function(){q.sap.log.info("Personalization data has been stored successfully.");P.resolve();}).fail(function(){P.reject("Writing personalization data failed.");});return P.promise();};a.prototype._readPersonalizationDataFromStorage=function(){var p=new q.Deferred();sap.ushell.Container.getServiceAsync("Personalization").then(function(P){var s={keyCategory:P.constants.keyCategory.FIXED_KEY,writeFrequency:P.constants.writeFrequency.LOW,clientStorageAllowed:true};var o={container:"sap.ushell.cdm.personalization",item:"data"};P.getPersonalizer(o,s).getPersData().done(function(b){p.resolve(b||{});}).fail(function(){p.reject("Fetching personalization data failed.");});});return p.promise();};a.prototype._identifySiteUrlFromConfig=function(A){var p=q.sap.getUriParameters();var s=p.get("sap-ushell-cdm-site-url");var c=A&&A.config;if((c&&!c.allowSiteSourceFromURLParameter)&&s){s=null;}if(c&&!s){s=c.siteDataUrl||c.cdmSiteUrl;}this.sCdmSiteUrl=s;return s;};return a;},true);
