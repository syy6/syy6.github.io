// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/adapters/cdm/_LaunchPage/readHome","sap/ushell/adapters/cdm/_LaunchPage/modifyHome","sap/ushell/adapters/cdm/_LaunchPage/readCatalogs","sap/m/GenericTile","sap/m/library","sap/ui/core/ComponentContainer","sap/ushell/adapters/cdm/_LaunchPage/uri.transform","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/navigationMode","sap/ushell/resources","sap/ushell/utils","sap/ushell/utils/utilsCdm","sap/ushell/components/tiles/utilsRT","sap/ushell/utils/WindowUtils"],function(r,m,R,G,M,C,u,a,E,n,o,U,b,c,W){"use strict";var l=jQuery.sap.log.getLogger("sap/ushell/adapters/cdm/LaunchPageAdapter"),L=jQuery.sap.log.Level;var g=M.GenericTileMode;function d(f,p,A){var _,s="sap.ushell.components.tiles.cdm.applauncher",D="sap.ushell.components.tiles.cdm.applauncherdynamic";this._mResolvedTiles={};this._mCatalogTilePromises={};this._mFailedResolvedCatalogTiles={};this._mFailedResolvedTiles={};this._mContentProviders={};this.TileType={Tile:"tile",Link:"link"};this.getGroups=function(){var e=new jQuery.Deferred();this._assureLoaded().done(function(z){U.setPerformanceMark("FLP - homepage groups processed");e.resolve(z);}).fail(function(){e.resolve([]);});return e.promise();};this._getTileFromHashInContextOfSite=function(e,z,I){var B=new jQuery.Deferred(),F=z[I];if(!F){F=e(I);z[I]=F;}F.done(function(T){var H={tileIntent:I,tileResolutionResult:T};B.resolve(H);}).fail(function(H){B.reject("Hash '"+I+"' could not be resolved to a tile. "+H);});return B.promise();};this._getTileFromHash=function(I){var e=sap.ushell.Container.getService("ClientSideTargetResolution");var z=e.resolveTileIntent.bind(e);return this._getTileFromHashInContextOfSite(z,this._mCatalogTilePromises,I);};this._getTileFromHashFromSite=function(S,I){var e=sap.ushell.Container.getService("ClientSideTargetResolution");var z=b.formatSite(S);var B=e.resolveTileIntentInContext.bind(e,z);var F={};return this._getTileFromHashInContextOfSite(B,F,I);};this._getTileForUrl=function(T){var e=T.indicatorDataSource?"#Shell-dynamicTile":"#Shell-staticTile";return{tileIntent:"#",tileResolutionResult:{tileComponentLoadInfo:e,isCustomTile:false}};};this._assureGroupItemsResolved=function(e,S){var P=[],z,B;if(e.payload&&e.payload.tiles){z=this._assureGroupTilesResolved(e.payload.tiles,S);Array.prototype.push.apply(P,z);}if(e.payload&&e.payload.links){B=this._assureGroupLinksResolved(e.payload.links,S);Array.prototype.push.apply(P,B);}return P;};this._assureGroupTilesResolved=function(e,S){return(e||[]).map(function(T,I){return this._resolveGroupTile(T,S).then(function(z){z.isLink=false;return z;});},this);};this._assureGroupLinksResolved=function(e,S){return(e||[]).map(function(z,I){return this._resolveGroupTile(z,S).then(function(B){B.isLink=true;return B;});},this);};this._resolveGroupTile=function(T,S){var e=this._mResolvedTiles;var F=this._mFailedResolvedTiles;var z;function B(I){e[T.id]=I;if(F[T.id]){delete F[T.id];}return I;}function H(T){var I=T.target;return I&&I.semanticObject==="Shell"&&I.action==="launchURL";}if(e[T.id]){return(new jQuery.Deferred()).resolve(e[T.id]).promise();}if(T.target&&T.target.url){z=jQuery.when(this._getTileForUrl(T));}else if(T.isBookmark){z=this._resolveTileByIntent(T,S);}else if(H(T)){z=this._resolveTileByIntent(T,S);}else{z=this._resolveTileByAppId(T,S);}z.done(function(I){B(I);}).fail(function(I){F[T.id]=I;});return z;};this._resolveTileByAppId=function(T,S){var e,z,I,B,H;function F(Q,V){return new jQuery.Deferred().reject({logLevel:Q,message:V}).promise();}if(!jQuery.isPlainObject(T)){return F(L.ERROR,"Cannot resolve tile: oTile must be an object");}if(!jQuery.isPlainObject(S)){return F(L.ERROR,"Cannot resolve tile: oSite must be an object");}e=T.appId||T.appIDHint;if(!e){return F(L.ERROR,["Cannot resolve tile '",T.id,"': either appId or appIDHint must be specified"].join(""));}z=S.applications&&S.applications[e];if(!z){return F(L.INFO,["Tile '",T.id,"' filtered from result: no app found for appId '",e,"' (dangling app reference)"].join(""));}I=this._getFirstInbound(z);if(!I){return F(L.ERROR,["Cannot resolve tile '",T.id,"': app '",e,"' has no navigation inbound"].join(""));}var J=b.mapOne(I.key,I.inbound,z),K=J.resolutionResult.applicationType,N=J.resolutionResult.additionalInformation,O=a.last("/core/navigation/enableInPlaceForClassicUIs"),P=O?O[K]:false;B=J.tileResolutionResult;B.navigationMode=n.computeNavigationModeForHomepageTiles(K,N,P);B.isLink=false;if(!this._isFormFactorSupported(B)){return F(L.INFO,["Tile '",T.id,"' filtered from result: form factor not supported"].join(""));}H=this._toHashFromInbound(I.inbound);return jQuery.when({tileResolutionResult:B,tileIntent:H});};this._isFormFactorSupported=function(e){var z=U.getFormFactor();return r.supportsFormFactor(e,z);};this._getFirstInbound=function(e){var F=Object.keys(e["sap.app"].crossNavigation.inbounds).shift(),I=e["sap.app"].crossNavigation.inbounds[F];return{key:F,inbound:I};};this._resolveTileByIntent=function(T,S){var H=this._prepareTileHash(T);return this._getTileFromHash(H);};this._prepareTileHash=function(T){var e=sap.ushell.Container.getService("URLParsing"),P={},z,B;if(this._isCatalogTile(T)){return T.tileIntent;}if(this._isGroupTile(T)&&T.target){B=T.target.parameters||[];B.forEach(function(F){if(F.name&&F.value){P[F.name]=[F.value];}});z={target:{semanticObject:T.target.semanticObject,action:T.target.action},params:P,appSpecificRoute:T.target.appSpecificRoute};return"#"+e.constructShellHash(z);}return undefined;};this._allPromisesDone=function(P){var e=new jQuery.Deferred(),z;if(P.length===0){e.resolve([]);}else{var N=P.map(function(B){z=new jQuery.Deferred();B.always(z.resolve.bind(z));return z.promise();});jQuery.when.apply(this,N).done(function(){var B=Array.prototype.slice.call(arguments);e.resolve(B);});}return e.promise();};this._assureLoaded=function(){var e=this,z=sap.ushell.Container.getService("CommonDataModel"),B;if(this._assureLoadedDeferred){return this._assureLoadedDeferred.promise();}B=new jQuery.Deferred();this._assureLoadedDeferred=B;z.getSite().done(function(S){var I=[];var F=r.getGroupsArrayFromSite(S);var H=r.getDefaultGroup(F);if(!H){H=m.createDefaultGroup(U.generateUniqueId(r.getGroupIdsFromSite(S)));S=m.addGroupToSite(S,H,0);F=r.getGroupsArrayFromSite(S);}_=H;F.forEach(function(J){I=e._assureGroupItemsResolved(J,S).concat(I);});e._allPromisesDone(I).done(function(){e._assureLoadedDeferred.resolve(F);delete e._assureLoadedDeferred;e._logTileResolutionFailures(e._mFailedResolvedTiles);});}).fail(function(F){jQuery.sap.log.error("Delivering hompage groups failed - "+F);e._assureLoadedDeferred.resolve([]);delete e._assureLoadedDeferred;});return B.promise();};this._logTileResolutionFailures=function(F){var e={};if(!F){return;}Object.keys(L).filter(function(z){var B=L[z];return B>=L.FATAL&&B<=L.ALL;}).forEach(function(z){e[L[z]]="";});Object.keys(F).forEach(function(z){var B=F[z];if(B.logLevel){e[B.logLevel]=e[B.logLevel].concat(B.message).concat("\n");}});if(e[L.FATAL]){l.fatal(e[L.FATAL]);}if(e[L.ERROR]){l.error(e[L.ERROR]);}if(e[L.WARNING]){l.warning(e[L.WARNING]);}if(e[L.INFO]){l.info(e[L.INFO]);}if(e[L.DEBUG]){l.debug(e[L.DEBUG]);}if(e[L.TRACE]){l.trace(e[L.TRACE]);}};this.getDefaultGroup=function(){var e=new jQuery.Deferred(),z;if(!_){z=this._assureLoaded();}if(z){z.done(function(){e.resolve(_);}).fail(function(B){e.reject("Failed to access default group. "+B);});}else{e.resolve(_);}return e.promise();};this._isValidTitle=function(T){if(typeof T!=='string'||!T){return false;}return true;};this._isGroupPreset=function(e){return r.isGroupPreset(e);};this._isGroupLocked=function(e){return r.isGroupLocked(e);};this.addGroup=function(T){var e=new jQuery.Deferred(),z=sap.ushell.Container.getService("CommonDataModel"),B,F,H=this;if(!this._isValidTitle(T)){return e.reject("No valid group title").promise();}F="Failed to add the group with title '"+T+"' to the homepage. ";z.getSite().done(function(S){B=U.generateUniqueId(r.getGroupIdsFromSite(S));m.addGroupToSite(S,m.createEmptyGroup(B,T));z.save().done(function(){delete H._assureLoadedDeferred;e.resolve(S.groups[B],B);}).fail(function(I){e.reject(I);});}).fail(function(I){e.reject(F+I);});return e.promise();};this.getGroupTitle=function(e){return r.getGroupTitle(e);};this.setGroupTitle=function(e,N){var z=this,B=new jQuery.Deferred(),F=sap.ushell.Container.getService("CommonDataModel"),O,H;if(typeof e!=='object'||!r.getGroupId(e)){return B.reject("Unexpected group value").promise();}if(!z._isValidTitle(N)){return B.reject("Unexpected oGroup title value").promise();}H="Failed to set new title for group with id '"+r.getGroupId(e)+"'. ";O=r.getGroupTitle(e);F.getSite().done(function(S){if(e){m.setGroupTitle(e,N);}F.save().done(function(){B.resolve();}).fail(function(I){jQuery.sap.log.error(I);B.reject(O);});}).fail(function(I){B.reject(O,H+I);});return B.promise();};this.getGroupId=function(e){return r.getGroupId(e);};this.hideGroups=function(H){var e=new jQuery.Deferred(),z=sap.ushell.Container.getService("CommonDataModel"),B;if(H&&jQuery.isArray(H)){B="Failed to hide group. ";z.getSite().done(function(S){r.getGroupsArrayFromSite(S).forEach(function(F){m.setGroupVisibility(F,jQuery.inArray(r.getGroupId(F),H)===-1);});z.save().done(function(){e.resolve();}).fail(function(F){e.reject("Hiding of groups did not work as expected - "+F);});}).fail(function(F){e.reject(B+F);});}else{e.reject("Invalid input parameter aHiddenGroupIds. Please pass a valid input parameter.");}return e.promise();};this.isGroupVisible=function(e){return r.isGroupVisible(e);};this.moveGroup=function(e,z){var B=new jQuery.Deferred(),F=sap.ushell.Container.getService("CommonDataModel"),H,I;if(!e||!r.getGroupId(e)||z<0){return B.reject("Unable to move groups - invalid parameters").promise();}I="Failed to move group with id '"+e.identification.id+"'. ";F.getSite().done(function(S){var J=r.getGroupIdsFromSite(S),K=r.getGroupId(e);if(!J){return B.reject("groupsOrder not found - abort operation of adding a group.");}else if(J.indexOf(K)===z){return B.resolve();}H=U.moveElementInsideOfArray(J,J.indexOf(K),z);if(!H){return B.reject("invalid move group operation - abort.");}m.setGroupsOrder(S,H);F.save().done(function(){B.resolve();}).fail(function(N){B.reject(N);});return undefined;}).fail(function(J){B.reject(I+J);});return B.promise();};this.removeGroup=function(e){var z=new jQuery.Deferred(),B=sap.ushell.Container.getService("CommonDataModel"),F,H;if(typeof e!=="object"){return z.reject("invalid group parameter").promise();}H=r.getGroupId(e);if(!H){return z.reject("group without id given").promise();}F="Failed to remove group with id '"+H+"'. ";B.getSite().done(function(S){m.removeGroupFromSite(S,e);B.save().done(function(){z.resolve();}).fail(function(I){z.reject(I);});}).fail(function(I){z.reject(F+I);});return z.promise();};this.resetGroup=function(e){var z=new jQuery.Deferred(),B=sap.ushell.Container.getService("CommonDataModel"),S=[],F=this,H,I;if(typeof e==="object"&&r.getGroupId(e)){I=r.getGroupId(e);H="Failed to reset group with id '"+I+"'. ";B.getSite().done(function(J){jQuery.extend(true,S,r.getGroupsArrayFromSite(J));if(F.isGroupRemovable(e)===false){B.getGroupFromOriginalSite(I).done(function(K){if(typeof J==="object"&&r.getGroupFromSite(J,I)){m.overwriteGroup(J,K,I);}B.save().done(function(){z.resolve(K);}).fail(function(N){z.reject("Group could not be reset - "+N,S);});}).fail(function(K){z.reject("Group could not be reset - "+K,S);});}else{z.reject("Group could not be reset as it was created by the user",S);}}).fail(function(J){z.reject(H+J,[]);});}return z.promise();};this.getTileTitle=function(T){return r.getTileTitle(this._mResolvedTiles,T);};this.getTileSubtitle=function(T){return r.getTileSubtitle(this._mResolvedTiles,T);};this.getTileIcon=function(T){return r.getTileIcon(this._mResolvedTiles,T);};this.getTileInfo=function(T){return r.getTileInfo(this._mResolvedTiles,T);};this.getTileIndicatorDataSource=function(T){var e=this._mResolvedTiles[T.id],z={},B;if(T.indicatorDataSource){z.indicatorDataSource=T.indicatorDataSource;if(T.dataSource){z.dataSource=T.dataSource;}return z;}if(!e){return z;}B=e.tileResolutionResult;if(B.indicatorDataSource){z.indicatorDataSource=B.indicatorDataSource;if(B.indicatorDataSource.hasOwnProperty("dataSource")){var F=B.indicatorDataSource.dataSource,H=B.dataSources;if(H&&H.hasOwnProperty(F)){z.dataSource=H[F];}else{jQuery.sap.log.warning("datasource referenced but not found for tile: "+e.tileIntent);}}if(U.getMember(B,"runtimeInformation.componentProperties.url")){var P=U.getMember(z,"indicatorDataSource.path");var I=U.getMember(z,"dataSource.uri");var J=U.getMember(B,"runtimeInformation.componentProperties.url");var K=u(P,I,J,window.location.href);if(!K.error){if(P){z.indicatorDataSource.path=K.uri;}if(I){z.dataSource.uri=K.uriParent;}}}}return z;};this.isGroupRemovable=function(e){return!this._isGroupPreset(e);};this.isGroupLocked=function(e){return this._isGroupLocked(e);};this.getGroupTiles=function(e){return r.getGroupTiles(e).concat(r.getGroupLinks(e));};this.getLinkTiles=function(e){return r.getGroupLinks(e);};this.getTileType=function(T){if(r.isLink(this._mResolvedTiles,T)){return this.TileType.Link;}return this.TileType.Tile;};this.getTileId=function(T){return r.getTileId(T);};this.getTileSize=function(T){return r.getTileSize(this._mResolvedTiles,T)||"1x1";};this.getTileTarget=function(T){var e,z=r.getTileId(T),B=this._mResolvedTiles[z],F;if(T.target&&T.target.url){return T.target.url;}if(B&&B.tileResolutionResult){e=B.tileResolutionResult;if(e.isCustomTile!==true){return B.tileIntent;}if(e&&typeof e.targetOutbound==="object"){F=this._toHashFromOutbound(e.targetOutbound);if(F){return F;}}}jQuery.sap.log.warning("Could not find a target for Tile with id '"+z+"'","sap.ushell.adapters.cdm.LaunchPageAdapter");return"";};this.isLinkPersonalizationSupported=function(T){return true;};this.isTileIntentSupported=function(T){return(this._mFailedResolvedTiles[T.id]===undefined)?true:false;};this._notifyTileAboutRefresh=function(T){if(typeof T.tileRefresh==="function"){T.tileRefresh();}};this.refreshTile=function(T){var e=this._mResolvedTiles[T.id];if(e){if(e.tileComponent){this._notifyTileAboutRefresh(e.tileComponent);}}};this._notifyTileAboutVisibility=function(T,N,O){if(typeof T.tileSetVisible==="function"&&O!==N){T.tileSetVisible(N);}};this.setTileVisible=function(T,N){var e=this._mResolvedTiles[T.id];if(e){if(e.tileComponent){this._notifyTileAboutVisibility(e.tileComponent,N,e.visibility);}e.visibility=N;}};this.getTileView=function(e){var z=this;return new jQuery.Deferred(function(B){return z._getTileView(e,false).then(function(T){B.resolve(T);},function(F){var H="Tile with ID '"+e.id+"' could not be initialized"+(F?":\n"+F:".");jQuery.sap.log.error(H,null,e.tileType);B.reject(H);});}).promise();};this._getTileUiComponentContainerSync=function(T,e,I){var z=this,B,F,N,H,J={};if(I===true){F=z._createTileComponentData(T,true,e);}else{F=z._createTileComponentData(T,false,e);}B=e.tileResolutionResult;if(e.isLink){N=B.navigationMode;return z._createLinkInstance(T,I,N,G,o);}if(typeof B.tileComponentLoadInfo==="string"){if(F.properties.indicatorDataSource&&F.properties.indicatorDataSource.path){J.name="sap.ushell.components.tiles.cdm.applauncherdynamic";}else{J.name="sap.ushell.components.tiles.cdm.applauncher";}}else if(typeof B.tileComponentLoadInfo==="object"&&B.tileComponentLoadInfo!==null){J=B.tileComponentLoadInfo.componentProperties||{};J.name=B.tileComponentLoadInfo.componentName;}J.componentData=F;if(J.manifest){J.componentData.properties=J.componentData.properties||{};J.componentData.properties.manifest=J.manifest;}if(J.name){J.async=false;var K;try{H=sap.ui.component(J);}catch(O){jQuery.sap.log.error(O.message+"\n-- An error occurred while instantiating "+"the tile component for "+J.name,O.stack?O.stack:"","sap.ushell.adapters.cdm.LaunchPageAdapter");return null;}K=new sap.ui.core.ComponentContainer({component:H,height:'100%'});if(!I){z._mResolvedTiles[T.id].tileComponent=H;}return K;}return null;};this._getTileUiComponentContainer=function(T,e,I){var z=this,B,F,N,H,J,K,O=new jQuery.Deferred();var P=sap.ushell.Container.getService("Ui5ComponentLoader");if(I===true){F=z._createTileComponentData(T,true,e);}else{F=z._createTileComponentData(T,false,e);}B=e.tileResolutionResult;if(e.isLink){N=B.navigationMode;O.resolve(z._createLinkInstance(T,I,N,G,o));return O.promise();}var Q=this._createTileComponentProperties(F,B.tileComponentLoadInfo);if(!Q.name){return O.reject("Cannot find name of tile component for tile with id: '"+T.id+"'").promise();}if(Q.manifest){F.properties=F.properties||{};F.properties.manifest=Q.manifest;}K=this.isCustomTile(Q.name);var S=function(Z){var e;H=Z.componentHandle.getInstance();J=new C({component:H,height:'100%'});if(!I){e=z._mResolvedTiles[T.id];e.tileComponent=H;if(typeof e.visibility==="boolean"){z._notifyTileAboutVisibility(H,e.visibility);}}return J;};var V=function(){return P.createComponent({loadCoreExt:K,loadDefaultDependencies:false,componentData:F,url:Q.url,applicationConfiguration:{},reservedParameters:{},applicationDependencies:Q,ui5ComponentName:Q.name},{},[]).then(S);};var X=function(){var Z={componentData:F,url:Q.url,name:Q.name,async:false};H=sap.ui.component(Z);var $={componentHandle:{getInstance:function(){return H;}}};return S($);};if(K){E.once("CoreResourcesComplementLoaded").do(function(){V().then(function(J){O.resolve(J);}).fail(function(Z){O.reject(Z);});});}else{var Y=X();O.resolve(Y);}return O.promise();};this._createTileComponentProperties=function(T,e){var z={};if(typeof e==="string"){if(T.properties.indicatorDataSource&&T.properties.indicatorDataSource.path){z.name=D;}else{z.name=s;}return z;}if(typeof e==="object"&&e!==null){z=e.componentProperties||{};z.name=e.componentName;}return z;};this._getTileView=function(e){var z,B,F=new jQuery.Deferred();if(typeof e!=="object"||!e.id){B="Invalid input parameter passed to _getTileView: "+e;jQuery.sap.log.error(B);return F.reject(B).promise();}z=this._mResolvedTiles[e.id];if(z){return this._getTileUiComponentContainer(e,z,false);}B="No resolved tile found for tile ID: "+e.id;jQuery.sap.log.error(B);return F.reject(B).promise();};this._getCatalogTileView=function(e){if(typeof e!=="object"){throw new Error(e);}return this._getTileUiComponentContainerSync(e,e,true);};this._getCatalogTileViewControl=function(e){var z=new jQuery.Deferred();if(typeof e!=="object"){var B="Invalid input parameter passed to _getCatalogTileView: "+e;jQuery.sap.log.error(B);return z.reject(B).promise();}return this._getTileUiComponentContainer(e,e,true);};this._createTileComponentData=function(T,I,e){var z=I?this.getCatalogTileTitle(T):this.getTileTitle(T),S=I?this.getCatalogTilePreviewSubtitle(T):this.getTileSubtitle(T),B=I?this.getCatalogTilePreviewIcon(T):this.getTileIcon(T),F=I?this.getCatalogTilePreviewInfo(T):this.getTileInfo(T),H=I?this.getCatalogTileTargetURL(T):this.getTileTarget(T),J=this.getTileIndicatorDataSource(T),K={properties:{},startupParameters:{}};if(e.tileResolutionResult.isCustomTile===true&&e.tileResolutionResult.startupParameters){K.startupParameters=e.tileResolutionResult.startupParameters;}if(z){K.properties.title=z;}if(F){K.properties.info=F;}if(S){K.properties.subtitle=S;}if(B){K.properties.icon=B;}if(H){K.properties.targetURL=H;}if(J.indicatorDataSource){K.properties.indicatorDataSource=J.indicatorDataSource;if(J.dataSource){K.properties.dataSource=J.dataSource;}}if(e.tileResolutionResult){K.properties.navigationMode=e.tileResolutionResult.navigationMode;}return K;};this._createLinkInstance=function(T,I,N,e,o){var z,B,F,H=this.getTileSubtitle(T);var G=e;if(I===true){z=this.getCatalogTileTitle(T);}else{z=this.getTileTitle(T);}B=new G({mode:g.LineMode,subheader:H,header:z,press:function(J){this._genericTilePressHandler(T,J);}.bind(this)});if(N){F=o.i18n.getText(N+"NavigationMode");B.setAriaLabel(F+" "+z+" "+H);}this._mResolvedTiles[T.id].linkTileControl=B;return B;};this._genericTilePressHandler=function(T,e){var z;if(e.getSource().getScope&&e.getSource().getScope()==="Display"){z=this.getTileTarget(T);if(z){if(z[0]==='#'){hasher.setHash(z);}else{W.openURL(z,'_blank');}}}};this._addTileToSite=function(P,e,N,z){var B=this,F=new jQuery.Deferred(),I=sap.ushell.Container.getService("URLParsing").parseShellHash(N.properties.targetURL),T={"id":B.getTileId(N),"target":{"semanticObject":I.semanticObject,"action":I.action,"parameters":y(I.params)}};P.groups[e.identification.id].payload.tiles.push(T);z.save().done(function(){F.resolve(T);}).fail(function(H){F.reject(H);});return F.promise();};this.addTile=function(e,z){var B=new jQuery.Deferred(),F,H=sap.ushell.Container.getService("CommonDataModel"),I;if(!z){z=_;}if(e.contentProviderId){if(e.externalUrl){return this.addBookmark(this._getBookmarkDataForExtensionCatalogTile(e),z);}return B.reject("Extension Tile without URL").promise();}I=j();I.appId=e.tileResolutionResult.appId;this._mResolvedTiles[I.id]={tileIntent:e.tileIntent,tileResolutionResult:e.tileResolutionResult,isLink:false};H.getSite().done(function(S){S.groups[z.identification.id].payload.tiles.push(I);H.save().done(function(){B.resolve(I);}).fail(function(J){B.reject(J);});}).fail(function(J){F="Failed to add tile with id '"+I.id+"' to group with id '"+z.identification.id+"'. ";B.reject(F+J);});return B.promise();};this._getBookmarkDataForExtensionCatalogTile=function(e){var B={title:e.tileResolutionResult.title,subtitle:e.tileResolutionResult.subTitle,icon:e.tileResolutionResult.icon,info:e.tileResolutionResult.info,url:e.externalUrl};if(e.tileResolutionResult.indicatorDataSource&&e.tileResolutionResult.indicatorDataSource.path){B.serviceUrl=e.tileResolutionResult.indicatorDataSource.path;B.serviceRefreshInterval=e.tileResolutionResult.indicatorDataSource.refresh;}return B;};this.removeTile=function(z,T,I){var B,F,H=new jQuery.Deferred(),J=this;if(!z||typeof z!=="object"||!z.identification||!z.identification.id||!T||typeof T!=="object"||!T.id){return H.reject({},"Failed to remove tile. No valid input parameters passed to removeTile method.").promise();}F="Failed to remove tile with id '"+T.id+"' from group with id '"+z.identification.id+"'. ";B=sap.ushell.Container.getService("CommonDataModel");B.getSite().done(function(S){var P,K;I=+I;try{P=S.groups[z.identification.id].payload;}catch(e){H.reject(S.groups[z.identification.id],F);}K=J.getTileType(T)===J.TileType.Link?"links":"tiles";if(J.getTileType(T)===J.TileType.Link){I-=P.tiles.length;}if(I>=0){P[K].splice(I,1);}else{P[K]=P[K].filter(function(N){return N.id!==T.id;});}B.save().done(function(){H.resolve();}).fail(function(N){jQuery.sap.log.error(N);H.reject(S.groups[z.identification.id],N);});}).fail(function(e){H.reject({},F+e);});return H.promise();};this.moveTile=function(T,S,e,z,B,F){var H=new jQuery.Deferred(),I=sap.ushell.Container.getService("CommonDataModel"),J=this,K;if(!T||jQuery.isEmptyObject(T)||S===undefined||S<0||e===undefined||e<0||!z||!z.identification||!z.identification.id||!B||!B.identification||!B.identification.id){return H.reject("Invalid input parameters").promise();}K="Failed to move tile with id '"+T.id+"'. ";I.getSite().done(function(N){var O,P,Q=J.getTileType(T)===J.TileType.Link?"links":"tiles";if(!F){F=J._mResolvedTiles[T.id].isLink?"link":"tile";}O=F==="link"?"links":"tiles";if(Q!=O&&J._mResolvedTiles[T.id]){J._mResolvedTiles[T.id].isLink=F==="link";}if(O==="links"){e-=N.groups[B.identification.id].payload.tiles.length;}if(Q==="links"){S-=N.groups[z.identification.id].payload.tiles.length;}if(z.identification.id===B.identification.id){if(S!==e||Q!=O){P=N.groups[B.identification.id].payload;P[Q].splice(S,1);P[O].splice(e,0,T);}else{return H.resolve(T).promise();}}else{N.groups[z.identification.id].payload[Q].splice(S,1);N.groups[B.identification.id].payload[O].splice(e,0,T);}I.save().done(function(){H.resolve(T);}).fail(function(V){jQuery.sap.log.error(K+V);H.reject(K+V);});return undefined;}).fail(function(N){jQuery.sap.log.error(K+N);H.reject(K+N);});return H.promise();};this._compareCatalogs=function(e,B){if(e.identification.id>B.identification.id){return 1;}return-1;};this.getCatalogs=function(){var e=this,z=new jQuery.Deferred(),B=[],F=sap.ushell.Container.getService("CommonDataModel");function H(I,J,B,K,P,N){var O=I.catalogs[J];if(P&&N){O.contentProviderId=P;N.catalogsMap[J]=O;}B.push(O);K.notify(O);}window.setTimeout(function(){F.getSite().done(function(S){Object.keys(S.catalogs).forEach(function(I){H(S,I,B,z);});F.getExtensionSites().progress(function(I){var P=I.providerId;var J=I.site;var K=Promise.resolve(J);var N={sitePromise:K,site:J,catalogsMap:{}};Object.keys(J.catalogs).forEach(function(O){e._mContentProviders[P]=N;H(J,O,B,z,P,N);});}).done(function(I){I.filter(function(J){return!J.success;}).forEach(function(J,K){B.push({identification:{id:J.providerId},contentProviderId:J.providerId,error:"The following content providers could not provide catalogs: "+J.providerId+(J.error?" -> "+J.error:"")});});z.resolve(B.sort(e._compareCatalogs));});});},0);return z.promise();};this._isStartableInbound=function(I){var N=["Shell-plugin","Shell-bootConfig"],e;if(!I.semanticObject||!I.action){return false;}if(N.indexOf(I.semanticObject+"-"+I.action)>-1){return false;}if(!jQuery.sap.getObject("signature.parameters",undefined,I)){return true;}e=Object.keys(I.signature.parameters).every(function(p){return!I.signature.parameters[p].filter||(!!I.signature.parameters[p].launcherValue||p==="sap-external-url");});return e;};this._isHiddenInbound=function(I){return!!I.hideLauncher;};this._toHashFromInbound=function(I){var e=b.toHashFromInbound(I);if(!e){return undefined;}return"#"+e;};this._getExternalUrlFromInbound=function(I){return jQuery.sap.getObject("signature.parameters.sap-external-url.launcherValue.value",undefined,I)||null;};this._toHashFromOutbound=function(O){var e=b.toHashFromOutbound(O);if(!e){return undefined;}return"#"+e;};this._isCustomTile=function(e){if(U.getMember(e,"sap|flp.type")==="tile"){return true;}return false;};this.getCatalogTiles=function(e){var z=this,B=new jQuery.Deferred();if(typeof e!=="object"||e===null){return B.reject("Invalid input parameter '"+e+"' passed to getCatalogTiles.").promise();}if(e.contentProviderId&&this._mContentProviders[e.contentProviderId]){this._mContentProviders[e.contentProviderId].sitePromise.then(function(S){h.call(z,e,S).done(B.resolve).fail(B.reject);},function(F){B.reject("Failed to get site: "+F);});}else{sap.ushell.Container.getService("CommonDataModel").getSite().done(function(S){h.call(z,e,S).done(B.resolve).fail(B.reject);}).fail(function(F){B.reject("Failed to get site: "+F);});}return B.promise();};this.isCustomTile=function(e){return!(e===s||e===D);};function h(e,S){var z=this,B=new jQuery.Deferred();setTimeout(function(){var F=((e.payload&&e.payload.appDescriptors)||[]).reduce(function(H,I){var J=S.applications[I.id],K,T,N,O,P,Q,V,X,Y,Z,$,a1;if(!J){return H;}K=z._getMember(J,"sap|app.crossNavigation.inbounds");if(!K||Object.keys(K).length===0){return H;}N=Object.keys(K)[0];O=K[N];if(z._isStartableInbound(O)&&!z._isHiddenInbound(O)){P=b.mapOne(N,O,J);if(!P||!P.tileResolutionResult){return H;}Y=P.resolutionResult.applicationType;a1=a.last("/core/navigation/enableInPlaceForClassicUIs");$=a1?a1[Y]:false;Z=P.resolutionResult.additionalInformation;P.tileResolutionResult.navigationMode=n.computeNavigationModeForHomepageTiles(Y,Z,$);Q=P.tileResolutionResult;T=z._toHashFromInbound(O);if(e.contentProviderId){X=z._getMember(J,"sap|app.crossNavigation.inbounds.Shell-launchURL.signature.parameters.sap-external-url.launcherValue.value");}V={id:X||T,tileIntent:X||T,tileResolutionResult:Q,isCatalogTile:true};if(e.contentProviderId&&X){V.contentProviderId=e.contentProviderId;V.externalUrl=X;}H.push(V);}return H;},[]);B.resolve(F);},0);return B.promise();}this.getCatalogError=function(e){if(e.error){return e.error;}return undefined;};this.getCatalogId=function(e){return R.getCatalogId(e);};this.getCatalogTitle=function(e){return R.getCatalogTitle(e);};this._isGroupTile=function(T){return r.isGroupTile(T);};this._isCatalogTile=function(T){return!!(T&&T.isCatalogTile);};this._isFailedGroupTile=function(T){return!!(T&&this._mFailedResolvedTiles&&this._mFailedResolvedTiles[r.getTileId(T)]);};this._isFailedCatalogTile=function(T){return!!(T&&this._mFailedResolvedCatalogTiles&&this._mFailedResolvedCatalogTiles[r.getTileId(T)]);};this.getCatalogTileId=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return undefined;}if(e.isBookmark&&jQuery.sap.getObject("target.url",undefined,e)){return e.target.url;}return(this._mResolvedTiles[r.getTileId(e)]||{}).tileIntent;}if(this._isCatalogTile(e)){return e.id;}return undefined;};this.getCatalogTileTitle=function(e){if(this._isGroupTile(e)){if(this._isFailedGroupTile(e)){return"";}return this._mResolvedTiles[e.id].tileResolutionResult.title;}if(this._isCatalogTile(e)){if(this._isFailedCatalogTile(e)){return undefined;}return e.tileResolutionResult.title;}return undefined;};this.getCatalogTileSize=function(e){return this.getTileSize(e);};this.getCatalogTileView=function(e){return this._getCatalogTileView(e);};this.getCatalogTileViewControl=function(e){return this._getCatalogTileViewControl(e);};this.getCatalogTileTargetURL=function(e){if(!e){throw new Error("The given tile is falsy");}if(this._isCatalogTile(e)){if(e.tileResolutionResult&&e.tileResolutionResult.isCustomTile){if(!e.tileResolutionResult.targetOutbound){return"";}return this._toHashFromOutbound(e.tileResolutionResult.targetOutbound);}return e.tileIntent||"";}return this.getTileTarget(e);};this.getCatalogTilePreviewTitle=function(e){if(this._isGroupTile(e)){return this.getTileTitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.title)||"";};this.getCatalogTilePreviewSubtitle=function(e){if(this._isGroupTile(e)){return this.getTileSubtitle(e);}return(e.tileResolutionResult&&e.tileResolutionResult.subTitle)||"";};this.getCatalogTilePreviewIcon=function(e){if(this._isGroupTile(e)){return this.getTileIcon(e);}return(e.tileResolutionResult&&e.tileResolutionResult.icon)||"";};this.getCatalogTilePreviewInfo=function(e){if(this._isGroupTile(e)){return this.getTileInfo(e);}return(e.tileResolutionResult&&e.tileResolutionResult.info)||"";};this.getCatalogTileKeywords=function(e){var K=[],z=e;if(!z){jQuery.sap.log.error("Could not find the Tile","sap.ushell.adapters.cdm.LaunchPageAdapter");return K;}if(this._mResolvedTiles&&this._mResolvedTiles[e.id]){z=this._mResolvedTiles[e.id];}if(z&&z.tileResolutionResult&&z.tileResolutionResult.title){K.push(z.tileResolutionResult.title);}if(z&&z.tileResolutionResult&&z.tileResolutionResult.subTitle){K.push(z.tileResolutionResult.subTitle);}return K;};this._visitBookmarks=function(e,V){var z=sap.ushell.Container;var B=z.getService("URLParsing");var F=z.getService("CommonDataModel");var H;var I=B.parseShellHash(e);if(I){H=x(I);}else{H=w(e);}return F.getSite().then(function(S){var J=S.groups;var T=Object.keys(J).filter(function(K){return!J[K].payload.locked;}).map(function(K){return J[K].payload.tiles.filter(function(N){return N.isBookmark&&q(H,N.target);});}).reduce(function(K,N){Array.prototype.push.apply(K,N);return K;},[]);if(!V){return T.length;}return jQuery.when(T.map(V)).then(function(){return T.length;});});};this.addBookmark=function(P,e){var T=this;return new jQuery.Deferred(function(z){var B=sap.ushell.Container;var F=B.getService("URLParsing");var H=B.getService("CommonDataModel");jQuery.when(e||T.getDefaultGroup(),H.getSite()).done(function(e,S){var I,J,K=F.parseShellHash(P.url),N,O=false;if(!K){J=w(P.url);O=true;}else{J=x(K);}I=i(P,J);if(O){N=new jQuery.Deferred();N.resolve(T._getTileForUrl(I));}else{N=T._getTileFromHash(P.url);}N.done(function(Q){Q.isLink=false;T._mResolvedTiles[I.id]=Q;S.groups[e.identification.id].payload.tiles.push(I);H.save().done(function(){z.resolve(I);}).fail(function(V){z.reject(V);});}).fail(function(Q){z.reject("Bookmark creation failed because: "+Q);});}).fail(function(I){z.reject(I);});}).promise();};this.countBookmarks=function(e){return this._visitBookmarks(e);};this.updateBookmarks=function(e,P){var z=sap.ushell.Container;var B=z.getService("URLParsing");var F=z.getService("CommonDataModel");var H=this._mResolvedTiles;function I(T){return new jQuery.Deferred(function(J){var K,N;var O;var Q=false;var S={};if(P.url||P.url===""){K=B.parseShellHash(P.url);if(!K){N=w(P.url);}else{N=x(K);}}if(T.icon!==P.icon){S.icon=P.icon;Q=true;}if(T.title!==P.title){S.title=P.title;Q=true;}if(T.subTitle!==P.subtitle){S.subtitle=P.subtitle;Q=true;}if(P.url&&e!==P.url){S.targetURL=P.url;Q=true;}if(T.info!==P.info){S.info=P.info;Q=true;}k(T,P,N);if(Q&&H[T.id]){O=H[T.id].tileComponent;O.tileSetVisualProperties(S);}J.resolve(T);}).promise();}return this._visitBookmarks(e,I).then(function(J){return F.save().then(function(){return J;});});};this.deleteBookmarks=function(e){var z=sap.ushell.Container;var B=z.getService("URLParsing");var F=z.getService("CommonDataModel");var I=B.parseShellHash(e);var H;if(I){H=x(I);}else{H=w(e);}return F.getSite().then(function(S){var J=S.groups;var K=Object.keys(J).map(function(N){var P=J[N].payload;var O=0;P.tiles=P.tiles.filter(function(T){if(T.isBookmark&&q(H,T.target)){++O;return false;}return true;});return O;}).reduce(function(N,O){N+=O;return N;},0);return F.save().then(function(){return K;});});};this.onCatalogTileAdded=function(T){};this._onTileSettingsSave=function(T,S){var e=new jQuery.Deferred(),z,B,N,F,H,O,I,J;if(T&&T.id&&S){N=S.oTitleInput.getValue();H=S.oSubTitleInput.getValue();F=S.oInfoInput.getValue();O=this.getTileTitle(T);I=this.getTileInfo(T);J=this.getTileSubtitle(T);if(O===N&&J===H&&I===F){return undefined;}z=sap.ushell.Container.getService("CommonDataModel");var K=this;z.getSite().done(function(P){if(!P.modifiedTiles){P.modifiedTiles={};}if(!P.modifiedTiles[T.id]){P.modifiedTiles[T.id]={id:T.id};}B={};if(O!==N){B.title=N;P.modifiedTiles[T.id].title=N;T.title=N;}if(J!==H){B.subtitle=H;P.modifiedTiles[T.id].subTitle=H;T.subTitle=H;}if(I!==F){B.info=F;P.modifiedTiles[T.id].info=F;T.info=F;}if(K._mResolvedTiles[T.id].tileComponent){K._mResolvedTiles[T.id].tileComponent.tileSetVisualProperties(B);}else if(K._mResolvedTiles[T.id].linkTileControl){if(B.title){K._mResolvedTiles[T.id].linkTileControl.setHeader(B.title);}if(B.subtitle){K._mResolvedTiles[T.id].linkTileControl.setSubheader(B.subtitle);}if((B.title)||(B.subtitle)){K._mResolvedTiles[T.id].linkTileControl.rerender();}}z.save().fail(function(Q){jQuery.sap.log.error(Q);e.reject("Could not save personalization changes: "+Q);}).done(function(){e.resolve();});}).fail(function(P){jQuery.sap.log.error(P);e.reject("Cannot get site: "+P);});}return e.promise();};this.getTileActions=function(T){var e=[],z,B;if(this._isGroupTile(T)&&!this._isFailedGroupTile(T)){B=new sap.ui.model.json.JSONModel({config:{"display_title_text":this.getTileTitle(T),"display_subtitle_text":this.getTileSubtitle(T),"display_info_text":this.getTileInfo(T)}});z=c.getTileSettingsAction(B,this._onTileSettingsSave.bind(this,T),this.getTileType(T));e.push(z);}return e;};function i(P,T){var e=j(P,T);e.isBookmark=true;return e;}function j(P,T){var e={id:U.generateUniqueId([])};k(e,P,T);return e;}function k(T,P,e){P=jQuery.extend(true,{},P);if(e){T.target=e;}if(P.title||P.title===""){T.title=P.title;}if(P.icon||P.icon===""){T.icon=P.icon;}if(P.subtitle||P.subtitle===""){T.subTitle=P.subtitle;}if(P.info||P.info===""){T.info=P.info;}if(P.dataSource){T.dataSource={};jQuery.extend(true,T.dataSource,P.dataSource);delete P.serviceUrl;}else if(P.dataSource===null){delete T.dataSource;delete T.indicatorDataSource;delete P.serviceUrl;}if((P.dataSource||T.dataSource)&&P.serviceUrlPath){T.indicatorDataSource={path:P.serviceUrlPath};}if(P.serviceUrl||P.serviceUrl===""){if(T.dataSource){jQuery.sap.log.warning("`serviceUrl` is marked for deprecation in the future."+"It is not the preferred means for defining a dynamic "+"tile's data source. Please use `oParameter.dataSource`");delete T.dataSource;}T.indicatorDataSource={path:P.serviceUrl};}else if(P.serviceUrl===null&&!T.dataSource){delete T.indicatorDataSource;}if(P.serviceRefreshInterval||P.serviceRefreshInterval===0){T.indicatorDataSource.refresh=P.serviceRefreshInterval;}}function q(T,O){if(T&&O){if(T.url){return T.url===O.url;}return T.semanticObject===O.semanticObject&&T.action===O.action&&t(T.parameters,O.parameters);}return T===O;}function t(P,O){var F,e;P=P||[];O=O||[];if(P.length===O.length){F=v(P);e=v(O);return F===e;}return false;}function v(e){return e.map(function(P){return P.name+P.value;}).sort().join();}function w(e){return{url:e};}function x(I){var T={semanticObject:I.semanticObject,action:I.action,parameters:y(I.params)};if(I.appSpecificRoute){T.appSpecificRoute=I.appSpecificRoute;}return T;}function y(I){return Object.keys(I).map(function(K){var V=I[K]&&I[K][0];return{name:K,value:V||""};});}}d.prototype._getMember=function(O,A){return U.getMember(O,A);};return d;},true);
