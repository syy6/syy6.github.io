// Copyright (c) 2009-2017 SAP SE, All Rights Reserved
sap.ui.define(['sap/ui/core/support/Plugin','sap/ui/model/json/JSONModel','sap/m/Button','sap/m/IconTabBar','sap/m/IconTabFilter','sap/m/Label','sap/m/Text','sap/m/MessageStrip','sap/m/FlexBox','sap/ui/model/resource/ResourceModel','sap/m/SearchField','sap/m/MessageBox'],function(P,J,B,I,a,L,T,M,F,R,S,b){"use strict";var t=this,o,f=P.extend("sap.ushell.support.plugins.flpConfig.FlpConfigurationPlugin",{constructor:function(s){o=new R({bundleName:"sap/ushell/support/plugins/flpConfig/i18n/FlpConfigurationPlugin"});P.apply(this,["sapUiFlpConfigurationPlugin",o.getResourceBundle().getText("PLUGIN_NAME"),s]);this._oSupportStub=s;if(this.runsAsToolPlugin()){t=this;this._aEventIds=[this.getId()+"ReceiveData"];}else{this._aEventIds=[this.getId()+"RequestData"];}}});f.prototype.isToolPlugin=function(){return true;};f.prototype.isAppPlugin=function(){return true;};f.prototype.init=function(s){P.prototype.init.apply(this,arguments);if(this.runsAsToolPlugin()){var r;setTimeout(function(){t.requestData();},500);r=sap.ui.getCore().createRenderManager();r.write("<div id='"+this.getId()+"'</div>").flush(this.$().get(0));r.destroy();}else{}};f.prototype.exit=function(s){P.prototype.exit.apply(this,arguments);};f.prototype.requestData=function(){this._oSupportStub.sendEvent(this.getId()+"RequestData",{eventData:{data:{}}});};f.prototype.onsapUiFlpConfigurationPluginRequestData=function(E){var p={};this.prepareForSending(window["sap-ushell-config"],p);this._oSupportStub.sendEvent(this.getId()+"ReceiveData",{eventData:{data:p}});};f.prototype.onsapUiFlpConfigurationPluginReceiveData=function(E){var t=this;this.flpConfig=E.getParameter("eventData").data;sap.ui.getCore().loadLibraries(["sap.ui.table"],{async:true}).then(function(){sap.ui.require(["sap/ui/table/TreeTable","sap/ui/table/Column"],function(i,C){t.getFlpConfigurationPluginUI(null,i,C);});});};function _(E){var H=0,s=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getSelectedKey(),i=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel().getData();if(jQuery.isArray(i[s])){i[s].forEach(function(p,j){var k=d(i[s][j],s);if(H<k){H=k;}});if(H>0){sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+s).expandToLevel(H-1);}else{b.error(new L({text:sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel("i18n").getResourceBundle().getText("MISSING_HIERARCHY_LEVEL")}));}}}function c(E){var s=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getSelectedKey();sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+s).collapseAll();}f.prototype.onPressSearchNewModel=function(E){var p,q,r,A,s,u,v,w,V,x=[],y={},z="",C={},D={},G=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel("Full"),H=E.getParameter("query");if(!G){G=sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").getModel().getData();}else{G=G.getData();}Object.keys(G).forEach(function(K){y[K]=0;});if(H){for(var K in G){z=K;p=[];m(G[K],K,z,p,H);D[K]=p;}Object.keys(D).forEach(function(K){A=D[K];for(var i=0;i<A.length;i++){s=A[i].split(".");u=[];for(var j=0;j<s.length;j++){if(!isNaN(parseInt(s[j],10))){u.push(parseInt(s[j],10));}else{u.push(s[j]);}}for(var k=0;k<u.length;k+=2){v={"property":""};v[u[0]]=[];if(isNaN(parseInt(u[k],10))){q=u.slice(0,k+1);if(!e(C,q)&&typeof e(C,u.slice(0,u.length-2))!=='object'){l(C,q,[v],u[0],q.length);}V=e(G,u.slice(0,k+2));if(V&&e(C,u.slice(0,k+2))){h(C,V.property,u.slice(0,k+2).toString()+",property");}else if(k!==u.length-2){x.push(u.slice(0,k+2).toString());}}}r=u.slice(0);l(C,u,{'property':"",'value':""},u[0],q.length);V=e(G,r);if(V){h(C,V.value,r.toString()+",value");h(C,V.property,r.toString()+",property");}}x.forEach(function(z){V=e(G,z.split(","));if(V&&e(C,z.split(","))){h(C,V.property,z+",property");}});x=[];if(C[K]&&jQuery.isArray(C[K][0][K])&&C[K][0][K].length===0){C[K]=C[K].splice(1);}});sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(C));sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(G),"Full");var N=0;Object.keys(y).forEach(function(K){w=K;if(C[w]&&jQuery.isArray(C[w])){C[w].forEach(function(i,j){var k=d(C[w][j],w);if(N<k){N=k;}});}sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TreeTable"+K).expandToLevel(N-1);sap.ui.getCore().byId(K).setCount(g(C[K],K,0));});}else{Object.keys(y).forEach(function(K){sap.ui.getCore().byId(K).setCount(g(G[K],K,0));});sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar").setModel(new J(G));}};function d(C,s){var H=0;if(C[s]){C[s].forEach(function(p){var i=d(p,s);if(i>H){H=i;}});}return H+1;}function e(j,p){for(var i=0;i<p.length;i++){if(j){j=j[p[i]];}}return j;}function g(C,s,p){if(jQuery.isArray(C)){C.forEach(function(i){if(i[s]){p=g(i[s],s,p);}else{p+=1;}});return p;}else{return undefined;}}function h(j,v,p){var k=p.split(',');for(var i=0;i<k.length-1;i++){j=j[k[i]];}j[k[k.length-1]]=v;}function l(i,p,v,s,j){if(p.length===1){i[p[0]]=v;}else{var k=p.shift();i[k]=l(typeof i[k]==='undefined'?{}:i[k],p,v,s,j);}if(i[s]&&i.property&&i.value){delete i.value;i.property="";}return i;}function m(C,p,s,i,j){C.forEach(function(k,q){if(k[p]){s=s+"."+q+"."+p;s=m(k[p],p,s,i,j);}else if(k.property.indexOf(j)>-1){s=s+"."+q;i.push(s);s=s.substring(0,s.lastIndexOf("."));}});s=s.substring(0,s.lastIndexOf("."));if(isNaN(parseInt(s.substr(s.lastIndexOf(".")+1),10))){return s;}else{return s.substring(0,s.lastIndexOf("."));}}function n(C,p){if(typeof C!=="object"){return[{property:p,value:C}];}return Object.keys(C).map(function(s){var r={property:s};if(typeof(C[s])==='object'&&Object.keys(C[s]).length!==0){r[p]=n(C[s],p);return r;}else{if(!jQuery.isEmptyObject(C[s])||typeof(C[s])!=='object'){r.value=C[s];}else{r.value="";}return r;}});}f.prototype.prepareForSending=function(i,p){Object.keys(i).forEach(function(k){var C=i[k];switch(typeof C){case'object':if(C===null){p[k]=C;return;}else if(Array.isArray(C)){p[k]=[];}else{p[k]={};}this.prepareForSending(i[k],p[k]);break;case'undefined':p[k]="undefined";return;case'function':return;default:p[k]=i[k];return;}}.bind(this));};f.prototype.getNewConfigJSON=function(i){var N={};Object.keys(i).forEach(function(s){N[s]=n(i[s],s);});return N;};f.prototype.getFlpConfigurationPluginUI=function(i,j,C){var k,p,q,r={};q=this.getNewConfigJSON(this.flpConfig);k=new J(q);for(var s in q){r[s]=g(q[s],s,0);}if(!sap.ui.getCore().byId("sap-ui-support-flpConfigurationPlugin-TabBar")){if(!q||jQuery.isEmptyObject(q)){new M({text:o.getResourceBundle().getText("ERROR_MESSAGE"),type:"Warning",showIcon:true,showCloseButton:false}).placeAt(this.getId());}else{p=new I("sap-ui-support-flpConfigurationPlugin-TabBar",{headerMode:"Inline"});Object.keys(this.flpConfig).forEach(function(v,w){p.insertItem(new a(v,{key:v,text:v,count:r[v],content:[new j("sap-ui-support-flpConfigurationPlugin-TreeTable"+v,{rows:"{/"+v+"/}",selectionMode:sap.ui.table.SelectionMode.None,enableCellFilter:true,extension:[new F({items:[new B({icon:"sap-icon://expand",text:"{i18n>EXPAND_BUTTON}",press:_}),new B({icon:"sap-icon://collapse",text:"{i18n>COLLAPSE_BUTTON}",press:c})]})],columns:[new C({label:new L({text:"{i18n>COLUMN_PROPERTY}"}),template:new T({text:"{property}"})}),new C({label:new L({text:"{i18n>COLUMN_VALUE}"}),template:new T({text:"{value}"})})]})]}),w);});var u=new S({search:this.onPressSearchNewModel});u.placeAt(this.getId());p.setModel(k);p.setModel(o,"i18n");p.placeAt(this.getId());}}};return f;});
