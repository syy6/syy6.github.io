sap.ui.define(["jquery.sap.global","sap/suite/ui/commons/library","sap/ui/core/Control","sap/ui/core/theming/Parameters","./TAccountPanel","sap/ui/core/IconPool","sap/ui/core/Icon","sap/m/Button","sap/base/security/encodeXML","sap/ui/core/Configuration","sap/ui/core/delegate/ItemNavigation","./TAccountUtils"],function(q,l,C,P,T,I,a,B,e,b,c,d){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var f=C.extend("sap.suite.ui.commons.taccount.TAccountGroup",{metadata:{library:"sap.suite.ui.commons",properties:{title:{type:"string",group:"Misc",defaultValue:null},collapsed:{type:"boolean",group:"Misc",defaultValue:false}},aggregations:{accounts:{type:"sap.suite.ui.commons.taccount.TAccount",multiple:true,singularName:"account"}},events:{}},renderer:function(R,g){if(!g._bThemeApplied){return;}R.write("<div");R.addClass("sapSuiteUiCommonsAccountGroup");if(g.getCollapsed()){R.addClass("sapSuiteUiCommonsAccountGroupCollapsed");}R.writeClasses(g);R.writeControlData(g);R.writeAttributeEscaped("aria-label",g._getSum());R.write(">");R.write("<div class=\"sapSuiteUiCommonsGroupHeader\">");R.write("<div class=\"sapSuiteUiCommonsGroupHeaderExpandWrapper\">");R.renderControl(g._getExpandCollapse());R.write("</div>");R.write("<div class=\"sapSuiteUiCommonsGroupHeaderFirst\">");R.write("<span class=\"sapSuiteUiCommonsGroupHeaderTitle\">"+e(g.getTitle())+"</span>");R.write("<span id=\""+g.getId()+"-sum\" class=\"sapSuiteUiCommonsGrouptHeaderSUM\">"+g._getSumText()+"</span>");R.write("<div id=\"\" class=\"sapSuiteUiCommonsGroupInfoIconWrapper sapSuiteUiCommonsTAccountBaseInfoIconWrapper\" title=\""+r.getText("TACCOUNT_SELECTED")+"\">");R.write("<span class=\"sapSuiteUiCommonsInfoIcon\">");R.write("!");R.write("</span>");R.write("</div>");R.write("</div>");R.write("<div class=\"sapSuiteUiCommonsGroupHeaderSecond\">");R.renderControl(g._getExpandAllAccounts());R.renderControl(g._getCollapseAllAccounts());R.write("</div>");R.write("</div>");R.write("<div id=\""+g.getId()+"-content\" class=\"sapSuiteUiCommonsAccountGroupContent\">");g.getAccounts().forEach(function(i){R.renderControl(i);});R.write("</div>");R.write("</div>");}});f.prototype.init=function(){sap.ui.getCore().attachThemeChanged(function(){this._bThemeApplied=true;this.invalidate();},this);this._bThemeApplied=sap.ui.getCore().isThemeApplied();q(window).resize(function(){this._adjustUI();}.bind(this));};f.prototype.exit=function(){if(this._oIconExpand){this._oIconExpand.destroy();}if(this._oIconCollapse){this._oIconCollapse.destroy();}};f.prototype.onBeforeRendering=function(){this._oSum=null;this._iColumnCount=-1;};f.prototype.onAfterRendering=function(){this._adjustUI();this._setupKeyboard();};f.prototype._setupKeyboard=function(){if(!this._oItemNavigation){this._oItemNavigation=new c();this.addDelegate(this._oItemNavigation);}this._oItemNavigation.setRootDomRef(this.getDomRef("content"));this._oItemNavigation.setItemDomRefs(this.$().find(".sapSuiteUiCommonsAccount"));this._oItemNavigation.setCycling(true);};f.prototype._getExpandCollapse=function(){if(!this._oArrowDown){this._oArrowDown=new a({src:"sap-icon://navigation-down-arrow",press:function(){this._expandCollapse();}.bind(this)});}return this._oArrowDown;};f.prototype._expandCollapse=function(){var g=this.getCollapsed();this._oArrowDown.setSrc(g?"sap-icon://navigation-down-arrow":"sap-icon://navigation-right-arrow");this.setProperty("collapsed",!g,true);this.$("content")[g?"show":"hide"]("medium");this.$()[!g?"addClass":"removeClass"]("sapSuiteUiCommonsAccountGroupCollapsed");};f.prototype._expandCollapseAllAccounts=function(E){this.getAccounts().forEach(function(A){A.setCollapsed(!!E);});};f.prototype._getExpandAllAccounts=function(){if(!this._oIconExpand){this._oIconExpand=new B({icon:"sap-icon://expand-all",type:"Transparent",tooltip:r.getText("TACCOUNT_EXPAND"),press:this._expandCollapseAllAccounts.bind(this,false)}).addStyleClass("sapSuiteUiCommonsGroupHeaderIcon");}return this._oIconExpand;};f.prototype._getCollapseAllAccounts=function(){if(!this._oIconCollapse){this._oIconCollapse=new B({icon:"sap-icon://collapse-all",type:"Transparent",tooltip:r.getText("TACCOUNT_COLLAPSE"),press:this._expandCollapseAllAccounts.bind(this,true)}).addStyleClass("sapSuiteUiCommonsGroupHeaderIcon");}return this._oIconCollapse;};f.prototype._getSum=function(){var A=this.getAccounts(),s=0,m="",g=true;if(!this._oSum){for(var i=0;i<A.length;i++){var o=A[i];if(m&&m!==o.getMeasureOfUnit()){g=false;break;}m=o.getMeasureOfUnit();s+=o._getSum();}this._oSum={sum:s,measure:m,correct:g};}return this._oSum;};f.prototype._getSumText=function(){var s=this._getSum();if(s&&s.correct){var v=d.formatCurrency(Math.abs(s.sum),s.measure);return(s.sum>0?r.getText("TACCOUNT_CREDIT"):r.getText("TACCOUNT_DEBIT"))+": "+v+" "+e(s.measure);}return"-";};f.prototype._getAriaText=function(){return"T Account Group "+e(this.getTitle())+" "+this._getSumText();};f.prototype._adjustUI=function(){var g=320,S=16,h=g+S;var $=this.$("content"),w=$.width(),j=Math.max(Math.ceil(w/(h))-1,1);if(j===this._iColumnCount){return;}var m=q("<div id=\""+this.getId()+"-content\" class=\"sapSuiteUiCommonsAccountGroupContent\"/>"),H=Array.apply(null,Array(j)).map(Number.prototype.valueOf,0);var n=this.$().find(".sapSuiteUiCommonsAccount"),o=0;this._iColumnCount=j;this._iDivs=[];var D="<div class=\"sapSuiteUiCommonsAccountGroupDroppingArea\"><div class=\"sapSuiteUiCommonsAccountGroupDroppingAreaInner\">"+"</div><div class=\"sapSuiteUiCommonsAccountGroupDroppingAreaInnerBall\"></div></div>";for(var i=0;i<j;i++){var s="<div class=\"sapSuiteUiCommonsAccountGroupColumn\">"+D+"</div>",p=q(s);m.append(p);this._iDivs.push(p);}for(var i=0;i<n.length;i++){var t=q(n[i]),u=t.height(),v=this._iDivs[o];var M=Number.MAX_VALUE,x=0;for(var k=0;k<j;k++){var y=H[k];if(y<M){M=y;x=k;}}var v=this._iDivs[x];t.detach().appendTo(v);q(D).appendTo(v);H[x]+=u;}$.detach();this.$().append(m);this._setupDroppable();};f.prototype._setupDroppable=function(){var i=this.$().find(".sapSuiteUiCommonsAccountGroupDroppingArea");i.droppable({scope:this.getId()+"-content",tolerance:"pointer",activeClass:"sapSuiteUiCommonsAccountGroupDroppingAreaActive",hoverClass:"sapSuiteUiCommonsAccountGroupDroppingAreaActive",drop:function(E,u){var $=q(this),g=u.draggable,h=g.next();if(h[0]!==$[0]){h.detach().insertAfter($);g.detach().insertAfter($);}else{g.detach().insertBefore($);}g.css("left",0);g.css("top",0);},over:function(g,u){}});};f.prototype._valueChanged=function(D){var s=this._getSum();if(s.correct){this._oSum.sum+=D;this.$("sum").text(this._getSumText());}var p=this.getParent();if(this._hasPanelParent(p)){p._valueChanged(D);}};f.prototype._hasPanelParent=function(p){return(p||this.getParent())instanceof T;};return f;},true);
