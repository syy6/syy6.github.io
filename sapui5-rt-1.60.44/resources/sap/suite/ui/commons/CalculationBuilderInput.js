sap.ui.define(["jquery.sap.global","./library","sap/ui/core/Control","./CalculationBuilderItem","sap/m/List","sap/m/ListMode","sap/m/StandardListItem","sap/m/ResponsivePopover","sap/m/PlacementType","sap/m/Button","sap/m/ButtonType","sap/m/Menu","sap/m/MenuButton","sap/m/MenuItem","sap/m/OverflowToolbar","sap/m/ToolbarSeparator","sap/m/ToolbarSpacer","sap/m/Title","sap/m/OverflowToolbarToggleButton","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/ui/model/json/JSONModel","sap/ui/Device"],function(q,l,C,a,L,b,S,R,P,B,c,M,d,f,O,T,g,h,j,k,m,J,D){"use strict";var E="&nbsp;&nbsp;";var n="┘┘";var I=l.CalculationBuilderItemType,V=l.CalculationBuilderValidationMode;var r=sap.ui.getCore().getLibraryResourceBundle("sap.suite.ui.commons");var o=function(e){if(typeof e.which==="undefined"){return true;}else if(typeof e.which==="number"&&e.which>0){return!e.ctrlKey&&!e.metaKey&&!e.altKey&&e.which!==8;}return false;};var G=function(e,s){var N,t="",i=0;if(e instanceof q){e=e[0];}var u=e.nodeType;if(!u){while((N=e[i++])){t+=G(N,s);}}else if(u===1||u===9||u===11){for(e=e.firstChild;e;e=e.nextSibling){t+=G(e,s);}}else if(u===3||u===4){t+=s&&q(e).parent().hasClass("sapCalculationBuilderItemTextEmpty")&&e.nodeValue==="  "?"┘┘":e.nodeValue;}return t;};var p=C.extend("sap.suite.ui.commons.CalculationBuilderInput",{metadata:{library:"sap.suite.ui.commons",events:{change:{parameters:{value:"String",position:"integer",validate:"boolean"}}}},renderer:function(e,i){var s="contenteditable=\"true\"";if(i.getParent().getShowInputToolbar()&&!i._bReadOnly){e.write("<div class=\"sapCalculationBuilderInputToolbarWrapper\">");e.renderControl(i._oInputToolbar);e.write("</div>");}e.write("<div");e.writeControlData(i);e.addClass("sapCalculationBuilderInputWrapper");if(i._bReadOnly){s="";}e.writeClasses(i);e.write(" aria-label=\"\" >");e.write("<div aria-label=\"\" aria-describedby=\""+i.getId()+"-error\" spellcheck=\"false\""+s+" id=\""+i.getId()+"-input\" class=\"sapCalculationBuilderInput\"></div>");e.write("<div id=\""+i.getId()+"-error\" class=\"sapCalculationBuilderInputErrorArea\"></div>");e.write("</div>");}});p.prototype.init=function(){this._setupSuggestionList();this._iCarretPosition=0;this._sSuggestionText="";this._aVariables=[];this._oInputToolbar=new O(this.getId()+"-toolbar").addStyleClass("sapCalculationBuilderInputToolbar");this.addDependent(this._oInputToolbar);};p.prototype.exit=function(){if(this._oPopup){this._oPopup.destroy();}if(this._oInputToolbar){this._oInputToolbar.destroy();}};p.prototype.onAfterRendering=function(){this._setupKeyPress();this._setupEvents();this._setupAriaLabel();};p.prototype.onBeforeRendering=function(){this._aFunctions=this.getParent()._getAllFunctions();this._fillInputToolbar();};p.prototype.getFocusDomRef=function(){return this.getDomRef("input");};p.prototype._setupEvents=function(){var $=this.$("input");$.blur(function(){this._lastRangeSelection=this._getSelectionRange();}.bind(this));$.mouseup(function(e){this._iCarretPosition=this._getCaretPosition();}.bind(this));};p.prototype._validate=function(s){var e=this.getParent();if(e&&e.getValidationMode()===V.FocusOut){this.getParent()._validateInput(G(this.$("input")),s?this._iCarretPosition:0);}};p.prototype._setupKeyPress=function(){var t=this,i=this.getParent(),A=i&&i.getAllowSuggestions()&&D.system.desktop,s="paste input";if(D.browser.msie){s+=" keyup";}this.$("input").on('focus',function(){var $=q(this);$.data('before',G($[0]));}).on(s,function(e){var $=q(this),u=$.data('before'),v=e.key,w=G($[0]);if(t._oPopup.isOpen()&&v==="Enter"){return;}if(u!==w){var x=t._iCarretPosition=t._getCaretPosition();t._storeCurrent();t.fireChange({position:Math.max(0,x),value:G($[0],true)});if(A){t._checkSuggestions(x,w,o(e));if(t._sSuggestionText.length>0){t._filterSuggestionList(t._sSuggestionText);if(t._oSuggestionList.getItems().length===0){t._oPopup.close();}else{t._findCurrentSpan();if(!t._oPopup.isOpen()){var y=sap.ui.getCore().getConfiguration().getRTL(),z=q(t._oCurrentSpan),F=y?-($.width()-z.position().left-z.width()):z.position().left;var H=parseInt(F,10),K=t.$("input").outerHeight()-(parseInt(q(t._oCurrentSpan).position().top,10)+q(t._oCurrentSpan).height())-10;t._iSuggestionSelectedIndex=-1;t._oPopup.setOffsetX(H);t._oPopup.setOffsetY(-K);t._oPopup.openBy(t.getDomRef("input"));}}}}}});};p.prototype._createItemSpan=function(K,e){var i=function(){if(!K){return"sapCalculationBuilderItemTextEmpty";}if(e){return"sapCalculationBuilderItemTextError";}if(this._isOperator(K)){return"sapCalculationBuilderItemTextOperator";}return"sapCalculationBuilderItemTextDefault";}.bind(this);var F=K?"text":"html";var N=q('<span />',{title:e?e.title:"","class":i(),"aria-hidden":D.browser.msie})[F](K||E);return N;};p.prototype._findCurrentSpan=function(){var s;if(window.getSelection&&window.getSelection().getRangeAt){s=window.getSelection();this._oCurrentSpan=s.anchorNode.parentNode;if(!q(this._oCurrentSpan).is("span")){this._oCurrentSpan=this.$("input").children().first()[0];}}return this._oCurrentSpan;};p.prototype._setupSuggestionList=function(){var s=new m({path:"grouptitle",descending:false,group:function(i){return i.getProperty("grouptitle");}});var A=function(K){var N=this._createItemSpan(K);q(this._oCurrentSpan).after(N);return N;}.bind(this);var e=function($){var t=$.innerText,v=this._sSuggestionText.toLowerCase(),i=v.length,u=t.toLowerCase(),N="",w=(" "+u).indexOf(" "+v),x;if(w>-1){N+=t.substring(0,w);x=t.substring(w,w+i);N+="<span class=\"sapMInputHighlight\">"+x+"</span>";N+=t.substring(w+i);}else{N=t;}return N;}.bind(this);this._oSuggestionList=new L({mode:b.SingleSelectMaster,showNoData:false,enableBusyIndicator:false,rememberSelections:false,items:{path:"/data",factory:function(i,t){var u=t.getProperty(t.oModel.sPath),v=new S({title:u.title,customData:[new k({key:"key",value:u.key})]});v.addStyleClass("sapCalculationBuilderSuggestionItem");return v;},sorter:s},selectionChange:function(t){var u=t.getParameter("listItem"),v,w,F,K,x;if(u){K=u.getCustomData()[0].getValue();F=this._getFunction(K);q(this._oCurrentSpan).text(F?K+"(":K+"");q(this._oCurrentSpan).removeClass("sapCalculationBuilderItemTextError").addClass("sapCalculationBuilderItemTextDefault");this._iCarretPosition+=(K||"").length+1;if(F){x=this._getFunctionTemplateItems(F);v=x.length;if(v>0){x.forEach(function(K,i){this._oCurrentSpan=A(K)[0];if(!K&&!w){w=this._oCurrentSpan;}if(!w&&K){this._iCarretPosition+=K.length;}if(K&&i!==v-1){this._oCurrentSpan=A(" ");}}.bind(this));}else{w=this._oCurrentSpan=A("")[0];}var y=A(")");if(!w){this._oCurrentSpan=y[0];}}this._storeCurrent();var z=w||this._oCurrentSpan,H=(z&&z.textContent&&z.textContent.length)||0;this.fireChange({position:this._getCaretPosition(z,F?1:H),value:G(this.$("input")[0],true)});}this._oPopup.close();}.bind(this)});this._oSuggestionList.addEventDelegate({onAfterRendering:function(){this._oSuggestionList.$().find(".sapMDLILabel, .sapMSLITitleOnly, .sapMDLIValue").each(function(){this.innerHTML=e(this);});}.bind(this)});this._oPopup=new R(this.getId()+"-popup",{contentWidth:"300px",showArrow:false,showHeader:false,placement:P.Vertical,horizontalScrolling:true,content:this._oSuggestionList}).attachAfterClose(function(i){this._clearSuggestion();}.bind(this));};p.prototype._checkSuggestions=function(e,t,s){var u=t[Math.max(e-1,0)];var v=function(u){return this._isOperator(u)||this._isEmptySpace(u);}.bind(this);if(!u||v(u)){this._clearSuggestion();return;}var w=s?u:"",x=s?2:1;e=Math.max(e,0);for(var i=e-x;i>=0;i--){if(v(t[i])){break;}w=t[i]+w;}for(i=e;i<t.length;i++){if(v(t[i])){break;}w=w+t[i];}if(!w){this._clearSuggestion();}this._sSuggestionText=w||"";};p.prototype._clearSuggestion=function(){this._sSuggestionText="";this._oCurrentSpan={};this._oPopup.close();};p.prototype._filterSuggestionList=function(t){var e=[];var A=function(K,s,u,v){var w=(s||K).toLowerCase(),x=t.toLowerCase();if((" "+w).indexOf(" "+x)!==-1){e.push({title:s||K,key:K,type:u,grouptitle:v});}};var i=this.getParent();i.getOperators().forEach(function(s){A(s.getKey(),s.getText(),I.CustomOperator,r.getText("CALCULATION_BUILDER_OPERATORS_TITLE"));});this._aVariables.forEach(function(v){var s=v.getGroup(),u,w=r.getText("CALCULATION_BUILDER_VARIABLES_TITLE");if(s){u=i.getGroups().filter(function(x){return x.getKey()===s;})[0];w=u?u.getTitle():w;}A(v.getKey(),v.getLabel(),I.Variable,w);});this._aFunctions.forEach(function(s){A(s.key,s.title,I.Function,r.getText("CALCULATION_BUILDER_FUNCTIONS_TITLE"));});e.sort(function(s,u){return s.title.toUpperCase()<u.title.toUpperCase()?-1:1;});this._oSuggestionList.setModel(new J({"data":e}));};p.prototype._getCaretPosition=function(s,t){var u,v,w,A=0;var x=function(N){return(s&&N===s)||(!s&&(N===v.anchorNode||N===v.anchorNode.parentNode));};var y=function(N){var z;if(x(N)){return false;}if(N.nodeType===3){A+=N.textContent.length;}else{for(var i=0;i<N.childNodes.length;i++){z=N.childNodes[i];if(x(z)){return false;}A+=z.textContent.length;}}return true;};try{if(window.getSelection&&window.getSelection().getRangeAt){u=window.getSelection().getRangeAt(0);v=window.getSelection();w=this.$("input")[0].childNodes;for(var i=0;i<w.length;i++){if(!y(w[i])){break;}}return(t||u.startOffset)+A;}}catch(e){return this._iCarretPosition;}return 0;};p.prototype._getSelectionRange=function(){var s,i=0,t=this.$("input")[0];if(typeof window.getSelection!=="undefined"){try{var u=window.getSelection().getRangeAt(0),v=u.cloneRange();if(!q.sap.containsOrEquals(t,u.startContainer)){return this._lastRangeSelection;}v.selectNodeContents(t);v.setEnd(u.startContainer,u.startOffset);s=v.toString().length;i=s+u.toString().length;}catch(e){i=s=this._iCarretPosition||0;}}return{start:s,length:i-s};};p.prototype._setCaretPosition=function(e){var s=window.getSelection(),$=this.$("input"),t,u,v,F,w;var x=function(w){var y=$.children(),z,A,H=0;for(var i=0;i<y.length;i++){z=y[i];A=z.innerText||"";if(H+A.length>w){return{spanIndex:i,position:H+A.length-w};}H+=A.length;}return{spanIndex:Math.max(i-1,0),position:100};};if(typeof e==="number"){e=x(e);}v=e&&e.span;if(e){t=$[0];if(!v){v=t&&t.children&&t.children.length>e.spanIndex?t.childNodes[e.spanIndex]:null;}if(v){u=document.createRange();F=v.firstChild?v.firstChild:v;w=Math.min(F.length,e.position);u.setStart(F,w);u.collapse(true);s.removeAllRanges();s.addRange(u);}}};p.prototype._recreateText=function(e){var s=function(A){var F;if(A){if(!this._isEmptySpace(A)){F=q.grep(e.errors,function(K){return K.index===w;})[0];}if(A==="┘"){A="";}H+=this._createItemSpan(A,F)[0].outerHTML;if(!this._isEmptySpace(A)){w++;}x++;}}.bind(this);var t=function(){for(;i<v.length;i++){u();if(!this._isEmptySpace(v[i])&&v[i]!=="("){i--;break;}W+=v[i];if(v[i]==="("){break;}}s(W);W="";}.bind(this);var u=function(A){if(!y&&e.position===i){y={spanIndex:x-(A||0),position:A||W.length};}};var H="",v,w=0,x=0,y=null,W="",z;v=e.text||G(this.$("input")[0],true);for(var i=0;i<v.length;i++){z=v[i];u();if(z==="┘"||this._isEmptySpace(z)||this._isOperator(z)){if(this._isFunction(W)){t();}else{s(W);s(z);W="";}if(z==="┘"){i++;u(1);}}else{W+=z;}}s(W);this.$("input").html(H);this._showErrorText(true,e.errors);if(e.position>0){this._setCaretPosition(y||{spanIndex:x-1,position:Number.MAX_SAFE_INTEGER});}};p.prototype._setupAriaLabel=function(){var e,i,A;if(D.browser.msie){return;}e=this.getParent();i=e._oExpressionBuilder._aErrors;A=r.getText("CALCULATION_BUILDER_EXPRESSION_TITLE")+": "+e.getExpression();if(i.length>0){A+=". "+r.getText("CALCULATION_BUILDER_ERROR_TITLE")+": ";i.forEach(function(s){A+=s.title+" ";});}this.$().attr("aria-label",A);};p.prototype._showErrorText=function(s,e){var $=this.$("error");e=e||this.getParent().getErrors();if((e&&e.length>0)&&s){var t="",u=5;for(var i=0;i<e.length&&i<u;i++){t+=e[i].title+"\n";}$.show();$.text(t);}else{$.hide();}};p.prototype._stringToItems=function(e){var i=[],s="",t="",u=0;var v=function(){var F,x="";if(t){F=this._getFunction(t);if(F){if(e[u]!=="("){x=I.Error;for(;u<e.length;u++){if(e[u]==="("){x="";break;}if(!this._isEmptySpace(e[u])){u--;break;}}}}var y=new a({key:t});y._sType=x;i.push(y);}t="";return!!F||!!x;}.bind(this);if(!e){e=G(this.$("input")[0],true);}for(;u<e.length;u++){s=e[u];if(s==="┘"){i.push(new a());u++;continue;}if(this._isEmptySpace(s)){if(t){v();}continue;}var N=e[u+1];if(N&&this._isOperator(s+N,false)){s+=N;u++;}var w=this._isOperator(s,false);if(w){if(v()){continue;}i.push(new a({key:s}));}else{t+=s;}}v();return i;};p.prototype._itemsToString=function(e){var s=e.items,t="",u="",v,w,x;var y=function(z){var A="";if(z){A=z.getKey();v=this._isFunction(A);if(v){A+="(";}}return A;}.bind(this);for(var i=0;i<s.length;i++){w=q.grep(e.errors,function(z){return z.index===i;})[0];x=y(s[i]);u+=this._createItemSpan(x,w)[0].outerHTML;if(!v&&x!=="("&&y(s[i+1])!==")"){u+=this._createItemSpan(" ")[0].outerHTML;}t+=x;}this.$("input").html(u);return t;};p.prototype.onfocusin=function(e){if(this._bSetCaretOnFocus){this._setCaretPosition(this._iCarretPosition);}this._bSetCaretOnFocus=false;this._showErrorText(true);};p.prototype.onsapfocusleave=function(e){if(e.relatedControlId&&q.sap.containsOrEquals(this._oPopup.getDomRef(),sap.ui.getCore().byId(e.relatedControlId).getFocusDomRef())){if(sap.ui.getCore().isMobile()||D.browser.safari){this._bSetCaretOnFocus=true;}this.focus();}else{this._showErrorText(false);this._validate(false);}};p.prototype.onsappageup=function(e){this._suggestionListKeyHandling({event:e,add:true,toEnd:true});if(!this._oPopup.isOpen()){this._iCarretPosition=G(this.$("input")).length-1;}};p.prototype.onsapnext=function(e){if(this._iCarretPosition<G(this.$("input")).length-1){this._iCarretPosition++;}};p.prototype.onsapprev=function(e){if(this._iCarretPosition>0){this._iCarretPosition--;}};p.prototype.onsappagedown=function(e){this._suggestionListKeyHandling({event:e,add:false,toEnd:true});if(!this._oPopup.isOpen()){this._iCarretPosition=0;}};p.prototype.onsapdown=function(e){this._suggestionListKeyHandling({event:e,add:true});};p.prototype.onsapescape=function(e){if(this._oPopup.isOpen()){this._oPopup.close();}};p.prototype.onsapup=function(e){this._suggestionListKeyHandling({event:e,add:false});};p.prototype.onsapenter=function(e){if(this._oPopup.isOpen()){this._oSuggestionList.fireSelectionChange({listItem:this._oSuggestionList.getSelectedItem()});}else{this._validate(true);}e.preventDefault();e.stopPropagation();};p.prototype._suggestionListKeyHandling=function(e){var i=e.event,A=e.add,t=e.toEnd,s,u;if(!this._oPopup.isOpen()||!i){return;}A?this._iSuggestionSelectedIndex++:this._iSuggestionSelectedIndex--;s=this._oSuggestionList.$().find(".sapCalculationBuilderSuggestionItem");u=s.length;if((this._iSuggestionSelectedIndex<0)||(!A&&t)){this._iSuggestionSelectedIndex=u-1;}else if((this._iSuggestionSelectedIndex>=u)||(A&&t)){this._iSuggestionSelectedIndex=0;}this._oSuggestionList.removeSelections(true);sap.ui.getCore().byId(s[this._iSuggestionSelectedIndex].id).setSelected(true).focus();i.preventDefault();i.stopPropagation();};p.prototype._displayError=function(s){this.$("input")[s?"addClass":"removeClass"]("sapCalculationBuilderInputError");};p.prototype._insertItemFromToolbar=function(K){var $=this.$("input"),t,N,e;var s=" "+K+" ",F=this._getFunction(K),i=s.length,u;var v=function(){return{start:$.text().length,length:0};};e=this._getSelectionRange()||v();$.focus();this._lastRangeSelection={};t=G($[0],true);if(t[e.start]==="┘"&&t[e.start-1]==="┘"&&e.length===0){e.start--;e.length+=2;}if(F){s=" "+K+"(";u=this._getFunctionTemplateItems(F);if(u.length>0){u.forEach(function(K){s+=K?K:n;});}else{s+=n;}s+=") ";i=s.indexOf(n)+1;}N=[t.slice(0,e.start),s,t.slice(e.start+e.length)].join('');this.fireChange({value:N,position:e.start+i});this._storeCurrent();};p.prototype._convertEmptyHashes=function(t){return t?t.replace(new RegExp(n,'g'),"  "):"";};p.prototype._fillInputToolbar=function(){var e=function(W,X){return new B({type:c.Transparent,text:W==="*"?"x":W,press:this._insertItemFromToolbar.bind(this,W)}).addStyleClass("sapCalculationBuilderInputToolbarButtons "+X);}.bind(this);var i=function(W){if(W){return W.map(function(X){return new f({key:X.getKey(),text:X._getLabel()});}).sort(function(X,Y){return X.getText().localeCompare(Y.getText());});}return[];};var s=function(W){return W.map(function(X){return new f({key:X.getKey(),text:X.getText()?X.getText():X.getKey()});}).sort(function(X,Y){return X.getText().localeCompare(Y.getText());});};var t=function(W){return W.map(function(X){return new f({key:X,text:X});});};var u=function(){var A=this.getParent(),W=A.getAllowComparisonOperators(),X=A.getAllowLogicalOperators(),Y=A.getOperators(),Z=Y.length>0,$,_,a1=[];if(W){$=t(Object.keys(x));a1.push(new f({text:r.getText("CALCULATION_BUILDER_COMPARISON_TITLE"),items:$}));}if(X){_=t(Object.keys(y));a1.push(new f({text:r.getText("CALCULATION_BUILDER_LOGICAL_TITLE"),items:t(Object.keys(y))}));}if(Z){_=s(Y);a1.push(new f({text:r.getText("CALCULATION_BUILDER_ADDITIONAL_OPERATOR"),items:_}));}if(a1.length>1){return a1;}if(W){return $;}if(X){return $;}if(Z){return $;}return[];}.bind(this);var v=function(W){return new d({text:W,menu:new M({itemSelected:function(X){this._insertItemFromToolbar(X.getParameters().item.getKey());}.bind(this)})}).addStyleClass("sapCalculationBuilderInputToolbarFunctionMenu").addStyleClass("sapCalculationBuilderInputToolbarMenuButtons");}.bind(this);var w=l.CalculationBuilderOperatorType,x=l.CalculationBuilderComparisonOperatorType,y=l.CalculationBuilderLogicalOperatorType,z=u(),A=this.getParent(),F=!!A.getTitle()&&(A.getLayoutType()===l.CalculationBuilderLayoutType.TextualOnly),H;this._oInputToolbar.removeAllContent();this._oInputToolbar.addContent(new h({text:A.getTitle(),visible:F}));this._oInputToolbar.addContent(new g());Object.keys(w).forEach(function(W){this._oInputToolbar.addContent(e(w[W],""));}.bind(this));this._oInputToolbar.addContent(new T().addStyleClass("sapUiSmallMarginBeginEnd"));if(z.length>0){this._oInputToolbar.addContent(new d({text:r.getText("CALCULATION_BUILDER_OPERATORS_TITLE"),menu:new M({itemSelected:function(W){this._insertItemFromToolbar(W.getParameters().item.getKey());}.bind(this),items:z})}).addStyleClass("sapCalculationBuilderInputToolbarMenuButtons"));}H=this._aFunctions.map(function(W){return new f({key:W.key,text:W.title});});var K=v(r.getText("CALCULATION_BUILDER_FUNCTIONS_AND_VARIABLES_TITLE"));if(H.length>0){K.getMenu().addItem(new f({text:r.getText("CALCULATION_BUILDER_FUNCTIONS_TITLE"),items:[H]}));}var N=A._getGroupMap(),Q=A.getGroups(),U=N["##DEFAULT##"];if(U&&U.length>0){K.getMenu().addItem(new f({text:r.getText("CALCULATION_BUILDER_VARIABLES_TITLE"),items:i(U)}));}Q.forEach(function(W){var X=N[W.getKey()];if(X&&X.length>0){K.getMenu().addItem(new f({text:W._getTitle(),items:i(X)}));}});this._oInputToolbar.addContent(K);};p.prototype._isOperator=function(s,A){return this.getParent()&&this.getParent()._isOperator(s,A);};p.prototype._getFunctionTemplateItems=function(F){return this.getParent()._getFunctionTemplateItems(F);};p.prototype._isEmptySpace=function(s){return s===String.fromCharCode(160)||s===" ";};p.prototype._isEmptyItem=function(t){return t===E;};p.prototype._getText=function(){return this.$("input").text();};p.prototype._isFunction=function(K){return!!this._getFunction(K);};p.prototype._getFunction=function(K){return this.getParent()._getFunctionDefinition(K);};p.prototype._storeCurrent=function(v){var $=this.$("input");$.data('before',$.text());};return p;},true);
