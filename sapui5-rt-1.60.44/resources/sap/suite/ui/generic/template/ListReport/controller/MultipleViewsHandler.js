sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsSingleTableModeHelper","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsMultipleTablesModeHelper","sap/suite/ui/generic/template/lib/BusyHelper","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/testableHelper"],function(q,B,M,a,b,F,t){"use strict";var P="/listReport/multipleViews";var c=P+"/selectedKey";var d=P+"/mode";var e=P+"/items";function g(s,C,T){var I;var Q;var m;var S;var o=T.oComponentUtils.getTemplatePrivateModel();var f;var D=T.oServices.oApplication.getBusyHelper().getBusyDelay();function h(){return Q&&Q.enableAutoBinding;}function r(){if(I&&I.fnRegisterToChartEvents){return I.fnRegisterToChartEvents.apply(null,arguments);}}function k(){if(I&&I.onDetailsActionPress){return I.onDetailsActionPress.apply(null,arguments);}}function l(){if(!I){return;}var i=x();return i.templateSortOrder;}function n(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var $=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=$.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function p(){if(I){var i=o.getProperty(c);var j=I.getContentForIappState(i);return{mode:m,state:j};}}function R(i){if(I){var j=I.getSelectedKeyAndRestoreFromIappState(i);if(f[j]){o.setProperty(c,j);}}}function u(){return o.getProperty(c);}function v(i){if(!I){return;}var j=function($,_,a1){var b1=T.oCommonUtils.getElementCustomData(_);var c1=f[$]||Object.create(null);c1.selectionVariantFilters=a1;c1.templateSortOrder=b1.TemplateSortOrder;c1.implementingControl=_;c1.dirtyState=0;f[$]=c1;if(S){var d1=e+"/"+$;var e1=function(g1,h1,i1){if(c1.numberOfUpdates!==h1){return;}var f1=q.extend({},o.getProperty(d1));if(!f1.state&&g1=="busy"){setTimeout(function(){if(o.getProperty(d1).state==="busy"){f1=q.extend({},o.getProperty(d1));f1.state="busyLong";o.setProperty(d1,f1);}},D);}f1.state=g1;if(!g1){f1.count=i1;}o.setProperty(d1,f1);};c1.numberOfUpdates=0;c1.updateStartFunction=e1.bind(null,"busy");c1.updateSuccessFunction=e1.bind(null,"");c1.errorFunction=e1.bind(null,"error");var f1={text:b1.text,count:0,state:""};o.setProperty(d1,f1);}};I.init(i,j);}function w(){return m;}function x(){return f[o.getProperty(c)];}function y(i){if(!I){return;}var j=i.getParameter("bindingParams");s.oFiltersWithoutSmartFilterBar=q.extend(true,{},j);if(w()==="multi"){var $=s.oSmartFilterbar.getFilters();s.oFiltersForCounts=z(j);H(s.oSmartTable,j,$);}else if(w()==="single"){s.oFiltersForCounts=q.extend(true,{},j);}A(j);}function A(j){var $=x();if($){var _=$.selectionVariantFilters;for(var i in _){j.filters.push(_[i]);}}}function z(i){var j=q.extend(true,{},i);G(j.filters,s.oMultipleViewsHandler.aTableFilters);return j;}function E(i,j){if(I.getIsDifferentEntitySets&&I.getIsDifferentEntitySets()){Z(i,j.filters);}}function G($,_){for(var i in _){var a1=_[i];for(var j=$.length;j--;j>=0){if(JSON.stringify($[j])===JSON.stringify(a1)){$.splice(j,1);break;}}}}function U(){var i=s.oSmartTable.getModel();var j=[],$;var _=s.oSmartFilterbar.getBasicSearchValue();var a1={};var b1;if(_){a1={search:_};}var c1;for(var d1 in f){c1=q.extend(true,{},s.oFiltersForCounts);b1=s.oSmartFilterbar.getFilters();var e1=f[d1];$=e1.entitySet;if(!$){$=s.oSmartTable.getEntitySet();}e1.numberOfUpdates++;e1.updateStartFunction(e1.numberOfUpdates);if(w()==="multi"){H(e1.implementingControl,c1,b1);}if(e1.selectionVariantFilters&&e1.selectionVariantFilters.length>0){j=c1.filters.concat(e1.selectionVariantFilters);}else{j=c1.filters;}i.read("/"+$+"/$count",{urlParameters:a1,filters:j,groupId:"updateMultipleViewsItemsCounts",success:e1.updateSuccessFunction.bind(null,e1.numberOfUpdates),error:e1.errorFunction.bind(null,e1.numberOfUpdates)});}}function H(i,j,$){E(i,j);N(i,$,j);}function J(){if(S){U();}}function K(){return S;}function L(i){var j=T.oCommonUtils.getMetaModelEntityType(i);return j.navigationProperty;}function N(i,j,$){var _=[],a1=[],b1;if(j.length<1){return;}if(I.getIsDifferentEntitySets&&I.getIsDifferentEntitySets()){_=Z(i,j);}else{_=j;}a1=$.filters&&$.filters.slice();a1=a1.concat(_);b1=new F(a1,true);$.filters=[b1];}function O(i){var j;for(j in f){if(f[j].implementingControl===i){return f[j].properties;}}}function V(j,$,_,a1,b1){var c1,d1,e1,f1,g1;if(j.indexOf("/")!==-1){c1=j.split("/");for(var i=0;i<c1.length-1;i++){d1=c1[i];for(var i in b1){if(b1[i].name===d1){e1=true;break;}}if(!e1){return false;}f1=_.getODataAssociationEnd(a1,d1);a1=f1&&_.getODataEntityType(f1.type);b1=a1&&a1.navigationProperty;}g1=a1&&a1.property;}else{g1=O($);}return g1;}function W(i){var j,$;if(i.indexOf("/")!==-1){j=i.split("/");$=j.pop();}else{$=i;}return $;}function X(i){var j=T.oCommonUtils.isSmartTable(s.oSmartTable);if(i!==2){s.oSmartTable[j?"rebindTable":"rebindChart"]();}if(i>1){if(j){T.oCommonUtils.refreshModel(s.oSmartTable);T.oCommonUtils.refreshSmartTable(s.oSmartTable);}else{}}}function Y(i,j,$){if(!I){return false;}var _=Array.isArray(j);if((_&&j.length===0)||($&&q.isEmptyObject($))){return true;}var a1=u();var b1=T.oComponentUtils.isComponentActive();if(m==="single"){if(_?j.indexOf(a1)<0:(j&&j!==a1)){return true;}if(b1){X(i);return true;}else{j=a1;_=false;}}var c1=function(d1){if(d1===a1&&b1){X(i);return;}var e1=f[d1];if(e1.dirtyState>0&&e1.dirtyState!==i){e1.dirtyState=3;}else{e1.dirtyState=i;}};if(j){if(_){j.forEach(c1);return true;}c1(j);return true;}for(var d1 in f){if(!$||$[f[d1].implementingControl.getEntitySet()]){c1(d1);}}return true;}function Z(i,$){var _,a1,b1,j,c1,d1,e1,f1,g1,h1,g1;if(!$||$.length<1){return;}e1=i.getModel().getMetaModel();f1=T.oCommonUtils.getMetaModelEntityType(i);d1=L(i);g1=q.extend(true,[],$);if(g1[0]&&g1[0].aFilters instanceof Array){c1=g1[0].aFilters;}else{c1=g1;}if(!c1){return;}for(j=c1.length-1;j>=0;j--){a1=false;if(c1[j].aFilters instanceof Array){b1=c1[j].aFilters[0].sPath;}else{b1=c1[j].sPath;}_=V(b1,i,e1,f1,d1);if(!_){c1.splice(j,1);continue;}h1=W(b1);_.some(function(i1){if(i1.name===h1){a1=true;return a1;}});if(!a1){c1.splice(j,1);}}if(g1&&g1[0]&&g1[0].aFilters&&g1[0].aFilters.length<1){g1=[];}return g1;}(function(){var i,j,$,_;i=C.getOwnerComponent().getAppComponent().getConfig();j=i&&i.pages[0]&&i.pages[0].component&&i.pages[0].component.settings;if(!j){return;}$=j.quickVariantSelectionX;_=j.quickVariantSelection;if($&&_){throw new Error("Defining both QuickVariantSelection and QuickVariantSelectionX in the manifest is not allowed.");}Q=$||_;if(!Q){return;}S=Q.showCounts;f=Object.create(null);o.setProperty(P,Object.create(null));o.setProperty(e,Object.create(null));var a1=C.byId("page");var b1=function(c1){o.setProperty(c,c1);var d1=o.bindProperty(c);d1.attachChange(function(e1){if(a1){a1.setPreserveHeaderStateOnScroll(true);}var f1=e1.getSource().getValue();if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(f1);}var g1=s.oIappStateHandler.areDataShownInTable()||s.oWorklistData.bWorkListEnabled;var h1=(m==="single")?3:f[f1].dirtyState;if(s.oWorklistData.bWorkListEnabled&&h1<2){h1=h1+2;}if(g1&&h1>0){X(h1);}else{T.oCommonUtils.setEnabledToolbarButtons(s.oSmartTable);}f[f1].dirtyState=0;s.oIappStateHandler.changeIappState(true,g1);if(T.oCommonUtils.isSmartTable(s.oSmartTable)){if(a1&&a1.getPreserveHeaderStateOnScroll()){a1.setPreserveHeaderStateOnScroll(false);}}});};if(_){I=new M(_,s,C,T,b1,f);m="single";q.sap.log.info("This list supports multiple views with single table");}else{I=new a($,s,C,T,b1,f);m="multi";q.sap.log.info("This list supports multiple views with multiple tables/charts");}o.setProperty(d,m);})();var G=t.testable(G,"fnRemoveTableSettingsFromFilters");var Z=t.testable(Z,"fnCheckIfFiltersSupported");var O=t.testable(O,"findEntityProperties");var N=t.testable(N,"fnAddFiltersFromSmartFilterbar");t.testable(function(){return I;},"getImplementingHelper");return{getEnableAutoBinding:h,fnRegisterToChartEvents:r,onDetailsActionPress:k,determineSortOrder:l,onDataRequested:J,formatItemTextForMultipleView:n,getContentForIappState:p,restoreFromIappState:R,getVariantSelectionKey:u,init:v,getMode:w,onRebindContentControl:y,getShowCounts:K,refreshOperation:Y};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.MultipleViewsHandler",{constructor:function(s,C,T){q.extend(this,g(s,C,T));}});});
