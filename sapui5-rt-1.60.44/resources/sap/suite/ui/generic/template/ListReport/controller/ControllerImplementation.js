sap.ui.define(["jquery.sap.global","sap/ui/model/json/JSONModel","sap/m/ObjectIdentifier","sap/m/Table","sap/m/Text","sap/ui/comp/smartfield/SmartField","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/ListReport/extensionAPI/ExtensionAPI","sap/m/MessageBox","sap/suite/ui/generic/template/js/AnnotationHelper","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/listTemplates/listUtils","sap/suite/ui/generic/template/ListReport/controller/IappStateHandler","sap/suite/ui/generic/template/ListReport/controller/MultipleViewsHandler","sap/suite/ui/generic/template/ListReport/controller/WorklistHandler","sap/suite/ui/generic/template/lib/ShareUtils","sap/ui/model/Filter","sap/ui/comp/navpopover/LinkData"],function(q,J,O,T,a,S,b,E,M,A,c,l,I,d,W,e){"use strict";return{getMethods:function(v,t,C){var s={};s.oWorklistData={};s.oWorklistData.bWorkListEnabled=false;s.oWorklistData.bVariantDirty=true;var f=true;var F;var w=null;function g(){var i=C.getOwnerComponent();var y=t.oComponentUtils.getTemplatePrivateModel();y.setProperty("/listReport/isLeaf",i.getIsLeaf());}function o(i){C.onInitSmartFilterBarExtension(i);C.templateBaseExtension.onInitSmartFilterBar(i);s.oIappStateHandler.onSmartFilterBarInitialise();}function h(){var i=s.oIappStateHandler.parseUrlAndApplyAppState();i.then(function(){f=false;},function(y){if(y instanceof Error){y.showMessageBox();}});}function j(){if(!f){s.oIappStateHandler.changeIappState(true,false);}}function u(i){var y=C.getOwnerComponent().getModel(),z=t.oComponentUtils.getTemplatePrivateModel();var B=y.getMetaModel();var D=t.oCommonUtils.getCurrentEntitySetName(i);var G=B.getODataEntitySet(D);var H=G["Org.OData.Capabilities.V1.DeleteRestrictions"];var K=false;if(sap.suite.ui.generic.template.js.AnnotationHelper.areDeleteRestrictionsValid(B,G.entityType,H)){var L=H&&H.Deletable&&H.Deletable.Path;var N=t.oCommonUtils.getSelectedContexts(i);K=N.some(function(P){var Q=y.getObject(P.getPath()+"/DraftAdministrativeData");var R=!(Q&&Q.InProcessByUser&&!Q.DraftIsProcessedByMe);return R&&!(L&&!y.getProperty(L,P));});}z.setProperty("/listReport/deleteEnabled",K);t.oCommonUtils.setEnabledToolbarButtons(i);if(!t.oCommonUtils.isSmartChart(i)){t.oCommonUtils.setEnabledFooterButtons(i);}}function k(i){var y=i.getParameters();var z=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationPressed(z,y);}function m(i){var y,z;y=i.getParameters();z=i.getSource();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(z,y,s,undefined,undefined);}function n(i){var y,z,B,D,G,H;y=i.getParameters().mainNavigation;G=i.getParameters();H=i.getSource();if(y){z=H.getText&&H.getText();B=t.oCommonUtils.getCustomData(i);if(B&&B["LinkDescr"]){D=B["LinkDescr"];y.setDescription(D);}}H=H.getParent().getParent().getParent().getParent();t.oCommonEventHandlers.onSemanticObjectLinkNavigationTargetObtained(H,G,s,z,y);}function p(y){var z=v.getItems();for(var i=0;i<z.length;i++){if(!y||z[i].getBindingContextPath()===y){return z[i];}}}function r(P,i){var y=i.getSource();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){t.oCommonEventHandlers.addEntry(y,false,s.oSmartFilterbar,P);},q.noop,s);}function x(i){var y=C.getOwnerComponent().getCreateWithFilters();var z=y.strategy||"extension";var P;switch(z){case"extension":P=C.getPredefinedValuesForCreateExtension(s.oSmartFilterbar);break;default:q.sap.log.error(z+" is not a valid strategy to extract values from the SmartFilterBar");return;}r(P,i);}return{onInit:function(){var i=C.getOwnerComponent().getAppComponent();var y=i.getConfig();s.oWorklistData.bWorkListEnabled=!!y.pages[0].component.settings&&y.pages[0].component.settings.isWorklist;s.oSmartFilterbar=C.byId("listReportFilter");s.oSmartTable=C.byId("listReport");s.updateControlOnSelectionChange=u;F=t.oServices.oApplication.getFclProxyForView(0);s.bLoadListAndFirstEntryOnStartup=F&&F.isListAndFirstEntryLoadedOnStartup&&F.isListAndFirstEntryLoadedOnStartup();s.oMultipleViewsHandler=new d(s,C,t);s.oWorklistHandler=new W(s,C,t);s.oIappStateHandler=new I(s,C,t);if(s.oWorklistData.bWorkListEnabled){s.oWorklistHandler.fetchAndSaveWorklistSearchField();}var z=t.oComponentUtils.getTemplatePrivateModel();z.setProperty("/generic/bDataAreShownInTable",false);z.setProperty("/listReport/isHeaderExpanded",true);z.setProperty("/listReport/deleteEnabled",false);z.setProperty("/listReport/activeObjectEnabled",false);z.setProperty("/listReport/vDraftState","0");t.oServices.oApplication.registerStateChanger({isStateChange:s.oIappStateHandler.isStateChange});v.getUrlParameterInfo=s.oIappStateHandler.getUrlParameterInfo;v.getItems=function(){var B=s.oSmartTable.getTable();if(t.oCommonUtils.isUiTable(B)){return B.getRows();}return B.getItems();};v.displayNextObject=function(B){return new Promise(function(D,G){w={aWaitingObjects:B,resolve:D,reject:G};});};v.onComponentActivate=function(){if(!f){s.oIappStateHandler.parseUrlAndApplyAppState();}};v.refreshBinding=function(U,B){if(s.oIappStateHandler.areDataShownInTable()){if(s.oMultipleViewsHandler.refreshOperation(2,null,!U&&B)){return;}if(U||B[s.oSmartTable.getEntitySet()]){t.oCommonUtils.refreshSmartTable(s.oSmartTable);}}};g();C.byId("template::FilterText").attachBrowserEvent("click",function(){C.byId("page").setHeaderExpanded(true);});},handlers:{addEntry:r.bind(null,undefined),addEntryWithFilters:x,deleteEntries:function(i){t.oCommonEventHandlers.deleteEntries(i);},updateTableTabCounts:function(){s.oMultipleViewsHandler.fnUpdateTableTabCounts();},onSelectionChange:function(i){var y=i.getSource();u(y);},onChange:function(i){t.oCommonEventHandlers.onChange(i);},onSmartFieldUrlPressed:function(i){t.oCommonEventHandlers.onSmartFieldUrlPressed(i,s);},onBreadCrumbUrlPressed:function(i){t.oCommonEventHandlers.onBreadCrumbUrlPressed(i,s);},onContactDetails:function(i){t.oCommonEventHandlers.onContactDetails(i);},onSmartFilterBarInitialise:o,onSmartFilterBarInitialized:h,onBeforeSFBVariantFetch:function(){s.oIappStateHandler.onBeforeSFBVariantFetch();},onAfterSFBVariantSave:function(){s.oIappStateHandler.onAfterSFBVariantSave();},onAfterSFBVariantLoad:function(i){s.oIappStateHandler.onAfterSFBVariantLoad(i);},onDataRequested:function(){s.oMultipleViewsHandler.onDataRequested();},onDataReceived:function(y){t.oCommonEventHandlers.onDataReceived(y);if(w){var z;var B=false;for(var i=0;i<w.aWaitingObjects.length&&!B;i++){z=p(w.aWaitingObjects[i]);if(z){t.oCommonEventHandlers.onListNavigate(z,s);w.resolve();B=true;}}if(!B){z=p();if(z){t.oCommonEventHandlers.onListNavigate(z,s);w.resolve();}else{w.reject();}}w=null;return;}var D=y.getSource().getTable();F.handleDataReceived(D,s,t);},onSmartChartDataReceived:function(){s.oMultipleViewsHandler.onDataRequested();},onBeforeRebindTable:function(i){s.oMultipleViewsHandler.aTableFilters=i.getParameters()&&i.getParameters().bindingParams&&q.extend(true,{},i.getParameters().bindingParams.filters);t.oCommonEventHandlers.onBeforeRebindTable(i,{determineSortOrder:s.oMultipleViewsHandler.determineSortOrder,ensureExtensionFields:C.templateBaseExtension.ensureFieldsForSelect,addExtensionFilters:C.templateBaseExtension.addFilters});C.onBeforeRebindTableExtension(i);s.oMultipleViewsHandler.onRebindContentControl(i);l.handleErrorsOnTableOrChart(t,i);},onShowDetails:function(i){t.oCommonEventHandlers.onShowDetails(i.getSource(),s);},onListNavigate:function(i){if(!C.onListNavigationExtension(i)){var y=i.getSource();var z=y.getBindingContext();if(t.oComponentUtils.isDraftEnabled()&&t.oServices.oDraftController.isActiveEntity(z)&&z.getObject("DraftAdministrativeData/DraftIsCreatedByMe")){var B=z.getModel();var D=t.oServices.oApplication.getBusyHelper();if(!D.isBusy()){var G,H=new Promise(function(R,K){B.read(z.getPath()+"/SiblingEntity",{success:function(L){G=B.getContext("/"+B.getKey(L));R(G);},error:function(L){t.oComponentUtils.navigateToDataLoadedFailedPage();K(L);}});});D.setBusy(H);H.then(function(){t.oCommonEventHandlers.onListNavigate(y,s,G);});}}else{t.oCommonEventHandlers.onListNavigate(y,s);}}},onCallActionFromToolBar:function(i){t.oCommonEventHandlers.onCallActionFromToolBar(i,s);},onDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldForIntentBasedNavigation(i,s);},onDataFieldWithIntentBasedNavigation:function(i){t.oCommonEventHandlers.onDataFieldWithIntentBasedNavigation(i,s);},onBeforeSemanticObjectLinkPopoverOpens:function(i){var y=i.getParameters();t.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){var z=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());t.oCommonUtils.semanticObjectLinkNavigation(y,z,C);},q.noop,s,q.noop);},onSemanticObjectLinkNavigationPressed:k,onSemanticObjectLinkNavigationTargetObtained:m,onSemanticObjectLinkNavigationTargetObtainedSmartLink:n,onDraftLinkPressed:function(i){var B=i.getSource();var y=B.getBindingContext();t.oCommonUtils.showDraftPopover(y,B);},onAssignedFiltersChanged:function(i){if(i.getSource()){C.byId("template::FilterText").setText(i.getSource().retrieveFiltersWithValuesAsText());}},onFilterChange:j,onToggleFiltersPressed:function(){var i=t.oComponentUtils.getTemplatePrivateModel();i.setProperty("/listReport/isHeaderExpanded",!i.getProperty("/listReport/isHeaderExpanded"));},onSearchButtonPressed:function(){t.oCommonUtils.refreshModel(s.oSmartTable);s.oIappStateHandler.changeIappState(false,true);},onSemanticObjectLinkPopoverLinkPressed:function(i){t.oCommonEventHandlers.onSemanticObjectLinkPopoverLinkPressed(i,s);},onAfterTableVariantSave:function(){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyTableVariant:function(){if(!f){s.oIappStateHandler.onAfterApplyTableVariant();}},onAfterChartVariantSave:function(i){s.oIappStateHandler.onAfterTableVariantSave();},onAfterApplyChartVariant:function(i){if(!f){s.oIappStateHandler.onAfterApplyTableVariant();}},onBeforeRebindChart:function(i){s.oMultipleViewsHandler.aTableFilters=i.getParameters()&&i.getParameters().bindingParams&&q.extend(true,{},i.getParameters().bindingParams.filters);var y=i.getSource();var z={setBindingPath:y.setChartBindingPath.bind(y),ensureExtensionFields:q.noop,addExtensionFilters:C.templateBaseExtension.addFilters};t.oCommonUtils.onBeforeRebindTableOrChart(i,z,s.oSmartFilterbar);C.onBeforeRebindChartExtension(i);s.oMultipleViewsHandler.onRebindContentControl(i);l.handleErrorsOnTableOrChart(t,i);},onChartInitialise:function(i){s.oMultipleViewsHandler.fnRegisterToChartEvents(i);s.oMultipleViewsHandler.init(i);t.oCommonUtils.checkToolbarIntentsSupported(i.getSource());},onSelectionDetailsActionPress:function(i){s.oMultipleViewsHandler.onDetailsActionPress(i);},onShareListReportActionButtonPress:function(i){var y={shareEmailPressed:function(){var D=t.oCommonUtils.getText("EMAIL_HEADER",[t.oServices.oApplication.getAppTitle()]);sap.m.URLHelper.triggerEmail(null,D,document.URL);},shareJamPressed:function(){e.openJamShareDialog(t.oServices.oApplication.getAppTitle());},getDownloadUrl:function(){var D=s.oSmartTable.getTable();var G=D.getBinding("rows")||D.getBinding("items");return G&&G.getDownloadUrl()||"";},getServiceUrl:function(){var D=y.getDownloadUrl();if(D){D+="&$top=0&$inlinecount=allpages";}var G={serviceUrl:D};if(C.onSaveAsTileExtension){C.onSaveAsTileExtension(G);}return G.serviceUrl;},getCustomUrl:function(){var H=hasher.getHash();return H?("#"+H):window.location.href;},getModelData:function(){var G=q.sap.getObject("sap.ushell.Container.getUser");var D=C.getOwnerComponent();var H=D.getAppComponent();var K=H.getMetadata();var U=K.getManifestEntry("sap.ui");var L=(U&&U.icons&&U.icons.icon)||"";var N=K.getManifestEntry("sap.app");var P=(N&&N.title)||"";return{serviceUrl:y.getServiceUrl,icon:L,title:P,isShareInJamActive:!!G&&G().isJamActive(),customUrl:y.getCustomUrl};}};e.openSharePopup(t.oCommonUtils,i.getSource(),y);var z=this.getView().byId("template::Share");var B=this.getView().byId("bookmarkButton");B.setBeforePressHandler(function(){z.focus();});},onInlineDataFieldForAction:function(i){t.oCommonEventHandlers.onInlineDataFieldForAction(i,s);},onInlineDataFieldForIntentBasedNavigation:function(i){t.oCommonEventHandlers.onInlineDataFieldForIntentBasedNavigation(i.getSource(),s);},onDeterminingDataFieldForAction:function(i){t.oCommonEventHandlers.onDeterminingDataFieldForAction(i,s.oSmartTable);},onDeterminingDataFieldForIntentBasedNavigation:function(i){var B=i.getSource();t.oCommonEventHandlers.onDeterminingDataFieldForIntentBasedNavigation(B,s.oSmartTable.getTable(),s);},onTableInit:function(i){var y=i.getSource();t.oCommonUtils.checkToolbarIntentsSupported(y);s.oMultipleViewsHandler.init(i);},onSearchWorkList:function(i){s.oWorklistHandler.performWorklistSearch(i);},onWorkListTableSettings:function(i){s.oWorklistHandler.openWorklistPersonalisation(i);},onActiveButtonPress:function(i){var P=C.byId("template::PageVariant");var y=t.oComponentUtils.getTemplatePrivateModel();var z=y.getProperty("/listReport/activeObjectEnabled");y.setProperty("/listReport/activeObjectEnabled",!z);P.currentVariantSetModified(true);s.oSmartFilterbar.search();s.oIappStateHandler.changeIappState(true,true);},onStateFilterChange:function(i){var y=t.oComponentUtils.getTemplatePrivateModel();var z=i.getSource().getSelectedKey();y.setProperty("/listReport/vDraftState",z);}},formatters:{formatDraftType:function(D,i,H){if(D&&D.DraftUUID){if(!i){return sap.m.ObjectMarkerType.Draft;}else if(H){return D.InProcessByUser?sap.m.ObjectMarkerType.Locked:sap.m.ObjectMarkerType.Unsaved;}}return sap.m.ObjectMarkerType.Flagged;},formatDraftVisibility:function(D,i){if(D&&D.DraftUUID){if(!i){return sap.m.ObjectMarkerVisibility.TextOnly;}}return sap.m.ObjectMarkerVisibility.IconAndText;},formatDraftLineItemVisible:function(D,i,y){if(D&&D.DraftUUID){if(y==="0"&&i){return false;}return true;}return false;},formatDraftOwner:function(D,H){var i="";if(D&&D.DraftUUID&&H){var U=D.InProcessByUserDescription||D.InProcessByUser||D.LastChangedByUserDescription||D.LastChangedByUser;if(U){i=t.oCommonUtils.getText("ST_DRAFT_OWNER",[U]);}else{i=t.oCommonUtils.getText("ST_DRAFT_ANOTHER_USER");}}return i;},formatItemTextForMultipleView:function(i){return s.oMultipleViewsHandler?s.oMultipleViewsHandler.formatItemTextForMultipleView(i):"";}},extensionAPI:new E(t,C,s)};}};});
