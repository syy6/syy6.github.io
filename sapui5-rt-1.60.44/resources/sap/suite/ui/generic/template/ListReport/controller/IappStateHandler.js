sap.ui.define(["jquery.sap.global","sap/ui/base/Object","sap/ui/core/mvc/ControllerExtension","sap/ui/generic/app/navigation/service/NavError","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/comp/state/UIState"],function(q,B,C,N,S,U){"use strict";var d="sap.suite.ui.generic.template.customData",a="sap.suite.ui.generic.template.extensionData",b="sap.suite.ui.generic.template.genericData";var I=["INIT","DATA_SUITE","CANCEL","RESET","SET_VM_ID"];function n(o){if(o){for(var p in o){o[p]=null;}}}function f(o,O){var k=Object.keys(o);if(k.length!==Object.keys(O).length){return true;}for(var i=0;i<k.length;i++){var K=k[i];var p=o[K];var P=O[K];if(p.length!==P.length){return true;}for(var j=0;j<p.length;j++){if(p[j]!==P[j]){return true;}}}return false;}function l(m,D){if(sap.ui.support){var L=q.sap.log.getLevel();if(L<q.sap.log.Level.INFO){q.sap.log.setLevel(q.sap.log.Level.INFO);}}var s;if(typeof D==="string"){s=D;}else{s="";var c="";for(var k in D){s=s+c+k+": "+D[k];c="; ";}}q.sap.log.info(m,s,"sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");}function g(s,c,t){var o=t.oCommonUtils.getNavigationHandler();var e=c.getOwnerComponent().getSmartVariantManagement();var r={appStateKey:"",urlParams:{},selectionVariant:"",tableVariantId:""};var h=false;var j=null;var A=Promise.resolve();var D=false;var k=false;var E=c.byId("editStateFilter");var m;var p=null;var u=null;s.oSmartFilterbar.setSuppressSelection(true);var v=(function(){var i;return function(){i=i||s.oSmartFilterbar.getNonVisibleCustomFilterNames();return i;};})();function w(){return D;}function x(){var c1={};var d1=[];var e1=v();for(var i=0;i<e1.length;i++){var f1=e1[i];if(s.oSmartFilterbar.isVisibleInFilterBarByName(f1)){d1.push(f1);}}var g1={suppressDataSelection:!D,visibleCustomFields:d1};c1[b]=g1;if(E){g1.editStateFilter=E.getSelectedKey();var h1=t.oComponentUtils.getTemplatePrivateModel();var i1=h1.getProperty("/listReport/activeObjectEnabled");g1.activeStateFilter=i1;}var j1=s.oMultipleViewsHandler.getContentForIappState();if(j1){var k1=j1.mode==="single"?"tableViewData":"tableTabData";g1[k1]=j1.state;}if(s.oWorklistData.bWorkListEnabled){var l1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";var m1={"searchString":l1};g1.Worklist=m1;}var n1={};c1[d]=n1;c.getCustomAppStateDataExtension(n1);var o1;var p1=true;var q1=function(r1,s1){if(!(r1 instanceof C)){throw new Error("State must always be set with respect to a ControllerExtension");}if(!p1){throw new Error("State must always be provided synchronously");}if(s1){o1=o1||Object.create(null);var t1=r1.getMetadata().getNamespace();o1[t1]=s1;}};c.templateBaseExtension.provideExtensionAppStateData(q1);p1=false;if(o1){c1[a]=o1;}return c1;}function y(){var c1=JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant());var d1=new S(c1);var e1=c.getVisibleSelectionsWithDefaults();for(var i=0;i<e1.length;i++){if(!d1.getValue(e1[i])){d1.addSelectOption(e1[i],"I","EQ","");}}if(c.byId('template::PageVariant')&&c.byId('template::PageVariant').currentVariantGetModified()&&d1.getID()){d1.setID("");}if(s.oWorklistData.bWorkListEnabled){var f1=s.oWorklistData.oSearchField?s.oWorklistData.oSearchField.getValue():"";d1.addSelectOption("Worklist.SearchField","I","EQ",f1);}var g1={selectionVariant:d1.toJSONString(),tableVariantId:(!e&&s.oSmartTable.getCurrentVariantId())||"",customData:x()};return g1;}function z(){l("fnStoreCurrentAppStateAndAdjustURL called",{bAppStateDirty:k,bDataAreShownInTable:D});if(!k){return;}k=false;try{p=o.storeInnerAppStateWithImmediateReturn(y(),true);}catch(i){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: "+i);return;}if(p instanceof N){k=true;p=null;return;}p.promise.fail(function(c1){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Error when persisting appState"+c1);});l("Result received from storeInnerAppStateWithImmediateReturn",{appStateKey:p.appStateKey,sAppStateKeyInUrl:u});if(u===p.appStateKey){p=null;}else{l("Call NavigationHandler.replaceHash",{appStateKey:p.appStateKey});o.replaceHash(p.appStateKey);}}function R(c1,d1){var e1=t.oComponentUtils.getTemplatePrivateModel();if(c1&&c1.editStateFilter!==undefined){if(E){E.setSelectedKey((c1.editStateFilter===null)?0:c1.editStateFilter);e1.setProperty("/listReport/vDraftState",(c1.editStateFilter===null)?0:c1.editStateFilter);}e1.setProperty("/listReport/activeObjectEnabled",!!c1.activeStateFilter);}var f1=c1&&c1.visibleCustomFields;if(f1&&f1.length>0){var g1=s.oSmartFilterbar.getAllFilterItems();for(var i=0;i<g1.length;i++){var h1=g1[i];var i1=h1.getName();if(f1.indexOf(i1)!==-1){h1.setVisibleInFilterBar(true);}}}D=d1&&!(c1&&c1.suppressDataSelection);if(D&&!s.oWorklistData.bWorkListEnabled){s.oSmartFilterbar.search();$(D);}}function F(i){c.restoreCustomAppStateDataExtension(i||{});}function G(i){if(!i){return;}var c1=true;var d1=function(e1){if(!(e1 instanceof C)){throw new Error("State must always be retrieved with respect to a ControllerExtension");}var f1=e1.getMetadata().getNamespace();if(!c1){throw new Error("State must always be restored synchronously");}return i[f1];};c.templateBaseExtension.restoreExtensionAppStateData(d1);c1=false;}function H(i,c1){i=i||{};if(i.hasOwnProperty(d)&&i.hasOwnProperty(b)){G(i[a]);F(i[d]);R(i[b],c1);}else{if(i._editStateFilter!==undefined){R({editStateFilter:i._editStateFilter});delete i._editStateFilter;}F(i);}}function J(){return A.then(function(){if(r.appStateKey){return{"sap-iapp-state":[r.appStateKey]};}return r.urlParams;});}function K(i){var c1=t.oComponentUtils.getTemplatePrivateModel();c1.setProperty("/generic/bDataAreShownInTable",i);}function L(i,c1){l("changeIappState called",{bFilterOrSettingsChange:i,bDataAreShown:c1,bDataAreShownInTable:D,bIsTransferringUrlStateToPageState:h,bAppStateDirty:k});K(c1);if(h){return;}if(i||c1!==D){D=c1;if(!k){k=true;if(!s.oSmartFilterbar.isDialogOpen()){if(j){z();}else{setTimeout(z,0);}}}}}function M(i){var c1=s.oSmartFilterbar.determineMandatoryFilterItems(),d1;for(var e1=0;e1<c1.length;e1++){if(c1[e1].getName().indexOf("P_DisplayCurrency")!==-1){if(i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0]&&i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low){d1=i.oDefaultedSelectionVariant.getSelectOption("DisplayCurrency")[0].Low;if(d1){i.oSelectionVariant.addParameter("P_DisplayCurrency",d1);}}break;}}}function O(i,c1,d1){l("fnAdaptToAppState called",{sNavType:d1,sAppStateKeyInUrl:u,sAppStateKey:i.appStateKey,storingInformationAppStateKey:p&&p.appStateKey});s.oSmartFilterbar.setSuppressSelection(false);s.sNavType=d1;var e1=i.appStateKey||"";if(h){return;}if(u===null){u=e1;}else if(e1!==u){return;}h=true;var f1=i.selectionVariant||"";var g1=(!e&&i.tableVariantId)||"";var h1=(!e1&&c1)||{};var i1=i.oSelectionVariant||"";var j1={selectionVariant:i1,urlParameters:c1,selectedQuickVariantSelectionKey:""};var k1=new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant()));var l1=k1.getSelectOption(d);var m1=k1.getSelectOption(b);if((r.appStateKey!==e1||r.selectionVariant!==f1||r.tableVariantId!==g1||f(r.urlParams,h1))&&d1!==sap.ui.generic.app.navigation.service.NavType.initial){if(!p||p.appStateKey!==e1){var n1=i&&i.bNavSelVarHasDefaultsOnly;if((i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("DisplayCurrency")===-1)&&(i.oSelectionVariant.getSelectOptionsPropertyNames().indexOf("P_DisplayCurrency")===-1)&&(i.oSelectionVariant.getParameterNames().indexOf("P_DisplayCurrency")===-1)){M(i);}if(!s.oWorklistData.bWorkListEnabled){if(!n1||s.oSmartFilterbar.isCurrentVariantStandard()){j1.selectionVariant=i.oSelectionVariant;if(d1!==sap.ui.generic.app.navigation.service.NavType.iAppState){c.modifyStartupExtension(j1);b1(j1.selectionVariant,r,f1);_(j1.selectionVariant.toJSONObject(),true,false);}else{b1(j1.selectionVariant,r,f1);_(j1.selectionVariant.toJSONObject(),!n1,false);}}else{a1(k1,l1,m1,true);j1.selectionVariant=k1;c.modifyStartupExtension(j1);a1(j1.selectionVariant,l1,m1,false);if(!q.sap.equal(j1.selectionVariant,new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())))){b1(j1.selectionVariant,r,f1);_(j1.selectionVariant.toJSONObject(),true,false);}}}if(g1!==r.tableVariantId){s.oSmartTable.setCurrentVariantId(g1);}i.customData=i.customData||{};var o1=s.oMultipleViewsHandler.getMode();if(o1){var p1=o1==="single"?"tableViewData":"tableTabData";if(i.customData[b]&&i.customData[b][p1]){s.oMultipleViewsHandler.restoreFromIappState(i.customData[b][p1]);}}if(s.oWorklistData.bWorkListEnabled){s.oWorklistData.oWorklistSavedData=i.customData[b]&&i.customData[b]["Worklist"]?i.customData[b]["Worklist"]:{};s.oWorklistHandler.restoreWorklistStateFromIappState();}H(i.customData,true);}r={appStateKey:e1,urlParams:h1,selectionVariant:f1,tableVariantId:g1};}if(d1!==sap.ui.generic.app.navigation.service.NavType.iAppState){if(d1===sap.ui.generic.app.navigation.service.NavType.initial){a1(k1,l1,m1,true);j1.selectionVariant=k1;c.modifyStartupExtension(j1);a1(j1.selectionVariant,l1,m1,false);if(!q.sap.equal(j1.selectionVariant,new S(JSON.stringify(s.oSmartFilterbar.getUiState().getSelectionVariant())))){b1(j1.selectionVariant,r,f1);_(j1.selectionVariant.toJSONObject(),true,false);}}if(j1.selectedQuickVariantSelectionKey){var o1=s.oMultipleViewsHandler.getMode();if(o1){if(c&&c.getOwnerComponent&&c.getOwnerComponent().getModel){var q1=c.getOwnerComponent().getModel("_templPriv");q1.setProperty("/listReport/multipleViews/selectedKey",j1.selectedQuickVariantSelectionKey);}}}}if(j){j();j=null;}if(d1!==sap.ui.generic.app.navigation.service.NavType.iAppState&&!D){var r1=(d1===sap.ui.generic.app.navigation.service.NavType.xAppState||d1===sap.ui.generic.app.navigation.service.NavType.URLParams)&&!i.bNavSelVarHasDefaultsOnly;D=r1||s.bLoadListAndFirstEntryOnStartup||m||s.oSmartFilterbar.isCurrentVariantExecuteOnSelectEnabled()||s.oMultipleViewsHandler.getEnableAutoBinding();K(D);if(D){s.oSmartFilterbar.search();$(D);}}if(d1==="initial"&&s.oWorklistData.bWorkListEnabled){if(s.oSmartFilterbar.isCurrentVariantStandard()){s.oWorklistHandler.restoreWorklistStateFromIappState();}}p=null;h=false;}function P(){if(!j){A=new Promise(function(c1){j=c1;});}var i=new Promise(function(c1,d1){var e1=o.parseNavigation();e1.done(function(f1,g1,h1){O(f1,g1,h1);c1();});e1.fail(function(f1,g1,h1){q.sap.log.warning(f1.getErrorCode(),"app state could not be parsed - continuing with empty state","sap.suite.ui.generic.template.ListReport.controller.IappStateHandler");O({},g1,sap.ui.generic.app.navigation.service.NavType.initial);c1();});});return i;}function Q(){var i=y();s.oSmartFilterbar.setFilterData({_CUSTOM:i.customData});}function T(){L(true,D);}function V(i){var c1=i.getParameter("context");var d1=s.oSmartFilterbar.getFilterData();if(d1._CUSTOM!==undefined){if(s.oWorklistData.bWorkListEnabled){var e1=d1._CUSTOM[b]["Worklist"];s.oSmartFilterbar.setSuppressSelection(false);s.oWorklistData.oSearchField.setValue(e1.searchString);s.oWorklistData.oSearchField.fireSearch();}else{H(d1._CUSTOM);}}else{var f1=x();n(f1[d]);n(f1[b]);H(f1);}if(I.indexOf(c1)<0){D=i.getParameter("executeOnSelect");L(true,D);}}function W(){if(!e){L(true,D);}}function X(){if(!e){L(true,D);}}function Y(i){var c1=i.getParameter("arguments");var d1=c1&&c1["?query"];u=(d1&&d1["sap-iapp-state"])||"";if(p){if(p.appStateKey!==u){q.sap.log.error("ListReport.fnStoreCurrentAppStateAndAdjustURL: Got AppstateKey "+u+" expected "+p.appStateKey);return false;}P();return true;}return false;}function Z(){m=s.oSmartTable.getEnableAutoBinding();s.oSmartFilterbar.attachFiltersDialogClosed(z);}function $(D){if(c&&c.getOwnerComponent&&c.getOwnerComponent().getModel){var i=c.getOwnerComponent().getModel("_templPriv");if(D){i.setProperty("/listReport/isHeaderExpanded",false);}else{i.setProperty("/listReport/isHeaderExpanded",true);}}}function _(i,c1,d1){if(c1){s.oSmartFilterbar.clearVariantSelection();}var e1=new U({selectionVariant:i});s.oSmartFilterbar.setUiState(e1,{replace:c1,strictMode:d1});}function a1(i,c1,d1,e1){if(i&&(c1||d1)){if(e1){i.removeSelectOption(d);i.removeSelectOption(b);}else{i.massAddSelectOption(d,c1);i.massAddSelectOption(b,d1);}}}function b1(c1,r,d1){if(c1&&(r.selectionVariant!==d1||s.sNavType==="initial")){var e1=c1.getParameterNames().concat(c1.getSelectOptionsPropertyNames());for(var i=0;i<e1.length;i++){s.oSmartFilterbar.addFieldToAdvancedArea(e1[i]);}}}s.getCurrentAppState=y;return{areDataShownInTable:w,parseUrlAndApplyAppState:P,getUrlParameterInfo:J,changeIappState:L,onSmartFilterBarInitialise:Z,onBeforeSFBVariantFetch:Q,onAfterSFBVariantSave:T,onAfterSFBVariantLoad:V,onAfterTableVariantSave:W,onAfterApplyTableVariant:X,isStateChange:Y};}return B.extend("sap.suite.ui.generic.template.ListReport.controller.IappStateHandler",{constructor:function(s,c,t){q.extend(this,g(s,c,t));}});});
