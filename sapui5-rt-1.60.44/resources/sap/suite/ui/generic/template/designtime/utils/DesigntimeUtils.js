sap.ui.define(["jquery.sap.global","sap/suite/ui/generic/template/changeHandler/util/AnnotationChangeUtilsV2","sap/suite/ui/generic/template/changeHandler/util/ChangeHandlerUtils"],function(q,A,C){"use strict";var D={},a="com.sap.vocabularies.UI.v1.DataPoint",b="com.sap.vocabularies.UI.v1.DataField",c="com.sap.vocabularies.UI.v1.Chart",F="com.sap.vocabularies.UI.v1.FieldGroup",L="com.sap.vocabularies.UI.v1.LineItem",d="com.sap.vocabularies.Communication.v1.Contact",e="com.sap.vocabularies.UI.v1.DataFieldWithUrl",f="com.sap.vocabularies.UI.v1.DataFieldForAnnotation",g="com.sap.vocabularies.UI.v1.DataFieldForAction",I="com.sap.vocabularies.UI.v1.DataFieldWithIntentBasedNavigation",M="com.sap.vocabularies.UI.v1.ChartMeasureRoleType",h="Datafield",k="ConnectedFields",l="Chart",m="RatingIndicator",n="ProgressIndicator",o="Contact",p="DataFieldWithIntentBasedNavigation",r="DataFieldForAction",s="DatafieldWithUrl",t="ToolbarButton";D.modifyDataPointForChart=function(T,E,N,i){var j={},u={},O;var v=N.DataPointAnnotationPath&&N.DataPointAnnotationPath.value;if(v){j=N.DataPoint;if(j){var Q=v.split("#").reverse()[0];var w=Q?a+"#"+Q:a;O=E[w];u=A.createCustomAnnotationTermChange(T,j,O,w);i.push(u);}}};D.createNewDataPointForColumn=function(i,Q,T){var v="com.sap.vocabularies.UI.v1.VisualizationType/"+Q,R=C.getLineItemRecordForColumn(i);var N={TargetValue:{String:T},Visualization:{EnumMember:v},RecordType:a+"Type",Title:{String:Q}};if(R&&R.Value&&R.Value.Path&&(R.RecordType===b||R.RecordType===I||R.RecordType===e)){N.Value={Path:R.Value.Path};}return N;};D.createNewColumn=function(R,O){var P,i={Label:{},Criticality:{},CriticalityRepresentation:{},IconUrl:{}},j={};j[b]=q.extend({},i,{Value:{Path:""}});j[e]=q.extend({},i,{Value:{Path:""},Url:{String:""}});j[f]=q.extend({},i,{Target:{Path:""}});j[g]=q.extend({},i,{Inline:{Bool:"true"},Determining:{Bool:"false"},Action:{String:""},InvocationGrouping:{}});j[I]=q.extend({},i,{Action:{String:""},Value:{Path:""},SemanticObject:{String:""}});var N={"com.sap.vocabularies.UI.v1.Importance":{"EnumMember":"com.sap.vocabularies.UI.v1.ImportanceType/High"},"RecordType":R,"EdmType":"Edm.String"};q.extend(true,N,j[R]);for(P in N){if(P!=="RecordType"&&O&&O[P]){q.extend(N[P],O[P]);}if(q.isEmptyObject(N[P])){delete N[P];}}return N;};D.getColumnTypeValues=function(){var v={Datafield:{displayName:"Data Field"},DatafieldWithUrl:{displayName:"Data Field with URL"},Contact:{displayName:"Contact"},DataFieldForAction:{displayName:"Inline Action"},DataFieldWithIntentBasedNavigation:{displayName:"Navigation Field"},ConnectedFields:{displayName:"Connected Fields"}};v.RatingIndicator={displayName:"Rating Indicator"};v.ProgressIndicator={displayName:"Progress Indicator"};v.Chart={displayName:"Chart"};return v;};D.getColumnType=function(E){var R=C.getLineItemRecordForColumn(E);var i,j,Q,u;if(R){switch(R.RecordType){case g:if(R.Inline&&R.Determining!==true){i=r;}else{i=t;}break;case f:var v=R.Target.AnnotationPath;if(v){if(v.indexOf(a)>=0){u=C.getEntityTypeFromAnnotationPath(E,v);var w=v.search("#");Q=v.substring(w);var x=Q?a+Q:a;j=u[x];if(j){if(j.Visualization.EnumMember==="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){i=m;}if(j.Visualization.EnumMember==="com.sap.vocabularies.UI.v1.VisualizationType/Progress"){i=n;}}}else if(R.Target.AnnotationPath.indexOf(d)>=0){i=o;}else if(R.Target.AnnotationPath.indexOf(c)>=0){i=l;}else if(R.Target.AnnotationPath.indexOf(F)>=0){i=k;}}break;case I:i=p;break;case b:i=h;break;case e:i=s;break;default:break;}}return i;};D.setColumnType=function(i,N){var O=D.getColumnType(i);if(O===N){return;}var j=[],u={},E={},R,T,v={},w=C.getEntityType(C.getComponent(i));switch(N){case h:R=b;break;case s:R=e;break;case r:R=g;break;case p:R=I;break;case k:case l:case o:R=f;break;case m:E=C.getODataEntityType(C.getComponent(i));T=E&&a.concat("#Rating");v=E[T];if(!v){v=D.createNewDataPointForColumn(i,"Rating","4");u=A.createCustomAnnotationTermChange(w,v,{},T);j.push(u);}R=f;break;case n:E=C.getODataEntityType(C.getComponent(i));T=a.concat("#Progress");v=E&&E[T];if(!v){v=D.createNewDataPointForColumn(i,"Progress","100");u=A.createCustomAnnotationTermChange(w,v,{},T);j.push(u);}R=f;break;default:break;}if(!R){return;}var x=C.getLineItems(i);var y=C.getLineItemRecordIndex(i,x);if(y===-1){throw"invalid index for old column";}var z=x[y];var B=[];B.push.apply(B,x);var G=D.createNewColumn(R,z);switch(N){case m:G.Target={AnnotationPath:"@"+a+"#Rating"};break;case n:G.Target={AnnotationPath:"@"+a+"#Progress"};break;default:break;}B.splice(y,1,G);u=A.createCustomAnnotationTermChange(w,B,x,L);j.push(u);return j;};D.getChartFromColumn=function(i){var R=C.getLineItemRecordForColumn(i),j;if(R&&R.RecordType===f&&R.Target&&R.Target.AnnotationPath.indexOf("Chart")>=0){var Q=R.Target.AnnotationPath.split("#").reverse()[0],u=Q?c+"#"+Q:c,v=C.getEntityTypeFromAnnotationPath(i,R.Target.AnnotationPath);if(v){j={chartID:u,entityType:v};}}return j;};D.getMeasures=function(u){var v={},w=[],x,Q,y,z,B,E={},G,H={},J=D.getChartFromColumn(u),K=J&&J.entityType[J.chartID];if(K&&K.Measures){q.extend(true,H,K);for(var i=0;i<H.Measures.length;i++){x=H.Measures[i].PropertyPath;y=false;if(H.MeasureAttributes){for(var j=0;j<H.MeasureAttributes.length;j++){z=H.MeasureAttributes[j];E={};if(z.Measure&&z.Measure.PropertyPath===x){y=true;if(z.DataPoint&&z.DataPoint.AnnotationPath){Q=z.DataPoint.AnnotationPath.split("#").reverse()[0];B=Q?a+"#"+Q:a;G=J.entityType[B];if(G){q.extend(true,E,G);}}v={Measure:{value:z.Measure&&z.Measure.PropertyPath},DataPointAnnotationPath:{value:z.DataPoint&&z.DataPoint.AnnotationPath},DataPoint:E};if(z.Role&&z.Role.EnumMember){switch(z.Role.EnumMember){case"com.sap.vocabularies.UI.v1.ChartMeasureRoleType/Axis1":v.Role={value:"Axis1"};break;case"com.sap.vocabularies.UI.v1.ChartMeasureRoleType/Axis2":v.Role={value:"Axis2"};break;case"com.sap.vocabularies.UI.v1.ChartMeasureRoleType/Axis3":v.Role={value:"Axis3"};break;default:break;}}w.push(v);break;}}}if(!y){v={Measure:H.Measures[i]};w.push(v);}}}return w;};D.setMeasures=function(u,N){var i,j,v,E,w,x,y=[],z,B={},G=D.getChartFromColumn(u),H=G&&G.entityType&&G.entityType[G.chartID],J={};if(!H||q.isEmptyObject(H)||!G){return y;}q.extend(true,J,H);var T=G.entityType.namespace+"."+G.entityType.name;if(J.Measures){for(i=J.Measures.length-1;i>=0;i--){E=false;v=J.Measures[i].PropertyPath;for(j=0;j<N.length;j++){if(N[j].Measure&&N[j].Measure.value===v){E=true;break;}}if(!E){J.Measures.splice(i,1);for(j=J.MeasureAttributes.length-1;j>=0;j--){z=J.MeasureAttributes[j].Measure;if(z&&z.PropertyPath===v){J.MeasureAttributes.splice(j,1);break;}}}}}for(i=0;i<N.length;i++){w=N[i];E=false;if(J.MeasureAttributes){for(j=0;j<J.MeasureAttributes.length;j++){z=J.MeasureAttributes[j].Measure;if(w.value&&w.Measure&&z&&z.PropertyPath===w.Measure.value){E=true;break;}}}if(w.DataPointAnnotationPath&&w.DataPointAnnotationPath.value){x=w.DataPointAnnotationPath.value;}else if(w.Measure){x="@"+a+"#"+w.Measure.value;w.DataPointAnnotationPath={value:x};}B={Measure:{PropertyPath:w.Measure.value},DataPoint:{AnnotationPath:x},RecordType:"com.sap.vocabularies.UI.v1.ChartMeasureAttributeType"};if(w.Role){switch(w.Role.value){case"Axis2":B.Role={EnumMember:M+"/Axis2"};break;case"Axis3":B.Role={EnumMember:M+"/Axis3"};break;default:B.Role={EnumMember:M+"/Axis1"};break;}}if(!E){if(!J.Measures){J.Measures=[];}J.Measures.push({PropertyPath:w.Measure.value});if(!J.MeasureAttributes){J.MeasureAttributes=[];}J.MeasureAttributes.push(B);}else{J.MeasureAttributes[j]=B;}D.modifyDataPointForChart(T,G.entityType,w,y);}var K=A.createCustomAnnotationTermChange(T,J,H,G.chartID);y.push(K);return y;};D.addSettingsHandler=function(T,P,j,u){return new Promise(function(v,w){var x=sap.ui.fl.Utils.getAppComponentForControl(T).getModel().getMetaModel();var E=x.getODataEntityContainer();var y=E.functionImport;var z={};var B=new sap.ui.model.json.JSONModel(y);var G=sap.ui.xmlfragment("sap.suite.ui.generic.template.changeHandler.customSelectDialog.SelectDialog",this);G.attachConfirm(function(O){var Q=O.getParameter("selectedContexts");var R=[],S;for(var i=0;i<Q.length;i++){S=E.namespace+"."+E.name+"/"+Q[i].getObject().name;R[i]={selectorControl:T,changeSpecificData:{changeType:u,content:{newFunctionImport:S}}};}v(R);});G.attachSearch(function(O){var V=O.getParameter("value");var S=new sap.ui.model.Filter("name",sap.ui.model.FilterOperator.Contains,V);var Q=new sap.ui.model.Filter({filters:[S,z],and:true});var H=O.getSource().getBinding("items");H.filter(Q);});G.setModel(B);var H=G.getBinding("items");var J=[];for(var i in j){var K=C.getCustomDataObject(j[i]);if(K&&K.Action){var N=K.Action.substring(K.Action.lastIndexOf("/")+1);J.push(new sap.ui.model.Filter("name",sap.ui.model.FilterOperator.NE,N));}}z=new sap.ui.model.Filter({filters:J,and:true});H.filter(z);G.addStyleClass(P.styleClass);G.open();});};return D;});
