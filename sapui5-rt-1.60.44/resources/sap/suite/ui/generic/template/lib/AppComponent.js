/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/UIComponent","sap/m/NavContainer","sap/f/FlexibleColumnLayout","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ui/generic/app/ApplicationController","sap/suite/ui/generic/template/lib/Application","sap/suite/ui/generic/template/lib/BusyHelper","sap/suite/ui/generic/template/lib/NavigationController","sap/suite/ui/generic/template/lib/ProcessObserver","sap/suite/ui/generic/template/lib/TemplateAssembler","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/lib/ViewDependencyHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/support/lib/CommonMethods","sap/suite/ui/generic/template/library"],function(q,U,N,F,a,b,J,R,A,c,B,d,P,T,C,V,t,e){"use strict";A=t.observableConstructor(A);var D=sap.m.DraftIndicatorState;var r=T.getRegisterAppComponent();var o;function g(){o=o||new R({bundleName:"sap/suite/ui/generic/template/lib/i18n/i18n"}).getResourceBundle();return o.getText.apply(o,arguments);}function f(){return new P({processObservers:[]});}var m=sap.ui.getCore().getMessageManager().getMessageModel();var v=new a({path:"validation",operator:b.EQ,value1:true});function h(j,k){var l={oAppComponent:j,componentRegistry:Object.create(null),aRunningSideEffectExecutions:[],getText:g,mRouteToTemplateComponentPromise:Object.create(null),oTemplatePrivateGlobalModel:(new J()).setDefaultBindingMode("TwoWay"),aStateChangers:[],oPaginatorInfo:Object.create(null),oStatePreserversAvailablePromise:Promise.resolve(),oValidationMessageBinding:m.bindList("/",null,null,v)};l.oValidationMessageBinding.attachChange(q.noop);var n;var p;var s;function u(){var i=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("URLParsing");l.oTemplatePrivateGlobalModel.setProperty("/generic",{crossAppNavSupport:!!i&&i.isIntentUrl(document.URL),draftIndicatorState:D.Clear,shellServiceUnavailable:false,forceFullscreenCreate:false});j.setModel(l.oTemplatePrivateGlobalModel,"_templPrivGlobal");l.oShellServicePromise.catch(function(){l.oTemplatePrivateGlobalModel.setProperty("/generic/shellServiceUnavailable",true);});}function w(){l.fnAddSideEffectPromise=function($){var i=0;for(;l.aRunningSideEffectExecutions[i];){i++;}l.aRunningSideEffectExecutions[i]=$;var _=function(){l.aRunningSideEffectExecutions[i]=null;};$.then(_,_);};n.attachEvent("beforeSideEffectExecution",function(i){if(i.getParameter("valueChange")||i.getParameter("fieldControl")){var $=i.getParameter("promise");l.oBusyHelper.setBusy($);l.fnAddSideEffectPromise($);}});var Y=j.getModel("_templPrivGlobal");var Z="/generic/draftIndicatorState";n.attachBeforeQueueItemProcess(function(i){if(i.draftSave){Y.setProperty(Z,D.Saving);}});n.attachOnQueueCompleted(function(){if(Y.getProperty(Z)===D.Saving){Y.setProperty(Z,D.Saved);}});n.attachOnQueueFailed(function(){if(Y.getProperty(Z)===D.Saving){Y.setProperty(Z,D.Clear);}});Y.setProperty("/generic/appComponentName",j.getMetadata().getComponentName());}function x(){var i={appComponent:j,oTemplateContract:l,application:new c(l),oViewDependencyHelper:new V(l)};l.oViewDependencyHelper=i.oViewDependencyHelper;l.oShellServicePromise=j.getService("ShellUIService").catch(function(){var Z=sap.ui.core.service.ServiceFactoryRegistry.get("sap.ushell.ui5service.ShellUIService");return((Z&&Z.createInstance())||Promise.reject());});l.oShellServicePromise.catch(function(){q.sap.log.warning("No ShellService available");});(U.prototype.init||q.noop).apply(j,arguments);l.oBusyHelper.setBusy(l.oShellServicePromise);s=r(i);var Y=j.getModel();n=new A(Y);u();p=new d(l);w();C.enableAutomaticDraftSaving(l);if((!Y.oMetadata||!Y.oMetadata.isLoaded())||Y.oMetadata.isFailed()){Y.attachMetadataFailed(function(){p.navigateToMessagePage({title:g("ST_GENERIC_ERROR_TITLE"),text:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE"),icon:"sap-icon://message-error",description:g("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC")});for(var Z in l.componentRegistry){l.componentRegistry[Z].fnViewRegisteredResolve(true);}});}if(j&&j.getMetadata()&&j.getMetadata().getManifest()){e.setAppComponent(j);}e.setApplicationStatus(e.mApplicationStatus.LOADING);e.publishEvent("elements","ViewRenderingStarted",{});l.oBusyHelper.setBusyReason("initAppComponent",false);}function y(){if(l.oNavigationHost){return"";}if(l.sRoutingType==="f"){var i=new F();l.oNavigationHost=i;l.aNavigationObservers=[new P({processName:"BeginColumnNavigation",eventHandlers:{attachProcessStart:i.attachBeginColumnNavigate.bind(i),attachProcessStop:i.attachAfterBeginColumnNavigate.bind(i)}}),new P({processName:"MidColumnNavigation",eventHandlers:{attachProcessStart:i.attachMidColumnNavigate.bind(i),attachProcessStop:i.attachAfterMidColumnNavigate.bind(i)}}),new P({processName:"EndColumnNavigation",eventHandlers:{attachProcessStart:i.attachEndColumnNavigate.bind(i),attachProcessStop:i.attachAfterEndColumnNavigate.bind(i)}})];l.oNavigationObserver=new P({processObservers:l.aNavigationObservers});l.aHeaderLoadingObservers=[f(),f(),f()];}else{var Y=new N({id:j.getId()+"-appContent"});l.oNavigationHost=Y;l.oNavigationObserver=new P({processName:"Navigation",eventHandlers:{attachProcessStart:Y.attachNavigate.bind(Y),attachProcessStop:Y.attachAfterNavigate.bind(Y)}});}l.oHeaderLoadingObserver=new P({processObservers:l.aHeaderLoadingObservers||[]});l.oPagesDataLoadedObserver=new P({processObservers:[l.oHeaderLoadingObserver,l.oNavigationObserver]});l.oNavigationHost.addStyleClass(l.oApplicationProxy.getContentDensityClass());l.oBusyHelper=new B(l);l.oBusyHelper.setBusyReason("initAppComponent",true,true);return l.oNavigationHost;}function z(){if(l.oNavigationHost){l.oNavigationHost.destroy();}if(n){n.destroy();}if(p){p.destroy();}if(l.oValidationMessageBinding){l.oValidationMessageBinding.destroy();}(U.prototype.exit||q.noop).apply(j,arguments);s();t.endApp(k);}function E(i){var Y=Object.keys(i).map(function(Z){var $=i[Z];if($.pages){$.pages=E($.pages);}return i[Z];});return Y;}function G(Y,Z){if(!Y){return;}for(var i=0;i<Y.length;i++){var $=Y[i];if($.routingSpec&&$.routingSpec.noOData){$.entitySet=$.routingSpec.routeName;if(Z>1){$.navigationProperty=$.routingSpec.routeName;}}G($.pages,Z+1);if($.embeddedComponents){for(var _ in $.embeddedComponents){var a1=$.embeddedComponents[_];if(a1.pages){a1.pages=E(a1.pages);G(a1.pages,Z+1);}}}if($.implementingComponent&&$.implementingComponent.pages){$.implementingComponent.pages=E($.implementingComponent.pages);G($.implementingComponent.pages,Z+1);}}}function H(i){if(i){var Y=i.entitySet;var Z=(i.component&&i.component.settings&&i.component.settings.quickVariantSelectionX&&i.component.settings.quickVariantSelectionX.variants)||{};var $=function(Z){for(var _ in Z){var a1=Z[_];if(!!a1.entitySet){return true;}}return false;};if($(Z)){for(var _ in Z){var a1=Z[_];if(a1.entitySet===undefined){a1.entitySet=Y;}}}}}var I;function K(){if(!I){var i=j.getMetadata();I=i.getManifestEntry("sap.ui.generic.app");if(I._version==="1.3.0"&&I.pages&&q.isPlainObject(I.pages)){I.pages=E(I.pages);}G(I.pages,0);H(I.pages[0]);}return I;}var L;function M(){if(!L){L=q.extend({},j.getMetadata().getManifest());L["sap.ui.generic.app"]=K();}return L;}function O(){var i=j.getManifestObject();var Y=i.getEntry("sap.ui.generic.app").settings;l.sRoutingType=(Y&&Y.flexibleColumnLayout)?"f":"m";return"sap."+l.sRoutingType+".routing.Router";}var Q=Promise.resolve();function S(){var i=new Promise(function(Y){Q.then(function(){var Z=[];l.oNavigationControllerProxy.getActiveComponents().forEach(function($){var _=l.componentRegistry[$];var a1=_.oComponent.getComponentContainer();var b1=a1.getParent();if(b1.getMetadata().getName()!=="sap.m.NavContainer"){throw new Error("Recreation only possible for sap.m.NavContainer");}var c1=l.oNavigationControllerProxy.createComponentInstance(l,_.routeConfig,l.oNavigationControllerProxy.mRouteToComponentResolve[_.route]);Z.push(c1.loaded().then(function(c1){var d1=a1.getComponentInstance().getBindingContext();b1.removePage(a1);b1.addPage(c1);b1.to(c1);a1.destroy();var e1=c1.getComponentInstance();var f1=l.componentRegistry[e1.sId];f1.activationTakt=_.activationTakt;l.mRouteToTemplateComponentPromise[_.route]=Promise.resolve(e1);if(d1){f1.viewRegistered.then(function(){f1.utils.bindComponent(d1.getPath(),true);});}return f1.oViewRenderedPromise;}));});Y(Promise.all(Z));});});Q=i.then(q.noop);return Q;}var W={init:x,createContent:y,exit:z,_getRouterClassName:O,getConfig:K,getInternalManifest:M,getTransactionController:function(){return n.getTransactionController();},getApplicationController:function(){return n;},getNavigationController:function(){return p;}};var X={retemplateActiveComponents:S};if(sap.ui.getCore().getConfiguration().getDesignMode()){q.extend(W,X);}return W;}return U.extend("sap.suite.ui.generic.template.lib.AppComponent",{metadata:{config:{title:"SAP UI Application Component",fullWidth:true},properties:{forceGlobalRefresh:{type:"boolean",defaultValue:true},"considerAnalyticalParameters":{"type":"boolean","defaultValue":"false"}},events:{pageDataLoaded:{}},routing:{config:{async:true,viewType:"XML",viewPath:"",clearTarget:false},routes:[],targets:[]},library:"sap.suite.ui.generic.template"},constructor:function(){var i=t.startApp();q.extend(this,h(this,i));(U.prototype.constructor||q.noop).apply(this,arguments);}});});
