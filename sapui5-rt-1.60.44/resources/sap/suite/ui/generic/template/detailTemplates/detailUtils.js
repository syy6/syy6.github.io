sap.ui.define(["jquery.sap.global","sap/ui/core/routing/HashChanger","sap/suite/ui/generic/template/extensionAPI/NavigationController","sap/suite/ui/generic/template/lib/MessageButtonHelper","sap/suite/ui/generic/template/lib/testableHelper","sap/suite/ui/generic/template/detailTemplates/PaginatorButtonsHelper","sap/suite/ui/generic/template/ObjectPage/extensionAPI/DraftTransactionController","sap/suite/ui/generic/template/ObjectPage/extensionAPI/NonDraftTransactionController","sap/m/DraftIndicator"],function(q,H,N,M,t,P,D,a){"use strict";var b=sap.m.DraftIndicatorState;function g(C,o,v){function i(){var T=o.getTemplatePrivateModel();T.setProperty("/objectPage",{displayMode:0,headerInfo:{objectTitle:"",objectSubtitle:""}});o.setStatePreserverPromise(v);}function d(B,I){var U=C.getModel("ui");var T=o.getTemplatePrivateModel();if(o.getEditableNDC()){U.setProperty("/editable",true);var k=o.isNonDraftCreate();U.setProperty("/createMode",k);T.setProperty("/objectPage/displayMode",k?4:2);}else if(!o.isDraftEnabled()){U.setProperty("/editable",false);U.setProperty("/createMode",false);T.setProperty("/objectPage/displayMode",1);}(v.onComponentActivate||q.noop)(B,I);}function u(){var B=C.getBindingContext();var k=o.registerContext(B);var T=C.getModel("_templPrivGlobal");T.setProperty("/generic/draftIndicatorState",b.Clear);(v.getHeaderInfoTitleForNavigationMenue||q.noop)();(v.applyHeaderContextToSmartTablesDynamicColumnHide||q.noop)(B);var A=B.getObject();var U=C.getModel("ui");var I;var l=o.getTemplatePrivateModel();if(k.bIsDraft){I=true;U.setProperty("/enabled",true);l.setProperty("/objectPage/displayMode",k.bIsCreate?4:2);}else{I=o.getEditableNDC();l.setProperty("/objectPage/displayMode",I?2:1);if(A.hasOwnProperty("HasDraftEntity")&&A.HasDraftEntity){U.setProperty("/enabled",false);var m=C.getModel();var r=new Promise(function(R,s){m.read(B.getPath(),{urlParameters:{"$expand":"SiblingEntity,DraftAdministrativeData"},success:R,error:s});});var p=o.getBusyHelper();p.setBusy(r);r.then(function(R){var s=m.getContext("/"+m.getKey(R.SiblingEntity));if(s){(v.draftResume||q.noop)(s,A,R.DraftAdministrativeData);}U.setProperty("/enabled",true);},function(E){});}else{U.setProperty("/enabled",true);}}U.setProperty("/createMode",k.bIsCreate);U.setProperty("/editable",I);}function f(){return o.getDraftRootPath();}function n(){v.navigateUp();}function e(p){return v.oStatePreserverPromise.then(function(s){return s.getUrlParameterInfo(p);});}function h(O){return v.getMessageFilters(O);}function j(k){return v.getScrollFunction&&v.getScrollFunction(k);}return{init:i,onActivate:d,getTitle:o.getTitleFromTreeNode,updateBindingContext:u,currentDraftModified:f,navigateUp:n,getUrlParameterInfo:e,getMessageFilters:h,getScrollFunction:j};}function c(v,T,C){var o;var e;var l;var p;var h;function G(){return h||H.getInstance();}function f(j,i){return function(){T.oServices.oApplication.subTitleForViewLevelChanged(j,i.getText());};}function s(i){var I=!T.oComponentUtils.isDraftEnabled();if(I||!i){var U=C.getView().getModel("ui");U.setProperty("/editable",i);}if(I){T.oComponentUtils.setEditableNDC(i);}}function O(){T.oCommonUtils.processDataLossConfirmationIfNonDraft(function(){var i=T.oComponentUtils.isDraftEnabled();if(!i){s(false);}T.oServices.oNavigationController.navigateBack();},q.noop,o.state);}function A(){var B=T.oComponentUtils.getTemplatePrivateModel();var U=B.getProperty("/generic/viewLevel")-1;var S=U?T.oServices.oApplication.getHierarchySectionsFromCurrentHash():[];var j=v.aBreadCrumbs;h=G();l="";var E="";for(var i=0;i<U;i++){var I=S[i];l=l+E+I;E="/";var J=e[i];var K=I.split("(");if(K&&K[1]){var L=j&&j[i];if(L){var Q=h.hrefForAppSpecificHash?h.hrefForAppSpecificHash(l):"#/"+l;Q=T.oServices.oApplication.adaptBreadCrumbUrl(Q,i+1);var R="/"+J+"("+K[1];L.setHref(Q);var W=L.getBindingInfo("text")||{};W.events={change:f(i+1,L)};L.bindElement({path:R});}}}}function d(i){var j=i.getBindingContext();var E=G().getHash();return T.oServices.oApplicationController.propertyChanged(E,j);}function n(){if(l){T.oServices.oNavigationController.navigateToContext(l,"",true);}else{T.oServices.oNavigationController.navigateToRoot(true);}}function k(i){var j=T.oServices.oApplication.getBusyHelper();var U=C.getView().getModel("ui");var E=C.getOwnerComponent().getModel("_templPrivGlobal");var I=d(i).then(function(R){if(!o.fclInfo.isContainedInFCL||E.getProperty("/generic/FCL/isVisuallyFullScreen")){n();}},function(){j.getUnbusy().then(function(R){if(!o.fclInfo.isContainedInFCL||E.getProperty("/generic/FCL/isVisuallyFullScreen")){T.oCommonUtils.processDataLossTechnicalErrorConfirmation(function(){n();U.setProperty("/enabled",true);},q.noop,o.state);}else{T.oCommonUtils.processDataLossTechnicalErrorConfirmation(q.noop,q.noop,o.state,"StayOnPage");}});});j.setBusy(I);}function m(E){var i=E.getSource();o.state.beforeSaveHelper.prepareAndRunSaveOperation(false,k.bind(null,i));}function r(){o.state.messageButtonHelper.toggleMessagePopover();}function u(i){return o.state.messageButtonHelper&&o.state.messageButtonHelper.getMessageFilters(i);}function w(){var i;return function(){i=i||new N(T,C,o.state);return i;};}function x(){var i;return function(){if(!i){var j=T.oComponentUtils.isDraftEnabled()?D:a;i=new j(T,C,o.state);}return i;};}function y(){p.handleShowNextObject();}function z(){p.handleShowPrevObject();}var G=t.testable(G,"getHashChangerInstance");var A=t.testable(A,"adaptLinksToUpperLevels");o={onInit:function(R,i,j){e=T.oServices.oApplication.getSections(C.getOwnerComponent().getEntitySet(),true);if(!R||R.footerBar){var I=T.oComponentUtils.isODataBased();var E={controller:C,getScrollDelegate:i||q.noop,prepareAllMessagesForNavigation:j};o.state.messageButtonHelper=new M(T.oCommonUtils,E,I);o.state.beforeSaveHelper=T.oServices.oApplication.getBeforeSaveHelper(C,T.oCommonUtils);T.oServices.oTemplateCapabilities.oMessageButtonHelper=o.state.messageButtonHelper;}if(!R||R.paginatorButtons){p=new P(o,C,T);}v.getScrollFunction=i&&function(J){var S=i();var K=S&&T.oCommonUtils.getPositionableControlId(J);return K&&T.oCommonUtils.focusControl.bind(null,S,K);};},handlers:{handleShowNextObject:y,handleShowPrevObject:z,onShowMessages:r,applyAndUp:m,onBack:O},extensionAPI:{getNavigationControllerFunction:w,getTransactionControllerFunction:x},fclInfo:{isContainedInFCL:false},state:{},onComponentActivate:function(i,I){if(o.state.messageButtonHelper){o.state.messageButtonHelper.adaptToContext(i);}T.oComponentUtils.setBackNavigation(O);A();if(p){p.computeAndSetVisibleParamsForNavigationBtns();}v.oStatePreserverPromise.then(function(S){S.applyAppState(i,I);});}};v.navigateUp=n;v.setEditable=s;v.getMessageFilters=u;var B=T.oComponentUtils.getTemplatePrivateModel();var V=B.getProperty("/generic/viewLevel");var F=T.oServices.oApplication.getFclProxyForView(V);if(F.oActionButtonHandlers){o.handlers.fclActionButtonHandlers=F.oActionButtonHandlers;o.fclInfo.isContainedInFCL=true;}o.fclInfo.navigateToDraft=F.navigateToDraft;o.stateChanged=function(){v.oStatePreserverPromise.then(function(S){S.stateChanged();});};return o;}return{getComponentBase:g,getControllerBase:c};});
