sap.ui.define(["sap/suite/ui/generic/template/AnalyticalListPage/control/visualfilterbar/FilterItem","sap/ui/model/Sorter","sap/ui/model/analytics/odata4analytics","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/ui/core/format/NumberFormat","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/ui/core/format/DateFormat"],function(F,S,d,c,N,v,D){"use strict";var C="Donut";var f="Line";var g="Bar";var I="__IS_OTHER__";var h=F.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.visualfilterbar.FilterItemMicroChart",{metadata:{properties:{smartFilterId:{type:"string",group:"Misc",defaultValue:null}},aggregations:{control:{type:"sap.ui5.controls.microchart",multiple:false}}},renderer:function(r,o){r.write("<div");r.writeControlData(o);r.writeClasses();r.addStyle("width","100%");jQuery(document.body).hasClass("sapUiSizeCozy")?r.addStyle("height","9.9rem"):r.addStyle("height","7.9rem");r.writeStyles();r.write(">");r.renderControl(o.getAggregation("control"));r.write("</div>");}});h.prototype._formattingId="__UI5__ShortIntegerMaxFraction2";h.prototype._maxFractionalDigits=2;h.prototype._maxFractionalDigitsValsLessThanZero=7;h.prototype._minFractionalDigits=0;h.prototype._shortRefNumber;h.prototype._isTriggeredBySync=false;h.prototype._multiUnit=false;h.prototype.technicalIssueMessage="TECHNICAL_ISSUES_OVERLAY_MESSAGE";h.prototype.noDataIssueMessage="NO_DATA_FOUND_OVERLAY_MESSAGE";h.prototype.requiredFilterMessage="REQUIRED_FIELDS_OVERLAY_MESSAGE";h.prototype.multipleCurrencyMessage="MULTIPLE_CURRENCY_OVERLAY_MESSAGE";h.prototype.multipleUnitMessage="MULTIPLE_UNIT_OVERLAY_MESSAGE";h.prototype.hiddenMeasureMessage="HIDDEN_MEASURE_OVERLAY_MESSAGE";h.prototype.init=function(){this._bAllowBindingUpdateOnPropertyChange=false;this._attachChartEvents();};h.prototype._attachChartEvents=function(){var m=this;this._chart.addEventDelegate({onAfterRendering:function(){if(m._getChartAggregations().length){if(m._multiUnit){m.applyOverlay(m.getIsCurrency()?m.multipleCurrencyMessage:m.multipleUnitMessage);}}}});this._chart.attachSelectionChanged(this._onSelectionChanged,this);};h.prototype._getCurrentSelectedChart=function(r){if(this._chart.getPoints){return r?f:"point";}else if(this._chart.getSegments){return r?C:"segment";}else if(this._chart.getBars){return r?g:"bar";}};h.prototype._getCustomData=function(e){var s=this._getCurrentSelectedChart();var a=(s)?e.getParameter(s):undefined;if(s&&a){var b=a.getCustomData(),V=b[0].getValue();if(V instanceof Date){V=c.convertLocalDatetoUTCDate(V);}var i={dimValue:V,dimValueDisplay:a.getLabel()};return i;}};h.prototype._onSelectionChanged=function(e){var s=this.getFilterRestriction(),o=this._getCustomData(e),b=e.getParameter("selected"),a=(s==="single"&&o.dimValue===I&&b);if(o.dimValue===I&&b&&this.getIsDropDown()){e.getParameter("segment").setSelected(false);return;}if(a){e.getParameter("segment").setSelected(false);}if(b&&o.dimValue===I&&s==="multiple"||(b&&o.dimValue!==I)){this._onChartSelectData(e);}else if(!b){this._onChartDeselectData(e);}};h.prototype._onChartSelectData=function(e){var o,s=this.getFilterRestriction();if(s==="multiple"){o=jQuery.extend(true,{items:[],ranges:[],value:null},this.getDimensionFilter());var a=this._getCustomData(e),b=this._getCurrentSelectedChart(true);if(b===C){o=this._applyDonutChartSelections(a,o);}else if(a.dimValue instanceof Date){o.ranges.push({exclude:false,keyField:this.getDimensionField(),operation:"EQ",value1:a.dimValue,value2:null});}else{o.items.push({key:a.dimValue,text:a.dimValueDisplay});}}else{o=this.getDimensionFilter();if(o){o=null;var i=e.getParameter("bar")||e.getParameter("point")||e.getParameter("segment");this._setSelectedAggregation(i);i.setSelected(true);}var a=this._getCustomData(e);o=a.dimValue;}this.setDimensionFilter(o);this.fireFilterChange();};h.prototype._setSelectedAggregation=function(s){var a=this._chart.setSelectedBars||this._chart.setSelectedPoints||this._chart.setSelectedSegments;a.call(this._chart,s);};h.prototype._getChartAggregations=function(){var a=this._chart.getPoints||this._chart.getSegments||this._chart.getBars;return a.call(this._chart);};h.prototype._onChartDeselectData=function(e){var o,s=this.getFilterRestriction(),a=this._getCustomData(e),u=[],U=[];if(s==="single"){o=null;}else{o=jQuery.extend(true,{},this.getDimensionFilter());var b=(o&&o.items)?o.items:undefined,i=(o&&o.ranges)?o.ranges:undefined,j=(o&&o.value)?o.value:null;if(b){b.forEach(function(k){var E=c.getResolvedDimensionValue(k.key),l=c.getResolvedDimensionValue(a.dimValue);if(E!==l){u.push(k);}});}o.items=u;if(j){if(a.dimValue===j){o.value=null;}}if(i){i.forEach(function(k){if(k.operation==="EQ"&&a.dimValue!==I&&k.exclude){U.push(k);}else if(k.operation==="EQ"&&!k.exclude){if(k.value1 instanceof Date&&a.dimValue instanceof Date){if(c.getDateInMedium(k.value1)!==c.getDateInMedium(a.dimValue)){U.push(k);}}else if(k.value1!==a.dimValue){U.push(k);}}else if(k.operation!=="EQ"&&!k.exclude&&k.value1!==a.dimValue){U.push(k);}});}o.ranges=U;}this.setDimensionFilter(o);this.fireFilterChange();};h._getSorter=function(s){var a=[],b=[],e=[];for(var i=0;i<s.length;i++){a[i]=s[i].Field.String;b[i]=s[i].Descending.Boolean;e.push(new S(a[i],b[i]));}var o={sorter:e,sortFields:a};return o;};h.prototype._getNumberFormatter=function(s){var a=N.getIntegerInstance({style:"short",showScale:false,shortRefNumber:s});return a;};h.prototype.setWidth=function(w){this.setProperty("width",w);};h.prototype.setHeight=function(a){this.setProperty("height",a);};h.prototype.setEntitySet=function(e){this.setProperty("entitySet",e);};h.prototype.setDimensionField=function(a){this.setProperty("dimensionField",a);};h.prototype.setDimensionFieldIsDateTime=function(a){this.setProperty("dimensionFieldIsDateTime",a);};h.prototype.setDimensionFieldDisplay=function(a){this.setProperty("dimensionFieldDisplay",a);};h.prototype.setMeasureField=function(m){if(m&&m.constructor===Object){if(m.value){this.setProperty("measureField",m.value);}if(m.bUpdateBinding){this._updateBinding();}}else if(m&&m.constructor===Array){this.setProperty("measureField",m);}else{this.setProperty("measureField",m);}};h.prototype.setUnitField=function(u){this.setProperty("unitField",u);};h.prototype.setSortOrder=function(s){if(s&&s.constructor===Object){if(s.value){this.setProperty("sortOrder",s.value);}if(s.bUpdateBinding){this._updateBinding();}}else if(s&&s.constructor===Array){this.setProperty("sortOrder",s);}else{this.setProperty("sortOrder",s);}};h.prototype.setDimensionFilterExternal=function(a){this.setProperty("dimensionFilterExternal",a);if(this._bAllowBindingUpdateOnPropertyChange){this._updateBinding();}};h.prototype.getP13NConfig=function(){var p=["width","height","filterRestriction","isDropDown","sortOrder","measureField","scaleFactor","numberOfFractionalDigits","chartQualifier","entitySet","dimensionField","dimensionFieldDisplay","dimensionFieldIsDateTime","dimensionFilter","unitField","isCurrency","isMandatory","outParameter","inParameters","parentProperty"];var o={};for(var i=0;i<p.length;i++){var n=p[i];o[n]=this.getProperty(n);if((n=="outParameter"||n=="inParameters")&&o[n]==""){o[n]=undefined;}}return o;};h.prototype.setDimensionFilter=function(a,i){this.setProperty("dimensionFilter",a);};h.prototype._onDataReceived=function(a){if(!a){return;}this._determineUnit(a);this._getShortRefNumber(a.slice(0));};h.prototype._determineUnit=function(a){this._multiUnit=false;var u=this.getUnitField();if(u){var p=a[0][u];for(var i=1;i<a.length;i++){if(a[i].dimensionValue!==I){var b=a[i][u];}if(b!=p){if(a.length>1){this._multiUnit=true;}break;}p=b;}this._applyUnitValue(this._multiUnit?"":p);}else{this._applyUnitValue("");}};h.prototype._applyUnitValue=function(a){if(this._lastUnitValue!=a){this._lastUnitValue=a;this.fireTitleChange();}};h.prototype._getShortRefNumber=function(o){this._scaleValue="";this._shortRefNumber=undefined;var s=this.getScaleFactor(),a;if(!s){var b=this._getScaleFactorFromMedian(o);s=b.iShortRefNumber;a=b.scale;}else{var e=this._getNumberFormatter(s);a=e.getScale()?e.getScale():"";}this._shortRefNumber=s;this._scaleValue=a;this.fireTitleChange();};h.prototype._getScaleFactorFromMedian=function(o){var m=this.getMeasureField();o.sort(function(a,b){if(Number(a[m])<Number(b[m])){return-1;}if(Number(a[m])>Number(b[m])){return 1;}return 0;});var M=o.length/2,e=M%1===0?(parseFloat(o[M-1][m])+parseFloat(o[M][m]))/2:parseFloat(o[Math.floor(M)][m]),j=e,s;for(var i=0;i<14;i++){s=Math.pow(10,i);if(Math.round(Math.abs(j)/s)<10){break;}}var k=this._getNumberFormatter(s);for(var i=0;i<o.length;i++){var l=o[i],n=k.format(l[m]),p=n.split(".");if((!p[1]&&parseInt(p[0],10)===0)||(p[1]&&parseInt(p[0],10)===0&&p[1].indexOf('0')===0)||(n/1000)>=1000){s=undefined;break;}}return{iShortRefNumber:s,scale:s?k.getScale():""};};h.prototype._getScaleFactor=function(a){var a=parseFloat(a);var p=this._minFractionalDigits;for(var i=0;i<14;i++){var s=Math.pow(10,i);if(Math.round(Math.abs(a)/s,p-1)<10){return s;}}return undefined;};h.prototype.getTitle=function(){var m=this.getModel();if(!m){return"";}var a=c.getPropertyNameDisplay(m,this.getEntitySet(),this.getMeasureField());var b=c.getPropertyNameDisplay(m,this.getEntitySet(),this.getDimensionField());var u=this._lastUnitValue?this._lastUnitValue:"";var s=this._scaleValue?this._scaleValue:"";var i=this.getModel("i18n");if(!i){return"";}var r=i.getResourceBundle();var t=r.getText("VIS_FILTER_TITLE_MD",[a,b]);var e=s+" "+u;e=e.trim();e=e.indexOf("%")>-1?"":e;var j={titleMD:t,titleUnitCurr:e};return j;};h.prototype.getFormattedNumber=function(a,s){var n=this.getNumberOfFractionalDigits();if(n===""||n===undefined){n="1";}else{if(Number(n)>1){n="1";}}var b=N.getFloatInstance({style:"short",decimals:Number(n),showScale:s,shortRefNumber:this._shortRefNumber,minFractionDigits:this._minFractionalDigits,maxFractionDigits:this._maxFractionalDigits});return b.format(parseFloat(a));};h.prototype._getFormattedNumberWithUoM=function(a,U){U=(U)?U:"";var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var b=N.getFloatInstance({maxFractionDigits:2,groupingEnabled:true},l).format(a);return(U==="%")?b+"%":b+" "+U;};h.prototype._getDisplayedValue=function(a,u){var s=(this._scaleValue===""),n=this.getFormattedNumber(a,s),i=(u==="%");return(i)?n+"%":""+n;};h.prototype._getToolTip=function(a,b,u){var n=this._getFormattedNumberWithUoM(b,u);return a+"\n"+n;};h.prototype._getSelected=function(o,s){var b=false,a=this.getFilterRestriction(),e=[];if(o){if(a==='multiple'){if(o.items){o.items.forEach(function(k){var l=c.getResolvedDimensionValue(k.key),m=c.getResolvedDimensionValue(s);if(l===m){b=true;}});}if(o.value&&o.value===s){b=true;}if(o.ranges){for(var i=0;i<o.ranges.length;i++){var r=o.ranges[i];if(r.operation==="EQ"&&r.value1&&!r.exclude){if(r.value1 instanceof Date&&s instanceof Date){if(c.getDateInMedium(r.value1)===c.getDateInMedium(s)){b=true;break;}}else if(r.value1===s){b=true;break;}else if(this._isDateTimeFieldSelected(r.value1,s)){b=true;break;}}else if(r.exclude&&r.operation==='EQ'){e.push(r.value1);}}if(e.length===2&&s===I){var V=0,j=this._chart.getSegments();j.forEach(function(k){var l=k.getCustomData()[0].getValue();if(e.indexOf(l)>-1){V++;}});if(V===2){b=true;}}}}else if(o instanceof Date&&s instanceof Date){if(c.getDateInMedium(o)===c.getDateInMedium(s)){b=true;}}else if(o&&o===s){b=true;}else if(this._isDateTimeFieldSelected(o,s)){b=true;}}return b;};h.prototype._isDateTimeFieldSelected=function(o,s){if(this.getDimensionFieldIsDateTime()){if(typeof o==="string"&&s instanceof Date){if(c.getDateInMedium(new Date(o))===c.getDateInMedium(s)){return true;}}else if(o instanceof Date&&typeof s==="string"){var a=D.getDateInstance({pattern:"yyyyMMdd"});var b=a.parse(s);if(c.getDateInMedium(b)===c.getDateInMedium(o)){return true;}}}return false;};h.prototype._getLabel=function(o,s){if(this.getDimensionFieldIsDateTime()){if(o instanceof Date){return c.getDateInMedium(c.convertLocalDatetoUTCDate(o));}else if(this._isStringDateType()){return c.formatStringDate(o,s||"");}else{return o;}}else{var t=this.getTextArrangement();return c.getTextArrangement(o,s,t);}};h.prototype._getChartAggregationSettings=function(i){var s=sap.ui.getCore().byId(this.getSmartFilterId());var a=i?'dimensionValue':this.getDimensionField(),b=this.getDimensionFieldDisplay(),m=this.getMeasureField(),u=this.getUnitField(),l=(a===b)?[b]:[b,a],t=(a===b)?[b,m,""]:[b,m,a],U=u?t.push(u):t,e=this,o={label:{parts:l,formatter:function(j,a){return e._getLabel(j,a);}},value:{path:m,formatter:function(j){return parseFloat(j);}},displayedValue:{parts:[m,u],formatter:function(j,k){return e._getDisplayedValue(j,k);}},tooltip:{parts:U.constructor===Array?U:t,formatter:function(j,k,a,n){j=j||j===""||j===0?j:"";a=a||a===""||a===0?a:"";a=a.constructor===Object?"":a;j=e._getLabel(j,a);return e._getToolTip(j,k,n);}},selected:{parts:s.isDialogOpen()?["_dialogFilter>/"+e.getParentProperty(),a]:["_filter>/"+e.getParentProperty(),a],formatter:function(j,k){if(k instanceof Date){k=c.convertLocalDatetoUTCDate(k);}return e._getSelected(j,k);}},customData:{Type:"sap.ui.core.CustomData",key:a,value:"{"+a+"}"},color:"{color}"};return o;};h.prototype.applyOverlay=function(i){var p=this.data("sPath");if(p){var s=p+"/showChartOverlay";var a=this.getModel('_visualFilterDialogModel')?this.getModel('_visualFilterDialogModel'):this.getModel('_visualFilterConfigModel');a.setProperty(s,(i?true:false));if(i){var o=p+"/overlayMessage";a.setProperty(o,i);}}};h.prototype.considerAnalyticBinding=function(b,s){if(s&&s.getAnalyticBindingPath&&s.getConsiderAnalyticalParameters()){try{var a=s.getAnalyticBindingPath();if(a){return a;}}catch(e){jQuery.sap.log.warning("Mandatory parameters have no values","","AnalyticalListPage");}}return b;};h.prototype.resolveParameterizedEntitySet=function(o,e,p,s){var a="";var b=new d.Model(d.Model.ReferenceByModel(o));var q=b.findQueryResultByName(e);var i=new d.QueryResultRequest(q);var j=q.getParameterization();if(j){i.setParameterizationRequest(new d.ParameterizationRequest(j));if(p){p.forEach(function(P){var r=P.PropertyName.PropertyPath;var t=P.PropertyValue.String;if(r&&t){i.getParameterizationRequest().setParameterValue(r,t);}});}if(s.getEntitySet()===e){var k=s.getAnalyticalParameters();var l=s.getFilterData(true);var m=JSON.parse(s.data('dateFormatSettings'));k.forEach(function(r){var V=l["$Parameter."+r.name];if(V){if(r.type==="Edm.Time"&&V instanceof Date){if(m&&!m.UTC){V=new Date(V.valueOf()+V.getTimezoneOffset()*60*1000);}V={__edmType:"Edm.Time",ms:(((V.getHours()*60)+V.getMinutes())*60+V.getSeconds())*1000+V.getMilliseconds()};}else if(m&&m.UTC&&V instanceof Date){V=this._getDateInUTCOffset(V);}i.getParameterizationRequest().setParameterValue(r.name,V);}}.bind(this));}}try{a=i.getURIToQueryResultEntitySet();}catch(n){q=i.getQueryResult();a="/"+q.getEntitySet().getQName();jQuery.sap.log.error("getEntitySetPathWithParameters","binding path with parameters failed - "+n||n.message);}return a;};h.prototype.checkSearchable=function(o,e,s,p,a){var b=new d.Model(d.Model.ReferenceByModel(o));var q=b.findQueryResultByName(e);var i=q.getParameterization(),j=[],k=true;if(i){var l=i.getAllParameterNames();l.forEach(function(P){p&&p.forEach(function(n){if(n.PropertyName.PropertyPath===P&&n.PropertyValue.String){j.push("$Parameter."+n.PropertyName.PropertyPath);}});});if(s.getEntitySet()===e){var A=s.getFilterData(true);l.forEach(function(P){if(A["$Parameter."+P]&&j.indexOf("$Parameter."+P)<0){j.push("$Parameter."+P);}});}if(l.length!==j.length){k=false;return k;}}j=[];if(s.getEntitySet()===e){var m=s.determineMandatoryFilterItems();var m=m.filter(function(n){return!n._bIsParameter;});m.forEach(function(n){a&&a.forEach(function(r){if(r.PropertyName.PropertyPath===n.getName()){j.push(r.PropertyName.PropertyPath);}});s.getFiltersWithValues().forEach(function(r){if(r.getName()===n.getName()&&!j[r.getName()]){j.push(r.getName());}});});if(j.length!==m.length){k=false;return k;}}return k;};h.prototype._getPathForVisualFilter=function(m,e){var p;if(this.getSmartFilterId()){var s=sap.ui.getCore().byId(this.getSmartFilterId());var a=this.getSelectFilters()&&this.getSelectFilters().Parameters;var b=this.getSelectFilters()&&this.getSelectFilters().SelectOptions;var i=this.checkSearchable(m,e,s,a,b);if(i){p=this.resolveParameterizedEntitySet(m,e,a,s);}else{this.applyOverlay(this.requiredFilterMessage);return;}}return p;};h.prototype._getDateInUTCOffset=function(o){return new Date(o.valueOf()-o.getTimezoneOffset()*60*1000);};h.prototype._isStringDateType=function(){var o=this.getCustomData();var s=false;o.forEach(function(a){if(a.getKey()=='stringdate'){s=a.getValue();}});return s;};h.prototype._determineHiddenVisualFilter=function(m,e,a){var E=m.getODataEntityType(m.getODataEntitySet(e).entityType);var p=m.getODataProperty(E,a);if(p[v.Hidden]&&p[v.Hidden].Bool==="true"){return true;}};return h;},true);
