sap.ui.define(["sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiAnnotationHelper","sap/suite/ui/generic/template/AnalyticalListPage/util/CriticalityUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms"],function(K,a,C,F,V,b){"use strict";var b=function(k){this._getDataFromAnnotations(k);};b.prototype._getDataFromAnnotations=function(c){var m=this;var M=c._oModel;var o=M.getMetaModel();var e=o.getODataEntitySet(c.getEntitySet());if(!e){jQuery.sap.log.error("KPI error details - Incorrect entity set");return;}var E=o.getODataEntityType(e.entityType);var q=c.getQualifier();var s,d,S,D;var p={};var k="com.sap.vocabularies.UI.v1.KPI#"+q;var f=E[k];if(f){if(f["DataPoint"]){D=this.getPathOrAnnotationPath(f["DataPoint"],true);}if(f["SelectionVariant"]){S=this.getPathOrAnnotationPath(f["SelectionVariant"],true);}if(f["ShortDescription"]){var g=K.getPrimitiveValue(f["ShortDescription"]);}var h=f.ID;var i=f.Detail&&f.Detail.SemanticObject;var j=f.Detail&&f.Detail.DefaultPresentationVariant;var A=f.Detail&&f.Detail.Action;p.kpiAnnotationPath=k;}else{var l="com.sap.vocabularies.UI.v1.SelectionPresentationVariant#"+q;p.selectionPresentationVariantPath=l;var n=E[l];if(!n){jQuery.sap.log.error("KPI error details - SelectionPresentationVariant does not have Path.");return;}if(n.SelectionVariant){S=this.getPathOrAnnotationPath(n.SelectionVariant);}if(n.PresentationVariant){var P=this.getPathOrAnnotationPath(n.PresentationVariant);}if(!P){jQuery.sap.log.error("KPI error details - PresentationVariant does not have Path.");return;}var r=E[P];var v=r.Visualizations;v.forEach(function(O){if(O.AnnotationPath.indexOf("DataPoint")>0){D=m.getPathOrAnnotationPath(O);}});}if(!D){jQuery.sap.log.error("KPI error details - DataPoint does not have Path.");return;}d=E[D];if(!S){jQuery.sap.log.error("KPI error details - SelectionVariant does not have a path");}s=E[S];p.dataPointPath=D;p.selectionVariantPath=S;var t=d.Value.Path;var u=s&&s.SelectOptions,w=s&&s.Parameters;var x=o.getODataProperty(E,d.Value.Path);var U=K.getUnitofMeasure(M,x);var y=d.Title,z=K.getPrimitiveValue(y);if(z===undefined){z="";}this.kpiConfig={entityTypeProperty:x,props:{title:z,value:t,unitOfMeasure:U},entitySet:e,dataPoint:d,selectionVariant:s,selectOptions:u,parameterS:w,kpiPropertyPath:p};if(f){this.kpiConfig.bIsKpiAnnotaion=true;}if(i&&A&&h){this.kpiConfig.navigation={semanticObject:i.String,action:A.String,kpiId:h.String};}if(f&&!j){this.kpiConfig.oDefaultPV=false;}if(g){this.kpiConfig.props.shortDescription=g;}var B=F.readProperty(d,"Criticality"),G=B&&(B.EnumMember)?K.getPrimitiveValue(B):undefined,H=(B&&B.Path)?this._getCriticalityParameters(B):undefined;if(G){this.kpiConfig.criticality={criticalityType:G};}else if(H){this.kpiConfig.criticality={criticalityPath:H};}else{var I=(!G&&F.readProperty(d,"CriticalityCalculation.ImprovementDirection.EnumMember"))?K.getPrimitiveValue(d.CriticalityCalculation.ImprovementDirection):undefined;if(I){var T=this._getCriticalityParameters(d.CriticalityCalculation.ToleranceRangeLowValue),J=this._getCriticalityParameters(d.CriticalityCalculation.ToleranceRangeHighValue),L=this._getCriticalityParameters(d.CriticalityCalculation.DeviationRangeLowValue),N=this._getCriticalityParameters(d.CriticalityCalculation.DeviationRangeHighValue);this.kpiConfig.criticalityCalculation={improveDirection:I,toleranceLow:T,toleranceHigh:J,deviationLow:L,deviationHigh:N};}}};b.prototype._getCriticalityParameters=function(c){if(c){if(c.Path){return{path:"/"+c.Path};}else{return K.getPrimitiveValue(c);}}};b.prototype.getCriticalityFromEnum=function(c){return C.getCriticalityIndicatorFromEnum(c);};b.prototype.getConfig=function(){return this.kpiConfig;};b.prototype.getImproveDirection=function(d,D,s,c,v){C.setVals(d,D,s,c,v);return(C[this.kpiConfig.criticalityCalculation.improveDirection]());};b.prototype.getPathOrAnnotationPath=function(e,i){var p=i?e.Path:(e.Path||e.AnnotationPath);if(/^@/.test(p)){p=p.slice(1);}return p;};return b;},true);
