sap.ui.define(["sap/ui/core/Control","sap/suite/ui/generic/template/AnalyticalListPage/controller/KpiTagController","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiAnnotationHelper","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/ui/comp/odata/ODataModelUtil","sap/suite/ui/generic/template/AnalyticalListPage/control/KpiTag","sap/suite/ui/generic/template/AnalyticalListPage/control/KpiProvider","sap/ui/Device","sap/ui/generic/app/navigation/service/SelectionVariant","sap/ui/model/Filter","sap/ui/model/json/JSONModel","sap/ui/core/Locale","sap/m/ResponsivePopover","sap/m/Bar","sap/m/Label","sap/m/MessageStrip","sap/ui/core/format/NumberFormat","sap/m/library","sap/ui/core/library"],function(C,K,a,b,F,V,O,c,d,D,S,e,J,L,R,B,f,M,N,g,h){"use strict";var T="Target",k="Maximize",l="Minimize";return c.extend("sap.suite.ui.generic.template.AnalyticalListPage.control.SmartKpiTag",{metadata:{designTime:true,interfaces:["sap.m.IOverflowToolbarContent"],properties:{entitySet:{type:"string",defaultValue:"",bindable:false},qualifier:{type:"string",defaultValue:"",bindable:false},modelName:{type:"string",defaultValue:undefined,bindable:false},groupId:{type:"string",defaultValue:"AlpKpiGroup",bindable:false},smartFilterId:{type:"string",defaultValue:undefined,bindable:false}},events:{beforeRebindFilterableKPI:{}}},renderer:{render:c.render},_isPercent:false,_unScaledValue:"",_sUnitofMeasure:"",_relativeToProperties:[],_bStopDataLoad:true,init:function(){jQuery.sap.log.setLevel(jQuery.sap.log.Level.WARNING,this);},_initCompositeSupport:function(s){a.addToKpiList(s,this);},propagateProperties:function(){C.prototype.propagateProperties.apply(this,arguments);this._initialiseMetadata();},_initialiseMetadata:function(){O.handleModelInit(this,this._onMetaDataInit);},_setDeferredGroups:function(){if(!this._oModel){return;}var i=this._oModel.getDeferredGroups();var G=this.getGroupId();if(i.indexOf(G)<0){i.push(G);this._oModel.setDeferredGroups(i);}},_onMetaDataInit:function(){if(this.getModelName()){this._oModel=this.getModel(this.getModelName());this._setDeferredGroups();this._oModel.getMetaModel().loaded().then(function(){this.kpiProvider=new d(this);if(!this.kpiProvider){this._kpiErrorHandler({},false);this._updateKpiList(true);return;}this.kpiSettings=this.kpiProvider.getConfig();if(!this.kpiSettings){jQuery.sap.log.error("KPI Error details: incorrect KPI configuration");this._updateKpiList(true);return;}var s=this.getSmartFilterId();if(s){if(s&&!this._oSmartFilter){this._oSmartFilter=this._findControl(s);this._oSmartFilter.attachSearch(this._createFilterableKpi,this);this._oSmartFilter.attachFilterChange(function(E){if(!this._oSmartFilter.isLiveMode()&&!this._oSmartFilter.isDialogOpen()){this.setEnabled(false);}}.bind(this));if(this._oSmartFilter.isInitialised()){this._createFilterableKpi();}else{this._oSmartFilter.attachInitialized(this._createFilterableKpi,this);}}}else{this._createGlobalKpi();}}.bind(this));}},_createFilterableKpi:function(){try{this._updateKpiList(false);this.setBusy(true);this.setBusyIndicatorDelay(0);if(this.getEntitySet()===this._oSmartFilter.getEntitySet()){if(!this._checkSearchAllowed()){this._kpiErrorHandler({},true);this._updateKpiList(true);return;}}var m=this.kpiSettings,s=m.selectOptions,p=m.parameters,u=this._oSmartFilter.getUiState(),U=u.getProperty("selectionVariant"),n=U?U.SelectOptions:undefined,o=U?U.Parameters:undefined,q=this._oSmartFilter.getFilterData(true),r=new S(U),t=new S(),v=[],w,P,x,y,z,A,E,G=this._oModel.getMetaModel(),H=G.getODataEntitySet(this.getEntitySet()),I=G.getODataEntityType(H.entityType);if(s){for(var i=0;i<s.length;i++){w=s[i];P=w.PropertyName.PropertyPath;x=r.getSelectOption(P);var Q=G.getODataProperty(I,P),W=Q&&F.isPropertyNonFilterable(H,Q.name);if(W){continue;}if(x){for(var j=0;j<x.length;j++){y=x[j];if(y.Sign==="I"||y.Sign==="E"){if(y.Low!==undefined){z=a.getFilter(y,x,P);t.addSelectOption(z.path,z.sign,z.operator,z.value1,z.value2);}}}}else{if(q&&q[P]===undefined){for(var j=0;j<w["Ranges"].length;j++){y=w["Ranges"][j];if(y.Sign.EnumMember===V.SelectionRangeSignType+"/I"||y.Sign.EnumMember===V.SelectionRangeSignType+"/E"){if(y.Low!==undefined){z=a.getFilter(y,w);t.addSelectOption(z.path,z.sign,z.operator,z.value1,z.value2);}}}}}}}if(p){for(var i=0;i<p.length;i++){A=p[i];P=A.PropertyName&&A.PropertyName.PropertyPath;E=r.getParameter(P)||A.PropertyValue.String;if(q&&q["$Parameter."+P]===undefined){if(P&&E&&(E!=="")){t.addParameter(P,E);}}}}if(o){for(var i=0;i<o.length;i++){A=o[i];P=A.PropertyName;E=A.PropertyValue;if(E!==t.getParameter(P)){if(P&&E&&(E!=="")){var X=b.checkParameterizedEntitySet(this._oModel,H,P);if(X){if(b.checkForDateTimeParameter(this._oModel,this.getEntitySet(),P)){if(E&&!(E.indexOf('Z')===(E.length-1))){E=E.split('T')[0]+"T00:00:00Z";}}t.addParameter(P,E);}}}}}if(n){for(var i=0;i<n.length;i++){var Y=n[i],Z=Y.PropertyName||undefined,Q=G.getODataProperty(I,Z);W=Q&&F.isPropertyNonFilterable(H,Q.name);if(Q&&!W){if(!t.getSelectOption(Z)){for(var j=0;j<Y["Ranges"].length;j++){y=Y["Ranges"][j];if(y.Sign==="I"||y.Sign==="E"){if(y.Low!==undefined){z=a.getFilter(y,Y,Z);if(Q['type']==="Edm.DateTime"&&Q['sap:display-format']==="Date"){if(z.value1&&!(z.value1.indexOf('Z')===(z.value1.length-1))){z.value1=z.value1.split('T')[0]+"T00:00:00Z";}if(z.value2&&!(z.value2.indexOf('Z')===(z.value2.length-1))){z.value2=z.value2.split('T')[0]+"T00:00:00Z";}}t.addSelectOption(z.path,z.sign,z.operator,z.value1,z.value2);}}}}}}}this.fireBeforeRebindFilterableKPI({selectionVariant:t,entityType:H.entityType});var $=t.getSelectOptionsPropertyNames();for(var i=0;i<$.length;i++){w=t.getSelectOption($[i]);for(var j=0;j<w.length;j++){y=w[j];if(y.Sign==="I"||y.Sign==="E"){if(y.Low!==undefined){z=a.getFilter(y,null,$[i]);v.push(new e(z));}}}}this._filterableKPISelectionVariant=t;var _=b.resolveParameterizedEntitySet(this._oModel,m.entitySet,t);this._applyFiltersToKpi.apply(this,[t,v,_]);}catch(a1){this._updateKpiList(true);jQuery.sap.log.error("KPI Error details: "+a1);}},_createGlobalKpi:function(){try{this._updateKpiList(false);this.setBusy(true);this.setBusyIndicatorDelay(0);var m=this.kpiSettings;var s=m.selectOptions,o,r,n=[];if(s){for(var i=0;i<s.length;i++){o=s[i];for(var j=0;j<o["Ranges"].length;j++){r=o["Ranges"][j];if(r.Low){n.push(new e(a.getFilter(r,o)));}}}}var p=b.resolveParameterizedEntitySet(this._oModel,m.entitySet,m.selectionVariant);this._applyFiltersToKpi.apply(this,[m.selectionVariant,n,p]);}catch(E){this._updateKpiList(true);jQuery.sap.log.error("KPI Error details: "+E);}},_applyFiltersToKpi:function(s,i,p){this._relativeToProperties=[];var j=this.kpiSettings;var o=j.dataPoint,m;var G=this.getGroupId();this._getCriticalityRefProperties(o);this._oConfig={path:p,filterable:this.getSmartFilterId()?true:false,properties:{value:j.props.value,valueFormat:j.dataPoint.ValueFormat,title:j.props.title,unitOfMeasure:j.props.unitOfMeasure}};this._oConfig.properties.shortDescription=j.props.shortDescription;this._checkForPercent(this._oConfig.properties.unitOfMeasure);this._checkKpiCriticality();if(this._relativeToProperties.length!==0){m=(this._relativeToProperties.indexOf(this._oConfig.properties.value)===-1)?[this._oConfig.properties.value].concat(this._relativeToProperties).join(","):this._relativeToProperties;}else{m=[this._oConfig.properties.value];}if(this._oConfig){this._oModel.read(this._oConfig.path,{async:true,filters:i,urlParameters:{"$select":m,"$top":1},success:this._kpiSuccessHandler.bind(this),error:this._kpiErrorHandler.bind(this),groupId:G});}if(this.getSmartFilterId()){this._updateKpiList(!this._bStopDataLoad);}else{this._updateKpiList(true);}},_updateKpiList:function(p){Promise.resolve().then(function(){this._updateKpiListAsync(p);}.bind(this));},_updateKpiListAsync:function(p){var G=this.getGroupId();a.updateKpiList(this,p);if(!p){return;}var o=a.getKpiList(this.getModelName(),G);for(var s in o){if(!o[s].bProcessed){return;}}this._oModel.submitChanges({groupId:G});},_checkSearchAllowed:function(){var A=this._oSmartFilter.determineMandatoryFilterItems(),m=this._oSmartFilter.getFiltersWithValues(),I=true,n=0;if(A.length){if(!m.length||(m.length<A.length)){I=false;}else{for(var i=0;i<A.length;i++){for(var j=0;j<m.length;j++){if(m[j].getName()===A[i].getName()){n++;}}}I=(n===A.length);}}if(I){var s=this._oSmartFilter.verifySearchAllowed.apply(this._oSmartFilter,arguments);if(s.hasOwnProperty("error")||s.hasOwnProperty("mandatory")){I=false;}}return I;},_checkKpiCriticality:function(){var i=this.kpiSettings;var o=i.dataPoint;var m;if(i.criticality){if(i.criticality.criticalityPath){m=i.criticality.criticalityPath;this._oConfig.criticality={criticalityPath:i.criticality.criticalityPath};}else if(i.criticality.criticalityType){m=this._getCriticalityFromEnum(i.criticality.criticalityType);this._oConfig.criticality={criticalityType:i.criticality.criticalityType};}}else if(i.criticalityCalculation){var I=i.criticalityCalculation.improveDirection,t=i.criticalityCalculation.toleranceHigh,s=i.criticalityCalculation.toleranceLow,j=i.criticalityCalculation.deviationLow,n=i.criticalityCalculation.deviationHigh;var p=[];if(this.getError()||(this.getSmartFilterId()&&this._checkCriticalityCalculationForNumber(o.CriticalityCalculation,I))){this._mCriticalityIndicator=g.ValueColor.Neutral;}else{p.push(this._getPathForIndicatorParts(t));p.push(this._getPathForIndicatorParts(s));p.push(this._getPathForIndicatorParts(j));p.push(this._getPathForIndicatorParts(n));p.push({path:"/"+i.props.value});m={parts:p,formatter:function(q,r,u,v,w){var x=r?r:s,y=q?q:t,z=u?u:j,A=v?v:n;x=x&&Number(x);y=y&&Number(y);z=z&&Number(z);A=A&&Number(A);w=w&&Number(w);return this._getImproveDirection(x,y,z,A,w);}.bind(this)};this._oConfig.criticalityCalculation={improveDirection:i.criticalityCalculation.improveDirection,toleranceLow:i.criticalityCalculation.toleranceLow,toleranceHigh:i.criticalityCalculation.toleranceHigh,deviationLow:i.criticalityCalculation.deviationLow,deviationHigh:i.criticalityCalculation.deviationHigh};}}this._oConfig.criticalityProps={criticalityIndicator:m,relativeProperties:this._relativeToProperties};},_getCriticalityRefProperties:function(o){var i=o.CriticalityCalculation;var j=o.Criticality;if(j&&j.Path&&this._relativeToProperties.indexOf(j.Path)===-1){this._relativeToProperties.push(j.Path);}else if(i){if(i.DeviationRangeLowValue&&i.DeviationRangeLowValue.Path&&this._relativeToProperties.indexOf(i.DeviationRangeLowValue.Path)===-1){this._relativeToProperties.push(i.DeviationRangeLowValue.Path);}if(i.DeviationRangeHighValue&&i.DeviationRangeHighValue.Path&&this._relativeToProperties.indexOf(i.DeviationRangeHighValue.Path)===-1){this._relativeToProperties.push(i.DeviationRangeHighValue.Path);}if(i.ToleranceRangeLowValue&&i.ToleranceRangeLowValue.Path&&this._relativeToProperties.indexOf(i.ToleranceRangeLowValue.Path)===-1){this._relativeToProperties.push(i.ToleranceRangeLowValue.Path);}if(i.ToleranceRangeHighValue&&i.ToleranceRangeHighValue.Path&&this._relativeToProperties.indexOf(i.ToleranceRangeHighValue.Path)===-1){this._relativeToProperties.push(i.ToleranceRangeHighValue.Path);}}},_kpiSuccessHandler:function(i,r){this.setProperty("error",false);this.setProperty("errorMessage","");if((this.kpiProvider.kpiConfig.bIsKpiAnnotaion&&!this.kpiProvider.kpiConfig.hasOwnProperty("navigation"))||this.kpiProvider.kpiConfig.oDefaultPV===false){this._kpiErrorHandler(r);}try{var o=i.results[0];if(!o){throw"no data";}}catch(E){this.setProperty("errorType",h.MessageType.Warning);var j=this.getModel("i18n").getResourceBundle();this.setProperty('errorMessage',j.getText("KPI_NO_DATA"));jQuery.sap.log.warning("KPI error details: "+j.getText("KPI_NO_DATA")," ",this);return this._kpiErrorHandler(r);}this.setBusy(false);var m=new J();m.setData(o);this.setModel(m);this._setKpiName();this._setKpiValue();if(this._oConfig.properties.unitOfMeasure){(this._oConfig.properties.unitOfMeasure.hasOwnProperty("Path"))?this.bindProperty("unit",{path:"/"+this._oConfig.properties.unitOfMeasure.Path}):this.setProperty("unit",this._oConfig.properties.unitOfMeasure.String||this._oConfig.properties.unitOfMeasure);}this._setKpiIndicator();if(!this.getEnabled()){this.setEnabled(true);}},_kpiErrorHandler:function(r,i){this._resetKpiValue();var o=this.getModel("i18n").getResourceBundle();if(r.statusCode==="401"||r.statusCode==="403"||r.authorizationError){this.setProperty('visible',false);jQuery.sap.log.warning("KPI error details: "+o.getText("KPI_AUTHORIZATION_ISSUE"),"",this);return;}if(this.kpiProvider.kpiConfig.oDefaultPV===false){this.setProperty('visible',false);jQuery.sap.log.warning("KPI error details: "+o.getText("KPI_DEFAULT_PV_ERROR_MESSAGE"),"",this);return;}if(this.kpiProvider.kpiConfig.bIsKpiAnnotaion&&!this.kpiProvider.kpiConfig.hasOwnProperty("navigation")){jQuery.sap.log.warning("KPI error details: "+o.getText("KPI_DRILLDOWN_NAVIGATION_MESSAGE"),"",this);return;}if(i){this.setProperty('errorMessage',o.getText("KPI_MANDATORY_PARAMETER_MESSAGE"));jQuery.sap.log.error("KPI error details: "+o.getText("KPI_MANDATORY_PARAMETER_MESSAGE"));}this.setBusy(false);if(!i&&!this.getProperty("errorMessage")){this.setProperty('errorMessage',o.getText("KPI_GENERIC_ERROR_MESSAGE"));}if(r&&r.statusCode&&r.message){jQuery.sap.log.error("KPI error details: "+r.statusCode+" "+r.message);}this._setKpiName();this._setKpiIndicator();this.setProperty('error',true);if(!this.getEnabled()){this.setEnabled(true);}},_resetKpiValue:function(){this.setValue("");this.setUnit("");this._isPercent=false;this._unScaledValue="";},_setKpiIndicator:function(){if(this._oConfig&&this._oConfig.criticalityProps){var i=this._oConfig.criticalityProps.criticalityIndicator;if(typeof i==="string"){this.setIndicator(i);}else if(typeof i==="object"){this.bindProperty("indicator",i);}}},_setKpiValue:function(){this.bindProperty("value",{path:"/"+this._oConfig.properties.value,formatter:function(v){this._isPercent=this._oConfig.properties.isPercent;this._unScaledValue=N.getFloatInstance({maxFractionDigits:2,groupingEnabled:true,showScale:false},new L(sap.ui.getCore().getConfiguration().getLanguage())).format(v);return this._oConfig.properties.isPercent?a.formatNumberForPresentation(v,this._getNumberOfFractionalDigits(),true):a.formatNumberForPresentation(v,this._getNumberOfFractionalDigits());}.bind(this)});},_checkCriticalityCalculationForNumber:function(i,I){if(I===k){if((i.DeviationRangeLowValue&&!i.DeviationRangeLowValue.Path)||(i.ToleranceRangeLowValue&&!i.ToleranceRangeLowValue.Path)){return true;}}else if(I===l){if((i.DeviationRangeHighValue&&!i.DeviationRangeHighValue.Path)||(i.ToleranceRangeHighValue&&!i.ToleranceRangeHighValue.Path)){return true;}}else if(I===T){if((i.ToleranceRangeLowValue&&!i.ToleranceRangeLowValue.Path)||(i.ToleranceRangeHighValue&&!i.ToleranceRangeHighValue.Path)){return true;}}},_setKpiName:function(){if(!this.kpiSettings||!this.kpiSettings.props||!this.kpiSettings.props.title){return this.setProperty("shortDescription","");}var n=this.kpiSettings.props.title;if(n===undefined||typeof n!=="string"){n="";}var s=this._oConfig&&this._oConfig.properties.shortDescription?this._oConfig.properties.shortDescription:n;if(s){if(s.indexOf(">")>0){this.bindProperty("shortDescription",{path:s,formatter:function(v){return this._getKpiTagTitle(v);}.bind(this)});}else{this.setProperty("shortDescription",this._getKpiTagTitle(s));}}},_getPathForIndicatorParts:function(v){if(Number(v)||!v){return{path:"/dummy"};}return v;},_getKpiTagTitle:function(n){return this.getShortDescription()?this.getShortDescription():this._getNameFromHeuristic(n);},_getCriticalityFromEnum:function(s){return this.kpiProvider.getCriticalityFromEnum(s);},_getNumberOfFractionalDigits:function(){var i=this._oConfig.properties.valueFormat&&this._oConfig.properties.valueFormat.NumberOfFractionalDigits.Int;if(i!=0){i=1;}return i;},_getImproveDirection:function(s,i,j,m,v){return this.kpiProvider.getImproveDirection(s,i,j,m,v);},_onMouseClick:function(E){if(this.kpiSettings){this._displayKpiErrorPopOverOrCard(E);}else{jQuery.sap.log.error("KPI error details - Incorrect KPI configuration. Unable to open card");}},_displayKpiErrorPopOverOrCard:function(E){if(this.getError()){if(this._oPopoverDialog){this._oPopoverDialog.openBy(this);}else{this._oPopoverDialog=this._getResponsivePopOver(this.getErrorMessage());this._oPopoverDialog.openBy(this);}}else{K.openKpiCard(E);}},_getResponsivePopOver:function(t){if(this._oPopoverDialog){return this._oPopoverDialog;}var s=D.system.phone?true:false;var r=new R({showHeader:s,placement:g.PlacementType.Auto,content:[new M({text:t,showIcon:true,type:this.getProperty("errorType")})]}).addStyleClass("sapSmartTemplatesAnalyticalListPageErrorPopOver");r.setShowCloseButton(s);return r;},_onKeyPress:function(E){if(this.kpiSettings&&E.which===jQuery.sap.KeyCodes.ENTER||E.which===jQuery.sap.KeyCodes.SPACE){this._displayKpiErrorPopOverOrCard(E);}else{jQuery.sap.log.error("KPI error details - Incorrect KPI configuration. Unable to open card");}},_checkForPercent:function(u){if(u&&u.hasOwnProperty("String")){this._oConfig.properties.unitOfMeasure=(u.String)?u.String:"";}if(u&&u.hasOwnProperty("Path")&&this._relativeToProperties.indexOf(u.Path)===-1){this._relativeToProperties.push(u.Path);}this._oConfig.properties.isPercent=(u&&u.hasOwnProperty("String"))?(u.String==="%"):false;},_getNameFromHeuristic:function(s){var p=s.split(/\s/);return p.length===1?this._getNameFromSingleWordHeuristic(s):this._getNameFromMultiWordHeuristic(p);},_getNameFromSingleWordHeuristic:function(w){return w.substr(0,3).toUpperCase();},_getNameFromMultiWordHeuristic:function(w){var p=[];p.push(w[0].charAt(0));p.push(w[1].charAt(0));if(w.length>=3){p.push(w[2].charAt(0));}return p.join("").toUpperCase();},getFilterableKPISelectionVariant:function(){return this._filterableKPISelectionVariant;},_findControl:function(i){var r,v;if(i){r=sap.ui.getCore().byId(i);if(!r){v=this._getView();if(v){r=v.byId(i);}}}return r;},_getView:function(){if(!this._oView){var o=this.getParent();while(o){if(o instanceof sap.ui.core.mvc.View){this._oView=o;break;}o=o.getParent();}}return this._oView;},exit:function(){this._relativeToProperties=[];},onAfterRendering:function(){var r=this.getModel("i18n").getResourceBundle(),i=(this._isPercent)?this.getValue()+" "+this.getUnit():this._unScaledValue+" "+this.getUnit(),j;switch(this.getIndicator()){case g.ValueColor.Error:j="KPI_TOOLTIP_ERROR";break;case g.ValueColor.Good:j="KPI_TOOLTIP_GOOD";break;case g.ValueColor.Critical:j="KPI_TOOLTIP_CRITICAL";break;default:j="KPI_TOOLTIP_NEUTRAL";break;}var n;if(this.kpiSettings&&this.kpiSettings.props){n=this.kpiSettings.props.title;}if(n&&n.indexOf(">")>0){this.bindProperty("tooltip",{path:n,formatter:function(v){this._oConfig.properties.title=v;return v+" "+i;}.bind(this)});}else{this.setTooltip(n+" "+i);}this._ariaLabel=r.getText(j,[(this.kpiSettings&&this.kpiSettings.props?this.kpiSettings.props.title:""),i]);setTimeout(function(){this.detachBrowserEvent("click",this._onMouseClick).attachBrowserEvent("click",this._onMouseClick);this.detachBrowserEvent("keypress",this._onKeyPress).attachBrowserEvent("keypress",this._onKeyPress);}.bind(this),1);},getSmartKpiConfig:function(){return this._oConfig;},getOverflowToolbarConfig:function(){return{canOverflow:true};},setShortDescription:function(v){this.setProperty("shortDescription",this._getNameFromHeuristic(v));}});},true);
