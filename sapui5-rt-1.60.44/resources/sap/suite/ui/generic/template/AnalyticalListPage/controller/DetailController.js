sap.ui.define(["sap/ui/base/EventProvider","sap/ui/comp/personalization/Util","sap/ui/table/AnalyticalTable","sap/ui/core/mvc/Controller","sap/ui/model/FilterType","sap/suite/ui/generic/template/AnalyticalListPage/util/FilterUtil","sap/m/Table","sap/ui/model/Sorter","sap/ui/core/format/DateFormat","sap/ui/model/odata/type/Time","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/table/RowSettings","sap/ui/model/FilterOperator","sap/ui/table/library","sap/suite/ui/generic/template/listTemplates/listUtils"],function(E,P,A,C,F,a,R,S,D,T,J,b,c,d,e,l){"use strict";var f=new E();var t=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.DetailController",{setState:function(s){this.oState=s;this._enableExpandByFilter=true;this._enableUpdateExpandLevelInfo=false;var g=this.oState.oSmartTable;var o=this.oState.oController.getOwnerComponent();var h=this.oState.oController.getOwnerComponent().getModel("_templPriv");h.setProperty('/alp/autoHide',o.getAutoHide()?"filter":"highlight");g.attachInitialise(this._onSmartTableInit,this);g.attachBeforeRebindTable(this._onBeforeRebindTable,this);},_onSmartTableInit:function(){var s=this.oState.oSmartTable,g=s.getCustomToolbar(),o=g.getContent(),n;this.oState.oTemplateUtils.oCommonUtils.checkToolbarIntentsSupported(s);if(this.oState._pendingTableToolbarInit){if(!this.oState.oSmartFilterableKPI){g.insertContent(this.oState.alr_viewSwitchButtonOnTable,o.length);}}if(this.oState._pendingTableToolbarInit){for(var i=0;i<o.length;i++){if(o[i].mProperties.text==="Settings"){n=i;}}g.insertContent(this.oState._autoHideToggleBtn,n);}delete this.oState._pendingTableToolbarInit;this.oState.oSmartTable.attachShowOverlay(function(j){this.oState.oSmartTable.getCustomToolbar().setEnabled(!j.getParameter("overlay").show);},this);var h=new J({"highlightMode":"rebindTable"});this.oState.oSmartTable.setModel(h,"_tableHighlight");},_onBindingDataReceived:function(){var g=this.oState.oSmartTable.getTable();if(g instanceof A){this._expandByFilter("bindingDataReceived");}},_onBeforeRebindTable:function(o){var v=this.oState.oSmartTable.fetchVariant(),B=o.getParameter("bindingParams");B.parameters=B.parameters||{};if(this.oState.chartController&&this.oState.chartController.oChart){var g=this.oState.chartController.oChart,h=this.oState.chartController._chartInfo,j=(h.drillStack&&h.drillStack.length>0)?h.drillStack[h.drillStack.length-1]:undefined;}if(!v){return;}var k=this.oState.oController.getOwnerComponent().getModel("_templPriv");var _=k.getProperty('/alp/_ignoreChartSelections');if(this.isFilter()&&this.oState.oSmartChart&&!_){this._applyChartSelectionOnTableAsFilter(o,g);}if(this.isFilter()&&j&&j.filter){o.getParameter("bindingParams").filters.push(j.filter);}var m=[];var n=this.oState.oSmartTable.getTable().getColumns();for(var i=0;i<n.length;i++){var p=n[i];if(p.getGrouped&&p.getGrouped()){m.push(p.getLeadingProperty?p.getLeadingProperty():P.getColumnKey(p));}}this._updateExpandLevelInfo(m);if(this.oState.oController.getOwnerComponent().getModel().getDefaultCountMode()==="None"&&this.oState.oSmartTable._isAnalyticalTable){o.mParameters.bindingParams.parameters.provideTotalResultSize=false;this.oState.oSmartTable.setShowRowCount(false);}var q=this._getValueFromCustomData(this.oState.oSmartTable,"InitialExpansionLevel");if(q){o.mParameters.bindingParams.parameters.numberOfExpandedLevels=parseInt(q,10);}this.oState.oController.onBeforeRebindTableExtension(o);this.oState.oTemplateUtils.oCommonEventHandlers.onBeforeRebindTable(o,{ensureExtensionFields:this.oState.oController.templateBaseExtension.ensureFieldsForSelect,addExtensionFilters:this.oState.oController.templateBaseExtension.addFilters,isAnalyticalListPage:true},this.oState.oSmartFilterbar);this.oState.oSmartTable.getModel("_tableHighlight").setProperty("/highlightMode","rebindTable");this._applyCriticalityInfo(o,this.oState.oSmartTable);l.handleErrorsOnTableOrChart(this.oState.oTemplateUtils,o);},attachTableChange:function(o,g,L){return f.attachEvent("TableChange",o,g,L);},detachTableChange:function(g,L){return f.detachEvent("TableChange",g,L);},isFilter:function(){var o=this.oState.oController.getOwnerComponent().getModel("_templPriv");return o.getProperty("/alp/autoHide")==="filter";},applyParamsToTable:function(){var s=this.oState.chartController,o=s.oChart,v=s._chartInfo.vizSelection;if(o&&v){var g=this.oState.oSmartTable.getModel("_tableHighlight"),h=s._chartInfo.chartSelection,i=s._chartInfo.drillStack.length>0;if(this.isFilter()||(h&&h.count)||g.getProperty("/highlightMode")==="eyeModeSwitch"||i){this.oState.oSmartTable.rebindTable(true);}else{this._applyCriticalityInfo(undefined,this.oState.oSmartTable);g.refresh(true);}}},_getValueFromCustomData:function(s,p){var _=s.getCustomData();for(var i=0;i<_.length;i++){if(_[i].mProperties.key===p){if(p==="lineItemCriticality"){return _[i].mProperties.value&&JSON.parse(_[i].mProperties.value);}else{return _[i].mProperties.value;}}}return"";},_applyCriticalityInfo:function(o,s){var g=s.getTable(),B=[],r=[],m=this,h=this._getValueFromCustomData(s,"lineItemCriticality");var j=this.oState.chartController&&this.oState.chartController.oChart;if(j){var p=this._getSelParamsFromChart(j);if(p&&p.length>0){p.forEach(function(i){if(i){var K=Object.keys(i);if(K){K.forEach(function(u){if(u!=="__metadata"&&r.indexOf(u)<0){B.push({path:u});r.push(u);}});}}});}this._setParamMap(j);}var k=h&&h.Path;if(k){B.push({path:k});if(o&&o.mParameters){o.mParameters.bindingParams.parameters.select.indexOf(k)===-1?o.mParameters.bindingParams.parameters.select+=","+k:"";}}else if(h&&h.EnumMember){B.push({path:"EnumMember"});}m.isFilterMode=this.isFilter();m.isResponsive=g instanceof R;if(!m.isFilterMode&&s.getModel("_tableHighlight").getProperty("/highlightMode")!=="eyeModeSwitch"){B.push({path:"_tableHighlight>/highlightMode"});}if(B&&B.length>0){var n=function(){var u=m._paramMap,_=m.isFilterMode;var v=m.isResponsive?this:this._getRow();if(!v){return;}if(v.getBindingContext()){var w;var x=this.getBindingContext();if(u&&!jQuery.isEmptyObject(u)){for(var y in u){if(!x.getObject(y)){continue;}for(var i=0;i<u[y].length;i++){if(u[y][i]===x.getObject(y)){w=true;break;}else{w=false;}}}}else{w=false;}m._applyCSSHighlight(v,_,w);if(k){var z=x.getObject(k);switch(z&&z.toString()){case"0":return"None";case"1":return"Error";case"2":return"Warning";case"3":return"Success";default:return"None";}}else if(h&&h.EnumMember){switch(h.EnumMember){case"com.sap.vocabularies.UI.v1.CriticalityType/Neutral":return"None";case"com.sap.vocabularies.UI.v1.CriticalityType/Negative":return"Error";case"com.sap.vocabularies.UI.v1.CriticalityType/Critical":return"Warning";case"com.sap.vocabularies.UI.v1.CriticalityType/Positive":return"Success";default:return"None";}}else{return"None";}}else{m._applyCSSHighlight(v,_,false);return"None";}};if(m.isResponsive){this.oState.alp_ColumnListItem.bindProperty("highlight",{parts:B,formatter:n});}else{var q=new c({highlight:{parts:B,formatter:n}});g.setRowSettingsTemplate(q);}}else{if(m.isResponsive){this.oState.alp_ColumnListItem.bindProperty("highlight",{path:"{_tableHighlight>/highlightMode}",formatter:function(){var _=m.isResponsive?this:this._getRow();if(!_){return;}m._applyCSSHighlight(_,false,false);return"None";}});}else{var q=new c({highlight:{path:"{_tableHighlight>/highlightMode}",formatter:function(){return"None";}}});g.setRowSettingsTemplate(q);}}},_applyCSSHighlight:function(r,i,g){if(g===undefined){return;}var h=r.getDomRefs?r.getDomRefs(true):r.getDomRef();if(h&&h.row){h.row.toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(i&&g)?i:g);}else{r.toggleStyleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(i&&g)?i:g);}},_getBindingProperty:function(g,n){if(g.getProperty){return g.getProperty(n);}else{var p=g.oEntityType.property;for(var i=0;i<p.length;i++){if(p[i].name==n){return p[i];}}return null;}},_getPageFilters:function(B){var p=this.oState.oSmartFilterbar.getFilters();for(var i=0;i<p.length;i++){if(p[i].aFilters!==undefined){var g=p[i].aFilters;for(var j=0;j<g.length;j++){var h=g[j];var n=h.sPath;if(!B.getProperty(n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}h.sPath=n;}}else{var h=p[i];var n=h.sPath;if(!B.getProperty(n)){jQuery.sap.log.warning("Could not apply filter with name \""+n+"\" as that field does not exist in the entity type");continue;}h.sPath=n;}}return p;},_applyParamsToTableAsHighlight:function(u){if(!this.oState){return;}var g=this.oState.chartController.oChart;if(!g){return;}var p=this._getSelParamsFromChart(g);var h=g.getVisibleDimensions();var j=this.oState.oSmartChart._lastSelected;var k=this.oState.oSmartTable.getTable();var m=this._getTableBinding(k);var n=this.oState.chartController._chartInfo.drillStack;if(!m){jQuery.sap.log.error("No table binding to apply the selection(s) to");return;}var o=[];for(var i=0;i<p.length;i++){var q=p[i];var r={};for(var s in q){if(h.indexOf(s)==-1||!this._getBindingProperty(m,s)){continue;}r[s]=q[s];}o.push(r);}n.forEach(function(v){var s=v.sPath,w={};w[s]=v.oValue1;o.push(w);});var r={};o.forEach(function(v){for(var w in v){if(!r.hasOwnProperty(w)){r[w]=[v[w]];}else{r[w].push(v[w]);}}});this._paramListFiltered=o;this._lastSelected=j;this._paramMap=r;this._updateRows(u);},_setParamMap:function(g){var p=this._getSelParamsFromChart(g);var h=g.getVisibleDimensions();var i=this.oState.chartController._chartInfo.drillStack;var j={};if(!this.oState.oController.getOwnerComponent().getModel("_templPriv").getProperty('/alp/_ignoreChartSelections')){p.forEach(function(o){for(var k in o){if(h.indexOf(k)==-1){continue;}if(!j.hasOwnProperty(k)){j[k]=[o[k]];}else{j[k].push(o[k]);}}});}i.forEach(function(o){if(!j.hasOwnProperty(o.sPath)){j[o.sPath]=[o.oValue1];}else{j[o.sPath].indexOf(o.oValue1)===-1?j[o.sPath].push(o.oValue1):"";}});this._paramMap=j;},_expandByFilter:function(u){if(!this._enableExpandByFilter){return;}var g=this.oState.oSmartTable.getTable();var h=this._getTableBinding(g);if(h&&this._lastBinding!=h){var m=this;h.attachDataReceived(this._onBindingDataReceived,this);h.attachEvent("change",function(o){if(m._expandingProgrammatically){return;}var p=o.getParameter("reason");if(p=="expand"||p=="collapse"){m._inUserChartSelectMode=false;}});this._lastBinding=h;}if(u=="selection"||u=="bindingDataReceived"){this._firstVisibleRelevantEventTS=new Date().getTime();}if(u=="selection"){this._inUserChartSelectMode=true;}if(!this._inUserChartSelectMode){return;}var r=this._getTableRows();for(var i=0;i<r.length;i++){var j=r[i];var k=j.getBindingContext();if(!k){continue;}var n=g.getFirstVisibleRow()+i;if(this._isRowHighlighted(k.getObject())){if(g.isExpanded(n)){continue;}if(!j._bHasChildren){continue;}if(!h.findNode(n)){continue;}this._expandingProgrammatically=true;g.expand(n);this._expandingProgrammatically=false;}else{if(!g.isExpanded(n)){continue;}if(!j._bHasChildren){continue;}if(!h.findNode(n)){continue;}this._expandingProgrammatically=true;g.collapse(n);this._expandingProgrammatically=false;}}this._updateFirstVisibleRow(u);},_updateFirstVisibleRow:function(u){var g=this.oState.oSmartTable.getTable();var h=this._getTableBinding(g);var j=h.getTotalSize();if(j==0||(new Date().getTime()-this._firstVisibleRelevantEventTS)>250){return;}var g=this.oState.oSmartTable.getTable();if(u=="selection"&&(!this._paramListFiltered||this._paramListFiltered.length==0)){g.setFirstVisibleRow(0);return;}var k=h.getContexts(0,j);for(var i=0;i<k.length;i++){var r=k[i].getObject();if(!this._isRowHighlighted(r)){continue;}if(this._lastSelected&&!this._rowMatch(this._lastSelected,r)){continue;}var m=g.getFirstVisibleRow();if(u=="selection"||this.isFilter()){g.setFirstVisibleRow(i);}else{if(i>m){g.setFirstVisibleRow(i);}}break;}},_rowMatch:function(s,r){for(var n in s){if(n.indexOf("__")!=-1){continue;}if(!r.hasOwnProperty(n)){continue;}if(s[n]!=r[n]){return false;}}return true;},_updateExpandLevelInfo:function(g){if(!this._enableUpdateExpandLevelInfo){return false;}var o=this.oState.oSmartTable.getTable();if(!o.getNumberOfExpandedLevels){return false;}var B=o.getBinding();if(!B){return false;}var h=g.length;var L=false;if(h>=B.aMaxAggregationLevel.length){L=true;h=B.aMaxAggregationLevel.length-1;this.wasAtMaxLevel=true;}else{L=o.getNumberOfExpandedLevels()!=h||this.wasAtMaxLevel;this.wasAtMaxLevel=false;}if(L){if(h>=0){o.setNumberOfExpandedLevels(h);o.bindRows(o.getBindingInfo("rows"));}var i=o.getGroupedColumns();o.fireGroup({column:i[0],groupedColumns:i,type:e.GroupEventType.group});}return L;},_updateRows:function(u){var g=this.oState.oSmartTable.getTable();if(g instanceof A){this._expandByFilter(u);}},_getTableRows:function(){var g=this.oState.oSmartTable.getTable();if(g.getRows){return g.getRows();}else{return g.getItems();}},_isRowHighlighted:function(r){var p=this._paramMap;if(!p||jQuery.isEmptyObject(p)){return false;}var m=true;for(var n in p){if(!r.hasOwnProperty(n)){continue;}if(p[n].indexOf(r[n])==-1){m=false;}}return m;},_getTableBinding:function(g){return g.getBinding()?g.getBinding():g.getBinding("items");},_applyChartSelectionOnTableAsFilter:function(o,g){var h=[];if(!g){return;}var p=this._getSelParamsFromChart(g);if(p.length>0){var k=g.getVisibleDimensions();for(var i=0;i<p.length;i++){var m=p[i],n=[];for(var q in m){if(k.indexOf(q)==-1){jQuery.sap.log.warning("Could not apply filter with name \""+q+"\" as that field does not exist in the entity type");continue;}var r=false;var s=o.mParameters.bindingParams.filters;if(s.length>0){var s=s[0].aFilters?s[0].aFilters:s;for(var j=0;j<s.length;j++){var u=s[j].aFilters?s[j].aFilters:s;if(u.length==1){if(u[0].sPath===q&&u[0].oValue1===m[q]){r=true;}}}}if(!r){n.push(new b({path:q,operator:d.EQ,value1:m[q]}));}}if(n.length>0){h.push(new b(n,true));}}if(h.length>0){o.mParameters.bindingParams.filters.push(new b(h,false));}}},_latestUpdateRow:function(p){var g=this.isFilter();var r=this._getTableRows();var h=false;for(var i=0;i<r.length;i++){var j=r[i];if(!g){if(j.getBindingContext()){var k=j.getBindingContext().getObject();h=this._isRowHighlighted(k);}}var m=j.getDomRefs?j.getDomRefs(true):j.getDomRef();if(!m){continue;}if(m.row){m.row.toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(g&&p)?g:h);}else{$(m).toggleClass("sapSmartTemplatesAnalyticalListPageRowHighlighted",(g&&p)?g:h);}}},_getSelParamsFromChart:function(g){var h=[];var o=this.oState.chartController._chartInfo;if(o.vizSelection){h=o.chartSelection.dataPoints;}return this._getSelParamsFromDPList(h);},_getSelParamsFromDPList:function(g){if(!g){return[];}var p=[];for(var i=0;i<g.length;i++){var h=g[i];var k=h.context;if(!k){if(h.dimensions){p.push(h.dimensions);}continue;}var m=k.getProperty(k.sPath);var n={};if(this._selectFilterByMeasure){for(var j=0;j<h.measures.length;j++){var o=h.measures[j];var v=m[o];n[o]=v;}}else{for(var o in m){n[o]=m[o];}}p.push(n);}return p;}});return t;});
