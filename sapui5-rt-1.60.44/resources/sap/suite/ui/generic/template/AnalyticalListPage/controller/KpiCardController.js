sap.ui.define(["jquery.sap.global","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/thirdparty/d3","sap/suite/ui/generic/template/AnalyticalListPage/util/KpiUtil","sap/suite/ui/generic/template/AnalyticalListPage/util/V4Terms","sap/ui/generic/app/navigation/service/SelectionVariant","sap/m/MessageBox"],function(q,F,C,J,D,K,V,S,M){"use strict";var n,s,o,a;var c=C.extend("sap.suite.ui.generic.template.AnalyticalListPage.controller.KpiCardController",{onInit:function(e){sap.ui.require(["sap/ovp/cards/CommonUtils"],function(O){o=O;});},onExit:function(){},onBeforeRendering:function(){var v=this.getView();var b=v.data("qualifierSettings");var Q=b.qualifier;var m=v.getModel();var d=m.getMetaModel();var e=d.getODataEntitySet(b.entitySet);var E=d.getODataEntityType(e.entityType);var f=v.data("mergedSelectionVariant");var k=v.data("kpiAnnotationPath");var g=v.data("selectionPresentationVariantPath");var h=v.data("dataPointPath");var i="kpiCard"+Q;var j={"cards":{}};j["cards"][i]={"model":b.model,"template":"sap.ovp.cards.charts.analytical","settings":{"title":v.data("kpiTitle"),"entitySet":b.entitySet,"showFilterInHeader":true,"navigation":"chartNav"}};if(k){j["cards"][i].settings.kpiAnnotationPath=k;}else{j["cards"][i].settings.dataPointAnnotationPath=h;j["cards"][i].settings.selectionPresentationAnnotationPath=g;}if(E[h]&&E[h].hasOwnProperty("Description")){j["cards"][i]["settings"].subTitle=E[h]["Description"].String;}o.createCardComponent(v,j,"template::ALPcardContainer",f);o.onHeaderClicked=function(l){this.handleNavigationPress(v);}.bind(this);o.onContentClicked=function(l){var p=l.getObject();this.handleNavigationPress(v,p);}.bind(this);},handleNavigationPress:function(v,b){var N=v.getModel("detailNavigation");if(N){var t=N.getProperty("/target");var A=N.getProperty("/action");var p=v.getParent();p.setModal(true);if(t&&A){if(!n){n=s.getNavigationHandler();}var O={semanticObject:t,action:A};this._oSelectionVariant=new S();var d=JSON.parse(N.getProperty("/parameters"));this._createNavigationContext(d,true);this._getSelectOptionsFromAnnotation(v);if(b){this._createNavigationContext(b);}a.adaptNavigationParameterExtension(this._oSelectionVariant,O);this._oSelectionVariant=this._oSelectionVariant.toJSONString();n.navigate(t,A,this._oSelectionVariant,null,function(e){if(e instanceof sap.ui.generic.app.navigation.service.NavError){if(e.getErrorCode()==="NavigationHandler.isIntentSupported.notSupported"){sap.m.MessageBox.show(s.getText("ST_NAV_ERROR_NOT_AUTHORIZED_DESC"),{title:s.getText("ST_GENERIC_ERROR_TITLE"),onClose:function(){p.setModal(false);}});}else{M.show(e.getErrorCode(),{title:s.getText("ST_GENERIC_ERROR_TITLE"),onClose:function(){p.setModal(false);}});}}});}}},_assignSmartTemplateDependencies:function(b,d){s=b;a=d;n=s.getNavigationHandler();},_createNavigationContext:function(p,I){var k=Object.keys(p);for(var i=0;i<k.length;i++){var e=k[i];if(!p[e]&&p[e]!==""){return;}if(I){this._oSelectionVariant.addParameter(e,p[e]);}else{if(this._oSelectionVariant.getSelectOption(e)){this._oSelectionVariant.removeSelectOption(e);}this._oSelectionVariant.addSelectOption(e,"I","EQ",p[e]);}}},_getSelectOptionsFromAnnotation:function(v){var t=this;var I=v.data("qualifierSettings").filterable;if(I){var m=v.data("mergedSelectionVariant");var p=this._oSelectionVariant.getParameterNames();if(p){for(var i=0;i<p.length;i++){if(!m.getParameter(p[i])){m.addParameter(p[i],this._oSelectionVariant.getParameter(p[i]));}}}this._oSelectionVariant=m;return;}var b=v.data("selectionVariant");var d=b.SelectOptions;var e=b.Parameters;if(e&&e.length){e.forEach(function(P){var f=P.PropertyName.PropertyPath;var g=P.PropertyValue.String;if(t._oSelectionVariant.getParameter(f)){t._oSelectionVariant.removeParameter(f);}t._oSelectionVariant.addParameter(f,g);});}if(d&&d.length){d.forEach(function(f){var P=f.PropertyName.PropertyPath;var r=f.Ranges;r.forEach(function(R){var l=R.Low.String;var h=(R.High&&R.High.String)?R.High.String:null;var g=R.Sign.EnumMember.split("/")[1];var O=R.Option.EnumMember.split("/")[1];t._oSelectionVariant.addSelectOption(P,g,O,l,h);});});}}});return c;});
