/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2016 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/rules/ui/library","sap/ui/core/Control","sap/ui/layout/form/SimpleForm","sap/m/Label","sap/m/Switch","sap/m/Select","sap/m/MessageBox","sap/m/Table","sap/m/Column","sap/m/Text","sap/m/Input","sap/m/Button","sap/m/ComboBox","sap/rules/ui/ExpressionAdvanced","sap/ui/layout/VerticalLayout","sap/rules/ui/type/Expression","sap/rules/ui/ast/lib/AstYamlConverter","sap/rules/ui/Constants"],function(q,l,C,S,L,a,b,M,T,c,d,I,B,f,E,V,g,A,h){"use strict";var t=C.extend("sap.rules.ui.TextRuleSettings",{metadata:{library:"sap.rules.ui",properties:{modelName:{type:"string",defaultValue:""},newTextRule:{type:"boolean",defaultValue:false}},aggregations:{mainLayout:{type:"sap.ui.layout.form.SimpleForm",multiple:false}},defaultAggregation:"mainLayout",associations:{expressionLanguage:{type:"sap.rules.ui.services.ExpressionLanguage",multiple:false,singularName:"expressionLanguage"}}}});sap.rules.ui.TextRuleSettings.prototype._bindPredefinedTable=function(p,k){var e=this;this.oPredefinedTable.destroyItems();var m=this.getModel("oDataModel");var o=sap.ui.getCore().byId(this.getExpressionLanguage());var v=new sap.ui.model.odata.v2.ODataModel(o.getModel().sServiceUrl);var s;var H;var j;var n=function(u){if(u&&u.length>0){e.oPredefinedTable.setBusy(true);for(var i=0;i<u.length;i++){if(k==="/TextRuleResults"){H={RuleId:u[i].RuleId,Id:u[i].Id,RuleVersion:u[i].RuleVersion};s=m.createKey(k,H);j=new sap.ui.model.Context(m,s);}else{H={DataObjectId:u[i].DataObjectId,Id:u[i].Id,VocabularyId:u[i].VocabularyId};s=v.createKey(k,H);j=new sap.ui.model.Context(v,s);}e.oPredefinedTable.addItem(e._predefinedFactory("col-"+i,j));}e.oPredefinedTable.setBusy(false);e._internalModel.setProperty("/refreshButtonClicked",false);}};if(k==="/TextRuleResults"){var r=this.getModel("TextRuleModel").getProperty("/textRuleResults");n(r);}else{v.read(p,{urlParameters:{"$expand":"Attributes"},success:function(i){n(i.Attributes.results);},error:function(i){M.error(i.responseText,{title:this.oBundle.getText("ERROR_DIALOG"),actions:[sap.m.MessageBox.Action.OK]});}});}};sap.rules.ui.TextRuleSettings.prototype._callRefreshResultsFunctionImport=function(){var i=this;var o=this.getModel("oDataModel");var m=this.getModel("TextRuleModel").getData();var j={groupId:"changes"};o.setDeferredGroups([j.groupId]);var s=function(){i._createPredefinedTable();i._internalModel.setProperty("/needToRefresh",false);};var k=function(e){sap.m.MessageToast.show(e);};var n=function(){var r=m.ruleId;o.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:j.groupId,urlParameters:{RuleId:r}});o.submitChanges({groupId:j.groupId,success:s,error:k});};if(this._internalModel.getProperty("/needToRefresh")){n();}};sap.rules.ui.TextRuleSettings.prototype._createInfoMessageStrip=function(e,i){var m=new sap.m.MessageStrip({visible:true,id:i,text:e,type:sap.ui.core.MessageType.Information,showIcon:true,showCloseButton:true}).addStyleClass("sapTextRuleSettingsMessageStrip");return m;};sap.rules.ui.TextRuleSettings.prototype._createLayout=function(){if(!this.oForm){this._destroyElements();this.oForm=new S("_formLayout",{editable:true,layout:"ResponsiveGridLayout",maxContainerCols:1,columnsL:1,columnsM:1,labelSpanM:1,content:[new L({text:this.oBundle.getText("output")}).setTooltip(this.oBundle.getText("output")),new sap.ui.layout.HorizontalLayout({content:[new b("__resultSelect",{width:"220px",items:{path:"settingModel>/results/resultsEnumeration",template:new sap.ui.core.Item({key:"{settingModel>id}",text:"{settingModel>name}"})},selectedKey:"{/ResultDataObjectId}",change:function(e){var D=this.getParent();var o=D.getButtons()[0];o.setEnabled(true);var s=e.getSource();var m=this.getModel().getData();if(m.ResultDataObjectStatus!=="C"){m.ResultDataObjectId=s.getSelectedKey();m.ResultDataObjectName=s._getSelectedItemText();m.ResultDataObjectStatus="U";if(m.ResultDataObjectId!==s.getSelectedKey()){this._updateRefreshFlags(false,false);}}this._internalModel.setProperty("/resultDataObjectChanged",true);if(this._internalModel.getProperty("/results/resultsEnumeration/0").id==="0"){this._internalModel.getProperty("/results/resultsEnumeration").splice(0,1);}this._createPredefinedTable();}.bind(this)}),this._createRefreshButton()]}),new L(),this._createVerticalLayout()]}).addStyleClass("sapTextRuleSettingsForm");}this.oForm.setBusyIndicatorDelay(0);return this.oForm;};sap.rules.ui.TextRuleSettings.prototype._createPredefinedTable=function(){if(!this.oPredefinedTable){this.oPredefinedTable=new T("idPredefinedTable",{backgroundDesign:sap.m.BackgroundDesign.Solid,showSeparators:sap.m.ListSeparators.All,swipeDirection:sap.m.SwipeDirection.Both,layoutData:new sap.ui.layout.form.GridContainerData({halfGrid:false}),columns:[new c({width:"45%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedResultColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new c({width:"25%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedAccessColumnHeaderText"),design:sap.m.LabelDesign.Bold})}),new c({width:"45%",header:new sap.m.Label({text:this.oBundle.getText("PredefinedValuesColumnHeaderText"),design:sap.m.LabelDesign.Bold})})]});}var r=this._internalModel.getProperty("/resultDataObjectChanged");var R=this._internalModel.getProperty("/refreshButtonClicked");var m=this.getModel("oDataModel");if(!r&&!R){this.oPredefinedTable.setModel(m);var e=[this.getModel("TextRuleModel").getProperty("/ruleBindingPath"),"/TextRule/TextRuleResults"].join("");this._bindPredefinedTable(e,"/TextRuleResults");this.oPredefinedTable.setBusyIndicatorDelay(0);return this.oPredefinedTable;}else{this._updatePredefinedTable(this.getModel().getData());}return null;};sap.rules.ui.TextRuleSettings.prototype._createRefreshButton=function(){var _=function(){this._internalModel.setProperty("/refreshButtonEnabled",true,null,true);return this.oBundle.getText("textRuleRefreshWarning");}.bind(this);var e=function(){this._updateRefreshFlags(true,false);}.bind(this);var i=_();var j=function(){var k=i;M.warning(k,{title:this.oBundle.getText("refeshResultWarningTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:function(o){if(o===sap.m.MessageBox.Action.OK){e();}}});}.bind(this);var r=new B({layoutData:new sap.ui.layout.ResponsiveFlowLayoutData({weight:1}),icon:sap.ui.core.IconPool.getIconURI("synchronize"),width:"3rem",type:sap.m.ButtonType.Transparent,text:"",press:j,visible:true,enabled:"{settingModel>/refreshButtonEnabled}"}).setTooltip(this.oBundle.getText("refreshBtn"));this.refreshButton=r;return r;};sap.rules.ui.TextRuleSettings.prototype._createVerticalLayout=function(){var v=new sap.ui.layout.VerticalLayout("verticalLayout",{content:[this._createInfoMessageStrip(this.oBundle.getText("TRPredefinedMessageStripHiddenAccessInfoText"),"id_HiddenAccessMessageStrip"),this._createInfoMessageStrip(this.oBundle.getText("TRPredefinedMessageStripEditableAccessInfoText"),"id_EditableAccessMessageStrip"),this._createPredefinedTable()]});return v;};sap.rules.ui.TextRuleSettings.prototype._destroyElements=function(){if(sap.ui.getCore().byId("_formLayout")){sap.ui.getCore().byId("_formLayout").destroy();}if(sap.ui.getCore().byId("__elseCheckBox")){sap.ui.getCore().byId("__elseCheckBox").destroy();}if(sap.ui.getCore().byId("__resultSelect")){sap.ui.getCore().byId("__resultSelect").destroy();}if(sap.ui.getCore().byId("id_HiddenAccessMessageStrip")){sap.ui.getCore().byId("id_HiddenAccessMessageStrip").destroy();}if(sap.ui.getCore().byId("id_EditableAccessMessageStrip")){sap.ui.getCore().byId("id_EditableAccessMessageStrip").destroy();}if(sap.ui.getCore().byId("idPredefinedTable")){sap.ui.getCore().byId("idPredefinedTable").destroy();}};sap.rules.ui.TextRuleSettings.prototype._getAccessOptions=function(){var o={accessEnumration:[{key:h.KEY_EDITABLE,value:h.EDITABLE},{key:h.KEY_HIDDEN,value:h.HIDDEN}]};return o;};sap.rules.ui.TextRuleSettings.prototype._getCurrentResult=function(){var m=this.getModel().getData();var e=this.getModel("TextRuleModel").getData();var H={Id:e.ruleId,Version:e.ruleVersion};var D=this.getModel("oDataModel");var p=D.createKey("/Rules",H);m.ResultDataObjectId=D.getProperty(p+"/ResultDataObjectId");m.ResultDataObjectName=D.getProperty(p+"/ResultDataObjectName");m.ResultDataObjectStatus="A";if(this._internalModel.getProperty("/results/resultsEnumeration/0").id==="0"){this._internalModel.getProperty("/results/resultsEnumeration").splice(0,1);}};sap.rules.ui.TextRuleSettings.prototype._getPredefinedExpressionAdvanced=function(o,i,j,k,m){var n=sap.ui.getCore().byId(this.getExpressionLanguage());var s=k?k:sap.rules.ui.ExpressionType.NonComparison;var p=this;return new E({expressionLanguage:n,placeholder:this.oBundle.getText("expressionPlaceHolder"),validateOnLoad:true,id:i,type:s,value:j,editable:true,attributeInfo:m,change:function(r){var u=r.getSource();var R=p._getConvertedExpression(u.getValue(),true,o);var v="";if(R&&R!==""){var w=R.output.decisionTableData.DecisionTable.DecisionTableColumns.results["0"].Condition.parserResults;if(w&&w.status!=="Error"){p._astUtils.Id=0;var P=o.getPath();var x=w.converted.ASTOutput;try{v=JSON.stringify(p._astUtils.parseConditionStatement(x));var y=o.oModel.oMetadata.mEntityTypes["/TextRuleConditions"].property;var z=0;if(y){for(var D=0;D<y.length;D++){if(y[D].name==="AST"){z=y[D].maxLength;}}if(v&&v.length>z){p._updateModelExpressionModelAst(P,o,v);}}}catch(e){console.log("Exception while converting ast for expression"+u.getValue()+" :"+e.message);}}}this._internalModel.setProperty("/resultAttributeChanged",true);this._updateResultAttributeJSON(o,false,null,u.getValue(),v);}.bind(this)}).setBindingContext(o);};sap.rules.ui.TextRuleSettings.prototype._getConvertedExpression=function(e,i,o){var j=sap.ui.getCore().byId(this.getExpressionLanguage());var r=this._formRuleData(o,e);var R;if(i){R=j.convertRuleToCodeValues(r);}else{R=j.convertRuleToDisplayValues(r);}return R;};sap.rules.ui.TextRuleSettings.prototype._formRuleData=function(o,e){var r=o.getProperty("RuleId");var v=o.getProperty("Version");var R=q.extend({},this.getModel().oData);if(!R){R={};}if(!R.DecisionTable){R.DecisionTable={};}R.Type="DT";R.DecisionTable.metadata={};R.DecisionTable.RuleID=r;R.DecisionTable.version=v;R.DecisionTable.HitPolicy="FM";R.DecisionTable.DecisionTableColumns={};R.DecisionTable.DecisionTableColumns.results=[];R.DecisionTable.DecisionTableColumns.results.push({"metadata":{},"RuleId":r,"Id":1,"Version":v,"Sequence":1,"Type":"CONDITION","Condition":{"metadata":{},"RuleId":r,"Id":1,"Version":v,"Expression":e,"Description":null,"ValueOnly":false,"FixedOperator":null},"Result":null});R.DecisionTable.DecisionTableRows={};R.DecisionTable.DecisionTableRows.results=[];R.DecisionTable.DecisionTableColumnsCondition={};R.DecisionTable.DecisionTableColumnsCondition.results=[];R.DecisionTable.DecisionTableColumnsResult={};R.DecisionTable.DecisionTableColumnsResult.results=[];return R;};sap.rules.ui.TextRuleSettings.prototype._getSelectedVisibilityStatus=function(s){if(s===h.HIDDEN){return h.KEY_HIDDEN;}else{return h.KEY_EDITABLE;}};sap.rules.ui.TextRuleSettings.prototype._initSettingsModel=function(r){var i={};i.predefinedResults=[];i.results=r;i.accessOptions=this._getAccessOptions();this._internalModel=new sap.ui.model.json.JSONModel(i);this.setModel(this._internalModel,"settingModel");};sap.rules.ui.TextRuleSettings.prototype._getResultsData=function(e){var o=sap.ui.getCore().byId(this.getExpressionLanguage());var r={resultsEnumeration:o.getResults()};r.resultsEnumeration.unshift({id:"0",name:""});this._initSettingsModel(r);if(e){this._setDefaultResult();}else{this._getCurrentResult();}if(this.needCreateLayout){var i=this.getAggregation("mainLayout");if(i){i.destroy();}i=this._createLayout();this.setAggregation("mainLayout",i);this.needCreateLayout=false;}};sap.rules.ui.TextRuleSettings.prototype._setDefaultResult=function(){var m=this.getModel().getData();var r=this._internalModel.getProperty("/results/resultsEnumeration");if(r.length>0){m.ResultDataObjectId=r[0].Id;m.ResultDataObjectName=r[0].Name;m.ResultDataObjectStatus="A";}var D=this.getParent();var o=D.getButtons()[0];o.setEnabled(false);};sap.rules.ui.TextRuleSettings.prototype._setColumnAccessMode=function(o,e){var s=e.getSource();var i="exp"+e.getSource().sId.split("select")[1];var j=sap.ui.getCore().byId(i);var k=s.getSelectedKey();if(k===h.KEY_HIDDEN){j.setValue("");j.setValueStateText(this.oBundle.getText("PredefinedResultsValueStateText"));this._updateResultAttributeJSON(o,false,h.HIDDEN,null,null);}else{j.setValueStateText("");this._updateResultAttributeJSON(o,false,h.EDITABLE,null,null);}this._internalModel.setProperty("/resultAttributeChanged",true);};sap.rules.ui.TextRuleSettings.prototype._predefinedFactory=function(i,o){var e=i.split("-")[1];var j="exp"+e;var k=o.getProperty("DataObjectAttributeName")?o.getProperty("DataObjectAttributeName"):o.getProperty("Name");var m=o.getProperty("DataObjectAttributeId")?o.getProperty("DataObjectAttributeId"):o.getProperty("Id");var n;var p;var r=o.getProperty("BusinessDataType");var s;var u=this._internalModel.getProperty("/predefinedResults");if(this._internalModel.getProperty("/resultDataObjectChanged")){this._updateResultAttributeJSON(o,true,h.EDITABLE,"","");s=h.EDITABLE;n="";p="";}else if(this._internalModel.getProperty("/refreshButtonClicked")){var v=u[m];s=v?v.AccessMode:h.EDITABLE;n=v?v.Expression:"";p=v?v.AST:"";this._updateResultAttributeJSON(o,false,s,n,p);}else{n=o.getProperty("Expression");p=o.getProperty("AST");s=o.getProperty("AccessMode");this._updateResultAttributeJSON(o,false,s,n,p);}var w=this._getSelectedVisibilityStatus(s);return new sap.m.ColumnListItem({visible:true,cells:[new sap.m.Label({visible:true,design:sap.m.LabelDesign.Standard,text:k,textAlign:sap.ui.core.TextAlign.Begin,textDirection:sap.ui.core.TextDirection.Inherit}).setBindingContext(o),new sap.m.Select({width:"65%",id:"select"+e,items:{path:"settingModel>/accessOptions/accessEnumration",template:new sap.ui.core.Item({key:"{settingModel>key}",text:"{settingModel>value}"})},selectedKey:w,change:function(x){this._setColumnAccessMode(o,x);}.bind(this)}).setBindingContext(o),this._getPredefinedExpressionAdvanced(o,j,n,r,m)]});};sap.rules.ui.TextRuleSettings.prototype._updatePredefinedTable=function(r){if(this._internalModel.getProperty("/resultDataObjectChanged")){this._internalModel.setProperty("/predefinedResults",[]);}var D=this.getModel("oDataModel");var e=this.getModel("TextRuleModel").getData();var s="/DataObjects(VocabularyId='"+e.projectId+"',Id='"+r.ResultDataObjectId+"')";this.oPredefinedTable.setModel(D);this._bindPredefinedTable(s,"/Attributes");this.oPredefinedTable.setBusyIndicatorDelay(0);return this.oPredefinedTable;};sap.rules.ui.TextRuleSettings.prototype._updateRefreshFlags=function(n,i){this._internalModel.setProperty("/needToRefresh",n);this._internalModel.setProperty("/refreshButtonEnabled",i,null,true);this._internalModel.setProperty("/refreshButtonClicked",true);this._callRefreshResultsFunctionImport();};sap.rules.ui.TextRuleSettings.prototype._updateResultAttributeJSON=function(o,r,s,e,i){var j=this._internalModel.getProperty("/refreshButtonClicked");var k=o.getProperty("DataObjectAttributeId")?o.getProperty("DataObjectAttributeId"):o.getProperty("Id");if(this._internalModel.getProperty("/predefinedResults")){if(this._internalModel.getProperty("/predefinedResults/"+k)){if(r){this._internalModel.setProperty("/predefinedResults/"+k+"/AccessMode",h.EDITABLE);this._internalModel.setProperty("/predefinedResults/"+k+"/Expression","");this._internalModel.setProperty("/predefinedResults/"+k+"/AST","");}if(j){this._internalModel.setProperty("/predefinedResults/"+k,o.getObject(o.sPath));this._internalModel.setProperty("/predefinedResults/"+k+"/isAttributeinBackend",true);this._internalModel.setProperty("/predefinedResults/"+k+"/AccessMode",s);this._internalModel.setProperty("/predefinedResults/"+k+"/Expression",e);this._internalModel.setProperty("/predefinedResults/"+k+"/AST",i);}if(s){this._internalModel.setProperty("/predefinedResults/"+k+"/AccessMode",s);}if(e||e===""){this._internalModel.setProperty("/predefinedResults/"+k+"/Expression",e);}if(i||i===""){this._internalModel.setProperty("/predefinedResults/"+k+"/AST",i);}}else{this._internalModel.setProperty("/predefinedResults/"+k,o.getObject(o.sPath));if(r){this._internalModel.setProperty("/predefinedResults/"+k+"/AccessMode",h.EDITABLE);this._internalModel.setProperty("/predefinedResults/"+k+"/Expression","");this._internalModel.setProperty("/predefinedResults/"+k+"/AST","");}if(j){this._internalModel.setProperty("/predefinedResults/"+k+"/AccessMode",s);this._internalModel.setProperty("/predefinedResults/"+k+"/Expression",e);this._internalModel.setProperty("/predefinedResults/"+k+"/AST",i);this._internalModel.setProperty("/predefinedResults/"+k+"/isAttributeinBackend",true);}}}};sap.rules.ui.TextRuleSettings.prototype.getButtons=function(D){var e=[];var o=new B({text:this.oBundle.getText("cancelBtn")}).setTooltip(this.oBundle.getText("cancelBtn"));o.attachPress(function(){D.close();},this);var i=new B({text:this.oBundle.getText("applyChangesBtn")}).setTooltip(this.oBundle.getText("applyChangesBtn"));i.attachPress(function(){this._applySettingsModelChangesToOData(D);},this);e.push(i);e.push(o);return e;};sap.rules.ui.TextRuleSettings.prototype.init=function(){this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.needCreateLayout=true;this.firstLoad=true;this.setBusyIndicatorDelay(0);this._astUtils=A;};sap.rules.ui.TextRuleSettings.prototype.onBeforeRendering=function(){if(this.firstLoad){var e=this.getProperty("newTextRule");this._getResultsData(e);this.firstLoad=false;}};sap.rules.ui.TextRuleSettings.prototype._applySettingsModelChangesToOData=function(D){var _=this.getModel();var o=this.getModel("oDataModel");var e=this.getModel("TextRuleModel");var s=this._internalModel;var r=e.getProperty("/ruleId");var R=e.getProperty("/ruleVersion");var j=_.getProperty("/ResultDataObjectId");var k=s.getProperty("/resultDataObjectChanged");var m=s.getProperty("/resultAttributeChanged");var n={groupId:"changes"};var p=false;var u=this.getProperty("newTextRule");var v=function(){D.setBusy(false);e.setProperty("/resultChanged",k);D.setState(sap.ui.core.ValueState.Success);D.close();};o.setDeferredGroups([n.groupId]);var w=function(){var H=s.getProperty("/predefinedResults");for(var J in H){if(!H[J].isAttributeinBackend){var K={RuleId:H[J].RuleId,RuleVersion:H[J].RuleVersion,Id:H[J].Id};var N=o.createKey("/TextRuleResults",K);var O=new sap.ui.model.Context(o,N);o.deleteCreatedEntry(O);var Q=e.getProperty("/textRuleResultExpressions");for(var i=0;i<Q.length;i++){if(Q[i].ResultId===H[J].Id){var U={RuleId:H[J].RuleId,RuleVersion:H[J].RuleVersion,ResultId:H[J].Id,ConditionId:Q[i].ConditionId};N=o.createKey("/TextRuleResultExpressions",U);O=new sap.ui.model.Context(o,N);o.deleteCreatedEntry(O);}}}}};var x=function(){var P={};var i={RuleId:r,RuleVersion:R};var H=o.createKey("/TextRules",i);if(!o.getData(H)){P.properties=i;o.createEntry("/TextRules",P);}var J={RuleId:r,RuleVersion:R,Sequence:1};P.properties=J;o.createEntry("/TextRuleBranches",P);};var y=function(){var i=s.getProperty("/predefinedResults");if(i){var H;for(H in i){var J=i[H].AccessMode;var K=i[H].Expression?i[H].Expression:"";var N=i[H].AST?i[H].AST:"";var O="/PredefinedResults(RuleId='"+r+"',DataObjectAttributeId='"+H+"')";var Q={AccessMode:J,Expression:K,AST:N};var P={groupId:n.groupId};o.update(O,Q,P);}}};var z=function(){o.callFunction("/SetRuleResultDataObject",{method:"POST",groupId:n.groupId,urlParameters:{RuleId:r,ResultDataObjectId:j}});};var F=function(){o.callFunction("/RefreshRuleResultDataObject",{method:"POST",groupId:n.groupId,urlParameters:{RuleId:r}});};D.setBusy(true);if(s.getProperty("/refreshButtonClicked")){w();}if(!k&&m){p=true;y();}else if(k){p=true;z();y();}var G=s.getProperty("/needToRefresh");if(G){p=true;F();}if(u){p=true;x();}var P={};P.success=v;P.groupId=n.groupId;if(p){o.submitChanges(P);return;}D.setState(sap.ui.core.ValueState.Success);D.setBusy(false);D.close();};return t;},true);
