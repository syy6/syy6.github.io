/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.instance");jQuery.sap.require('sap.apf.ui.utils.constants');(function(){'use strict';function s(c,f,S){var l=c.getLayoutView();var a=l.byId("subHeader");a.addContent(f);f.addEventDelegate({onAfterRendering:function(){a.setBusy(false);if(f instanceof sap.ui.comp.smartfilterbar.SmartFilterBar){a.setHeight("");a.addStyleClass(S);if(!f.getFilterBarExpanded()||f.getFilters().length===0){f.addStyleClass("smartFilterBar");}else{f.removeStyleClass("smartFilterBar");}}}});}function r(c){c.getLayoutView().byId("subHeader").setBusy(false);}sap.apf.ui.Instance=function(i){i.uiApi=this;var c=i.oCoreApi;var S=i.oStartFilterHandler;var a;var m;var b;var t;var d;var e;var p;var f;var g;var F,o;var h=c.getUriGenerator().getApfLocation();this.oEventCallbacks={};var j;jQuery.sap.includeStyleSheet(h+"resources/css/apfUi.css","apfCss");jQuery.sap.includeStyleSheet(h+"resources/css/apfPrint.css","printCss");jQuery("#printCss").attr("media","print");this.getAddAnalysisStepButton=function(){return this.getAnalysisPath().getCarousel().addButton;};this.getAnalysisPath=function(){if(a===undefined){a=sap.ui.view({viewName:"sap.apf.ui.reuse.view.analysisPath",type:sap.ui.core.mvc.ViewType.JS,viewData:i,async:true});}return a;};this.getNotificationBar=function(){if(m===undefined){m=sap.ui.view({viewName:"sap.apf.ui.reuse.view.messageHandler",type:sap.ui.core.mvc.ViewType.JS,viewData:i,async:true});}return m;};this.getStepContainer=function(){if(b===undefined){b=sap.ui.view({viewName:"sap.apf.ui.reuse.view.stepContainer",type:sap.ui.core.mvc.ViewType.JS,viewData:i,async:true});}return b;};this.getToolbar=function(){if(t===undefined){t=sap.ui.view({viewName:"sap.apf.ui.reuse.view.toolbar",type:sap.ui.core.mvc.ViewType.JS,viewData:i,async:true});}return t;};this.getCarousel=function(){if(d===undefined){d=sap.ui.view({viewName:"sap.apf.ui.reuse.view.carousel",type:sap.ui.core.mvc.ViewType.JS,viewData:{oInject:i},async:true});}return d;};this.getStepGallery=function(){if(e===undefined){e=sap.ui.view({type:sap.ui.core.mvc.ViewType.JS,viewName:"sap.apf.ui.reuse.view.stepGallery",viewData:i,async:true});}return e;};this.getPathGallery=function(){if(p===undefined){p=sap.ui.view({viewName:"sap.apf.ui.reuse.view.pathGallery",type:sap.ui.core.mvc.ViewType.JS,viewData:{oInject:i},async:true});}return p;};this.getDeleteAnalysisPath=function(){if(f===undefined){f=sap.ui.view({viewName:"sap.apf.ui.reuse.view.deleteAnalysisPath",type:sap.ui.core.mvc.ViewType.JS,viewData:{oInject:i},async:true});}return f;};this.getLayoutView=function(){if(g===undefined){g=sap.ui.view({viewName:"sap.apf.ui.reuse.view.layout",type:sap.ui.core.mvc.ViewType.XML,viewData:i,async:true});}return g;};this.selectionChanged=function(R){var n;function u(){if(g){g.getController().enableDisableOpenIn();}}n=c.getSteps().indexOf(c.getActiveStep());if(R){this.getAnalysisPath().getController().refresh(0);}else{this.getAnalysisPath().getController().refresh(n+1);}c.updatePath(this.getAnalysisPath().getController().callBackForUpdatePath.bind(this.getAnalysisPath().getController()),function(){u();});};var I=false;this.createApplicationLayout=function(l){var n=this;return new Promise(function(q){if(!I){var u=n.getStepGallery().loaded();var w=n.getToolbar().loaded();var x=n.getPathGallery().loaded();var y=n.getDeleteAnalysisPath().loaded();var z=n.getStepContainer().loaded();var A=Promise.all([u]).then(function(){return n.getCarousel().loaded();});var B=Promise.all([w,A,x,y]).then(function(){return n.getAnalysisPath().loaded();});var C=Promise.all([z,B]).then(function(){return n.getLayoutView().loaded();});C.then(function(){l.addPage(g);I=true;j=l;q(l);});}else{q(j);}});};this.addDetailFooterContent=function(C){this.getLayoutView().getController().addDetailFooterContentLeft(C);};this.addMasterFooterContentRight=function(C){this.getLayoutView().getController().addMasterFooterContentRight(C);};this.setEventCallback=function(E,C){this.oEventCallbacks[E]=C;};this.getEventCallback=function(E){return this.oEventCallbacks[E];};this.getCustomFormatExit=function(){return i.exits;};this.setCustomFormatExit=function(C){var l=this.getCustomFormatExit();l.customFormat=C;};this.drawSmartFilterBar=function(l){var n=this;function q(u){c.getSmartFilterbarDefaultFilterValues().done(function(C){o=sap.ui.view({viewName:"sap.apf.ui.reuse.view.smartFilterBar",type:sap.ui.core.mvc.ViewType.JS,viewData:{oCoreApi:c,oUiApi:n,oSmartFilterBarConfiguration:u,controlConfiguration:C,parent:n.getLayoutView()},async:true});o.loaded().then(function(V){s(n,V.byId("idAPFSmartFilterBar"),"smartFilterBarContainer");});});}if(l){if(l.entitySet){q(l);}else{c.getMetadata(l.service).done(function(u){l.entitySet=u.getEntitySetByEntityType(l.entityType);delete l.entityType;q(l);});}}else{r(n);}};this.drawFacetFilter=function(C){if(C.length>0){var l=this;F=sap.ui.view({viewName:"sap.apf.ui.reuse.view.facetFilter",type:sap.ui.core.mvc.ViewType.JS,viewData:{oCoreApi:c,oUiApi:this,aConfiguredFilters:C,oStartFilterHandler:S},async:true});F.loaded().then(function(V){s(l,V.byId("idAPFFacetFilter"));});}else{r(this);}};this.contextChanged=function(R){var C=this.getEventCallback(sap.apf.core.constants.eventTypes.contextChanged);if(typeof C==="function"){C();}};this.getFacetFilterForPrint=function(){if(F){return F.byId("idAPFFacetFilter");}};this.getSmartFilterForPrint=function(){if(o){return o.byId("idAPFSmartFilterBar");}};this.handleStartup=function(l){var n=this;var q=jQuery.Deferred();c.getSmartFilterBarConfigurationAsPromise().done(function(u){if(u){n.drawSmartFilterBar(u);}l.done(function(w){var x=S.getStartFilters();x.done(function(C){n.contextChanged();if(!u){n.drawFacetFilter(C);}if(w.navigationMode==="backward"){n.getAnalysisPath().getController().isBackNavigation=true;c.updatePath(n.getAnalysisPath().getController().callBackForUpdatePath.bind(n.getAnalysisPath().getController()));n.getAnalysisPath().getController().setPathTitle();}if(w.navigationMode==="forward"){if(c.getStartParameterFacade().getSteps()){var y=c.getStartParameterFacade().getSteps()[0].stepId;var z=c.getStartParameterFacade().getSteps()[0].representationId;var A=n.getAnalysisPath().getController().callBackForUpdatePathAndSetLastStepAsActive.bind(n.getAnalysisPath().getController());c.createFirstStep(y,z,A);}}n.getNotificationBar().loaded().then(function(M){n.getLayoutView().byId("applicationPage").addContent(M);var B=M.getController().showMessage;c.setCallbackForMessageHandling(B.bind(M.getController()));q.resolve();});});});});return q.promise();};this.destroy=function(){F=undefined;o=undefined;if(a){this.getAnalysisPath().getCarousel().dndBox=undefined;var l=this.getAnalysisPath().getToolbar().getController();k(l.saveDialog);k(l.newOpenDialog);k(l.newDialog);k(l.confirmDialog);k(l.errorMsgDialog);k(l.noPathAddedDialog);if(l.deleteAnalysisPath!==undefined){k(l.deleteAnalysisPath.getController().oDialog);}if(l.pathGallery!==undefined){k(l.pathGallery.getController().oDialog);}var n=this.getAnalysisPath().getCarousel().getStepGallery().getController();k(n.oHierchicalSelectDialog);}if(b){var q=this.getStepContainer().getController();k(q.selectionDisplayDialog);v(this);}};function k(l){if(l!==undefined){if(l instanceof sap.m.ViewSettingsDialog){l.destroy();}else if(l.isOpen()){l.close();}}}function v(l){var n=false;var q=false;var u;if(l.getStepContainer().getViewData().oCoreApi.getActiveStep()!==undefined){n=true;}if(n){u=l.getStepContainer().getViewData().oCoreApi.getActiveStep().getSelectedRepresentation();if(u!==undefined){q=true;}}if(q){if(u.type!==sap.apf.ui.utils.CONSTANTS.representationTypes.TABLE_REPRESENTATION){if(u.toggleInstance!==undefined){k(u.toggleInstance.viewSettingsDialog);}}else{k(u.viewSettingsDialog);}}}};}());
