/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(['sap/ui/core/mvc/ControllerExtension','sap/fe/actions/draft','sap/fe/actions/nonDraft','sap/fe/actions/operations','sap/fe/model/DraftModel',"sap/ui/model/json/JSONModel",'sap/fe/actions/messageHandling','sap/m/Text','sap/m/Button','sap/m/Popover','sap/m/VBox','sap/m/MessageBox'],function(C,d,n,o,D,J,m,T,B,P,V,M){'use strict';function g(p){if(p&&p.getMetadata&&p.getMetadata().getName()==='sap.ui.base.Event'){p={};}return p||{};}var E=C.extend('sap.fe.controllerextensions.Transaction',{getProgrammingModel:function(a){var t=this;a=a||this.getDataModel();if(!this.sProgrammingModel){return D.upgradeOnDemand(a).then(function(i){t.sProgrammingModel=i?'Draft':'NonDraft';return t.sProgrammingModel;});}else{return Promise.resolve(this.sProgrammingModel);}},getDataModel:function(){return this.base.getView().getModel();},getUIModel:function(){if(!this.uiModel){this.uiModel=new J({editable:false,busy:false,draftStatus:'Clear'});}return this.uiModel;},createDocument:function(l){var u=this.getUIModel();if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}return this.getProgrammingModel(l.getModel()).then(function(p){var N=l.create();switch(p){case'Draft':u.setProperty("/busy",true);return N.created().then(function(){u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return N;});});case'NonDraft':return N;}}).catch(function(e){u.setProperty("/busy",false);m.showUnboundMessages();return Promise.reject(e);});},deleteDocument:function(c,p){var u=this.getUIModel(),r,R;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}u.setProperty("/busy",true);p=g(p);var l=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),a,b={title:l.getText("OBJECT_PAGE_DELETE")};if(p.title){if(p.description){a=[p.title,p.description];b.text=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTINFO",a);}else{a=[p.title];b.text=l.getText("OBJECT_PAGE_CONFIRM_DELETE_WITH_OBJECTTITLE",a);}}else{b.text=l.getText("OBJECT_PAGE_CONFIRM_GENERIC_DELETE");}M.show(b.text,{icon:M.Icon.WARNING,title:b.title,actions:[M.Action.DELETE,M.Action.CANCEL],onClose:function(A){if(A===M.Action.DELETE){var e=Array.isArray(c)?c:[c];return Promise.all(e.map(function(f){f.delete().then(function(){u.setProperty("/busy",false);r();}).catch(function(h){u.setProperty("/busy",false);m.showUnboundMessages();R();});}));}u.setProperty("/busy",false);}});return new Promise(function(e,f){R=f;r=e;});},editDocument:function(c){var t=this;var u=this.getUIModel();if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}return this.getProgrammingModel(c.getModel()).then(function(p){switch(p){case'Draft':t.activeContext=c;u.setProperty("/busy",true);return d.createDraftFromActiveDocument(c,{bPreserveChanges:false});case'NonDraft':return c;}}).then(function(N){u.setProperty("/editable",true);u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return N;});}).catch(function(e){u.setProperty("/busy",false);m.showUnboundMessages();return Promise.reject(e);});},updateDocument:function(){return Promise.resolve();},cancelDocument:function(c,p){var t=this,u=t.getUIModel(),i,s,a;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}if(!c){return Promise.reject("No context exists. Pass a meaningful context");}var p=g(p),b=c,e=p.cancelButton,f=b.getModel();return this.getProgrammingModel().then(function(h){s=h;if(h==="Draft"){u.setProperty("/busy",true);var j=f.bindContext(b.getPath()+'/DraftAdministrativeData').getBoundContext();return j.requestObject().then(function(k){i=!(k.CreationDateTime===k.LastChangeDateTime);return i;});}else if(h==="NonDraft"){i=b.hasPendingChanges();return i;}}).then(function(h){return t._showDiscardPopover(e,h);}).then(function(){switch(s){case'Draft':var h=b.getObject(),H=h&&h.HasActiveEntity;if(!H){b.delete();return H;}else{var A=t.activeContext||f.bindContext(b.getPath()+'/SiblingEntity').getBoundContext();return A.requestCanonicalPath().then(function(j){a=j;return b.delete();}).then(function(){if(A.getPath()!==a){A=f.bindContext(a).getBoundContext();}return A;});}break;case'NonDraft':if(b===c&&i){c.getBinding().resetChanges();}break;}}).then(function(h){u.setProperty("/editable",false);u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return h;});}).catch(function(h){u.setProperty("/busy",false);m.showUnboundMessages();return Promise.reject(h);});},saveDocument:function(c){var t=this,u=this.getUIModel();if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}u.setProperty("/busy",true);return this.getProgrammingModel(c.getModel()).then(function(p){switch(p){case'Draft':return d.activateDocument(c);case'NonDraft':t.getDataModel().submitBatch(t.getDataModel().getUpdateGroupId());return c;}}).then(function(a){u.setProperty("/editable",false);u.setProperty("/busy",false);return m.showUnboundMessages().then(function(){return a;});}).catch(function(e){u.setProperty("/busy",false);m.showUnboundMessages();return Promise.reject(e);});},callBoundAction:function(a,c,p){p=p||{};var u=this.getUIModel(),t=this;if(u.getProperty("/busy")){return Promise.reject("Action can only be called once at a time");}return this.getProgrammingModel().then(function(s){if(s==='NonDraft'){}var b=t._getBindingParameters(a);return o.callBoundAction(a,c,{invocationGrouping:p.invocationGrouping,label:p.label,showActionParameterDialog:true,bindingParameters:b,onSubmitted:function(){u.setProperty("/busy",true);}});}).then(function(){u.setProperty("/busy",false);return m.showUnboundMessages();}).catch(function(e){u.setProperty("/busy",false);m.showUnboundMessages();return Promise.reject(e);});},_getBindingParameters:function(a){if(!a){return;}var b=this.getDataModel().getMetaModel(),s=b.getObject("/"+a+'@com.sap.vocabularies.Common.v1.SideEffects');if(!s){return;}var p={},t=s.TargetProperties,c=s.TargetEntities;if(Array.isArray(t)&&t.length){p['$select']="";t.forEach(function(e){var f=e['$PropertyPath'];if(f.indexOf('_it/')!==0){p['$select']+=(f+',');}else{p['$expand']=p['$expand']||"";p['$expand']+=(f.slice(4)+',');}});p['$select']=p['$select'].slice(0,-1);p['$expand']=p['$expand']?p['$expand'].slice(0,-1):undefined;}if(Array.isArray(c)&&c.length){}return p;},_showDiscardPopover:function(c,i){var t=this,r=sap.ui.getCore().getLibraryResourceBundle("sap.fe");t._bContinueDiscard=false;return new Promise(function(a,b){if(!c){b("Cancel button not found");}if(i){var O=function(){c.setEnabled(true);if(t._bContinueDiscard){a();}else{b("Discard operation was rejected. Document has not been discarded");}t._oPopover.detachAfterClose(O);};if(!t._oPopover){t._oPopover=new P({showHeader:false,placement:"Top",content:[new V({items:[new T({text:r.getText("SAPFE_DRAFT_DISCARD_MESSAGE")}),new B({text:r.getText("SAPFE_DRAFT_DISCARD_BUTTON"),width:"100%",press:function(){t._bContinueDiscard=true;t._oPopover.close();}})]})],beforeOpen:function(){c.setEnabled(false);}});t._oPopover.addStyleClass("sapUiContentPadding");}t._oPopover.attachAfterClose(O);t._oPopover.openBy(c);}else{a();}});}});return E;});
