/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(['sap/ui/core/mvc/ControllerExtension',"sap/ui/model/json/JSONModel","sap/ui/core/routing/HashChanger"],function(C,J,H){'use strict';var E=C.extend('sap.fe.controllerextensions.AppState',{initializeAppState:function(a){var t=this;var r=a.getRouter();var A=sap.fe.controllerextensions.AppState.mAppContainer[a.getId()]={appStateModels:{}};A.oInnerAppStatePromise=new jQuery.Deferred();r.attachRouteMatched(function(e){var q=e.getParameters().arguments['?query'];var s=q&&q['sap-iapp-state'];if(s){if(A.oAppState&&s===A.oAppState.getKey()){A.oInnerAppStatePromise.resolve();s=undefined;}if(s){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(a,s).done(function(S){A.oAppState=S;t._updateAppStateModels(A,S);A.oInnerAppStatePromise.resolve();});}}else{A.oInnerAppStatePromise.resolve();if(A.oAppState){A.oAppState=null;t._updateAppStateModels(A,null);}}});},cleanupAppState:function(a){if(sap.fe.controllerextensions.AppState.mAppContainer[a.getId()]){delete sap.fe.controllerextensions.AppState.mAppContainer[a.getId()];}},requestAppStateModel:function(i){var t=this;var a=this._getAppContainer(),A;return a.oInnerAppStatePromise.then(function(){if(!a.appStateModels[i]){a.appStateModels[i]=new J(null,true);a.appStateModels[i].bindList("/").attachChange(t._updateAppState.bind(t,i));}if(a.oAppState){A=a.oAppState.getData();if(A&&A[i]){a.appStateModels[i].setData(A[i]);}}return a.appStateModels[i];});},_updateAppState:function(i){var a={};var A=this._getAppContainer();var n=A.appStateModels[i].getJSON();if(A.oAppState){a=A.oAppState.getData()||{};}if(a&&a[i]&&a[i]===n){return;}A.oAppState=sap.ushell.Container.getService("CrossApplicationNavigation").createEmptyAppState(this._getOwnerComponent());var h=this._getHashChanger();var c=h.getAppHash();var p=c.split("?");var s=p[0];s+="?sap-iapp-state="+A.oAppState.getKey();h.replaceHash(s);a[i]=n;A.oAppState.setData(a);return A.oAppState.save();},_getHashChanger:function(){if(!this.oHashChanger){this.oHashChanger=H.getInstance();}return this.oHashChanger;},_getOwnerComponent:function(){return this.base.getView().getController().getOwnerComponent();},_updateAppStateModels:function(a,A){var d=A&&A.getData()||{};for(var p in a.appStateModels){if(d&&d[p]){a.appStateModels[p].setData(d[p]);}else{a.appStateModels[p].setData(null);}}},_getAppContainer:function(){return sap.fe.controllerextensions.AppState.mAppContainer[this._getOwnerComponent().getId()];}});sap.fe.controllerextensions.AppState.mAppContainer={};return E;});
