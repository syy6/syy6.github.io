/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(['sap/m/MessageBox',"sap/m/Dialog",'sap/ui/layout/form/SimpleForm','sap/ui/mdc/base/Field','sap/m/Label',"sap/ui/model/json/JSONModel"],function(M,D,S,F,L,J){'use strict';function c(A,f,P){return new Promise(function(h,k){var C,E,O=P.onSubmitted,l=P.actionParameters||[],m,n,q,t=[],G,i,u=P.label,v=P.invocationGrouping==='ChangeSet',I,w=P.showActionParameterDialog,B=P.bindingParameters,x;if(!f||f.length===0){return k("Bound actions always requires at least one context");}C=Array.isArray(f)?f:[f];m=C[0].getModel();A=r(A);I=e(A,m);if(w||l.length>0){q=g(A,m,C);l=p(q,l);if(!l||l.length===0){w=false;}}if(w){x=s;}else if(I){x=b;}E=function(n,z){if(l&&l.length){for(var j=0;j<l.length;j++){n.setParameter(l[j].$Name,l[j].value);}}G=z&&!v?'$auto.'+z:undefined;t.push(n.execute(G));};function y(j){return j.then(function(z){return{response:z,status:"resolved"};},function(z){return{response:z,status:"rejected"};});}(x?x(u,l):Promise.resolve(true)).then(function(j){if(j){for(i=0;i<C.length;i++){n=m.bindContext(A+'(...)',C[i],B);E(n,(C.length<=1?null:i));}(O||jQuery.noop)(t);Promise.all(t.map(y)).then(function(z){var R=[],H=[];var K;for(K=0;K<z.length;K++){if(z[K].status==="rejected"){R.push(z[K].response);}if(z[K].status==="resolved"){H.push(z[K].response);}}if(!z||(z&&z.length===0)){k(true);}if(R.length===0){h(H);}else{k({resolvedItems:H,rejectedItems:R});}});}});});}function a(A,m,P){var f=P.actionParameters||[],O=P.onSubmitted,h,i,k,I,l=P.label,n=P.showActionParameterDialog,q;if(!m){return Promise.reject("Action expects a model/context for execution");}A=r(A);i=g(A,m,null);I=e(A,m);if(!i||i.$kind!=="ActionImport"){return Promise.reject("Action Import not found");}if(n||f.length>0){f=p(i,f);if(f.length===0){n=false;}}if(n){q=s;}else if(I){q=b;}(q?q(l,f):Promise.resolve(true)).then(function(C){if(C){h=m.bindContext("/"+A+'(...)');if(f&&f.length){for(var j=0;j<f.length;j++){h.setParameter(f[j].name,f[j].value);}}k=h.execute('actionImport');m.submitBatch('actionImport');(O||jQuery.noop)(k);return k;}});}function b(A,f){return new Promise(function(h,i){var R=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),C;if(R.hasText("SAPFE_ACTION_CONFIRM|"+A)){C=R.getText("SAPFE_ACTION_CONFIRM|"+A);}else{C=R.getText("SAPFE_ACTION_CONFIRM");}M.confirm(C,{onClose:function(j){if(j===M.Action.OK){h(true);}h(false);},title:f||R.getText("SAPFE_ACTION_CONFIRM_TITLE")});});}function s(A,P){return new Promise(function(f,h){var R=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),j=[],k=new J(),l,m;function n(v){return(v==='Edm.Date'||v==='Edm.DateTimeOffset')?{style:'medium'}:{};}function q(E){var m=E.oSource;var v=E.getParameter("value");var V=E.getParameter("valid");if(V&&v!=""){m.setValueState(sap.ui.core.ValueState.None);m.setValueStateText("");}}var t=new S();t.setModel(k);for(var i=0;i<P.length;i++){l=new L({text:P[i].$Name});m=new F({value:"{/"+P[i].$Name+'}',required:P[i].$Nullable===false,dataType:P[0].$Type,width:"100%",multipleLines:false,dataTypeConstraints:{precision:P[i].$Type||0},dataTypeFormatOptions:n(P[i].$Type),change:q.bind(this)});l.setLabelFor(m);t.addContent(l);t.addContent(m);j.push({field:m,label:l});}var u=new D({title:A||R.getText("SAPFE_ACTION_PARAMETER_DIALOG_TITLE"),content:[t],beginButton:{text:A||R.getText("SAPFE_ACTION_PARAMETER_DIALOG_OK"),press:function(){var m,E,i;for(i in j){m=j[i].field;if(m.getRequired()&&(m.getValue()===""||m.getValue()===null)){m.setValueState("Error");m.setValueStateText(R.getText("SAPFE_ACTION_PARAMETER_REQUIRED"));E=true;}}if(!E){for(i=0;i<P.length;i++){P[i].value=k.getProperty("/"+P[i].$Name);}u.close();f(true);}}},endButton:{text:R.getText("SAPFE_ACTION_PARAMETER_DIALOG_CANCEL"),press:function(){u.close();f(false);}}});u.open();});}function p(A,P){var f=d(A);P=P||[];if(P.length>0){}return f;}function g(A,m,C){if(!A){return Promise.reject("Action name is empty");}var f=m.getMetaModel();var h=f.getObject("/"+A),P=[],E;if(!h){return Promise.reject("Action with the name"+A+"does not exist");}if(h.length){for(var i=0;i<h.length;i++){P=h[i].$Parameter;if(P&&P.length){E=f.getObject(f.getMetaPath(C[0].getPath())+"/$Type");if(P[0]&&P[0].$Type===E){return h[i];}}}}else if(h.$Action&&f.getObject("/"+h.$Action)){return f.getObject("/"+h.$Action)[0];}}function r(A){var n=A.split("/")[1];return n?n:A;}function d(A){if(!A){return Promise.reject("No Action was obtained");}var P=A.$Parameter;if(P&&P.length){if(A.$IsBound){var f=P.slice(1,P.length)||[];return f;}else{return P;}}}function e(A,m){return m.getMetaModel().getObject("/"+A+'@com.sap.vocabularies.Common.v1.IsActionCritical');}var o={callBoundAction:c,callActionImport:a};return o;});
