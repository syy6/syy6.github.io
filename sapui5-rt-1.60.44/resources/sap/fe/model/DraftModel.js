/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/json/JSONModel","sap/ui/model/odata/v4/ODataListBinding","sap/ui/model/odata/v4/Context","sap/ui/model/Filter","sap/ui/base/ManagedObject","sap/ui/model/ChangeReason","sap/ui/model/resource/ResourceModel","sap/fe/core/internal/testableHelper","sap/ui/model/odata/v4/ODataContextBinding"],function(J,O,C,F,M,a,R,t,b){"use strict";var c="_$DraftModel";var A=false;var d=/( and )?\(*IsActiveEntity eq.*$/g;var p={};t.testableStatic(function(){A=true;},"addPrivateDataToModel");function s(x,K,y){var z=typeof x==="string"?x:x.getId(),P=p[z]=p[z]||{};P[K]=y;if(A&&!x[c]){x[c]=P;}}function g(x,K){var y=typeof x==="string"?x:x.getId();return p[y]&&p[y][K];}var E={ALL:"0",UNCHANGED:"1",OWN_DRAFT:"2",LOCKED:"3",UNSAVED_CHANGES:"4"};t.testableStatic(E,"EDITSTATE");function e(x){var y="";switch(x){case E.UNCHANGED:y="(IsActiveEntity eq true and HasDraftEntity eq false)";break;case E.OWN_DRAFT:y="(IsActiveEntity eq false)";break;case E.LOCKED:y="(IsActiveEntity eq true and SiblingEntity/IsActiveEntity eq null and DraftAdministrativeData/InProcessByUser ne '')";break;case E.UNSAVED_CHANGES:y="(IsActiveEntity eq true and SiblingEntity/IsActiveEntity eq null and DraftAdministrativeData/InProcessByUser eq '')";break;default:y="(IsActiveEntity eq false or SiblingEntity/IsActiveEntity eq null)";break;}return y;}t.testableStatic(e,"getFilterForEditState");function f(x){var y=x.getMetaModel(),z=g(x,"aEntitySets"),B=z?Promise.resolve(z):y&&y.requestObject("/").then(function(G){var P=[];Object.keys(G).forEach(function(H){var I=G[H],K;if(I.$kind==="EntitySet"){K=y.requestObject("/"+H+"@");P.push(K.then(function(L){var N={};N["@"]=L;N["@sapui.name"]=H;return N;}));}});return Promise.all(P);});return B;}function h(x,y,z){var B=x.getModel();z=z||{$$inheritExpandSelect:false};return B.bindContext(y+"(...)",x,z);}function i(){if(!this.getProperty("IsActiveEntity")){var x=h(this,arguments[0]);return x.execute().then(function(y){return y;});}else{throw new Error("The activation action cannot be executed on an active document");}}function j(x){if(!this.getProperty("IsActiveEntity")){var y=h(this,arguments[0]);x=arguments[1];if(typeof x==="undefined"){x="";}y.setParameter("SideEffectsQualifier",x);return y.execute().then(function(){return y;});}else{throw new Error("The preparation action cannot be executed on an active document");}}function k(){if(!this.getProperty("IsActiveEntity")){var x=h(this,arguments[0]);return x.execute().then(function(){return x;});}else{throw new Error("The validation function cannot be executed on an active document");}}function l(x){if(this.getProperty("IsActiveEntity")){var y=h(this,arguments[0]);x=arguments[1];y.setParameter("PreserveChanges",x);return y.execute().then(function(z){return z;});}else{throw new Error("The edit action cannot be executed on a draft document");}}var o={"ActivationAction":i,"PreparationAction":j,"ValidationFunction":k,"EditAction":l};function m(x,y){var z=y["@"]["@com.sap.vocabularies.Common.v1.DraftRoot"]||y["@"]["@com.sap.vocabularies.Common.v1.DraftNode"];Object.keys(z).forEach(function(B){var G=z[B];if(o[B]){x["executeDraft"+B]=o[B].bind(x,G);}});}function n(x){return f(x).then(function(y){var z=y.filter(function(G){var H=G["@"]||{};return H.hasOwnProperty("@com.sap.vocabularies.Common.v1.DraftRoot")||H.hasOwnProperty("@com.sap.vocabularies.Common.v1.DraftNode");}),B=Array.isArray(z)&&z.length>0;if(B){s(x,"aEntitySets",y);s(x,"aDraftEntitySets",z);}return B;});}function q(x,y){var z=e(x,"");if(y){y="("+y+") and "+z;}else{y=z;}return y;}function _(x){var y={},L={},z=-1,B=sap.ui.getCore().getLibraryResourceBundle("sap.fe"),G={"editStates":[{id:E.ALL,name:B.getText("SAPFE_DRAFT_ALL_FILTER")},{id:E.UNCHANGED,name:B.getText("SAPFE_DRAFT_UNCHANGED_FILTER")},{id:E.OWN_DRAFT,name:B.getText("SAPFE_DRAFT_OWN_DRAFT_FILTER")},{id:E.LOCKED,name:B.getText("SAPFE_DRAFT_LOCKED_FILTER")},{id:E.UNSAVED_CHANGES,name:B.getText("SAPFE_DRAFT_UNSAVED_CHANGES_FILTER")}],"entitySets":{}},I,H=g(x,"aDraftEntitySets");s(x,"mListBindings",L);t.testableStatic(function(x){return g(x,"mListBindings");},"getOverwrittenListBindings");H.forEach(function(K){G.entitySets[K["@sapui.name"]]={editState:"0"};});I=new J(G);s(x,"oDraftAccessModel",I);x.getDraftAccessModel=v;I.attachPropertyChange(function(K){var P=K.getParameters(),N=P&&(P.path.indexOf("/entitySets")===0?P.path.split("/")[2]:false);if(N){N="/"+N;Object.keys(L).forEach(function(Q){var S=L[Q],T=S.mParameters,U="",V="",W=[];if(S instanceof O&&S.getPath()===N){U=T["$filter"];if(U){W=U.match(d);if(Array.isArray(W)&&W[0]){V=W[0];U=U.replace(V,"");U=U.substr(1).slice(0,-1);}}T["$filter"]=q(P.value,U);S.applyParameters(T);S.reset(sap.ui.model.ChangeReason.Filter);}});}});y.bindList=x.bindList;x.bindList=function(P,K,S,N,Q){var T=I.getObject("/entitySets"+P),U,V;if(T){var W="";Q=Q||{};W=Q.$expand;if(W){if(W.indexOf("DraftAdministrativeData")<0){W+=",DraftAdministrativeData";}}else{W="DraftAdministrativeData";}Q.$expand=W;Q.$filter=q(T.editState,Q.$filter);}arguments[4]=Q;U=y.bindList.apply(this,arguments);if(T){V=U.changeParameters;U.changeParameters=function(Q){var T=I.getObject("/entitySets"+P);Q.$filter=q(T.editState,Q.$filter);return V.call(this,Q);};L[++z]=U;U.destroy=(function(X){return function(){delete L[X];return O.prototype.destroy.apply(this,arguments);};})(z);y.bindProperty=y.bindProperty||x.bindProperty.bind(x);x.bindProperty=function(P,K,Q){if(P.indexOf(":$count")>-1){var X=P.split(":$")[0];return y.bindProperty("$count",x.mNamedBindings[X].getHeaderContext(),Q);}return y.bindProperty.apply(this,arguments);};}return U;};y.create=C.create;C.create=function(x,K,P,N,Q){var S=y.create.apply(null,arguments),T=false;if(g(x,"bUpgraded")&&P){H.forEach(function(U){var V=!T&&P.indexOf(U["@sapui.name"])===1;if(V){T=true;m(S,U);}});}return S;};y.modelDestroy=x.destroy;x.destroy=function(){delete p[this.getId()];return y.modelDestroy.apply(this,arguments);};s(x,"bUpgraded",true);}function u(x){return n(x).then(function(y){if(y){_(x);}else{throw new Error("The model is not draft enabled");}});}function r(x){return n(x).then(function(y){if(y){_(x);}return y;});}function v(){return g(this,"oDraftAccessModel");}var w={};var D={upgrade:u,upgradeOnDemand:r,isDraftModel:n,EDITSTATE:E};return D;},true);
